<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Exercise Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #005ec4;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
            --bg-body: #F2F2F7;
            --text-main: #1C1C1E;
            --text-muted: #8E8E93;
            --card-bg: #FFFFFF;
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        /* Contenedor Principal (Antes Popup) */
        .main-container {
            background: var(--card-bg);
            width: 100%;
            max-width: 700px;
            border-radius: var(--radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: fit-content;
            max-height: 95vh;
        }

        /* Header */
        .header {
            background: #F9F9FB;
            border-bottom: 1px solid #e5e5ea;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        .btn-help { 
            width: 24px; height: 24px; background: #e5e5ea; color: #8e8e93; 
            border: none; border-radius: 50%; cursor: pointer; font-weight: 700; font-size: 0.8rem;
        }
        .btn-help:hover { background: var(--primary); color: white; }

        /* Cuerpo */
        .content-body {
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Elementos de Formulario */
        .section-label { 
            font-size: 0.75rem; font-weight: 800; color: #86868b; 
            text-transform: uppercase; margin-top: 10px; margin-bottom: 5px; 
        }

        .select-input, .text-input {
            width: 100%; padding: 12px; border-radius: 10px; 
            border: 1px solid #d1d1d6; background: #fff; 
            font-size: 0.95rem; font-family: inherit; transition: all 0.2s;
        }
        .select-input:focus, .text-input:focus { border-color: var(--primary); outline: none; }
        .text-input.override-warning { border-color: var(--warning); background-color: #fffbf0; }

        textarea.text-input { resize: vertical; min-height: 60px; }

        /* Grupos de botones (Nivel y Banderas) */
        .btn-group { display: flex; gap: 10px; }
        
        .btn-level {
            flex: 1; padding: 10px; border: 1px solid #e5e5ea; border-radius: 8px;
            background: #fff; color: #666; font-size: 0.85rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-level.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .btn-flag {
            border: 1px solid #e5e5ea; border-radius: 10px; background: #fff;
            font-size: 1.5rem; width: 48px; height: 48px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.5; filter: grayscale(100%); transition: all 0.2s;
        }
        .btn-flag:hover { opacity: 1; filter: grayscale(0%); }
        .btn-flag.selected { border-color: var(--primary); background: #e3f2fd; opacity: 1; filter: grayscale(0%); }
        .btn-flag.hidden { display: none; }
        .btn-flag.sm { width: 38px; height: 38px; font-size: 1.2rem; }

        /* Acciones Principales */
        .action-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-top: 15px; }
        
        .btn-action {
            padding: 14px; border: none; border-radius: 12px; 
            font-weight: 700; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn-action:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #007AFF, #005ec4); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .btn-secondary { background: #f2f2f7; color: var(--text-main); border: 1px solid #e5e5ea; }
        
        .btn-save-tpl {
            background: #fff8e1; color: #d97706; border: 1px solid #fcd34d;
            margin-top: 10px; width: 100%;
        }

        /* Banco de Memoria */
        .memory-section {
            margin-top: 30px; border-top: 2px solid #f2f2f7; padding-top: 20px;
        }
        .memory-list { 
            display: flex; flex-direction: column; gap: 10px; 
            max-height: 250px; overflow-y: auto; margin-top: 10px;
        }
        .saved-item {
            background: #fff; border: 1px solid #e5e5ea; border-radius: 12px;
            padding: 12px; display: flex; align-items: center; gap: 12px;
        }
        .saved-info { flex: 1; }
        .saved-title { font-weight: 600; font-size: 0.9rem; display: block; color: #333; }
        .saved-meta { font-size: 0.75rem; color: #86868b; }
        
        .btn-icon { 
            width: 32px; height: 32px; border: none; background: #f2f2f7; 
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .btn-icon.delete:hover { background: #fff5f5; color: var(--danger); }
        .btn-icon.export:hover { background: #e3f2fd; color: var(--primary); }

        /* Utilidades */
        .help-box { 
            display: none; background: #eef2ff; color: #3730a3; 
            padding: 15px; border-radius: 10px; font-size: 0.85rem; 
            margin-bottom: 15px; border: 1px solid #c7d2fe; line-height: 1.5; 
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <div class="header-title">
                <span>‚ö° Polyglot Generator</span>
            </div>
            <button class="btn-help" onclick="toggleHelp()">?</button>
        </div>

        <div class="content-body">
            
            <div id="help-box" class="help-box">
                <b>Instructions:</b><br>
                1. Select your options (Context, Grammar, Type).<br>
                2. Click <b>Create Mission</b> to copy the prompt.<br>
                3. Paste into ChatGPT/Claude.<br>
                4. Copy the JSON response.<br>
                5. Click <b>Import & Save</b> to store the exercise in the Memory Bank.
            </div>

            <div class="section-label">1. Context & Topic</div>
            <select id="ai-context-select" class="select-input">
                <option value="" selected disabled>-- Select Context --</option>
                <optgroup label="üè† Daily Life">
                    <option value="Daily Routine & Habits">Daily Routine & Habits</option>
                    <option value="Family & Relationships">Family & Relationships</option>
                    <option value="Food & Cooking">Food & Cooking</option>
                    <option value="Health & Fitness">Health & Fitness</option>
                </optgroup>
                <optgroup label="‚úàÔ∏è Travel">
                    <option value="At the Airport">At the Airport</option>
                    <option value="Hotel & Accommodation">Hotel Situations</option>
                    <option value="Directions & City">City & Directions</option>
                </optgroup>
                <optgroup label="üíº Business">
                    <option value="Job Interviews">Job Interviews</option>
                    <option value="Meetings & Negotiations">Meetings</option>
                    <option value="Emails & Calls">Emails & Calls</option>
                </optgroup>
            </select>
            <input type="text" id="ai-context-custom" class="text-input" style="margin-top:5px" placeholder="Or type custom topic..." oninput="checkOverride()">

            <div class="section-label">2. Grammar Focus</div>
            <select id="ai-grammar-select" class="select-input">
                <option value="" selected disabled>-- Select Grammar --</option>
                <optgroup label="Tenses">
                    <option value="Present Simple">Present Simple</option>
                    <option value="Present Continuous">Present Continuous</option>
                    <option value="Past Simple">Past Simple</option>
                    <option value="Past Perfect">Past Perfect</option>
                    <option value="Future Forms">Future Forms (Will/Going to)</option>
                </optgroup>
                <optgroup label="Structures">
                    <option value="Conditionals">Conditionals (If clauses)</option>
                    <option value="Passive Voice">Passive Voice</option>
                    <option value="Reported Speech">Reported Speech</option>
                    <option value="Modals">Modal Verbs</option>
                    <option value="Prepositions">Prepositions</option>
                </optgroup>
            </select>
            <input type="text" id="ai-grammar-custom" class="text-input" style="margin-top:5px" placeholder="Or type custom grammar..." oninput="checkOverride()">

            <div class="section-label">3. Exercise Format</div>
            <div style="display:flex; gap:10px;">
                <select id="ai-type-select" class="select-input" style="flex:2">
                    <option value="Fill in the Blanks (Cloze)" selected>Fill in the Blanks</option>
                    <option value="Multiple Choice Quiz">Multiple Choice</option>
                    <option value="Find and Fix the Mistake">Find the Mistake</option>
                    <option value="Sentence Reordering">Unscramble Sentences</option>
                    <option value="Vocabulary Matching">Vocabulary Matching</option>
                    <option value="True or False (Reading)">True or False</option>
                </select>
                <select id="ai-gap-count" class="select-input" style="flex:1">
                    <option value="1">1 Gap</option>
                    <option value="2">2 Gaps</option>
                    <option value="random">Mix</option>
                </select>
            </div>

            <div class="section-label">Target Language</div>
            <div class="btn-group" id="target-lang-group">
                <div class="btn-flag selected" onclick="selectTarget(this, 'en')" title="English">üá∫üá∏</div>
                <div class="btn-flag" onclick="selectTarget(this, 'es')" title="Spanish">üá™üá∏</div>
                <div class="btn-flag" onclick="selectTarget(this, 'pt')" title="Portuguese">üáßüá∑</div>
                <div class="btn-flag" onclick="selectTarget(this, 'it')" title="Italian">üáÆüáπ</div>
                <div class="btn-flag" onclick="selectTarget(this, 'fr')" title="French">üá´üá∑</div>
            </div>

            <div class="section-label">Level</div>
            <div class="btn-group">
                <button class="btn-level" onclick="selectLevel(this, 'A1-A2 (Beginner)')">A1-A2</button>
                <button class="btn-level selected" onclick="selectLevel(this, 'B1-B2 (Intermediate)')">B1-B2</button>
                <button class="btn-level" onclick="selectLevel(this, 'C1-C2 (Advanced)')">C1-C2</button>
            </div>

            <textarea id="ai-extra-data" class="text-input" style="margin-top:15px" placeholder="Extra instructions (e.g. 'Use medical vocabulary', 'Make it funny')..."></textarea>

            <div class="action-row">
                <button class="btn-action btn-primary" onclick="copyProfessorPrompt()">
                    <span>‚ú® Create Mission</span>
                </button>
                <button class="btn-action btn-secondary" onclick="pasteAIJson()">
                    <span>üì• Import</span>
                </button>
            </div>

            <div class="memory-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="section-label" style="margin:0;">üíæ Memory Bank (Templates)</div>
                    <button class="btn-action btn-secondary" style="padding: 5px 10px; font-size: 0.7rem;" onclick="exportMemoryBank()">Backup JSON</button>
                </div>
                
                <div id="memory-list" class="memory-list">
                    <div style="text-align:center; padding:20px; color:#aaa;">No saved exercises yet.</div>
                </div>
            </div>

        </div>
    </div>

<script>
    const AI_MEM_KEY = 'mdc_isolated_ai_mem';
    let currentTargetLang = 'en';
    let currentLevel = 'B1-B2 (Intermediate)';
    const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian', 'fr': 'French' };

    document.addEventListener('DOMContentLoaded', () => {
        renderMemoryList();
    });

    function toggleHelp() {
        const el = document.getElementById('help-box');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function checkOverride() {
        // Just visual feedback if user types in custom fields
        const ctx = document.getElementById('ai-context-custom').value;
        const gra = document.getElementById('ai-grammar-custom').value;
        
        document.getElementById('ai-context-select').style.opacity = ctx ? '0.6' : '1';
        document.getElementById('ai-grammar-select').style.opacity = gra ? '0.6' : '1';
    }

    function selectTarget(el, lang) {
        document.querySelectorAll('#target-lang-group .btn-flag').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        currentTargetLang = lang;
    }

    function selectLevel(el, level) {
        document.querySelectorAll('.btn-level').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        currentLevel = level;
    }

    /* --- CORE LOGIC --- */

    function copyProfessorPrompt() {
        const ctxSel = document.getElementById('ai-context-select').value;
        const graSel = document.getElementById('ai-grammar-select').value;
        const typSel = document.getElementById('ai-type-select').value;
        const gapCount = document.getElementById('ai-gap-count').value;
        
        const ctxCust = document.getElementById('ai-context-custom').value.trim();
        const graCust = document.getElementById('ai-grammar-custom').value.trim();
        const extraData = document.getElementById('ai-extra-data').value.trim();

        let context = ctxCust || ctxSel;
        let grammar = graCust || graSel;
        
        if (!context && !grammar && !extraData) return alert("Please select at least a Topic or Grammar.");

        const target = LANG_NAMES[currentTargetLang] || 'English';
        const typeStr = typSel;

        let requirements = [];
        if (context) requirements.push(`Topic: ${context}`);
        if (grammar) requirements.push(`Grammar: ${grammar}`);
        requirements.push(`Format: ${typeStr}`);

        let jsonExample = `{ "title": "Exercise Title", "exercises": [ { "cloze_text": "Sentence in ${target} with {option1|option2} gaps.", "hint": "Tip", "translations": {"es": "..."} } ] }`;

        const promptText = `ACT AS: Senior ${target} Linguist. LEVEL: CEFR ${currentLevel}. 
TASK: Create a structured JSON exercise. 
REQUIREMENTS: ${requirements.join(", ")}. 
GAP RULES: Provide ${gapCount} gap(s) per sentence. Options inside gaps {opt1|opt2...} MUST BE in ${target}.
${extraData ? `EXTRA: ${extraData}` : ''}
OUTPUT: RAW JSON ONLY. No markdown.
STRUCTURE: ${jsonExample}`;

        navigator.clipboard.writeText(promptText).then(() => {
            const btn = document.querySelector('.btn-primary');
            const orig = btn.innerHTML;
            btn.innerHTML = "<span>‚úÖ Copied to Clipboard!</span>";
            setTimeout(() => btn.innerHTML = orig, 2000);
        });
    }

    async function pasteAIJson() {
        let jsonString = "";
        try {
            jsonString = await navigator.clipboard.readText();
        } catch (err) {
            jsonString = prompt("Paste JSON code here:");
        }
        
        if (!jsonString) return;

        try {
            // Cleanup typical Markdown wrappers
            let cleanString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const aiData = JSON.parse(cleanString);
            
            // Normalize data
            let finalData = Array.isArray(aiData) ? { title: "Generated Exercise", exercises: aiData } : aiData;
            
            // Save to Memory
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            const newItem = {
                id: Date.now(),
                title: finalData.title || `Exercise ${new Date().toLocaleTimeString()}`,
                lang: currentTargetLang,
                date: new Date().toLocaleDateString(),
                data: finalData.exercises
            };
            
            memory.unshift(newItem);
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
            
            renderMemoryList();
            alert("‚úÖ Saved to Memory Bank!");
            
        } catch (e) {
            alert("‚ùå Invalid JSON. Please ensure you copied the AI output correctly.\nError: " + e.message);
        }
    }

    function renderMemoryList() {
        const list = document.getElementById('memory-list');
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        
        if (memory.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">No saved exercises yet.</div>';
            return;
        }

        let html = '';
        memory.forEach(item => {
            let flag = "üá∫üá∏";
            if(item.lang === 'es') flag = "üá™üá∏";
            if(item.lang === 'pt') flag = "üáßüá∑";
            if(item.lang === 'it') flag = "üáÆüáπ";
            if(item.lang === 'fr') flag = "üá´üá∑";

            html += `
            <div class="saved-item">
                <div class="saved-info">
                    <span class="saved-title">${flag} ${item.title}</span>
                    <span class="saved-meta">${item.date} ‚Ä¢ ${item.data ? item.data.length : 0} Qs</span>
                </div>
                <button class="btn-icon export" onclick="downloadJSON(${item.id})" title="Download JSON">‚¨áÔ∏è</button>
                <button class="btn-icon delete" onclick="deleteItem(${item.id})" title="Delete">üóëÔ∏è</button>
            </div>`;
        });
        list.innerHTML = html;
    }

    function deleteItem(id) {
        if(!confirm("Delete this template?")) return;
        let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        memory = memory.filter(i => i.id !== id);
        localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
        renderMemoryList();
    }

    function downloadJSON(id) {
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        const item = memory.find(i => i.id === id);
        if(!item) return;

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(item, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", item.title.replace(/\s+/g, '_') + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function exportMemoryBank() {
        const memory = localStorage.getItem(AI_MEM_KEY);
        if(!memory) return alert("Nothing to backup.");
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(memory);
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "mdc_ai_templates_backup.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
    }
</script>

</body>
</html>
