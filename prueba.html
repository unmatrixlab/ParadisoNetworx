<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDC - Pro AI Tutor Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --card-bg: rgba(255, 255, 255, 0.85);
            --header-height: 60px;
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-body);
            font-family: 'Inter', sans-serif;
            padding-top: var(--header-height);
            padding-bottom: 60px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ====== HEADER ====== */
        #mdc-header {
            position: fixed;
            top: 0; left: 0; width: 100%;
            height: var(--header-height);
            background: rgba(31, 41, 55, 0.85);
            backdrop-filter: blur(16px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        #mdc-header a {
            text-decoration: none;
            font-weight: 800;
            font-size: 18px;
            background: linear-gradient(to right, #fff, #a5b4fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ====== INPUT PANEL ====== */
        .input-panel {
            width: 95%; max-width: 600px;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: var(--radius);
            padding: 25px; margin-top: 30px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.6);
            display: flex; flex-direction: column; gap: 15px;
        }

        .panel-title { font-size: 1.2rem; font-weight: 700; text-align: center; margin-bottom: 5px; }

        .input-group label {
            display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted);
            margin-bottom: 5px; text-transform: uppercase;
        }

        input[type="text"] {
            width: 100%; padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px; font-size: 1rem;
            background: rgba(255,255,255,0.9);
        }

        .btn-save {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            transition: 0.2s;
        }
        .btn-save:hover { background: var(--primary-hover); }

        .backup-section {
            margin-top: 10px; padding-top: 15px; border-top: 1px solid #e5e7eb;
            display: flex; gap: 10px;
        }
        .btn-backup {
            flex: 1; padding: 10px; background: transparent;
            color: var(--text-muted); border: 1px solid #e5e7eb; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        /* ====== GRID ====== */
        .grid-container {
            width: 95%; max-width: 1000px; margin-top: 40px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }

        .video-card {
            background: white; border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: transform 0.3s; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .video-card:hover { transform: translateY(-5px); }

        .thumbnail-container {
            position: relative; width: 100%; aspect-ratio: 16/9; background: #000; cursor: pointer;
        }
        .thumbnail-container img {
            width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;
        }
        .video-target { width: 100%; height: 100%; }

        .play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: rgba(255,255,255,0.25);
            backdrop-filter: blur(4px); border-radius: 50%; border: 1px solid rgba(255,255,255,0.4);
            display: flex; align-items: center; justify-content: center; pointer-events: none;
        }
        .play-icon svg { width: 24px; height: 24px; fill: white; margin-left: 4px; }

        .card-info { padding: 15px; display: flex; justify-content: space-between; gap: 10px; }
        .card-title { font-weight: 600; font-size: 0.95rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .card-actions { display: flex; gap: 5px; }
        .btn-action { background: transparent; border: none; cursor: pointer; padding: 4px; border-radius: 4px; }
        .btn-edit:hover { color: var(--primary); background: #e0e7ff; }
        .btn-delete:hover { color: var(--danger); background: #fef2f2; }

        /* ====== EDITOR MODAL ====== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }

        .editor-popup {
            background: white; border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            display: flex; overflow: hidden;
            width: 90%; max-width: 500px; height: 550px;
            flex-direction: column;
            transition: opacity 0.2s;
        }

        .desktop-video-container { display: none; background: #000; }
        .editor-content-panel { flex: 1; display: flex; flex-direction: column; height: 100%; background: white; }

        @media (min-width: 900px) {
            .editor-popup { width: 95%; max-width: 1200px; height: 85vh; flex-direction: row; }
            .desktop-video-container { display: block; flex: 1.5; position: relative; }
            .editor-content-panel { flex: 1; border-left: 1px solid #e5e7eb; }
            .opacity-control-group { display: none !important; }
        }

        .editor-header {
            padding: 10px 15px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        .editor-title { font-weight: 700; font-size: 0.9rem; }
        .close-editor { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }

        .editor-toolbar {
            padding: 12px; background: #fff; border-bottom: 1px solid #e5e7eb;
            display: flex; flex-direction: column; gap: 12px;
        }
        .toolbar-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }

        .control-group {
            display: flex; gap: 4px; align-items: center;
            background: #f3f4f6; padding: 4px 8px; border-radius: 8px;
        }

        .btn-fmt {
            width: 32px; height: 32px; border: 1px solid transparent; background: transparent;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #374151;
            display: flex; align-items: center; justify-content: center; transition: all 0.1s;
        }
        .btn-fmt:hover { background: #e5e7eb; }
        .btn-fmt.is-active { background: #4f46e5; color: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .btn-ai-trigger { color: #7c3aed; background: #f5f3ff; border: 1px solid #ddd6fe; }
        .btn-ai-trigger:hover { background: #ede9fe; }

        .color-btn {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid transparent; cursor: pointer;
            transition: transform 0.1s; position: relative;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.is-active { border-color: #000; transform: scale(1.1); box-shadow: 0 0 0 2px white, 0 0 0 4px rgba(0,0,0,0.1); }
        .c-black { background-color: #1f2937; }
        .c-red { background-color: #ef4444; }
        .c-blue { background-color: #3b82f6; }

        .opacity-control { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; flex-grow: 1; justify-content: flex-end;}
        
        @media (max-width: 899px) {
            .opacity-control-group { flex-basis: 100%; width: 100%; margin-top: 5px; display: flex; flex-direction: column; align-items: flex-start; }
            .opacity-control-group label { margin-bottom: 5px; font-weight: 600; color: #6b7280; }
            .opacity-control-group input[type="range"] { width: 100%; height: 30px; cursor: pointer; }
        }
        
        .media-controls { display: flex; gap: 6px; flex-grow: 1; justify-content: center; }
        .btn-media { padding: 6px 10px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
        .btn-media:hover { background: #f9fafb; }
        .btn-speed { min-width: 40px; }
        .btn-clear { padding: 6px 12px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }

        .editor-area {
            flex: 1; width: 100%; padding: 20px; border: none; font-family: 'Inter', sans-serif; 
            font-size: 16px; line-height: 1.6; background: transparent; overflow-y: auto; outline: none; color: #1f2937;
        }
        .editor-footer { padding: 10px 15px; border-top: 1px solid #e5e7eb; text-align: right; background: #f9fafb; font-size: 0.85rem; color: var(--text-muted); font-style: italic; }
        .save-indicator { color: #10b981; font-weight: 500; display: flex; align-items: center; justify-content: flex-end; gap: 5px; }

        /* ====== NEW AI HUB POPUP STYLES ====== */
        .ai-popup-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        .ai-popup-overlay.active { display: flex; }

        .ai-popup-box {
            background: white; width: 90%; max-width: 380px;
            border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        .ai-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white; padding: 15px; font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }
        .ai-close { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.8; }
        
        .ai-body { padding: 15px; display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }

        .ai-topic-label { font-size: 0.75rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: -5px; }
        .ai-select {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db;
            background: #fff; color: #374151; font-size: 0.9rem; cursor: pointer;
        }
        .ai-select:focus { border-color: #4f46e5; outline: none; }

        .ai-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .btn-ai-action {
            padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: white;
            font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-ai-action:hover { background: #f9fafb; border-color: #d1d5db; }
        .btn-ai-primary { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        
        .saved-list-title { font-size: 0.75rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-top: 10px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
        .saved-exercises-list { display: flex; flex-direction: column; gap: 8px; }
        .saved-item {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .saved-info { display: flex; flex-direction: column; gap: 2px; }
        .saved-name { font-weight: 600; font-size: 0.9rem; color: #334155; }
        .saved-date { font-size: 0.75rem; color: #94a3b8; }
        .btn-insert {
            background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 6px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer;
        }
        .btn-insert:hover { background: #059669; }
        .btn-clear-mem {
            margin-top: 10px; width: 100%; padding: 8px; border: none; background: #fee2e2; color: #991b1b;
            font-size: 0.8rem; border-radius: 6px; cursor: pointer;
        }

        /* ====== EXERCISE RENDER STYLES ====== */
        .exercise-box {
            background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 15px; margin: 15px 0;
            user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            /* Important: Ensure contenteditable=false is respected visually */
            cursor: default;
        }
        .exercise-header { font-size: 0.9rem; font-weight: 700; color: #4f46e5; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .exercise-row { margin-bottom: 12px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; line-height: 1.6; }
        
        .ex-select { 
            padding: 6px 10px; 
            border: 2px solid #cbd5e1; 
            border-radius: 6px; 
            background: white; 
            cursor: pointer; 
            outline: none;
            /* FIX 2: Force appearance to accept background colors */
            -webkit-appearance: none; 
            appearance: none; 
            /* Add arrow back since we removed appearance */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        
        /* FIX 2 CONTINUED: Strong Styles for Correct/Wrong */
        .ex-select.correct { 
            border-color: #10b981 !important; 
            background-color: #d1fae5 !important; 
            color: #065f46 !important; 
            font-weight: 700;
        }
        .ex-select.wrong { 
            border-color: #ef4444 !important; 
            background-color: #fee2e2 !important; 
            color: #991b1b !important; 
            animation: shake 0.3s; 
        }

        .ex-btn-icon { 
            background: white; border: 1px solid #e5e7eb; border-radius: 50%; 
            cursor: pointer; width: 28px; height: 28px; 
            display: flex; align-items: center; justify-content: center; 
            /* FIX 3: Prevent Text Selection on Buttons */
            user-select: none;
            -webkit-user-select: none;
        }
        .ex-btn-icon:hover { transform: scale(1.1); background: #f3f4f6; }
        
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text {
            visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 6px; padding: 10px; position: absolute; z-index: 10; bottom: 135%; left: 50%;
            margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.85rem; pointer-events: none;
        }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

    </style>
</head>
<body>

    <div id="mdc-header">
        <a href="#">MDC ENG</a>
    </div>

    <div class="input-panel">
        <div class="panel-title">Add to Favorites</div>
        <div class="input-group">
            <label>YouTube URL</label>
            <input type="text" id="vidUrl" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        <div class="input-group">
            <label>Title</label>
            <input type="text" id="vidTitle" placeholder="e.g. Grammar Class">
        </div>
        <button class="btn-save" onclick="addVideo()">Save</button>
        <div class="backup-section">
            <button class="btn-backup" onclick="downloadBackup()">Backup</button>
            <input type="file" id="importFile" accept=".html,.json" style="display:none" onchange="importBackup(this)">
            <button class="btn-backup" onclick="document.getElementById('importFile').click()">Load</button>
        </div>
    </div>

    <div class="grid-container" id="video-grid"></div>

    <div class="modal-overlay" id="editor-modal">
        <div class="editor-popup" id="editor-popup">
            
            <div class="desktop-video-container" id="desktop-video-wrapper">
                <div id="desktop-player-target" style="width:100%; height:100%;"></div>
            </div>

            <div class="editor-content-panel">
                <div class="editor-header">
                    <span class="editor-title">Note Editor</span>
                    <button class="close-editor" onclick="closeEditor()">&times;</button>
                </div>
                
                <div class="editor-toolbar">
                    <div class="toolbar-row">
                        <div class="control-group">
                            <div class="color-btn c-black" onmousedown="event.preventDefault(); applyColor('#1f2937')" id="btn-col-black"></div>
                            <div class="color-btn c-red" onmousedown="event.preventDefault(); applyColor('#ef4444')" id="btn-col-red"></div>
                            <div class="color-btn c-blue" onmousedown="event.preventDefault(); applyColor('#3b82f6')" id="btn-col-blue"></div>
                        </div>

                        <div class="control-group">
                            <button class="btn-fmt" id="btn-bold" onmousedown="event.preventDefault(); toggleBold()">B</button>
                            <div style="width:1px; height:20px; background:#d1d5db; margin:0 4px;"></div>
                            <button class="btn-fmt" id="btn-size-norm" onmousedown="event.preventDefault(); setSize(3)">T</button>
                            <button class="btn-fmt" id="btn-size-lg" onmousedown="event.preventDefault(); setSize(5)" style="font-size:1.2rem">T+</button>
                            
                            <div style="width:1px; height:20px; background:#d1d5db; margin:0 4px;"></div>
                            <button class="btn-fmt btn-ai-trigger" onclick="openAIMenu()" title="AI Exercise Hub">‚ö°</button>
                        </div>
                    </div>

                    <div class="toolbar-row">
                        <div class="opacity-control opacity-control-group">
                            <label>Opacity</label>
                            <input type="range" min="0.2" max="1" step="0.1" value="1" oninput="document.getElementById('editor-popup').style.opacity = this.value">
                        </div>
                    </div>

                    <div class="toolbar-row">
                        <div class="media-controls">
                            <button class="btn-media" onclick="seekVideo(-3)">-3s</button>
                            <button class="btn-media" onclick="togglePlay()">‚èØÔ∏è</button>
                            <button class="btn-media" onclick="seekVideo(3)">+3s</button>
                            <button class="btn-media btn-speed" id="btn-speed" onclick="cycleSpeed()">1x</button>
                        </div>
                        <button class="btn-clear" onclick="if(confirm('Clear all?')) { document.getElementById('editor-text').innerHTML=''; saveNote(); }">Erase</button>
                    </div>
                </div>

                <div id="editor-text" class="editor-area" contenteditable="true" placeholder="Type here..." oninput="saveNote()"></div>
                
                <div class="editor-footer">
                    <span class="save-indicator">‚úì Changes saved automatically</span>
                </div>
            </div>
        </div>
    </div>

    <div class="ai-popup-overlay" id="ai-hub-modal">
        <div class="ai-popup-box">
            <div class="ai-header">
                <span>‚ö° AI Exercise Hub</span>
                <button class="ai-close" onclick="closeAIMenu()">&times;</button>
            </div>
            <div class="ai-body">
                
                <div class="ai-topic-label">Choose Topic:</div>
                <select id="ai-topic-select" class="ai-select">
                    <option value="Advanced Verb Patterns">Advanced Verb Patterns</option>
                    <option value="Prepositions (In/On/At)">Prepositions (In/On/At)</option>
                    <option value="Phrasal Verbs">Phrasal Verbs</option>
                    <option value="Present Perfect vs Past Simple">Present Perfect vs Past Simple</option>
                    <option value="Conditionals (If Clauses)">Conditionals (If Clauses)</option>
                    <option value="Passive Voice">Passive Voice</option>
                    <option value="Modal Verbs">Modal Verbs</option>
                </select>

                <div class="ai-actions">
                    <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">üß† Copy Prompt</button>
                    <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">üìã Paste JSON</button>
                </div>

                <div class="saved-list-title">Memory Bank</div>
                <div class="saved-exercises-list" id="ai-memory-list">
                    <div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>
                </div>

                <button class="btn-clear-mem" onclick="clearAIMemory()">üóëÔ∏è Clear Memory</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'mdc_saved_favorites';
        const AI_MEM_KEY = 'mdc_ai_exercises';
        const grid = document.getElementById('video-grid');
        
        let gridPlayer = null;      
        let modalPlayer = null;     
        let activePlayer = null;    
        
        let currentEditIndex = -1;
        let trackingInterval = null;
        let currentVideoId = null;  

        const modal = document.getElementById('editor-modal');
        const editorArea = document.getElementById('editor-text');
        const aiModal = document.getElementById('ai-hub-modal');

        // === INIT ===
        document.addEventListener('DOMContentLoaded', () => {
            loadVideos();
            renderAiList();
        });

        // === VIDEO LOGIC ===
        function loadVideos() {
            const data = localStorage.getItem(STORAGE_KEY);
            renderGrid(data ? JSON.parse(data) : []);
        }

        function addVideo() {
            const url = document.getElementById('vidUrl').value;
            const title = document.getElementById('vidTitle').value;
            const id = (url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|live\/)([^#&?]*).*/) || [])[2];
            
            if (id && id.length === 11) {
                const videos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                videos.unshift({ 
                    id, 
                    title: title || "Video", 
                    date: new Date().toLocaleDateString(), 
                    note: "", 
                    lastTime: 0 
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(videos));
                renderGrid(videos);
                document.getElementById('vidUrl').value = '';
                document.getElementById('vidTitle').value = '';
            } else { alert("Invalid URL"); }
        }

        function deleteVideo(idx) {
            if(confirm("Delete?")) {
                const videos = JSON.parse(localStorage.getItem(STORAGE_KEY));
                videos.splice(idx, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(videos));
                renderGrid(videos);
            }
        }

        function renderGrid(videos) {
            grid.innerHTML = videos.length ? '' : '<div style="grid-column:1/-1;text-align:center;color:#666;margin-top:40px">No videos yet.</div>';
            videos.forEach((v, i) => {
                const hasNote = v.note && v.note.replace(/<[^>]*>/g, '').trim().length > 0;
                grid.innerHTML += `
                <div class="video-card">
                    <div class="thumbnail-container" onclick="initGridPlayer(this, '${v.id}')">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg">
                        <div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${hasNote ? 'üìù ' : ''}${v.title}</div>
                        <div class="card-actions">
                            <button class="btn-action btn-edit" onclick="openEditor(${i})">‚úèÔ∏è</button>
                            <button class="btn-action btn-delete" onclick="deleteVideo(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // --- GRID PLAYER ---
        function initGridPlayer(el, id) {
            currentVideoId = id;
            const videos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const vidData = videos.find(v => v.id === id);
            const startTime = vidData ? (vidData.lastTime || 0) : 0;

            el.innerHTML = `<div id="p-${id}" class="video-target"></div>`;
            el.onclick = null;
            
            gridPlayer = new YT.Player(`p-${id}`, { 
                width:'100%', height:'100%', videoId: id, 
                playerVars: { autoplay: 1, rel: 0, start: Math.floor(startTime) },
                events: {
                    'onReady': (e) => {
                         e.target.playVideo();
                         activePlayer = gridPlayer;
                    },
                    'onStateChange': (e) => onPlayerStateChange(e, id, gridPlayer)
                }
            });
        }

        // --- TRACKING LOGIC ---
        function onPlayerStateChange(event, id, playerInstance) {
            if (event.data === YT.PlayerState.PLAYING) {
                stopTracking();
                trackingInterval = setInterval(() => saveVideoTime(playerInstance, id), 5000);
            } else {
                saveVideoTime(playerInstance, id);
                stopTracking();
            }
        }

        function saveVideoTime(player, id) {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            const currentTime = player.getCurrentTime();
            if (currentTime > 0) {
                const videos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const index = videos.findIndex(v => v.id === id);
                if (index !== -1) {
                    videos[index].lastTime = currentTime;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(videos));
                }
            }
        }

        function stopTracking() {
            if (trackingInterval) { clearInterval(trackingInterval); trackingInterval = null; }
        }

        // === EDITOR & MODAL LOGIC ===
        function openEditor(i) {
            currentEditIndex = i;
            const videos = JSON.parse(localStorage.getItem(STORAGE_KEY));
            const videoData = videos[i];
            currentVideoId = videoData.id;
            editorArea.innerHTML = videoData.note || "";
            
            const isDesktop = window.matchMedia("(min-width: 900px)").matches;
            
            modal.classList.add('active');
            document.getElementById('editor-popup').style.opacity = 1;
            document.querySelector('input[type="range"]').value = 1;
            document.getElementById('btn-speed').innerText = "1x"; 

            if (isDesktop) {
                let startTime = videoData.lastTime || 0;
                if (gridPlayer && typeof gridPlayer.getCurrentTime === 'function') {
                    startTime = gridPlayer.getCurrentTime();
                    gridPlayer.pauseVideo(); 
                }

                document.getElementById('desktop-video-wrapper').innerHTML = '<div id="desktop-player-target" style="width:100%; height:100%;"></div>';
                
                modalPlayer = new YT.Player('desktop-player-target', {
                    width: '100%', height: '100%', videoId: currentVideoId,
                    playerVars: { autoplay: 1, rel: 0, start: Math.floor(startTime) },
                    events: {
                        'onReady': (e) => {
                            e.target.playVideo();
                            activePlayer = modalPlayer;
                        },
                        'onStateChange': (e) => onPlayerStateChange(e, currentVideoId, modalPlayer)
                    }
                });
            } else {
                if (gridPlayer) activePlayer = gridPlayer;
            }
            updateToolbarState();
        }

        function closeEditor() {
            if (activePlayer) {
                saveVideoTime(activePlayer, currentVideoId);
                stopTracking();
            }
            if (modalPlayer) {
                modalPlayer.destroy();
                modalPlayer = null;
            }
            const videos = JSON.parse(localStorage.getItem(STORAGE_KEY));
            renderGrid(videos); 
            modal.classList.remove('active'); 
            currentEditIndex = -1;
            activePlayer = null;
            gridPlayer = null;
            closeAIMenu();
        }

        function saveNote() {
            if(currentEditIndex > -1) {
                const videos = JSON.parse(localStorage.getItem(STORAGE_KEY));
                videos[currentEditIndex].note = editorArea.innerHTML;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(videos));
            }
        }

        // --- MEDIA CONTROLS ---
        function seekVideo(s) { if(activePlayer?.seekTo) activePlayer.seekTo(activePlayer.getCurrentTime()+s, true); }
        function togglePlay() { if(activePlayer?.getPlayerState) activePlayer.getPlayerState()===1 ? activePlayer.pauseVideo() : activePlayer.playVideo(); }
        
        function cycleSpeed() {
            if (!activePlayer || typeof activePlayer.setPlaybackRate !== 'function') return;
            const btn = document.getElementById('btn-speed');
            const currentText = btn.innerText;
            let nextRate = 1;
            if (currentText === '1x') nextRate = 0.9;
            else if (currentText === '0.9x') nextRate = 0.8;
            else if (currentText === '0.8x') nextRate = 0.7;   
            else if (currentText === '0.7x') nextRate = 0.6;
            else if (currentText === '0.6x') nextRate = 0.5;
            else if (currentText === '0.5x') nextRate = 1;
            activePlayer.setPlaybackRate(nextRate);
            btn.innerText = nextRate + 'x';
        }

        function applyColor(hex) { document.execCommand('foreColor', false, hex); updateToolbarState(); }
        function toggleBold() { document.execCommand('bold'); updateToolbarState(); }
        function setSize(size) { document.execCommand('fontSize', false, size); updateToolbarState(); }

        editorArea.addEventListener('keyup', updateToolbarState);
        editorArea.addEventListener('mouseup', updateToolbarState);
        editorArea.addEventListener('click', updateToolbarState);

        function updateToolbarState() {
            const isBold = document.queryCommandState('bold');
            document.getElementById('btn-bold').classList.toggle('is-active', isBold);
            const size = document.queryCommandValue('fontSize');
            document.getElementById('btn-size-lg').classList.toggle('is-active', size === '5' || size === 'x-large');
            document.getElementById('btn-size-norm').classList.toggle('is-active', size !== '5' && size !== 'x-large');
            const rgb = document.queryCommandValue('foreColor');
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('is-active'));
            if(rgb.includes('239, 68, 68')) document.getElementById('btn-col-red').classList.add('is-active');
            else if (rgb.includes('59, 130, 246')) document.getElementById('btn-col-blue').classList.add('is-active');
            else document.getElementById('btn-col-black').classList.add('is-active');
        }

        function downloadBackup() {
            const d = localStorage.getItem(STORAGE_KEY);
            if(!d) return alert("No data");
            const b = new Blob([`<!DOCTYPE html><html><body><script>const backupData=${d}<\/script></body></html>`],{type:'text/html'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.html';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function importBackup(inp) {
            const r = new FileReader();
            r.onload = e => {
                const m = e.target.result.match(/const backupData=(.*?)(;|<\/script>)/s);
                if(m){ localStorage.setItem(STORAGE_KEY, m[1]); loadVideos(); alert("Loaded"); }
            };
            if(inp.files[0]) r.readAsText(inp.files[0]);
        }

        // =========================================================
        // ====== AI EXERCISE HUB LOGIC ============================
        // =========================================================

        function openAIMenu() {
            aiModal.classList.add('active');
            renderAiList();
        }

        function closeAIMenu() {
            aiModal.classList.remove('active');
        }

        // 1. GENERAR PROMPT
        function copyProfessorPrompt() {
            const topic = document.getElementById('ai-topic-select').value;
            const promptText = `
You are an expert Cambridge C2 English Linguist. Create a 'Fill in the Blanks' exercise.
TOPIC: ${topic}.

STRICT RULES:
1. Provide 5 distinct sentences.
2. The missing word must be grammatically crucial.
3. The 'options' must act as plausible distractors (common mistakes), not random words.
4. The 'hint' must explain the GRAMMAR RULE, not just give the definition.
5. FORMAT: Pure JSON only. No markdown. No intro text.

JSON STRUCTURE:
[
  {
    "pre": "Text before blank",
    "answer": "correct_word",
    "post": "Text after blank",
    "options": ["correct_word", "distractor1", "distractor2", "distractor3"],
    "hint": "Grammar explanation",
    "full_sentence": "Full sentence for audio reading."
  }
]
            `.trim();

            navigator.clipboard.writeText(promptText)
                .then(() => {
                    const btn = document.querySelector('.btn-ai-primary');
                    const orig = btn.innerText;
                    btn.innerText = "‚úÖ Copied!";
                    setTimeout(() => btn.innerText = orig, 2000);
                })
                .catch(err => alert("Error: " + err));
        }

        // 2. PEGADO INTELIGENTE (FIX 1: Auto-Read Clipboard)
        async function pasteAIJson() {
            let jsonString = "";

            try {
                // Intento leer el portapapeles directamente
                jsonString = await navigator.clipboard.readText();
                
                // Feedback visual en el bot√≥n
                const btn = document.getElementById('btn-paste-json');
                const orig = btn.innerText;
                btn.innerText = "‚úÖ Pasted!";
                setTimeout(() => btn.innerText = orig, 1500);

            } catch (err) {
                // Si falla (permisos), volvemos al prompt antiguo
                jsonString = prompt("Unable to read clipboard automatically. Paste JSON here:");
            }

            if (!jsonString) return;
            processJsonAndSave(jsonString);
        }

        // Funci√≥n auxiliar para procesar el JSON
        function processJsonAndSave(jsonString) {
            try {
                let cleanString = jsonString
                    .replace(/```json/g, '')
                    .replace(/```/g, '')
                    .replace(/[\u201C\u201D]/g, '"')
                    .replace(/[\u2018\u2019]/g, "'")
                    .trim();

                const exercises = JSON.parse(cleanString);
                const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
                const title = exercises[0].full_sentence.substring(0, 25) + "...";
                
                memory.unshift({
                    id: Date.now(),
                    title: title,
                    date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString().slice(0,5),
                    data: exercises
                });

                localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
                renderAiList();

            } catch (e) {
                alert("‚ùå Invalid JSON.\nError: " + e.message);
            }
        }

        // 3. RENDERIZAR LISTA
        function renderAiList() {
            const listContainer = document.getElementById('ai-memory-list');
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');

            if (memory.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No saved exercises. Paste JSON to start.</div>';
                return;
            }

            let html = '';
            memory.forEach(item => {
                html += `
                <div class="saved-item">
                    <div class="saved-info">
                        <span class="saved-name">${item.title}</span>
                        <span class="saved-date">${item.date} ‚Ä¢ ${item.data.length} Qs</span>
                    </div>
                    <button class="btn-insert" onclick="insertExerciseFromMem(${item.id})">Insert</button>
                </div>
                `;
            });
            listContainer.innerHTML = html;
        }

        // 4. INSERTAR AL FINAL (FIX 4: insertAdjacentHTML beforeend)
        function insertExerciseFromMem(id) {
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            const item = memory.find(x => x.id === id);
            
            if (!item) return;

            let htmlBlock = `<div class="exercise-box" contenteditable="false">
                                <div class="exercise-header">‚úçÔ∏è Practice: ${item.title}</div>`;

            item.data.forEach((ex, index) => {
                let optsHtml = `<option value="" disabled selected>Select...</option>`;
                ex.options.forEach(opt => {
                    optsHtml += `<option value="${opt}">${opt}</option>`;
                });

                const uniqueId = `ex-${id}-${index}`;

                // FIX 3: Buttons have explicit onclick attributes, relying on contenteditable=false wrapper
                htmlBlock += `
                <div class="exercise-row" id="${uniqueId}">
                    <span><b>${index + 1}.</b> ${ex.pre}</span>
                    <select class="ex-select" onchange="window.validateExercise(this, '${ex.answer}')">
                        ${optsHtml}
                    </select>
                    <span>${ex.post}</span>
                    <div style="display:inline-flex; gap:5px; margin-left:10px;">
                        <button class="ex-btn-icon" contenteditable="false" onclick="window.speakText('${ex.full_sentence.replace(/'/g, "\\'")}')" title="Listen">üîä</button>
                        <div class="tooltip-container">
                            <button class="ex-btn-icon" contenteditable="false">‚ùì</button>
                            <span class="tooltip-text">${ex.hint}</span>
                        </div>
                    </div>
                </div>`;
            });

            htmlBlock += '</div><p><br></p>';

            // FIX 4: Append to END of document
            editorArea.insertAdjacentHTML('beforeend', htmlBlock);
            editorArea.scrollTop = editorArea.scrollHeight; // Scroll to bottom
            
            saveNote();
            closeAIMenu();
        }

        function clearAIMemory() {
            if(confirm("Clear all saved exercises?")) {
                localStorage.removeItem(AI_MEM_KEY);
                renderAiList();
            }
        }

        // 5. VALIDACI√ìN GLOBAL
        window.validateExercise = function(selectEl, correctAnswer) {
            const selectedVal = selectEl.value;
            selectEl.classList.remove('correct', 'wrong');
            
            // Trim whitespace just in case
            if (selectedVal.trim().toLowerCase() === correctAnswer.trim().toLowerCase()) {
                selectEl.classList.add('correct');
            } else {
                selectEl.classList.add('wrong');
                if(navigator.vibrate) navigator.vibrate(200);
            }
        };

        window.speakText = function(text) {
            // FIX 3: Ensure this event doesn't trigger text selection
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; 
                utterance.rate = 0.9; 
                window.speechSynthesis.speak(utterance);
            } else {
                alert("TTS not supported.");
            }
        };

    </script>
</body>
</html>
