<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fusionador Pro v5: SubtÃ­tulos a HTML Final</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #27ae60;
            --danger: #e74c3c;
            --upload: #8e44ad;
            --bg: #f4f7f6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); padding: 20px; color: #333; }
        
        /* Cabecera y Links */
        .header { text-align: center; margin-bottom: 20px; }
        h2 { color: var(--secondary); margin-bottom: 15px; }
        
        .resources {
            background: #fff; padding: 10px 20px; border-radius: 50px;
            display: inline-flex; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            align-items: center; font-size: 0.9rem;
        }
        .resource-link {
            text-decoration: none; color: #fff; background: var(--secondary);
            padding: 8px 16px; border-radius: 20px; font-weight: bold; transition: 0.3s;
            display: flex; align-items: center; gap: 5px;
        }
        .resource-link:hover { background: #34495e; transform: translateY(-2px); }
        .resource-link.blue { background: var(--primary); }

        /* Opciones Adicionales (NUEVO: URL de YouTube) */
        .options {
            display: flex; gap: 15px; margin-bottom: 15px; padding: 15px;
            background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .option-field {
            flex: 1; display: flex; flex-direction: column; 
        }
        .option-field label {
            font-weight: bold; color: var(--secondary); margin-bottom: 5px; font-size: 0.95em;
        }
        .option-field input {
            padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 14px;
        }
        .option-field input:focus { border-color: var(--primary); outline: none; }
        /* FIN NUEVO */

        /* Contenedor Principal (ajustado para dar espacio a la URL) */
        .container { display: flex; gap: 15px; height: 60vh; }
        .column { flex: 1; display: flex; flex-direction: column; background: #fff; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .toolbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px;
        }
        .toolbar label { font-weight: bold; color: var(--secondary); font-size: 0.95em; }
        
        .mini-btn-group { display: flex; gap: 5px; }
        
        /* Estilos de botones mini */
        .mini-btn {
            padding: 4px 10px; border: 1px solid #ddd; background: #f9f9f9;
            border-radius: 4px; cursor: pointer; font-size: 11px; transition: 0.2s;
            display: flex; align-items: center; gap: 4px; font-weight: 600;
        }
        .mini-btn:hover { background: #e2e6ea; }
        
        .mini-btn.copy { color: var(--primary); border-color: var(--primary); }
        .mini-btn.paste { color: var(--accent); border-color: var(--accent); }
        .mini-btn.clear { color: var(--danger); border-color: var(--danger); }
        .mini-btn.clear:hover { background: #fdedec; }
        
        /* BotÃ³n de subir archivo (Label estilizado) */
        .upload-label { color: white; background-color: var(--upload); border-color: var(--upload); }
        .upload-label:hover { background-color: #732d91; color: white; }
        input[type="file"] { display: none; }

        textarea {
            flex: 1; padding: 10px; border: 1px solid #eee; border-radius: 5px;
            font-family: 'Consolas', monospace; font-size: 12px; resize: none;
            background: #fafafa; color: #444;
        }
        textarea:focus { border-color: var(--primary); outline: none; background: #fff; }

        /* Botones Principales */
        .btn-container { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .main-btn {
            padding: 15px 40px; border: none; border-radius: 30px; cursor: pointer;
            font-size: 16px; font-weight: bold; transition: 0.3s; display: flex; align-items: center; gap: 10px;
            color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-generate { background: var(--accent); }
        .btn-generate:hover { background: #219150; transform: translateY(-2px); }
        .btn-clear-all { background: var(--danger); }
        .btn-clear-all:hover { background: #c0392b; transform: translateY(-2px); }

        #output { background: #2c3e50; color: #ecf0f1; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Fusionador de SubtÃ­tulos Ultimate v5</h2>
        <div class="resources">
            <span>Herramientas:</span>
            <a href="https://downsub.com/" target="_blank" class="resource-link">â¬‡ï¸ DownSub</a>
            <a href="https://translatesubtitles.co" target="_blank" class="resource-link blue">ğŸŒ TranslateSubtitles</a>
        </div>
    </div>
    
    <div class="options">
        <div class="option-field">
            <label for="youtubeUrl">URL de YouTube:</label>
            <input type="text" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=XXXXXXXXXXX" value="https://www.youtube.com/watch?v=-moW9jvvMr4">
        </div>
    </div>
    <div class="container">
        <div class="column">
            <div class="toolbar">
                <label>1. InglÃ©s (Original)</label>
                <div class="mini-btn-group">
                    <input type="file" id="fileEng" accept=".srt,.txt">
                    <label for="fileEng" class="mini-btn upload-label" title="Subir archivo SRT">ğŸ“‚ Subir</label>
                    <button class="mini-btn paste" onclick="pasteText('inputEng')" title="Pegar">ğŸ“‹</button>
                    <button class="mini-btn copy" onclick="copyText('inputEng')" title="Copiar">ğŸ“‘</button>
                    <button class="mini-btn clear" onclick="clearText('inputEng')" title="Borrar">âŒ</button>
                </div>
            </div>
            <textarea id="inputEng" placeholder="Sube un archivo o pega el SRT en INGLÃ‰S..."></textarea>
        </div>

        <div class="column">
            <div class="toolbar">
                <label>2. EspaÃ±ol (Traducido)</label>
                <div class="mini-btn-group">
                    <input type="file" id="fileEsp" accept=".srt,.txt">
                    <label for="fileEsp" class="mini-btn upload-label" title="Subir archivo SRT">ğŸ“‚ Subir</label>
                    <button class="mini-btn paste" onclick="pasteText('inputEsp')" title="Pegar">ğŸ“‹</button>
                    <button class="mini-btn copy" onclick="copyText('inputEsp')" title="Copiar">ğŸ“‘</button>
                    <button class="mini-btn clear" onclick="clearText('inputEsp')" title="Borrar">âŒ</button>
                </div>
            </div>
            <textarea id="inputEsp" placeholder="Sube un archivo o pega el SRT en ESPAÃ‘OL..."></textarea>
        </div>

        <div class="column">
            <div class="toolbar">
                <label>3. Resultado HTML COMPLETO</label>
                <div class="mini-btn-group">
                    <button class="mini-btn copy" onclick="copyText('output')" title="Copiar cÃ³digo final">ğŸ“‘ COPIAR CÃ“DIGO</button>
                    <button class="mini-btn clear" onclick="clearText('output')" title="Borrar resultado">âŒ</button>
                </div>
            </div>
            <textarea id="output" readonly placeholder="El cÃ³digo HTML completo aparecerÃ¡ aquÃ­..."></textarea>
        </div>
    </div>

    <div class="btn-container">
        <button class="main-btn btn-clear-all" onclick="clearAll()">
            ğŸ—‘ï¸ BORRAR TODO
        </button>
        <button class="main-btn btn-generate" onclick="fusionar()">
            âš¡ FUSIONAR Y GENERAR
        </button>
    </div>

    <script>
        // --- Manejo de Archivos (File Reader) ---
        function handleFileUpload(fileInputId, textAreaId) {
            document.getElementById(fileInputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const textArea = document.getElementById(textAreaId);
                    textArea.value = content;
                    
                    // Efecto visual de Ã©xito
                    textArea.style.backgroundColor = "#e8f5e9";
                    setTimeout(() => textArea.style.backgroundColor = "", 500);
                };
                reader.readAsText(file);
                
                // Resetear el input para permitir subir el mismo archivo de nuevo si se borra
                this.value = null; 
            });
        }

        // Inicializar los escuchadores de eventos para subir archivos
        handleFileUpload('fileEng', 'inputEng');
        handleFileUpload('fileEsp', 'inputEsp');


        // --- Funciones de Interfaz ---
        function clearText(elementId) {
            document.getElementById(elementId).value = "";
            const el = document.getElementById(elementId);
            el.style.backgroundColor = "#fdedec";
            setTimeout(() => el.style.backgroundColor = "", 200);
        }

        function clearAll() {
            if (confirm("Â¿EstÃ¡s seguro de que quieres borrar todo?")) {
                clearText('inputEng');
                clearText('inputEsp');
                clearText('output');
                // Resetear el valor de ejemplo en la URL
                document.getElementById('youtubeUrl').value = "https://www.youtube.com/watch?v=-moW9jvvMr4";
            }
        }

        async function pasteText(elementId) {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById(elementId).value = text;
            } catch (err) {
                alert('âš ï¸ Usa Ctrl+V para pegar.');
            }
        }

        function copyText(elementId) {
            const textarea = document.getElementById(elementId);
            if (!textarea.value) return;
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert("âœ… Â¡Copiado al portapapeles!");
            });
        }

        // --- LÃ³gica de FusiÃ³n (SRT Processing) ---

        function getYouTubeVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|\w\/.+\/|embed\/|v\/|watch\?v=|[^#]*\??v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            return (match && match[1].length === 11) ? match[1] : null;
        }

        function timeToSeconds(timeString) {
            try {
                const parts = timeString.split(':');
                const hours = parseInt(parts[0]);
                const minutes = parseInt(parts[1]);
                const secondsPart = parts[2].split(/[,.]/); 
                const seconds = parseInt(secondsPart[0]);
                const milliseconds = parseInt(secondsPart[1]) || 0;
                return (hours * 3600) + (minutes * 60) + seconds + (milliseconds / 1000);
            } catch (e) { return 0; }
        }

        function parseSRT(text) {
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n') + "\n\n";
            const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2}[,.]\d{3})\s-->\s(\d{2}:\d{2}:\d{2}[,.]\d{3})\s+([\s\S]*?)(?=\n\n|\n\d+\s+\d{2}:\d{2}|$)/g;
            const bloques = [];
            let match;

            while ((match = regex.exec(text)) !== null) {
                const cleanText = match[4].replace(/<\/?[^>]+(>|$)/g, "").replace(/\n/g, ' ').replace(/\s\s+/g, ' ').trim();
                
                bloques.push({
                    id: match[1],
                    start: match[2].replace('.', ','), 
                    text: cleanText
                });
            }
            return bloques;
        }

        function generateSubtitleBlocks(engBlocks, espBlocks) {
            let htmlBlocksOutput = "";

            for (let i = 0; i < engBlocks.length; i++) {
                const engItem = engBlocks[i];
                const espText = espBlocks[i] ? espBlocks[i].text : "";
                // Usamos la funciÃ³n original timeToSeconds para el data-time
                const seconds = timeToSeconds(engItem.start); 

                const htmlBlock = 
`<div class="line" data-time="${seconds}">
  <div class="line-content">
    <div class="text-block">
      <div class="english">${engItem.text}</div>
      <div class="spanish">${espText}</div>
    </div>
    <div class="controls">
      <button class="btn playBtn">Play</button>
      <button class="btn speakBtn">Speak</button>
    </div>
  </div>
</div>`;
                htmlBlocksOutput += htmlBlock + "\n\n";
            }
            return htmlBlocksOutput;
        }
        
        function fusionar() {
            const rawEng = document.getElementById('inputEng').value;
            const rawEsp = document.getElementById('inputEsp').value;
            const youtubeUrl = document.getElementById('youtubeUrl').value.trim();

            // 1. Validaciones y obtenciÃ³n de datos
            if (!rawEng.trim()) {
                alert("âš ï¸ Â¡Falta el archivo en InglÃ©s!");
                return;
            }
            if (!youtubeUrl) {
                alert("âš ï¸ Â¡Falta la URL de YouTube!");
                return;
            }
            
            const videoId = getYouTubeVideoId(youtubeUrl);
            if (!videoId) {
                 alert("âš ï¸ Â¡La URL de YouTube no es vÃ¡lida o estÃ¡ incompleta!");
                return;
            }

            // 2. Procesar SubtÃ­tulos
            const engBlocks = parseSRT(rawEng);
            const espBlocks = parseSRT(rawEsp);
            
            // 3. Generar bloques HTML de subtÃ­tulos fusionados
            const subtitleBlocks = generateSubtitleBlocks(engBlocks, espBlocks);
            
            // 4. Obtener Plantilla y Ensamblar
            const template = getOriginalTemplate();
            
            // A. Reemplazar el ID de YouTube
            let finalCode = template.replace(
                /const YOUTUBE_ID\s*=\s*'.*?';\s*\/\/ CAMBIAR ID AQUÃ/,
                `const YOUTUBE_ID = '${videoId}'; // ID DE YOUTUBE GENERADO`
            );

            // B. Insertar los bloques de subtÃ­tulos
            finalCode = finalCode.replace(
                '',
                '\n' + subtitleBlocks + '\n'
            );


            document.getElementById('output').value = finalCode;
            
            if (engBlocks.length !== espBlocks.length && rawEsp.trim()) {
                alert(`â„¹ï¸ Proceso completado. Nota: InglÃ©s tiene ${engBlocks.length} lÃ­neas y EspaÃ±ol ${espBlocks.length}. El cÃ³digo completo ya estÃ¡ en el campo de resultado.`);
            } else {
                alert("âœ… Â¡CÃ³digo generado con Ã©xito! El HTML completo ya estÃ¡ en el campo de Resultado (3).");
            }
        }
        
        // --- PLANTILLA ORIGINAL COMPLETA (COMBINADA DE TUS DOS FRAGMENTOS) ---
        function getOriginalTemplate() {
            return `<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>MDC ENG - Video Learning</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
Â  :root {
Â  Â  --primary: #4f46e5; Â  Â  Â  /* Ãndigo profesional */
Â  Â  --primary-hover: #4338ca;
Â  Â  --accent: #ec4899; Â  Â  Â  Â /* Rosa para destaques */
Â  Â  --bg-body: #f3f4f6;
Â  Â  --card-bg: #ffffff;
Â  Â  --text-main: #1f2937;
Â  Â  --text-sec: #6b7280;
Â  Â  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
Â  Â  --radius: 12px;
Â  Â  --header-height: 50px; Â  Â /* Altura fija para cÃ¡lculos */
Â  }

Â  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

Â  body {
Â  Â  margin: 0;
Â  Â  font-family: 'Inter', sans-serif;
Â  Â  background: var(--bg-body);
Â  Â  color: var(--text-main);
Â  Â  padding-top: var(--header-height); /* Espacio para el header fijo */
Â  }

Â  /* ====== HEADER MEJORADO (Estilo App) ====== */
Â  #mdc-header {
Â  Â  position: fixed;
Â  Â  top: 0; left: 0; width: 100%;
Â  Â  height: var(--header-height);
Â  Â  background: rgba(31, 41, 55, 0.95); /* Oscuro casi opaco */
Â  Â  backdrop-filter: blur(10px); Â  Â  Â  Â /* Efecto vidrio */
Â  Â  color: white;
Â  Â  z-index: 1000;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  border-bottom: 1px solid rgba(255,255,255,0.1);
Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
Â  }
Â  #mdc-header a {
Â  Â  color: white;
Â  Â  text-decoration: none;
Â  Â  font-weight: 700;
Â  Â  font-size: 16px;
Â  Â  letter-spacing: 0.5px;
Â  }

Â  /* ====== CONTENEDOR PRINCIPAL ====== */
Â  .page-max-width {
Â  Â  max-width: 600px;
Â  Â  margin: 0 auto;
Â  Â  width: 100%;
Â  Â  position: relative;
Â  }

Â  /* ====== VIDEO STICKY (Optimizado) ====== */
Â  .video-wrapper {
Â  Â  position: sticky;
Â  Â  top: var(--header-height); /* Se pega justo debajo del header */
Â  Â  width: 100%;
Â  Â  background: #000;
Â  Â  z-index: 500;
Â  Â  box-shadow: var(--shadow);
Â  }
Â  .video-inner {
Â  Â  position: relative;
Â  Â  padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
Â  Â  height: 0;
Â  Â  overflow: hidden;
Â  }
Â  .video-inner iframe {
Â  Â  position: absolute;
Â  Â  top: 0; left: 0;
Â  Â  width: 100%; height: 100%;
Â  Â  border: 0;
Â  }

Â  /* ====== LISTA DE DIÃLOGOS ====== */
Â  .dialogue-container {
Â  Â  padding: 20px 15px 80px 15px; /* Padding bottom extra para botÃ³n flotante */
Â  }

Â  .line {
Â  Â  background: var(--card-bg);
Â  Â  border-radius: var(--radius);
Â  Â  padding: 18px;
Â  Â  margin-bottom: 16px;
Â  Â  box-shadow: var(--shadow);
Â  Â  border-left: 4px solid transparent;
Â  Â  transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
Â  }

Â  /* Estado Activo */
Â  .line.active {
Â  Â  border-left-color: var(--primary);
Â  Â  background-color: #eef2ff; /* Azul muy suave */
Â  Â  transform: scale(1.02);
Â  Â  box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2);
Â  }

Â  .line-content {
Â  Â  display: flex;
Â  Â  gap: 15px;
Â  Â  align-items: flex-start;
Â  }

Â  /* Textos */
Â  .text-block {
Â  Â  flex: 1;
Â  Â  cursor: pointer;
Â  }
Â  .english {
Â  Â  font-size: 1.05rem;
Â  Â  font-weight: 600;
Â  Â  line-height: 1.5;
Â  Â  color: var(--text-main);
Â  Â  margin-bottom: 6px;
Â  }
Â  .spanish {
Â  Â  font-size: 0.95rem;
Â  Â  color: var(--text-sec);
Â  Â  border-top: 1px solid #eee;
Â  Â  padding-top: 6px;
Â  Â  display: none; /* Oculto por defecto */
Â  Â  line-height: 1.4;
Â  }
Â  .spanish.visible {
Â  Â  display: block;
Â  Â  animation: fadeIn 0.3s ease;
Â  }

Â  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

Â  /* Botones de LÃ­nea */
Â  .controls {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 8px;
Â  Â  min-width: 80px;
Â  }

Â  .btn {
Â  Â  border: none;
Â  Â  border-radius: 8px;
Â  Â  padding: 8px 0;
Â  Â  font-size: 13px;
Â  Â  font-weight: 600;
Â  Â  cursor: pointer;
Â  Â  transition: all 0.2s;
Â  Â  text-transform: uppercase;
Â  Â  letter-spacing: 0.5px;
Â  Â  width: 100%;
Â  }

Â  .playBtn {
Â  Â  background-color: var(--primary);
Â  Â  color: white;
Â  }
Â  .playBtn:hover { background-color: var(--primary-hover); }
Â Â 
Â  /* Estado Reproduciendo (Rojo Stop) */
Â  .playBtn[data-state="playing"] {
Â  Â  background-color: #ef4444;
Â  Â  animation: pulse 1.5s infinite;
Â  }

Â  .speakBtn {
Â  Â  background-color: #e5e7eb;
Â  Â  color: var(--text-main);
Â  }
Â  .speakBtn:hover { background-color: #d1d5db; }
Â Â 
Â  /* Estado Hablando */
Â  .speakBtn[data-state="speaking"] {
Â  Â  background-color: var(--accent);
Â  Â  color: white;
Â  }

Â  /* ====== BOTÃ“N FLOTANTE (Global Toggle) ====== */
Â  .fab-toggle {
Â  Â  position: fixed;
Â  Â  bottom: 20px;
Â  Â  right: 20px;
Â  Â  width: 56px;
Â  Â  height: 56px;
Â  Â  background: var(--text-main);
Â  Â  color: white;
Â  Â  border-radius: 50%;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  font-size: 24px;
Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
Â  Â  cursor: pointer;
Â  Â  z-index: 100;
Â  Â  transition: transform 0.2s;
Â  }
Â  .fab-toggle:active { transform: scale(0.9); }

Â  @keyframes pulse {
Â  Â  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
Â  Â  70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
Â  Â  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
Â  }

Â  /* Media Queries */
Â  @media (max-width: 640px) {
Â  Â  .line { padding: 15px; }
Â  Â  .english { font-size: 1rem; }
Â  Â  .controls { min-width: 70px; }
Â  }
</style>
</head>
<body>

Â  <div id="mdc-header">
Â  Â  <a href="https://paradisonetworx.com/mdceng">MDC ENG</a>
Â  </div>

Â  <div class="page-max-width">
Â  Â Â 
Â  Â  <div class="video-wrapper">
Â  Â  Â  <div class="video-inner">
Â  Â  Â  Â  <div id="player"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="dialogue-container">
Â  Â  Â Â 
Â  Â Â 
Â  Â  Â  </div>
Â  </div>

Â  <div class="fab-toggle" onclick="toggleAllTranslations()" title="Ver/Ocultar todas las traducciones">
Â  Â  ğŸ‘ï¸
Â  </div>

<script>
/* ====== CONFIGURACIÃ“N ====== */
// Ajuste fino: Si la frase empieza muy rÃ¡pido, resta 0.5s. Si acaba abruptamente, suma 1.5s
const TIME_OFFSET = -0.2;Â 
const END_PADDING = 0.5;Â 
const YOUTUBE_ID Â = '-moW9jvvMr4'; // CAMBIAR ID AQUÃ

/* ====== VARIABLES GLOBALES ====== */
let player;
let checkInterval;
let isSegmentPlaying = false;
let segmentEndTime = 0;
let currentSynth = null;
let scrollEnabled = true;

// ====== YOUTUBE API ======
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);

function onYouTubeIframeAPIReady() {
Â  player = new YT.Player('player', {
Â  Â  videoId: YOUTUBE_ID,
Â  Â  playerVars: {Â 
Â  Â  Â  playsinline: 1,Â 
Â  Â  Â  rel: 0,Â 
Â  Â  Â  modestbranding: 1,
Â  Â  Â  controls: 1
Â  Â  },
Â  Â  events: {
Â  Â  Â  'onStateChange': onPlayerStateChange
Â  Â  }
Â  });
}

/* ====== LÃ“GICA PRINCIPAL (Heartbeat) ====== */
// Esta funciÃ³n se ejecuta cada 100ms cuando el video corre
function checkTime() {
Â  if (!player || !player.getCurrentTime) return;
Â Â 
Â  const currentTime = player.getCurrentTime();

Â  // 1. Control de Segmento (Play Button)
Â  // AquÃ­ estÃ¡ la MAGIA: Si estamos reproduciendo un segmento, verificamos el tiempo actual.
Â  // No usamos setTimeout, asÃ­ que si hay buffering, espera.
Â  if (isSegmentPlaying && currentTime >= segmentEndTime) {
Â  Â  player.pauseVideo();
Â  Â  isSegmentPlaying = false;
Â  Â  resetButtons();
Â  Â  scrollEnabled = true; // Reactivar scroll automÃ¡tico global
Â  Â  return;Â 
Â  }

Â  // 2. Resaltado AutomÃ¡tico (Scroll)
Â  if (scrollEnabled) {
Â  Â  highlightCurrentLine(currentTime);
Â  }
}

function onPlayerStateChange(event) {
Â  if (event.data === YT.PlayerState.PLAYING) {
Â  Â  // Iniciar el monitor de tiempo
Â  Â  clearInterval(checkInterval);
Â  Â  checkInterval = setInterval(checkTime, 100);
Â  } else {
Â  Â  clearInterval(checkInterval);
Â  }
}

/* ====== MANEJO DE DOM ====== */

// Resaltar lÃ­nea actual basada en el tiempo
function highlightCurrentLine(time) {
Â  const lines = document.querySelectorAll('.line');
Â  let activeLine = null;

Â  lines.forEach((line, index) => {
Â  Â  const start = parseFloat(line.dataset.time);
Â  Â  // El fin es el inicio de la siguiente lÃ­nea, o +10s si es la Ãºltima
Â  Â  const nextLine = lines[index + 1];
Â  Â  const end = nextLine ? parseFloat(nextLine.dataset.time) : start + 10;

Â  Â  if (time >= start && time < end) {
Â  Â  Â  activeLine = line;
Â  Â  }
Â  Â  line.classList.remove('active');
Â  });

Â  if (activeLine) {
Â  Â  activeLine.classList.add('active');
Â  Â  scrollToLine(activeLine);
Â  }
}

function scrollToLine(element) {
Â  // Scroll suave para centrar el elemento, teniendo en cuenta el header y el video sticky
Â  const headerOffset = 100; // <--- ESTE ES EL PROBLEMA
Â  const elementPosition = element.getBoundingClientRect().top;
Â  const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

Â  // Solo hacemos scroll si estÃ¡ muy lejos del foco (para no marear)
Â  if (elementPosition < 150 || elementPosition > window.innerHeight - 150) {
Â  Â  window.scrollTo({
Â  Â  Â  top: offsetPosition,
Â  Â  Â  behavior: "smooth"
Â  Â  });
Â  }
}

/* ====== BOTONES PLAY (SEGMENTOS) ====== */
document.querySelectorAll('.playBtn').forEach(btn => {
Â  btn.addEventListener('click', (e) => {
Â  Â  e.stopPropagation(); // Evitar abrir traducciÃ³n
Â  Â  const line = btn.closest('.line');
Â  Â  const start = parseFloat(line.dataset.time) + TIME_OFFSET;
Â  Â Â 
Â  Â  // Calcular fin basado en la siguiente lÃ­nea
Â  Â  const nextLine = line.nextElementSibling;
Â  Â  const nextTime = nextLine ? parseFloat(nextLine.dataset.time) : start + 5;
Â  Â  const end = nextTime + END_PADDING;

Â  Â  // Si ya estÃ¡ sonando este botÃ³n, paramos
Â  Â  if (btn.dataset.state === 'playing') {
Â  Â  Â  player.pauseVideo();
Â  Â  Â  isSegmentPlaying = false;
Â  Â  Â  resetButtons();
Â  Â  Â  return;
Â  Â  }

Â  Â  // Iniciar reproducciÃ³n
Â  Â  resetButtons(); // Limpiar otros
Â  Â  resetSynth(); Â  // Calla la voz sintÃ©tica si habla
Â  Â Â 
Â  Â  scrollEnabled = false; // Desactivar scroll auto para que no salte
Â  Â  isSegmentPlaying = true;
Â  Â  segmentEndTime = end;
Â  Â Â 
Â  Â  player.seekTo(Math.max(0, start), true);
Â  Â  player.playVideo();
Â  Â Â 
Â  Â  btn.textContent = "Stop";
Â  Â  btn.dataset.state = 'playing';
Â  Â  line.classList.add('active');
Â  });
});

/* ====== BOTONES SPEAK (TTS MEJORADO) ====== */
// Cargar voces
let voices = [];
window.speechSynthesis.onvoiceschanged = () => {
Â  voices = window.speechSynthesis.getVoices();
};

document.querySelectorAll('.speakBtn').forEach(btn => {
Â  btn.addEventListener('click', (e) => {
Â  Â  e.stopPropagation();
Â  Â  const line = btn.closest('.line');
Â  Â  const text = line.querySelector('.english').innerText;

Â  Â  if (btn.dataset.state === 'speaking') {
Â  Â  Â  resetSynth();
Â  Â  Â  resetButtons();
Â  Â  Â  return;
Â  Â  }

Â  Â  resetButtons();
Â  Â  resetSynth();
Â  Â  player.pauseVideo(); // Callar video si suena

Â  Â  const utter = new SpeechSynthesisUtterance(text);
Â  Â Â 
Â  Â  // Intentar buscar una voz mejor (Google US o Samantha)
Â  Â  const preferredVoice = voices.find(v =>Â 
Â  Â  Â  v.name.includes('Google US English') ||Â 
Â  Â  Â  v.name.includes('Samantha') ||Â 
Â  Â  Â  v.lang === 'en-US'
Â  Â  );
Â  Â Â 
Â  Â  if (preferredVoice) utter.voice = preferredVoice;
Â  Â  utter.lang = 'en-US';
Â  Â  utter.rate = 0.9; // Un poco mÃ¡s lento para claridad

Â  Â  utter.onstart = () => {
Â  Â  Â  btn.textContent = "Stop";
Â  Â  Â  btn.dataset.state = 'speaking';
Â  Â  Â  line.classList.add('active');
Â  Â  };
Â  Â Â 
Â  Â  utter.onend = () => {
Â  Â  Â  resetButtons();
Â  Â  };

Â  Â  window.speechSynthesis.speak(utter);
Â  });
});

/* ====== UTILIDADES ====== */
function resetButtons() {
Â  document.querySelectorAll('.playBtn').forEach(b => {
Â  Â  b.textContent = "Play";
Â  Â  b.removeAttribute('data-state');
Â  });
Â  document.querySelectorAll('.speakBtn').forEach(b => {
Â  Â  b.textContent = "Speak";
Â  Â  b.removeAttribute('data-state');
Â  });
Â  // No quitamos la clase 'active' de la lÃ­nea para no perder el foco visual
}

function resetSynth() {
Â  window.speechSynthesis.cancel();
}

// Toggle de traducciÃ³n individual
document.querySelectorAll('.text-block').forEach(block => {
Â  block.addEventListener('click', () => {
Â  Â  const span = block.querySelector('.spanish');
Â  Â  span.classList.toggle('visible');
Â  });
});

// Toggle global (BotÃ³n Flotante)
let allVisible = false;
function toggleAllTranslations() {
Â  allVisible = !allVisible;
Â  document.querySelectorAll('.spanish').forEach(span => {
Â  Â  if (allVisible) span.classList.add('visible');
Â  Â  else span.classList.remove('visible');
Â  });
}
</script>
</body>
</html>`;
        }
    </script>

</body>
</html>
