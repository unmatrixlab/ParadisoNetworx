<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Biblioteca JSON</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #f3f4f6; --card: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px 20px; min-height: 100vh; margin: 0; color: #1f2937; }
        .container { background: var(--card); width: 100%; max-width: 700px; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        
        h1 { margin-top: 0; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .badge { background: #e0e7ff; color: var(--primary); font-size: 12px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; }

        /* SECTIONS */
        .step-section { margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fafafa; position: relative; }
        .step-number { position: absolute; top: -12px; left: 20px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .step-title { font-weight: 800; margin-bottom: 15px; display: block; color: #374151; }

        /* INPUTS */
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 700; color: #6b7280; margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"] { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; outline: none; box-sizing: border-box; }
        input[type="text"]:focus { border-color: var(--primary); }
        
        /* FILE UPLOADS */
        .file-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .file-box { border: 2px dashed #cbd5e1; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; position: relative; transition: 0.2s; background: white; }
        .file-box:hover { border-color: var(--primary); background: #eef2ff; }
        .file-box input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-status { font-weight: 600; color: #4b5563; font-size: 13px; }
        .file-box.loaded { border-color: var(--success); background: #d1fae5; }
        .file-box.loaded .file-status { color: #065f46; }

        /* BUTTONS */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-load { background: #374151; color: white; margin-top: 10px; }
        .btn-generate { background: var(--primary); color: white; font-size: 16px; margin-top: 10px; }
        .btn-generate:hover { background: #4338ca; transform: translateY(-2px); }
        
        textarea { width: 100%; height: 200px; margin-top: 20px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; font-size: 12px; resize: vertical; display: none; background: #1f2937; color: #a5f3fc; box-sizing: border-box; }
        
        .copy-btn { background: var(--success); color: white; margin-top: 10px; display: none; }
        .status-msg { font-size: 12px; margin-top: 5px; color: #6b7280; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Gestor de Biblioteca <span class="badge">V2.0</span></h1>
    <p style="color:#666; font-size:14px; margin-bottom:25px;">Agrega videos a tu lista existente sin romper el formato.</p>

    <div class="step-section">
        <div class="step-number">PASO 1</div>
        <span class="step-title">Cargar Biblioteca Actual</span>
        <div class="group">
            <label>URL Raw de GitHub (Tu archivo biblioteca.json)</label>
            <input type="text" id="existing-url" placeholder="https://raw.githubusercontent.com/Usuario/Repo/main/biblioteca.json">
        </div>
        <button class="btn-load" onclick="loadExistingLibrary()">üì• DESCARGAR Y ANALIZAR</button>
        <div id="load-status" class="status-msg">Esperando URL...</div>
    </div>

    <div class="step-section" id="step-2" style="opacity:0.5; pointer-events:none;">
        <div class="step-number">PASO 2</div>
        <span class="step-title">Datos del Nuevo Video</span>
        
        <div class="group">
            <label>URL de YouTube</label>
            <input type="text" id="yt-url" placeholder="https://www.youtube.com/watch?v=..." oninput="validateYoutube()">
        </div>
        <div class="group">
            <label>T√≠tulo del Video</label>
            <input type="text" id="vid-title" placeholder="Ej: Entrevista con Elon Musk">
        </div>
        <div class="group">
            <label>Archivos de Subt√≠tulos (.srt)</label>
            <div class="file-grid">
                <div class="file-box" id="box-en">
                    <span class="file-status" id="status-en">üá∫üá∏ Ingl√©s</span>
                    <input type="file" id="file-en" accept=".srt" onchange="updateStatus(this, 'box-en', 'status-en')">
                </div>
                <div class="file-box" id="box-es">
                    <span class="file-status" id="status-es">üá™üá∏ Espa√±ol</span>
                    <input type="file" id="file-es" accept=".srt" onchange="updateStatus(this, 'box-es', 'status-es')">
                </div>
            </div>
        </div>
    </div>

    <button class="btn-generate" id="btn-gen" onclick="generateMergedJSON()" disabled style="opacity:0.5;">FUSIONAR Y GENERAR C√ìDIGO ‚ú®</button>
    
    <textarea id="output" readonly></textarea>
    <button class="copy-btn" id="btn-copy" onclick="copyToClipboard()">COPIAR JSON COMPLETO üìã</button>
</div>

<script>
    let CURRENT_LIBRARY = []; // Aqu√≠ se guarda lo que bajamos de GitHub
    let IS_LOADED = false;

    // 1. CARGAR LIBRER√çA EXISTENTE
    async function loadExistingLibrary() {
        const url = document.getElementById('existing-url').value.trim();
        const status = document.getElementById('load-status');
        
        if(!url) return alert("Pega la URL Raw de GitHub primero.");
        
        status.innerText = "‚è≥ Conectando...";
        status.style.color = "#4f46e5";

        try {
            // A√±adimos timestamp para evitar cach√© vieja
            const res = await fetch(url + '?t=' + new Date().getTime());
            if(!res.ok) throw new Error("No se pudo conectar (Error " + res.status + ")");
            
            CURRENT_LIBRARY = await res.json();
            
            if(!Array.isArray(CURRENT_LIBRARY)) {
                // Si el archivo estaba vac√≠o o mal formado, iniciamos array vac√≠o
                CURRENT_LIBRARY = [];
            }

            // UI UPDATES
            IS_LOADED = true;
            status.innerHTML = `‚úÖ <b>¬°√âxito!</b> Se encontraron ${CURRENT_LIBRARY.length} videos en la nube.`;
            status.style.color = "#065f46";
            
            // Habilitar Paso 2
            const step2 = document.getElementById('step-2');
            step2.style.opacity = "1";
            step2.style.pointerEvents = "auto";
            document.getElementById('btn-gen').disabled = false;
            document.getElementById('btn-gen').style.opacity = "1";

        } catch (e) {
            console.error(e);
            status.innerText = "‚ùå Error: " + e.message + ". Verifica que la URL sea 'Raw'.";
            status.style.color = "#ef4444";
        }
    }

    // 2. VALIDACIONES UI
    function validateYoutube() {
        const url = document.getElementById('yt-url').value;
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        if (match && match[7].length == 11) {
            document.getElementById('yt-url').style.borderColor = "#10b981";
        }
    }

    function updateStatus(input, boxId, statusId) {
        if(input.files && input.files[0]) {
            document.getElementById(boxId).classList.add('loaded');
            document.getElementById(statusId).innerText = "‚úì " + input.files[0].name;
        }
    }

    // 3. FUSIONAR Y GENERAR
    async function generateMergedJSON() {
        if(!IS_LOADED && CURRENT_LIBRARY.length === 0) {
            if(!confirm("¬øNo cargaste una biblioteca existente? Se crear√° una nueva lista desde cero.")) return;
        }

        const url = document.getElementById('yt-url').value;
        const title = document.getElementById('vid-title').value;
        const fileEn = document.getElementById('file-en').files[0];
        const fileEs = document.getElementById('file-es').files[0];

        // Validar que haya datos nuevos
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        const videoId = (match && match[7].length == 11) ? match[7] : null;

        if(!videoId) return alert("URL de YouTube inv√°lida");
        if(!title) return alert("Escribe un t√≠tulo");
        if(!fileEn || !fileEs) return alert("Faltan los archivos SRT");

        try {
            const textEn = await readFile(fileEn);
            const textEs = await readFile(fileEs);

            // Crear objeto del NUEVO video
            const newVideo = {
                id: videoId,
                title: title,
                srtEn: textEn,
                srtEs: textEs
            };

            // === LA MAGIA: FUSIONAR ===
            // Usamos unshift para poner el nuevo video AL PRINCIPIO de la lista
            CURRENT_LIBRARY.unshift(newVideo);

            // Convertir todo a string
            const jsonString = JSON.stringify(CURRENT_LIBRARY, null, 4);

            const output = document.getElementById('output');
            output.value = jsonString;
            output.style.display = 'block';
            
            const btnCopy = document.getElementById('btn-copy');
            btnCopy.style.display = 'block';
            
            // Scroll al resultado
            output.scrollIntoView({behavior: "smooth"});
            
            alert(`¬°Listo! El video ha sido agregado a la lista. Ahora tienes ${CURRENT_LIBRARY.length} videos en total.`);

        } catch (e) {
            alert("Error procesando archivos: " + e);
        }
    }

    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    }

    function copyToClipboard() {
        const output = document.getElementById('output');
        output.select();
        document.execCommand('copy');
        const btn = document.getElementById('btn-copy');
        btn.innerText = "¬°COPIADO! ‚úÖ VE A GITHUB Y PEGA ESTO";
        setTimeout(() => btn.innerText = "COPIAR JSON COMPLETO üìã", 3000);
    }
</script>

</body>
</html>
