<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polyglot Tutor V31 - Pro UI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Dancing+Script:wght=700&family=Playfair+Display:wght=600&family=Courier+Prime:wght=700&display=swap" rel="stylesheet">
<style>
        :root {
            --primary: #007AFF;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --bg-body: #FFFFFF;
            --text-main: #111111;
            --toolbar-bg: rgba(255, 255, 255, 0.95);
            --dropdown-bg: rgba(255, 255, 255, 0.98);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ====== APP LAYOUT ====== */
        .main-container {
            width: 100%;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            border: none;
            overflow: hidden;
        }

        .sticky-top-wrapper {
            flex-shrink: 0;
            z-index: 100;
            background: var(--toolbar-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e5ea;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        .editor-header {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            max-width: 1000px; 
            margin: 0 auto;
            width: 100%;
        }
        .editor-title { font-weight: 800; font-size: 1.1rem; color: #111; display:flex; gap:10px; align-items:center; letter-spacing: -0.3px;}
        .save-indicator { font-size: 0.75rem; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: color 0.3s; }
        .save-indicator.saved { color: var(--success); }

        .editor-toolbar { 
            width: 100%; padding: 10px 20px; 
            display: flex; align-items: center; gap: 15px; overflow-x: auto; scrollbar-width: none;
            max-width: 1000px; margin: 0 auto;
        }
        
        .delicate-group {
            display: flex; align-items: center; gap: 8px; 
            background: #f7f7f9; border: 1px solid #e5e5ea; 
            border-radius: 20px; padding: 4px 10px;
            flex-shrink: 0;
        }
        .delicate-sep { width: 1px; height: 18px; background: #d1d1d6; margin: 0 4px; }
        .color-circle { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-circle:hover { transform: scale(1.2); }
        .color-circle.active { border-color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: scale(1.1); }
        .font-btn { background: none; border: none; font-size: 0.9rem; font-weight: 600; color: #888; cursor: pointer; padding: 2px 6px; border-radius: 6px; transition: all 0.2s; }
        .font-btn:hover { color: #000; background: #e5e5ea; }
        .font-btn.active { color: #007aff; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .style-icon { background: none; border: none; font-size: 0.85rem; font-weight: 700; color: #666; cursor: pointer; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .style-icon:hover { background: #e5e5ea; color: #000; }
        .style-icon.active { background: #000; color: #fff; }
        .toolbar-group { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        
        .btn-ai-trigger { background: linear-gradient(135deg, #e3f2fd, #90caf9); color: #007AFF; border: 1px solid #bbdefb; padding: 0 16px; height: 36px; border-radius: 10px; cursor: pointer; font-weight: 800; display:flex; align-items:center; justify-content:center; gap:6px; font-size: 0.9rem; transition: transform 0.2s; }
        .btn-ai-trigger:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,122,255,0.2); }
        .btn-clear { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e5ea; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0;}
        .btn-clear svg { width: 18px; height: 18px; fill: #888; }
        .editor-area { flex: 1; width: 100%; max-width: 900px; margin: 0 auto; padding: 40px 20px 100px 20px; border: none; font-family: 'Inter', sans-serif; font-size: 19px; line-height: 1.8; outline: none; color: #111; background: transparent; overflow-y: auto; }

        /* ====== AI HUB ====== */
        .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 3000; display: none; flex-direction: column; }
        .ai-popup-overlay.active { display: flex; }
        .ai-popup-box { background: #fff; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; border: none; border-radius: 0; box-shadow: none; }
        .ai-header { background: rgba(255,255,255,0.98); border-bottom: 1px solid #eee; color: #111; padding: 15px 20px; font-weight: 800; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; }
        .ai-close { background: #f2f2f7; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; transition: background 0.2s; font-size: 1.5rem;}
        .ai-close:hover { background: #e5e5ea; color: #000; }
        .ai-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; flex:1; background: #fff; width: 100%; max-width: 900px; margin: 0 auto; padding-bottom: 80px; }

        /* ====== CARDS & INPUTS ====== */
        .ai-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media(max-width: 600px) { .ai-grid-2 { grid-template-columns: 1fr; } }
        .ai-card-group { background: #F9F9FB; border-radius: 16px; padding: 6px; border: 1px solid #e5e5ea; display: flex; flex-direction: column; transition: border-color 0.2s; position: relative; }
        .ai-card-group:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .ai-card-label { font-size: 0.75rem; font-weight: 800; color: #888; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px 4px 12px; display: flex; align-items: center; gap: 6px; }

        /* ====== CUSTOM DROPDOWN SYSTEM (HIGH DESIGN) ====== */
        /* Ocultamos el select original pero lo mantenemos funcional */
        .ai-select { display: none; } 

        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
        }
        
        .custom-select-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #111;
            cursor: pointer;
            background: transparent;
            transition: all 0.2s;
            border-radius: 12px;
        }

        .custom-select-trigger:hover {
            background: rgba(0,0,0,0.03);
        }

        .custom-arrow {
            font-size: 0.8rem;
            color: #999;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            margin-left: 10px;
        }

        .custom-select-wrapper.open .custom-arrow {
            transform: rotate(180deg);
            color: var(--primary);
        }

        .custom-options {
            position: absolute;
            top: 110%; /* Un poco separado del trigger */
            left: 0;
            right: 0;
            background: var(--dropdown-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border-radius: 16px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(-10px) scale(0.98);
            transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
        }

        .custom-select-wrapper.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0) scale(1);
        }

        .custom-option {
            padding: 10px 12px;
            font-size: 0.9rem;
            color: #333;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .custom-option:hover {
            background: var(--primary);
            color: white;
        }
        
        .custom-option.selected {
            background: #f2f2f7;
            color: #000;
            font-weight: 700;
        }
        .custom-option.selected:after {
            content: '‚úì';
            color: var(--primary);
            font-weight: 800;
        }
        .custom-option:hover.selected {
            background: var(--primary);
            color: white;
        }
        .custom-option:hover.selected:after {
            color: white;
        }

        .custom-group-header {
            padding: 12px 12px 6px 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #999;
            font-weight: 800;
            letter-spacing: 0.5px;
            pointer-events: none;
            margin-top: 4px;
            border-top: 1px solid #f2f2f7;
        }
        .custom-group-header:first-child { border-top: none; margin-top: 0; }

        /* Scrollbar del dropdown */
        .custom-options::-webkit-scrollbar { width: 5px; }
        .custom-options::-webkit-scrollbar-track { background: transparent; }
        .custom-options::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
        
        /* OVERRIDE WARNING COLOR */
        .custom-select-trigger.override-warning { color: var(--danger); }
        .custom-select-trigger.override-warning:after { content: '‚ö†Ô∏è'; font-size: 0.8rem; margin-left: auto; margin-right: 5px;}

        /* ====== INPUTS CUSTOM ====== */
        .ai-custom-input { width: 100%; padding: 12px; border: none; border-top: 1px solid #e5e5ea; background: #fff; font-size: 0.9rem; color: #333; outline: none; border-radius: 0 0 16px 16px; transition: background 0.2s; }
        .ai-custom-input:focus { background: #fff; color: #000; }
        
        /* ====== OTHER CONTROLS ====== */
        .segmented-control { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; gap: 2px; }
        .level-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; background: transparent; color: #666; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .level-btn:hover { color: #000; }
        .level-btn.selected { background: #fff; color: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .flag-group { display: flex; gap: 12px; flex-wrap: wrap;}
        .flag-btn { border: 2px solid transparent; border-radius: 50%; background: #f2f2f7; font-size: 1.5rem; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; filter: grayscale(100%); transition: all 0.2s; }
        .flag-btn:hover { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
        .flag-btn.selected { border-color: var(--primary); background: #fff; opacity: 1; filter: grayscale(0%); box-shadow: 0 4px 10px rgba(0,122,255,0.2); }
        .flag-btn.hidden { display: none !important; }
        .flag-sm { width: 40px; height: 40px; font-size: 1.2rem; }

        textarea.ai-custom-input { resize: vertical; min-height: 80px; border-radius: 12px; border: 1px solid #e5e5ea; background: #F9F9FB; margin-top: 0; }
        textarea.ai-custom-input:focus { background: #fff; border-color: var(--primary); }
        
        .ai-footer-actions { margin: 15px 0; padding: 0; background: transparent; border-top: none; display: flex; gap: 15px; z-index: 5; width: 100%; }
        .btn-ai-action { flex: 1; padding: 16px; border: none; border-radius: 14px; font-weight: 800; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); text-transform: uppercase; letter-spacing: 0.5px; border: 2px solid #fff; }
        .btn-ai-primary { background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%); color: #445; box-shadow: 0 8px 20px rgba(142, 197, 252, 0.25); }
        .btn-ai-primary:hover { transform: translateY(-2px); background: linear-gradient(135deg, #d3b0f5 0%, #7eb8f2 100%); box-shadow: 0 12px 25px rgba(142, 197, 252, 0.4); color: #223; }
        #btn-paste-json { background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%); color: #445; box-shadow: 0 8px 20px rgba(250, 208, 196, 0.25); }
        #btn-paste-json:hover { transform: translateY(-2px); background: linear-gradient(135deg, #f5c0b0 0%, #f5c0f5 100%); box-shadow: 0 12px 25px rgba(250, 208, 196, 0.4); color: #223; }

        .ai-preview-box { margin-bottom: 20px; border: 2px solid var(--success); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1); }
        .ai-preview-box.highlight { animation: highlightPulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) 3; }
        @keyframes highlightPulse { 0%, 100% { border-color: var(--success); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1); } 50% { border-color: var(--warning); box-shadow: 0 0 20px rgba(255, 149, 0, 0.5); } }

        .saved-exercises-list { max-height: 300px; overflow-y: auto; border: 1px solid #e5e5ea; border-radius: 12px; margin-bottom: 10px; }
        .saved-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .saved-item:nth-child(odd) { background: #fff; }
        .saved-item:nth-child(even) { background: #f4f4f7; }
        .saved-item:last-child { border-bottom: none; }
        .saved-info { flex: 1; }
        .saved-name { font-weight: 600; font-size: 0.9rem; color: #111; }
        .saved-date { font-size: 0.7rem; color: #888; }
        .badge-new { background: var(--success); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
        .badge-tpl { background: var(--warning); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
        .mem-actions { display: flex; gap: 6px; }
        .btn-icon-action { width: 30px; height: 30px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); color: #555; transition: all 0.2s;}
        .btn-icon-action:hover { background: #000; color: #fff; }
        .btn-insert { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
        .btn-delete-item:hover { background: #d00 !important; color: #fff !important; }
        .mem-controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn-mem-ctrl { flex: 1; padding: 10px; border: 1px solid #e5e5ea; background: #fff; border-radius: 10px; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .btn-mem-ctrl:hover { background: #f9f9f9; }

        /* ====== EXERCISE RENDER ====== */
        .exercise-box { background: #f9f9fb; border: 1px solid #e5e5ea; border-radius: 12px; padding: 25px; margin: 30px 0; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .exercise-header { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 16px; border-bottom: 1px solid #f2f2f7; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .exercise-header span { flex: 1; word-wrap: break-word; overflow-wrap: break-word; }
        .btn-theory { background: #e3f2fd; color: var(--primary); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
        .btn-del-block { background: #fff5f5; color: var(--danger); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 5px; }
        .btn-reset-block { background: #fff8e1; color: #d97706; border: none; padding: 6px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: 700; white-space: nowrap; margin-left: 5px; }
        .theory-box { display: none; background: #fff; padding: 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; border: 1px solid #e5e5ea;}
        .exercise-row { margin-bottom: 16px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; line-height: 1.8; position: relative; } 
        .hint-box, .trans-box { display: none; width: 100%; margin-top: 8px; padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; }
        .hint-box { background: #fffbe6; border-left: 4px solid #f59e0b; color: #78350f; }
        .trans-box { background: #f0f9ff; border-left: 4px solid #007AFF; color: #0c4a6e; }
        .trans-line { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .btn-mini-speak { background: #fff; border: 1px solid #d1d1d6; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ex-select { padding: 8px 14px; border: 1px solid #d1d1d6; border-radius: 8px; background: white; cursor: pointer; outline: none; font-size: 0.95rem; appearance: none; padding-right: 2.5rem; max-width: 100%; white-space: normal; }
        .ex-select.correct { border-color: var(--success) !important; background-color: #e8f5e9 !important; color: #1b5e20 !important; font-weight: 700; }
        .ex-select.wrong { border-color: var(--danger) !important; background-color: #ffebee !important; color: #b71c1c !important; animation: shake 0.3s; }
        .ex-btn-icon { background: #f2f2f7; border: none; border-radius: 8px; cursor: pointer; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; color: #1d1d1f; }
        .ex-btn-icon:hover { background: #e5e5ea; color: var(--primary); }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .exercise-row s { color: var(--danger); text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color: var(--danger); background-color: rgba(255, 59, 48, 0.1); padding: 2px 6px; border-radius: 6px; margin-right: 8px; font-weight: 600; display: inline-block; }
        .exercise-row s::before { content: "‚úñ"; font-size: 0.7em; margin-right: 4px; vertical-align: text-top; opacity: 0.6; }
        .cloze-gap-container { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 4px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="sticky-top-wrapper">
            <div class="editor-header">
                <div class="editor-title">
                    <span>üìò Polyglot Editor</span>
                </div>
                <div>
                     <span class="save-indicator" id="save-status">‚úì Ready</span>
                </div>
            </div>

            <div class="editor-toolbar">
                <div class="delicate-group">
                    <div class="color-circle" style="background:#111; border-color:#ddd;" onmousedown="event.preventDefault(); applyColor('#1d1d1f')" title="Black"></div>
                    <div class="color-circle" style="background:#FF3B30" onmousedown="event.preventDefault(); applyColor('#FF3B30')" title="Red"></div>
                    <div class="color-circle" style="background:#007AFF" onmousedown="event.preventDefault(); applyColor('#007AFF')" title="Blue"></div>
                    <div class="color-circle" style="background:#34C759" onmousedown="event.preventDefault(); applyColor('#34C759')" title="Green"></div>
                    <div class="delicate-sep"></div>
                    <button class="font-btn" style="font-family:'Inter'" onclick="setFont('Inter')" title="Sans Serif">Aa</button>
                    <button class="font-btn" style="font-family:'Playfair Display'" onclick="setFont('Playfair Display')" title="Serif">Aa</button>
                    <button class="font-btn" style="font-family:'Courier Prime'" onclick="setFont('Courier Prime')" title="Mono">Aa</button>
                    <div class="delicate-sep"></div>
                    <button class="style-icon" id="btn-bold" onmousedown="event.preventDefault(); toggleBold()" title="Bold">B</button>
                    <button class="style-icon" id="btn-size-norm" onmousedown="event.preventDefault(); setSize(3)" title="Normal">T</button>
                    <button class="style-icon" id="btn-size-lg" onmousedown="event.preventDefault(); setSize(5)" title="Large" style="font-size:1.1rem">T+</button>
                </div>

                <div class="toolbar-group">
                    <button class="btn-ai-trigger" onclick="openAIMenu()" title="AI Exercise Hub">
                        <span>‚ö° AI Hub</span>
                    </button>
                </div>
                
                <button class="btn-clear" onclick="if(confirm('Clear all content?')) { document.getElementById('editor-text').innerHTML=''; saveNote(); }" title="Clear All">
                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </div>
        </div>

        <div id="editor-text" class="editor-area" contenteditable="true" placeholder="Start typing..." oninput="saveNote()"></div>
    </div>

    <div class="ai-popup-overlay" id="ai-hub-modal">
        <div class="ai-popup-box">
            <div class="ai-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span>‚ö° Polyglot AI Hub</span>
                </div>
                <button class="ai-close" onclick="closeAIMenu()">√ó</button>
            </div>
            
            <div class="ai-body">
                
                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üåç Context</div>
                        <select id="ai-context-select" class="ai-select">
                            <option value="" selected disabled>Select Context...</option>
                            <optgroup label="üè† Daily Life & Lifestyle">
                                <option value="Daily Routine & Habits">Daily Routine & Habits</option>
                                <option value="Family & Relationships">Family & Relationships</option>
                                <option value="House & Chores">House, Furniture & Chores</option>
                                <option value="Food, Cooking & Restaurants">Food, Cooking & Restaurants</option>
                                <option value="Health, Fitness & Body">Health, Fitness & Doctors</option>
                                <option value="Hobbies, Music & Movies">Hobbies, Music & Movies</option>
                            </optgroup>
                            <optgroup label="‚úàÔ∏è Travel & Adventure">
                                <option value="At the Airport & Flying">At the Airport & Flying</option>
                                <option value="Hotel Check-in & Problems">Hotel Situations</option>
                                <option value="Asking for Directions & City">City & Directions</option>
                                <option value="Car Rental & Driving">Car Rental & Driving</option>
                            </optgroup>
                            <optgroup label="üíº Work & Business">
                                <option value="Job Interviews & CVs">Job Interviews & HR</option>
                                <option value="Business Meetings & Strategy">Meetings & Negotiations</option>
                                <option value="Emails & Formal Communication">Formal Emails</option>
                                <option value="Tech, IT & Programming">Tech, IT & Programming</option>
                                <option value="Marketing & Sales">Marketing & Sales</option>
                                <option value="Customer Service Scenarios">Customer Service Issues</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-context-custom" class="ai-custom-input" placeholder="Or type custom context..." oninput="checkCustomOverride('ai-context-custom', 'ai-context-select')">
                    </div>

                    <div class="ai-card-group">
                        <div class="ai-card-label">üß† Grammar</div>
                        <select id="ai-grammar-select" class="ai-select">
                            <option value="" selected disabled>Select Grammar...</option>
                            <optgroup label="üïí Present Tenses">
                                <option value="Present Simple">Present Simple (Habits & Facts)</option>
                                <option value="Present Continuous">Present Continuous (Now & Future)</option>
                                <option value="Present Perfect">Present Perfect (Experiences)</option>
                                <option value="Present Perfect Continuous">Present Perfect Continuous</option>
                                <option value="Present Simple vs Continuous">Mix: Simple vs Continuous</option>
                            </optgroup>
                            <optgroup label="üîô Past Tenses">
                                <option value="Past Simple">Past Simple (Finished Actions)</option>
                                <option value="Past Continuous">Past Continuous (Interrupted Actions)</option>
                                <option value="Past Perfect">Past Perfect (The Past before the Past)</option>
                                <option value="Past Perfect Continuous">Past Perfect Continuous</option>
                                <option value="Narrative Tenses Mix">Mix: Narrative Tenses (Storytelling)</option>
                            </optgroup>
                            <optgroup label="üöÄ Future Tenses">
                                <option value="Future Simple (Will)">Future Simple (Will - Spontaneous)</option>
                                <option value="Be Going To">Be Going To (Plans)</option>
                                <option value="Future Continuous">Future Continuous (In progress later)</option>
                                <option value="Future Perfect">Future Perfect (Completed by then)</option>
                                <option value="Future Forms Mix">Mix: Will / Going to / Present Cont.</option>
                            </optgroup>
                            <optgroup label="‚öôÔ∏è Advanced Structures">
                                <option value="Conditionals 0 & 1">Conditionals 0 & 1 (Real)</option>
                                <option value="Conditionals 2 & 3">Conditionals 2 & 3 (Unreal)</option>
                                <option value="Mixed Conditionals">Mixed Conditionals</option>
                                <option value="Passive Voice">Passive Voice</option>
                                <option value="Reported Speech">Reported Speech (Indirect)</option>
                                <option value="Relative Clauses">Relative Clauses (Who, Which, That)</option>
                                <option value="Causative (Have/Get something done)">Causative Form</option>
                            </optgroup>
                            <optgroup label="üß© Particles & Modals">
                                <option value="Modal Verbs (Can, Could, Should, Must)">Modal Verbs</option>
                                <option value="Modals of Deduction (Must have, Can't have)">Modals of Past Deduction</option>
                                <option value="Phrasal Verbs">Phrasal Verbs (General)</option>
                                <option value="Prepositions of Place & Time">Prepositions (In, On, At, By)</option>
                                <option value="Articles (A, An, The, Zero)">Articles (A / An / The)</option>
                                <option value="Gerunds vs Infinitives">Gerunds vs Infinitives</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-grammar-custom" class="ai-custom-input" placeholder="Or type custom grammar..." oninput="checkCustomOverride('ai-grammar-custom', 'ai-grammar-select')">
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üìù Format</div>
                        <select id="ai-type-select" class="ai-select">
                            <option value="" selected disabled>Select Format...</option>
                            <optgroup label="‚úçÔ∏è Standard Practice">
                                <option value="Fill in the Blanks (Cloze)">Fill in the Blanks (Classic)</option>
                                <option value="Multiple Choice Quiz">Multiple Choice Quiz</option>
                                <option value="Find and Fix the Mistake">Find and Fix the Mistake</option>
                                <option value="True or False (Reading)">True or False (Reading Comp.)</option>
                            </optgroup>
                            <optgroup label="üß† Vocabulary & Logic">
                                <option value="Vocabulary Matching">Vocabulary Matching (Def - Word)</option>
                                <option value="Synonym & Antonym Finder">Synonym Finder</option>
                                <option value="Sentence Reordering">Sentence Reordering (Scrambled)</option>
                                <option value="Choose the Odd One Out">Odd One Out (Logic)</option>
                            </optgroup>
                            <optgroup label="üîÑ Translation">
                                <option value="Reverse Translation (ES->EN)">Reverse Translation (See ES, Pick EN)</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-type-custom" class="ai-custom-input" placeholder="Or type custom format..." oninput="checkCustomOverride('ai-type-custom', 'ai-type-select')">
                    </div>

                    <div class="ai-card-group" style="justify-content: space-between;">
                        <div style="flex: 1;">
                            <div class="ai-card-label">‚öôÔ∏è Settings</div> 
                            <div style="display: flex; align-items: center; gap: 0; padding-right: 12px;"> 
                                <select id="ai-gap-count" class="ai-select" style="flex: 1; min-width: 0;" title="Gaps">
                                    <option value="1" selected>1 Gap</option>
                                    <option value="2">2 Gaps</option>
                                    <option value="3">3 Gaps</option>
                                    <option value="random">Mix</option>
                                </select>
                                <select id="ai-option-count" class="ai-select" style="flex: 1; min-width: 0; border-left: 1px solid #e5e5ea; padding-left:10px;" title="Options">
                                    <option value="2">2 Opts</option>
                                    <option value="3">3 Opts</option>
                                    <option value="4" selected>4 Opts</option>
                                    <option value="5">5 Opts</option>
                                </select>
                                <select id="ai-sentence-count" class="ai-select" style="flex: 1; min-width: 0; border-left: 1px solid #e5e5ea; padding-left:10px;" title="Quantity">
                                    <option value="3">3 Qs</option>
                                    <option value="6" selected>6 Qs</option>
                                    <option value="9">9 Qs</option>
                                    <option value="12">12 Qs</option>
                                </select>
                            </div>
                        </div>
                        <div style="padding: 0 10px 10px 10px;">
                            <div class="segmented-control" id="level-group">
                                <button class="level-btn" onclick="selectLevel(this, 'A1-A2 (Beginner)')">A1-A2</button>
                                <button class="level-btn selected" onclick="selectLevel(this, 'B1-B2 (Intermediate)')">B1-B2</button>
                                <button class="level-btn" onclick="selectLevel(this, 'C1-C2 (Advanced)')">C1-C2</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div>
                        <div class="ai-card-label">üéØ Target</div>
                        <div class="flag-group" id="target-lang-group">
                            <div class="flag-btn selected" onclick="selectTarget(this, 'en')" title="English">üá∫üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'es')" title="Spanish">üá™üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'pt')" title="Portuguese">üáßüá∑</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'it')" title="Italian">üáÆüáπ</div>
                        </div>
                    </div>
                    <div>
                        <div class="ai-card-label">üåê Translate</div>
                        <div class="flag-group" id="trans-lang-group">
                            <div class="flag-btn flag-sm" data-lang="en" onclick="toggleTrans(this, 'en')">üá∫üá∏</div>
                            <div class="flag-btn flag-sm selected" data-lang="es" onclick="toggleTrans(this, 'es')">üá™üá∏</div>
                            <div class="flag-btn flag-sm" data-lang="pt" onclick="toggleTrans(this, 'pt')">üáßüá∑</div>
                            <div class="flag-btn flag-sm" data-lang="it" onclick="toggleTrans(this, 'it')">üáÆüáπ</div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="ai-card-label">‚ö° Extra Instructions</div>
                    <textarea id="ai-extra-data" class="ai-custom-input" placeholder="E.g. Use British slang, make it funny..."></textarea>
                </div>

                <div class="ai-footer-actions">
                    <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">
                        <span>‚ú®</span> Create Mission
                    </button>
                    <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">
                        <span>‚ú®</span> Paste Mission
                    </button>
                </div>

                <div id="ai-latest-preview"></div>

                <div style="margin-top: 20px;">
                    <div class="ai-card-label" style="font-size: 0.9rem;">üéì Memory Bank</div>
                    <div class="saved-exercises-list" id="ai-memory-list">
                        <div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>
                    </div>
                    <div class="mem-controls">
                        <button class="btn-mem-ctrl" onclick="exportMemoryBank()">‚¨áÔ∏è Export</button>
                        <input type="file" id="importMemFile" accept=".json" style="display:none" onchange="importMemoryBank(this)">
                        <button class="btn-mem-ctrl" onclick="document.getElementById('importMemFile').click()">‚¨ÜÔ∏è Import</button>
                        <button class="btn-mem-ctrl" style="color:var(--danger)" onclick="clearAIMemory()">üóëÔ∏è Clear</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    /* ====== CONFIG & STATE ====== */
    const AI_MEM_KEY = 'mdc_ai_exercises';
    const EDITOR_KEY = 'mdc_simple_editor';
    
    let currentTargetLang = 'en'; 
    let currentLevel = 'B1-B2 (Intermediate)';
    const transLangs = new Set(['es']); 
    const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian' };
    
    const editorArea = document.getElementById('editor-text');
    const aiModal = document.getElementById('ai-hub-modal');

    /* ====== INITIALIZATION ====== */
    document.addEventListener('DOMContentLoaded', () => {
        loadEditorContent();
        renderAiList(); 
        updateTransFlagsVisibility();
        initCustomDropdowns(); // INICIALIZA LOS MEN√öS PERSONALIZADOS
    });

    /* ====== CUSTOM DROPDOWN LOGIC (NUEVO) ====== */
    function initCustomDropdowns() {
        const selects = document.querySelectorAll('.ai-select');
        selects.forEach(select => {
            // 1. Create wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-select-wrapper';
            select.parentNode.insertBefore(wrapper, select);
            wrapper.appendChild(select); // Move select inside wrapper

            // 2. Create trigger
            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';
            // Set initial text
            const selectedOpt = select.options[select.selectedIndex];
            trigger.innerHTML = `<span>${selectedOpt.text}</span><span class="custom-arrow">‚ñº</span>`;
            wrapper.appendChild(trigger);

            // 3. Create options container
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'custom-options';
            wrapper.appendChild(optionsContainer);

            // 4. Populate options
            Array.from(select.children).forEach(child => {
                if(child.tagName === 'OPTGROUP') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'custom-group-header';
                    groupHeader.innerText = child.label;
                    optionsContainer.appendChild(groupHeader);
                    
                    Array.from(child.children).forEach(opt => {
                        createCustomOption(opt, optionsContainer, trigger, select, wrapper);
                    });
                } else if (child.tagName === 'OPTION') {
                    createCustomOption(child, optionsContainer, trigger, select, wrapper);
                }
            });

            // 5. Trigger Click Event
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close all others
                document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                    if(w !== wrapper) w.classList.remove('open');
                });
                wrapper.classList.toggle('open');
            });
        });

        // Close on click outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
        });
    }

    function createCustomOption(optElement, container, trigger, select, wrapper) {
        if(optElement.disabled) return; // Skip placeholders

        const div = document.createElement('div');
        div.className = 'custom-option';
        if(optElement.selected) div.classList.add('selected');
        div.innerText = optElement.text;
        
        div.addEventListener('click', (e) => {
            e.stopPropagation();
            // Update Select
            select.value = optElement.value;
            // Update Trigger Text
            trigger.querySelector('span').innerText = optElement.text;
            // Update UI Selected classes
            container.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
            div.classList.add('selected');
            // Close
            wrapper.classList.remove('open');
            // Trigger Change Event (if logic needs it)
            const event = new Event('change');
            select.dispatchEvent(event);
        });

        container.appendChild(div);
    }

    // Function to check manual override inputs (updated for custom dropdowns)
    function checkCustomOverride(inputId, selectId) { 
        const inputVal = document.getElementById(inputId).value.trim(); 
        const selectEl = document.getElementById(selectId);
        const wrapper = selectEl.closest('.custom-select-wrapper');
        const trigger = wrapper.querySelector('.custom-select-trigger');

        if(inputVal.length > 0) { 
            trigger.classList.add('override-warning'); 
        } else { 
            trigger.classList.remove('override-warning'); 
        } 
    }

    /* ====== EDITOR LOGIC ====== */
    function loadEditorContent() {
        const saved = localStorage.getItem(EDITOR_KEY);
        if(saved) editorArea.innerHTML = saved;
    }

    window.saveNote = function() {
        const selects = editorArea.querySelectorAll('select'); 
        selects.forEach(s => { 
            const val = s.value; 
            const opts = s.querySelectorAll('option'); 
            opts.forEach(o => { 
                if (o.value === val) o.setAttribute('selected', 'true'); else o.removeAttribute('selected'); 
            }); 
        });
        localStorage.setItem(EDITOR_KEY, editorArea.innerHTML);
        
        const ind = document.getElementById('save-status');
        ind.innerText = "‚úì Saved";
        ind.classList.add('saved');
        setTimeout(() => { ind.innerText = "‚úì Ready"; ind.classList.remove('saved'); }, 1500);
    }

    function applyColor(hex) { document.execCommand('foreColor', false, hex); updateToolbarState(); }
    function toggleBold() { document.execCommand('bold'); updateToolbarState(); }
    function setSize(size) { document.execCommand('fontSize', false, size); updateToolbarState(); }
    function setFont(fontName) { document.execCommand('fontName', false, fontName); updateToolbarState(); }

    editorArea.addEventListener('keyup', updateToolbarState); 
    editorArea.addEventListener('mouseup', updateToolbarState); 
    editorArea.addEventListener('click', updateToolbarState); 
    editorArea.addEventListener('input', window.saveNote);
    
    function updateToolbarState() { 
        const isBold = document.queryCommandState('bold'); 
        document.getElementById('btn-bold').classList.toggle('active', isBold); 
        
        const size = document.queryCommandValue('fontSize'); 
        document.getElementById('btn-size-lg').classList.toggle('active', size === '5' || size === 'x-large'); 
        document.getElementById('btn-size-norm').classList.toggle('active', size !== '5' && size !== 'x-large'); 
        
        const rgb = document.queryCommandValue('foreColor'); 
        document.querySelectorAll('.color-circle').forEach(b => b.classList.remove('active')); 
        if(rgb) {
            if(rgb.includes('255, 59, 48')) document.querySelectorAll('.color-circle')[1].classList.add('active'); 
            else if (rgb.includes('0, 122, 255')) document.querySelectorAll('.color-circle')[2].classList.add('active'); 
            else if (rgb.includes('52, 199, 89')) document.querySelectorAll('.color-circle')[3].classList.add('active'); 
            else document.querySelectorAll('.color-circle')[0].classList.add('active'); 
        }

        const font = document.queryCommandValue('fontName');
        document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
        if(font) {
            if(font.includes('Inter')) document.querySelectorAll('.font-btn')[0].classList.add('active');
            else if(font.includes('Playfair')) document.querySelectorAll('.font-btn')[1].classList.add('active');
            else if(font.includes('Courier')) document.querySelectorAll('.font-btn')[2].classList.add('active');
        }
    }

    /* ====== AI HUB LOGIC ====== */
    function openAIMenu() { aiModal.classList.add('active'); renderAiList(); }
    function closeAIMenu() { aiModal.classList.remove('active'); }
    function selectTarget(el, lang) { document.querySelectorAll('#target-lang-group .flag-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentTargetLang = lang; updateTransFlagsVisibility(); }
    function selectLevel(el, levelDesc) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentLevel = levelDesc; }
    function updateTransFlagsVisibility() { document.querySelectorAll('#trans-lang-group .flag-btn').forEach(btn => { const btnLang = btn.getAttribute('data-lang'); if (btnLang === currentTargetLang) { btn.classList.add('hidden'); btn.classList.remove('selected'); transLangs.delete(btnLang); } else { btn.classList.remove('hidden'); } }); }
    function toggleTrans(el, lang) { if (transLangs.has(lang)) { transLangs.delete(lang); el.classList.remove('selected'); } else { if (transLangs.size >= 3) return alert("Max 3 translation languages."); transLangs.add(lang); el.classList.add('selected'); } }
    function escapeHtml(text) { if (!text) return ""; return text.replace(/'/g, "\\'").replace(/"/g, "&quot;"); }

    function exportMemoryBank() { const data = localStorage.getItem(AI_MEM_KEY); if(!data || data === '[]') return alert("Memory is empty."); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'polyglot_memory_full.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function importMemoryBank(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if(!Array.isArray(importedData)) throw new Error("Invalid format"); const current = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const combined = [...importedData, ...current]; localStorage.setItem(AI_MEM_KEY, JSON.stringify(combined)); renderAiList(); alert("Import Successful!"); } catch(err) { alert("Error importing: " + err.message); } }; reader.readAsText(file); }
    function renameMemoryItem(id) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const idx = memory.findIndex(i => i.id === id); if(idx > -1) { const newTitle = prompt("New Title:", memory[idx].title); if(newTitle) { memory[idx].title = newTitle; localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } } }
    function exportSingleItem(id) { const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const item = memory.find(x => x.id === id); if(!item) return; const data = JSON.stringify([item], null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const safeName = (item.title || 'exercise').replace(/[^a-z0-9]/gi, '_').toLowerCase(); a.download = `${safeName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function deleteMemoryItem(id) { if(confirm("Delete?")) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory = memory.filter(item => item.id !== id); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } }
    function clearAIMemory() { if(confirm("Clear all?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }
    
    function renderAiList() { 
        const listContainer = document.getElementById('ai-memory-list'); 
        const previewContainer = document.getElementById('ai-latest-preview');
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); 
        
        previewContainer.innerHTML = '';
        listContainer.innerHTML = '';

        if (memory.length === 0) { 
            listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>'; 
            return; 
        } 

        const createItemHtml = (item, index, isPreview = false) => {
            let flag = "üá¨üáß"; if(item.lang === 'es') flag = "üá™üá∏"; if(item.lang === 'pt') flag = "üáßüá∑"; if(item.lang === 'it') flag = "üáÆüáπ"; 
            let newBadge = (index === 0 && !isPreview) ? '<span class="badge-new">NEW</span>' : ''; 
            let typeBadge = item.isHtml ? '<span class="badge-tpl">TEMPLATE</span>' : `‚Ä¢ ${item.data.length} Qs`; 
            let boxClass = isPreview ? 'saved-item ai-preview-box' : 'saved-item';
            let titlePrefix = isPreview ? 'üÜï LATEST CREATED: ' : '';

            return `<div class="${boxClass}" style="${isPreview ? 'background:#f0fff4; border-bottom:none;' : ''}">
                <div class="saved-info">
                    <span class="saved-name">${flag} ${titlePrefix}${item.title} ${newBadge}</span>
                    <span class="saved-date">${item.date} ${typeBadge}</span>
                </div>
                <div class="mem-actions">
                    <button class="btn-insert" onclick="insertExerciseFromMem(${item.id})">Insert</button>
                    <button class="btn-icon-action btn-export-item" onclick="exportSingleItem(${item.id})" title="Export JSON">‚¨áÔ∏è</button>
                    <button class="btn-icon-action btn-rename" onclick="renameMemoryItem(${item.id})" title="Rename">‚úèÔ∏è</button>
                    <button class="btn-icon-action btn-delete-item" onclick="deleteMemoryItem(${item.id})" title="Delete">√ó</button>
                </div>
            </div>`; 
        };

        if(memory.length > 0) { previewContainer.innerHTML = createItemHtml(memory[0], 0, true); }
        let listHtml = '';
        memory.forEach((item, index) => { listHtml += createItemHtml(item, index, false); }); 
        listContainer.innerHTML = listHtml; 
    }
    
    function copyProfessorPrompt() {
        const ctxSel = document.getElementById('ai-context-select').value;
        const graSel = document.getElementById('ai-grammar-select').value;
        const typSel = document.getElementById('ai-type-select').value;
        const gapCount = document.getElementById('ai-gap-count').value;
        const optionCount = document.getElementById('ai-option-count').value; 
        const ctxCust = document.getElementById('ai-context-custom').value.trim();
        const graCust = document.getElementById('ai-grammar-custom').value.trim();
        const typCust = document.getElementById('ai-type-custom').value.trim();
        const extraData = document.getElementById('ai-extra-data').value.trim();
        const quantity = document.getElementById('ai-sentence-count').value || 5;

        let requirements = [];
        let isGrammarFocus = false;
        let typeStr = typCust ? typCust : typSel;

        if(ctxCust) requirements.push(`Topic Context: ${ctxCust}`); else if(ctxSel) requirements.push(`Topic Context: ${ctxSel}`);
        if(graCust) { requirements.push(`Grammar Focus: ${graCust}`); isGrammarFocus = true; } else if(graSel) { requirements.push(`Grammar Focus: ${graSel}`); isGrammarFocus = true; }
        if(typeStr) requirements.push(`Exercise Format: ${typeStr}`);

        if(requirements.length === 0) return alert("‚ö†Ô∏è Please select at least one option.");

        const finalTopic = requirements.join(", ");
        const target = LANG_NAMES[currentTargetLang];
        
        let languageInstruction = `CRITICAL LANGUAGE RULE: The sentences AND the options inside the gaps {opt1|opt2...} MUST BE in **${target.toUpperCase()}**. Do NOT use English words inside the gaps.`;
        let strictInstruction = "QUALITY CONTROL: Sentences must be culturally authentic and idiomatic (not robotic). Distractors inside gaps {opt1|opt2...} must be GRAMMATICALLY PLAUSIBLE (same part of speech, same conjugation) but incorrect contextually. Make it challenging.";
        let gapInstruction = "";

        if (typeStr && typeStr.includes("Find and Fix")) {
            strictInstruction += `TYPE: FIND AND FIX THE MISTAKE.\nVISUAL REQUIREMENT: You MUST include the mistake crossed out using HTML tags <s>mistake</s> immediately before the correct gap.`;
        } else if (typeStr && typeStr.includes("Vocabulary Matching")) {
            strictInstruction += `TYPE: VOCABULARY MATCHING.\nFormat: "Definition text (${target})... {CorrectWord|Distractor1|Distractor2}"`;
        } else if (typeStr && typeStr.includes("True or False")) {
            strictInstruction += `TYPE: READING COMPREHENSION (TRUE/FALSE).\nFormat: "Statement about the text... {True|False}"`;
            gapInstruction = "Provide options {True|False}.";
        }

        const optInst = `Provide exactly ${optionCount} options`; 

        if (!gapInstruction && gapCount === 'random') {
             gapInstruction = `GAP REQUIREMENT: ${optInst} in ${target}. Mix of 1, 2, or 3 gaps per sentence.`; 
        } else if (!gapInstruction) {
             gapInstruction = `GAP REQUIREMENT: ${optInst} in ${target}. Provide exactly ${gapCount} gap(s) per sentence.`; 
        }

        if (isGrammarFocus && (!typeStr || !typeStr.includes("Reordering"))) {
            strictInstruction += ` Focus gaps ONLY on the requested GRAMMAR rule.`;
        }
        
        const jsonExample = `
    {
      "cloze_text": "Natural sentence in ${target} using idiomatic vocabulary with {correct|distractor1|distractor2} gaps.",
      "hint": "A subtle linguistic clue. DO NOT give the answer.",
      "translations": { ${Array.from(transLangs).map(l => `"${l}": "Translation"`).join(', ')} },
      "full_sentence": "Full sentence without gaps."
    }`;
        
       const promptText = `ACT AS: Senior ${target} Linguist.
LEVEL: CEFR ${currentLevel}.
TASK: Create a structured JSON exercise with exactly ${quantity} sentences.

REQUIREMENTS: 
${finalTopic}

RULES:
1. ${languageInstruction}
2. GAP DENSITY: ${gapInstruction}
3. ${strictInstruction}
4. ONLY OUTPUT THE RAW JSON. DO NOT SPEAK, ASK QUESTIONS, OR ADD ANY CONVERSATIONAL TEXT BEFORE OR AFTER THE JSON.
${extraData ? `5. EXTRA INSTRUCTIONS: ${extraData}` : ''}

OUTPUT FORMAT: PURE JSON STRING FOR CANVAS. PROVIDE ONLY THE RAW JSON STRING. DO NOT USE MARKDOWN CODE BLOCKS (\`\`\`json). START DIRECTLY WITH THE CHARACTER "{" AND END WITH "}".
JSON STRUCTURE:
{
  "title": "Short descriptive title in ${target}",
  "lang_code": "${currentTargetLang}",
  "theory": "Comprehensive educational guide using HTML tags (<b>, <ul>, <li>, <br>). Explain rules, usage contexts, exceptions, and provide examples.",
  "exercises": [ ${jsonExample} ] 
}`.trim();
        
        navigator.clipboard.writeText(promptText).then(() => {
            const btn = document.querySelector('.btn-ai-primary'); const orig = btn.innerText;
            btn.innerText = "‚úÖ Copied!"; setTimeout(() => btn.innerText = orig, 2000);
        }).catch(err => alert("Error copying: " + err));
    }
    
    async function pasteAIJson() {
        let jsonString = "";
        try { jsonString = await navigator.clipboard.readText(); } catch (err) { jsonString = prompt("Paste JSON here:"); }
        if (!jsonString) return;
        const btn = document.getElementById('btn-paste-json'); const originalContent = btn.innerHTML; 
        btn.innerHTML = "<span>‚úÖ</span> Pasted!"; setTimeout(() => { btn.innerHTML = originalContent; }, 2000);
        processJsonAndSave(jsonString);
    }
    
    function processJsonAndSave(jsonString) {
        try {
            let cleanString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const aiData = JSON.parse(cleanString);
            let finalData = Array.isArray(aiData) ? { title: "Exercise", lang_code: "en", theory: "Review rules.", exercises: aiData } : aiData;
            if (!finalData.lang_code) finalData.lang_code = "en";
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            memory.unshift({ id: Date.now(), title: finalData.title || "Untitled", lang: finalData.lang_code, theory: finalData.theory, date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), data: finalData.exercises });
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
            renderAiList();
            setTimeout(() => {
                const previewBox = document.querySelector('#ai-latest-preview .ai-preview-box');
                if (previewBox) { previewBox.classList.add('highlight'); setTimeout(() => { previewBox.classList.remove('highlight'); }, 4600); }
            }, 50);
        } catch (e) { alert("‚ùå Invalid JSON.\nError: " + e.message); }
    }
    
    function insertExerciseFromMem(id) {
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        const item = memory.find(x => x.id === id); if (!item) return;
        
        const insertTime = Date.now(); const theoryId = `theory-${id}-${insertTime}`; const targetLang = item.lang || 'en';
        let htmlBlock = `<div class="exercise-box" contenteditable="false"><div class="exercise-header"><span>‚úçÔ∏è ${item.title}</span><div style="display:flex; align-items:center;"><button class="btn-theory" onclick="document.getElementById('${theoryId}').style.display = document.getElementById('${theoryId}').style.display === 'block' ? 'none' : 'block'">üìò Theory</button><button class="btn-reset-block" contenteditable="false" onclick="window.resetExerciseBlock(this)" title="Reset">‚Ü∫</button><button class="btn-del-block" contenteditable="false" onclick="if(confirm('Delete block?')) { this.closest('.exercise-box').remove(); window.saveNote(); }" title="Delete">üóëÔ∏è</button></div></div><div class="theory-box" id="${theoryId}">${item.theory || "No theory."}</div>`;
        item.data.forEach((ex, index) => {
            const uId = `ex-${id}-${index}-${insertTime}`; const hId = `hint-${id}-${index}-${insertTime}`; const tId = `trans-${id}-${index}-${insertTime}`;
            let exerciseContent = "";
            if (ex.cloze_text) {
                let parsedHtml = ex.cloze_text.replace(/\{([^}]+)\}/g, (match, content) => {
                    const parts = content.split('|'); const correctAns = parts[0].trim(); const shuffled = [...parts].sort(() => Math.random() - 0.5);
                    let optsHtml = `<option value="" disabled selected>...</option>`;
                    shuffled.forEach(opt => { optsHtml += `<option value="${escapeHtml(opt.trim())}">${opt.trim()}</option>`; });
                    return `<span class="cloze-gap-container"><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(correctAns)}')">${optsHtml}</select></span>`;
                });
                exerciseContent = `<span><b>${index + 1}.</b> ${parsedHtml}</span>`;
            } else {
                let optsHtml = `<option value="" disabled selected>...</option>`; const shuffled = [...ex.options].sort(() => Math.random() - 0.5);
                shuffled.forEach(opt => { optsHtml += `<option value="${escapeHtml(opt)}">${opt}</option>`; });
                exerciseContent = `<span><b>${index + 1}.</b> ${ex.pre || ''}</span><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(ex.answer)}')">${optsHtml}</select><span>${ex.post || ''}</span>`;
            }
            let transContent = "";
            if (ex.translations) {
                for (const [key, val] of Object.entries(ex.translations)) {
                    let f = "üá¨üáß"; if (key === 'es') f = "üá™üá∏"; if (key === 'pt') f = "üáßüá∑"; if (key === 'it') f = "üáÆüáπ";
                    transContent += `<div class="trans-line"><button class="btn-mini-speak" contenteditable="false" onclick="window.speakText('${escapeHtml(val)}', '${key}')">üîä</button><span>${f} ${val}</span></div>`;
                }
            } else { transContent = "No translation"; }
            htmlBlock += `<div class="exercise-row" id="${uId}">${exerciseContent}<div style="display:inline-flex; gap:5px; margin-left:10px;"><button class="ex-btn-icon" contenteditable="false" onclick="window.speakText('${escapeHtml(ex.full_sentence)}', '${targetLang}')">üîä</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${tId}').style.display = document.getElementById('${tId}').style.display === 'block' ? 'none' : 'block'">üåê</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${hId}').style.display = document.getElementById('${hId}').style.display === 'block' ? 'none' : 'block'">‚ùì</button></div><div class="hint-box" id="${hId}">üí° ${ex.hint}</div><div class="trans-box" id="${tId}">${transContent}</div></div>`;
        });
        htmlBlock += '</div><p><br></p>';
        editorArea.insertAdjacentHTML('beforeend', htmlBlock);
        setTimeout(() => { editorArea.scrollTop = editorArea.scrollHeight; window.saveNote(); }, 50);
        closeAIMenu();
    }
    
    window.validateExercise = function(s, a) {
        s.classList.remove('correct', 'wrong');
        if (s.value.trim().toLowerCase() === a.trim().toLowerCase()) { s.classList.add('correct'); } else { s.classList.add('wrong'); if (navigator.vibrate) navigator.vibrate(200); }
        window.saveNote();
    };
    
    window.speakText = function(text, langCode) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text);
            const m = { 'en': 'en-US', 'es': 'es-ES', 'pt': 'pt-BR', 'it': 'it-IT' };
            u.lang = m[langCode] || 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u);
        } else { alert("TTS not supported."); }
    };
    window.resetExerciseBlock = function(btn) { const box = btn.closest('.exercise-box'); if(box) { const selects = box.querySelectorAll('select'); selects.forEach(s => { s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); s.selectedIndex = 0; }); window.saveNote(); } };
</script>
</body>
</html>
