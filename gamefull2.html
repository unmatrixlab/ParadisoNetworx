<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LINGUA NEXUS | HYBRID V2 (BAN SYSTEM)</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== VARIABLES & RESET ==================== */
        :root {
            --bg-deep: #050505; --bg-card: #121214; --bg-hover: #1f1f22; --bg-input: #18181b;
            --txt-main: #f4f4f5; --txt-sec: #71717a; --border: #27272a;
            --c-noun: #0ea5e9; --c-adj: #d946ef; --c-reg: #22c55e; --c-irreg:#f59e0b; --c-func: #6366f1; 
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; --purple: #a855f7;
            --font-head: 'Bebas Neue', sans-serif; --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        :root.light-mode {
            --bg-deep: #f8fafc; --bg-card: #ffffff; --bg-hover: #f1f5f9; --bg-input: #e2e8f0;
            --txt-main: #0f172a; --txt-sec: #64748b; --border: #e2e8f0;
            --c-noun: #0284c7; --c-adj: #c026d3; --c-reg: #16a34a; --c-irreg:#d97706; --c-func: #4f46e5; --c-mixed: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { background-color: var(--bg-deep); color: var(--txt-main); font-family: var(--font-ui); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }

        /* HEADER */
        header { height: 64px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; background: rgba(5,5,5,0.95); border-bottom: 1px solid var(--border); z-index: 50; backdrop-filter: blur(10px); }
        .brand-area { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .brand { font-family: var(--font-head); font-size: 26px; letter-spacing: 2px; color: var(--txt-main); text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .back-btn { display: none; color: var(--txt-sec); }
        body:not(.is-home) .back-btn { display: block; }
        body:not(.is-home) .brand { display: none; } 
        .header-actions { display: flex; gap: 20px; }
        .icon-btn { background: none; border: none; color: var(--txt-sec); cursor: pointer; padding: 0; transition: 0.2s; }
        .icon-btn.active { color: var(--primary); filter: drop-shadow(0 0 5px var(--primary)); transform: scale(1.1); }

        /* MAIN LAYOUT */
        main { flex: 1; position: relative; width: 100%; overflow: hidden; }
        .view-screen { display: none; flex-direction: column; width: 100%; height: 100%; padding: 20px; padding-bottom: calc(40px + var(--safe-bottom)); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .view-screen.active { display: flex; }
        #view-game { overflow: hidden; padding-bottom: calc(20px + var(--safe-bottom)); }

        /* HOME UI */
        .welcome-text { margin-bottom: 30px; text-align: center; margin-top: 10px; }
        .welcome-text h1 { font-family: var(--font-head); font-size: 52px; margin: 0; line-height: 0.9; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .stat-pill { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
        .stat-val { font-family: var(--font-code); font-weight: 700; font-size: 24px; display: block; }
        .stat-lbl { font-size: 10px; font-weight: 600; color: var(--txt-sec); text-transform: uppercase; margin-top: 4px; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%; padding-bottom: 20px; }
        .menu-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .menu-card:active { transform: scale(0.96); }
        .card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 15px; background: rgba(255,255,255,0.05); }
        .menu-card h3 { margin: 0; font-family: var(--font-head); font-size: 28px; line-height: 1; letter-spacing: 1px; }
        .menu-card span { font-size: 12px; color: var(--txt-sec); font-weight: 500; margin-top: 6px; display: block; }

        .menu-card[data-type="noun"] { border-color: rgba(14, 165, 233, 0.3); color: var(--c-noun); } 
        .menu-card[data-type="adj"] { border-color: rgba(217, 70, 239, 0.3); color: var(--c-adj); }
        .menu-card[data-type="reg"] { border-color: rgba(34, 197, 94, 0.3); color: var(--c-reg); }
        .menu-card[data-type="irreg"] { border-color: rgba(245, 158, 11, 0.3); color: var(--c-irreg); }
        .menu-card[data-type="func"] { border-color: rgba(99, 102, 241, 0.3); color: var(--c-func); }
        .menu-card[data-type="mixed"] { border-color: var(--border); color: #fff; }
        .menu-card[data-type="folder"] { border-color: rgba(251, 191, 36, 0.3); color: var(--gold); }
        .menu-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; border-style: dashed; }

        /* FOLDER & LISTS */
        .folder-grid { display: grid; gap: 10px; }
        .folder-item { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .folder-item:active { transform: scale(0.98); background: var(--bg-hover); }
        .folder-info h4 { margin: 0; font-size: 18px; color: var(--txt-main); text-transform: uppercase; }
        .folder-info span { font-size: 12px; color: var(--txt-sec); font-weight: 600; }
        .folder-play { width: 40px; height: 40px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); }
        
        .folder-item.sys-all { border-color: var(--purple); background: linear-gradient(90deg, rgba(168, 85, 247, 0.05), transparent); } .folder-item.sys-all .folder-play { color: var(--purple); }
        .folder-item.sys-off { border-color: var(--c-noun); } .folder-item.sys-off .folder-play { color: var(--c-noun); }
        .folder-item.sys-imp { border-color: var(--gold); } .folder-item.sys-imp .folder-play { color: var(--gold); }

        /* SETTINGS & QUEUE */
        .section-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; flex-shrink: 0; }
        .section-head { font-family: var(--font-head); font-size: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; letter-spacing: 1px; }
        .row-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .num-inp { background: var(--bg-input); border: 1px solid var(--border); color: var(--txt-main); border-radius: 8px; padding: 8px; width: 70px; text-align: center; font-family: var(--font-code); }
        .lib-search { width: 100%; background: var(--bg-card); border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: var(--txt-main); font-size: 16px; margin-bottom: 15px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; flex-shrink: 0; }
        .filter-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; flex: 1; min-width: 50px; text-align: center; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 0 10px rgba(59,130,246,0.3); }
        
        .lib-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
        .lib-content { padding: 15px; }
        .lib-en { font-weight: 700; font-size: 16px; color: var(--txt-main); text-transform: uppercase; } 
        .lib-es { font-size: 13px; color: var(--txt-sec); margin-top: 2px; text-transform: uppercase; } 
        .prog-track { width: 100%; height: 4px; background: var(--bg-input); }
        .prog-fill { height: 100%; width: 0%; }
        .lvl-1 .prog-fill { background: var(--danger); } .lvl-2 .prog-fill { background: var(--c-irreg); }
        .lvl-3 .prog-fill { background: var(--primary); } .lvl-4 .prog-fill { background: var(--success); }
        .lib-badge { position: absolute; right: 15px; top: 15px; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: var(--bg-input); color: var(--txt-sec); }
        .load-more-btn { width: 100%; padding: 15px; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-main); border-radius: 12px; margin-top: 10px; cursor: pointer; font-weight: 700; font-size: 12px; letter-spacing: 1px; flex-shrink: 0; }
        
        .queue-grid { display: grid; gap: 8px; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-deep); border: 1px solid var(--border); padding: 10px 14px; border-radius: 8px; font-size: 14px; }
        .queue-tag { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; letter-spacing: 0.5px; }
        .tag-0 { background: var(--c-noun); color: #fff; } .tag-1 { background: var(--danger); color: #fff; } 
        .tag-2 { background: var(--c-irreg); color: #000; } .tag-3 { background: var(--primary); color: #fff; } 
        .tag-4 { background: var(--success); color: #fff; } 

        .scope-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: var(--bg-input); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); }
        .scope-label { font-size: 11px; font-weight: 700; color: var(--txt-sec); text-transform: uppercase; }
        .scope-reset { font-size: 10px; font-weight: 800; color: var(--primary); background: none; border: none; cursor: pointer; text-transform: uppercase; }

        /* ==================== GAME CONTAINERS ==================== */
        .game-top-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; z-index: 60; position: relative; flex-shrink: 0; }
        .stage-pill { display: inline-flex; padding: 6px 14px; border-radius: 100px; font-size: 11px; font-weight: 700; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); text-transform: uppercase; letter-spacing: 1px; }
        .timer-badge { font-family: var(--font-code); font-size: 12px; color: var(--primary); background: rgba(59, 130, 246, 0.1); padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); margin-left: 10px; font-weight: bold; }
        .audio-toggle-btn { background: var(--bg-card); border: 1px solid var(--border); width: 48px; height: 48px; border-radius: 12px; color: var(--txt-sec); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-left: auto; margin-right: 15px; }
        .audio-toggle-btn.active { background: var(--bg-input); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .mini-chart { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .chart-hole { width: 38px; height: 38px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; }
        #chart-pct { font-size: 10px; font-weight: 800; font-family: var(--font-code); color: var(--txt-main); }

        /* ARCADE SPECIFIC */
        #mode-arcade { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; height: 100%; }
        #game-canvas-container { flex: 1; position: relative; width: 100%; background: #050505; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; box-shadow: inset 0 0 30px rgba(0,0,0,0.8); }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* NEW ARCADE GRID WITH CENTER HOLE */
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 150px; flex-shrink: 0; padding: 5px; position: relative; }
        .ans-btn { position: relative; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-bottom-color: rgba(255, 255, 255, 0.02); border-right-color: rgba(255, 255, 255, 0.02); color: var(--txt-main); padding: 12px; border-radius: 24px; font-size: 16px; font-weight: 700; letter-spacing: 0.5px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; justify-content: center; box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.15), inset 0 -2px 5px rgba(0, 0, 0, 0.2), 0 8px 20px rgba(0, 0, 0, 0.2), 0 0 0 1px transparent; backdrop-filter: blur(12px); text-shadow: 0 2px 4px rgba(0,0,0,0.3); overflow: hidden; text-transform: uppercase; }
        .ans-btn::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to bottom right, rgba(255,255,255,0.1) 0%, transparent 40%, transparent 100%); transform: rotate(30deg); pointer-events: none; transition: 0.5s; opacity: 0.6; }
        .ans-btn:hover::after { opacity: 1; transform: rotate(30deg) translate(10%, 10%); }
        .ans-btn:active { transform: translateY(4px) scale(0.97); box-shadow: inset 0 3px 6px rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.3); border-color: rgba(255, 255, 255, 0.05); }
        .ans-btn.correct-flash { background: linear-gradient(135deg, var(--success), #047857) !important; color: #fff !important; border: 1px solid #34d399 !important; box-shadow: 0 0 35px var(--success), inset 0 0 20px rgba(255,255,255,0.4) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5); z-index: 10; transform: translateY(0) scale(1.02); }
        .ans-btn.error-flash { background: linear-gradient(135deg, var(--danger), #991b1b) !important; color: #fff !important; border: 1px solid #f87171 !important; box-shadow: 0 0 35px var(--danger), inset 0 0 20px rgba(255,255,255,0.4) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
        
        /* BAN BUTTON ARCADE */
        .ban-btn-arcade { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; border-radius: 50%; background: var(--bg-deep); border: 2px solid var(--danger); z-index: 50; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); transition: 0.2s; font-size: 20px; }
        .ban-btn-arcade:active { transform: translate(-50%, -50%) scale(0.9); }

        /* TEXT MODE SPECIFIC */
        #mode-text { flex: 1; display: none; flex-direction: column; width: 100%; height: 100%; overflow-y: auto; padding-top: 20px; }
        .word-stage { margin: 10px 0 30px 0; text-align: center; position: relative; }
        .main-word { font-size: clamp(36px, 10vw, 64px); font-weight: 800; line-height: 1; color: var(--txt-main); margin: 0; transition: color 0.3s; text-transform: uppercase; }
        .main-word.audio-active { color: var(--primary); cursor: pointer; }
        
        .ban-btn-text { position: absolute; right: 0; top: 0; background: var(--bg-input); border: 1px solid var(--danger); color: var(--danger); font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; cursor: pointer; text-transform: uppercase; }
        .ban-btn-text:active { transform: scale(0.9); background: var(--danger); color: #fff; }

        /* INPUTS & CONTROLS */
        .input-list { display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px; }
        .input-group { position: relative; }
        .input-tag { position: absolute; top: 14px; left: 16px; font-size: 10px; font-weight: 700; color: var(--txt-sec); opacity: 0.7; pointer-events: none; text-transform: uppercase; }
        .smart-input { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px 16px 14px 16px; font-family: var(--font-code); font-size: 18px; color: var(--txt-main); text-transform: uppercase; }
        .smart-input:focus { border-color: var(--primary); background: var(--bg-hover); }
        .input-group.correct .smart-input { border-color: var(--success); color: var(--success); }
        .input-group.error .smart-input { border-color: var(--danger); color: var(--danger); }
        .action-btn { width: 100%; padding: 20px; border-radius: 16px; border: none; background: var(--bg-input); color: var(--txt-sec); font-family: var(--font-head); font-size: 24px; cursor: not-allowed; transition: 0.3s; margin-top: auto; }
        .action-btn.active { background: var(--primary); color: #fff; cursor: pointer; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); }
        .hint-btn { background: none; border: none; color: var(--primary); font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer; margin-top: 15px; display: inline-block; opacity: 0.8; }
        .hint-text { display: none; margin-top: 15px; font-size: 14px; color: var(--txt-sec); font-style: italic; line-height: 1.5; background: var(--bg-input); padding: 15px; border-radius: 12px; }
        
        /* SPACE RAY CSS EFFECT FOR TEXT MODE */
        .space-ray {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;
            background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
            opacity: 0; mix-blend-mode: screen;
        }
        @keyframes fireRay { 
            0% { opacity: 0; transform: scaleX(0); }
            10% { opacity: 1; transform: scaleX(1); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: scaleX(2); }
        }
        .ray-active { animation: fireRay 0.6s ease-out forwards; }
    </style>
</head>
<body class="is-home">

    <script src="https://paradisonetworx.com/database.js"></script>

    <div id="text-space-ray" class="space-ray"></div>

    <header>
        <div class="brand-area" onclick="App.stopAll(); App.nav('home')">
            <svg class="back-btn" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path></svg>
            <div class="brand">LINGUA NEXUS</div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="Profile.toggleTheme()">
                <svg id="theme-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button id="btn-settings-nav" class="icon-btn" onclick="App.stopAll(); App.nav('settings')">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <main>
        <div id="view-home" class="view-screen active">
            <div class="welcome-text"><h1>TRAINING HUB</h1></div>
            <div class="stats-row">
                <div class="stat-pill"><span class="stat-val" style="color:var(--success)" id="stat-m">0</span><span class="stat-lbl">Mastered</span></div>
                <div class="stat-pill"><span class="stat-val" style="color:var(--c-noun)" id="stat-t">0</span><span class="stat-lbl">Total Seen</span></div>
            </div>
            <div class="grid-menu">
                <div class="menu-card" data-type="noun" onclick="App.start('nouns')"><div class="card-icon">N</div><div><h3>NOUNS</h3><span>Objects & Things</span></div></div>
                <div class="menu-card" data-type="adj" onclick="App.start('adjectives')"><div class="card-icon">A</div><div><h3>ADJECTIVES</h3><span>Descriptions</span></div></div>
                <div class="menu-card" data-type="reg" onclick="App.start('verbs_reg')"><div class="card-icon">R</div><div><h3>REGULAR</h3><span>Standard Verbs</span></div></div>
                <div class="menu-card" data-type="irreg" onclick="App.start('verbs_irreg')"><div class="card-icon">I</div><div><h3>IRREGULAR</h3><span>Complex Forms</span></div></div>
                <div class="menu-card" data-type="func" onclick="App.start('functionals')"><div class="card-icon">L</div><div><h3>LOGIC & SYNTAX</h3><span>Connectors & Structure</span></div></div>
                <div class="menu-card" data-type="folder" onclick="App.nav('folders')"><div class="card-icon" style="color:var(--gold)">F</div><div><h3>MY FOLDERS</h3><span>Custom Collections</span></div></div>
            </div>
        </div>

        <div id="view-folders" class="view-screen">
            <div class="section-box" style="border-color: var(--gold);">
                <div class="section-head" style="color: var(--gold);">SELECT A FOLDER</div>
                <div id="folder-list-container" class="folder-grid"></div>
            </div>
        </div>

        <div id="view-settings" class="view-screen">
            <div class="section-box" style="border-color: var(--c-noun);">
                <div class="section-head" style="color: var(--c-noun);">INTERACTION MODE</div>
                <div class="row-ctrl">
                    <span class="row-lbl">Play Style</span>
                    <select id="cfg-interaction" class="num-inp" style="width:220px; text-align:left;" onchange="Profile.saveCfg()">
                        <option value="arcade">ARCADE (Game & Physics)</option>
                        <option value="text">TEXT (Typing & Input)</option>
                    </select>
                </div>
            </div>

            <div class="section-box" style="border-color: var(--c-func);">
                <div class="section-head" style="color: var(--c-func);">ARCADE SETTINGS</div>
                <div class="row-ctrl">
                    <span class="row-lbl">Game Engine</span>
                    <select id="cfg-mode" class="num-inp" style="width:220px; text-align:left;" onchange="Profile.saveCfg()">
                        <option value="meteor">NEON FALL (Classic)</option>
                        <option value="bubble">ZERO GRAVITY (Float)</option>
                        <option value="orbit">ORBITAL DEFENSE (360Â°)</option>
                        <option value="flower">FLOWER POWER (Falling)</option>
                        <option value="heart">HEART FLOAT (Rising)</option>
                        <option value="butterfly">BUTTERFLY RING (360Â°)</option>
                    </select>
                </div>
                <div class="row-ctrl"><span class="row-lbl">Game Speed</span><select id="cfg-speed" class="num-inp" onchange="Profile.saveCfg()"><option value="1">Slow</option><option value="2">Normal</option><option value="3">Fast</option></select></div>
            </div>
            
            <div class="section-box">
                <div class="section-head">SESSION</div>
                <div class="row-ctrl"><span class="row-lbl">Words per Session</span><input type="number" id="cfg-count" class="num-inp" value="10" onchange="Profile.saveCfg()"></div>
                <div class="row-ctrl"><span class="row-lbl">Time Limit (Min)</span><input type="number" id="cfg-time" class="num-inp" value="0" onchange="Profile.saveCfg()"></div>
            </div>
            <div class="section-box"><div class="section-head">DANGER ZONE</div><div class="row-ctrl"><span class="row-lbl" style="color:var(--danger)">Reset All Progress</span><button onclick="Profile.wipe()" style="background:var(--danger); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:bold;">WIPE</button></div></div>
            
            <div class="section-box" style="border-color: var(--primary);"><div class="section-head" style="color:var(--primary)">UP NEXT IN QUEUE</div><div id="study-queue-list" class="queue-grid"></div></div>
            
            <div class="scope-bar">
                <span id="lib-scope-label" class="scope-label">SCOPE: FULL DATABASE</span>
                <button id="btn-scope-reset" class="scope-reset" onclick="App.clearScope()">RESET TO ALL</button>
            </div>

            <input type="text" id="inp-search" class="lib-search" placeholder="Search Database..." onkeyup="App.resetRender()">
            <div class="filter-bar"><button class="filter-btn active" onclick="App.setLibFilter('all', this)">ALL</button><button class="filter-btn" onclick="App.setLibFilter(0, this)">LVL 0</button><button class="filter-btn" onclick="App.setLibFilter(1, this)">LVL 1</button><button class="filter-btn" onclick="App.setLibFilter(2, this)">LVL 2</button><button class="filter-btn" onclick="App.setLibFilter(3, this)">LVL 3</button><button class="filter-btn" onclick="App.setLibFilter(4, this)">LVL 4</button></div>
            <div id="lib-list" style="padding-bottom:20px;"></div><button id="btn-load-more" class="load-more-btn" onclick="App.renderMore()">LOAD MORE...</button>
        </div>

        <div id="view-game" class="view-screen">
            <div class="game-top-bar">
                <div class="stage-pill" id="game-cat-pill">CATEGORY</div>
                <div class="timer-badge" id="game-timer" style="display:none">00:00</div>
                <button id="btn-audio-mode" class="audio-toggle-btn active" onclick="App.toggleAudioMode()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
                </button>
                <div class="mini-chart" id="game-chart"><div class="chart-hole"><span id="chart-pct">0%</span></div></div>
            </div>
            
            <div id="mode-arcade">
                <div id="game-canvas-container"><canvas id="game-canvas"></canvas></div>
                <div class="answers-grid" id="control-dock"></div>
            </div>

            <div id="mode-text">
                <div class="word-stage">
                    <h2 class="main-word" id="text-word" onclick="TextGame.replayAudio()">...</h2>
                    <button class="ban-btn-text" onclick="TextGame.banActive()">ðŸ’€ BAN</button>
                </div>
                <div class="input-list" id="text-inputs"></div>
                <button id="btn-text-action" class="action-btn" onclick="TextGame.checkOrNext()">CHECK ANSWER</button>
                <div style="text-align:center; margin-top:10px;">
                    <button id="btn-hint" class="hint-btn" onclick="TextGame.getHint()">ðŸ’¡ SHOW DEFINITION HINT</button>
                    <div id="hint-text" class="hint-text"></div>
                </div>
            </div>
        </div>
    </main>

<script>
const DB = {
    data: {}, customData: [],
    async init() {
        try { this.customData = JSON.parse(localStorage.getItem('mdc_vocab_list') || '[]'); } catch(e) { this.customData = []; }
        return new Promise(r => {
            const t = setInterval(() => { if (typeof INTERNAL_VOCAB !== 'undefined') { this.data = INTERNAL_VOCAB; clearInterval(t); r(); } }, 50);
        });
    },
    getFolderWords(folderId) {
        if (folderId === 'sys_official') { let all=[]; Object.keys(this.data).forEach(k=>all=all.concat(this.data[k].map(x=>({...x,cat:'official'})))); return all; }
        if (folderId === 'sys_custom') { let all=[]; const ext=(l)=>{l.forEach(i=>{if(i.isFolder&&i.items)ext(i.items);else if(i.eng)all.push({en:i.eng,es:i.esp,cat:'custom'});});}; ext(this.customData); return all; }
        if (folderId === 'sys_everything') { return this.getFolderWords('sys_official').concat(this.getFolderWords('sys_custom')); }
        let words=[]; const find=(l)=>{for(let i of l){if(i.isFolder){if(i.id===folderId)return i.items||[];const f=find(i.items||[]);if(f)return f;}}return null;};
        const raw=find(this.customData); if(!raw)return[];
        const ext=(l)=>{l.forEach(i=>{if(i.isFolder&&i.items)ext(i.items);else if(i.eng)words.push({en:i.eng,es:i.esp,cat:'custom'});});};
        ext(raw); return words;
    },
    getFolderList() {
        let f=[]; const ext=(l)=>{l.forEach(i=>{if(i.isFolder){let c=0;const count=(s)=>s.forEach(x=>{if(x.isFolder&&x.items)count(x.items);else if(x.eng)c++;});if(i.items)count(i.items);f.push({id:i.id,name:i.name,count:c});if(i.items)ext(i.items);}});};
        ext(this.customData); return f;
    },
    get(cat) {
        const k={nouns:'NOUNS',adjectives:'ADJECTIVES',verbs_reg:'REGULAR_VERBS',verbs_irreg:'IRREGULAR_VERBS',functionals:'FUNCTION WORDS'};
        if(cat==='mixed'){let a=[];Object.keys(k).forEach(ky=>{a=a.concat((this.data[k[ky]]||[]).map(x=>({...x,cat:ky})));});return a;}
        return (this.data[k[cat]]||[]).map(x=>({...x,cat}));
    },
    all(){ let a=[]; Object.keys(this.data).forEach(k=>a=a.concat(this.data[k])); return a; }
};

const Profile = {
    cfg: { count: 10, time: 0, theme: 'dark', prog: {}, speed: 2, gameMode: 'meteor', interaction: 'arcade', banned: [] },
    load() {
        const s = localStorage.getItem('LN_V8_HYBRID'); if (s) this.cfg = { ...this.cfg, ...JSON.parse(s) };
        if(!this.cfg.banned) this.cfg.banned = [];
        this.applyDecay(); this.applyTheme();
        if(document.getElementById('cfg-count')) document.getElementById('cfg-count').value = this.cfg.count;
        if(document.getElementById('cfg-speed')) document.getElementById('cfg-speed').value = this.cfg.speed || 2;
        if(document.getElementById('cfg-time')) document.getElementById('cfg-time').value = this.cfg.time || 0;
        if(document.getElementById('cfg-mode')) document.getElementById('cfg-mode').value = this.cfg.gameMode || 'meteor';
        if(document.getElementById('cfg-interaction')) document.getElementById('cfg-interaction').value = this.cfg.interaction || 'arcade';
        this.calcStats();
    },
    saveCfg() {
        this.cfg.count = parseInt(document.getElementById('cfg-count').value)||10;
        this.cfg.speed = parseInt(document.getElementById('cfg-speed').value)||2;
        this.cfg.time = parseInt(document.getElementById('cfg-time').value)||0;
        this.cfg.gameMode = document.getElementById('cfg-mode').value;
        this.cfg.interaction = document.getElementById('cfg-interaction').value;
        this.save(); App.renderQueue();
    },
    save() { localStorage.setItem('LN_V8_HYBRID', JSON.stringify(this.cfg)); },
    ban(w) { if(!this.cfg.banned.includes(w)) this.cfg.banned.push(w); this.save(); },
    isBanned(w) { return (this.cfg.banned || []).includes(w); },
    applyTheme() {
        const d=document.documentElement, i=document.getElementById('theme-icon');
        if(this.cfg.theme==='light'){d.classList.add('light-mode');if(i)i.innerHTML='<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>';}
        else{d.classList.remove('light-mode');if(i)i.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';}
    },
    toggleTheme() { this.cfg.theme = this.cfg.theme==='dark'?'light':'dark'; this.applyTheme(); this.save(); },
    getData(w) { let v=this.cfg.prog[w]; if(v===undefined)return{lvl:0,date:0}; if(typeof v==='number')return{lvl:v,date:0}; return v; },
    setProg(w, ok) {
        let e=this.getData(w), l=e.lvl; if(ok){if(l<4)l++;}else{l=Math.max(0,l-1);}
        this.cfg.prog[w]={lvl:l,date:Date.now()}; this.save(); this.calcStats(); return l;
    },
    getLvl(w) { return this.getData(w).lvl; },
    getDate(w) { return this.getData(w).date; },
    wipe() { if(confirm("Clear progress & banned words?")) { this.cfg.prog={}; this.cfg.banned=[]; this.save(); App.nav('home'); } },
    calcStats() {
        const k=Object.keys(this.cfg.prog), m=k.filter(x=>this.getData(x).lvl===4).length;
        if(document.getElementById('stat-m')) document.getElementById('stat-m').innerText=m;
        if(document.getElementById('stat-t')) document.getElementById('stat-t').innerText=k.length;
    },
    applyDecay() {
        const NOW=Date.now(), DECAY=30*24*60*60*1000; let ch=false;
        Object.keys(this.cfg.prog).forEach(w=>{let e=this.cfg.prog[w];if(typeof e==='object'&&e.lvl===4&&NOW-e.date>DECAY){e.lvl=3;e.date=NOW;ch=true;}});
        if(ch)this.save();
    }
};

const App = {
    audioMode: true, activeScope: null, scopeName: null,
    async boot() { await DB.init(); Profile.load(); this.nav('home'); },
    nav(v) {
        document.querySelectorAll('.view-screen').forEach(e => e.classList.remove('active'));
        document.getElementById('view-' + v).classList.add('active');
        document.body.className = (v === 'home') ? 'is-home' : '';
        const btn = document.getElementById('btn-settings-nav');
        if (v === 'settings') {
            btn.classList.add('active'); this.setLibFilter('all', document.querySelector('.filter-bar .filter-btn'));
            this.renderQueue(); this.updateScopeUI();
        } else { btn.classList.remove('active'); }
        if (v === 'folders') this.renderFolderList();
    },
    stopAll() { Game.stop(); TextGame.stop(); },
    toggleAudioMode() { 
        this.audioMode = !this.audioMode; 
        const btn = document.getElementById('btn-audio-mode');
        if(this.audioMode){btn.classList.add('active'); btn.style.opacity='1';} else{btn.classList.remove('active'); btn.style.opacity='0.5';}
        if(Profile.cfg.interaction === 'text' && document.getElementById('view-game').classList.contains('active')) { TextGame.syncAudioState(); }
    },
    renderFolderList() {
        const c = document.getElementById('folder-list-container'); c.innerHTML = '';
        const sys = [{id:'sys_everything',name:'ULTIMATE DATABASE (ALL)',class:'sys-all',count:'FULL'},{id:'sys_official',name:'OFFICIAL DB (FULL)',class:'sys-off',count:'INT'},{id:'sys_custom',name:'IMPORTED DB (FULL)',class:'sys-imp',count:'EXT'}];
        sys.forEach(f => {
            const d=document.createElement('div'); d.className=`folder-item ${f.class}`; d.innerHTML=`<div class="folder-info"><h4>${f.name}</h4><span style="font-weight:800;opacity:0.7;">${f.count}</span></div><div class="folder-play"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>`;
            d.onclick=()=>this.startFolder(f.id, f.name); c.appendChild(d);
        });
        const folders = DB.getFolderList();
        if(folders.length > 0) {
            const sep=document.createElement('div'); sep.style.cssText="margin-top:15px; margin-bottom:5px; font-size:11px; font-weight:700; color:var(--txt-sec); text-transform:uppercase; letter-spacing:1px;"; sep.innerText="YOUR COLLECTIONS"; c.appendChild(sep);
            folders.forEach(f => {
                const d=document.createElement('div'); d.className='folder-item'; d.innerHTML=`<div class="folder-info"><h4>${f.name}</h4><span>${f.count} Words</span></div><div class="folder-play"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>`;
                d.onclick=()=>this.startFolder(f.id, f.name); c.appendChild(d);
            });
        }
    },
    startFolder(fid, fname) {
        const raw = DB.getFolderWords(fid); if(raw.length===0)return alert("Folder is empty!");
        this.prepGame(raw, 'custom', fname);
    },
    start(cat) { const raw = DB.get(cat); this.prepGame(raw, cat, cat==='mixed'?"MIXED BAG":cat.toUpperCase()); },
    prepGame(raw, catKey, title) {
        // FILTER BANNED WORDS
        raw = raw.filter(w => !Profile.isBanned(w.en));
        this.activeScope = raw; this.scopeName = title;
        const sorted = [...raw].sort((a, b) => {
            const ga = (l=Profile.getLvl(a.en)) => l>0&&l<4?1:l===0?2:3;
            const gb = (l=Profile.getLvl(b.en)) => l>0&&l<4?1:l===0?2:3;
            if (ga(Profile.getLvl(a.en))!==gb(Profile.getLvl(b.en))) return ga(Profile.getLvl(a.en))-gb(Profile.getLvl(b.en));
            return Profile.getDate(a.en)-Profile.getDate(b.en);
        });
        const queue = sorted.slice(0, Profile.cfg.count);
        if (queue.length === 0) return alert("No words available (Check banned list?).");
        
        this.nav('game');
        
        const pills = { nouns:'--c-noun', adjectives:'--c-adj', verbs_reg:'--c-reg', verbs_irreg:'--c-irreg', functionals:'--c-func', mixed:'--c-mixed', custom:'--gold' };
        const p = document.getElementById('game-cat-pill');
        const cVar = (catKey==='custom'||!pills[catKey])?'--gold':pills[catKey];
        p.innerText = title; p.style.color = `var(${cVar})`; p.style.borderColor = `var(${cVar})`;
        
        if(Profile.cfg.interaction === 'text') {
            document.getElementById('mode-arcade').style.display = 'none'; document.getElementById('mode-text').style.display = 'flex';
            TextGame.init(queue, catKey, sorted);
        } else {
            document.getElementById('mode-arcade').style.display = 'flex'; document.getElementById('mode-text').style.display = 'none';
            Game.init(queue, catKey, `var(${cVar})`, sorted);
        }
        this.updateChart(queue);
    },
    updateChart(sourceData) {
        const t = sourceData.length; const c = [0,0,0,0,0];
        if (t === 0) return;
        sourceData.forEach(w => c[Profile.getLvl(w.en)]++);
        const p4=c[4]/t*100, p3=c[3]/t*100, p2=c[2]/t*100, p1=c[1]/t*100;
        const dom = document.getElementById('game-chart');
        if (dom) {
            dom.style.background = `conic-gradient(var(--success) 0% ${p4}%, var(--primary) ${p4}% ${p4+p3}%, var(--c-irreg) ${p4+p3}% ${p4+p3+p2}%, var(--danger) ${p4+p3+p2}% ${p4+p3+p2+p1}%, var(--bg-input) ${p4+p3+p2+p1}% 100%)`;
            document.getElementById('chart-pct').innerText = Math.round(p4) + '%';
        }
    },
    setLibFilter(lvl, btn) { this.filterLvl=lvl; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); if(btn)btn.classList.add('active'); this.resetRender(); },
    clearScope() { this.activeScope = null; this.scopeName = null; this.updateScopeUI(); this.resetRender(); this.renderQueue(); },
    updateScopeUI() {
        const lbl=document.getElementById('lib-scope-label'), btn=document.getElementById('btn-scope-reset');
        if(this.activeScope){lbl.innerText=`SCOPE: ${this.scopeName}`; lbl.style.color='var(--gold)'; btn.style.display='block';}
        else{lbl.innerText='SCOPE: FULL DATABASE'; lbl.style.color='var(--txt-sec)'; btn.style.display='none';}
    },
    resetRender() { this.renderCount=50; this.calculateFilteredList(); this.renderLib(); },
    renderMore() { this.renderCount+=50; this.renderLib(); },
    calculateFilteredList() { 
        const s=document.getElementById('inp-search').value.toLowerCase(); const src=this.activeScope||DB.all();
        this.filteredResults = src.filter(x=>{ const m=!s||x.en.toLowerCase().includes(s); if(!m)return false; if(this.filterLvl==='all')return true; return Profile.getLvl(x.en)===this.filterLvl; }); 
    },
    renderLib() { 
        const c=document.getElementById('lib-list'); c.innerHTML=''; const btn=document.getElementById('btn-load-more');
        if(this.filteredResults.length>this.renderCount){btn.style.display='block';btn.innerText=`LOAD MORE (${this.filteredResults.length-this.renderCount})`;}else{btn.style.display='none';}
        const frag=document.createDocumentFragment(); this.filteredResults.slice(0,this.renderCount).forEach(w=>{const l=Profile.getLvl(w.en), pct=l*25, d=document.createElement('div');d.className=`lib-card lvl-${l}`;d.innerHTML=`<div class="lib-content"><span class="lib-badge">LVL ${l}</span><div class="lib-en">${w.en.toUpperCase()}</div><div class="lib-es">${Array.isArray(w.es)?w.es[0].toUpperCase():w.es.toUpperCase()}</div></div><div class="prog-track"><div class="prog-fill" style="width:${pct}%"></div></div>`;frag.appendChild(d);});c.appendChild(frag);
    },
    renderQueue() {
        let raw = this.activeScope ? [...this.activeScope] : DB.get('mixed');
        raw = raw.filter(w => !Profile.isBanned(w.en)); // FILTER HERE TOO
        for (let i=raw.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [raw[i],raw[j]]=[raw[j],raw[i]]; }
        const sorted = raw.sort((a,b) => {
            const la=Profile.getLvl(a.en), lb=Profile.getLvl(b.en);
            const g=(l)=>(l>0&&l<4)?1:(l===0?2:3);
            if(g(la)!==g(lb)) return g(la)-g(lb);
            return Profile.getDate(a.en)-Profile.getDate(b.en);
        });
        const nB = sorted.slice(0, Profile.cfg.count); const con = document.getElementById('study-queue-list'); if(!con)return; con.innerHTML='';
        if(nB.length===0){con.innerHTML='<div style="text-align:center;padding:20px;color:var(--txt-sec)">No words available.</div>';return;}
        con.innerHTML=`<div style="font-size:11px;color:var(--primary);margin-bottom:10px;font-weight:700;">NEXT ${nB.length} WORDS:</div>`;
        nB.forEach(w=>{const l=Profile.getLvl(w.en), tc='tag-'+l, tt=l===0?'NEW':(l===4?'MASTER':`LVL ${l}`); const d=document.createElement('div'); d.className='queue-item'; d.innerHTML=`<div><span style="font-weight:700;color:var(--txt-main)">${w.en.toUpperCase()}</span></div><div class="queue-tag ${tc}">${tt}</div>`; con.appendChild(d);});
    }
};

const Game = {
    canvas:null, ctx:null, queue:[], pool:[], fullList:[], idx:0, width:0, height:0, loopId:null, lastTime:0, activeWord:null, particles:[], stars:[], laser:null, ghosts:[], shockwaves:[], clouds:[], score:0, startTime:0, timeLimit:0, themeColor:'#fff', flashIntensity:0, combo:0, gridOffset:0, showingGhost:false, category:'', timerId:null, isPlaying:false, mode: 'meteor', speedMult: 1, 
    banningPhase: false, banBeamColor: 0,

    init(queue, cat, colorVar, fullList) {
        this.queue=queue; this.category=cat; this.fullList=fullList;
        this.pool=(cat==='custom'||cat==='mixed')?(this.fullList.length>4?this.fullList:DB.all()):DB.all();
        // Filter pool against ban list
        this.pool = this.pool.filter(w => !Profile.isBanned(w.en));

        this.idx=0; this.score=0; this.ghosts=[]; this.shockwaves=[]; this.combo=0; this.showingGhost=false; this.isPlaying=true; this.banningPhase=false;
        this.canvas=document.getElementById('game-canvas'); this.ctx=this.canvas.getContext('2d'); this.resize();
        window.addEventListener('resize', ()=>this.resize());
        this.mode=Profile.cfg.gameMode; this.speedMult=Profile.cfg.speed===1?0.6:(Profile.cfg.speed===3?1.5:1.0);
        this.startTime=Date.now(); this.timeLimit=Profile.cfg.time*60*1000;
        const tD=document.createElement('div'); tD.style.color=colorVar; document.body.appendChild(tD); this.themeColor=getComputedStyle(tD).color; document.body.removeChild(tD);
        if(['flower','heart','butterfly'].includes(this.mode)) { const p={'--c-noun':'#93c5fd','--c-adj':'#f0abfc','--c-reg':'#86efac','--c-irreg':'#fcd34d','--c-func':'#a5b4fc','--primary':'#fda4af','--gold':'#fcd34d'}; const v=colorVar.replace('var(','').replace(')',''); this.themeColor=p[v]||this.themeColor; }
        document.getElementById('game-timer').style.display = this.timeLimit>0?'block':'none';
        this.stars=[]; for(let i=0;i<80;i++)this.stars.push({x:Math.random()*this.width,y:Math.random()*this.height,size:Math.random()*2,speed:0.2+Math.random()*0.5});
        this.clouds=[]; if(['flower','heart','butterfly'].includes(this.mode)) for(let i=0;i<5;i++)this.clouds.push({x:Math.random()*this.width,y:Math.random()*this.height,size:30+Math.random()*50,speed:0.1+Math.random()*0.1});
        this.spawn(); this.lastTime=performance.now(); this.loopId=requestAnimationFrame(t=>this.loop(t));
    },
    resize() { const c=document.getElementById('game-canvas-container'); if(c){this.canvas.width=c.offsetWidth; this.canvas.height=c.offsetHeight; this.width=this.canvas.width; this.height=this.canvas.height;} },
    stop() { this.isPlaying=false; cancelAnimationFrame(this.loopId); clearTimeout(this.timerId); this.activeWord=null; },
    spawn() {
        if(!this.isPlaying||this.showingGhost||this.banningPhase)return;
        if(this.idx>=this.queue.length){ this.idx=0; if(this.timeLimit===0&&this.queue.every(w=>Profile.getLvl(w.en)===4)){ alert("SESSION COMPLETE!"); this.stop(); App.nav('home'); return; } }
        const data=this.queue[this.idx], size=60; let x,y,vx,vy;
        if(this.mode==='orbit'||this.mode==='butterfly'){ const a=Math.random()*Math.PI*2, d=Math.max(this.width,this.height)/2+size+20; x=(this.width/2)+Math.cos(a)*d; y=(this.height/2)+Math.sin(a)*d; const dx=(this.width/2)-x, dy=(this.height/2)-y, m=Math.hypot(dx,dy); vx=(dx/m)*0.8*this.speedMult; vy=(dy/m)*0.8*this.speedMult; }
        else { x=size+Math.random()*(this.width-size*2); const fall=['meteor','flower'].includes(this.mode); y=fall?-60:this.height+60; vx=(Math.random()-0.5)*0.5; vy=fall?(1+Math.random())*this.speedMult:(-1-Math.random())*this.speedMult; }
        this.activeWord={data,x,y,vx,vy,rot:0,rotSpeed:(Math.random()-0.5)*0.02,size,color:this.themeColor,trail:[]};
        this.renderButtons(data);
    },
    renderButtons(cor) {
        const d=document.getElementById('control-dock'); d.innerHTML=''; 
        // 1. Center Ban Button
        const banBtn = document.createElement('button'); banBtn.className='ban-btn-arcade'; banBtn.innerText='ðŸ’€'; 
        banBtn.onclick=()=>this.banActive(); d.appendChild(banBtn);
        // 2. Options
        let opts=[cor], i=0;
        while(opts.length<4&&i<100){const r=this.pool[Math.floor(Math.random()*this.pool.length)];if(!opts.find(x=>x.en===r.en))opts.push(r);i++;}
        opts.sort(()=>Math.random()-0.5);
        opts.forEach(o=>{ const b=document.createElement('button'); b.className='ans-btn'; b.innerText=(Array.isArray(o.es)?o.es[0]:o.es).toUpperCase(); b.onclick=()=>this.fire(o,cor,b); d.appendChild(b); });
    },
    banActive() {
        if(!this.activeWord || this.banningPhase) return;
        const w = this.activeWord.data;
        Profile.ban(w.en); this.banningPhase = true;
        setTimeout(() => {
            this.replaceMasteredWord(w.en); // Uses same logic to remove and replace
            this.banningPhase = false; this.activeWord = null; this.idx++;
            this.spawn();
        }, 800);
    },
    spawnGhost(x,y,t){ if(!this.isPlaying||this.showingGhost)return; let gx=Math.max(50,Math.min(this.width-50,x)), gy=Math.max(50,Math.min(this.height-50,y)); this.ghosts.push({x:gx,y:gy,text:(Array.isArray(t)?t[0]:t).toUpperCase(),life:1.0,vy:-0.5}); this.showingGhost=true; },
    replaceMasteredWord(oldEn) {
        const idx=this.queue.findIndex(w=>w.en===oldEn); if(idx===-1)return; this.queue.splice(idx,1);
        const c=this.fullList.filter(w=>!this.queue.find(q=>q.en===w.en) && !Profile.isBanned(w.en)); // Ensure replacement isn't banned
        if(c.length>0)this.queue.push(c[0]);
        if(idx<this.idx)this.idx--; else if(idx===this.idx)this.idx--;
    },
    fire(sel,cor,btn) {
        if(!this.activeWord||this.banningPhase)return;
        const rect=btn.getBoundingClientRect(), cRect=this.canvas.getBoundingClientRect();
        let ox=(rect.left+rect.width/2)-cRect.left, oy=this.height;
        if(['orbit','butterfly'].includes(this.mode)){ox=this.width/2;oy=this.height/2;}
        const fem=['flower','heart','butterfly'].includes(this.mode), lCol=sel.en===cor.en?(fem?'#86efac':'#10b981'):(fem?'#fda4af':'#ef4444');
        this.laser={x1:ox,y1:oy,x2:this.activeWord.x,y2:this.activeWord.y,life:1.0,color:lCol,time:0};
        if(sel.en===cor.en){
            btn.classList.add('correct-flash'); if(App.audioMode)this.speak(cor.en);
            this.shockwaves.push({x:this.activeWord.x,y:this.activeWord.y,radius:10,alpha:1.0,color:this.activeWord.color});
            this.flashIntensity=0.3; this.combo++; this.createExplosion(this.activeWord.x,this.activeWord.y,this.activeWord.color);
            const newLvl=Profile.setProg(cor.en,true); if(newLvl===4)this.replaceMasteredWord(cor.en);
            App.updateChart(this.queue); this.activeWord=null; this.idx++; if(!this.showingGhost)this.timerId=setTimeout(()=>this.spawn(),500);
        } else {
            btn.classList.add('error-flash'); this.screenShake(); this.spawnGhost(this.activeWord.x,this.activeWord.y,cor.es); this.combo=0;
        }
    },
    fail() {
        if(App.audioMode)this.speak(this.activeWord.data.en); this.screenShake(); this.spawnGhost(this.activeWord.x,this.activeWord.y,this.activeWord.data.es);
        Profile.setProg(this.activeWord.data.en,false); App.updateChart(this.queue); this.createExplosion(this.activeWord.x,this.activeWord.y,'#555');
        this.activeWord=null; this.idx++; this.combo=0;
    },
    createExplosion(x,y,c){ for(let i=0;i<25;i++){const a=Math.random()*Math.PI*2,s=Math.random()*2;this.particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1.0,color:c,size:Math.random()*4});} },
    speak(t){ window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; u.rate=1.1; window.speechSynthesis.speak(u); },
    screenShake(){ const c=this.canvas; c.style.transform=`translate(${Math.random()*10-5}px,${Math.random()*10-5}px)`; setTimeout(()=>c.style.transform='none',200); },
    drawWebLaser(ctx,l){ const d=Math.hypot(l.x2-l.x1,l.y2-l.y1), a=Math.atan2(l.y2-l.y1,l.x2-l.x1); ctx.shadowBlur=20; ctx.shadowColor=l.color; const ds=(w,o,f,m)=>{ctx.beginPath();ctx.strokeStyle=l.color;ctx.lineWidth=w;ctx.globalAlpha=l.life*o;for(let i=0;i<=d;i+=8){const wb=Math.sin(i*0.1+l.time*2)*5*l.life, x=l.x1+Math.cos(a)*i-Math.sin(a)*(Math.sin(i*(0.05+f)+l.time)*(15*l.life*m)+wb), y=l.y1+Math.sin(a)*i+Math.cos(a)*(Math.sin(i*(0.05+f)+l.time)*(15*l.life*m)+wb);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.stroke();}; ds(6,0.6,0,1.0); ds(3,1.0,0.02,1.2); ds(3,1.0,-0.02,0.8); ctx.globalAlpha=1; ctx.shadowBlur=0; l.time+=0.05; },
    drawGrid(ctx){ ctx.strokeStyle="rgba(59,130,246,0.2)"; ctx.lineWidth=1; const h=this.height*0.4; this.gridOffset=(this.gridOffset+2)%40; for(let x=-this.width;x<this.width*2;x+=80){ctx.beginPath();ctx.moveTo(x,this.height);ctx.lineTo(this.width/2+(x-this.width/2)*0.2,h);ctx.stroke();} for(let z=0;z<this.height;z+=40){let y=(z+this.gridOffset)%this.height;if(y<h)continue;let py=h+Math.pow((y-h)/(this.height-h),2)*(this.height-h);ctx.beginPath();ctx.moveTo(0,py);ctx.lineTo(this.width,py);ctx.stroke();} const g=ctx.createLinearGradient(0,h,0,this.height);g.addColorStop(0,"rgba(5,5,5,1)");g.addColorStop(0.2,"rgba(5,5,5,0)");ctx.fillStyle=g;ctx.fillRect(0,h,this.width,this.height-h); },
    
    // RAY BEAM RENDERER
    drawBanBeam(ctx, target) {
        this.banBeamColor += 15;
        const hue = this.banBeamColor % 360;
        const color = `hsl(${hue}, 100%, 60%)`;
        
        // From center bottom (dock is below canvas, so simulate from bottom center)
        let sx = this.width / 2;
        let sy = this.height + 40; // Approx where button is visually
        if(this.mode==='orbit'||this.mode==='butterfly'){ sx=this.width/2; sy=this.height/2; } // Center for orbit

        const l = {x1:sx, y1:sy, x2:target.x, y2:target.y, life:1.0, color:color, time: Date.now()};
        this.drawWebLaser(ctx, l); // Reuse laser logic but thick
        
        // Add particles at target
        for(let i=0; i<5; i++) {
            this.particles.push({
                x: target.x, y: target.y,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                life: 1.0, color: color, size: Math.random()*6
            });
        }
    },

    loop(now) {
        if(!this.isPlaying)return; const dt=(now-this.lastTime)/16; this.lastTime=now;
        this.ctx.fillStyle='#050505'; this.ctx.fillRect(0,0,this.width,this.height);
        const fem=['flower','heart','butterfly'].includes(this.mode);
        if(!fem)this.drawGrid(this.ctx);
        else{ const g=this.ctx.createLinearGradient(0,0,0,this.height);g.addColorStop(0,"#0f172a");g.addColorStop(1,"#1e1b4b");this.ctx.fillStyle=g;this.ctx.fillRect(0,0,this.width,this.height);this.clouds.forEach(c=>{c.x+=c.speed;if(c.x>this.width+100)c.x=-100;this.ctx.fillStyle="rgba(255,255,255,0.3)";this.ctx.beginPath();this.ctx.arc(c.x,c.y,c.size,0,Math.PI*2);this.ctx.fill();}); }
        if(!fem)this.stars.forEach(s=>{s.y+=s.speed;if(s.y>this.height)s.y=0;this.ctx.globalAlpha=0.3+Math.random()*0.5;this.ctx.beginPath();this.ctx.arc(s.x,s.y,s.size,0,Math.PI*2);this.ctx.fillStyle='#fff';this.ctx.fill();}); this.ctx.globalAlpha=1;
        const cx=this.width/2, cy=this.height/2;
        if(['orbit','butterfly'].includes(this.mode)){ if(this.mode==='butterfly'){this.ctx.fillStyle='#fcd34d';this.ctx.beginPath();this.ctx.arc(cx,cy,40,0,Math.PI*2);this.ctx.fill();}else{this.ctx.beginPath();this.ctx.arc(cx,cy,30,0,Math.PI*2);this.ctx.fillStyle='#111';this.ctx.fill();this.ctx.strokeStyle='#3b82f6';this.ctx.lineWidth=2;this.ctx.stroke();}}
        if(this.activeWord){
            const w=this.activeWord; 
            if(!this.banningPhase) {
                w.x+=w.vx*dt; w.y+=w.vy*dt; w.rot+=w.rotSpeed*dt;
                // Standard Draw Logic
                if(this.mode==='meteor'){w.trail.push({x:w.x,y:w.y});if(w.trail.length>15)w.trail.shift();this.ctx.globalCompositeOperation='lighter';w.trail.forEach((p,i)=>{this.ctx.fillStyle=w.color;this.ctx.globalAlpha=i/15;this.ctx.beginPath();this.ctx.arc(p.x,p.y,w.size*(i/20),0,Math.PI*2);this.ctx.fill();});this.ctx.globalCompositeOperation='source-over';this.ctx.globalAlpha=1;}
                let fail=false;
                if(['meteor','flower'].includes(this.mode)&&w.y>this.height-50)fail=true;
                else if(['bubble','heart'].includes(this.mode)&&w.y<50)fail=true;
                else if(['orbit','butterfly'].includes(this.mode)&&Math.hypot(cx-w.x,cy-w.y)<40)fail=true;
                if(fail)this.fail();
            } else {
                // Banning Phase: Shake word and draw beam
                w.x += (Math.random()-0.5)*5; w.y += (Math.random()-0.5)*5;
                this.drawBanBeam(this.ctx, w);
            }

            this.ctx.save(); this.ctx.translate(w.x,w.y);
            if(['orbit','butterfly'].includes(this.mode)){const ang=Math.atan2(cy-w.y,cx-w.x);this.ctx.rotate(ang+Math.PI/2);}else{this.ctx.rotate(w.rot);}
            this.ctx.shadowBlur=20; this.ctx.shadowColor=w.color;
            if(fem){this.ctx.fillStyle=w.color;this.ctx.shadowBlur=15;}else{this.ctx.strokeStyle=w.color;this.ctx.lineWidth=3;}
            this.ctx.beginPath();
            if(this.mode==='meteor'){for(let i=0;i<6;i++)this.ctx.lineTo(w.size*Math.cos(i*Math.PI/3),w.size*Math.sin(i*Math.PI/3));this.ctx.closePath();this.ctx.stroke();this.ctx.fillStyle="rgba(0,0,0,0.8)";this.ctx.fill();}
            else if(this.mode==='bubble'){this.ctx.arc(0,0,w.size,0,Math.PI*2);this.ctx.stroke();this.ctx.fillStyle="rgba(255,255,255,0.05)";this.ctx.fill();}
            else if(this.mode==='orbit'){this.ctx.moveTo(0,20);this.ctx.lineTo(-20,-20);this.ctx.lineTo(20,-20);this.ctx.closePath();this.ctx.stroke();this.ctx.fillStyle="rgba(0,0,0,0.8)";this.ctx.fill();}
            else if(this.mode==='flower'){const p=w.size/2.5;for(let i=0;i<5;i++){this.ctx.beginPath();this.ctx.ellipse(Math.cos(i*2*Math.PI/5)*p,Math.sin(i*2*Math.PI/5)*p,p,p/2,i*2*Math.PI/5,0,2*Math.PI);this.ctx.fill();}this.ctx.beginPath();this.ctx.arc(0,0,w.size/4,0,Math.PI*2);this.ctx.fillStyle='#fffbea';this.ctx.fill();}
            else if(this.mode==='heart'){ const size=w.size; const h=size*0.3; this.ctx.moveTo(0,h); this.ctx.bezierCurveTo(0,0,-size/2,0,-size/2,h); this.ctx.bezierCurveTo(-size/2,(size+h)/2,0,(size+h)/2,0,size); this.ctx.bezierCurveTo(0,(size+h)/2,size/2,(size+h)/2,size/2,h); this.ctx.bezierCurveTo(size/2,0,0,0,0,h); this.ctx.fill(); }
            else if(this.mode==='butterfly'){ const size=w.size, flap=Math.abs(Math.sin(Date.now()*0.0025)); this.ctx.beginPath(); this.ctx.ellipse(-size/3,-size/4,size/2*flap,size/3,-Math.PI/4,0,Math.PI*2); this.ctx.fill(); this.ctx.beginPath(); this.ctx.ellipse(-size/3,size/4,size/2.5*flap,size/4,Math.PI/4,0,Math.PI*2); this.ctx.fill(); this.ctx.beginPath(); this.ctx.ellipse(size/3,-size/4,size/2*flap,size/3,Math.PI/4,0,Math.PI*2); this.ctx.fill(); this.ctx.beginPath(); this.ctx.ellipse(size/3,size/4,size/2.5*flap,size/4,-Math.PI/4,0,Math.PI*2); this.ctx.fill(); this.ctx.fillStyle="#fff"; this.ctx.beginPath(); this.ctx.ellipse(0,0,size/8,size/2,0,0,Math.PI*2); this.ctx.fill(); }
            this.ctx.restore();
            this.ctx.font="bold 26px 'Bebas Neue'";this.ctx.textAlign="center";this.ctx.textBaseline="middle";this.ctx.shadowBlur=0;this.ctx.lineWidth=4;this.ctx.strokeStyle="rgba(0,0,0,0.8)";this.ctx.strokeText(w.data.en.toUpperCase(),w.x,w.y);this.ctx.fillStyle="#fff";this.ctx.fillText(w.data.en.toUpperCase(),w.x,w.y);
        }
        if(this.laser){this.ctx.globalCompositeOperation='lighter';this.drawWebLaser(this.ctx,this.laser);this.laser.life-=0.005;if(this.laser.life<=0)this.laser=null;this.ctx.globalCompositeOperation='source-over';}
        for(let i=this.particles.length-1;i>=0;i--){let p=this.particles[i];p.x+=p.vx;p.y+=p.vy;p.life-=0.005;if(!['orbit','butterfly'].includes(this.mode))p.vy+=0.05;if(p.life<=0)this.particles.splice(i,1);else{this.ctx.globalCompositeOperation='lighter';this.ctx.globalAlpha=p.life;this.ctx.fillStyle=p.color;this.ctx.beginPath();this.ctx.arc(p.x,p.y,p.size,0,Math.PI*2);this.ctx.fill();this.ctx.globalCompositeOperation='source-over';}}
        for(let i=this.shockwaves.length-1;i>=0;i--){let s=this.shockwaves[i];s.radius+=3;s.alpha-=0.02;if(s.alpha<=0)this.shockwaves.splice(i,1);else{this.ctx.strokeStyle=s.color;this.ctx.lineWidth=3;this.ctx.globalAlpha=s.alpha;this.ctx.beginPath();this.ctx.arc(s.x,s.y,s.radius,0,Math.PI*2);this.ctx.stroke();}}
        if(this.flashIntensity>0){this.ctx.fillStyle=this.themeColor;this.ctx.globalAlpha=this.flashIntensity;this.ctx.fillRect(0,0,this.width,this.height);this.ctx.globalAlpha=1;this.flashIntensity-=0.02;}
        for(let i=this.ghosts.length-1;i>=0;i--){let g=this.ghosts[i];g.y+=g.vy;g.life-=0.003;if(g.life<=0){this.ghosts.splice(i,1);this.showingGhost=false;if(!this.activeWord)this.spawn();}else{this.ctx.save();if(g.life>0.9){let s=1+(1-g.life)*5;this.ctx.translate(g.x,g.y);this.ctx.scale(s,s);this.ctx.translate(-g.x,-g.y);}this.ctx.globalAlpha=g.life;this.ctx.font="bold 24px 'Inter'";this.ctx.textAlign="center";this.ctx.lineWidth=3;this.ctx.strokeStyle="#000";this.ctx.strokeText(g.text,g.x,g.y);this.ctx.fillStyle="#fbbf24";this.ctx.fillText(g.text,g.x,g.y);this.ctx.restore();}}
        this.ctx.globalAlpha=1;
        if(this.combo>1){this.ctx.font="italic 900 30px 'Bebas Neue'";this.ctx.fillStyle="#fff";this.ctx.strokeStyle="#000";this.ctx.lineWidth=4;this.ctx.strokeText(`x${this.combo} COMBO!`,this.width-70,40);this.ctx.fillText(`x${this.combo} COMBO!`,this.width-70,40);}
        if(this.timeLimit>0){const l=this.timeLimit-(Date.now()-this.startTime);if(l<=0){this.stop();alert("TIME'S UP!");App.nav('home');return;}else{const m=Math.floor(l/60000),s=Math.floor((l%60000)/1000);document.getElementById('game-timer').innerText=`${m}:${s<10?'0':''}${s}`;}}
        this.loopId=requestAnimationFrame(t=>this.loop(t));
    }
};

const TextGame = {
    queue: [], fullList: [], idx: 0, startTime: 0, timeLimit: 0, fail: false, isPlaying: false, cat: '', nextTimer: null,

    init(queue, cat, fullList) {
        this.queue = queue; this.cat = cat; this.fullList = fullList;
        this.idx = 0; this.startTime = Date.now(); this.timeLimit = Profile.cfg.time * 60 * 1000;
        this.isPlaying = true;
        document.getElementById('game-timer').style.display = this.timeLimit > 0 ? 'block' : 'none';
        this.play(); this.checkTimer();
    },
    stop() { this.isPlaying = false; clearTimeout(this.nextTimer); },
    checkTimer() {
        if(!this.isPlaying) return;
        if(this.timeLimit > 0) {
            const l = this.timeLimit - (Date.now() - this.startTime);
            if(l <= 0) { alert("Time's Up!"); App.nav('home'); return; }
            const m = Math.floor(l / 60000); const s = Math.floor((l % 60000) / 1000);
            document.getElementById('game-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            requestAnimationFrame(() => this.checkTimer());
        }
    },
    syncAudioState() {
        if(!this.isPlaying) return;
        const wEl = document.getElementById('text-word'); const curr = this.queue[this.idx];
        if(App.audioMode) { wEl.innerHTML = '<span style="font-size:40px">ðŸ”Š</span><div style="font-size:14px; opacity:0.5; margin-top:5px">LISTEN & TYPE</div>'; wEl.classList.add('audio-active'); this.speak(curr); } 
        else { wEl.innerText = Array.isArray(curr.es) ? curr.es[0].toUpperCase() : curr.es.toUpperCase(); wEl.classList.remove('audio-active'); }
        // Ensure ban button is present after rewrite
        if(!wEl.parentElement.querySelector('.ban-btn-text')) {
             const b = document.createElement('button'); b.className='ban-btn-text'; b.innerText='ðŸ’€ BAN'; 
             b.onclick=()=>this.banActive(); wEl.parentElement.appendChild(b);
        }
    },
    speak(w) { Game.speak(w.en); },
    replayAudio() { if(App.audioMode) this.speak(this.queue[this.idx]); },
    banActive() {
        const w = this.queue[this.idx];
        Profile.ban(w.en);
        // Visual Effect
        const ray = document.getElementById('text-space-ray');
        ray.classList.add('ray-active');
        setTimeout(() => {
            ray.classList.remove('ray-active');
            // Logic to replace
            const removeIdx = this.queue.findIndex(qw => qw.en === w.en);
            if (removeIdx !== -1) {
                this.queue.splice(removeIdx, 1);
                const cand = this.fullList.filter(fw => !this.queue.find(qw => qw.en === fw.en) && !Profile.isBanned(fw.en));
                if (cand.length > 0) this.queue.push(cand[0]);
                this.idx--; // Adjust
            }
            this.idx++; this.play();
        }, 600);
    },
    play() {
        if (this.idx >= this.queue.length) { this.idx = 0; if (this.queue.length === 0) { alert("Session Complete!"); App.nav('home'); return; } }
        clearTimeout(this.nextTimer);
        document.getElementById('hint-text').style.display = 'none'; document.getElementById('hint-text').innerText = '';
        document.getElementById('btn-hint').innerText = 'ðŸ’¡ SHOW DEFINITION HINT'; document.getElementById('btn-hint').style.display = 'inline-block';
        const curr = this.queue[this.idx]; this.fail = false; 
        
        const wEl = document.getElementById('text-word');
        const banBtnHtml = `<button class="ban-btn-text" onclick="TextGame.banActive()">ðŸ’€ BAN</button>`;

        if(App.audioMode) { wEl.innerHTML = '<span style="font-size:40px">ðŸ”Š</span><div style="font-size:14px; opacity:0.5; margin-top:5px">LISTEN & TYPE</div>' + banBtnHtml; wEl.classList.add('audio-active'); this.speak(curr); } 
        else { wEl.innerHTML = (Array.isArray(curr.es) ? curr.es[0].toUpperCase() : curr.es.toUpperCase()) + banBtnHtml; wEl.classList.remove('audio-active'); }
        
        const con = document.getElementById('text-inputs'); con.innerHTML = '';
        const btn = document.getElementById('btn-text-action'); btn.innerText = "CHECK"; btn.classList.remove('active'); btn.onclick = () => this.validate();
        if (curr.cat.includes('verbs') && (this.cat !== 'custom')) { this.mkInp(con, 'Base', curr.en); this.mkInp(con, 'Past', curr.past); this.mkInp(con, 'Participle', curr.part); } 
        else { this.mkInp(con, 'English', curr.en); }
        setTimeout(() => { const i = con.querySelector('input'); if(i) i.focus(); }, 100);
    },
    mkInp(p, lbl, ans) {
        const d = document.createElement('div'); d.className = 'input-group';
        d.innerHTML = `<span class="input-tag">${lbl}</span><input class="smart-input" data-ans="${ans}" autocomplete="off">`;
        const i = d.querySelector('input');
        i.oninput = () => {
            const all = [...document.querySelectorAll('.smart-input')]; const ready = all.every(x => x.value.trim().length > 0);
            const btn = document.getElementById('btn-text-action');
            if(ready) btn.classList.add('active'); else btn.classList.remove('active');
        };
        i.onkeydown = (e) => {
            if(e.key === 'Enter') {
                const all = [...document.querySelectorAll('.smart-input')]; const ix = all.indexOf(e.target);
                if(ix < all.length - 1) all[ix+1].focus(); else if(document.getElementById('btn-text-action').classList.contains('active')) this.validate();
            }
        };
        p.appendChild(d);
    },
    validate() {
        const inps = document.querySelectorAll('.smart-input'); let pass = true;
        inps.forEach(i => {
            const row = i.parentElement; row.classList.remove('error', 'correct');
            if(i.value.trim().toLowerCase() !== i.dataset.ans.toLowerCase()) { pass = false; row.classList.add('error'); i.value = ''; i.placeholder = i.dataset.ans.toUpperCase(); } 
            else { row.classList.add('correct'); }
        });
        const w = this.queue[this.idx];
        if(!pass) { this.fail = true; Profile.setProg(w.en, false); App.updateChart(this.queue); } 
        else {
            const newLvl = this.fail ? Profile.getLvl(w.en) : Profile.setProg(w.en, true);
            if(!App.audioMode) this.speak(w);
            if (newLvl === 4 && !this.fail) {
                const removeIdx = this.queue.findIndex(qw => qw.en === w.en);
                if (removeIdx !== -1) {
                    this.queue.splice(removeIdx, 1);
                    const cand = this.fullList.filter(fw => !this.queue.find(qw => qw.en === fw.en) && !Profile.isBanned(fw.en));
                    if (cand.length > 0) this.queue.push(cand[0]);
                    this.idx--; // Adjust since array shifted
                }
            }
            const btn = document.getElementById('btn-text-action'); btn.innerText = "NEXT";
            btn.onclick = () => { clearTimeout(this.nextTimer); this.idx++; this.play(); };
            App.updateChart(this.queue);
            this.nextTimer = setTimeout(() => { this.idx++; this.play(); }, 1200);
        }
    },
    checkOrNext() {
        const btn = document.getElementById('btn-text-action');
        if(btn.innerText === "NEXT") { clearTimeout(this.nextTimer); this.idx++; this.play(); } else { this.validate(); }
    },
    async getHint() {
        const btn = document.getElementById('btn-hint'), txt = document.getElementById('hint-text'), w = this.queue[this.idx].en; 
        btn.innerText = "SEARCHING...";
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`);
            const data = await res.json();
            if(data && data[0] && data[0].meanings && data[0].meanings[0].definitions) { txt.innerText = '"' + data[0].meanings[0].definitions[0].definition + '"'; txt.style.display = 'block'; btn.style.display = 'none'; } 
            else { btn.innerText = "NO DEFINITION FOUND"; }
        } catch(e) { btn.innerText = "OFFLINE / ERROR"; }
    }
};

window.onload = () => App.boot();
</script>
</body>
</html>
