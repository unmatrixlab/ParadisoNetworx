¬°Me encanta esa ambici√≥n! Vamos a por el "Campeonato Mundial de Dise√±o".
Para lograr ese nivel Premium/Exquisito (superior a Apple), no podemos usar simplemente un fondo gris plano. Necesitamos:
 * Fondo "Aurora": Un fondo sutilmente animado y colorido para que el efecto "vidrio" (Glassmorphism) realmente resalte. Si el fondo es plano, el vidrio no se nota.
 * Profundidad: Sombras difusas de m√∫ltiples capas.
 * Materiales: Diferenciar entre "Vidrio Grueso" (para el contenedor principal) y "Vidrio Fino" (para men√∫s).
 * Tipograf√≠a: San Francisco / Inter con espaciados perfectos.
 * Micro-interacciones: Todo debe respirar y moverse suavemente.
Aqu√≠ tienes la Versi√≥n 32: "Crystal OS". He reescrito el 100% del CSS para unificar el estilo de toda la aplicaci√≥n con el del Launcher.
üíé Novedades de Dise√±o V32
 * Fondo Mesh Gradient: Un fondo vivo que respira.
 * Tarjetas Flotantes: Efecto de levitaci√≥n real.
 * Inputs iOS: Campos de texto grises suaves con foco animado.
 * Editor Pro: Parece una ventana nativa de macOS Sequoia.
Copia y pega este c√≥digo completo.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Crystal OS V32</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* =========================================
           1. CORE DESIGN SYSTEM (THE "APPLE+" LOOK)
           ========================================= */
        :root {
            /* Palette */
            --accent: #007AFF; 
            --accent-grad: linear-gradient(135deg, #007AFF, #0051e0);
            --danger: #FF3B30; 
            --success: #34C759; 
            --warning: #FF9500;
            --text-main: #1D1D1F; 
            --text-sec: #86868B;
            
            /* Glass Materials */
            --glass-thick: rgba(255, 255, 255, 0.75);
            --glass-thin: rgba(255, 255, 255, 0.5);
            --glass-border: rgba(255, 255, 255, 0.4);
            --blur-strength: 25px;
            
            /* Shapes */
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 10px;
            
            /* Physics */
            --shadow-float: 0 20px 40px rgba(0,0,0,0.08), 0 10px 10px rgba(0,0,0,0.04);
            --shadow-subtle: 0 4px 12px rgba(0,0,0,0.03);
            --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; outline: none; }
        
        body { 
            /* Aurora Background */
            background: 
                radial-gradient(at 0% 0%, hsla(210,100%,93%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,100%,96%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(250,100%,96%,1) 0, transparent 50%);
            background-color: #F5F5F7;
            background-attachment: fixed;
            font-family: 'Inter', -apple-system, sans-serif; 
            padding-top: 80px; padding-bottom: 80px; 
            color: var(--text-main); min-height: 100vh; 
            display: flex; flex-direction: column; align-items: center; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

        /* =========================================
           2. HEADER & GLASS COMPONENTS
           ========================================= */
        /* Universal Glass Card Class */
        .glass-panel {
            background: var(--glass-thick);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-float);
            border-radius: var(--radius-lg);
        }

        #mdc-header { 
            position: fixed; top: 20px; width: auto; height: 50px; 
            padding: 0 30px; border-radius: 30px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.3s ease;
        }
        #mdc-header:hover { transform: translateY(2px); }
        #mdc-header a { text-decoration: none; font-weight: 800; font-size: 16px; letter-spacing: 0.5px; color: #000; text-transform: uppercase; }

        /* =========================================
           3. DASHBOARD (INPUTS & BUTTONS)
           ========================================= */
        .dashboard-container { 
            width: 92%; max-width: 1200px; margin-top: 20px; 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; 
        }
        
        .dash-card { 
            @extend .glass-panel; /* Conceptually */
            background: rgba(255,255,255,0.65);
            padding: 30px; display: flex; flex-direction: column; gap: 20px; 
            position: relative; transition: transform 0.3s var(--ease-elastic);
        }
        .dash-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.85); }

        .dash-title { font-size: 1.4rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 12px; letter-spacing: -0.02em; }
        
        /* iOS Style Inputs */
        .input-group input { 
            width: 100%; padding: 14px 18px; 
            border: 1px solid transparent; border-radius: 14px; 
            font-size: 1rem; background: rgba(0,0,0,0.05); color: var(--text-main);
            transition: all 0.2s; 
        }
        .input-group input:focus { 
            background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            border-color: var(--accent); transform: scale(1.01);
        }
        .input-group input::placeholder { color: #aaa; }

        /* Premium Buttons */
        .btn-main { 
            width: 100%; padding: 16px; 
            background: var(--text-main); color: white; 
            border: none; border-radius: 16px; 
            font-weight: 700; font-size: 1rem; cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); 
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .btn-main:active { transform: scale(0.98); }
        
        .type-selector { display: flex; gap: 6px; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 14px; width: fit-content; }
        .type-pill { padding: 8px 16px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; cursor: pointer; color: var(--text-sec); transition: all 0.3s; }
        .type-pill.active { background: #fff; color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        /* =========================================
           4. LIBRARY GRID (FLOATING CARDS)
           ========================================= */
        .filter-toolbar { width: 92%; max-width: 1200px; margin: 30px 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-btn { padding: 10px 20px; border-radius: 30px; background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.5); color: var(--text-sec); font-weight: 600; font-size: 0.9rem; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s; }
        .filter-btn:hover { background: white; transform: translateY(-2px); }
        .filter-btn.active { background: var(--text-main); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .grid-container { width: 92%; max-width: 1200px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; padding-bottom: 40px; }
        
        .resource-card { 
            background: white; border-radius: 20px; overflow: hidden; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.03); 
            border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.3s var(--ease-elastic); 
            display: flex; flex-direction: column; 
        }
        .resource-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.12); z-index: 2; }
        
        .media-area { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; cursor: pointer; overflow: hidden; }
        .media-area img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: opacity 0.3s; }
        .media-area:hover img { opacity: 0.7; }
        .play-icon { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            width: 60px; height: 60px; background: rgba(255,255,255,0.2); 
            backdrop-filter: blur(10px); border-radius: 50%; border: 1px solid rgba(255,255,255,0.5);
            display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;
            transition: all 0.3s var(--ease-elastic); opacity: 0;
        }
        .media-area:hover .play-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        
        .media-area.web { background: linear-gradient(135deg, #E0EAFC, #CFDEF3); display: flex; align-items: center; justify-content: center; }
        .web-favicon-box { width: 64px; height: 64px; background: white; border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        
        .card-info { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: white; }
        .card-title { font-weight: 700; font-size: 1rem; color: var(--text-main); line-height: 1.4; max-width: 75%; }
        .card-actions button { 
            width: 36px; height: 36px; border-radius: 50%; border: none; 
            background: #F5F5F7; color: var(--text-main); cursor: pointer; 
            font-size: 14px; margin-left: 5px; transition: all 0.2s;
        }
        .card-actions button:hover { background: var(--text-main); color: white; transform: scale(1.1); }

        /* =========================================
           5. EDITOR MODAL (THE WORKSTATION)
           ========================================= */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .editor-popup { 
            background: #fff; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 50px 100px rgba(0,0,0,0.3);
        }
        @media (min-width: 900px) {
            .editor-popup { width: 95%; max-width: 1600px; height: 90vh; flex-direction: row; border-radius: 24px; border: 1px solid rgba(255,255,255,0.5); }
            .desktop-media-container { width: 45%; height: 100%; border-right: 1px solid rgba(0,0,0,0.05); }
            .editor-content-panel { width: 55%; height: 100%; }
            .resizer-gutter { display: block; width: 8px; background: #F5F5F7; cursor: col-resize; flex-shrink: 0; }
        }
        
        /* Mobile Layout */
        .desktop-media-container { display: flex; flex-direction: column; width: 100%; height: 40vh; background: #000; position: relative; }
        .editor-content-panel { display: flex; flex-direction: column; width: 100%; height: 60vh; background: white; }
        .resizer-gutter { display: none; }

        /* Tabs (Segmented Control Style) */
        .web-tab-nav { display: flex; padding: 10px; background: #F5F5F7; gap: 5px; height: auto; overflow-x: auto; }
        .web-tab-btn { 
            flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 10px; 
            background: transparent; font-size: 0.8rem; font-weight: 600; color: #888; 
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .web-tab-btn:hover { background: rgba(255,255,255,0.5); }
        .web-tab-btn.active { background: white; color: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab-gear { margin-left: 6px; opacity: 0.3; font-size: 12px; }
        
        /* Colors for Tabs & Buttons */
        .channel-1.active { color: #007AFF !important; box-shadow: 0 2px 8px rgba(0,122,255,0.2) !important; }
        .channel-2.active { color: #34C759 !important; box-shadow: 0 2px 8px rgba(52,199,89,0.2) !important; }
        .channel-3.active { color: #AF52DE !important; box-shadow: 0 2px 8px rgba(175,82,222,0.2) !important; }
        .channel-4.active { color: #FF9500 !important; box-shadow: 0 2px 8px rgba(255,149,0,0.2) !important; }
        .channel-5.active { color: #FF3B30 !important; box-shadow: 0 2px 8px rgba(255,59,48,0.2) !important; }

        .web-content-area { flex: 1; position: relative; background: #fff; overflow: hidden; }
        .web-frame-container { width: 100%; height: 100%; display: none; }
        .web-frame-container.active { display: block; }
        .web-frame-container iframe { width: 100%; height: 100%; border: none; }

        /* Toolbar */
        .editor-header { padding: 15px 25px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .editor-toolbar { padding: 10px 25px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; overflow-x: auto; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); }
        
        .ctrl-target-group { display: flex; background: #F0F0F2; border-radius: 12px; padding: 4px; gap: 4px; align-items: center; }
        .btn-target { width: 32px; height: 32px; border: none; background: transparent; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #999; cursor: pointer; transition: all 0.2s; }
        .btn-target.active { background: white; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-lock { width: 32px; border: none; background: transparent; cursor: pointer; opacity: 0.3; }
        .btn-lock.locked { opacity: 1; }

        .btn-import { background: var(--text-main); color: white; padding: 8px 16px; border-radius: 12px; border: none; font-size: 0.8rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: transform 0.1s; }
        .btn-import:active { transform: scale(0.95); }
        
        .editor-area { flex: 1; padding: 40px; font-family: 'Inter', sans-serif; font-size: 1.1rem; line-height: 1.7; overflow-y: auto; color: #333; }

        /* =========================================
           6. SMART LAUNCHER (GLASS POPUP)
           ========================================= */
        .launcher-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(15px);
            z-index: 5000; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .launcher-modal.active { display: flex; opacity: 1; }

        .launcher-box {
            width: 650px; max-width: 90%; height: 600px;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 30px; box-shadow: 0 40px 80px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.9); transition: transform 0.4s var(--ease-elastic);
        }
        .launcher-modal.active .launcher-box { transform: scale(1); }

        .launcher-header { padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .launcher-title { font-weight: 800; font-size: 1.2rem; color: var(--text-main); }
        .launcher-close { width: 36px; height: 36px; background: rgba(0,0,0,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; transition: all 0.2s; }
        .launcher-close:hover { background: rgba(0,0,0,0.1); transform: rotate(90deg); }

        .launcher-body { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

        .input-wrapper { display: flex; gap: 10px; margin-bottom: 25px; background: #e9e9eb; padding: 6px; border-radius: 18px; transition: all 0.2s; }
        .input-wrapper:focus-within { background: white; box-shadow: 0 0 0 2px var(--accent); }
        .btn-paste { width: 44px; border: none; background: transparent; cursor: pointer; font-size: 1.2rem; opacity: 0.5; transition: opacity 0.2s; }
        .btn-paste:hover { opacity: 1; }
        .launcher-input { flex: 1; border: none; background: transparent; padding: 10px; font-size: 1.1rem; }
        .btn-go { background: var(--accent); color: white; border: none; padding: 0 24px; border-radius: 14px; font-weight: 700; cursor: pointer; }

        .filter-glass-bar { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
        .filter-pill { padding: 8px 18px; border-radius: 20px; border: none; background: rgba(255,255,255,0.5); font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; color: #666; }
        .filter-pill:hover { background: white; transform: translateY(-2px); }
        .filter-pill.active { background: var(--text-main); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }

        .apps-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .app-item { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 20px; background: rgba(255,255,255,0.5); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: all 0.3s; position: relative; text-align: center; }
        .app-item:hover { background: white; transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); z-index: 2; }
        .app-icon { width: 48px; height: 48px; object-fit: contain; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .app-name { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        .app-cat-tag { font-size: 0.7rem; color: var(--text-sec); text-transform: uppercase; margin-top: 2px; }
        
        .app-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0; transform: scale(0.8); transition: all 0.2s; }
        .app-item:hover .app-actions { opacity: 1; transform: scale(1); }
        .btn-mini-action { width: 24px; height: 24px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-edit-app { background: var(--warning); }
        .btn-del-app { background: var(--danger); }

        /* Exercise Styles */
        .exercise-box { background: #fcfcfc; border: 1px solid #eee; border-radius: 16px; padding: 25px; margin: 30px 0; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02); }
        .ex-select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: white; font-family: inherit; font-size: 1rem; cursor: pointer; }
        .ex-select.correct { border-color: var(--success); background: #f0fdf4; color: #15803d; font-weight: 600; }
        .ex-select.wrong { border-color: var(--danger); background: #fef2f2; color: #b91c1c; }
    </style>
</head>
<body>

    <div id="mdc-header">
        <a href="#">MDC CRYSTAL OS</a>
    </div>

    <div class="dashboard-container">
        <div class="dash-card">
            <div class="dash-title"><span style="font-size:1.5rem">‚ú®</span> New Card</div>
            <div class="input-group"><input type="text" id="resUrl" placeholder="Paste Link (YouTube, Web, PDF)..."></div>
            <div class="input-group"><input type="text" id="resTitle" placeholder="Topic Title..."></div>
            <button class="btn-main" onclick="addResource()">Create Card</button>
        </div>

        <div class="dash-card">
            <div class="dash-title"><span style="font-size:1.5rem">üíæ</span> Backup</div>
            <div style="font-size:0.9rem; color:#666; line-height:1.5;">Auto-mirroring active. Data stored locally with persistence.</div>
            <div style="display:flex; gap:10px; margin-top:auto;">
                <button class="btn-main" style="background:#E5E5EA; color:#333;" onclick="downloadBackup()">Save</button>
                <input type="file" id="importFile" style="display:none" onchange="importBackup(this)">
                <button class="btn-main" style="background:#E5E5EA; color:#333;" onclick="document.getElementById('importFile').click()">Load</button>
            </div>
        </div>
    </div>

    <div class="filter-toolbar">
        <button class="filter-btn active" onclick="loadResources()">All</button>
        <div class="input-group" style="margin-left:auto; width:250px;">
            <input type="text" id="searchInput" placeholder="Search library..." oninput="loadResources()" style="padding: 10px 20px; border-radius: 30px; background:rgba(255,255,255,0.7);">
        </div>
    </div>

    <div class="grid-container" id="video-grid"></div>

    <div class="modal-overlay" id="editor-modal">
        <div class="editor-popup" id="editor-popup">
            <div class="desktop-media-container" id="desktop-media-wrapper"></div>
            <div class="resizer-gutter" id="drag-resizer"></div>
            
            <div class="editor-content-panel">
                <div class="editor-header">
                    <span style="font-weight:800; font-size:1.1rem; letter-spacing:-0.5px;">Workstation</span>
                    <button onclick="closeEditor()" style="border:none; background:#f2f2f2; width:32px; height:32px; border-radius:50%; font-size:1.2rem; color:#333; cursor:pointer;">√ó</button>
                </div>
                <div class="editor-toolbar">
                    <button class="btn-import" onclick="importExerciseCode()">üì• Import JSON</button>
                    <div style="width:1px; height:24px; background:#ddd; margin:0 10px;"></div>
                    
                    <div class="ctrl-target-group">
                        <button class="btn-lock locked" id="btn-sync-lock" onclick="toggleSyncLock()">üîí</button>
                        <button class="btn-target channel-1 active" onclick="setControlTarget(0)">1</button>
                        <button class="btn-target channel-2" onclick="setControlTarget(1)">2</button>
                        <button class="btn-target channel-3" onclick="setControlTarget(2)">3</button>
                        <button class="btn-target channel-4" onclick="setControlTarget(3)">4</button>
                        <button class="btn-target channel-5" onclick="setControlTarget(4)">5</button>
                    </div>
                    
                    <button class="btn-target" id="btn-main-play" onclick="togglePlay()" style="font-size:1.2rem; margin-left:10px;">‚èØÔ∏è</button>
                </div>
                <div id="editor-text" class="editor-area" contenteditable="true" oninput="saveNote()" placeholder="Type notes here..."></div>
            </div>
        </div>
    </div>

<script>
    /* ====== CONFIG & STATE ====== */
    const STORAGE_KEY = 'mdc_saved_favorites';
    const MIRROR_RES_KEY = 'mdc_mirror_res_bak';
    const FAV_KEY = 'mdc_tab_favs';
    
    // Default Apps
    const DEFAULT_APPS = [
        { title: "Editor Interno", url: "internal:editor", icon: "https://cdn-icons-png.flaticon.com/512/2921/2921222.png", cat: "System" },
        { title: "ChatGPT", url: "https://chatgpt.com", icon: "https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg", cat: "AI" },
        { title: "Claude", url: "https://claude.ai", icon: "https://upload.wikimedia.org/wikipedia/commons/7/74/Claude_AI_Logo.png", cat: "AI" },
        { title: "DeepL", url: "https://www.deepl.com/translator", icon: "https://static.deepl.com/img/logo/deepl-logo-blue.svg", cat: "Tools" },
        { title: "Wikipedia", url: "https://wikipedia.org", icon: "https://www.google.com/s2/favicons?domain=wikipedia.org&sz=128", cat: "Reference" }
    ];

    let players = [null, null, null, null, null]; 
    let controlTarget = 0; 
    let currentEditIndex = -1; let currentResourceId = null;
    let activeTabIndexForPopup = 0;
    let isSyncLocked = true; 
    let currentAppFilter = 'All';

    document.addEventListener('DOMContentLoaded', () => {
        initDataGuardian(); loadResources(); injectTabPopupHtml(); initResizer();
    });

    /* ====== SMART LAUNCHER (CORE V31) ====== */
    function injectTabPopupHtml() {
        if(document.getElementById('smart-launcher')) return;
        const html = `
        <div id="smart-launcher" class="launcher-modal" onclick="if(event.target===this) closeLauncher()">
            <div class="launcher-box">
                <div class="launcher-header">
                    <span class="launcher-title">App Library <span id="launcher-tab-num" style="opacity:0.4; font-weight:400; margin-left:8px">Tab #1</span></span>
                    <div class="launcher-close" onclick="closeLauncher()">‚úï</div>
                </div>
                <div class="launcher-body">
                    <div class="input-wrapper">
                        <button class="btn-paste" onclick="pasteFromClipboard()" title="Paste">üìã</button>
                        <input type="text" id="launcher-input" class="launcher-input" placeholder="Type URL (e.g. bbc.com)..." onkeyup="if(event.key==='Enter') addAndLaunch()">
                        <button class="btn-go" onclick="addAndLaunch()">Go</button>
                    </div>
                    <div class="filter-glass-bar" id="launcher-filters"></div>
                    <div class="apps-grid" id="launcher-grid"></div>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    }

    window.editTabUrl = function(idx, event) {
        event.stopPropagation();
        if(currentEditIndex === -1) { if(confirm("Save card first?")) saveFreeModeWork("Draft"); else return; }
        activeTabIndexForPopup = idx;
        document.getElementById('launcher-tab-num').innerText = `Tab #${idx + 1}`;
        const currentRes = JSON.parse(localStorage.getItem(STORAGE_KEY))[currentEditIndex];
        const key = idx === 0 ? 'url' : `url${idx+1}`;
        document.getElementById('launcher-input').value = currentRes[key] || '';
        currentAppFilter = 'All'; renderLauncherFilters(); renderLauncherApps();
        document.getElementById('smart-launcher').classList.add('active');
        document.getElementById('launcher-input').focus();
    };

    function closeLauncher() { document.getElementById('smart-launcher').classList.remove('active'); }
    async function pasteFromClipboard() { try { const t = await navigator.clipboard.readText(); document.getElementById('launcher-input').value = t; document.getElementById('launcher-input').focus(); } catch (e) {} }

    function getStoredApps() {
        let apps = JSON.parse(localStorage.getItem(FAV_KEY));
        if (!apps || apps.length === 0) { apps = JSON.parse(JSON.stringify(DEFAULT_APPS)); localStorage.setItem(FAV_KEY, JSON.stringify(apps)); }
        return apps;
    }

    function renderLauncherFilters() {
        const apps = getStoredApps();
        const categories = ['All', ...new Set(apps.map(a => a.cat || 'Unsorted'))];
        const bar = document.getElementById('launcher-filters'); bar.innerHTML = '';
        categories.forEach(cat => {
            const cls = (cat === currentAppFilter) ? 'active' : '';
            bar.innerHTML += `<button class="filter-pill ${cls}" onclick="setLauncherFilter('${cat}')">${cat}</button>`;
        });
    }
    function setLauncherFilter(c) { currentAppFilter = c; renderLauncherFilters(); renderLauncherApps(); }

    function renderLauncherApps() {
        const grid = document.getElementById('launcher-grid'); grid.innerHTML = '';
        const apps = getStoredApps();
        const filtered = (currentAppFilter === 'All') ? apps : apps.filter(a => (a.cat || 'Unsorted') === currentAppFilter);
        filtered.forEach((app, i) => {
            const realIdx = apps.indexOf(app);
            grid.innerHTML += `
            <div class="app-item" onclick="launchApp('${app.url}')">
                <div class="app-actions" onclick="event.stopPropagation()">
                    <button class="btn-mini-action btn-edit-app" onclick="editApp(${realIdx})" title="Edit">‚úé</button>
                    <button class="btn-mini-action btn-del-app" onclick="deleteApp(${realIdx})" title="Delete">√ó</button>
                </div>
                <img src="${app.icon}" class="app-icon" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1006/1006771.png'">
                <div class="app-info"><span class="app-name">${app.title}</span><span class="app-cat-tag">${app.cat || 'General'}</span></div>
            </div>`;
        });
    }

    function addAndLaunch() {
        let url = document.getElementById('launcher-input').value.trim(); if(!url) return;
        if(!url.startsWith('http') && !url.startsWith('internal:') && !url.startsWith('about:')) url = 'https://' + url;
        const apps = getStoredApps();
        if (!apps.some(a => a.url === url) && !url.includes('internal:')) {
            if(confirm("New App. Save to library?")) {
                const cat = prompt("Category:", "Web");
                if(cat) {
                    const dom = getDomain(url);
                    apps.push({ title: dom.charAt(0).toUpperCase()+dom.slice(1), url: url, icon: `https://www.google.com/s2/favicons?domain=${url}&sz=128`, cat: cat });
                    localStorage.setItem(FAV_KEY, JSON.stringify(apps));
                }
            }
        }
        launchApp(url);
    }

    function editApp(index) {
        const apps = getStoredApps(); const app = apps[index];
        const newTitle = prompt("Name:", app.title); if(newTitle===null) return;
        const newCat = prompt("Category:", app.cat || "General"); if(newCat===null) return;
        const newUrl = prompt("URL:", app.url); if(newUrl===null) return;
        app.title = newTitle.trim(); app.cat = newCat.trim(); app.url = newUrl.trim();
        app.icon = `https://www.google.com/s2/favicons?domain=${app.url}&sz=128`;
        localStorage.setItem(FAV_KEY, JSON.stringify(apps));
        renderLauncherFilters(); renderLauncherApps();
    }

    function deleteApp(index, e) {
        e.stopPropagation(); if(!confirm("Delete?")) return;
        const apps = getStoredApps(); apps.splice(index, 1);
        localStorage.setItem(FAV_KEY, JSON.stringify(apps));
        renderLauncherFilters(); renderLauncherApps();
    }

    function launchApp(url) {
        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const key = activeTabIndexForPopup === 0 ? 'url' : `url${activeTabIndexForPopup+1}`;
        resources[currentEditIndex][key] = url;
        if (activeTabIndexForPopup === 0) {
            const ytId = getYouTubeID(url);
            resources[currentEditIndex].type = ytId ? 'video' : 'web';
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));
        closeLauncher(); openEditorById(resources[currentEditIndex].id);
        setTimeout(() => switchWebTab(activeTabIndexForPopup), 300);
    }

    /* ====== EDITOR & TABS LOGIC ====== */
    function openEditorById(id) {
        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const index = resources.findIndex(r => String(r.id) === String(id));
        if (index === -1) return;
        
        currentEditIndex = index; const resData = resources[index]; currentResourceId = resData.id;
        document.getElementById('editor-text').innerHTML = resData.note || "";
        document.getElementById('editor-modal').classList.add('active');
        
        // Render Tabs
        const container = document.getElementById('desktop-media-wrapper');
        const getBtn = (idx, link) => `<button class="web-tab-btn channel-${idx+1} ${idx===0?'active':''}" onclick="switchWebTab(${idx})">Tab ${idx+1}<span class="tab-gear" onclick="window.editTabUrl(${idx}, event)">‚öôÔ∏è</span></button>`;
        let nav = `<div class="web-tab-nav">${getBtn(0, resData.url)}${getBtn(1, resData.url2)}${getBtn(2, resData.url3)}${getBtn(3, resData.url4)}${getBtn(4, resData.url5)}</div>`;
        let content = `<div class="web-content-area">`;
        
        [resData.url, resData.url2, resData.url3, resData.url4, resData.url5].forEach((url, i) => {
            const ytId = getYouTubeID(url);
            let inner = '';
            if (url === 'internal:editor') inner = `<div style="padding:20px; text-align:center; color:#999; margin-top:20px;">Use the main editor panel below/right.</div>`;
            else if (ytId) inner = `<div id="player-tab-${i}" style="width:100%;height:100%"></div>`;
            else if (url) inner = `<iframe src="${url}" allowfullscreen style="width:100%;height:100%;border:none;"></iframe>`;
            else inner = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ccc;">Empty Tab</div>`;
            content += `<div class="web-frame-container ${i===0?'active':''}" id="tab-content-${i}">${inner}</div>`;
        });
        content += `</div>`;
        container.innerHTML = nav + content;

        // Init Players
        players = [null,null,null,null,null];
        [resData.url, resData.url2, resData.url3, resData.url4, resData.url5].forEach((url, i) => {
            const ytId = getYouTubeID(url);
            if(ytId) players[i] = new YT.Player(`player-tab-${i}`, { width:'100%', height:'100%', videoId: ytId, playerVars:{autoplay:0, rel:0}, events:{'onStateChange':(e)=>onPlayerStateChange(e, resData.id, players[i])} });
        });
        
        setControlTarget(0, true);
    }

    function closeEditor() {
        if(players[0]) saveMediaTime(players[0], currentResourceId);
        players = [null,null,null,null,null];
        document.getElementById('editor-modal').classList.remove('active');
        document.getElementById('desktop-media-wrapper').innerHTML = '';
        loadResources();
    }

    function switchWebTab(idx, fromSync=false) {
        activeTabIndexForPopup = idx;
        document.querySelectorAll('.web-tab-btn').forEach((b, i) => { if(i === idx) b.classList.add('active'); else b.classList.remove('active'); });
        document.querySelectorAll('.web-frame-container').forEach((f, i) => { if(i === idx) f.classList.add('active'); else f.classList.remove('active'); });
        if(isSyncLocked && !fromSync) setControlTarget(idx, true);
    }

    function setControlTarget(idx, fromSync=false) {
        controlTarget = idx;
        document.querySelectorAll('.btn-target').forEach((b, i) => { if(i === idx) b.classList.add('active'); else b.classList.remove('active'); });
        if(isSyncLocked && !fromSync) switchWebTab(idx, true);
    }
    
    function toggleSyncLock() { isSyncLocked = !isSyncLocked; document.getElementById('btn-sync-lock').classList.toggle('locked', isSyncLocked); if(isSyncLocked) setControlTarget(activeTabIndexForPopup, true); }

    /* ====== BASIC FUNCTIONS ====== */
    function loadResources() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const filtered = all.filter(r => r.title.toLowerCase().includes(query));
        
        const grid = document.getElementById('video-grid'); grid.innerHTML = '';
        filtered.forEach(r => {
            const type = r.type || 'web'; const vid = getYouTubeID(r.url);
            let media = (type==='video' && vid) 
                ? `<div class="media-area video" onclick="openEditorById('${r.id}')"><img src="https://img.youtube.com/vi/${vid}/mqdefault.jpg"><div class="play-icon">‚ñ∂</div></div>`
                : `<div class="media-area web" onclick="openEditorById('${r.id}')"><div class="web-favicon-box"><img src="https://www.google.com/s2/favicons?domain=${r.url}&sz=64"></div></div>`;
            
            grid.innerHTML += `
            <div class="resource-card">
                ${media}
                <div class="card-info">
                    <div class="card-title">${r.note ? 'üìù ' : ''}${r.title}</div>
                    <div class="card-actions"><button onclick="openEditorById('${r.id}')">‚úèÔ∏è</button><button onclick="deleteResourceById('${r.id}')" style="color:red">üóëÔ∏è</button></div>
                </div>
            </div>`;
        });
    }

    function addResource() {
        const url = document.getElementById('resUrl').value.trim();
        const title = document.getElementById('resTitle').value.trim();
        if(!url) return alert("URL Required");
        const res = { id: Date.now().toString(), url: url, title: title || getDomain(url), type: getYouTubeID(url)?'video':'web', note: "", url2:'', url3:'', url4:'', url5:'' };
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        list.unshift(res); localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        loadResources(); document.getElementById('resUrl').value=''; document.getElementById('resTitle').value='';
    }

    /* ====== EXERCISE IMPORT ====== */
    async function importExerciseCode() {
        let json = ""; try { json = await navigator.clipboard.readText(); } catch(e) { json = prompt("Paste JSON:"); }
        if(!json) return;
        try {
            const data = JSON.parse(json.replace(/```json/g,'').replace(/```/g,'').trim());
            const exercises = Array.isArray(data) ? data : (data.exercises || []);
            let html = `<div class="exercise-box" contenteditable="false"><div class="exercise-header"><span>‚úçÔ∏è Exercise</span><button class="btn-del-block" onclick="this.closest('.exercise-box').remove();saveNote()">Delete</button></div>`;
            exercises.forEach((ex,i) => {
                let txt = ex.cloze_text ? ex.cloze_text.replace(/\{([^}]+)\}/g, (m,c) => {
                    const parts = c.split('|'); const correct = parts[0].trim(); const opts = parts.sort(()=>Math.random()-0.5).map(o=>`<option value="${o.trim()}">${o.trim()}</option>`).join('');
                    return `<select class="ex-select" onchange="window.validateExercise(this, '${correct}')"><option disabled selected>...</option>${opts}</select>`;
                }) : ex.question || "Exercise content...";
                html += `<div class="exercise-row"><b>${i+1}.</b> ${txt}</div>`;
            });
            html += `</div><p><br></p>`;
            document.getElementById('editor-text').insertAdjacentHTML('beforeend', html);
            saveNote();
        } catch(e) { alert("Invalid JSON Code"); }
    }

    /* ====== UTILS & SAFETY ====== */
    window.validateExercise = function(s, c) { s.classList.remove('correct','wrong'); if(s.value===c) s.classList.add('correct'); else s.classList.add('wrong'); saveNote(); };
    window.saveNote = function() { 
        if(currentEditIndex>-1) {
            document.querySelectorAll('#editor-text select').forEach(s => { s.querySelectorAll('option').forEach(o => { if(o.value===s.value) o.setAttribute('selected','true'); else o.removeAttribute('selected'); }); });
            const r = JSON.parse(localStorage.getItem(STORAGE_KEY)); r[currentEditIndex].note = document.getElementById('editor-text').innerHTML; localStorage.setItem(STORAGE_KEY, JSON.stringify(r)); 
        } 
    };
    function getYouTubeID(url) { if(!url) return null; const m = url.match(/(?:v=|youtu\.be\/)([^&?]+)/); return m ? m[1] : null; }
    function getDomain(url) { try { return new URL(url).hostname.replace('www.',''); } catch { return 'Web'; } }
    function onPlayerStateChange(e, id, p) { if(e.data===1 && players[controlTarget]===p) document.getElementById('btn-main-play').innerText="‚è∏Ô∏è"; else if(e.data!==1 && players[controlTarget]===p) document.getElementById('btn-main-play').innerText="‚ñ∂Ô∏è"; if(e.data===1) { clearInterval(trackingInterval); trackingInterval = setInterval(()=>saveMediaTime(p,id),5000); } else { saveMediaTime(p,id); clearInterval(trackingInterval); } }
    function saveMediaTime(p, id) { if(!p) return; let t = (typeof p.getCurrentTime==='function')?p.getCurrentTime():0; if(t>0) { const r = JSON.parse(localStorage.getItem(STORAGE_KEY)); const idx = r.findIndex(x=>x.id===id); if(idx>-1) { r[idx].lastTime = t; localStorage.setItem(STORAGE_KEY, JSON.stringify(r)); } } }
    function togglePlay() { const p = players[controlTarget]; if(p) (p.getPlayerState()===1)?p.pauseVideo():p.playVideo(); }
    function initDataGuardian() { if(navigator.storage && navigator.storage.persist) navigator.storage.persist(); const m = localStorage.getItem(STORAGE_KEY); const mir = localStorage.getItem(MIRROR_RES_KEY); if((!m || m==='[]') && (mir && mir.length>50)) { if(confirm("Restore from Backup?")) { localStorage.setItem(STORAGE_KEY, mir); location.reload(); } } const os = localStorage.setItem; localStorage.setItem = function(k,v) { os.apply(this,[k,v]); if(k===STORAGE_KEY && v.length>50) os.apply(this,[MIRROR_RES_KEY,v]); }; }
    function downloadBackup() { const d = localStorage.getItem(STORAGE_KEY)||'[]'; const b = new Blob([d],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `MDC_V32_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function importBackup(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload=e=>{ try { const d = JSON.parse(e.target.result); localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.isArray(d)?d:(d.resources||[]))); loadResources(); } catch(x){alert("Error");} }; r.readAsText(f); }
    function deleteResourceById(id) { if(confirm("Delete?")) { const r = JSON.parse(localStorage.getItem(STORAGE_KEY)).filter(x=>x.id!==id); localStorage.setItem(STORAGE_KEY, JSON.stringify(r)); loadResources(); } }
    function initResizer() { 
        const r=document.getElementById('drag-resizer'); const p=document.getElementById('desktop-media-wrapper');
        r.onmousedown=e=>{ document.onmousemove=ex=>{ p.style.width=(ex.clientX/window.innerWidth*100)+'%'; }; document.onmouseup=()=>{ document.onmousemove=null; }; }; 
    }
</script>
</body>
</html>

