<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Polyglot Tutor V33 (Dual Pro)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007AFF;
            --bg-body: #F2F2F7;
            --header-height: 60px;
            --success: #34C759;
            --danger: #FF3B30;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            padding-top: var(--header-height);
            padding-bottom: 60px;
            color: #111;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: scroll;
        }

        /* ====== TOP HEADER ====== */
        #mdc-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: rgba(10, 20, 35, 0.95); backdrop-filter: blur(16px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #mdc-header a { text-decoration: none; font-weight: 900; font-size: 22px; color: white; letter-spacing: 1px; }

        /* ====== CONTROL BAR ====== */
        .control-bar {
            width: 95%; max-width: 1200px; margin: 20px auto 15px auto;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border: 1px solid #d1d1d6; border-radius: 16px; padding: 12px 16px;
            display: flex; align-items: center; justify-content: space-between; gap: 15px; z-index: 900;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .control-left { display: flex; align-items: center; gap: 12px; flex-grow: 1; }
        .compact-search { position: relative; width: 100%; max-width: 400px; }
        .compact-search input {
            width: 100%; padding: 10px 12px 10px 36px; border-radius: 10px;
            border: 1px solid #ccc; outline: none; transition: border 0.2s;
        }
        .compact-search input:focus { border-color: var(--primary); }
        .compact-search .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.6; }

        .btn-new-session {
            background: #000; color: white; padding: 10px 20px; border-radius: 10px;
            border: none; font-weight: 700; cursor: pointer; transition: transform 0.2s;
        }
        .btn-new-session:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .btn-data-mini {
            width: 42px; height: 42px; border-radius: 10px; border: 1px solid #ccc;
            background: #fff; cursor: pointer; font-size: 1.3rem; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .btn-data-mini:hover { background: #f0f0f5; }

        /* ====== GRID SYSTEM ====== */
        .section-header { width: 95%; max-width: 1200px; margin: 20px auto 5px auto; font-weight: 900; border-bottom: 2px solid #e5e5ea; color: #444; text-transform: uppercase; font-size: 0.9rem; padding-bottom: 5px; }
        .grid-container { width: 95%; max-width: 1200px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding-bottom: 60px; margin: 20px auto; }
        
        .resource-card { 
            background: white; border-radius: 16px; overflow: hidden; border: 1px solid #e5e5ea; height: 260px; display: flex; flex-direction: column; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .resource-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }

        .media-area { height: 150px; background: #000; position: relative; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center;}
        .media-area img { width: 100%; height: 100%; object-fit: cover; opacity: 0.95; transition: opacity 0.2s; }
        .media-area:hover img { opacity: 0.8; }
        .play-icon { position: absolute; width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        .card-info { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-weight: 800; font-size: 1rem; color: #111; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-actions { display: flex; gap: 8px; margin-top: auto; }
        .btn-action { flex: 1; background: #f9f9fb; border: 1px solid #e5e5ea; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #555; transition: all 0.2s; }
        .btn-action:hover { background: #e5e5ea; color: #000; }
        .btn-action.delete:hover { background: #fff0f0; color: var(--danger); border-color: #ffcccc; }

        /* ====== DUAL WINDOW MODAL ====== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        
        .editor-popup { 
            background: #1c1c1e; 
            width: 98%; max-width: 1800px; height: 95vh; 
            display: flex; flex-direction: row; 
            border-radius: 16px; overflow: hidden; 
            box-shadow: 0 30px 80px rgba(0,0,0,0.6); 
            border: 1px solid #333;
        }

        .split-panel { 
            flex: 1; min-width: 300px; display: flex; flex-direction: column; 
            background: #fff; position: relative; 
        }

        .resizer-gutter { 
            width: 12px; background: #111; cursor: col-resize; flex-shrink: 0; 
            border-left: 1px solid #333; border-right: 1px solid #333; 
            display: flex; align-items: center; justify-content: center;
        }
        .resizer-gutter::after { content: "‚ãÆ"; color: #555; font-size: 12px; }
        .resizer-gutter:hover { background: #007AFF; }

        /* WEB TABS */
        .web-tab-nav { 
            display: flex; background: #f2f2f7; border-bottom: 1px solid #d1d1d6; 
            height: 44px; flex-shrink: 0; 
        }
        .web-tab-btn { 
            flex: 1; border: none; background: #f2f2f7; color: #888; 
            font-size: 0.85rem; font-weight: 700; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            border-bottom: 3px solid transparent; transition: all 0.2s; 
            padding: 0 10px; white-space: nowrap; overflow: hidden;
        }
        .web-tab-btn:hover { background: #e5e5ea; color: #555; }
        
        /* Colores por pesta√±a para f√°cil identificaci√≥n */
        .web-tab-btn.active-1 { color: #007AFF; border-bottom-color: #007AFF; background: #fff; }
        .web-tab-btn.active-2 { color: #34C759; border-bottom-color: #34C759; background: #fff; }
        .web-tab-btn.active-3 { color: #AF52DE; border-bottom-color: #AF52DE; background: #fff; }
        .web-tab-btn.active-4 { color: #FF9500; border-bottom-color: #FF9500; background: #fff; }
        .web-tab-btn.active-5 { color: #FF3B30; border-bottom-color: #FF3B30; background: #fff; }

        .tab-gear { 
            font-size: 0.9rem; opacity: 0.4; padding: 4px; border-radius: 50%; transition: all 0.2s;
        }
        .tab-gear:hover { opacity: 1; background: rgba(0,0,0,0.1); color: #000; transform: rotate(90deg); }

        .web-content-area { flex: 1; position: relative; width: 100%; height: 100%; background: #fff; }
        .web-frame-container { width: 100%; height: 100%; display: none; position: relative; }
        .web-frame-container.active { display: block; }
        .web-frame-container iframe { width: 100%; height: 100%; border: none; background: #fff; }
        
        .web-error-bg { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #ccc; background: #f9f9fb; font-weight: 600; text-align: center;
        }

        .floating-close {
            position: absolute; top: 15px; right: 15px; z-index: 3000;
            width: 40px; height: 40px; background: #fff; color: #111;
            border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.2s;
        }
        .floating-close:hover { transform: scale(1.1); background: #FF3B30; color: white; }

        /* ====== TAB CONFIG POPUP (RESTAURADO) ====== */
        .tab-settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .tab-settings-modal.active { display: flex; }
        .tab-popup-content { 
            background: #fff; padding: 25px; border-radius: 16px; 
            width: 700px; max-width: 95%; max-height: 85vh; 
            box-shadow: 0 25px 80px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column;
        }
        
        .tab-popup-header { font-weight: 800; margin-bottom: 20px; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .tab-input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-input-group input { 
            flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; 
            font-size: 1rem; color: #000; outline: none; min-width: 250px;
        }
        .tab-input-group input:focus { border-color: var(--primary); }
        
        .tab-btn-action { 
            padding: 0 16px; border-radius: 8px; cursor: pointer; font-weight: 700; border: none; 
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-paste { background: #e5e5ea; color: #333; }
        .btn-paste:hover { background: #d1d1d6; }
        .tab-btn-go { background: var(--primary); color: white; }
        .tab-btn-go:hover { background: #0062cc; transform: scale(1.02); }
        .tab-btn-extra { background: #f2f2f7; color: #333; border: 1px solid #d1d1d6; }
        .tab-btn-extra:hover { background: #e5e5ea; transform: translateY(-1px); }

        .fav-list-title { font-size: 0.85rem; color: #666; text-transform: uppercase; margin-bottom: 10px; font-weight: 800; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .fav-list { list-style: none; padding: 0; overflow-y: auto; flex: 1; padding-right: 5px; max-height: 400px; }
        .fav-list::-webkit-scrollbar { width: 6px; }
        .fav-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .fav-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        .fav-item { 
            display: flex; align-items: center; padding: 10px; 
            border-bottom: 1px solid #eee; cursor: pointer; border-radius: 8px; margin-bottom: 2px;
        }
        .fav-item:hover { background: #f5f5f7; }
        .fav-icon { width: 24px; height: 24px; margin-right: 12px; border-radius: 4px; object-fit: contain; padding: 2px; background: #fff; border: 1px solid #eee; }
        .fav-name { flex: 1; font-size: 0.95rem; font-weight: 600; color: #111; }
        
        .fav-actions { display: flex; gap: 8px; opacity: 0.3; transition: opacity 0.2s; }
        .fav-item:hover .fav-actions { opacity: 1; }
        .btn-fav-mini { padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 0.8rem; }
        .btn-fav-mini:hover { background: #eee; }
        .btn-fav-del { color: var(--danger); border-color: #ffcccc; background: #fff5f5; }
        .btn-fav-del:hover { background: #ff0000; color: white; }

    </style>
</head>
<body>

    <div id="mdc-header">
        <a href="#">MDC Polyglot - Dual Pro</a>
    </div>

    <div class="control-bar">
        <div class="control-left">
            <div class="compact-search">
                <span class="icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Search saved sessions..." oninput="applySearch()">
            </div>
        </div>
        <div class="control-right">
            <button class="btn-new-session" onclick="openDualView()">
                <span>+ New Dual Session</span>
            </button>
            <button class="btn-data-mini" onclick="if(confirm('Clear all saved data?')) { localStorage.removeItem(STORAGE_KEY); loadResources(); }">üóëÔ∏è</button>
        </div>
    </div>

    <div class="section-header"><span>üìö Library</span></div>
    <div class="grid-container" id="video-grid"></div>

    <div class="modal-overlay" id="dual-modal">
        <button class="floating-close" onclick="closeDualView()">√ó</button>
        
        <div class="editor-popup" id="popup-container">
            <div class="split-panel" id="panel-left"></div>
            
            <div class="resizer-gutter" id="drag-resizer"></div>
            
            <div class="split-panel" id="panel-right"></div>
        </div>
    </div>

    <div id="tab-settings-modal" class="tab-settings-modal" onclick="if(event.target===this) closeTabPopup()">
        <div class="tab-popup-content">
            <div class="tab-popup-header">
                <span id="tab-config-title">Configure URL</span>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="closeTabPopup()">√ó</span>
            </div>
            
            <div class="tab-input-group">
                <input type="text" id="tab-url-input" placeholder="https://... ‚û°Ô∏è Enter URL">
                
                <button class="tab-btn-action btn-paste" onclick="pasteToTabInput()" title="Paste">üìã</button>
                <button class="tab-btn-action tab-btn-extra" onclick="document.getElementById('tab-url-input').value = '';" title="Clear">‚ùå</button>
                <button class="tab-btn-action tab-btn-extra" onclick="copyTabUrlFromInput()" title="Copy">üîó</button>
                
                <button class="tab-btn-action tab-btn-go" onclick="applyTabUrlFromInput()">Load & Save</button>
            </div>

            <div class="fav-list-title">Presets & Favorites</div>
            <ul class="fav-list" id="tab-fav-list"></ul>
        </div>
    </div>

<script>
    /* ====== CONFIG & STATE ====== */
    const STORAGE_KEY = 'mdc_saved_dual_v33';
    const FAV_KEY = 'mdc_tab_favs_v33';
    const FIXED_TAB_5_URL = "https://paradisonetworx.com/LinguistDeckVocabulary.html";

    // Presets fijos
    const DEFAULT_FAVS = [
        { title: "üî§ Alphabet Deck", url: "https://paradisonetworx.com/LinguistDeckAlphabet.html" },
        { title: "üÜî Digraphs Deck", url: "https://paradisonetworx.com/LinguistDeckDigraphs.html" },
        { title: "üß† Vocabulary Deck", url: "https://paradisonetworx.com/LinguistDeckVocabulary.html" },
        { title: "üí™ Verbs Deck", url: "https://paradisonetworx.com/LinguistDeckVerb.html" }, 
        { title: "üéÆ Game Deck 1", url: "https://paradisonetworx.com/LinguistDeckGame.html" },
        { title: "‚ñ∂Ô∏è Player Studio", url: "https://paradisonetworx.com/LinguistDeckPlayer.html" }
    ];

    let currentResourceId = null;
    let editingSide = null; // 'left' or 'right'
    let editingIndex = 0;
    
    // Default structure (Empty tabs)
    const DEFAULT_TABS = ["", "", "", "", ""];

    document.addEventListener('DOMContentLoaded', () => {
        loadResources();
        initResizer();
    });

    /* ====== RESIZER LOGIC ====== */
    function initResizer() {
        const resizer = document.getElementById('drag-resizer');
        const leftSide = document.getElementById('panel-left');
        const container = document.getElementById('popup-container');
        let x = 0, leftWidth = 0;

        const mouseDownHandler = (e) => {
            x = e.clientX;
            leftWidth = leftSide.getBoundingClientRect().width;
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            container.style.userSelect = 'none';
            container.style.pointerEvents = 'none'; 
        };

        const mouseMoveHandler = (e) => {
            const dx = e.clientX - x;
            const newW = ((leftWidth + dx) / container.getBoundingClientRect().width) * 100;
            if(newW > 15 && newW < 85) leftSide.style.width = `${newW}%`;
        };

        const mouseUpHandler = () => {
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            container.style.pointerEvents = 'auto';
            container.style.userSelect = 'auto';
        };

        resizer.addEventListener('mousedown', mouseDownHandler);
    }

    /* ====== RESOURCE MANAGEMENT ====== */
    function openDualView(id = null) {
        let resource;
        
        if (id) {
            const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            resource = resources.find(r => r.id === id);
            currentResourceId = id;
        } else {
            const newId = Date.now().toString();
            resource = {
                id: newId,
                title: "New Session " + new Date().toLocaleTimeString(),
                leftTabs: ["", "", "", "", FIXED_TAB_5_URL], // Tab 5 default
                rightTabs: ["", "", "", "", ""]
            };
            const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            resources.unshift(resource);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));
            currentResourceId = newId;
            loadResources();
        }

        renderPanel('left', resource.leftTabs || DEFAULT_TABS);
        renderPanel('right', resource.rightTabs || DEFAULT_TABS);
        
        document.getElementById('dual-modal').classList.add('active');
    }

    function renderPanel(side, urls) {
        const container = document.getElementById(`panel-${side}`);
        
        // Generate Tabs HTML
        let navHtml = `<div class="web-tab-nav">`;
        urls.forEach((url, i) => {
            navHtml += `
                <button class="web-tab-btn channel-${i+1} ${i===0?'active-'+(i+1):''}" 
                        onclick="switchTab('${side}', ${i})" id="btn-${side}-${i}" title="${url}">
                    Tab ${i+1} 
                    <span class="tab-gear" onclick="openTabConfig('${side}', ${i}, event)">‚öôÔ∏è</span>
                </button>`;
        });
        navHtml += `</div>`;

        // Generate Content HTML
        let contentHtml = `<div class="web-content-area">`;
        urls.forEach((url, i) => {
            let inner = `<div class="web-error-bg"><span>Empty Tab ${i+1}<br><small>Click ‚öôÔ∏è to configure</small></span></div>`;
            if(url) {
                const ytId = getYouTubeID(url);
                if(ytId) {
                    inner = `<iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen style="width:100%;height:100%;border:none;"></iframe>`;
                } else {
                    inner = `<iframe src="${url}" allowfullscreen style="width:100%;height:100%;border:none;"></iframe>`;
                }
            }
            contentHtml += `<div class="web-frame-container ${i===0?'active':''}" id="content-${side}-${i}">${inner}</div>`;
        });
        contentHtml += `</div>`;

        container.innerHTML = navHtml + contentHtml;
    }

    function switchTab(side, index) {
        // Update Buttons
        const btns = document.querySelectorAll(`#panel-${side} .web-tab-btn`);
        btns.forEach((b, i) => {
            if (i === index) b.classList.add(`active-${i+1}`);
            else b.className = `web-tab-btn channel-${i+1}`;
        });

        // Update Content
        const frames = document.querySelectorAll(`#panel-${side} .web-frame-container`);
        frames.forEach((f, i) => {
            if (i === index) f.classList.add('active');
            else f.classList.remove('active');
        });
    }

    /* ====== CONFIG POPUP (LOGIC RESTORED) ====== */
    function openTabConfig(side, index, event) {
        event.stopPropagation();
        editingSide = side;
        editingIndex = index;
        
        // Update Title
        document.getElementById('tab-config-title').innerText = `Configure ${side.toUpperCase()} Panel - Tab ${index + 1}`;

        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const res = resources.find(r => r.id === currentResourceId);
        
        const urls = side === 'left' ? res.leftTabs : (res.rightTabs || DEFAULT_TABS);
        const currentUrl = urls[index] || "";
        
        document.getElementById('tab-url-input').value = currentUrl;
        
        renderTabFavorites();
        document.getElementById('tab-settings-modal').classList.add('active');
        document.getElementById('tab-url-input').focus();
    }

    async function pasteToTabInput() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('tab-url-input').value = text;
        } catch (err) { alert('Failed to paste: ' + err); }
    }

    function copyTabUrlFromInput() {
        const val = document.getElementById('tab-url-input').value;
        if(val) navigator.clipboard.writeText(val);
    }

    function applyTabUrlFromInput() {
        const url = document.getElementById('tab-url-input').value.trim();
        saveTabUrl(url);
    }

    function saveTabUrl(url) {
        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const resIndex = resources.findIndex(r => r.id === currentResourceId);
        
        if (resIndex > -1) {
            // Update Array
            if(editingSide === 'left') {
                if(!resources[resIndex].leftTabs) resources[resIndex].leftTabs = [...DEFAULT_TABS];
                resources[resIndex].leftTabs[editingIndex] = url;
            } else {
                if(!resources[resIndex].rightTabs) resources[resIndex].rightTabs = [...DEFAULT_TABS];
                resources[resIndex].rightTabs[editingIndex] = url;
            }
            
            // Auto Update Title if editing Tab 1 of Left side
            if(editingIndex === 0 && editingSide === 'left' && url) {
                resources[resIndex].title = (getDomain(url) || "Web") + " Session";
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));
            
            // Re-render only the affected panel & switch to tab
            renderPanel(editingSide, editingSide === 'left' ? resources[resIndex].leftTabs : resources[resIndex].rightTabs);
            switchTab(editingSide, editingIndex);
            
            // Check for Favorite addition
            if(url && url.includes('.') && !getTabFavorites().some(f => f.url === url)) {
                if(confirm("Add this URL to favorites for quick access?")) {
                    addTabFavorite(url);
                }
            }
            
            loadResources(); // Refresh Grid Titles
        }
        closeTabPopup();
    }

    /* ====== FAVORITES SYSTEM ====== */
    function getTabFavorites() {
        const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
        return [...DEFAULT_FAVS, ...saved];
    }

    function renderTabFavorites() {
        const list = document.getElementById('tab-fav-list');
        list.innerHTML = '';
        const favs = getTabFavorites();
        const fixedCount = DEFAULT_FAVS.length;

        favs.forEach((fav, idx) => {
            const isCustom = idx >= fixedCount;
            const delBtn = isCustom ? `<div class="btn-fav-mini btn-fav-del" onclick="deleteTabFavorite(${idx - fixedCount}, event)">‚úï</div>` : '';
            
            list.innerHTML += `
                <li class="fav-item" onclick="document.getElementById('tab-url-input').value = '${fav.url}'; applyTabUrlFromInput();">
                    <img src="https://www.google.com/s2/favicons?domain=${fav.url}&sz=64" class="fav-icon" onerror="this.src='about:blank'">
                    <span class="fav-name">${fav.title}</span>
                    <div class="fav-actions">
                        ${delBtn}
                    </div>
                </li>`;
        });
    }

    function addTabFavorite(url) {
        const name = prompt("Name for this favorite:", getDomain(url));
        if(name) {
            const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
            saved.push({ title: name, url: url });
            localStorage.setItem(FAV_KEY, JSON.stringify(saved));
        }
    }

    function deleteTabFavorite(index, e) {
        e.stopPropagation();
        if(confirm("Delete favorite?")) {
            const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
            saved.splice(index, 1);
            localStorage.setItem(FAV_KEY, JSON.stringify(saved));
            renderTabFavorites();
        }
    }

    function closeTabPopup() { document.getElementById('tab-settings-modal').classList.remove('active'); }
    function closeDualView() { 
        document.getElementById('dual-modal').classList.remove('active'); 
        document.getElementById('panel-left').innerHTML = "";
        document.getElementById('panel-right').innerHTML = "";
    }

    /* ====== GRID & HELPERS ====== */
    function loadResources() {
        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const grid = document.getElementById('video-grid');
        const query = document.getElementById('searchInput').value.toLowerCase();
        
        grid.innerHTML = "";
        
        resources.forEach(r => {
            if(query && !r.title.toLowerCase().includes(query)) return;
            
            let img = "";
            const mainUrl = (r.leftTabs && r.leftTabs[0]) ? r.leftTabs[0] : "";
            const ytId = getYouTubeID(mainUrl);
            
            if(ytId) img = `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;
            else if(mainUrl) img = `https://www.google.com/s2/favicons?domain=${mainUrl}&sz=128`;
            
            const mediaContent = ytId 
                ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover;">`
                : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f9f9fb;font-size:2rem;color:#ccc;">üåê</div>`;

            grid.innerHTML += `
                <div class="resource-card">
                    <div class="media-area" onclick="openDualView('${r.id}')">
                        ${mediaContent}
                        ${ytId ? '<div class="play-icon">‚ñ∂</div>' : ''}
                    </div>
                    <div class="card-info">
                        <div class="card-title">${r.title}</div>
                        <div class="card-actions">
                            <button class="btn-action" onclick="openDualView('${r.id}')">Open</button>
                            <button class="btn-action delete" onclick="deleteRes('${r.id}')">Delete</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    function deleteRes(id) {
        if(confirm("Delete this session?")) {
            let res = JSON.parse(localStorage.getItem(STORAGE_KEY));
            res = res.filter(r => r.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(res));
            loadResources();
        }
    }

    function getYouTubeID(url) { if (!url) return null; const match = (url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|live\/)([^#&?]*).*/) || [])[2]; return (match && match.length === 11) ? match : null; }
    function getDomain(url) { try { return new URL(url).hostname.replace('www.', ''); } catch(e) { return ''; } }

</script>
</body>
</html>
