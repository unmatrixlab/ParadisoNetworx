<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8"> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>LINGUA NEXUS | V7.2 VOICE COMMANDER PRO</title>

    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    

    <style>

        /* ==================== VARIABLES & RESET ==================== */

        :root {

            --bg-deep: #050505; --bg-card: #121214; --bg-hover: #1f1f22; --bg-input: #18181b;

            --txt-main: #f4f4f5; --txt-sec: #71717a; --border: #27272a;

            --c-noun: #0ea5e9; --c-adj: #d946ef; --c-reg: #22c55e; --c-irreg:#f59e0b; --c-func: #6366f1; 

            --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; --purple: #a855f7;

            --font-head: 'Bebas Neue', sans-serif; --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;

            --safe-bottom: env(safe-area-inset-bottom);

            --c-mixed: #334155;

        }

        :root.light-mode {

            --bg-deep: #f8fafc; --bg-card: #ffffff; --bg-hover: #f1f5f9; --bg-input: #e2e8f0;

            --txt-main: #0f172a; --txt-sec: #64748b; --border: #e2e8f0;

            --c-noun: #0284c7; --c-adj: #c026d3; --c-reg: #16a34a; --c-irreg:#d97706; --c-func: #4f46e5; --c-mixed: #334155;

        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

        body { 

            background-color: var(--bg-deep); color: var(--txt-main); font-family: var(--font-ui); 

            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 

            transition: background 0.3s, color 0.3s; 

        }



        /* HEADER */

        header { 

            height: 64px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; 

            padding: 0 24px; background: rgba(5,5,5,0.95); border-bottom: 1px solid var(--border); 

            z-index: 50; backdrop-filter: blur(10px); 

        }

        .brand-area { display: flex; align-items: center; gap: 10px; cursor: pointer; }

        .brand { font-family: var(--font-head); font-size: 26px; letter-spacing: 2px; color: var(--txt-main); text-shadow: 0 0 10px rgba(255,255,255,0.1); }

        .back-btn { display: none; color: var(--txt-sec); }

        body:not(.is-home) .back-btn { display: block; }

        body:not(.is-home) .brand { display: none; } 

        .header-actions { display: flex; gap: 20px; }

        .icon-btn { background: none; border: none; color: var(--txt-sec); cursor: pointer; padding: 0; transition: 0.2s; }

        .icon-btn.active { color: var(--primary); filter: drop-shadow(0 0 5px var(--primary)); transform: scale(1.1); }



        /* MAIN LAYOUT */

        main { flex: 1; position: relative; width: 100%; overflow: hidden; }

        .view-screen { display: none; flex-direction: column; width: 100%; height: 100%; padding: 20px; padding-bottom: calc(40px + var(--safe-bottom)); overflow-y: auto; -webkit-overflow-scrolling: touch; }

        .view-screen.active { display: flex; }

        #view-game { overflow: hidden; padding-bottom: calc(20px + var(--safe-bottom)); }



        /* HOME UI */

        .welcome-text { margin-bottom: 10px; text-align: center; margin-top: 10px; }

        .welcome-text h1 { font-family: var(--font-head); font-size: 52px; margin: 0; line-height: 0.9; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .global-progress { height: 6px; background: var(--bg-input); border-radius: 4px; overflow: hidden; margin: 15px 0 25px 0; width: 100%; border: 1px solid var(--border); }

        .global-progress-fill { height: 100%; background: linear-gradient(90deg, var(--c-noun), var(--primary), var(--success)); transition: width 1s ease; width: 0%; box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }

        .stat-pill { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }

        .stat-val { font-family: var(--font-code); font-weight: 700; font-size: 24px; display: block; }

        .stat-lbl { font-size: 10px; font-weight: 600; color: var(--txt-sec); text-transform: uppercase; margin-top: 4px; }

        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%; padding-bottom: 20px; }

        .menu-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }

        .menu-card:active { transform: scale(0.96); }

        .card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 15px; background: rgba(255,255,255,0.05); }

        .menu-card h3 { margin: 0; font-family: var(--font-head); font-size: 28px; line-height: 1; letter-spacing: 1px; }

        .menu-card span { font-size: 12px; color: var(--txt-sec); font-weight: 500; margin-top: 6px; display: block; }

        .menu-card[data-type="noun"] { border-color: rgba(14, 165, 233, 0.3); color: var(--c-noun); } 

        .menu-card[data-type="adj"] { border-color: rgba(217, 70, 239, 0.3); color: var(--c-adj); }

        .menu-card[data-type="reg"] { border-color: rgba(34, 197, 94, 0.3); color: var(--c-reg); }

        .menu-card[data-type="irreg"] { border-color: rgba(245, 158, 11, 0.3); color: var(--c-irreg); }

        .menu-card[data-type="func"] { border-color: rgba(99, 102, 241, 0.3); color: var(--c-func); }

        .menu-card[data-type="mixed"] { border-color: var(--border); color: #fff; }

        .menu-card[data-type="folder"] { border-color: rgba(251, 191, 36, 0.3); color: var(--gold); }

        .menu-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; border-style: dashed; }



        /* FOLDER & LISTS */

        .folder-grid { display: grid; gap: 10px; }

        .folder-item { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }

        .folder-item:active { transform: scale(0.98); background: var(--bg-hover); }

        .folder-info h4 { margin: 0; font-size: 18px; color: var(--txt-main); text-transform: uppercase; }

        .folder-info span { font-size: 12px; color: var(--txt-sec); font-weight: 600; }

        .folder-play { width: 40px; height: 40px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); }

        .folder-item.sys-all { border-color: var(--purple); background: linear-gradient(90deg, rgba(168, 85, 247, 0.05), transparent); } .folder-item.sys-all .folder-play { color: var(--purple); }

        .folder-item.sys-off { border-color: var(--c-noun); } .folder-item.sys-off .folder-play { color: var(--c-noun); }

        .folder-item.sys-imp { border-color: var(--gold); } .folder-item.sys-imp .folder-play { color: var(--gold); }



        /* SETTINGS */

        .section-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; flex-shrink: 0; }

        .section-head { font-family: var(--font-head); font-size: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; letter-spacing: 1px; }

        .row-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }

        .num-inp { background: var(--bg-input); border: 1px solid var(--border); color: var(--txt-main); border-radius: 8px; padding: 8px; width: 70px; text-align: center; font-family: var(--font-code); }

        .lib-search { width: 100%; background: var(--bg-card); border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: var(--txt-main); font-size: 16px; margin-bottom: 15px; flex-shrink: 0; }

        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; flex-shrink: 0; }

        .filter-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; flex: 1; min-width: 50px; text-align: center; }

        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 0 10px rgba(59,130,246,0.3); }

        .lib-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }

        .lib-content { padding: 15px; }

        .lib-en { font-weight: 700; font-size: 16px; color: var(--txt-main); text-transform: uppercase; } 

        .lib-es { font-size: 13px; color: var(--txt-sec); margin-top: 2px; text-transform: uppercase; } 

        .prog-track { width: 100%; height: 4px; background: var(--bg-input); }

        .prog-fill { height: 100%; width: 0%; }

        .lvl-1 .prog-fill { background: var(--danger); } .lvl-2 .prog-fill { background: var(--c-irreg); }

        .lvl-3 .prog-fill { background: var(--primary); } .lvl-4 .prog-fill { background: var(--success); }

        .lib-badge { position: absolute; right: 15px; top: 15px; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: var(--bg-input); color: var(--txt-sec); }

        .load-more-btn { width: 100%; padding: 15px; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-main); border-radius: 12px; margin-top: 10px; cursor: pointer; font-weight: 700; font-size: 12px; letter-spacing: 1px; flex-shrink: 0; }

        .banned-grid { display: grid; gap: 8px; max-height: 200px; overflow-y: auto; }

        .banned-item { display: flex; justify-content: space-between; align-items: center; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); padding: 10px 14px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: 0.2s; }

        .banned-item:hover { background: var(--danger); color: white; }

        .banned-item span { font-weight: 700; text-transform: uppercase; }

        .banned-icon { font-size: 12px; }



        /* QUEUE */

        .queue-grid { display: grid; gap: 8px; }

        .queue-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-deep); border: 1px solid var(--border); padding: 10px 14px; border-radius: 8px; font-size: 14px; }

        .queue-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

        .phase-badge { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; background: var(--danger); color: #fff; }

        .phase-badge.review { background: var(--success); }

        .batch-progress { height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden; margin-top: 8px; }

        .batch-progress-fill { height: 100%; background: var(--primary); transition: width 0.6s ease; width: 0%; }

        .scope-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: var(--bg-input); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); }

        .scope-label { font-size: 11px; font-weight: 700; color: var(--txt-sec); text-transform: uppercase; }

        .scope-reset { font-size: 10px; font-weight: 800; color: var(--primary); background: none; border: none; cursor: pointer; text-transform: uppercase; }



        /* RESUME */

        .resume-banner { background: linear-gradient(135deg, var(--success), #047857); color: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; text-align: center; font-weight: 800; letter-spacing: 1px; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); border: 1px solid #34d399; display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        .resume-banner:active { transform: scale(0.98); opacity: 0.9; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }



        /* GAME UI (COMPACTO) */

        .game-top-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; z-index: 60; position: relative; flex-shrink: 0; gap:5px; flex-wrap:wrap; }

        

        .cat-phase-group { 

            display: flex; 

            gap: 4px; 

            align-items: center; 

        }

        .stage-pill { 

            display: inline-flex; 

            padding: 4px 8px; 

            border-radius: 6px; 

            font-size: 10px; 

            font-weight: 700; 

            background: var(--bg-card); 

            border: 1px solid var(--border); 

            color: var(--txt-sec); 

            text-transform: uppercase; 

            letter-spacing: 0.5px; 

            white-space: nowrap; 

            max-width: 100px; 

            overflow: hidden;

            text-overflow: ellipsis;

        }

        .phase-pill { 

            font-size: 9px; 

            font-weight: 800; 

            padding: 4px 6px; 

            border-radius: 6px; 

            background: var(--danger); 

            color: #fff; 

            text-transform: uppercase; 

            border: 1px solid rgba(255,255,255,0.2); 

            transition: background 0.3s; 

            white-space: nowrap;

        }

        .phase-pill.review { background: var(--success); }



        .timer-badge { font-family: var(--font-code); font-size: 12px; color: var(--primary); background: rgba(59, 130, 246, 0.1); padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); margin-left: auto; font-weight: bold; }

        .audio-toggle-btn { background: var(--bg-card); border: 1px solid var(--border); width: 48px; height: 48px; border-radius: 12px; color: var(--txt-sec); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-right: 15px; }

        .audio-toggle-btn.active { background: var(--bg-input); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }

        .mini-chart { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }

        .chart-hole { width: 38px; height: 38px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; }

        #chart-pct { font-size: 10px; font-weight: 800; font-family: var(--font-code); color: var(--txt-main); }



        /* ARCADE */

        #mode-arcade { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; height: 100%; }

        #game-canvas-container { 

            flex: 1; position: relative; width: 100%; background: #050505; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; 

            box-shadow: inset 0 0 30px rgba(0,0,0,0.8); 

            transition: background 1.5s ease;

        }

        #game-canvas-container.learning { background: linear-gradient(to bottom, #1a0505, #050505); }

        #game-canvas-container.review { background: linear-gradient(to bottom, #050a1a, #050505); }

        canvas { display: block; width: 100%; height: 100%; }

        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; height: 180px; flex-shrink: 0; padding: 10px; position: relative; align-items: stretch; }

        

        .ban-btn-arcade { position: absolute !important; z-index: 999 !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; margin: 0 !important; width: 64px; height: 64px; border-radius: 50%; background: var(--bg-deep); border: 2px solid var(--danger); color: var(--danger); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 0 4px var(--bg-deep), 0 0 20px rgba(0,0,0,0.5); font-size: 24px; animation: jellyPulseCenter 1.5s infinite ease-in-out !important; }

        .ban-btn-arcade.is-banning { animation: none !important; background: var(--danger) !important; color: #fff !important; box-shadow: 0 0 30px var(--danger), inset 0 0 10px rgba(255,255,255,0.5) !important; transform: translate(-50%, -50%) scale(1.1) !important; border-color: #fff !important; }

        .ans-btn { position: relative; background: rgba(30, 30, 35, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--txt-main); padding: 12px; border-radius: 18px; font-size: 16px; font-weight: 700; letter-spacing: 0.5px; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); backdrop-filter: blur(10px); text-shadow: 0 2px 4px rgba(0,0,0,0.3); overflow: hidden; text-transform: uppercase; transition: background-color 0.4s ease, border-color 0.4s ease, transform 0.2s ease, box-shadow 0.4s ease; }

        .ans-btn:active { transform: scale(0.96); }

        .ans-btn.correct-flash { background-color: var(--success) !important; color: #fff !important; border-color: #34d399 !important; box-shadow: 0 0 20px rgba(16, 185, 129, 0.6) !important; z-index: 10; transform: scale(1.05); }

        .ans-btn.error-flash { background-color: var(--danger) !important; color: #fff !important; border-color: #f87171 !important; box-shadow: 0 0 20px rgba(239, 68, 68, 0.6) !important; animation: shake 0.4s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }



        /* TEXT MODE */

        #mode-text { flex: 1; display: none; flex-direction: column; width: 100%; height: 100%; overflow-y: auto; padding-top: 20px; }

        .word-stage { margin: 10px 0 30px 0; text-align: center; position: relative; }

        .main-word { font-size: clamp(36px, 10vw, 64px); font-weight: 800; line-height: 1; color: var(--txt-main); margin: 0; transition: color 0.3s; text-transform: uppercase; }

        .main-word.audio-active { color: var(--primary); cursor: pointer; }

        .input-list { display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px; }

        .input-group { position: relative; }

        .input-tag { position: absolute; top: 14px; left: 16px; font-size: 10px; font-weight: 700; color: var(--txt-sec); opacity: 0.7; pointer-events: none; text-transform: uppercase; }

        .smart-input { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px 16px 14px 16px; font-family: var(--font-code); font-size: 18px; color: var(--txt-main); text-transform: uppercase; }

        .smart-input:focus { border-color: var(--primary); background: var(--bg-hover); }

        .input-group.correct .smart-input { border-color: var(--success); color: var(--success); }

        .input-group.error .smart-input { border-color: var(--danger); color: var(--danger); }

        .input-ban-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 20px; cursor: pointer; z-index: 5; opacity: 0.7; transition: 0.2s; }

        .input-ban-btn:active { transform: translateY(-50%) scale(0.9); opacity: 1; }

        .action-btn { width: 100%; padding: 20px; border-radius: 16px; border: none; background: var(--bg-input); color: var(--txt-sec); font-family: var(--font-head); font-size: 24px; cursor: not-allowed; transition: 0.3s; margin-top: auto; }

        .action-btn.active { background: var(--primary); color: #fff; cursor: pointer; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); }

        .hint-btn { background: none; border: none; color: var(--primary); font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer; margin-top: 15px; display: inline-block; opacity: 0.8; }

        .hint-text { display: none; margin-top: 15px; font-size: 14px; color: var(--txt-sec); font-style: italic; line-height: 1.5; background: var(--bg-input); padding: 15px; border-radius: 12px; }

        .space-ray { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); opacity: 0; mix-blend-mode: screen; }

        @keyframes fireRay { 0% { opacity: 0; transform: scaleX(0); } 10% { opacity: 1; transform: scaleX(1); } 50% { opacity: 1; } 100% { opacity: 0; transform: scaleX(2); } }

        .ray-active { animation: fireRay 0.6s ease-out forwards; }



        /* ANIMATIONS */

        @keyframes jellyPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px currentColor, inset 0 0 5px currentColor; } 50% { transform: scale(1.08); box-shadow: 0 0 25px currentColor, inset 0 0 15px currentColor; } }

        @keyframes jellyPulseCenter { 0%, 100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 10px currentColor, inset 0 0 5px currentColor; } 50% { transform: translate(-50%, -50%) scale(1.08); box-shadow: 0 0 25px currentColor, inset 0 0 15px currentColor; } }

        .mini-chart { color: var(--primary); animation: jellyPulse 3s infinite ease-in-out; border: none; background: rgba(59, 130, 246, 0.1); }

        .chart-hole { box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }

        .ban-btn-arcade { color: var(--danger); border: none; background: rgba(239, 68, 68, 0.1); animation: jellyPulseCenter 1.5s infinite ease-in-out !important; }



        /* GAMIFICATION */

        .coin-wallet { display:flex; gap:10px; margin-left:15px; align-items:center; }

        .coin-slot { position: relative; width: 32px; height: 32px; perspective: 1000px; }

        .coin { width: 100%; height: 100%; border-radius: 50%; transform-style: preserve-3d; animation: spinCoin 4s infinite linear; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        .coin.silver { background: linear-gradient(135deg, #e2e8f0, #94a3b8); border: 2px solid #cbd5e1; color: #475569; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; font-family: var(--font-code); }

        .coin.gold { background: linear-gradient(135deg, #fcd34d, #d97706); border: 2px solid #fbbf24; color: #78350f; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; font-family: var(--font-code); animation-duration: 3s; }

        .coin-val { position:absolute; bottom:-12px; left:0; width:100%; text-align:center; font-size:10px; font-weight:800; color:var(--txt-sec); font-family:var(--font-code); }

        @keyframes spinCoin { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

        #reward-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; z-index: 2000; pointer-events: none; }

        .reward-msg { font-family: var(--font-head); font-size: 60px; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.5), 4px 4px 0 #000; transform: scale(0); animation: rewardPop 1.5s forwards; text-align: center; }

        .reward-sub { font-size: 20px; color: var(--gold); font-family: var(--font-code); background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 8px; margin-top: 10px; display: inline-block; }

        @keyframes rewardPop { 0% { transform: scale(0) rotate(-10deg); opacity: 0; } 20% { transform: scale(1.2) rotate(5deg); opacity: 1; } 40% { transform: scale(1) rotate(0deg); } 80% { transform: scale(1) translateY(0); opacity: 1; } 100% { transform: scale(1.5) translateY(-50px); opacity: 0; } }

        

        /* REST & OVERLAYS */

        .rest-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 5, 0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 1.1s ease; backdrop-filter: blur(5px); }

        .rest-overlay.active { opacity: 1; pointer-events: auto; }

        .rest-icon { font-size: 50px; margin-bottom: 10px; animation: breathe 3s infinite ease-in-out; }

        .rest-text { font-family: var(--font-head); font-size: 32px; color: var(--success); letter-spacing: 2px; }

        .rest-sub { font-family: var(--font-ui); font-size: 14px; color: var(--txt-sec); margin-top: 5px; }

        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } }



        /* MASTERED OVERLAY & EFFECTS */

        .mastered-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: var(--font-head); font-size: 60px; color: var(--gold); text-shadow: 0 0 30px var(--gold), 0 0 60px var(--gold); pointer-events: none; opacity: 0; z-index: 100; animation: masteredPop 2s ease-out forwards; }

        @keyframes masteredPop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -70%) scale(1); } }

        .phase-wave { position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; pointer-events: none; opacity: 0; animation: phaseWave 1.5s ease-out forwards; }

        @keyframes phaseWave { 0% { width: 0; height: 0; opacity: 0.8; } 100% { width: 2000px; height: 2000px; opacity: 0; transform: translate(-50%, -50%); } }

        

        /* EFECTO STAR WARS CRAWL */

        .sw-stage { 

            perspective: 400px; 

            height: 160px; 

            width: 100%; 

            overflow: hidden; 

            margin: 10px 0 20px 0; 

            position: relative; 

            mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%); 

            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);

        }

        .sw-content { 

            position: absolute; top: 100%; left: 0; width: 100%; text-align: center; 

            color: var(--gold); font-family: var(--font-head); font-size: 40px; 

            letter-spacing: 3px; line-height: 1.1;

            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);

            transform-origin: 50% 100%; 

        }

        @keyframes crawlAnimation {

            0% { top: 100%; transform: rotateX(25deg) translateZ(0) scale(1); opacity: 0; }

            15% { opacity: 1; }

            100% { top: -300%; transform: rotateX(25deg) translateZ(-500px) scale(0.8); opacity: 0; }

        }



        /* MIC INDICATOR */

        #mic-indicator {

            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);

            font-size: 16px; color: #fff; background: rgba(59, 130, 246, 0.9);

            padding: 8px 16px; border-radius: 20px; z-index: 90; pointer-events: none;

            opacity: 0; transition: opacity 0.3s; font-weight: 700; letter-spacing: 1px;

            box-shadow: 0 0 20px var(--primary);

            display: flex; align-items: center; gap: 8px;

        }

        .mic-dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: micPulse 1s infinite; }

        @keyframes micPulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }

    </style>

</head>

<body class="is-home">



    <script src="https://paradisonetworx.com/database.js"></script>



    <div id="text-space-ray" class="space-ray"></div>

    <div id="text-space-ray" class="space-ray"></div>

<div id="arcade-ban-ray" class="space-ray" style="background: linear-gradient(90deg, #ff0000, #990000, #000, #990000, #ff0000); mix-blend-mode: hard-light;"></div>

    <div id="reward-overlay">

        <div>

            <div id="reward-title" class="reward-msg">SESSION CLEAR!</div>

            <div style="text-align:center"><span id="reward-desc" class="reward-sub">+1 SILVER COIN</span></div>

        </div>

    </div>



    <div id="mastered-overlay" class="rest-overlay" style="z-index: 3000; background: rgba(5,5,5,0.95);">

        <div class="rest-icon" style="filter: drop-shadow(0 0 20px var(--gold));">üèÜ</div>

        <div class="rest-text" style="color: var(--gold); text-shadow: 0 0 30px rgba(251, 191, 36, 0.5); font-size:40px;">MASTERED!</div>

        

        <div class="sw-stage">

            <div id="sw-list" class="sw-content"></div>

        </div>

        

        <button id="btn-replay-folder" class="action-btn active" style="width: auto; padding: 15px 40px; background: var(--gold); color: #000; font-weight: 800; border: none; margin-bottom: 15px; box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);">

            ‚Ü∫ REPLAY & RESET

        </button>

        

       <button onclick="document.getElementById('mastered-overlay').classList.remove('active'); App.headerBack()" class="hint-btn" style="color: #fff; opacity: 0.5;">
    EXIT TO MENU
</button>

    </div>



    <header>

        <div class="brand-area" onclick="App.headerBack()">

            <svg class="back-btn" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path></svg>

            <div class="brand">LINGUA NEXUS</div>

        </div>

        <div class="header-actions">

            <button class="icon-btn" onclick="Profile.toggleTheme()">

                <svg id="theme-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>

            </button>

            <button id="btn-settings-nav" class="icon-btn" onclick="App.nav('settings')">

                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l-.06.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>

            </button>

        </div>

    </header>



    <main>

        <div id="view-home" class="view-screen active">

            <div class="welcome-text"><h1>TRAINING HUB</h1></div>

            <div class="global-progress"><div class="global-progress-fill" id="global-progress-fill"></div></div>

            <div id="home-resume-btn" class="resume-banner" onclick="App.resumeGame()" style="display:none; margin-bottom:20px; background:linear-gradient(135deg, var(--gold), #d97706); border-color:#fbbf24; text-shadow:0 1px 2px rgba(0,0,0,0.3);">‚èØ RESUME: <span id="resume-lbl">GAME</span></div>

            <div class="stats-row">

                <div class="stat-pill"><span class="stat-val" style="color:var(--success)" id="stat-m">0</span><span class="stat-lbl">Mastered</span></div>

                <div class="stat-pill"><span class="stat-val" style="color:var(--c-noun)" id="stat-t">0%</span><span class="stat-lbl">Global Mastery</span></div>

            </div>

            <div style="background:var(--bg-card); padding:15px; border-radius:16px; margin-bottom:20px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">

                <span style="font-size:12px; font-weight:700; color:var(--txt-sec); letter-spacing:1px;">YOUR LOOT</span>

                <div class="coin-wallet">

                    <div class="coin-slot"><div class="coin gold">G</div><div id="menu-coin-g" class="coin-val">0</div></div>

                    <div class="coin-slot"><div class="coin silver">S</div><div id="menu-coin-s" class="coin-val">0</div></div>

                </div>

            </div>

            <div class="grid-menu">

                <div class="menu-card" data-type="noun" onclick="App.start('nouns')"><div class="card-icon">N</div><div><h3>NOUNS</h3><span>Objects & Things</span></div></div>

                <div class="menu-card" data-type="adj" onclick="App.start('adjectives')"><div class="card-icon">A</div><div><h3>ADJECTIVES</h3><span>Descriptions</span></div></div>

                <div class="menu-card" data-type="reg" onclick="App.start('verbs_reg')"><div class="card-icon">R</div><div><h3>REGULAR</h3><span>Standard Verbs</span></div></div>

                <div class="menu-card" data-type="irreg" onclick="App.start('verbs_irreg')"><div class="card-icon">I</div><div><h3>IRREGULAR</h3><span>Complex Forms</span></div></div>

                <div class="menu-card" data-type="func" onclick="App.start('functionals')"><div class="card-icon">L</div><div><h3>LOGIC & SYNTAX</h3><span>Connectors & Structure</span></div></div>

                <div class="menu-card" data-type="folder" onclick="App.nav('folders')"><div class="card-icon" style="color:var(--gold)">F</div><div><h3>MY FOLDERS</h3><span>Custom Collections</span></div></div>

            </div>

        </div>



        <div id="view-folders" class="view-screen">

            <div class="section-box" style="border-color: var(--gold);">

                <div class="section-head" style="color: var(--gold);">SELECT A FOLDER</div>

                <div id="folder-list-container" class="folder-grid"></div>

            </div>

        </div>



        <div id="view-settings" class="view-screen">

            <div id="resume-banner" class="resume-banner" onclick="App.resumeGame()">‚ñ∂ RESUME SESSION</div>

            <div class="section-box" style="border-color: var(--c-noun);">

                <div class="section-head" style="color: var(--c-noun);">INTERACTION MODE</div>

                <div class="row-ctrl">

                    <span class="row-lbl">Play Style</span>

                    <select id="cfg-interaction" class="num-inp" style="width:220px; text-align:left;" onchange="Profile.saveCfg()">

                        <option value="arcade">ARCADE (Game & Physics)</option>

                        <option value="text">TEXT (Typing & Input)</option>

                    </select>

                </div>

            </div>

            <div class="section-box" style="border-color: var(--c-func);">

                <div class="section-head" style="color: var(--c-func);">ARCADE SETTINGS</div>

                <div class="row-ctrl">

                    <span class="row-lbl">Game Engine</span>

                    <select id="cfg-mode" class="num-inp" style="width:220px; text-align:left;" onchange="Profile.saveCfg()">

                        <option value="meteor">NEON FALL (Classic)</option>

                        <option value="bubble">ZERO GRAVITY (Float)</option>

                        <option value="orbit">ORBITAL DEFENSE (360¬∞)</option>

                        <option value="flower">FLOWER POWER (Falling)</option>

                        <option value="heart">HEART FLOAT (Rising)</option>

                        <option value="butterfly">BUTTERFLY RING (360¬∞)</option>

                    </select>

                </div>

                <div class="row-ctrl"><span class="row-lbl">Game Speed</span><select id="cfg-speed" class="num-inp" onchange="Profile.saveCfg()"><option value="1">Slow</option><option value="2">Normal</option><option value="3">Fast</option></select></div>

                <div class="row-ctrl"><span class="row-lbl">Voice Mode (Speak Answer)</span><select id="cfg-speaking" class="num-inp" onchange="Profile.saveCfg()"><option value="false">OFF</option><option value="true">ON</option></select></div>

                <div class="row-ctrl">

                    <span class="row-lbl">Voice Difficulty</span>

                    <select id="cfg-voice-diff" class="num-inp" style="width:120px;" onchange="Profile.saveCfg()">

                        <option value="relaxed">Relaxed</option>

                        <option value="normal">Normal</option>

                        <option value="strict">Strict</option>

                    </select>

                </div>

                <div class="row-ctrl"><span class="row-lbl">Brain Rest Mode üß†</span><select id="cfg-rest" class="num-inp" style="width:120px;" onchange="Profile.saveCfg()"><option value="false">OFF</option><option value="true">ON</option></select></div>

            </div>

            <div class="section-box">

                <div class="section-head">SESSION</div>

       <div class="row-ctrl">
    <span class="row-lbl">Words per Session (Reward Goal)</span>
    <input type="number" id="cfg-count" class="num-inp" value="10" min="4" onchange="Profile.saveCfg()">
</div>

<div class="row-ctrl">
    <span class="row-lbl">Time Limit (Min)</span>
    <input type="number" id="cfg-time" class="num-inp" value="0" min="0" onchange="Profile.saveCfg()">
</div>

            </div>

            <div class="section-box"><div class="section-head">DANGER ZONE</div><div class="row-ctrl"><span class="row-lbl" style="color:var(--danger)">Reset All Progress</span><button onclick="Profile.wipe()" style="background:var(--danger); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:bold;">WIPE</button></div></div>

            <div class="section-box" style="border-color: #666;"><div class="section-head" style="color:#aaa">GRAVEYARD (BANNED WORDS)</div><div id="banned-list-container" class="banned-grid"></div></div>

            <div class="section-box" style="border-color: var(--primary);"><div class="section-head" style="color:var(--primary)">UP NEXT IN QUEUE</div><div id="study-queue-list" class="queue-grid"></div></div>

            <div class="scope-bar"><span id="lib-scope-label" class="scope-label">SCOPE: FULL DATABASE</span><button id="btn-scope-reset" class="scope-reset" onclick="App.clearScope()">RESET TO ALL</button></div>

            <input type="text" id="inp-search" class="lib-search" placeholder="Search Database..." onkeyup="App.resetRender()">

            <div class="filter-bar"><button class="filter-btn active" onclick="App.setLibFilter('all', this)">ALL</button><button class="filter-btn" onclick="App.setLibFilter(0, this)">LVL 0</button><button class="filter-btn" onclick="App.setLibFilter(1, this)">LVL 1</button><button class="filter-btn" onclick="App.setLibFilter(2, this)">LVL 2</button><button class="filter-btn" onclick="App.setLibFilter(3, this)">LVL 3</button><button class="filter-btn" onclick="App.setLibFilter(4, this)">LVL 4</button></div>

            <div id="lib-list" style="padding-bottom:20px;"></div><button id="btn-load-more" class="load-more-btn" onclick="App.renderMore()">LOAD MORE...</button>

        </div>



        <div id="view-game" class="view-screen">

            <div class="game-top-bar">

                <div class="cat-phase-group">

                    <div class="stage-pill" id="game-cat-pill">CATEGORY</div>

                    <div class="phase-pill" id="game-phase-pill">LEARN</div>

                </div>

                <div class="coin-wallet" style="flex:1; justify-content:center; padding:0 5px;">

                    <div class="coin-slot"><div class="coin gold">G</div><div id="game-coin-g" class="coin-val">0</div></div>

                    <div class="coin-slot"><div class="coin silver">S</div><div id="game-coin-s" class="coin-val">0</div></div>

                </div>

                <div class="timer-badge" id="game-timer" style="display:none">00:00</div>

                <button id="btn-audio-mode" class="audio-toggle-btn active" onclick="App.toggleAudioMode()">

                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>

                </button>

                <div class="mini-chart" id="game-chart"><div class="chart-hole"><span id="chart-pct">0%</span></div></div>

            </div>

            

            <div id="mode-arcade">

                <div id="game-canvas-container">

                    <div id="mic-indicator"><div class="mic-dot"></div> SPEAK NOW</div>

                    <canvas id="game-canvas"></canvas>

                </div>

                <div class="answers-grid" id="control-dock"></div>

                <div id="brain-rest-layer" class="rest-overlay"><div class="rest-icon">üß†</div><div class="rest-text" id="rest-title">RELAX</div><div class="rest-sub" id="rest-msg">Breathe in...</div></div>

            </div>



            <div id="mode-text">

                <div class="word-stage"><h2 class="main-word" id="text-word" onclick="TextGame.replayAudio()">...</h2></div>

                <div class="input-list" id="text-inputs"></div>

                <button id="btn-text-action" class="action-btn" onclick="TextGame.checkOrNext()">CHECK ANSWER</button>

                <div style="text-align:center; margin-top:10px;">

                    <button id="btn-hint" class="hint-btn" onclick="TextGame.getHint()">üí° SHOW DEFINITION HINT</button>

                    <div id="hint-text" class="hint-text"></div>

                </div>

            </div>

        </div>

    </main>



<script>
/* ================================================================
   MODULE 1: DATABASE HANDLING
   ================================================================ */
/* ================================================================
   MODULE 1: DATABASE HANDLING (AUTO-SYNC VERSION)
   ================================================================ */
const DB = {
    data: {}, 
    customData: [],
    lastHash: "", // Variable para recordar la √∫ltima versi√≥n de los datos

    async init() {
        // 1. Carga inicial inmediata
        this.syncCustomData();

        // 2. ACTIVAR EL VIGILANTE (Revisa cada 1 segundo si hay cambios)
        setInterval(() => this.syncCustomData(), 1000);

        // 3. Listener instant√°neo (para cuando cambias de pesta√±a)
        window.addEventListener('storage', (e) => {
            if(e.key === 'mdc_vocab_list') this.syncCustomData();
        });
        window.addEventListener('focus', () => this.syncCustomData());

        // 4. Carga de datos internos (Diccionario base del sistema)
        return new Promise(r => {
            const t = setInterval(() => { 
                if (typeof INTERNAL_VOCAB !== 'undefined') { this.data = INTERNAL_VOCAB; clearInterval(t); r(); } 
                else if (document.readyState === 'complete') { this.data = {}; clearInterval(t); r(); }
            }, 50);
        });
    },

    // --- NUEVA FUNCI√ìN: Sincroniza y refresca la UI si es necesario ---
    syncCustomData() {
        const raw = localStorage.getItem('mdc_vocab_list') || '[]';
        
        // Solo actuamos si los datos han cambiado desde la √∫ltima vez
        if (raw !== this.lastHash) {
            this.lastHash = raw;
            try { 
                this.customData = JSON.parse(raw); 
                // Si el usuario est√° mirando la pantalla de carpetas, refrescarla autom√°ticamente
                if (typeof App !== 'undefined') {
                    const viewFolders = document.getElementById('view-folders');
                    if (viewFolders && viewFolders.classList.contains('active')) {
                        App.renderFolderList();
                    }
                }
            } catch(e) { this.customData = []; }
        }
    },

    clean(txt) { if (!txt) return ""; return String(txt).split('/')[0].trim(); },
    
    getFolderWords(folderId) {
        let words = [];
        if (folderId === 'sys_official') { Object.keys(this.data).forEach(k => words = words.concat(this.data[k].map(x => ({...x, en: this.clean(x.en), cat:'official'})))); return words; }
        
        if (folderId === 'sys_custom') { 
            const ext = (l) => l.forEach(i => { 
                if(i.isFolder && i.items) ext(i.items); 
                else if(i.eng || i.en) words.push({
                    en: this.clean(i.eng || i.en), 
                    es: (i.esp || i.es || "??"), 
                    cat: 'custom'
                }); 
            }); 
            ext(this.customData); return words; 
        }
        
        if (folderId === 'sys_everything') { return this.getFolderWords('sys_official').concat(this.getFolderWords('sys_custom')); }
        
        const find = (l) => { for(let i of l) { if(i.isFolder) { if(i.id === folderId) return i.items || []; const f = find(i.items || []); if(f) return f; } } return null; };
        const raw = find(this.customData); if(!raw) return [];
        
        const ext = (l) => l.forEach(i => { 
            if(i.isFolder && i.items) ext(i.items); 
            else if(i.eng || i.en) words.push({
                en: this.clean(i.eng || i.en), 
                es: (i.esp || i.es || "??"), 
                cat: 'custom'
            }); 
        });
        ext(raw); return words;
    },

    getFolderList() {
        let f = []; const ext = (l) => l.forEach(i => { 
            if(i.isFolder) { 
                let c = 0; 
                const count = (s) => s.forEach(x => { if(x.isFolder && x.items) count(x.items); else if(x.eng || x.en) c++; }); 
                if(i.items) count(i.items); 
                f.push({id:i.id, name:i.name, count:c}); 
                if(i.items) ext(i.items); 
            } 
        });
        ext(this.customData); return f;
    },
    get(cat) {
        const k = {nouns:'NOUNS', adjectives:'ADJECTIVES', verbs_reg:'REGULAR_VERBS', verbs_irreg:'IRREGULAR_VERBS', functionals:'FUNCTION WORDS'};
        if(cat === 'mixed') { let a = []; Object.keys(k).forEach(ky => { a = a.concat((this.data[k[ky]] || []).map(x => ({...x, en: this.clean(x.en), cat:ky}))); }); return a; }
        return (this.data[k[cat]] || []).map(x => ({...x, en: this.clean(x.en), cat}));
    },
    all(){ let a = []; Object.keys(this.data).forEach(k => a = a.concat(this.data[k].map(x => ({...x, en:this.clean(x.en)})))); return a; }
};

/* ================================================================
   MODULE 2: PROFILE & STATS
   ================================================================ */
const Profile = {
    cfg: { count: 10, time: 0, theme: 'dark', prog: {}, speed: 1, gameMode: 'meteor', interaction: 'arcade', restMode: 'true', speaking: 'false', voiceDiff: 'normal', banned: [], coins: { silver:0, gold:0 } },
    sessionMastery: 0, 
    load() {
        const s = localStorage.getItem('LN_V8_HYBRID'); if (s) this.cfg = { ...this.cfg, ...JSON.parse(s) };
        if(!this.cfg.banned) this.cfg.banned = []; if(!this.cfg.coins) this.cfg.coins = { silver:0, gold:0 }; 
        this.applyTheme();
        const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
        setVal('cfg-count', this.cfg.count); setVal('cfg-speed', this.cfg.speed || 1); setVal('cfg-time', this.cfg.time || 0);
        setVal('cfg-mode', this.cfg.gameMode || 'meteor'); setVal('cfg-interaction', this.cfg.interaction || 'arcade');
        setVal('cfg-rest', this.cfg.restMode || 'false'); setVal('cfg-speaking', this.cfg.speaking || 'false');
        setVal('cfg-voice-diff', this.cfg.voiceDiff || 'normal');
        this.calcStats(); App.updateCoinUI();
    },
    saveCfg() {
        // --- VALIDACI√ìN DE INPUTS (M√≠nimos y M√°ximos) ---
        let rawCount = parseInt(document.getElementById('cfg-count').value) || 10;
        if(rawCount < 4) rawCount = 4; // M√≠nimo 4 palabras para que funcione el juego
        this.cfg.count = rawCount;
        document.getElementById('cfg-count').value = rawCount; // Feedback visual

        let rawTime = parseInt(document.getElementById('cfg-time').value) || 0;
        if(rawTime < 0) rawTime = 0; // M√≠nimo 0 (Infinito)
        this.cfg.time = rawTime;
        document.getElementById('cfg-time').value = rawTime; // Feedback visual

        this.cfg.speed = parseInt(document.getElementById('cfg-speed').value) || 1;
        this.cfg.gameMode = document.getElementById('cfg-mode').value;
        this.cfg.interaction = document.getElementById('cfg-interaction').value;
        this.cfg.restMode = document.getElementById('cfg-rest').value;
        this.cfg.speaking = document.getElementById('cfg-speaking').value;
        this.cfg.voiceDiff = document.getElementById('cfg-voice-diff').value;
        
        this.save(); App.renderQueuePreview(); 
    },
    save() { localStorage.setItem('LN_V8_HYBRID', JSON.stringify(this.cfg)); },
    ban(w) { const key = DB.clean(w); if(!this.cfg.banned.includes(key)) this.cfg.banned.push(key); this.save(); },
    unban(w) { const key = DB.clean(w); this.cfg.banned = this.cfg.banned.filter(b => b !== key); this.save(); App.renderBannedList(); },
    isBanned(w) { return (this.cfg.banned || []).includes(DB.clean(w)); },
    getData(w) { const key = DB.clean(w); let v = this.cfg.prog[key]; if(v === undefined) return {lvl:0, date:0}; if(typeof v === 'number') return {lvl:v, date:0}; return { lvl: parseInt(v.lvl), date: v.date }; },
    setProg(w, ok) { const key = DB.clean(w); let e = this.getData(key), l = e.lvl; if(ok) { if(l < 4) l++; } else { l = Math.max(0, l - 1); } this.cfg.prog[key] = {lvl:l, date:Date.now()}; this.save(); this.calcStats(App.activeScope); return l; },
    resetWord(w) { 
        const key = DB.clean(w); 
        this.cfg.prog[key] = {lvl:0, date:Date.now()}; 
        this.save(); 
    },
    getLvl(w) { return this.getData(w).lvl; },
    addMasteryPoint() { this.sessionMastery++; const goal = this.cfg.count; if (this.sessionMastery > 0 && this.sessionMastery % goal === 0) { this.cfg.coins.silver++; if (this.cfg.coins.silver >= 5) { this.cfg.coins.silver -= 5; this.cfg.coins.gold++; this.save(); App.updateCoinUI(); return 'gold'; } else { this.save(); App.updateCoinUI(); return 'silver'; } } return null; },
    applyTheme() { const d = document.documentElement, i = document.getElementById('theme-icon'); if(this.cfg.theme === 'light') { d.classList.add('light-mode'); if(i) i.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>'; } else { d.classList.remove('light-mode'); if(i) i.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'; } },
    toggleTheme() { this.cfg.theme = this.cfg.theme === 'dark' ? 'light' : 'dark'; this.applyTheme(); this.save(); },
    wipe() { if(confirm("DANGER: This will delete ALL progress, coins, and banned words. Are you sure?")) { this.cfg.prog = {}; this.cfg.banned = []; this.cfg.coins = {silver:0,gold:0}; this.save(); App.clearScope(); App.nav('home'); } },
    calcStats(scopeList = null) { const sourceList = scopeList || (typeof DB !== 'undefined' ? DB.all() : []); const total = sourceList.length; if (total === 0) { if(document.getElementById('stat-m')) document.getElementById('stat-m').innerHTML = `0 <span style="font-size:12px; opacity:0.7">/ 0</span>`; if(document.getElementById('stat-t')) document.getElementById('stat-t').innerText = `0%`; return; } let masteredCount = 0; sourceList.forEach(w => { if (this.getLvl(w.en) === 4) masteredCount++; }); const globalPct = ((masteredCount / total) * 100).toFixed(1); if(document.getElementById('stat-m')) document.getElementById('stat-m').innerHTML = `${masteredCount} <span style="font-size:12px; opacity:0.7">/ ${total}</span>`; if(document.getElementById('stat-t')) document.getElementById('stat-t').innerText = `${globalPct}%`; }
};

/* ================================================================
   MODULE 3: BATCH & QUEUE SYSTEM
   ================================================================ */
const BatchManager = {
    currentBatch: [], phase: 'new',
    getBatch(fullPool) { const target = this.phase === 'new' ? 3 : 4; this.currentBatch = this.currentBatch.filter(w => { const l = Profile.getLvl(w.en); return l < target && !Profile.isBanned(w.en); }); if (this.currentBatch.length === 0) { this.cyclePhase(); this.fillBatch(fullPool); } return [...this.currentBatch]; },
    cyclePhase() { this.phase = (this.phase === 'new') ? 'review' : 'new'; },
    fillBatch(fullPool) { const batchSize = Profile.cfg.count || 10; let candidates = []; if (this.phase === 'new') { candidates = fullPool.filter(w => Profile.getLvl(w.en) < 3 && !Profile.isBanned(w.en)); candidates.sort((a,b) => Profile.getLvl(a.en) - Profile.getLvl(b.en)); } else { candidates = fullPool.filter(w => Profile.getLvl(w.en) === 3 && !Profile.isBanned(w.en)); } if (this.phase === 'review' && candidates.length === 0) { this.phase = 'new'; this.fillBatch(fullPool); return; } candidates.sort(() => Math.random() - 0.5); this.currentBatch = candidates.slice(0, batchSize); },
    reset() { this.currentBatch = []; this.phase = 'new'; }
};

/* ================================================================
   MODULE 4: APP CONTROLLER
   ================================================================ */
const App = {
    audioMode: true, activeScope: null, scopeName: null, pausedSession: null,
    async boot() { await DB.init(); Profile.load(); Profile.calcStats(); const saved = localStorage.getItem('LN_SAVED_SESSION'); if(saved) { try { this.pausedSession = JSON.parse(saved); } catch(e) { console.log("Error recovering session"); } } this.nav('home'); },
    updateCoinUI() { const s = Profile.cfg.coins.silver; const g = Profile.cfg.coins.gold; ['menu-coin-s', 'game-coin-s'].forEach(id => { const el = document.getElementById(id); if(el) el.innerText = s; }); ['menu-coin-g', 'game-coin-g'].forEach(id => { const el = document.getElementById(id); if(el) el.innerText = g; }); },
    
    saveStateToDisk() { 
        if(document.getElementById('view-game').classList.contains('active')) { 
            const isText = Profile.cfg.interaction === 'text'; 
            
            // Calculamos cu√°nto tiempo ha pasado realmente
            const currentElapsed = Date.now() - (isText ? TextGame.startTime : Game.startTime);

            const stateToSave = { 
                queue: isText ? TextGame.queue : Game.queue, 
                fullList: isText ? TextGame.fullList : Game.fullList, 
                idx: isText ? TextGame.idx : Game.idx, 
                cat: isText ? TextGame.cat : Game.category, 
                scopeName: this.scopeName, 
                isScopeActive: !!this.activeScope, 
                elapsed: currentElapsed, 
                active: true, 
                batchData: BatchManager.currentBatch, 
                batchPhase: BatchManager.phase 
            }; 
            localStorage.setItem('LN_SAVED_SESSION', JSON.stringify(stateToSave)); 
            this.pausedSession = stateToSave; 
        } 
    },
    
    headerBack() { if(document.getElementById('view-game').classList.contains('active')) { this.saveStateToDisk(); this.stopAll(); this.nav('home'); return; } if(document.getElementById('view-settings').classList.contains('active')) { this.nav('home'); return; } this.stopAll(); this.nav('home'); },
    nav(v) {
        if(document.getElementById('view-game').classList.contains('active') && v === 'settings') { this.saveStateToDisk(); this.stopAll(); } 
        document.querySelectorAll('.view-screen').forEach(e => e.classList.remove('active')); document.getElementById('view-' + v).classList.add('active'); document.body.className = (v === 'home') ? 'is-home' : '';
        if (v === 'settings') { document.getElementById('btn-settings-nav').classList.add('active'); this.setLibFilter('all', document.querySelector('.filter-bar .filter-btn')); this.renderQueuePreview(); this.renderBannedList(); this.updateScopeUI(); Profile.calcStats(this.activeScope); const resumeBtn = document.getElementById('resume-banner'); if(resumeBtn) resumeBtn.style.display = (this.pausedSession && this.pausedSession.active) ? 'block' : 'none'; } else { document.getElementById('btn-settings-nav').classList.remove('active'); }
        if (v === 'home') { Profile.calcStats(null); const mastered = parseInt((document.getElementById('stat-m').innerText || '0').match(/\d+/)?.[0] || 0); const total = DB.all().length || 1; const pct = (mastered / total) * 100; const fill = document.getElementById('global-progress-fill'); if(fill) fill.style.width = pct + '%'; const homeResume = document.getElementById('home-resume-btn'); const lbl = document.getElementById('resume-lbl'); if(this.pausedSession && this.pausedSession.active) { homeResume.style.display = 'block'; const displayLabel = this.pausedSession.scopeName || (this.pausedSession.cat === 'mixed' ? 'MIXED BAG' : this.pausedSession.cat); lbl.innerText = displayLabel.toUpperCase(); homeResume.style.animation = 'none'; homeResume.offsetHeight; homeResume.style.animation = 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; } else { homeResume.style.display = 'none'; } }
        if (v === 'folders') this.renderFolderList();
    },
    resumeGame() { if(!this.pausedSession || !this.pausedSession.active) return; const ps = this.pausedSession; if (ps.isScopeActive) { this.scopeName = ps.scopeName; } if(ps.batchData) BatchManager.currentBatch = ps.batchData; if(ps.batchPhase) BatchManager.phase = ps.batchPhase; this.prepGame(ps.queue, ps.cat, ps.scopeName || ps.cat, true); },
    stopAll() { Game.stop(); TextGame.stop(); },
    toggleAudioMode() { this.audioMode = !this.audioMode; const btn = document.getElementById('btn-audio-mode'); if(this.audioMode){ btn.classList.add('active'); btn.style.opacity='1'; if('speechSynthesis' in window) window.speechSynthesis.cancel(); } else { btn.classList.remove('active'); btn.style.opacity='0.5'; } if(Profile.cfg.interaction === 'text' && document.getElementById('view-game').classList.contains('active')) { TextGame.syncAudioState(); } },
    renderFolderList() { const c = document.getElementById('folder-list-container'); c.innerHTML = ''; const sys = [{id:'sys_everything',name:'ULTIMATE DATABASE (ALL)',class:'sys-all',count:'FULL'},{id:'sys_official',name:'OFFICIAL DB (FULL)',class:'sys-off',count:'INT'},{id:'sys_custom',name:'IMPORTED DB (FULL)',class:'sys-imp',count:'EXT'}]; sys.forEach(f => { const d = document.createElement('div'); d.className = `folder-item ${f.class}`; d.innerHTML = `<div class="folder-info"><h4>${f.name}</h4><span style="font-weight:800;opacity:0.7;">${f.count}</span></div><div class="folder-play"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>`; d.onclick = () => this.startFolder(f.id, f.name); c.appendChild(d); }); const folders = DB.getFolderList(); if(folders.length > 0) { const sep = document.createElement('div'); sep.style.cssText = "margin-top:15px; margin-bottom:5px; font-size:11px; font-weight:700; color:var(--txt-sec); text-transform:uppercase; letter-spacing:1px;"; sep.innerText = "YOUR COLLECTIONS"; c.appendChild(sep); folders.forEach(f => { const d = document.createElement('div'); d.className = 'folder-item'; d.innerHTML = `<div class="folder-info"><h4>${f.name}</h4><span>${f.count} Words</span></div><div class="folder-play"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>`; d.onclick = () => this.startFolder(f.id, f.name); c.appendChild(d); }); } },
    
    startFolder(fid, fname) { 
        const raw = DB.getFolderWords(fid); 
        if(raw.length === 0) return alert("Folder is empty!"); 
        
        const total = raw.length;
        const completedCount = raw.filter(w => Profile.getLvl(w.en) === 4 || Profile.isBanned(w.en)).length;

        if (total > 0 && total === completedCount) {
            this.showMasteredScreen(fid, fname, raw);
            return; 
        }

        this.activeScope = raw; 
        this.scopeName = fname; 
        Profile.calcStats(raw); 
        BatchManager.reset(); 
        this.prepGame(raw, 'custom', fname); 
    },

    showMasteredScreen(fid, fname, rawData) {
        const overlay = document.getElementById('mastered-overlay'); 
        const btn = document.getElementById('btn-replay-folder');     
        const listContainer = document.getElementById('sw-list'); 

        if (listContainer && rawData) {
            const wordsHTML = rawData.map(w => w.en.toUpperCase()).join('<br>');
            listContainer.innerHTML = `<div style="font-size:20px; color:#fff; margin-bottom:10px;">${fname}</div>` + wordsHTML;
            const duration = Math.max(5, rawData.length * 0.8); 
            listContainer.style.animation = 'none'; 
            listContainer.offsetHeight; 
            listContainer.style.animation = `crawlAnimation ${duration}s linear infinite`;
        }
        
        btn.onclick = () => {
            btn.innerText = "RESETTING..."; 
            setTimeout(() => {
                rawData.forEach(w => Profile.resetWord(w.en));
                overlay.classList.remove('active');
                btn.innerText = "‚Ü∫ REPLAY & RESET"; 
                this.activeScope = rawData; 
                this.scopeName = fname; 
                Profile.calcStats(rawData); 
                BatchManager.reset(); 
                this.prepGame(rawData, 'custom', fname); 
            }, 800);
        };
        overlay.classList.add('active');
    },

    start(cat) { const raw = DB.get(cat); this.activeScope = null; this.scopeName = null; BatchManager.reset(); this.prepGame(raw, cat, cat === 'mixed' ? "MIXED BAG" : cat.toUpperCase()); },
    getGameQueue(rawList) { return BatchManager.getBatch(rawList); },
    
    prepGame(rawOrQueue, catKey, title, isResume = false) {
        let queue, sorted;
        if(isResume) { queue = rawOrQueue; sorted = this.pausedSession.fullList; } else { localStorage.removeItem('LN_SAVED_SESSION'); this.pausedSession = null; queue = this.getGameQueue(rawOrQueue); sorted = rawOrQueue; if (queue.length === 0) return alert("No words available (Check banned list?)."); }
        if(!isResume) { Profile.sessionMastery = 0; }
        document.querySelectorAll('.view-screen').forEach(e => e.classList.remove('active')); document.getElementById('view-game').classList.add('active'); document.getElementById('btn-settings-nav').classList.remove('active');
        
        const pills = { nouns:'--c-noun', adjectives:'--c-adj', verbs_reg:'--c-reg', verbs_irreg:'--c-irreg', functionals:'--c-func', mixed:'--c-mixed', custom:'--gold' };
        const p = document.getElementById('game-cat-pill'); 
        const cVar = (catKey === 'custom' || !pills[catKey]) ? '--gold' : pills[catKey]; 
        let rawTitle = title || this.scopeName;
        p.innerText = rawTitle.length > 7 ? rawTitle.substring(0, 7) + ".." : rawTitle;
        p.style.color = `var(${cVar})`; 
        p.style.borderColor = `var(${cVar})`;

        const phasePill = document.getElementById('game-phase-pill'); 
        if(phasePill) {
            phasePill.style.display = 'inline-flex'; 
            phasePill.textContent = BatchManager.phase === 'new' ? 'LEARN' : 'REV'; 
            phasePill.className = BatchManager.phase === 'new' ? 'phase-pill' : 'phase-pill review'; 
        }

        if(Profile.cfg.interaction === 'text') { document.getElementById('mode-arcade').style.display = 'none'; document.getElementById('mode-text').style.display = 'flex'; TextGame.init(queue, catKey, sorted); if(isResume) TextGame.idx = this.pausedSession.idx; } else { document.getElementById('mode-arcade').style.display = 'flex'; document.getElementById('mode-text').style.display = 'none'; Game.init(queue, catKey, `var(${cVar})`, sorted); if(isResume) Game.idx = this.pausedSession.idx; setTimeout(() => Game.updatePhaseBackground(), 100); }
        this.updateChart(queue);
    },

    updateChart(sourceData) { const t = sourceData.length; const c = [0,0,0,0,0]; if (t === 0) return; sourceData.forEach(w => c[Profile.getLvl(w.en)]++); const p4 = c[4]/t*100, p3 = c[3]/t*100, p2 = c[2]/t*100, p1 = c[1]/t*100; const dom = document.getElementById('game-chart'); if (dom) { dom.style.background = `conic-gradient(var(--success) 0% ${p4}%, var(--primary) ${p4}% ${p4+p3}%, var(--c-irreg) ${p4+p3}% ${p4+p3+p2}%, var(--danger) ${p4+p3+p2}% ${p4+p3+p2+p1}%, var(--bg-input) ${p4+p3+p2+p1}% 100%)`; document.getElementById('chart-pct').innerText = Math.round(p4) + '%'; } },
    setLibFilter(lvl, btn) { this.filterLvl = lvl; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); this.resetRender(); },
    clearScope() { this.activeScope = null; this.scopeName = null; this.updateScopeUI(); Profile.calcStats(null); this.resetRender(); this.renderQueuePreview(); },
    updateScopeUI() { const lbl = document.getElementById('lib-scope-label'), btn = document.getElementById('btn-scope-reset'); if(this.activeScope) { lbl.innerText = `SCOPE: ${this.scopeName}`; lbl.style.color = 'var(--gold)'; btn.style.display = 'block'; } else { lbl.innerText = 'SCOPE: FULL DATABASE'; lbl.style.color = 'var(--txt-sec)'; btn.style.display = 'none'; } },
    resetRender() { this.renderCount = 50; this.calculateFilteredList(); this.renderLib(); },
    renderMore() { this.renderCount += 50; this.renderLib(); },
    calculateFilteredList() { const s = document.getElementById('inp-search').value.toLowerCase(); const src = this.activeScope || DB.all(); this.filteredResults = src.filter(x => { const m = !s || x.en.toLowerCase().includes(s); if(!m) return false; if(this.filterLvl === 'all') return true; return Profile.getLvl(x.en) === this.filterLvl; }); },
    renderLib() { const c = document.getElementById('lib-list'); c.innerHTML = ''; const btn = document.getElementById('btn-load-more'); if(this.filteredResults.length > this.renderCount) { btn.style.display = 'block'; btn.innerText = `LOAD MORE (${this.filteredResults.length - this.renderCount})`; } else { btn.style.display = 'none'; } const frag = document.createDocumentFragment(); this.filteredResults.slice(0, this.renderCount).forEach(w => { const l = Profile.getLvl(w.en), pct = l * 25, d = document.createElement('div'); d.className = `lib-card lvl-${l}`; d.innerHTML = `<div class="lib-content"><span class="lib-badge">LVL ${l}</span><div class="lib-en">${w.en.toUpperCase()}</div><div class="lib-es">${Array.isArray(w.es) ? w.es[0].toUpperCase() : w.es.toUpperCase()}</div></div><div class="prog-track"><div class="prog-fill" style="width:${pct}%"></div></div>`; frag.appendChild(d); }); c.appendChild(frag); },
    
    renderQueuePreview() {
        const con = document.getElementById('study-queue-list'); if(!con) return; con.innerHTML = '';
        let source = []; let labelText = ""; let colorStatus = ""; let showProgress = false; let completed = 0; let total = 0;
        
        if (BatchManager.currentBatch && BatchManager.currentBatch.length > 0) { 
            source = [...BatchManager.currentBatch]; 
            labelText = "üî• LIVE BATCH (CURRENTLY PLAYING)"; 
            colorStatus = "var(--primary)"; 
            showProgress = true; 
            const target = BatchManager.phase === 'new' ? 3 : 4; 
            completed = source.filter(w => Profile.getLvl(w.en) >= target).length; 
            total = source.length; 
        } 
        else { 
            let raw = this.activeScope ? [...this.activeScope] : DB.get('mixed'); 
            raw = raw.filter(w => !Profile.isBanned(w.en)); 
            let priority = raw.filter(w => Profile.getLvl(w.en) === 0); 
            if (priority.length < 5) priority = priority.concat(raw.filter(w => Profile.getLvl(w.en) > 0 && Profile.getLvl(w.en) < 4)); 
            if (priority.length < 5) priority = priority.concat(raw.filter(w => Profile.getLvl(w.en) === 4)); 
            
            // Usamos la configuraci√≥n del usuario con fallback a 10
            const userLimit = parseInt(Profile.cfg.count) || 10;
            source = priority.slice(0, userLimit); 
            
            labelText = "‚ö° UP NEXT (SMART PREDICTION)"; 
            colorStatus = "var(--gold)"; 
        }

        if(source.length === 0) { con.innerHTML = '<div style="text-align:center;padding:20px;color:var(--txt-sec)">No words available.</div>'; return; }
        const phaseText = BatchManager.phase === 'new' ? 'LEARNING PHASE' : 'REVIEW PHASE';
        con.innerHTML = `<div class="queue-header"><div style="font-size:11px; color:${colorStatus}; font-weight:800;">${labelText}</div><div class="phase-badge ${BatchManager.phase}">${phaseText}</div></div>${showProgress ? `<div style="font-size:12px; color:var(--txt-sec); margin-bottom:8px;">${completed}/${total} completed</div><div class="batch-progress"><div class="batch-progress-fill" style="width:${(completed/total)*100}%"></div></div>` : ''}`;
        source.forEach(w => { const l = Profile.getLvl(w.en); const meta = { 0: { c: 'var(--c-noun)', t: 'NEW' }, 1: { c: 'var(--danger)', t: 'LEARNING' }, 2: { c: 'var(--c-irreg)', t: 'HARD' }, 3: { c: 'var(--primary)', t: 'REVIEW' }, 4: { c: 'var(--success)', t: 'MASTER' } }[l] || { c: '#666', t: '?' }; const d = document.createElement('div'); d.className = 'queue-item'; const pct = l * 25; d.innerHTML = `<div style="flex:1"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:700; color:var(--txt-main); font-size:15px;">${w.en.toUpperCase()}</span><span style="font-size:10px; font-weight:800; background:${meta.c}; color:#fff; padding:2px 6px; border-radius:4px;">${meta.t}</span></div><div style="width:100%; height:3px; background:#333; margin-top:5px; border-radius:2px; overflow:hidden;"><div style="width:${pct}%; height:100%; background:${meta.c}; transition:width 0.3s;"></div></div></div>`; con.appendChild(d); });
    },
    renderBannedList() { const con = document.getElementById('banned-list-container'); if (!con) return; con.innerHTML = ''; const list = Profile.cfg.banned || []; if (list.length === 0) { con.innerHTML = '<div style="text-align:center;padding:10px;color:#666;font-size:12px;">The graveyard is empty.</div>'; return; } list.forEach(w => { const d = document.createElement('div'); d.className = 'banned-item'; d.innerHTML = `<span>${w.toUpperCase()}</span><span class="banned-icon">‚ôªÔ∏è RESTORE</span>`; d.onclick = () => { if(confirm(`Restore "${w}"?`)) Profile.unban(w); }; con.appendChild(d); }); }
};

/* ================================================================
   MODULE 5: ARCADE GAME ENGINE (VOICE COMMANDER PRO)
   ================================================================ */
const Game = {
    canvas:null, ctx:null, queue:[], pool:[], fullList:[], idx:0, width:0, height:0, loopId:null, lastTime:0, activeWord:null, particles:[], stars:[], laser:null, ghosts:[], shockwaves:[], clouds:[], score:0, startTime:0, timeLimit:0, themeColor:'#fff', flashIntensity:0, combo:0, gridOffset:0, showingGhost:false, category:'', timerId:null, isPlaying:false, mode: 'meteor', speedMult: 1, 
    banningPhase: false, banBeamColor: 0, wordsCleared: 0, isResting: false, speakingMode: false, recognition: null,

    init(queue, cat, colorVar, fullList) {
        this.queue = queue; this.category = cat; this.fullList = fullList;
        if (App.activeScope) { this.pool = App.activeScope; } 
        else { this.pool = (cat === 'custom' || cat === 'mixed') ? (this.fullList.length > 4 ? this.fullList : DB.all()) : DB.all(); }
        this.idx = 0; this.score = 0; this.ghosts = []; this.shockwaves = []; this.combo = 0; this.showingGhost = false; this.isPlaying = true; this.banningPhase = false;
        this.wordsCleared = 0; this.isResting = false; 
        this.speakingMode = Profile.cfg.speaking === 'true';
        this.canvas = document.getElementById('game-canvas'); this.ctx = this.canvas.getContext('2d'); this.resize();
        window.addEventListener('resize', () => this.resize());
        this.mode = Profile.cfg.gameMode; this.speedMult = Profile.cfg.speed === 1 ? 0.6 : (Profile.cfg.speed === 3 ? 1.5 : 1.0);
        
        this.timeLimit = Profile.cfg.time * 60 * 1000;
        if(App.pausedSession && App.pausedSession.elapsed) {
            this.startTime = Date.now() - App.pausedSession.elapsed;
        } else {
            this.startTime = Date.now();
        }
        
        const tD = document.createElement('div'); tD.style.color = colorVar; document.body.appendChild(tD); this.themeColor = getComputedStyle(tD).color; document.body.removeChild(tD);
        if(['flower', 'heart', 'butterfly'].includes(this.mode)) { const p = {'--c-noun':'#93c5fd', '--c-adj':'#f0abfc', '--c-reg':'#86efac', '--c-irreg':'#fcd34d', '--c-func':'#a5b4fc', '--primary':'#fda4af', '--gold':'#fcd34d'}; const v = colorVar.replace('var(', '').replace(')', ''); this.themeColor = p[v] || this.themeColor; }
        document.getElementById('game-timer').style.display = this.timeLimit > 0 ? 'block' : 'none';
        this.stars = []; for(let i = 0; i < 60; i++) this.stars.push({x:Math.random() * this.width, y:Math.random() * this.height, size:Math.random() * 2, speed:0.2 + Math.random() * 0.5});
        this.clouds = []; if(['flower', 'heart', 'butterfly'].includes(this.mode)) for(let i = 0; i < 5; i++) this.clouds.push({x:Math.random() * this.width, y:Math.random() * this.height, size:30 + Math.random() * 50, speed:0.1 + Math.random() * 0.1});
        this.spawn(); this.lastTime = performance.now(); this.loopId = requestAnimationFrame(t => this.loop(t));
        this.updatePhaseBackground();
    },
    resize() { const c = document.getElementById('game-canvas-container'); if(c) { this.canvas.width = c.offsetWidth; this.canvas.height = c.offsetHeight; this.width = this.canvas.width; this.height = this.canvas.height; } },
    stop() { 
        this.isPlaying = false; cancelAnimationFrame(this.loopId); clearTimeout(this.timerId); this.activeWord = null; 
        if (this.recognition) { this.recognition.stop(); this.recognition = null; }
        const mic = document.getElementById('mic-indicator'); if(mic) mic.style.opacity = '0';
    },
    updatePhaseBackground() {
        const container = document.getElementById('game-canvas-container'); if (!container) return;
        container.classList.remove('learning', 'review'); container.classList.add(BatchManager.phase === 'new' ? 'learning' : 'review');
        const wave = document.createElement('div'); wave.className = 'phase-wave';
        wave.style.background = BatchManager.phase === 'new' ? 'radial-gradient(circle, rgba(255,100,100,0.3) 0%, transparent 70%)' : 'radial-gradient(circle, rgba(100,255,100,0.3) 0%, transparent 70%)';
        container.appendChild(wave); setTimeout(() => wave.remove(), 1600);
    },
    spawn() {
        if(!this.isPlaying || this.showingGhost || this.banningPhase || this.isResting) return;
        if(this.idx >= this.queue.length) { this.idx = 0; this.queue = App.getGameQueue(this.fullList); App.updateChart(this.queue); this.updatePhaseBackground(); if(this.queue.length === 0) { alert("BATCH COMPLETED!"); this.stop(); App.nav('home'); return; } }
        const data = this.queue[this.idx];
        let displayWord;
        if (this.speakingMode) {
            displayWord = Array.isArray(data.es) ? data.es[0] : data.es; displayWord = DB.clean(displayWord).toUpperCase();
            this.startSpeechRecognition(data.en);
        } else { displayWord = DB.clean(data.en).toUpperCase(); }
        const size = 60; let x, y, vx, vy;
        if(this.mode === 'orbit' || this.mode === 'butterfly') { const a = Math.random() * Math.PI * 2, d = Math.max(this.width, this.height) / 2 + size + 20; x = (this.width / 2) + Math.cos(a) * d; y = (this.height / 2) + Math.sin(a) * d; const dx = (this.width / 2) - x, dy = (this.height / 2) - y, m = Math.hypot(dx, dy); vx = (dx / m) * 0.8 * this.speedMult; vy = (dy / m) * 0.8 * this.speedMult; }
        else { x = size + Math.random() * (this.width - size * 2); const fall = ['meteor', 'flower'].includes(this.mode); y = fall ? -60 : this.height + 60; vx = (Math.random() - 0.5) * 0.5; vy = fall ? (1 + Math.random()) * this.speedMult : (-1 - Math.random()) * this.speedMult; }
        this.activeWord = {data, displayWord, x, y, vx, vy, rot:0, rotSpeed:(Math.random() - 0.5) * 0.02, size, color:this.themeColor, trail:[], hasErrored: false};
        this.renderButtons(data);
    },
    
    getLevenshtein(a, b) {
        const matrix = [];
        for(let i=0; i<=b.length; i++) matrix[i] = [i];
        for(let j=0; j<=a.length; j++) matrix[0][j] = j;
        for(let i=1; i<=b.length; i++) {
            for(let j=1; j<=a.length; j++) {
                if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
                else matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1));
            }
        }
        return matrix[b.length][a.length];
    },

    startSpeechRecognition(correctAnswer) {
        if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) { console.log("Speech API missing"); return; }
        const mic = document.getElementById('mic-indicator'); if(mic) mic.style.opacity = '1';
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(this.recognition) this.recognition.abort();
        this.recognition = new SpeechRecognition();
        this.recognition.lang = 'en-US';
        this.recognition.interimResults = false;
        this.recognition.maxAlternatives = 1;

        this.recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.trim().toLowerCase();
            const correctLower = DB.clean(correctAnswer).toLowerCase();
            let isMatch = false;
            
            const diff = Profile.cfg.voiceDiff || 'normal';
            if (diff === 'strict') { isMatch = (transcript === correctLower); } 
            else if (diff === 'relaxed') { const dist = this.getLevenshtein(transcript, correctLower); isMatch = transcript.includes(correctLower) || dist <= 2; } 
            else { const regex = new RegExp("\\b" + correctLower + "\\b", "i"); isMatch = (transcript === correctLower || regex.test(transcript)); }

            if (isMatch) { this.fire({en: correctAnswer}, {en: correctAnswer}, null, true); } 
            else { console.log("Heard:", transcript, "Expected:", correctLower, "Diff:", diff); }
        };
        this.recognition.onend = () => { if(this.isPlaying && this.activeWord && this.speakingMode) this.recognition.start(); };
        try { this.recognition.start(); } catch(e) {}
    },
    renderButtons(cor) {
        const d = document.getElementById('control-dock'); d.innerHTML = ''; const banBtn = document.createElement('button'); banBtn.className = 'ban-btn-arcade'; banBtn.innerText = 'üíÄ'; banBtn.onclick = () => this.banActive(banBtn); d.appendChild(banBtn);
        let opts = [cor], i = 0;
        if(this.pool && this.pool.length > 0) { while(opts.length < 4 && i < 100) { const r = this.pool[Math.floor(Math.random() * this.pool.length)]; if(r && r.en && !opts.find(x => x.en === r.en)) opts.push(r); i++; } }
        while(opts.length < 4) opts.push(cor);
        opts.sort(() => Math.random() - 0.5);
        opts.forEach(o => { 
            const b = document.createElement('button'); b.className = 'ans-btn'; 
            let label = Array.isArray(o.es) ? o.es[0] : o.es;
            if (this.speakingMode) label = o.en; 
            label = DB.clean(label); b.innerText = label.toUpperCase(); b.onclick = () => this.fire(o, cor, b); d.appendChild(b); 
        });
    },
    banActive(btnElement) { 
        if(!this.activeWord || this.banningPhase) return; 
        
        // 1. Efecto Visual en el Bot√≥n
        if(btnElement) btnElement.classList.add('is-banning'); 
        
        // 2. DISPARAR EL RAYO DE LA MUERTE (NUEVO)
        const ray = document.getElementById('arcade-ban-ray');
        if(ray) {
            ray.classList.add('ray-active');
            setTimeout(() => ray.classList.remove('ray-active'), 600);
        }

        // 3. L√≥gica de Baneo
        const w = this.activeWord.data; 
        Profile.ban(w.en); 
        this.banningPhase = true; 
        
        setTimeout(() => { 
            const qIdx = this.queue.findIndex(qw => qw.en === w.en); 
            if(qIdx !== -1) this.queue.splice(qIdx, 1); 
            if(qIdx < this.idx) this.idx--; else if(qIdx === this.idx) this.idx--; 
            this.banningPhase = false; 
            this.activeWord = null; 
            this.idx++; 
            this.spawn(); 
        }, 800); 
    },
    spawnGhost(x, y, t) { if(!this.isPlaying || this.showingGhost) return; let gx = Math.max(50, Math.min(this.width - 50, x)), gy = Math.max(50, Math.min(this.height - 50, y)); this.ghosts.push({x:gx, y:gy, text:(Array.isArray(t) ? t[0] : t).toUpperCase(), life:1.0, vy:-0.5}); this.showingGhost = true; },
    showReward(type) { const overlay = document.getElementById('reward-overlay'); const title = document.getElementById('reward-title'); const desc = document.getElementById('reward-desc'); if (type === 'gold') { title.innerText = "RANK UP!"; title.style.color = "var(--gold)"; desc.innerText = "+1 GOLD COIN"; desc.style.color = "#000"; desc.style.background = "var(--gold)"; } else { title.innerText = "UNIT CLEAR!"; title.style.color = "#fff"; desc.innerText = "+1 SILVER COIN"; desc.style.color = "#fff"; desc.style.background = "rgba(0,0,0,0.8)"; } overlay.style.display = 'flex'; setTimeout(() => { overlay.style.display = 'none'; }, 1600); },
    showMasteredText() { const text = document.createElement('div'); text.className = 'mastered-text'; text.innerText = 'MASTERED!'; document.getElementById('game-canvas-container').appendChild(text); setTimeout(() => text.remove(), 2000); },
  fire(sel, cor, btn, automated = false) {
        if(!this.activeWord || this.banningPhase || (this.laser && !automated) || this.isFrozen) return;
        const targetWordRef = this.activeWord;
        let ox, oy;
        if (automated) { ox = this.width/2; oy = this.height; } else { const rect = btn.getBoundingClientRect(), cRect = this.canvas.getBoundingClientRect(); ox = (rect.left + rect.width / 2) - cRect.left; oy = this.height; }
        if(['orbit', 'butterfly'].includes(this.mode)) { ox = this.width / 2; oy = this.height / 2; }
        const fem = ['flower', 'heart', 'butterfly'].includes(this.mode); const isCorrect = sel.en === cor.en; let color, start, end;
        if (isCorrect) { color = fem ? '#86efac' : '#10b981'; start = { x: ox, y: oy }; end = { x: targetWordRef.x, y: targetWordRef.y }; if(btn) btn.classList.add('correct-flash'); } else { color = fem ? '#fda4af' : '#ef4444'; end = { x: ox, y: oy }; start = { x: targetWordRef.x, y: targetWordRef.y }; if(btn) btn.classList.add('error-flash'); }
        this.laser = {
            x1: start.x, y1: start.y, x2: end.x, y2: end.y, life: 1.0, color: color, time: 0, progress: 0, speed: 0.08, 
            onHit: () => {
                if(!this.activeWord || this.activeWord !== targetWordRef || !this.isPlaying) return;
                if(isCorrect) {
                    if(App.audioMode && !this.speakingMode) this.speak(cor.en);
                    this.shockwaves.push({x: this.activeWord.x, y: this.activeWord.y, radius: 10, alpha: 1.0, color: this.activeWord.color}); this.flashIntensity = 0.3; this.combo++; this.createExplosion(this.activeWord.x, this.activeWord.y, this.activeWord.color); this.wordsCleared++;
                    let isTriggerRest = false; let restDuration = 0; let restMsg = ""; let restTitle = "";
                    if (Profile.cfg.restMode === 'true') { if (this.wordsCleared % 20 === 0) { isTriggerRest = true; restDuration = 20000; restTitle = "DEEP REST"; restMsg = "Take a deep breath..."; } else if (this.wordsCleared % 5 === 0) { isTriggerRest = true; restDuration = 6000; restTitle = "NICE!"; restMsg = "Brief pause..."; } }
                    if (isTriggerRest) { this.isResting = true; const layer = document.getElementById('brain-rest-layer'); document.getElementById('rest-title').innerText = restTitle; document.getElementById('rest-msg').innerText = restMsg; layer.classList.add('active'); if(this.recognition) this.recognition.stop(); setTimeout(() => { layer.classList.remove('active'); this.isResting = false; this.activeWord = null; this.idx++; this.spawn(); }, restDuration); } else {
                        const newLvl = this.activeWord.hasErrored ? Profile.getLvl(cor.en) : Profile.setProg(cor.en, true); App.updateChart(this.queue); this.activeWord = null; this.idx++; 
                        
                        if(newLvl >= 4 && !this.activeWord?.hasErrored) { 
                            this.createExplosion(targetWordRef.x, targetWordRef.y, color, 3); 
                            this.createConfetti(targetWordRef.x, targetWordRef.y); 
                            this.showMasteredText(); 
                            const reward = Profile.addMasteryPoint(); 
                            if (reward) this.showReward(reward);
                            
                            const currentList = App.activeScope || Game.fullList;
                            const isFolderDone = currentList.every(w => Profile.getLvl(w.en) === 4 || Profile.isBanned(w.en));
                            
                            if (isFolderDone) {
                                this.isFrozen = true; 
                                App.showMasteredScreen(App.scopeName || Game.category, App.scopeName || Game.category, currentList);
                                return;
                            }
                        }
                        
                        if(!this.showingGhost) this.timerId = setTimeout(() => this.spawn(), 500);
                    }
                } else {
                    if (App.audioMode && this.speakingMode) this.speak(cor.en);
                    this.screenShake(); this.createExplosion(this.laser.x2, this.laser.y2, color); if(this.activeWord) this.spawnGhost(this.activeWord.x, this.activeWord.y, cor.es); this.combo = 0; if (!this.activeWord.hasErrored) { Profile.setProg(this.activeWord.data.en, false); this.activeWord.hasErrored = true; App.updateChart(this.queue); }
                }
            }
        };
    },
    fail() {
        if(App.audioMode) this.speak(this.activeWord.data.en);
        this.screenShake(); this.spawnGhost(this.activeWord.x, this.activeWord.y, this.activeWord.data.es); this.createExplosion(this.activeWord.x, this.activeWord.y, '#555'); if (!this.activeWord.hasErrored) { Profile.setProg(this.activeWord.data.en, false); App.updateChart(this.queue); } this.activeWord = null; this.idx++; this.combo = 0; if(!this.showingGhost) this.timerId = setTimeout(() => this.spawn(), 500);
    },
    createExplosion(x, y, c, mult = 1) { const count = 15 * mult; for(let i = 0; i < count; i++) { const a = Math.random() * Math.PI * 2; const s = (Math.random() * 2 + 1) * (mult > 1 ? 1.8 : 1.0); let pColor = c; if (mult > 1) { const r = Math.random(); if (r > 0.66) pColor = '#fbbf24'; else if (r > 0.33) pColor = '#ffffff'; } else if (c === '#555') { if (Math.random() > 0.7) pColor = '#7f1d1d'; } this.particles.push({ x, y, vx: Math.cos(a) * s, vy: Math.sin(a) * s, life: 1.0, color: pColor, size: (Math.random() * 4) * (mult > 1 ? 1.5 : 1) }); } },
    createConfetti(x, y) { for(let i = 0; i < 40; i++) { const angle = Math.random() * Math.PI * 2; const speed = 2 + Math.random() * 6; const color = ['#fbbf24', '#f59e0b', '#fcd34d', '#ffffff'][Math.floor(Math.random()*4)]; this.particles.push({ x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed - 2, life: 1.5, color, size: 5 + Math.random() * 4, gravity: 0.15, rotation: Math.random() * Math.PI * 2, rotSpeed: (Math.random() - 0.5) * 0.3, isConfetti: true }); } },
    speak(t) { if(!('speechSynthesis' in window)) return; if (window.speechSynthesis.paused) window.speechSynthesis.resume(); window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang = 'en-US'; u.rate = 1.0; u.volume = 1.0; window.utterances = window.utterances || []; window.utterances.push(u); u.onend = function() { window.utterances.shift(); }; setTimeout(() => { window.speechSynthesis.speak(u); }, 10); },
    screenShake() { const c = this.canvas; c.style.transform = `translate(${Math.random() * 10 - 5}px,${Math.random() * 10 - 5}px)`; setTimeout(() => c.style.transform = 'none', 200); },
    drawWebLaser(ctx, l) { const d = Math.hypot(l.x2 - l.x1, l.y2 - l.y1); const a = Math.atan2(l.y2 - l.y1, l.x2 - l.x1); if(l.life > 0.5) { ctx.shadowBlur = 15; ctx.shadowColor = l.color; } if(l.progress < 1) { l.progress += l.speed; if(l.progress > 1) l.progress = 1; } const ds = (w, o, f, m, lag) => { let currentDist = d * (l.progress * lag); if(currentDist > d) currentDist = d; ctx.beginPath(); ctx.strokeStyle = l.color; ctx.lineWidth = w; ctx.globalAlpha = l.life * o; for(let i = 0; i <= currentDist; i += 12) { const wb = Math.sin(i * 0.1 + l.time * 2) * 5 * l.life; const x = l.x1 + Math.cos(a) * i - Math.sin(a) * (Math.sin(i * (0.05 + f) + l.time) * (15 * l.life * m) + wb); const y = l.y1 + Math.sin(a) * i + Math.cos(a) * (Math.sin(i * (0.05 + f) + l.time) * (15 * l.life * m) + wb); if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.stroke(); }; ds(6, 0.6, 0, 1.0, 1.0); ds(3, 1.0, 0.02, 1.2, 0.85); ctx.globalAlpha = 1; ctx.shadowBlur = 0; l.time += 0.05; },
    drawGrid(ctx) { ctx.strokeStyle = "rgba(59,130,246,0.2)"; ctx.lineWidth = 1; const h = this.height * 0.4; this.gridOffset = (this.gridOffset + 2) % 40; for(let x = -this.width; x < this.width * 2; x += 80) { ctx.beginPath(); ctx.moveTo(x, this.height); ctx.lineTo(this.width / 2 + (x - this.width / 2) * 0.2, h); ctx.stroke(); } for(let z = 0; z < this.height; z += 40) { let y = (z + this.gridOffset) % this.height; if(y < h) continue; let py = h + Math.pow((y - h) / (this.height - h), 2) * (this.height - h); ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(this.width, py); ctx.stroke(); } const g = ctx.createLinearGradient(0, h, 0, this.height); g.addColorStop(0, "rgba(5,5,5,1)"); g.addColorStop(0.2, "rgba(5,5,5,0)"); ctx.fillStyle = g; ctx.fillRect(0, h, this.width, this.height - h); },
    drawBanBeam(ctx, target) { this.banBeamColor += 15; const hue = this.banBeamColor % 360; const color = `hsl(${hue}, 100%, 60%)`; let sx = this.width / 2; let sy = this.height + 40; if(this.mode === 'orbit' || this.mode === 'butterfly') { sx = this.width / 2; sy = this.height / 2; } const l = {x1:sx, y1:sy, x2:target.x, y2:target.y, life:1.0, color:color, time: Date.now()}; this.drawWebLaser(ctx, l); for(let i = 0; i < 2; i++) { this.particles.push({ x: target.x, y: target.y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1.0, color: color, size: Math.random() * 6 }); } },
    getWobbleR(baseR, angle, time) { return baseR + Math.sin(angle * 7 + time * 0.004) * (baseR * 0.06) + Math.cos(angle * 3 - time * 0.002) * (baseR * 0.1); },
    drawJelly(ctx, x, y, baseR, color, time, isFilled = false) { ctx.beginPath(); const steps = 30; for (let i = 0; i <= steps; i++) { const a = (Math.PI * 2 / steps) * i; const r = this.getWobbleR(baseR, a, time); const px = x + Math.cos(a) * r; const py = y + Math.sin(a) * r; if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py); } ctx.closePath(); ctx.shadowColor = color; ctx.shadowBlur = 15; if(isFilled) { ctx.fillStyle = color; ctx.fill(); } else { ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.stroke(); ctx.fillStyle = color.replace(')', ',0.15)').replace('rgb', 'rgba'); ctx.fill(); } ctx.shadowBlur = 0; },
    loop(now) {
        if(!this.isPlaying) return; const dt = (now - this.lastTime) / 16; this.lastTime = now;
        this.ctx.fillStyle = '#050505'; this.ctx.fillRect(0, 0, this.width, this.height);
        const fem = ['flower', 'heart', 'butterfly'].includes(this.mode); if(!fem) this.drawGrid(this.ctx); else { const g = this.ctx.createLinearGradient(0, 0, 0, this.height); g.addColorStop(0, "#0f172a"); g.addColorStop(1, "#1e1b4b"); this.ctx.fillStyle = g; this.ctx.fillRect(0, 0, this.width, this.height); this.clouds.forEach(c => { c.x += c.speed; if(c.x > this.width + 100) c.x = -100; this.ctx.fillStyle = "rgba(255,255,255,0.3)"; this.ctx.beginPath(); this.ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2); this.ctx.fill(); }); }
        if(!fem) this.stars.forEach(s => { s.y += s.speed; if(s.y > this.height) s.y = 0; this.ctx.globalAlpha = 0.3 + Math.random() * 0.5; this.ctx.beginPath(); this.ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); this.ctx.fillStyle = '#fff'; this.ctx.fill(); }); this.ctx.globalAlpha = 1;
        const cx = this.width / 2, cy = this.height / 2;
        if(['orbit', 'butterfly'].includes(this.mode)) { const centerColor = this.mode === 'butterfly' ? '#fcd34d' : '#3b82f6'; const centerSize = this.mode === 'butterfly' ? 40 : 35; this.drawJelly(this.ctx, cx, cy, centerSize, centerColor, now, true); }
        if(this.activeWord) {
            const w = this.activeWord; if(!this.banningPhase && !this.isResting) { w.x += w.vx * dt; w.y += w.vy * dt; w.rot += w.rotSpeed * dt; if(this.mode === 'meteor') { w.trail.push({x:w.x, y:w.y}); if(w.trail.length > 12) w.trail.shift(); this.ctx.globalCompositeOperation = 'lighter'; this.ctx.fillStyle = w.color; this.ctx.beginPath(); w.trail.forEach((p, i) => { this.ctx.moveTo(p.x, p.y); this.ctx.arc(p.x, p.y, w.size * (i / 20), 0, Math.PI * 2); }); this.ctx.globalAlpha = 0.4; this.ctx.fill(); this.ctx.globalCompositeOperation = 'source-over'; this.ctx.globalAlpha = 1; } let fail = false; if(['meteor', 'flower'].includes(this.mode) && w.y > this.height - 50) fail = true; else if(['bubble', 'heart'].includes(this.mode) && w.y < 50) fail = true; else if(['orbit', 'butterfly'].includes(this.mode)) { const distToCenter = Math.hypot(cx - w.x, cy - w.y); if(distToCenter < 40) fail = true; if(distToCenter > Math.max(this.width, this.height) + 150) fail = true; } if(fail) this.fail(); } else if (this.banningPhase) { w.x += (Math.random() - 0.5) * 5; w.y += (Math.random() - 0.5) * 5; this.drawBanBeam(this.ctx, w); }
            this.ctx.save(); this.ctx.translate(w.x, w.y); if(['orbit', 'butterfly'].includes(this.mode)) { const ang = Math.atan2(cy - w.y, cx - w.x); this.ctx.rotate(ang + Math.PI / 2); } else { this.ctx.rotate(w.rot); }
            if(this.mode !== 'bubble') { this.ctx.shadowBlur = 15; this.ctx.shadowColor = w.color; } if(fem) { this.ctx.fillStyle = w.color; } else { this.ctx.strokeStyle = w.color; this.ctx.lineWidth = 3; }
            this.ctx.beginPath(); if(this.mode === 'meteor') { for(let i = 0; i < 6; i++) this.ctx.lineTo(w.size * Math.cos(i * Math.PI / 3), w.size * Math.sin(i * Math.PI / 3)); this.ctx.closePath(); this.ctx.stroke(); this.ctx.fillStyle = "rgba(0,0,0,0.8)"; this.ctx.fill(); } else if(this.mode === 'bubble') { this.drawJelly(this.ctx, 0, 0, w.size, w.color, now, false); } else if(this.mode === 'orbit') { this.ctx.moveTo(0, 20); this.ctx.lineTo(-20, -20); this.ctx.lineTo(20, -20); this.ctx.closePath(); this.ctx.stroke(); this.ctx.fillStyle = "rgba(0,0,0,0.8)"; this.ctx.fill(); } else if(this.mode === 'flower') { const p = w.size / 2.5; for(let i = 0; i < 5; i++) { this.ctx.beginPath(); this.ctx.ellipse(Math.cos(i * 2 * Math.PI / 5) * p, Math.sin(i * 2 * Math.PI / 5) * p, p, p / 2, i * 2 * Math.PI / 5, 0, 2 * Math.PI); this.ctx.fill(); } this.ctx.beginPath(); this.ctx.arc(0, 0, w.size / 4, 0, Math.PI * 2); this.ctx.fillStyle = '#fffbea'; this.ctx.fill(); } else if(this.mode === 'heart') { const size = w.size; const h = size * 0.3; this.ctx.moveTo(0, h); this.ctx.bezierCurveTo(0, 0, -size / 2, 0, -size / 2, h); this.ctx.bezierCurveTo(-size / 2, (size + h) / 2, 0, (size + h) / 2, 0, size); this.ctx.bezierCurveTo(0, (size + h) / 2, size / 2, (size + h) / 2, size / 2, h); this.ctx.bezierCurveTo(size / 2, 0, 0, 0, 0, h); this.ctx.fill(); } else if(this.mode === 'butterfly') { const size = w.size, flap = Math.abs(Math.sin(Date.now() * 0.0025)); this.ctx.beginPath(); this.ctx.ellipse(-size / 3, -size / 4, size / 2 * flap, size / 3, -Math.PI / 4, 0, Math.PI * 2); this.ctx.fill(); this.ctx.beginPath(); this.ctx.ellipse(-size / 3, size / 4, size / 2.5 * flap, size / 4, Math.PI / 4, 0, Math.PI * 2); this.ctx.fill(); this.ctx.beginPath(); this.ctx.ellipse(size / 3, -size / 4, size / 2 * flap, size / 3, Math.PI / 4, 0, Math.PI * 2); this.ctx.fill(); this.ctx.beginPath(); this.ctx.ellipse(size / 3, size / 4, size / 2.5 * flap, size / 4, -Math.PI / 4, 0, Math.PI * 2); this.ctx.fill(); this.ctx.fillStyle = "#fff"; this.ctx.beginPath(); this.ctx.ellipse(0, 0, size / 8, size / 2, 0, 0, Math.PI * 2); this.ctx.fill(); }
            this.ctx.restore();
            const currentLvl = Profile.getLvl(w.data.en); const dots = 4; const dotSize = 3; const spacing = 10; const startX = w.x - ((dots - 1) * spacing) / 2; for(let i = 0; i < dots; i++) { this.ctx.beginPath(); this.ctx.arc(startX + (i * spacing), w.y + 25, dotSize, 0, Math.PI * 2); if (i < currentLvl) { this.ctx.fillStyle = this.themeColor; this.ctx.fill(); } else { this.ctx.strokeStyle = "rgba(255,255,255,0.3)"; this.ctx.lineWidth = 1; this.ctx.stroke(); } }
            this.ctx.font = "bold 26px 'Bebas Neue'"; this.ctx.textAlign = "center"; this.ctx.textBaseline = "middle"; this.ctx.shadowBlur = 0; this.ctx.lineWidth = 4; this.ctx.strokeStyle = "rgba(0,0,0,0.8)"; this.ctx.strokeText(w.displayWord.toUpperCase(), w.x, w.y); this.ctx.fillStyle = "#fff"; this.ctx.fillText(w.displayWord.toUpperCase(), w.x, w.y);
        }
        if(this.laser) { this.ctx.globalCompositeOperation = 'lighter'; this.drawWebLaser(this.ctx, this.laser); if (this.laser.progress >= 1) { if (this.laser.onHit) this.laser.onHit(); this.laser = null; } else { this.laser.life -= 0.005; } this.ctx.globalCompositeOperation = 'source-over'; }
        if(this.particles.length > 0) { this.ctx.globalCompositeOperation = 'lighter'; for(let i = this.particles.length - 1; i >= 0; i--) { let p = this.particles[i]; p.x += p.vx; p.y += p.vy; if(p.gravity) { p.vy += p.gravity; } else if(!['orbit', 'butterfly'].includes(this.mode)) { p.vy += 0.05; } if(p.rotSpeed) p.rotation += p.rotSpeed; p.life -= 0.008; if(p.life <= 0) this.particles.splice(i, 1); else { this.ctx.globalAlpha = p.life; this.ctx.fillStyle = p.color; if(p.isConfetti) { this.ctx.save(); this.ctx.translate(p.x, p.y); this.ctx.rotate(p.rotation); this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size); this.ctx.restore(); } else { this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); this.ctx.fill(); } } } this.ctx.globalCompositeOperation = 'source-over'; this.ctx.globalAlpha = 1; }
        for(let i = this.shockwaves.length - 1; i >= 0; i--) { let s = this.shockwaves[i]; s.radius += 3; s.alpha -= 0.02; if(s.alpha <= 0) this.shockwaves.splice(i, 1); else { this.ctx.strokeStyle = s.color; this.ctx.lineWidth = 3; this.ctx.globalAlpha = s.alpha; this.ctx.beginPath(); this.ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2); this.ctx.stroke(); } }
        if(this.flashIntensity > 0) { this.ctx.fillStyle = this.themeColor; this.ctx.globalAlpha = this.flashIntensity; this.ctx.fillRect(0, 0, this.width, this.height); this.ctx.globalAlpha = 1; this.flashIntensity -= 0.02; }
        for(let i = this.ghosts.length - 1; i >= 0; i--) { let g = this.ghosts[i]; g.y += g.vy; g.life -= 0.003; if(g.life <= 0) { this.ghosts.splice(i, 1); this.showingGhost = false; if(!this.activeWord) this.spawn(); } else { this.ctx.save(); let s = 1 + (1 - g.life) * 0.3; this.ctx.translate(g.x, g.y); this.ctx.scale(s, s); this.ctx.translate(-g.x, -g.y); this.ctx.globalAlpha = Math.max(0, g.life); this.ctx.font = "bold 24px 'Inter'"; this.ctx.textAlign = "center"; this.ctx.lineWidth = 3; this.ctx.strokeStyle = "#000"; this.ctx.strokeText(g.text, g.x, g.y); this.ctx.fillStyle = "#fbbf24"; this.ctx.fillText(g.text, g.x, g.y); this.ctx.restore(); } }
        this.ctx.globalAlpha = 1;
        if(this.combo > 1) { this.ctx.font = "italic 900 30px 'Bebas Neue'"; this.ctx.fillStyle = "#fff"; this.ctx.strokeStyle = "#000"; this.ctx.lineWidth = 4; this.ctx.strokeText(`x${this.combo} COMBO!`, this.width - 70, 40); this.ctx.fillText(`x${this.combo} COMBO!`, this.width - 70, 40); }
        if(this.timeLimit > 0) { const l = this.timeLimit - (Date.now() - this.startTime); if(l <= 0) { this.stop(); alert("TIME'S UP!"); App.nav('home'); return; } else { const m = Math.floor(l / 60000), s = Math.floor((l % 60000) / 1000); document.getElementById('game-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; } }
        this.loopId = requestAnimationFrame(t => this.loop(t));
    }
};

const TextGame = {
    queue: [], fullList: [], idx: 0, startTime: 0, timeLimit: 0, fail: false, isPlaying: false, cat: '', nextTimer: null,
    init(queue, cat, fullList) { 
        this.queue = queue; this.cat = cat; this.fullList = fullList; this.idx = 0; 
        this.timeLimit = Profile.cfg.time * 60 * 1000; 
        
        if(App.pausedSession && App.pausedSession.elapsed) {
            this.startTime = Date.now() - App.pausedSession.elapsed;
        } else {
            this.startTime = Date.now();
        }
        
        this.isPlaying = true; document.getElementById('game-timer').style.display = this.timeLimit > 0 ? 'block' : 'none'; this.play(); this.checkTimer(); 
    },
    stop() { this.isPlaying = false; clearTimeout(this.nextTimer); },
    checkTimer() { if(!this.isPlaying) return; if(this.timeLimit > 0) { const l = this.timeLimit - (Date.now() - this.startTime); if(l <= 0) { alert("Time's Up!"); App.nav('home'); return; } const m = Math.floor(l / 60000); const s = Math.floor((l % 60000) / 1000); document.getElementById('game-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; requestAnimationFrame(() => this.checkTimer()); } },
    syncAudioState() { if(!this.isPlaying) return; const wEl = document.getElementById('text-word'); const curr = this.queue[this.idx]; if(App.audioMode) { wEl.innerHTML = '<span style="font-size:40px">üîä</span><div style="font-size:14px; opacity:0.5; margin-top:5px">LISTEN & TYPE</div>'; wEl.classList.add('audio-active'); this.speak(curr); } else { wEl.innerText = Array.isArray(curr.es) ? curr.es[0].toUpperCase() : curr.es.toUpperCase(); wEl.classList.remove('audio-active'); } },
    speak(w) { Game.speak(w.en); }, replayAudio() { if(App.audioMode) this.speak(this.queue[this.idx]); },
    banActive() { const w = this.queue[this.idx]; Profile.ban(w.en); const ray = document.getElementById('text-space-ray'); ray.classList.add('ray-active'); setTimeout(() => { ray.classList.remove('ray-active'); const removeIdx = this.queue.findIndex(qw => qw.en === w.en); if (removeIdx !== -1) { this.queue.splice(removeIdx, 1); const cand = this.fullList.filter(fw => !this.queue.find(qw => qw.en === fw.en) && !Profile.isBanned(fw.en)); if (cand.length > 0) this.queue.push(cand[0]); this.idx--; } this.idx++; this.play(); }, 600); },
    play() { 
        if (this.idx >= this.queue.length) { 
            this.idx = 0; 
            this.queue = App.getGameQueue(this.fullList);
            if (this.queue.length === 0) { localStorage.removeItem('LN_SAVED_SESSION'); alert("Session Complete!"); App.nav('home'); return; } 
        }
        clearTimeout(this.nextTimer); document.getElementById('hint-text').style.display = 'none'; document.getElementById('hint-text').innerText = ''; document.getElementById('btn-hint').innerText = 'üí° SHOW DEFINITION HINT'; document.getElementById('btn-hint').style.display = 'inline-block'; const curr = this.queue[this.idx]; this.fail = false; this.syncAudioState(); const con = document.getElementById('text-inputs'); con.innerHTML = ''; const btn = document.getElementById('btn-text-action'); btn.innerText = "CHECK"; btn.classList.remove('active'); btn.onclick = () => this.validate(); if (curr.cat.includes('verbs') && (this.cat !== 'custom')) { this.mkInp(con, 'Base', curr.en, true); this.mkInp(con, 'Past', curr.past, false); this.mkInp(con, 'Participle', curr.part, false); } else { this.mkInp(con, 'English', curr.en, true); } setTimeout(() => { const i = con.querySelector('input'); if(i) i.focus(); }, 100); 
    },
    mkInp(p, lbl, ans, isFirst) { const d = document.createElement('div'); d.className = 'input-group'; let btnHtml = isFirst ? `<button class="input-ban-btn" onclick="TextGame.banActive()">üíÄ</button>` : ''; d.innerHTML = `<span class="input-tag">${lbl}</span><input class="smart-input" data-ans="${ans}" autocomplete="off">${btnHtml}`; const i = d.querySelector('input'); i.oninput = () => { const all = [...document.querySelectorAll('.smart-input')]; const ready = all.every(x => x.value.trim().length > 0); const btn = document.getElementById('btn-text-action'); if(ready) btn.classList.add('active'); else btn.classList.remove('active'); }; i.onkeydown = (e) => { if(e.key === 'Enter') { const all = [...document.querySelectorAll('.smart-input')]; const ix = all.indexOf(e.target); if(ix < all.length - 1) all[ix+1].focus(); else if(document.getElementById('btn-text-action').classList.contains('active')) this.validate(); } }; p.appendChild(d); },
    validate() { const inps = document.querySelectorAll('.smart-input'); let pass = true; inps.forEach(i => { const row = i.parentElement; row.classList.remove('error', 'correct'); if(i.value.trim().toLowerCase() !== i.dataset.ans.toLowerCase()) { pass = false; row.classList.add('error'); i.value = ''; i.placeholder = i.dataset.ans.toUpperCase(); } else { row.classList.add('correct'); } }); const w = this.queue[this.idx]; if(!pass) { this.fail = true; Profile.setProg(w.en, false); App.updateChart(this.queue); } else { const newLvl = this.fail ? Profile.getLvl(w.en) : Profile.setProg(w.en, true); if(!App.audioMode) this.speak(w); if (newLvl === 4 && !this.fail) { const removeIdx = this.queue.findIndex(qw => qw.en === w.en); if (removeIdx !== -1) { this.queue.splice(removeIdx, 1); const cand = this.fullList.filter(fw => !this.queue.find(qw => qw.en === fw.en) && !Profile.isBanned(fw.en)); if (cand.length > 0) this.queue.push(cand[0]); this.idx--; } } const btn = document.getElementById('btn-text-action'); btn.innerText = "NEXT"; btn.onclick = () => { clearTimeout(this.nextTimer); this.idx++; this.play(); }; App.updateChart(this.queue); this.nextTimer = setTimeout(() => { this.idx++; this.play(); }, 1200); } },
    checkOrNext() { const btn = document.getElementById('btn-text-action'); if(btn.innerText === "NEXT") { clearTimeout(this.nextTimer); this.idx++; this.play(); } else { this.validate(); } },
    async getHint() { const btn = document.getElementById('btn-hint'), txt = document.getElementById('hint-text'), w = this.queue[this.idx].en; btn.innerText = "SEARCHING..."; try { const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`); const data = await res.json(); if(data && data[0] && data[0].meanings && data[0].meanings[0].definitions) { txt.innerText = '"' + data[0].meanings[0].definitions[0].definition + '"'; txt.style.display = 'block'; btn.style.display = 'none'; } else { btn.innerText = "NO DEFINITION FOUND"; } } catch(e) { btn.innerText = "OFFLINE / ERROR"; } }
};

window.onload = () => App.boot();
window.addEventListener("beforeunload", () => { App.saveStateToDisk(); });
window.addEventListener('message', (event) => { if (event.data === 'FORCE_PAUSE') { if(document.getElementById('view-game').classList.contains('active')) { console.log("Nexus orden√≥ pausar el juego."); App.headerBack(); } } });

</script>



    </body>

</html>
