<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDC - Smart Editor V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --bg-body: #111827; 
            --bg-panel: #1f2937;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #374151;
            --highlight: #fde047;
            --highlight-text: #000;
            --tooltip-bg: #4b5563;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* TOOLBAR */
        .toolbar {
            height: 60px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .brand { font-weight: 700; color: var(--primary); font-size: 1.2rem; margin-right: 20px; }
        .tool-btn {
            background: #374151; border: none; color: white; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .tool-btn:hover { background: var(--primary); }
        .tool-btn svg { width: 16px; height: 16px; }
        
        .format-group { display: flex; gap: 5px; border-right: 1px solid var(--border); padding-right: 15px; }

        /* MAIN LAYOUT */
        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR (DB INTEGRATION) */
        .sidebar {
            width: 280px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        .db-folder { margin-bottom: 5px; }
        .db-folder-title {
            padding: 8px; background: #374151; border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;
        }
        .db-folder-items { display: none; padding-left: 10px; margin-top: 5px; }
        .db-folder.open .db-folder-items { display: block; }
        
        .draggable-word {
            background: #4b5563; padding: 6px 10px; margin-bottom: 4px; border-radius: 4px;
            font-size: 0.85rem; cursor: grab; border: 1px solid transparent; transition: all 0.2s;
            color: #e5e7eb;
        }
        .draggable-word:hover { border-color: var(--primary-light); background: #556070; }
        .draggable-word:active { cursor: grabbing; }

        /* EDITOR AREA */
        .editor-container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .document-title {
            width: 100%; background: transparent; border: none; font-size: 2rem; font-weight: 700;
            color: var(--text-main); margin-bottom: 30px; outline: none;
        }

        /* BLOCKS (ROWS) */
        .editor-block {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            transition: box-shadow 0.2s;
            position: relative;
        }
        .editor-block:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }

        .block-inputs { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        
        /* Row Wrappers for Flags */
        .row-wrapper {
            position: relative;
            width: 100%;
        }

        /* Content Editable styling */
        .input-row {
            padding: 8px; padding-right: 35px; /* Space for flag */
            border-radius: 4px; outline: none; min-height: 32px;
            line-height: 1.5;
        }
        .row-en {
            font-size: 1.1rem; color: #fff; font-weight: 500;
            border-left: 3px solid var(--primary); background: rgba(79,70,229, 0.1);
        }
        .row-es {
            font-size: 1rem; color: var(--text-muted); font-style: italic;
            border-left: 3px solid #10b981; background: rgba(16,185,129, 0.05);
        }
        
        /* GHOST FLAGS */
        .lang-flag {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 15px;
            pointer-events: none; /* Let clicks pass through */
            filter: grayscale(100%);
            opacity: 0.2;
            background-size: cover;
            background-repeat: no-repeat;
        }
        /* Using base64 SVGs to keep single file */
        .flag-en {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 30'%3E%3CclipPath id='s'%3E%3Cpath d='M0,0 v30 h60 v-30 z'/%3E%3C/clipPath%3E%3CclipPath id='t'%3E%3Cpath d='M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z'/%3E%3C/clipPath%3E%3Cg clip-path='url(%23s)'%3E%3Cpath d='M0,0 v30 h60 v-30 z' fill='%23012169'/%3E%3Cpath d='M0,0 L60,30 M60,0 L0,30' stroke='%23fff' stroke-width='6'/%3E%3Cpath d='M0,0 L60,30 M60,0 L0,30' clip-path='url(%23t)' stroke='%23C8102E' stroke-width='4'/%3E%3Cpath d='M30,0 v30 M0,15 h60' stroke='%23fff' stroke-width='10'/%3E%3Cpath d='M30,0 v30 M0,15 h60' stroke='%23C8102E' stroke-width='6'/%3E%3C/g%3E%3C/svg%3E");
        }
        .flag-es {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 750 500'%3E%3Crect width='750' height='500' fill='%23c60b1e'/%3E%3Crect width='750' height='250' y='125' fill='%23ffc400'/%3E%3C/svg%3E");
        }

        .block-controls {
            display: flex; flex-direction: column; gap: 5px; justify-content: center;
        }
        .mini-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            background: #374151; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .mini-btn:hover { background: var(--primary); color: white; }
        .mini-btn.delete:hover { background: #ef4444; }

        /* HOVER TOOLTIP */
        #translation-tooltip {
            position: fixed;
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 250px;
        }

        /* FORMATTING CLASSES */
        b { color: var(--primary-light); }
        i { color: #f472b6; }
        u { text-decoration-color: var(--highlight); text-decoration-thickness: 2px; }

    </style>
</head>
<body>

    <div class="toolbar">
        <div class="brand">MDC Editor</div>
        
        <div class="format-group">
            <button class="tool-btn" onclick="formatText('bold')" title="Bold"><b>B</b></button>
            <button class="tool-btn" onclick="formatText('italic')" title="Italic"><i>I</i></button>
            <button class="tool-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
        </div>

        <button class="tool-btn" onclick="addNewBlock()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            New Block
        </button>
        <button class="tool-btn" onclick="saveDocument()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
            Save
        </button>
         <button class="tool-btn" onclick="readFullText()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
            Read All
        </button>
    </div>

    <div class="workspace">
        <div class="sidebar">
            <div class="sidebar-header">Vocabulary Bank (From Database)</div>
            <div class="sidebar-content" id="sidebar-list">
                </div>
        </div>

        <div class="editor-container" id="editor-area">
            <input type="text" class="document-title" id="doc-title" placeholder="Untitled Lesson...">
            <div id="blocks-wrapper">
                </div>
        </div>
    </div>

    <div id="translation-tooltip">Translation</div>

<script>
    // --- CONFIG & STATE ---
    const DB_KEY = 'mdc_vocab_list';
    const DOC_KEY = 'mdc_smart_editor_doc';
    let hoverTimer;
    let currentTooltip = document.getElementById('translation-tooltip');

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadSidebar();
        loadDocument();
        
        // If empty, add one block
        if(document.getElementById('blocks-wrapper').children.length === 0) {
            addNewBlock();
        }
    });

    // --- SIDEBAR LOGIC (READ ONLY FROM DB) ---
    function loadSidebar() {
        const raw = localStorage.getItem(DB_KEY);
        const list = document.getElementById('sidebar-list');
        list.innerHTML = '';

        if (!raw) {
            list.innerHTML = '<div style="padding:10px; color: grey">No database found.</div>';
            return;
        }

        const data = JSON.parse(raw);
        
        // 1. Render Folders
        data.filter(i => i.isFolder).forEach(folder => {
            const folderEl = document.createElement('div');
            folderEl.className = 'db-folder';
            
            const titleEl = document.createElement('div');
            titleEl.className = 'db-folder-title';
            titleEl.innerHTML = `<span>ðŸ“‚ ${folder.name}</span> <span style="font-size:0.8em; opacity:0.7">${folder.items.length}</span>`;
            titleEl.onclick = () => folderEl.classList.toggle('open');
            
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'db-folder-items';
            
            folder.items.forEach(item => {
                itemsContainer.appendChild(createDraggableChip(item.eng));
            });

            folderEl.appendChild(titleEl);
            folderEl.appendChild(itemsContainer);
            list.appendChild(folderEl);
        });

        // 2. Render Loose Items
        const looseItems = data.filter(i => !i.isFolder);
        if (looseItems.length > 0) {
            const looseContainer = document.createElement('div');
            looseContainer.style.marginTop = '15px';
            looseContainer.innerHTML = '<div class="sidebar-header">Uncategorized</div>';
            looseItems.forEach(item => {
                looseContainer.appendChild(createDraggableChip(item.eng));
            });
            list.appendChild(looseContainer);
        }
    }

    function createDraggableChip(text) {
        const chip = document.createElement('div');
        chip.className = 'draggable-word';
        chip.textContent = text;
        chip.draggable = true;
        chip.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', text);
            e.dataTransfer.effectAllowed = 'copy';
        };
        return chip;
    }

    // --- EDITOR LOGIC ---
    function addNewBlock(engText = '', espText = '') {
        const wrapper = document.getElementById('blocks-wrapper');
        const blockId = Date.now();
        
        const block = document.createElement('div');
        block.className = 'editor-block';
        block.innerHTML = `
            <div class="block-inputs">
                <div class="row-wrapper">
                    <div class="input-row row-en" contenteditable="true" 
                         data-placeholder="English text here..."
                         oninput="autoSave()" 
                         onmousemove="handleHover(event)" 
                         onmouseleave="hideTooltip()"
                         onpaste="handlePaste(event)">${engText}</div>
                    <div class="lang-flag flag-en" title="English"></div>
                </div>
                
                <div class="row-wrapper">
                    <div class="input-row row-es" contenteditable="true" 
                         data-placeholder="Translation..."
                         oninput="autoSave()">${espText}</div>
                    <div class="lang-flag flag-es" title="Spanish"></div>
                </div>
            </div>
            
            <div class="block-controls">
                <button class="mini-btn" onclick="speakBlock(this)" title="Listen">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                </button>
                <button class="mini-btn" onclick="translateBlock(this)" title="Auto Translate (Bidirectional)">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" /></svg>
                </button>
                <button class="mini-btn delete" onclick="deleteBlock(this)" title="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        `;
        
        wrapper.appendChild(block);
        
        // Handle Drag & Drop specifically for the new English row
        const enRow = block.querySelector('.row-en');
        enRow.addEventListener('dragover', (e) => {
            e.preventDefault(); // Necessary to allow dropping
            enRow.style.background = 'rgba(79,70,229, 0.3)';
        });
        enRow.addEventListener('dragleave', () => {
             enRow.style.background = 'rgba(79,70,229, 0.1)';
        });
        enRow.addEventListener('drop', (e) => {
            e.preventDefault();
            enRow.style.background = 'rgba(79,70,229, 0.1)';
            const text = e.dataTransfer.getData('text/plain');
            
            // Point 1: Add spaces before and after the inserted word
            const textWithSpaces = " " + text + " ";
            
            // Insert text at cursor position if possible, or append
            if (document.caretRangeFromPoint) {
                const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                if (range && enRow.contains(range.startContainer)) {
                    const textNode = document.createTextNode(textWithSpaces);
                    range.insertNode(textNode);
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                } else {
                    enRow.innerHTML += textWithSpaces;
                }
            } else {
                enRow.innerHTML += textWithSpaces;
            }
            autoSave();
        });
        
        // Focus logic
        enRow.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                block.querySelector('.row-es').focus();
            }
        });
        
        const esRow = block.querySelector('.row-es');
        esRow.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                addNewBlock();
                setTimeout(() => {
                    const allBlocks = wrapper.querySelectorAll('.editor-block');
                    const lastBlock = allBlocks[allBlocks.length - 1];
                    lastBlock.querySelector('.row-en').focus();
                }, 10);
            }
        });

        return block;
    }

    function deleteBlock(btn) {
        if(confirm('Delete this block?')) {
            btn.closest('.editor-block').remove();
            autoSave();
        }
    }

    // --- HOVER TRANSLATION (INTERACTIVE) ---
    function handleHover(e) {
        if (e.target.nodeName === 'DIV' || e.target.nodeName === 'SPAN') {
            clearTimeout(hoverTimer);
            const range = document.caretRangeFromPoint(e.clientX, e.clientY);
            if (!range || !range.startContainer.textContent) return;
            
            const text = range.startContainer.textContent;
            const offset = range.startOffset;
            
            let start = offset;
            let end = offset;
            while(start > 0 && /\w/.test(text.charAt(start-1))) start--;
            while(end < text.length && /\w/.test(text.charAt(end))) end++;
            
            const word = text.slice(start, end).trim();
            
            if (word.length > 2) {
                hoverTimer = setTimeout(() => {
                    showTooltip(word, e.clientX, e.clientY);
                }, 500); 
            }
        }
    }

    function hideTooltip() {
        clearTimeout(hoverTimer);
        currentTooltip.style.opacity = 0;
    }

    async function showTooltip(word, x, y) {
        const translation = await fetchTranslation(word, 'en', 'es');
        if(translation) {
            currentTooltip.textContent = `${word} â†’ ${translation}`;
            currentTooltip.style.left = (x + 10) + 'px';
            currentTooltip.style.top = (y + 20) + 'px';
            currentTooltip.style.opacity = 1;
        }
    }

    // --- API & UTILS ---
    async function fetchTranslation(text, sl, tl) {
        try {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`;
            const res = await fetch(url);
            const data = await res.json();
            return data[0][0][0];
        } catch (e) { console.error(e); return null; }
    }
    
    // Point 3: Bidirectional Translation Logic
    async function translateBlock(btn) {
        const block = btn.closest('.editor-block');
        const enRow = block.querySelector('.row-en');
        const esRow = block.querySelector('.row-es');
        
        const enText = enRow.innerText.trim();
        const esText = esRow.innerText.trim();
        
        // Priority: If EN has text, translate to ES. If EN is empty but ES has text, translate to EN.
        if (enText) {
            esRow.style.opacity = 0.5;
            const trans = await fetchTranslation(enText, 'en', 'es');
            esRow.style.opacity = 1;
            if(trans) {
                esRow.innerText = trans;
                autoSave();
            }
        } else if (esText) {
            enRow.style.opacity = 0.5;
            const trans = await fetchTranslation(esText, 'es', 'en');
            enRow.style.opacity = 1;
            if(trans) {
                enRow.innerText = trans;
                autoSave();
            }
        }
    }

    function speakBlock(btn) {
        const text = btn.closest('.editor-block').querySelector('.row-en').innerText;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
    }
    
    function readFullText() {
        const blocks = document.querySelectorAll('.editor-block');
        let fullText = "";
        blocks.forEach(b => {
            fullText += b.querySelector('.row-en').innerText + ". ";
        });
        const utterance = new SpeechSynthesisUtterance(fullText);
        utterance.lang = 'en-US';
        window.speechSynthesis.speak(utterance);
    }

    function formatText(command) {
        document.execCommand(command, false, null);
        document.querySelector('.editor-container').focus();
    }
    
    function handlePaste(e) {
        e.preventDefault();
        const text = (e.originalEvent || e).clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);
    }

    // --- STORAGE ---
    function autoSave() {
        saveDocument();
    }

    function saveDocument() {
        const title = document.getElementById('doc-title').value;
        const blocks = [];
        document.querySelectorAll('.editor-block').forEach(b => {
            blocks.push({
                en: b.querySelector('.row-en').innerHTML, 
                es: b.querySelector('.row-es').innerHTML
            });
        });
        
        const docData = { title, blocks, date: Date.now() };
        localStorage.setItem(DOC_KEY, JSON.stringify(docData));
    }

    function loadDocument() {
        const raw = localStorage.getItem(DOC_KEY);
        if(raw) {
            const data = JSON.parse(raw);
            document.getElementById('doc-title').value = data.title || '';
            const wrapper = document.getElementById('blocks-wrapper');
            wrapper.innerHTML = '';
            
            if(data.blocks && data.blocks.length > 0) {
                data.blocks.forEach(b => addNewBlock(b.en, b.es));
            }
        }
    }
</script>
</body>
</html>
