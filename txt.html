<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDC - Smart Editor V8.2 (Stable Drag & Drop)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --bg-body: #111827; 
            --bg-panel: #1f2937;
            --bg-pair-alt: #283142; 
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #374151;
            --highlight: #fde047;
            --danger: #ef4444;
            --recording: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* TOOLBAR */
        .toolbar {
            height: 60px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .brand { font-weight: 700; color: var(--primary); font-size: 1.2rem; margin-right: 20px; }
        .tool-btn {
            background: #374151; border: none; color: white; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .tool-btn:hover { background: var(--primary); }
        .tool-btn.active { background: var(--highlight); color: black; font-weight: bold; }
        .tool-btn svg { width: 16px; height: 16px; }
        
        .format-group { display: flex; gap: 5px; border-right: 1px solid var(--border); padding-right: 15px; }
        
        .study-group { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        #save-status {
            font-size: 0.8rem; color: var(--text-muted); font-style: italic;
            opacity: 0; transition: opacity 0.5s; margin-right: 10px;
        }
        #save-status.visible { opacity: 1; color: var(--success); }

        /* MAIN LAYOUT */
        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header { 
            padding: 15px 15px 5px 15px; 
            font-weight: 700; color: var(--primary-light); font-size: 0.75rem; 
            text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; border-top: 1px solid var(--border);
        }
        .sidebar-header:first-child { border-top: none; margin-top: 0; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        .db-folder { margin-bottom: 5px; border: 1px solid #374151; border-radius: 6px; overflow: hidden; background: #111827; }
        .db-folder-title {
            padding: 10px; background: #1f2937; cursor: pointer; font-size: 0.9rem; 
            display: flex; justify-content: space-between; align-items: center; font-weight: 500;
        }
        .db-folder-title:hover { background: #374151; }
        .db-folder-items { display: none; padding: 10px; background: #111827; border-top: 1px solid #374151; }
        .db-folder.open .db-folder-items { display: block; }
        
        .draggable-word {
            background: #374151; padding: 6px 10px; margin-bottom: 5px; border-radius: 4px;
            font-size: 0.85rem; cursor: grab; border: 1px solid transparent; transition: all 0.2s;
            color: #e5e7eb; display: block;
        }
        .draggable-word:hover { border-color: var(--primary-light); background: #4b5563; }

        /* EDITOR AREA */
        .editor-container {
            flex: 1; padding: 40px; overflow-y: auto;
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-size: 20px 20px; padding-bottom: 200px;
        }
        .document-title {
            width: 100%; background: transparent; border: none; font-size: 2rem; font-weight: 700;
            color: var(--text-main); margin-bottom: 30px; outline: none;
        }

        /* BLOCKS */
        .editor-block {
            background: var(--bg-panel); border-radius: 12px; margin-bottom: 30px;
            border: 1px solid var(--border); overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); position: relative;
        }
        .block-header {
            background: #111827; padding: 8px 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .block-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        
        .lesson-drawer { display: none; padding: 15px; background: #1f2937; border-bottom: 1px solid var(--border); }
        .lesson-drawer textarea {
            width: 100%; min-height: 80px; background: #111827; color: #d1d5db;
            border: 1px dashed #6b7280; border-radius: 6px; padding: 10px;
            font-family: monospace; font-size: 0.9rem; resize: vertical;
        }
        .lesson-drawer textarea:focus { outline: none; border-color: var(--primary-light); }

        .pairs-container { display: flex; flex-direction: column; }
        .sentence-pair {
            display: flex; gap: 10px; padding: 12px 15px;
            border-bottom: 1px solid #374151; align-items: flex-start;
        }
        .sentence-pair:nth-child(even) { background-color: var(--bg-pair-alt); }
        .sentence-pair:last-child { border-bottom: none; }

        .pair-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .row-wrapper { position: relative; width: 100%; }
        .input-row {
            padding: 8px 10px; padding-right: 30px; border-radius: 4px; outline: none; 
            min-height: 36px; line-height: 1.5; transition: filter 0.3s;
        }
        .row-en {
            font-size: 1.05rem; color: #fff; font-weight: 500;
            border-left: 3px solid var(--primary); background: rgba(79,70,229, 0.1);
        }
        .row-es {
            font-size: 0.95rem; color: var(--text-muted); font-style: italic;
            border-left: 3px solid #10b981; background: rgba(16,185,129, 0.05);
        }
        
        .input-row:focus { box-shadow: 0 0 0 1px var(--primary-light); }

        /* BLUR EFFECTS */
        .blur-en .row-en { color: transparent; text-shadow: 0 0 10px rgba(255,255,255,0.7); cursor: help; }
        .blur-es .row-es { color: transparent; text-shadow: 0 0 10px rgba(255,255,255,0.7); cursor: help; }
        .blur-en .row-en:hover, .blur-en .row-en:focus { color: #fff; text-shadow: none; }
        .blur-es .row-es:hover, .blur-es .row-es:focus { color: var(--text-muted); text-shadow: none; }

        .pair-controls { display: flex; flex-direction: column; gap: 4px; padding-top: 2px; }
        .lang-flag {
            position: absolute; right: 8px; bottom: 10px; width: 18px; height: 12px; pointer-events: none;
            filter: grayscale(100%); opacity: 0.2; background-size: cover;
        }
        .flag-en { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 30'%3E%3Cpath d='M0,0 v30 h60 v-30 z' fill='%23012169'/%3E%3Cpath d='M0,0 L60,30 M60,0 L0,30' stroke='%23fff' stroke-width='6'/%3E%3Cpath d='M0,0 L60,30 M60,0 L0,30' stroke='%23C8102E' stroke-width='4'/%3E%3Cpath d='M30,0 v30 M0,15 h60' stroke='%23fff' stroke-width='10'/%3E%3Cpath d='M30,0 v30 M0,15 h60' stroke='%23C8102E' stroke-width='6'/%3E%3C/svg%3E"); }
        .flag-es { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 750 500'%3E%3Crect width='750' height='500' fill='%23c60b1e'/%3E%3Crect width='750' height='250' y='125' fill='%23ffc400'/%3E%3C/svg%3E"); }

        .mini-btn {
            width: 26px; height: 26px; border-radius: 4px; border: none;
            background: #374151; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .mini-btn:hover { background: var(--primary); color: white; }
        .mini-btn.delete:hover { background: var(--danger); }
        .mini-btn.book-active { background: var(--highlight); color: black; }
        
        .mini-btn.recording { background: var(--recording); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .block-delete { margin-left: auto; background: transparent; color: #6b7280; }
        .block-delete:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        #translation-tooltip {
            position: fixed; background: var(--primary); color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
            z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        
        b { color: var(--primary-light); }
        i { color: #f472b6; }
        u { text-decoration-color: var(--highlight); text-decoration-thickness: 2px; }

    </style>
</head>
<body>

    <div class="toolbar">
        <div class="brand">MDC Editor V8.2</div>
        
        <div class="format-group">
            <button class="tool-btn" onclick="formatText('bold')"><b>B</b></button>
            <button class="tool-btn" onclick="formatText('italic')"><i>I</i></button>
            <button class="tool-btn" onclick="formatText('underline')"><u>U</u></button>
        </div>

        <button class="tool-btn" onclick="createBlock()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            New Block
        </button>
        <button class="tool-btn" onclick="saveDocumentManual()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
            Save
        </button>
        
        <div class="study-group">
            <span id="save-status">Autosaved</span>
            <button class="tool-btn" id="btn-blur-en" onclick="toggleBlur('en')">
                üëÅÔ∏è Hide English
            </button>
            <button class="tool-btn" id="btn-blur-es" onclick="toggleBlur('es')">
                üëÅÔ∏è Hide Spanish
            </button>
        </div>
    </div>

    <div class="workspace">
        <div class="sidebar">
            <div class="sidebar-content" id="sidebar-list"></div>
        </div>

        <div class="editor-container" id="editor-area">
            <input type="text" class="document-title" id="doc-title" placeholder="My English Lesson...">
            <div id="blocks-wrapper"></div>
        </div>
    </div>

    <div id="translation-tooltip">Translation</div>

<script>
    // --- STATE ---
    const DB_KEY = 'mdc_vocab_list';
    const DOC_KEY = 'mdc_smart_editor_v8_doc';
    let hoverTimer;
    let currentTooltip = document.getElementById('translation-tooltip');
    
    // Recognition & Context State
    let recognition;
    let isRecording = false;
    let currentRecordingBtn = null;
    let activeLangContext = 'en'; 

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onresult = function(event) {
            if(currentRecordingBtn) {
                const text = event.results[0][0].transcript;
                const pair = currentRecordingBtn.closest('.sentence-pair');
                let targetRow;
                if (activeLangContext === 'es') {
                    targetRow = pair.querySelector('.row-es');
                } else {
                    targetRow = pair.querySelector('.row-en');
                }
                
                if(targetRow.innerText.trim() === '') {
                    targetRow.innerText = text;
                } else {
                    targetRow.innerText += " " + text;
                }
                autoSave();
            }
        };
        
        recognition.onend = function() {
            isRecording = false;
            if(currentRecordingBtn) currentRecordingBtn.classList.remove('recording');
            currentRecordingBtn = null;
        };
    }

    const STATIC_GRAMMAR = [
        { name: "Pronouns (Pronombres)", words: ["I", "You", "He", "She", "We", "They", "It"] },
        { name: "Verbs (Verbos)", words: ["To Be", "To Have", "To Do", "To Go", "To Say", "To Get", "To Make"] },
        { name: "Adjectives (Adjetivos)", words: ["Good", "New", "First", "Last", "Long", "Great", "Little"] },
        { name: "Nouns (Sustantivos)", words: ["Time", "Person", "Year", "Way", "Day", "Thing", "Man"] },
        { name: "Prepositions", words: ["In", "On", "At", "For", "With", "By", "From"] }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        loadSidebar();
        loadDocument();
        if(document.getElementById('blocks-wrapper').children.length === 0) createBlock();
    });

    // --- SIDEBAR (FIXED) ---
    function loadSidebar() {
        const raw = localStorage.getItem(DB_KEY);
        const list = document.getElementById('sidebar-list');
        list.innerHTML = ''; // Start clean

        // 1. My Database
        if (raw) {
            const data = JSON.parse(raw);
            const folders = data.filter(i => i.isFolder);
            if (folders.length > 0) {
                const header = document.createElement('div');
                header.className = 'sidebar-header';
                header.innerText = 'My Database';
                list.appendChild(header);

                folders.forEach(folder => {
                    const folderEl = document.createElement('div');
                    folderEl.className = 'db-folder';
                    folderEl.innerHTML = `
                        <div class="db-folder-title" onclick="this.parentElement.classList.toggle('open')">
                            <span>üìÇ ${folder.name}</span> <span style="font-size:0.8em; opacity:0.7">${folder.items.length}</span>
                        </div>
                        <div class="db-folder-items"></div>
                    `;
                    const container = folderEl.querySelector('.db-folder-items');
                    // Safety check: item.eng must exist
                    folder.items.forEach(item => {
                        if(item && item.eng) {
                            container.appendChild(createDraggableChip(item.eng));
                        }
                    });
                    list.appendChild(folderEl);
                });
            }
        }

        // 2. Grammar Helper
        const gramHeader = document.createElement('div');
        gramHeader.className = 'sidebar-header';
        gramHeader.innerText = 'Grammar Helper';
        list.appendChild(gramHeader);

        STATIC_GRAMMAR.forEach(cat => {
            const catEl = document.createElement('div');
            catEl.className = 'db-folder';
            catEl.innerHTML = `
                <div class="db-folder-title" onclick="this.parentElement.classList.toggle('open')">
                    <span>üìö ${cat.name}</span>
                </div>
                <div class="db-folder-items"></div>
            `;
            const container = catEl.querySelector('.db-folder-items');
            cat.words.forEach(word => container.appendChild(createDraggableChip(word)));
            list.appendChild(catEl);
        });
    }

    // --- DRAGGABLE CHIP (HARDENED) ---
    function createDraggableChip(text) {
        const chip = document.createElement('div');
        chip.className = 'draggable-word';
        chip.textContent = text;
        chip.draggable = true;
        
        chip.ondragstart = (e) => {
            // FIX: Read text content directly from the target element
            // This ensures "What you see is what you drag" even if closure references fail.
            const content = e.target.innerText; 
            e.dataTransfer.setData('text/plain', content);
            e.dataTransfer.effectAllowed = 'copy';
        };
        return chip;
    }

    // --- EDITOR ---
    function createBlock(lessonText = '', pairsData = []) {
        const wrapper = document.getElementById('blocks-wrapper');
        const block = document.createElement('div');
        block.className = 'editor-block';
        
        const showLesson = lessonText.trim().length > 0 ? 'style="display:block;"' : '';
        const bookActiveClass = lessonText.trim().length > 0 ? 'book-active' : '';

        block.innerHTML = `
            <div class="block-header">
                <div class="block-label">Block / Unit</div>
                <div style="display:flex; gap:5px;">
                    <button class="mini-btn ${bookActiveClass}" onclick="toggleLesson(this)" title="Toggle Lesson Notes">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    </button>
                    <button class="mini-btn block-delete" onclick="removeBlock(this)" title="Delete entire block">‚úï</button>
                </div>
            </div>
            <div class="lesson-drawer" ${showLesson}>
                <textarea placeholder="Paste study material here..." oninput="autoSave()">${lessonText}</textarea>
            </div>
            <div class="pairs-container"></div>
        `;
        wrapper.appendChild(block);
        const pairsContainer = block.querySelector('.pairs-container');
        if(pairsData.length > 0) pairsData.forEach(p => addPair(pairsContainer, p.en, p.es));
        else addPair(pairsContainer);
    }

    function addPair(container, enText = '', esText = '', focusEn = false) {
        const pair = document.createElement('div');
        pair.className = 'sentence-pair';
        pair.innerHTML = `
            <div class="pair-inputs">
                <div class="row-wrapper">
                    <div class="input-row row-en" contenteditable="true" 
                         data-placeholder="English..." 
                         onfocus="activeLangContext='en'"
                         oninput="autoSave()" 
                         onmousemove="handleHover(event)" 
                         onmouseleave="hideTooltip()" 
                         onpaste="handlePaste(event)">${enText}</div>
                    <div class="lang-flag flag-en"></div>
                </div>
                <div class="row-wrapper">
                    <div class="input-row row-es" contenteditable="true" 
                         data-placeholder="Espa√±ol..." 
                         onfocus="activeLangContext='es'"
                         oninput="autoSave()">${esText}</div>
                    <div class="lang-flag flag-es"></div>
                </div>
            </div>
            <div class="pair-controls">
                <button class="mini-btn" onclick="toggleRecord(this)" title="Dictate (Records to last clicked row)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                </button>
                <button class="mini-btn" onclick="speakPair(this)" title="Listen">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                </button>
                <button class="mini-btn" onclick="translatePair(this)" title="Translate">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" /></svg>
                </button>
                <button class="mini-btn delete" onclick="deletePair(this)" title="Delete Pair">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        `;
        container.appendChild(pair);

        const enRow = pair.querySelector('.row-en');
        const esRow = pair.querySelector('.row-es');

        // --- FIXED DROP LOGIC ---
        enRow.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            enRow.style.background = 'rgba(79,70,229,0.3)'; 
        });
        enRow.addEventListener('dragleave', () => { 
            enRow.style.background = 'rgba(79,70,229,0.1)'; 
        });
        enRow.addEventListener('drop', (e) => {
            e.preventDefault();
            enRow.style.background = 'rgba(79,70,229,0.1)';
            const text = " " + e.dataTransfer.getData('text/plain') + " ";
            
            // Positioning Hack:
            // Ensure focus is on the element
            enRow.focus();
            
            // Try to use caret position if available
            if (document.caretRangeFromPoint) {
                const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                if (range && enRow.contains(range.startContainer)) {
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
            
            document.execCommand('insertText', false, text);
            autoSave();
        });

        enRow.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); esRow.focus(); } });
        esRow.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); addPair(container, '', '', true); } });

        if(focusEn) setTimeout(() => enRow.focus(), 10);
    }

    // --- FUNCTIONS ---
    function toggleBlur(lang) {
        const body = document.body;
        const btn = document.getElementById(`btn-blur-${lang}`);
        
        if (lang === 'en') {
            body.classList.toggle('blur-en');
            btn.classList.toggle('active');
        } else {
            body.classList.toggle('blur-es');
            btn.classList.toggle('active');
        }
    }

    function toggleRecord(btn) {
        if (!recognition) { alert("Speech recognition not supported in this browser (Use Chrome/Edge)."); return; }
        if (isRecording) { recognition.stop(); return; }
        
        currentRecordingBtn = btn;
        btn.classList.add('recording');
        if (activeLangContext === 'es') recognition.lang = 'es-ES';
        else recognition.lang = 'en-US';
        recognition.start();
        isRecording = true;
    }

    function toggleLesson(btn) {
        const block = btn.closest('.editor-block');
        const drawer = block.querySelector('.lesson-drawer');
        const isHidden = drawer.style.display === 'none' || drawer.style.display === '';
        drawer.style.display = isHidden ? 'block' : 'none';
        btn.classList.toggle('book-active');
        if(isHidden) drawer.querySelector('textarea').focus();
        autoSave();
    }
    
    function removeBlock(btn) { if(confirm("Delete block?")) { btn.closest('.editor-block').remove(); autoSave(); } }
    function deletePair(btn) { 
        const pair = btn.closest('.sentence-pair');
        if(pair.parentElement.children.length === 1) {
            pair.querySelector('.row-en').innerText = ''; pair.querySelector('.row-es').innerText = '';
        } else { pair.remove(); }
        autoSave();
    }

    function speakPair(btn) {
        const text = btn.closest('.sentence-pair').querySelector('.row-en').innerText;
        const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u);
    }

    async function translatePair(btn) {
        const pair = btn.closest('.sentence-pair');
        const enRow = pair.querySelector('.row-en'); const esRow = pair.querySelector('.row-es');
        const en = enRow.innerText.trim(); const es = esRow.innerText.trim();
        if (en) {
            esRow.style.opacity = 0.5;
            const res = await fetchTranslation(en, 'en', 'es');
            esRow.style.opacity = 1; if(res) { esRow.innerText = res; autoSave(); }
        } else if (es) {
            enRow.style.opacity = 0.5;
            const res = await fetchTranslation(es, 'es', 'en');
            enRow.style.opacity = 1; if(res) { enRow.innerText = res; autoSave(); }
        }
    }

    async function fetchTranslation(text, sl, tl) {
        try {
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`);
            const data = await res.json(); return data[0][0][0];
        } catch(e) { return null; }
    }

    function handleHover(e) {
        if (e.target.nodeName !== 'DIV' && e.target.nodeName !== 'SPAN') return;
        clearTimeout(hoverTimer);
        const range = document.caretRangeFromPoint(e.clientX, e.clientY);
        if (!range || !range.startContainer.textContent) return;
        const text = range.startContainer.textContent;
        let start = range.startOffset, end = range.startOffset;
        while(start > 0 && /\w/.test(text.charAt(start-1))) start--;
        while(end < text.length && /\w/.test(text.charAt(end))) end++;
        const word = text.slice(start, end).trim();
        if (word.length > 2) {
            hoverTimer = setTimeout(async () => {
                const tr = await fetchTranslation(word, 'en', 'es');
                if(tr) {
                    currentTooltip.innerText = `${word} ‚Üí ${tr}`;
                    currentTooltip.style.left = (e.clientX+10)+'px';
                    currentTooltip.style.top = (e.clientY+20)+'px';
                    currentTooltip.style.opacity = 1;
                }
            }, 500);
        }
    }
    function hideTooltip() { clearTimeout(hoverTimer); currentTooltip.style.opacity = 0; }
    function handlePaste(e) { e.preventDefault(); document.execCommand('insertText', false, (e.originalEvent||e).clipboardData.getData('text/plain')); }
    function formatText(cmd) { document.execCommand(cmd, false, null); }
    function readFullText() {
        let txt = ""; document.querySelectorAll('.row-en').forEach(el => txt += el.innerText + ". ");
        const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-US'; window.speechSynthesis.speak(u);
    }
    
    function autoSave() { 
        saveDocument(); 
        const status = document.getElementById('save-status');
        status.classList.add('visible');
        setTimeout(() => status.classList.remove('visible'), 2000);
    }
    
    function saveDocumentManual() {
        saveDocument();
        const status = document.getElementById('save-status');
        status.textContent = "Saved Manually!";
        status.classList.add('visible');
        setTimeout(() => {
            status.classList.remove('visible');
            status.textContent = "Autosaved";
        }, 2000);
    }

    function saveDocument() {
        const title = document.getElementById('doc-title').value;
        const blocksData = [];
        document.querySelectorAll('.editor-block').forEach(block => {
            const lesson = block.querySelector('.lesson-drawer textarea').value;
            const pairs = [];
            block.querySelectorAll('.sentence-pair').forEach(pair => {
                pairs.push({ en: pair.querySelector('.row-en').innerHTML, es: pair.querySelector('.row-es').innerHTML });
            });
            blocksData.push({ lesson, pairs });
        });
        localStorage.setItem(DOC_KEY, JSON.stringify({ title, blocks: blocksData, date: Date.now() }));
    }
    function loadDocument() {
        const raw = localStorage.getItem(DOC_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        document.getElementById('doc-title').value = data.title || '';
        document.getElementById('blocks-wrapper').innerHTML = '';
        if(data.blocks && data.blocks.length > 0) data.blocks.forEach(b => createBlock(b.lesson, b.pairs));
    }
</script>
</body>
</html>
