<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calibrador V3: P√≠xeles Reales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        canvas { border: 2px solid #334155; cursor: crosshair; }
        .btn-mode.active { border-color: white; box-shadow: 0 0 15px currentColor; transform: scale(1.05); }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <div class="max-w-5xl w-full">
        <div class="flex justify-between items-end mb-4 border-b border-slate-700 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-cyan-400">üì° CALIBRADOR DE ZONAS (V3)</h1>
                <p class="text-slate-400 text-xs">Genera coordenadas reales para c√°mara 4K.</p>
            </div>
            
            <div class="flex gap-2 bg-slate-800 p-2 rounded text-xs">
                <div class="flex flex-col">
                    <span class="text-slate-500 font-bold">ANCHO REAL (CAM):</span>
                    <input type="number" id="realW" value="3840" class="bg-black text-cyan-300 border border-slate-600 rounded px-1 w-20 text-center">
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-500 font-bold">ALTO REAL (CAM):</span>
                    <input type="number" id="realH" value="2160" class="bg-black text-cyan-300 border border-slate-600 rounded px-1 w-20 text-center">
                </div>
            </div>
        </div>

        <div class="bg-slate-800 p-4 rounded-xl flex flex-wrap gap-4 justify-between items-center mb-4 shadow-lg border border-slate-700">
            <label class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold cursor-pointer text-sm shadow-lg hover:shadow-blue-500/50 transition-all">
                üìÇ 1. SUBIR FOTO
                <input type="file" id="imgInput" accept="image/*" class="hidden">
            </label>

            <div class="flex gap-3">
                <button onclick="setMode('zona', '#4ade80')" id="btnPos" class="btn-mode active bg-green-900/50 text-green-300 border border-green-600 px-4 py-2 rounded font-bold text-sm">
                    üõ°Ô∏è ALARMA
                </button>
                <button onclick="setMode('nozona', '#f87171')" id="btnNeg" class="btn-mode bg-red-900/50 text-red-300 border border-red-600 px-4 py-2 rounded font-bold text-sm">
                    ‚õî IGNORAR
                </button>
            </div>

            <div class="flex items-center gap-2 bg-black px-4 py-2 rounded border border-slate-600">
                <span class="text-slate-400 text-xs font-bold">ZONA ID:</span>
                <select id="zoneId" class="bg-transparent text-white font-bold outline-none text-lg">
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                </select>
            </div>
        </div>

        <div class="relative bg-black rounded-lg overflow-hidden border-2 border-slate-700 shadow-2xl">
            <p id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 animate-pulse">
                <span>‚¨Ü Sube la foto que te envi√≥ el Bot en Telegram</span>
                <span class="text-xs mt-2 text-slate-600">(No importa si est√° borrosa, el sistema la corregir√°)</span>
            </p>
            <canvas id="canvas" class="w-full h-auto block"></canvas>
            
            <div id="coordsInfo" class="absolute bottom-2 left-2 bg-black/80 text-cyan-400 text-xs px-2 py-1 rounded hidden font-mono">
                X: 0 Y: 0
            </div>
        </div>

        <div class="mt-4 bg-slate-900 border border-cyan-900 rounded-lg p-4 relative group hover:border-cyan-500 transition-colors">
            <p class="text-cyan-500 text-xs font-bold mb-1 uppercase tracking-widest">Copia este comando y p√©galo en Telegram:</p>
            <code id="output" class="text-lg font-mono text-white break-all block">...</code>
            
            <button onclick="copyText()" class="absolute top-1/2 -translate-y-1/2 right-4 bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded font-bold text-sm shadow-lg shadow-cyan-900/50">
                COPIAR üìã
            </button>
        </div>
        
        <div class="text-center mt-4">
            <button onclick="reset()" class="text-red-400 text-xs underline hover:text-red-300">Borrar puntos y empezar de nuevo</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const coordsInfo = document.getElementById('coordsInfo');
        let img = new Image();
        let points = [];
        let prefix = '/zona';
        let color = '#4ade80';

        // Configuraci√≥n de la c√°mara REAL (Default 4K)
        // Si el usuario cambia estos inputs, se recalcula todo.
        function getRealDims() {
            return {
                w: parseInt(document.getElementById('realW').value) || 3840,
                h: parseInt(document.getElementById('realH').value) || 2160
            };
        }

        document.getElementById('imgInput').addEventListener('change', e => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = ev => {
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        points = [];
                        draw();
                        document.getElementById('placeholder').style.display = 'none';
                    }
                    img.src = ev.target.result;
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            const real = getRealDims();
            // Escalar posici√≥n del mouse a Resoluci√≥n Real 4K
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const imgX = (e.clientX - rect.left) * scaleX;
            const imgY = (e.clientY - rect.top) * scaleY;
            
            // Proyectar a 4K
            const finalX = Math.round((imgX / canvas.width) * real.w);
            const finalY = Math.round((imgY / canvas.height) * real.h);

            coordsInfo.style.display = 'block';
            coordsInfo.textContent = `X: ${finalX} Y: ${finalY}`;
        });

        canvas.addEventListener('mousedown', e => {
            if(points.length >= 4) points = [];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            points.push({x, y});
            draw();
            generate();
        });

        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if(img.src) ctx.drawImage(img,0,0);
            
            if(points.length > 0) {
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                points.forEach(p => ctx.lineTo(p.x, p.y));
                if(points.length === 4) ctx.closePath();
                ctx.lineWidth = Math.max(3, canvas.width/400);
                ctx.strokeStyle = color;
                ctx.stroke();
                
                // Relleno suave
                if(points.length === 4) {
                    ctx.fillStyle = color + '33'; // Transparencia hex
                    ctx.fill();
                }
                
                points.forEach((p,i) => {
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, Math.max(4, canvas.width/150), 0, Math.PI*2);
                    ctx.fill();
                    
                    // Numero
                    ctx.fillStyle = 'black';
                    ctx.font = `bold ${Math.max(20, canvas.width/50)}px Arial`;
                    ctx.fillText(i+1, p.x, p.y - 10);
                });
            }
        }

        function generate() {
            if(points.length < 4) { document.getElementById('output').textContent = "Marca 4 puntos..."; return; }
            
            const real = getRealDims();
            const id = document.getElementById('zoneId').value;

            // MAGIA: Convertir los puntos clicados a la Resoluci√≥n Real (4K)
            const coords = points.map(p => {
                // Regla de tres: (PosicionClick / AnchoImagen) * AnchoReal
                let finalX = Math.round((p.x / canvas.width) * real.w);
                let finalY = Math.round((p.y / canvas.height) * real.h);
                
                // Seguridad: no salir de limites negativos
                finalX = Math.max(0, finalX);
                finalY = Math.max(0, finalY);
                
                return `${finalX} ${finalY}`;
            }).join(' ');

            document.getElementById('output').textContent = `${prefix}${id} ${coords}`;
        }

        function setMode(m, c) {
            prefix = '/' + m; color = c; points = []; draw();
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active','border-white'));
            document.getElementById(m === 'zona' ? 'btnPos' : 'btnNeg').classList.add('active');
            document.getElementById('output').textContent = "...";
        }

        function reset() { points = []; draw(); document.getElementById('output').textContent = "..."; }
        function copyText() { 
            const t = document.getElementById('output').textContent;
            if(t.includes("...")) return;
            navigator.clipboard.writeText(t); 
            alert("¬°Comando copiado!"); 
        }
    </script>
</body>
</html>
