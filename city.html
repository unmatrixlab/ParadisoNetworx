<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON MOSAIC | Configurable</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* VARIABLES DINÁMICAS (Se modifican desde JS) */
            --hue: 180; /* 180 = Cyan default */
            --sat: 100%;
            --txt-scale: 1; 
            
            /* COLORES CALCULADOS EN BASE AL HUE */
            --cyan: hsl(var(--hue), var(--sat), 50%);
            --pink: hsl(calc(var(--hue) + 180), var(--sat), 60%); /* Complementario */
            
            --gap: 15px; 
            --purple: #bc13fe;
            --dark: #050508;
            
            --neon-1: #ff0055; --neon-2: #00ff99; --neon-3: #ffcc00; 
            --neon-4: #9900ff; --neon-5: #00ccff; --neon-6: #ff3300;
        }

        body {
            margin: 0; background-color: var(--dark);
            background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, var(--dark) 80%);
            height: 100vh; overflow: hidden; font-family: 'Montserrat', sans-serif;
            color: white; display: flex; flex-direction: column; align-items: center;
        }

        /* === HUD SUPERIOR === */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 90px;
            display: flex; justify-content: center; /* CENTRADO DEL TÍTULO */
            align-items: center;
            padding: 0 20px; box-sizing: border-box; z-index: 100;
            pointer-events: none;
        }
        .title { 
            font-weight: 900; letter-spacing: 1px; text-transform: uppercase; font-size: 16px;
            text-shadow: 0 0 20px var(--cyan); color: var(--cyan); pointer-events: auto;
            transition: color 0.3s;
        }
        
        /* BOTONES DEL HUD */
        .hud-btn {
            background: rgba(0,0,0,0.8); border: 2px solid var(--pink);
            color: var(--pink); padding: 8px 20px; border-radius: 4px;
            cursor: pointer; font-weight: 900; text-transform: uppercase; font-size: 12px;
            transition: 0.3s; pointer-events: auto; 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        .hud-btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 30px var(--pink); }
        
        /* BOTÓN VOLVER (FLECHA IZQUIERDA) */
     /* === NUEVO CSS (NEÓN) === */
.back-btn {
    position: absolute; left: 20px; top: 25px;
    width: 40px; height: 40px; border-radius: 50%;
    padding: 0; display: flex; align-items: center; justify-content: center;
    font-size: 24px; /* Un poco más grande la flecha */
    z-index: 101;
    transform: translateX(-20px); opacity: 0;

    /* --- NUEVOS ESTILOS NEÓN --- */
    color: var(--cyan); /* Color de la flecha */
    border-color: var(--cyan); /* Color del borde */
    /* Brillo intenso en el texto y la caja */
    text-shadow: 0 0 10px var(--cyan);
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.3), inset 0 0 15px rgba(0, 255, 255, 0.1);
}
        .back-btn.visible { opacity: 1; transform: translateX(0); }

        /* BOTÓN DE CONFIGURACIÓN */
        .gear-btn {
            position: absolute; right: 20px; top: 25px;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; border-color: var(--cyan); color: var(--cyan);
            z-index: 101; padding: 0;
        }
        .gear-btn:hover { background: var(--cyan); color: #000; transform: rotate(90deg); }

        /* === MENÚ DE AJUSTES (MODAL) === */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #settings-modal.active { display: flex; opacity: 1; }

        .settings-panel {
            background: #0a0a12; border: 2px solid var(--cyan);
            width: 90%; max-width: 350px; padding: 25px; border-radius: 12px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(255,255,255,0.05);
        }
        .st-row { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .st-label { font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Controles de Formulario Personalizados */
        input[type=range] {
            width: 50%; accent-color: var(--cyan); cursor: pointer;
        }
        input[type=checkbox] {
            width: 20px; height: 20px; accent-color: var(--pink); cursor: pointer;
        }
        
        .close-st-btn {
            width: 100%; padding: 12px; background: var(--cyan); color: #000;
            border: none; font-weight: 900; cursor: pointer; text-transform: uppercase;
            margin-top: 10px;
        }

        /* === ESCENARIO 3D === */
        #scene {
            width: 100%; height: 100%; perspective: 800px; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, transparent 15%, black 40%, black 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, transparent 15%, black 40%, black 100%);
        }

        #floor {
            display: grid; justify-content: center;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--gap); width: 115%; 
            transform: rotateX(45deg) rotateZ(0deg) translateY(0px);
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 150px 20px 300px 20px; 
            max-height: 100vh; overflow-y: auto; 
            scrollbar-width: none; -ms-overflow-style: none;
        }
        #floor::-webkit-scrollbar { display: none; }

        /* === MOSAICOS === */
        .tile {
            width: 100%; height: 120px; 
            position: relative; transform-style: preserve-3d; cursor: pointer;
            opacity: 0; animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popUp { 0% { opacity: 0; transform: translateZ(-200px); } 100% { opacity: 1; transform: translateZ(0); } }

        .tile-inner {
            position: absolute; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.3, 1.5, 0.5, 1), box-shadow 0.6s ease;
            transform-style: preserve-3d;
            background: #0a0a10;
            border: 2px solid rgba(255, 255, 255, 0.1); 
            border-color: rgba(255,255,255,0.3); /* Base neutra */
            box-shadow: 0 6px 0 #000, 0 15px 25px rgba(0,0,0,0.6);
        }

        /* El color del borde reacciona a la variable CSS dinámica */
        .tile:hover .tile-inner {
            border-color: var(--cyan);
            box-shadow: 0 6px 0 #000, 0 15px 35px var(--cyan), inset 0 0 30px var(--cyan);
        }

        .tile.flipped .tile-inner {
            transform: rotateY(180deg); z-index: 10;
            border-color: var(--back-color);
            box-shadow: 0 6px 0 #000, 0 0 40px var(--back-color), inset 0 0 30px rgba(255,255,255,0.2);
        }

        .face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; text-align: center; user-select: none; box-sizing: border-box; overflow: hidden;
        }

        .face.front {
            transform: rotateY(0deg) translateZ(1px); 
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(0,0,0,0.9));
            color: var(--cyan); text-shadow: 0 0 8px var(--cyan);
        }
        .face.front::after {
            content:''; position: absolute; bottom: 8px; width: 30%; height: 2px;
            background: var(--cyan); box-shadow: 0 0 10px var(--cyan); opacity: 0.7;
        }

        .face.back {
            background: var(--back-color); transform: rotateY(180deg) translateZ(1px); 
            color: #000; text-shadow: 0 1px 0 rgba(255,255,255,0.4);
            border: 4px solid rgba(0,0,0,0.3); 
        }

        .icon-type { font-size: 28px; margin-bottom: 8px; filter: drop-shadow(0 0 5px var(--cyan)); }
        
        .word-text { 
            text-transform: uppercase; line-height: 1.1; font-weight: 900; 
            width: 100%; word-wrap: break-word; hyphens: auto;
            /* Escalado dinámico desde configuración */
            transform: scale(var(--txt-scale)); 
        }
        .sub-text { font-size: 9px; opacity: 0.8; margin-top: 5px; font-weight: 600; color:white; letter-spacing: 1px; }

        .verb-stack { display:flex; flex-direction:column; gap:2px; width:100%; height:100%; justify-content:center; transform: scale(var(--txt-scale));}
        .verb-row { border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 2px; margin-bottom: 2px; }
        .verb-row:last-child { border-bottom: none; margin-bottom: 0; }
        .verb-tag { font-size: 7px; opacity: 0.6; text-transform: uppercase; font-weight: 700; display:block; letter-spacing: 1px;}
        .verb-word { font-size: 11px; font-weight: 900; text-transform: uppercase; display:block; line-height: 1;}
        .verb-trans { font-size: 10px; font-style: italic; margin-bottom: 4px; font-weight: 600; background:rgba(255,255,255,0.3); padding:2px; border-radius:4px; display:inline-block;}

        #loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--cyan); font-weight:900; letter-spacing: 2px; animation:pulse 1s infinite; pointer-events:none;}
        @keyframes pulse { 0%{opacity:0.3} 50%{opacity:1} 100%{opacity:0.3} }
    </style>
</head>
<body>

    <script src="https://paradisonetworx.com/database.js"></script>

    <div id="hud">
        <button class="hud-btn back-btn" onclick="initFolderView()">←</button>
        <div class="title" id="page-title">SYSTEM LOADING...</div>
        <button class="hud-btn gear-btn" onclick="toggleSettings()">⚙</button>
    </div>

    <div id="settings-modal">
        <div class="settings-panel">
            <div style="text-align:center; color:var(--cyan); font-weight:900; margin-bottom:20px; font-size:18px;">SYSTEM CONFIG</div>
            
            <div class="st-row">
                <span class="st-label">AUDIO ENABLED</span>
                <input type="checkbox" id="st-audio" checked onchange="updateSettings()">
            </div>

            <div class="st-row">
                <span class="st-label">VOICE SPEED</span>
                <input type="range" id="st-speed" min="0.5" max="1.5" step="0.1" value="1.0" oninput="updateSettings()">
            </div>

            <div class="st-row">
                <span class="st-label">NEON COLOR</span>
                <input type="range" id="st-hue" min="0" max="360" value="180" oninput="updateSettings()">
            </div>

            <div class="st-row">
                <span class="st-label">TEXT SIZE</span>
                <input type="range" id="st-size" min="0.8" max="1.3" step="0.1" value="1.0" oninput="updateSettings()">
            </div>

            <button class="close-st-btn" onclick="toggleSettings()">APPLY & CLOSE</button>
        </div>
    </div>

    <div id="loading">CONNECTING TO DATABASE...</div>

    <div id="scene">
        <div id="floor"></div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURACIÓN (SETTINGS)
        // ==========================================
        const appConfig = {
            audio: true,
            speed: 1.0,
            hue: 180,
            scale: 1.0
        };

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isActive = modal.classList.contains('active');
            if (isActive) modal.classList.remove('active');
            else modal.classList.add('active');
        }

        function updateSettings() {
            appConfig.audio = document.getElementById('st-audio').checked;
            appConfig.speed = parseFloat(document.getElementById('st-speed').value);
            appConfig.hue = document.getElementById('st-hue').value;
            appConfig.scale = document.getElementById('st-size').value;

            // Aplicar variables CSS en vivo
            document.documentElement.style.setProperty('--hue', appConfig.hue);
            document.documentElement.style.setProperty('--txt-scale', appConfig.scale);
        }

        // ==========================================
        // 2. GESTIÓN DE DATOS & MEMORIA
        // ==========================================
        let db = [];
        const neonColors = ['var(--neon-1)', 'var(--neon-2)', 'var(--neon-3)', 'var(--neon-4)', 'var(--neon-5)', 'var(--neon-6)'];
        let activeList = [];      
        let renderIndex = 0;      
        let currentMode = '';     
        const BATCH_SIZE = 30;    

        function clean(txt) { if (!txt) return ""; return String(txt).split('/')[0].trim(); }

        function getSmartFontSize(text) {
            const len = text.length;
            if (len <= 5) return '18px';  
            if (len <= 10) return '14px'; 
            if (len <= 18) return '12px'; 
            return '10px';                  
        }

        async function initDB() {
            let customData = [];
            try { const raw = localStorage.getItem('mdc_vocab_list'); if(raw) customData = JSON.parse(raw); } catch(e) {}

            return new Promise(resolve => {
                const check = setInterval(() => {
                    if (typeof INTERNAL_VOCAB !== 'undefined') {
                        clearInterval(check);
                        const officialFolders = Object.keys(INTERNAL_VOCAB).map(key => {
                            return {
                                id: key,
                                isFolder: true,
                                name: key.replace(/_/g, ' '),
                                type: 'official',
                                items: INTERNAL_VOCAB[key].map(item => ({
                                    eng: clean(item.en),
                                    esp: item.es,
                                    past: item.past ? clean(item.past) : null,
                                    part: item.part ? clean(item.part) : null
                                }))
                            };
                        });
                        db = [...officialFolders, ...customData];
                        resolve();
                    }
                }, 100);
            });
        }

        // ==========================================
        // 3. MOTOR RENDER
        // ==========================================
        const floor = document.getElementById('floor');
        const title = document.getElementById('page-title');
        const backBtn = document.querySelector('.back-btn');
        const loading = document.getElementById('loading');

        floor.addEventListener('scroll', () => {
            if (floor.scrollTop + floor.clientHeight >= floor.scrollHeight - 300) {
                loadNextBatch();
            }
        });

        function initFolderView() {
            floor.innerHTML = ''; floor.scrollTop = 0;
            title.innerText = "NEON DATABASE";
            title.style.color = "var(--cyan)";
            backBtn.classList.remove('visible');
            floor.style.transform = "rotateX(45deg) translateY(0px)";
            
            const folders = db.filter(i => i.isFolder);
            const loose = db.filter(i => !i.isFolder);
            activeList = [];
            if (loose.length > 0) activeList.push({ name: "MY SAVED", count: loose.length, id: 'root', type: 'hub' });
            folders.forEach((f) => {
                const isOfficial = f.type === 'official';
                activeList.push({ name: f.name, count: f.items.length, id: f.id, type: isOfficial ? 'official' : 'custom' });
            });

            currentMode = 'folder';
            renderIndex = 0;
            loadNextBatch();
        }

        function openFolder(id) {
            floor.innerHTML = ''; floor.scrollTop = 0;
            backBtn.classList.add('visible');
            floor.style.transform = "rotateX(45deg) translateY(0px)";

            let items = [], folderName = "";
            if (id === 'root') { items = db.filter(i => !i.isFolder); folderName = "MY SAVED"; } 
            else { const f = db.find(i => i.id === id); if (f) { items = f.items; folderName = f.name; }}

            title.innerText = folderName;
            title.style.color = "white";
            
            if(items.length === 0) {
                floor.innerHTML = `<div style="grid-column:1/-1; text-align:center; opacity:0.5; margin-top:100px;">EMPTY SECTOR</div>`;
                return;
            }

            activeList = items;
            currentMode = 'word';
            renderIndex = 0;
            loadNextBatch();
        }

        function loadNextBatch() {
            if (renderIndex >= activeList.length) return;
            const endIndex = Math.min(renderIndex + BATCH_SIZE, activeList.length);
            for (let i = renderIndex; i < endIndex; i++) {
                const item = activeList[i];
                if (currentMode === 'folder') createTile(item, i);
                else createWordTile(item, i);
            }
            renderIndex = endIndex;
        }

        // ==========================================
        // 4. GENERADORES
        // ==========================================

        function createTile(data, index) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            if(index < 15) tile.style.animationDelay = `${(index % 10) * 0.05}s`;
            else tile.style.animation = 'none'; 
            if(index >= 15) tile.style.opacity = 1;

            let icon = '◆'; 
            if (data.type === 'official') icon = '❖'; 
            if (data.type === 'hub') icon = '★'; 
            
            tile.innerHTML = `
                <div class="tile-inner">
                    <div class="face front" style="border-bottom-color:var(--cyan);">
                        <div class="icon-type">${icon}</div>
                        <div class="word-text" style="font-size:12px;">${data.name}</div>
                        <div class="sub-text">${data.count} UNITS</div>
                    </div>
                    <div class="face back"></div>
                </div>
            `;
            tile.onclick = () => {
                document.querySelectorAll('.tile').forEach(t => t.style.transform = "scale(0) translateZ(-100px)");
                setTimeout(() => openFolder(data.id), 400);
            };
            floor.appendChild(tile);
        }

        function createWordTile(item, index) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            if(index < 15) tile.style.animationDelay = `${(index % 10) * 0.03}s`;
            else { tile.style.animation = 'none'; tile.style.opacity = 1; }

            const eng = item.eng || "?";
            const esp = item.esp || "...";
            const randomColor = neonColors[Math.floor(Math.random() * neonColors.length)];
            tile.style.setProperty('--back-color', randomColor);

            const isIrregular = (item.past && item.part);
            const fontSizeEng = getSmartFontSize(eng);
            const fontSizeEsp = getSmartFontSize(esp);

            let backHTML = '';
            if (isIrregular) {
                backHTML = `
                    <div class="verb-stack">
                        <div class="verb-trans">${esp.substring(0,15)}</div>
                        <div class="verb-row"><span class="verb-tag">BASE</span><span class="verb-word">${eng}</span></div>
                        <div class="verb-row"><span class="verb-tag">PAST</span><span class="verb-word">${item.past}</span></div>
                        <div class="verb-row"><span class="verb-tag">PART</span><span class="verb-word">${item.part}</span></div>
                    </div>
                `;
            } else {
                backHTML = `<div class="word-text" style="font-size:${fontSizeEsp}">${esp}</div>`;
            }

            tile.innerHTML = `
                <div class="tile-inner">
                    <div class="face front">
                        <div class="word-text" style="font-size:${fontSizeEng}">${eng}</div>
                    </div>
                    <div class="face back">
                        ${backHTML}
                    </div>
                </div>
            `;

            tile.onclick = () => {
                const isAlreadyFlipped = tile.classList.contains('flipped');
                if (isAlreadyFlipped) {
                    tile.classList.remove('flipped');
                    return;
                }
                const currentOpen = document.querySelector('.tile.flipped');
                if (currentOpen) currentOpen.classList.remove('flipped');

                tile.classList.add('flipped');

                if (isIrregular) speakSequence([eng, item.past, item.part]);
                else speak(eng, 'en-US');
            };
            floor.appendChild(tile);
        }

        // ==========================================
        // 5. AUDIO SYSTEM
        // ==========================================
        function speak(text, lang) {
            if (!appConfig.audio) return; // Respetar configuración
            
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang; 
            u.rate = appConfig.speed; // Respetar velocidad
            
            const voices = window.speechSynthesis.getVoices();
            if(lang === 'en-US') {
                const v = voices.find(voice => voice.name.includes('Google US English') || voice.lang === 'en-US');
                if(v) u.voice = v;
            }
            window.speechSynthesis.speak(u);
        }

        function speakSequence(words) {
            if (!appConfig.audio) return;
            window.speechSynthesis.cancel();
            let i = 0;
            function next() {
                if (i >= words.length) return;
                const u = new SpeechSynthesisUtterance(words[i]);
                u.lang = 'en-US'; 
                u.rate = appConfig.speed;
                
                const voices = window.speechSynthesis.getVoices();
                const v = voices.find(voice => voice.name.includes('Google US English') || voice.lang === 'en-US');
                if(v) u.voice = v;
                
                u.onend = () => { i++; setTimeout(next, 300); };
                window.speechSynthesis.speak(u);
            }
            next();
        }

        // INICIO
        initDB().then(() => {
            loading.style.display = 'none';
            initFolderView();
        });

    </script>
</body>
</html>
