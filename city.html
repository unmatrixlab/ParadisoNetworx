<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON MOSAIC | Perfect Fit</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --tile-size: 140px;
            --gap: 25px; 
            --cyan: #00f3ff;
            --pink: #ff00ff;
            --purple: #bc13fe;
            --dark: #050508;
            
            /* Paleta de colores neón para el reverso */
            --neon-1: #ff0055; --neon-2: #00ff99; --neon-3: #ffcc00; 
            --neon-4: #9900ff; --neon-5: #00ccff; --neon-6: #ff3300;
        }

        body {
            margin: 0; background-color: var(--dark);
            background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, var(--dark) 80%);
            height: 100vh; overflow: hidden; font-family: 'Montserrat', sans-serif;
            color: white; display: flex; flex-direction: column; align-items: center;
        }

        /* === HUD SUPERIOR === */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; box-sizing: border-box; z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: none;
        }
        .title { 
            font-weight: 900; letter-spacing: 2px; text-transform: uppercase; 
            text-shadow: 0 0 20px var(--cyan); color: var(--cyan); pointer-events: auto;
        }
        .back-btn {
            background: rgba(0,0,0,0.6); border: 2px solid var(--pink);
            color: var(--pink); padding: 10px 25px; border-radius: 4px;
            cursor: pointer; font-weight: 900; text-transform: uppercase;
            transition: 0.3s; opacity: 0; pointer-events: auto; transform: translateY(-20px);
        }
        .back-btn.visible { opacity: 1; transform: translateY(0); }
        .back-btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 25px var(--pink); }

        /* === ESCENARIO 3D === */
        #scene {
            width: 100%; height: 100%; 
            perspective: 1500px; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden;
        }

        #floor {
            display: grid; 
            /* Centrado horizontal de la grilla */
            justify-content: center;
            grid-template-columns: repeat(auto-fill, var(--tile-size));
            gap: var(--gap); 
            
            width: 100%; max-width: 1200px;
            
            /* Inclinación isométrica */
            transform: rotateX(40deg) rotateZ(0deg) translateY(50px);
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            
            padding: 50px 20px 250px 20px; /* Margen inferior extra para scroll */
            max-height: 100vh; overflow-y: auto; 
            scrollbar-width: none; -ms-overflow-style: none;
        }
        #floor::-webkit-scrollbar { display: none; }

        /* === MOSAICOS === */
        .tile {
            width: var(--tile-size); height: var(--tile-size);
            position: relative; transform-style: preserve-3d; cursor: pointer;
            opacity: 0; animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popUp { 0% { opacity: 0; transform: translateZ(-200px); } 100% { opacity: 1; transform: translateZ(0); } }

        /* EL BLOQUE 3D */
        .tile-inner {
            position: absolute; width: 100%; height: 100%;
            transition: transform 0.8s cubic-bezier(0.3, 1.5, 0.5, 1), box-shadow 0.8s ease;
            transform-style: preserve-3d;
            background: #0a0a10;
            border: 2px solid rgba(0, 243, 255, 0.2); 
            box-shadow: 0 4px 0 #000, 0 10px 20px rgba(0,0,0,0.5), inset 0 0 20px rgba(0, 243, 255, 0.1);
        }

        .tile:hover .tile-inner {
            border-color: var(--cyan);
            box-shadow: 0 4px 0 #000, 0 10px 30px rgba(0, 243, 255, 0.2), inset 0 0 30px rgba(0, 243, 255, 0.3);
        }

        /* ESTADO GIRADO (FLIPPED) */
        .tile.flipped .tile-inner {
            transform: rotateY(180deg); 
            z-index: 10;
            border-color: var(--back-color);
            box-shadow: 0 4px 0 #000, 0 0 30px var(--back-color), inset 0 0 20px rgba(255,255,255,0.2);
        }

        /* CARAS */
        .face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px; /* MARGEN INTERNO SEGURO */
            text-align: center; 
            user-select: none; box-sizing: border-box;
            overflow: hidden; /* Cortar si algo se sale extremadamente */
        }

        .face.front {
            transform: rotateY(0deg) translateZ(1px); 
            background: linear-gradient(135deg, rgba(0,243,255,0.1), rgba(0,0,0,0.8));
            color: var(--cyan);
            text-shadow: 0 0 5px rgba(0,243,255,0.5);
        }
        
        .face.front::after {
            content:''; position: absolute; bottom: 10px; width: 40%; height: 2px;
            background: var(--cyan); box-shadow: 0 0 10px var(--cyan); opacity: 0.5;
        }

        .face.back {
            background: var(--back-color);
            transform: rotateY(180deg) translateZ(1px); 
            color: #000; text-shadow: 0 1px 0 rgba(255,255,255,0.4);
            border: 4px solid rgba(0,0,0,0.2); 
        }

        /* Tipografía Dinámica */
        .icon-type { font-size: 32px; margin-bottom: 10px; }
        .word-text { 
            text-transform: uppercase; 
            line-height: 1.2; 
            font-weight: 900; 
            width: 100%;
            word-wrap: break-word; /* Romper palabras largas si es necesario */
            hyphens: auto;
        }
        .sub-text { font-size: 10px; opacity: 0.7; margin-top: 5px; font-weight: 500; color:white; }
        
        #loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--cyan); font-weight:900; animation:pulse 1s infinite; pointer-events:none;}
        @keyframes pulse { 0%{opacity:0.5} 50%{opacity:1} 100%{opacity:0.5} }
    </style>
</head>
<body>

    <script src="https://paradisonetworx.com/database.js"></script>

    <div id="hud">
        <div class="title" id="page-title">SYSTEM LOADING...</div>
        <button class="back-btn" onclick="renderFolders()">← MAIN MENU</button>
    </div>

    <div id="loading">CONNECTING TO DATABASE...</div>

    <div id="scene">
        <div id="floor"></div>
    </div>

    <script>
        // ==========================================
        // 1. GESTIÓN DE DATOS 
        // ==========================================
        let db = [];
        const neonColors = ['var(--neon-1)', 'var(--neon-2)', 'var(--neon-3)', 'var(--neon-4)', 'var(--neon-5)', 'var(--neon-6)'];

        function clean(txt) { 
            if (!txt) return ""; 
            return String(txt).split('/')[0].trim(); 
        }

        // Calcula el tamaño de fuente ideal basado en la longitud del texto
        function getSmartFontSize(text) {
            const len = text.length;
            if (len <= 6) return '20px';  // Palabras muy cortas (Big)
            if (len <= 12) return '16px'; // Palabras normales
            if (len <= 20) return '13px'; // Frases cortas
            if (len <= 40) return '11px'; // Frases medias
            return '9px';                 // Frases largas (Tiny)
        }

        async function initDB() {
            let customData = [];
            try {
                const raw = localStorage.getItem('mdc_vocab_list');
                if(raw) customData = JSON.parse(raw);
            } catch(e) {}

            return new Promise(resolve => {
                const check = setInterval(() => {
                    if (typeof INTERNAL_VOCAB !== 'undefined') {
                        clearInterval(check);
                        
                        const officialFolders = Object.keys(INTERNAL_VOCAB).map(key => {
                            return {
                                id: key,
                                isFolder: true,
                                name: key.replace(/_/g, ' '),
                                type: 'official',
                                items: INTERNAL_VOCAB[key].map(item => ({
                                    eng: clean(item.en),
                                    esp: item.es
                                }))
                            };
                        });

                        db = [...officialFolders, ...customData];
                        resolve();
                    }
                }, 100);
            });
        }

        // ==========================================
        // 2. MOTOR RENDER
        // ==========================================
        const floor = document.getElementById('floor');
        const title = document.getElementById('page-title');
        const backBtn = document.querySelector('.back-btn');
        const loading = document.getElementById('loading');

        function renderFolders() {
            floor.innerHTML = ''; 
            title.innerText = "NEON DATABASE";
            title.style.color = "var(--cyan)";
            backBtn.classList.remove('visible');
            
            // Vista de carpetas: Inclinada
            floor.style.transform = "rotateX(40deg) translateY(50px)";
            // Centrado automático con CSS grid
            floor.style.gridTemplateColumns = "repeat(auto-fill, 160px)"; 

            const folders = db.filter(i => i.isFolder);
            const loose = db.filter(i => !i.isFolder);

            if (loose.length > 0) createTile({ name: "MY SAVED WORDS", count: loose.length, id: 'root', type: 'hub' }, 0);
            
            folders.forEach((f, index) => {
                const isOfficial = f.type === 'official';
                createTile({ 
                    name: f.name, 
                    count: f.items.length, 
                    id: f.id, 
                    type: isOfficial ? 'official' : 'custom' 
                }, index + 1);
            });
        }

        function openFolder(id) {
            floor.innerHTML = ''; 
            backBtn.classList.add('visible');
            
            // Vista de palabras: Más plana para leer bien
            floor.style.transform = "rotateX(30deg) translateY(0px)";
            floor.style.gridTemplateColumns = "repeat(auto-fill, 140px)";

            let items = [], folderName = "";
            
            if (id === 'root') { 
                items = db.filter(i => !i.isFolder); 
                folderName = "MY SAVED WORDS"; 
            } else { 
                const f = db.find(i => i.id === id); 
                if (f) { items = f.items; folderName = f.name; }
            }

            title.innerText = folderName;
            title.style.color = "white";
            
            if(items.length === 0) {
                floor.innerHTML = `<div style="grid-column:1/-1; text-align:center; opacity:0.5; margin-top:50px; font-weight:bold;">EMPTY FOLDER</div>`;
            }

            items.forEach((item, index) => createWordTile(item, index));
        }

        // ==========================================
        // 3. GENERADORES DE MOSAICOS
        // ==========================================

        function createTile(data, index) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.style.animationDelay = `${index * 0.05}s`;
            
            let icon = '◆'; 
            let color = 'var(--cyan)';
            
            if (data.type === 'official') { icon = '❖'; color = 'var(--purple)'; }
            if (data.type === 'hub') { icon = '★'; color = 'var(--pink)'; }
            
            tile.innerHTML = `
                <div class="tile-inner">
                    <div class="face front" style="color:${color}; border-bottom-color:${color};">
                        <div class="icon-type">${icon}</div>
                        <div class="word-text" style="font-size:12px;">${data.name}</div>
                        <div class="sub-text">${data.count} UNITS</div>
                    </div>
                    <div class="face back"></div>
                </div>
            `;
            tile.onclick = () => {
                document.querySelectorAll('.tile').forEach(t => t.style.transform = "scale(0) translateZ(-100px)");
                setTimeout(() => openFolder(data.id), 400);
            };
            floor.appendChild(tile);
        }

        function createWordTile(item, index) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.style.animationDelay = `${index * 0.03}s`;

            const eng = item.eng || "?";
            const esp = item.esp || "...";
            
            // Color aleatorio para este mosaico
            const randomColor = neonColors[Math.floor(Math.random() * neonColors.length)];
            tile.style.setProperty('--back-color', randomColor);

            // Calcular tamaño de fuente inteligente
            const fontSizeEng = getSmartFontSize(eng);
            const fontSizeEsp = getSmartFontSize(esp);

            tile.innerHTML = `
                <div class="tile-inner">
                    <div class="face front">
                        <div class="word-text" style="font-size:${fontSizeEng}">${eng}</div>
                    </div>
                    <div class="face back">
                        <div class="word-text" style="font-size:${fontSizeEsp}">${esp}</div>
                    </div>
                </div>
            `;

            tile.onclick = () => {
                const isAlreadyFlipped = tile.classList.contains('flipped');
                
                // 1. Cerrar si ya está abierto
                if (isAlreadyFlipped) {
                    tile.classList.remove('flipped');
                    return;
                }
                
                // 2. Cerrar cualquier otro
                const currentOpen = document.querySelector('.tile.flipped');
                if (currentOpen) currentOpen.classList.remove('flipped');

                // 3. Abrir este y hablar
                tile.classList.add('flipped');
                speak(eng, 'en-US');
            };
            floor.appendChild(tile);
        }

        // ==========================================
        // 4. AUDIO
        // ==========================================
        function speak(text, lang) {
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang; u.rate = 1.0; 
            const voices = window.speechSynthesis.getVoices();
            if(lang === 'en-US') {
                const v = voices.find(voice => voice.name.includes('Google US English') || voice.lang === 'en-US');
                if(v) u.voice = v;
            }
            window.speechSynthesis.speak(u);
        }

        // INICIO
        initDB().then(() => {
            loading.style.display = 'none';
            renderFolders();
        });

    </script>
</body>
</html>
