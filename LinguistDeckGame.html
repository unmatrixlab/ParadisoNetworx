<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocabulary Hunter: Final Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #0f0;
            --neon-red: #ff4444;
            --neon-blue: #4f46e5;
            --neon-yellow: #ffff00;
            --dark-bg: #050505;
            --panel-bg: rgba(0, 15, 0, 0.95);
        }
        body {margin:0;overflow:hidden;background:var(--dark-bg);font-family:'Press Start 2P',monospace;color:white;user-select:none;touch-action:none;}
        canvas {display:block;}
        /* SCANLINES */
        .scanlines {
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,255,255,0) 50%,rgba(0,0,0,0.1) 50%,rgba(0,0,0,0.1));
            background-size:100% 4px;z-index:999;pointer-events:none;
        }
        
        #ui {position:absolute;top:10px;left:10px;right:10px;z-index:10;pointer-events:none;display:flex;justify-content:space-between;text-shadow:2px 2px 0 #000; font-size: 10px;}
        #lives-panel {color:var(--neon-red);}
        #score-panel {color:var(--neon-green);}
        
        /* CONTROLES MÓVILES */
        #mobile-controls {
            display: none; 
            position: absolute; 
            bottom: 20px; 
            width: 100%;
            justify-content: space-between; 
            padding: 0 20px; 
            box-sizing: border-box;
            z-index: 20; 
            pointer-events: none;
            align-items: flex-end; 
        }

        .touch-group { display: flex; gap: 20px; pointer-events: auto; }

        /* GRUPO IZQUIERDO (Flechas Verdes): 150px arriba */
        .touch-group:first-child {
            margin-bottom: 150px; 
        }

        /* GRUPO DERECHO (Botón Rojo): 90px arriba */
        .touch-group:last-child {
            margin-bottom: 90px;
        }

        .touch-btn {
            width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.1); border: 2px solid var(--neon-green);
            border-radius: 50%; color: var(--neon-green); font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none;
            text-shadow: 2px 2px 0 #000;
        }
        .touch-btn:active { background: var(--neon-green); color: #000; }
        .btn-fire { border-color: var(--neon-red); color: var(--neon-red); }
        .btn-fire:active { background: var(--neon-red); color: #000; }

        @media (max-width: 768px) or (pointer: coarse) {
            #mobile-controls { display: flex; }
            #category-bar-wrapper { bottom: 100px; } 
            h1 { font-size: 20px; }
            p { font-size: 10px; line-height: 1.5; }
        }

        /* BARRA INFERIOR */
        #category-bar-wrapper {
            position:absolute; bottom:30px; left:0; width:100%; padding:10px 0;
            background:rgba(0,0,0,0.85); z-index:15; overflow-x:auto; white-space:nowrap;
            display:flex; justify-content:center; border-top:1px solid #333;
            box-shadow:0 -5px 15px rgba(0,255,0,0.1);
        }
        .category-chip {
            padding:8px 16px; margin:0 8px; background:#111; color:#666;
            font-size:10px; cursor:pointer; border:1px solid #444; transition:.2s;
            pointer-events:all; display:inline-block;
        }
        .category-chip:hover { border-color:#888; color:#888; }
        .category-chip.active {
            color:var(--neon-green); background:#002200;
            border-color:var(--neon-green); box-shadow:0 0 10px var(--neon-green);
        }
        .category-chip.help-btn { border-color:var(--neon-yellow); color:var(--neon-yellow); }
        .category-chip.help-btn:hover { background:#222200; box-shadow:0 0 10px var(--neon-yellow); }
        
        /* OVERLAYS */
        .overlay-screen {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
        h1 {color:var(--neon-green);text-shadow:4px 4px #003300;font-size:35px;margin-bottom:20px;line-height:1.5;}
        h2 {color:var(--neon-red);font-size:30px;margin-bottom:20px;text-shadow:3px 3px 0 #300;}
        p {line-height:2;color:#aaa;font-size:12px;max-width:600px;padding:0 20px;}
        .key-hint {display:inline-block;padding:2px 6px;border:1px solid #666;border-radius:4px;color:#fff;background:#222;font-size:10px;}
        .blink {animation:blinker 1s linear infinite;color:var(--neon-yellow);margin-top:40px;font-size:14px;cursor:pointer;}
        @keyframes blinker {50%{opacity:0;}}
        
        /* POP QUIZ MODAL */
        #quiz-overlay {
            background: rgba(0, 10, 0, 0.98); border: 4px solid var(--neon-red);
            padding: 20px; border-radius: 10px; max-width: 600px; width: 90%;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.2);
            transition: border-color 0.3s;
            display: flex; flex-direction: column; align-items: center;
        }
        #quiz-question { font-size: 16px; color: var(--neon-blue); margin: 20px 0; line-height: 1.5; word-break: break-word;}
        #quiz-input {
            background: #000; border: 2px solid #333; color: #fff;
            padding: 15px; font-family: 'Press Start 2P'; font-size: 14px;
            text-align: center; width: 90%; text-transform: uppercase;
        }
        #quiz-input:focus { border-color: var(--neon-green); outline: none; }
        
        #quiz-feedback { 
            margin-top: 20px; min-height: 30px; font-size: 10px; 
            color: var(--neon-yellow); line-height: 1.6; text-align: center;
        }
        .correct-ans-highlight {
            color: #fff; background: var(--neon-red); padding: 5px 10px; display: inline-block; margin-top: 5px; border-radius: 4px;
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .quiz-actions { display: flex; gap: 10px; margin-top: 15px; width: 100%; justify-content: center; }
        .quiz-btn {
            padding: 15px; font-family: 'Press Start 2P'; cursor: pointer; font-size: 10px; border: 2px solid;
            background: transparent; color: #fff; flex: 1;
        }
        .btn-verify { border-color: var(--neon-green); color: var(--neon-green); }
        .btn-verify:hover { background: var(--neon-green); color: #000; }
        .btn-skip { border-color: #555; color: #777; font-size: 8px; }
        .btn-skip:hover { border-color: var(--neon-red); color: var(--neon-red); }

        /* MODAL */
        #study-content {
            background:var(--panel-bg); padding:20px; border:2px solid var(--neon-green);
            width:90%; max-width:800px; height:80%; display: flex; flex-direction: column;
            position:relative; box-shadow:0 0 30px rgba(0,255,0,0.2); text-align:left;
        }
        .tabs-header { display: flex; border-bottom: 2px solid var(--neon-green); margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 10px; cursor: pointer; text-align: center; font-size: 10px;
            background: transparent; border: none; color: #666; font-family: 'Press Start 2P'; transition: 0.2s;
        }
        .tab-btn:hover { background: #002200; color: #fff; }
        .tab-btn.active { background: var(--neon-green); color: #000; font-weight: bold; }
        .tab-content { flex: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        
        table {width:100%;border-collapse:separate;border-spacing:0;font-size:10px;}
        th {color:var(--neon-green);text-align:left;border-bottom:2px solid var(--neon-green);padding:10px;position:sticky;top:0;background:#001500;z-index:2;}
        td {padding:12px 10px;border-bottom:1px solid #333;color:#aaa;}
        tr:hover td {background:#002200;color:#fff;cursor:crosshair;}
        .en-word {color:var(--neon-blue);font-weight:bold;}
        .chk-cell { width: 40px; text-align: center; }
        input[type=checkbox] { width: 18px; height: 18px; accent-color: var(--neon-green); cursor: pointer; }

        .config-header { color:var(--neon-green); margin-top:0; text-transform:uppercase; border-bottom:1px solid #333; padding-bottom:10px; font-size:14px; margin-bottom: 20px; }
        .config-group { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .config-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 10px; color: #ddd; align-items: center;}
        .config-val { color: var(--neon-yellow); }
        .slider-desc { font-size: 8px; color: #666; margin-top: 5px; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--neon-green); }
        input[type=color] { cursor: pointer; border: none; width: 50px; height: 30px; }
        select { width: 100%; padding: 10px; background: #111; color: var(--neon-green); border: 1px solid var(--neon-green); font-family: 'Press Start 2P'; font-size: 10px; cursor: pointer; margin-top: 5px; }
        select:focus { outline: none; background: #222; }
        .reset-btn { width: 100%; padding: 15px; background: #330000; color: var(--neon-red); border: 1px solid var(--neon-red); font-family: 'Press Start 2P'; cursor: pointer; margin-top: 20px; font-size: 10px; }
        .reset-btn:hover { background: var(--neon-red); color: #000; }
        .close-btn {position:absolute;top:15px;right:20px;font-size:20px;color:var(--neon-red);cursor:pointer;border:1px solid var(--neon-red);padding:5px 10px;z-index:10;background: transparent; border-radius: 0; width: auto; height: auto;}
        .close-btn:hover {background:var(--neon-red);color:#000;}
        
        ::-webkit-scrollbar {width:10px;}
        ::-webkit-scrollbar-track {background:#111;}
        ::-webkit-scrollbar-thumb {background:#333;border:1px solid var(--neon-green);}
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="ui">
        <div id="score-panel">SCORE: <span id="score">0</span> | COMBO: <span id="combo">0</span></div>
        <div id="lives-panel">LIVES: <span id="lives">5</span></div>
        <div id="high-score-panel">HIGH: <span id="highScore">0</span></div>
    </div>
    
    <div id="mobile-controls">
        <div class="touch-group">
            <div class="touch-btn" id="btn-left">←</div>
            <div class="touch-btn" id="btn-right">→</div>
        </div>
        <div class="touch-group">
            <div class="touch-btn btn-fire" id="btn-fire">●</div>
        </div>
    </div>

    <div id="category-bar-wrapper"></div>

    <div id="start-screen" class="overlay-screen" onclick="startGame()">
        <h1>VOCAB ROBOT</h1>
        <p>
            1. Enemies drop English words & <strong>Bombs</strong>.<br>
            2. Shoot 3 times to Translate -> 1 time to Destroy.<br>
            3. Shoot Parachutes to hear them.<br><br>
            <span class="key-hint">← →</span> Move &nbsp;&nbsp; <span class="key-hint">SPACE</span> Shoot
        </p>
        <div class="blink">CLICK / TAP TO START</div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;" onclick="startGame()">
        <h2>MISSION FAILED</h2>
        <p>FINAL SCORE: <span id="finalScore" style="color:white;">0</span></p>
        <div class="blink">CLICK TO RETRY</div>
    </div>

    <div id="quiz-screen" class="overlay-screen" style="display:none;">
        <div id="quiz-overlay">
            <h2 style="color:var(--neon-red);" id="quiz-title">SYSTEM HACK DETECTED!</h2>
            <p style="font-size:10px; color:#aaa;">TRANSLATE TO RESTORE SYSTEMS</p>
            <div id="quiz-question">WORD</div>
            <input type="text" id="quiz-input" placeholder="TYPE TRANSLATION" autocomplete="off">
            <div id="quiz-feedback"></div>
            
            <div class="quiz-actions">
                <button class="quiz-btn btn-skip" onclick="skipQuiz()">FORCE REBOOT (-500 PTS)</button>
                <button class="quiz-btn btn-verify" onclick="checkQuizAnswer()">VERIFY REPAIR</button>
            </div>
        </div>
    </div>

    <div id="study-guide" class="overlay-screen" style="display:none;">
        <div id="study-content">
            <span class="close-btn" onclick="toggleStudyGuide()">X</span>
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('db')">DATABASE</button>
                <button class="tab-btn" onclick="switchTab('settings')">SETTINGS</button>
            </div>
            
            <div id="tab-db" class="tab-content active">
                <h2 id="db-title" class="config-header">ACTIVE VOCABULARY</h2>
                
                <div class="config-group" style="margin-bottom: 10px;">
                    <label class="config-label">DATA USAGE LIMIT<span id="lbl-percent" class="config-val">100%</span></label>
                    <input type="range" id="mini-slider-percent" min="1" max="100" value="100" oninput="updateDataPercent(this.value)">
                    <div class="slider-desc"><span>START</span><span>ALL DATA</span></div>
                </div>

                <div class="config-group" style="border-top: 1px dashed #333; padding-top: 10px;">
                    <label class="config-label" style="justify-content: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="chk-quiz" onchange="updateConfig('quiz')">
                        ENABLE POP QUIZ TIMER
                    </label>
                    <label class="config-label" style="margin-top:5px;">FREQUENCY<span id="val-quiz-time" class="config-val">30s</span></label>
                    <input type="range" id="cfg-quiz-time" min="10" max="60" step="5" value="30" oninput="updateConfig('quiz')">
                    <div class="slider-desc"><span>OFTEN</span><span>RARE</span></div>
                </div>

                <div id="study-table-container"></div>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2 class="config-header">SYSTEM CONFIG</h2>
                
                <div class="config-group">
                     <label class="config-label">MASTER VOLUME<span id="val-volume" class="config-val">50%</span></label>
                     <input type="range" id="cfg-volume" min="0" max="100" step="10" value="50" oninput="updateConfig('volume')">
                </div>

                <div class="config-group">
                    <label class="config-label" style="justify-content: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="chk-sfx" onchange="updateConfig('audio_toggles')" checked>
                        SFX (SHOOT/EXPLOSION)
                    </label>
                    <label class="config-label" style="justify-content: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="chk-voice-words" onchange="updateConfig('audio_toggles')" checked>
                        VOICE: WORDS
                    </label>
                    <label class="config-label" style="justify-content: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="chk-voice-bombs" onchange="updateConfig('audio_toggles')" checked>
                        VOICE: BOMBS (NUM/LET)
                    </label>
                </div>
                <div class="config-group">
                    <label class="config-label">VOCABULARY SOURCE</label>
                    <select id="cfg-source" onchange="updateConfig('source')"></select>
                </div>
                <div class="config-group">
                    <label class="config-label">ENEMY FREQUENCY<span id="val-spawn" class="config-val">1</span></label>
                    <input type="range" id="cfg-spawn" min="1" max="10" step="1" value="1" oninput="updateConfig('spawn')">
                    <div class="slider-desc"><span>FEW</span><span>MANY</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">ENEMY SPEED<span id="val-speed" class="config-val">0.5x</span></label>
                    <input type="range" id="cfg-speed" min="0.5" max="3.0" step="0.1" value="0.5" oninput="updateConfig('speed')">
                    <div class="slider-desc"><span>SLOW</span><span>FAST</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">BOMB QUANTITY<span id="val-bomb" class="config-val">30%</span></label>
                    <input type="range" id="cfg-bomb" min="0" max="100" step="10" value="30" oninput="updateConfig('bomb')">
                    <div class="slider-desc"><span>NONE</span><span>RAIN</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">BOMB FALL SPEED<span id="val-bspeed" class="config-val">1.0</span></label>
                    <input type="range" id="cfg-bspeed" min="1.0" max="5.0" step="0.1" value="1.0" oninput="updateConfig('bspeed')">
                    <div class="slider-desc"><span>FLOAT</span><span>DROP</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">PLAYER COLOR</label>
                    <input type="color" id="cfg-color" value="#4f46e5" onchange="updateConfig('color')">
                </div>
                <button class="reset-btn" onclick="resetConfig()">RESET DEFAULTS</button>
            </div>
            <p style="margin-top:20px;text-align:center;color:#666;font-size:10px;">
                GAME PAUSED. PRESS <span class="key-hint">TAB</span> TO RESUME.
            </p>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/* =========================================
   1. INTERNAL DATA
   ========================================= */
const INTERNAL_VOCAB = {
 'VERBS': [
    {en:"BE", es:"SER/ESTAR"}, {en:"HAVE", es:"TENER"}, {en:"DO", es:"HACER"}, {en:"SAY", es:"DECIR"},
    {en:"GO", es:"IR"}, {en:"GET", es:"OBTENER"}, {en:"MAKE", es:"HACER"}, {en:"KNOW", es:"SABER"},
    {en:"THINK", es:"PENSAR"}, {en:"TAKE", es:"TOMAR"}, {en:"SEE", es:"VER"}, {en:"COME", es:"VENIR"},
    {en:"WANT", es:"QUERER"}, {en:"LOOK", es:"MIRAR"}, {en:"USE", es:"USAR"}, {en:"FIND", es:"ENCONTRAR"},
    {en:"GIVE", es:"DAR"}, {en:"TELL", es:"DECIR/CONTAR"}, {en:"WORK", es:"TRABAJAR"}, {en:"CALL", es:"LLAMAR"},
    {en:"TRY", es:"INTENTAR"}, {en:"ASK", es:"PREGUNTAR"}, {en:"NEED", es:"NECESITAR"}, {en:"FEEL", es:"SENTIR"},
    {en:"BECOME", es:"LLEGAR A SER"}, {en:"LEAVE", es:"SALIR/DEJAR"}, {en:"PUT", es:"PONER"}, {en:"MEAN", es:"SIGNIFICAR"},
    {en:"KEEP", es:"MANTENER"}, {en:"LET", es:"DEJAR"}, {en:"BEGIN", es:"EMPEZAR"}, {en:"SEEM", es:"PARECER"},
    {en:"HELP", es:"AYUDAR"}, {en:"TALK", es:"HABLAR"}, {en:"TURN", es:"GIRAR"}, {en:"START", es:"EMPEZAR"},
    {en:"SHOW", es:"MOSTRAR"}, {en:"HEAR", es:"OÍR"}, {en:"PLAY", es:"JUGAR"}, {en:"RUN", es:"CORRER"},
    {en:"MOVE", es:"MOVER"}, {en:"LIKE", es:"GUSTAR"}, {en:"LIVE", es:"VIVIR"}, {en:"BELIEVE", es:"CREER"},
    {en:"HOLD", es:"SOSTENER"}, {en:"BRING", es:"TRAER"}, {en:"HAPPEN", es:"OCURRIR"}, {en:"WRITE", es:"ESCRIBIR"},
    {en:"SIT", es:"SENTARSE"}, {en:"STAND", es:"ESTAR DE PIE"}, {en:"LOSE", es:"PERDER"},

    // New verbs start here
    {en:"PAY", es:"PAGAR"}, {en:"MEET", es:"ENCONTRAR/REUNIRSE"}, {en:"INCLUDE", es:"INCLUIR"}, {en:"CONTINUE", es:"CONTINUAR"},
    {en:"SET", es:"ESTABLECER"}, {en:"LEARN", es:"APRENDER"}, {en:"CHANGE", es:"CAMBIAR"}, {en:"LEAD", es:"LIDERAR"},
    {en:"UNDERSTAND", es:"ENTENDER"}, {en:"WATCH", es:"VER/OBSERVAR"}, {en:"FOLLOW", es:"SEGUIR"}, {en:"STOP", es:"DETENER"},
    {en:"CREATE", es:"CREAR"}, {en:"SPEAK", es:"HABLAR"}, {en:"READ", es:"LEER"}, {en:"ALLOW", es:"PERMITIR"},
    {en:"ADD", es:"AGREGAR"}, {en:"SPEND", es:"GASTAR/PASAR"}, {en:"GROW", es:"CRECER"}, {en:"OPEN", es:"ABRIR"},
    {en:"WALK", es:"CAMINAR"}, {en:"WIN", es:"GANAR"}, {en:"OFFER", es:"OFRECER"}, {en:"REMEMBER", es:"RECORDAR"},
    {en:"LOVE", es:"AMAR"}, {en:"CONSIDER", es:"CONSIDERAR"}, {en:"APPEAR", es:"APARECER"}, {en:"BUY", es:"COMPRAR"},
    {en:"WAIT", es:"ESPERAR"}, {en:"SERVE", es:"SERVIR"}, {en:"DIE", es:"MORIR"}, {en:"SEND", es:"ENVIAR"},
    {en:"EXPECT", es:"ESPERAR (EXPECTATIVA)"}, {en:"BUILD", es:"CONSTRUIR"}, {en:"STAY", es:"QUEDARSE"}, {en:"FALL", es:"CAER"},
    {en:"CUT", es:"CORTAR"}, {en:"REACH", es:"ALCANZAR"}, {en:"KILL", es:"MATAR"}, {en:"REMAIN", es:"PERMANECER"},
    {en:"SUGGEST", es:"SUGERIR"}, {en:"RAISE", es:"LEVANTAR/AUMENTAR"}, {en:"PASS", es:"PASAR"}, {en:"SELL", es:"VENDER"},
    {en:"REQUIRE", es:"REQUIRIR"}, {en:"REPORT", es:"REPORTAR"}, {en:"DECIDE", es:"DECIDIR"}, {en:"PULL", es:"TIRAR"},
    {en:"RETURN", es:"REGRESAR"}, {en:"EXPLAIN", es:"EXPLICAR"}, {en:"HOPE", es:"ESPERAR (DESEO)"}, {en:"DEVELOP", es:"DESARROLLAR"},
    {en:"CARRY", es:"CARGAR"}, {en:"BREAK", es:"ROMPER"}, {en:"RECEIVE", es:"RECIBIR"}, {en:"AGREE", es:"ESTAR DE ACUERDO"},
    {en:"SUPPORT", es:"APOYAR"}, {en:"HIT", es:"GOLPEAR"}, {en:"PRODUCE", es:"PRODUCIR"}, {en:"EAT", es:"COMER"},
    {en:"COVER", es:"CUBRIR"}, {en:"CATCH", es:"ATRAPAR"}, {en:"DRAW", es:"DIBUJAR"}, {en:"CHOOSE", es:"ELEGIR"},
    {en:"CAUSE", es:"CAUSAR"}, {en:"POINT", es:"SEÑALAR"}, {en:"LISTEN", es:"ESCUCHAR"}, {en:"RECOGNIZE", es:"RECONOCER"},
    {en:"MARRY", es:"CASARSE"}, {en:"TREAT", es:"TRATAR"}, {en:"AFFECT", es:"AFECTAR"}, {en:"IMPROVE", es:"MEJORAR"},
    {en:"HANDLE", es:"MANEJAR"}, {en:"SHARE", es:"COMPARTIR"}, {en:"PULL", es:"TIRAR"}, {en:"PUSH", es:"EMPURJAR"},
    {en:"ACHIEVE", es:"LOGRAR"}, {en:"AVOID", es:"EVITAR"}, {en:"DESCRIBE", es:"DESCRIBIR"}, {en:"APPLY", es:"APLICAR"},
    {en:"FILL", es:"LLENAR"}, {en:"ATTEND", es:"ASISTIR"}, {en:"REDUCE", es:"REDUCIR"}, {en:"FIX", es:"ARREGLAR"},
    {en:"CLOSE", es:"CERRAR"}, {en:"SEND", es:"ENVIAR"}, {en:"CLIMB", es:"ESCALAR"}, {en:"CLEAN", es:"LIMPIAR"},
    {en:"SMILE", es:"SONREÍR"}, {en:"LAUGH", es:"REÍR"}, {en:"CRY", es:"LLORAR"}, {en:"SLEEP", es:"DORMIR"},
    {en:"WAKE", es:"DESPERTAR"}, {en:"DRIVE", es:"MANEJAR"}, {en:"RIDE", es:"MONTAR"}, {en:"FLY", es:"VOLAR"},
    {en:"SWIM", es:"NADAR"}, {en:"TEACH", es:"ENSEÑAR"}, {en:"TRAVEL", es:"VIAJAR"}, {en:"BORROW", es:"PEDIR PRESTADO"},
    {en:"LEND", es:"PRESTAR"}, {en:"PROMISE", es:"PROMETER"}, {en:"WARN", es:"ADVERTIR"}, {en:"GUESS", es:"ADIVINAR"},
    {en:"MISS", es:"EXTRAÑAR/PERDER"}, {en:"SHOUT", es:"GRITAR"}, {en:"WHISPER", es:"SUSURRAR"}, {en:"SMELL", es:"OLER"},
    {en:"TOUCH", es:"TOCAR"}, {en:"BORROW", es:"PEDIR PRESTADO"}, {en:"SPREAD", es:"EXTENDER"}, {en:"THROW", es:"LANZAR"},
    {en:"SHAKE", es:"SACUDIR"}, {en:"FIT", es:"ENCajar"}, {en:"FORGET", es:"OLVIDAR"}, {en:"REMIND", es:"RECORDAR"},
    {en:"MANAGE", es:"MANEJAR/ADMINISTRAR"}, {en:"ENTER", es:"ENTRAR"}, {en:"ARRIVE", es:"LLEGAR"}, {en:"ORGANIZE", es:"ORGANIZAR"},
    {en:"ATTACK", es:"ATACAR"}, {en:"DEFEND", es:"DEFENDER"}, {en:"DEMAND", es:"EXIGIR"}, {en:"PREFER", es:"PREFERIR"},
    {en:"DESERVE", es:"MERECER"}, {en:"INSIST", es:"INSISTIR"}, {en:"COMPARE", es:"COMPARAR"}, {en:"ARGUE", es:"DISCUTIR"},
    {en:"SING", es:"CANTAR"}, {en:"DANCE", es:"BAILAR"}, {en:"PRAY", es:"REZAR"}, {en:"COOK", es:"COCINAR"},
    {en:"BAKE", es:"HORNEAR"}, {en:"BOIL", es:"HERVIR"}, {en:"FRY", es:"FREÍR"}, {en:"CUT", es:"CORTAR"},
    {en:"MEASURE", es:"MEDIR"}, {en:"GUESS", es:"ADIVINAR"}, {en:"TEST", es:"PROBAR"}, {en:"PLAN", es:"PLANEAR"},
    {en:"PREPARE", es:"PREPARAR"}, {en:"IMAGINE", es:"IMAGINAR"}, {en:"PREVENT", es:"PREVENIR"}, {en:"REALIZE", es:"DAR CUENTA"},
    {en:"JUMP", es:"SALTAR"}, {en:"HANG", es:"COLGAR"}, {en:"KICK", es:"PATEAR"}, {en:"BURN", es:"QUEMAR"},
    {en:"BEND", es:"DOBLAR"}, {en:"FREEZE", es:"CONGELAR"}, {en:"STEAL", es:"ROBAR"}, {en:"ARREST", es:"ARRESTAR"},
    {en:"SELECT", es:"SELECCIONAR"}, {en:"TYPE", es:"TIPEAR"}, {en:"PRINT", es:"IMPRIMIR"}, {en:"UPLOAD", es:"SUBIR"},
    {en:"DOWNLOAD", es:"DESCARGAR"}, {en:"SAVE", es:"GUARDAR"}, {en:"DELETE", es:"BORRAR"}, {en:"RENAME", es:"RENOMBRAR"},
    {en:"SEARCH", es:"BUSCAR"}, {en:"BITE", es:"MORDER"}, {en:"CHEW", es:"MASTICAR"}, {en:"JOIN", es:"UNIRSE"},
    {en:"ESCAPE", es:"ESCAPAR"}, {en:"SWITCH", es:"CAMBIAR"}, {en:"CONNECT", es:"CONECTAR"}, {en:"BLOCK", es:"BLOQUEAR"},
    {en:"UNLOCK", es:"DESBLOQUEAR"}, {en:"SIGN", es:"FIRMAR"}, {en:"CANCEL", es:"CANCELAR"}, {en:"CONFIRM", es:"CONFIRMAR"}
],
  'NOUNS': [
    {en:"TIME", es:"TIEMPO"}, {en:"PERSON", es:"PERSONA"}, {en:"YEAR", es:"AÑO"}, {en:"WAY", es:"CAMINO/MANERA"},
    {en:"DAY", es:"DÍA"}, {en:"THING", es:"COSA"}, {en:"MAN", es:"HOMBRE"}, {en:"WORLD", es:"MUNDO"},
    {en:"LIFE", es:"VIDA"}, {en:"HAND", es:"MANO"}, {en:"PART", es:"PARTE"}, {en:"CHILD", es:"NIÑO/A"},
    {en:"EYE", es:"OJO"}, {en:"WOMAN", es:"MUJER"}, {en:"PLACE", es:"LUGAR"}, {en:"WORK", es:"TRABAJO"},
    {en:"WEEK", es:"SEMANA"}, {en:"CASE", es:"CASO"}, {en:"POINT", es:"PUNTO"}, {en:"GOVERNMENT", es:"GOBIERNO"},
    {en:"COMPANY", es:"EMPRESA"}, {en:"NUMBER", es:"NÚMERO"}, {en:"GROUP", es:"GRUPO"}, {en:"PROBLEM", es:"PROBLEMA"},
    {en:"FACT", es:"HECHO"}, {en:"HOUSE", es:"CASA"}, {en:"SERVICE", es:"SERVICIO"}, {en:"FRIEND", es:"AMIGO"},
    {en:"FATHER", es:"PADRE"}, {en:"POWER", es:"PODER"}, {en:"HOUR", es:"HORA"}, {en:"GAME", es:"JUEGO"},
    {en:"LINE", es:"LÍNEA"}, {en:"END", es:"FIN"}, {en:"MEMBER", es:"MIEMBRO"}, {en:"LAW", es:"LEY"},
    {en:"CAR", es:"COCHE"}, {en:"CITY", es:"CIUDAD"}, {en:"COMMUNITY", es:"COMUNIDAD"}, {en:"NAME", es:"NOMBRE"},
    {en:"PRESIDENT", es:"PRESIDENTE"}, {en:"TEAM", es:"EQUIPO"}, {en:"MINUTE", es:"MINUTO"}, {en:"IDEA", es:"IDEA"},
    {en:"KID", es:"NIÑO"}, {en:"BODY", es:"CUERPO"}, {en:"INFORMATION", es:"INFORMACIÓN"}, {en:"BACK", es:"ESPALDA"},
    {en:"PARENT", es:"PADRE/MADRE"}, {en:"FACE", es:"CARA"}, {en:"OTHERS", es:"OTROS"}, {en:"HOME", es:"HOGAR"},
    {en:"SCHOOL", es:"ESCUELA"}, {en:"WATER", es:"AGUA"}, {en:"WORD", es:"PALABRA"}, {en:"AREA", es:"ÁREA"},
    {en:"MONEY", es:"DINERO"}, {en:"STORY", es:"HISTORIA"}, {en:"MORNING", es:"MAÑANA"}, {en:"MOM", es:"MAMÁ"},

    // New nouns start here
    {en:"AIR", es:"AIRE"}, {en:"FOOD", es:"COMIDA"}, {en:"ROOM", es:"HABITACIÓN"}, {en:"BOOK", es:"LIBRO"},
    {en:"JOB", es:"TRABAJO"}, {en:"NIGHT", es:"NOCHE"}, {en:"BEACH", es:"PLAYA"}, {en:"SHOP", es:"TIENDA"},
    {en:"STORE", es:"ALMACÉN/TIENDA"}, {en:"CHANCE", es:"OPORTUNIDAD"}, {en:"LEVEL", es:"NIVEL"}, {en:"FORM", es:"FORMA"},
    {en:"AIRPORT", es:"AEROPUERTO"}, {en:"MOVIE", es:"PELÍCULA"}, {en:"MUSIC", es:"MÚSICA"}, {en:"HEALTH", es:"SALUD"},
    {en:"ART", es:"ARTE"}, {en:"NATURE", es:"NATURALEZA"}, {en:"HISTORY", es:"HISTORIA"}, {en:"MOTHER", es:"MADRE"},
    {en:"SON", es:"HIJO"}, {en:"DAUGHTER", es:"HIJA"}, {en:"BROTHER", es:"HERMANO"}, {en:"SISTER", es:"HERMANA"},
    {en:"CAT", es:"GATO"}, {en:"DOG", es:"PERRO"}, {en:"PET", es:"MASCOTA"}, {en:"ANIMAL", es:"ANIMAL"},
    {en:"ROAD", es:"CARRETERA"}, {en:"STREET", es:"CALLE"}, {en:"MAP", es:"MAPA"}, {en:"COUNTRY", es:"PAÍS"},
    {en:"NATION", es:"NACIÓN"}, {en:"FLAG", es:"BANDERA"}, {en:"POLICE", es:"POLICÍA"}, {en:"FIRE", es:"FUEGO"},
    {en:"NEWS", es:"NOTICIAS"}, {en:"MEDIA", es:"MEDIOS"}, {en:"WEATHER", es:"CLIMA"}, {en:"TRAFFIC", es:"TRÁFICO"},
    {en:"PAPER", es:"PAPEL"}, {en:"LETTER", es:"CARTA"}, {en:"MAIL", es:"CORREO"}, {en:"MESSAGE", es:"MENSAJE"},
    {en:"PHONE", es:"TELÉFONO"}, {en:"COMPUTER", es:"COMPUTADORA"}, {en:"SCREEN", es:"PANTALLA"}, {en:"KEYBOARD", es:"TECLADO"},
    {en:"TABLE", es:"MESA"}, {en:"CHAIR", es:"SILLA"}, {en:"BED", es:"CAMA"}, {en:"WINDOW", es:"VENTANA"},
    {en:"DOOR", es:"PUERTA"}, {en:"WALL", es:"PARED"}, {en:"FLOOR", es:"PISO"}, {en:"CEILING", es:"TECHO"},
    {en:"CLOTHES", es:"ROPA"}, {en:"SHOES", es:"ZAPATOS"}, {en:"DRESS", es:"VESTIDO"}, {en:"COAT", es:"ABRIGO"},
    {en:"BAG", es:"BOLSO"}, {en:"WALLET", es:"BILLETERA"}, {en:"CARD", es:"TARJETA"}, {en:"TICKET", es:"BOLETO"},
    {en:"PASSPORT", es:"PASAPORTE"}, {en:"KEY", es:"LLAVE"}, {en:"LIGHT", es:"LUZ"}, {en:"FAN", es:"VENTILADOR"},
    {en:"BOTTLE", es:"BOTELLA"}, {en:"GLASS", es:"VASO"}, {en:"CUP", es:"TAZA"}, {en:"PLATE", es:"PLATO"},
    {en:"KNIFE", es:"CUCHILLO"}, {en:"FORK", es:"TENEDOR"}, {en:"SPOON", es:"CUCHARA"}, {en:"FOOD", es:"COMIDA"},
    {en:"BREAKFAST", es:"DESAYUNO"}, {en:"LUNCH", es:"ALMUERZO"}, {en:"DINNER", es:"CENA"}, {en:"SNACK", es:"MERIENDA"},
    {en:"RESTAURANT", es:"RESTAURANTE"}, {en:"MENU", es:"MENÚ"}, {en:"WAITER", es:"CAMARERO"}, {en:"BILL", es:"CUENTA"},
    {en:"CASH", es:"EFECTIVO"}, {en:"PRICE", es:"PRECIO"}, {en:"MARKET", es:"MERCADO"}, {en:"SHOPPING", es:"COMPRAS"},
    {en:"TOOL", es:"HERRAMIENTA"}, {en:"MACHINE", es:"MÁQUINA"}, {en:"ENGINE", es:"MOTOR"}, {en:"DEVICE", es:"DISPOSITIVO"},
    {en:"PROJECT", es:"PROYECTO"}, {en:"PLAN", es:"PLAN"}, {en:"TASK", es:"TAREA"}, {en:"GOAL", es:"META"},
    {en:"PROFESSION", es:"PROFESIÓN"}, {en:"WORKER", es:"TRABAJADOR"}, {en:"DOCTOR", es:"DOCTOR"}, {en:"NURSE", es:"ENFERMERA"},
    {en:"ENGINEER", es:"INGENIERO"}, {en:"TEACHER", es:"MAESTRO"}, {en:"STUDENT", es:"ESTUDIANTE"}, {en:"DRIVER", es:"CONDUCTOR"},
    {en:"ACTOR", es:"ACTOR"}, {en:"AUTHOR", es:"AUTOR"}, {en:"WRITER", es:"ESCRITOR"}, {en:"SINGER", es:"CANTANTE"},
    {en:"MUSICIAN", es:"MÚSICO"}, {en:"PAINTER", es:"PINTOR"}, {en:"CHEF", es:"CHEF"}, {en:"POLITICIAN", es:"POLÍTICO"},
    {en:"LEADER", es:"LÍDER"}, {en:"ATHLETE", es:"ATLETA"}, {en:"PLAYER", es:"JUGADOR"}, {en:"CUSTOMER", es:"CLIENTE"},
    {en:"CLIENT", es:"CLIENTE"}, {en:"VISITOR", es:"VISITANTE"}, {en:"TOURIST", es:"TURISTA"}, {en:"GUEST", es:"INVITADO"},
    {en:"HUMAN", es:"HUMANO"}, {en:"ADULT", es:"ADULTO"}, {en:"TEENAGER", es:"ADOLESCENTE"}, {en:"BABY", es:"BEBÉ"},
    {en:"CROWD", es:"MULTITUD"}, {en:"PEOPLE", es:"GENTE"}, {en:"FAMILY", es:"FAMILIA"}, {en:"RELATIONSHIP", es:"RELACIÓN"},
    {en:"FEELING", es:"SENTIMIENTO"}, {en:"EMOTION", es:"EMOCIÓN"}, {en:"THOUGHT", es:"PENSAMIENTO"}, {en:"DREAM", es:"SUEÑO"},
    {en:"HOPE", es:"ESPERANZA"}, {en:"FEAR", es:"MIEDO"}, {en:"LOVE", es:"AMOR"}, {en:"PAIN", es:"DOLOR"},
    {en:"JOY", es:"ALEGRÍA"}, {en:"ENERGY", es:"ENERGÍA"}, {en:"STRENGTH", es:"FUERZA"}, {en:"SPEED", es:"VELOCIDAD"},
    {en:"SIZE", es:"TAMAÑO"}, {en:"COLOR", es:"COLOR"}, {en:"SHAPE", es:"FORMA"}, {en:"QUALITY", es:"CALIDAD"},
    {en:"QUANTITY", es:"CANTIDAD"}, {en:"LIST", es:"LISTA"}, {en:"NOTE", es:"NOTA"}, {en:"FILE", es:"ARCHIVO"},
    {en:"IMAGE", es:"IMAGEN"}, {en:"VIDEO", es:"VIDEO"}, {en:"AUDIO", es:"AUDIO"}, {en:"PHOTO", es:"FOTO"},
    {en:"CHANNEL", es:"CANAL"}, {en:"ACCOUNT", es:"CUENTA"}, {en:"PASSWORD", es:"CONTRASEÑA"}, {en:"PROFILE", es:"PERFIL"},
    {en:"SYSTEM", es:"SISTEMA"}, {en:"NETWORK", es:"RED"}, {en:"WEBSITE", es:"SITIO WEB"}, {en:"APP", es:"APLICACIÓN"}
],
 // ==================== ADJETIVOS MÁS FRECUENTES (200) ====================
'ADJECTIVES': [
    {en:"GOOD", es:"BUENO"}, {en:"NEW", es:"NUEVO"}, {en:"FIRST", es:"PRIMERO"}, {en:"LAST", es:"ÚLTIMO"},
    {en:"LONG", es:"LARGO"}, {en:"GREAT", es:"GENIAL/GRANDE"}, {en:"LITTLE", es:"PEQUEÑO"}, {en:"OWN", es:"PROPIO"},
    {en:"OTHER", es:"OTRO"}, {en:"OLD", es:"VIEJO"}, {en:"RIGHT", es:"CORRECTO/DERECHO"}, {en:"BIG", es:"GRANDE"},
    {en:"HIGH", es:"ALTO"}, {en:"DIFFERENT", es:"DIFERENTE"}, {en:"SMALL", es:"PEQUEÑO"}, {en:"LARGE", es:"GRANDE"},
    {en:"NEXT", es:"SIGUIENTE"}, {en:"EARLY", es:"TEMPRANO"}, {en:"YOUNG", es:"JOVEN"}, {en:"IMPORTANT", es:"IMPORTANTE"},
    {en:"FEW", es:"POCOS"}, {en:"PUBLIC", es:"PÚBLICO"}, {en:"BAD", es:"MALO"}, {en:"SAME", es:"MISMO"},
    {en:"ABLE", es:"CAPAZ"}, {en:"HAPPY", es:"FELIZ"}, {en:"EASY", es:"FÁCIL"}, {en:"BEST", es:"MEJOR"},
    {en:"BEAUTIFUL", es:"HERMOSO"}, {en:"TRUE", es:"VERDADERO"}, {en:"FREE", es:"LIBRE/GRATIS"}, {en:"HARD", es:"DURO/DIFÍCIL"},
    {en:"BETTER", es:"MEJOR"}, {en:"SURE", es:"SEGURO"}, {en:"POSSIBLE", es:"POSIBLE"}, {en:"FULL", es:"LLENO"},
    {en:"STRONG", es:"FUERTE"}, {en:"HOT", es:"CALIENTE"}, {en:"COLD", es:"FRÍO"}, {en:"NICE", es:"AMABLE/LINDO"},

    // === Added to reach 200 ===
    {en:"CLEAR", es:"CLARO"}, {en:"SPECIAL", es:"ESPECIAL"}, {en:"DIFFICULT", es:"DIFÍCIL"},
    {en:"REAL", es:"REAL"}, {en:"MAIN", es:"PRINCIPAL"}, {en:"READY", es:"LISTO"},
    {en:"COMMON", es:"COMÚN"}, {en:"SIMPLE", es:"SIMPLE"}, {en:"SERIOUS", es:"SERIO"},
    {en:"STRANGE", es:"EXTRAÑO"}, {en:"ENTIRE", es:"ENTERO"}, {en:"PERSONAL", es:"PERSONAL"},
    {en:"PRIVATE", es:"PRIVADO"}, {en:"POOR", es:"POBRE"}, {en:"RICH", es:"RICO"},
    {en:"POPULAR", es:"POPULAR"}, {en:"MODERN", es:"MODERNO"}, {en:"TRADITIONAL", es:"TRADICIONAL"},
    {en:"FINE", es:"BIEN/FINO"}, {en:"OPEN", es:"ABIERTO"}, {en:"CLOSED", es:"CERRADO"},
    {en:"SHORT", es:"CORTO"}, {en:"TALL", es:"ALTO"}, {en:"WIDE", es:"ANCHO"},
    {en:"NARROW", es:"ANGOSTO"}, {en:"DEEP", es:"PROFUNDO"}, {en:"SHALLOW", es:"SUPERFICIAL"},
    {en:"BRIGHT", es:"BRILLANTE"}, {en:"DARK", es:"OSCURO"}, {en:"LOUD", es:"RUIDOSO"},
    {en:"QUIET", es:"SILENCIOSO"}, {en:"BUSY", es:"OCUPADO"}, {en:"LAZY", es:"PEREZOSO"},
    {en:"TIRED", es:"CANSADO"}, {en:"AFRAID", es:"ASUSTADO"}, {en:"BRAVE", es:"VALIENTE"},
    {en:"POLITE", es:"EDUCADO"}, {en:"RUDE", es:"GROsero"}, {en:"FUNNY", es:"GRACIOSO"},
    {en:"SERIOUS", es:"SERIO"}, {en:"WONDERFUL", es:"MARAVILLOSO"}, {en:"AWFUL", es:"HORRIBLE"},
    {en:"AMAZING", es:"ASOMBROSO"}, {en:"BORING", es:"ABURRIDO"}, {en:"INTERESTING", es:"INTERESANTE"},
    {en:"USEFUL", es:"ÚTIL"}, {en:"USELESS", es:"INÚTIL"}, {en:"AVAILABLE", es:"DISPONIBLE"},
    {en:"UNAVAILABLE", es:"NO DISPONIBLE"}, {en:"SAFE", es:"SEGURO"}, {en:"DANGEROUS", es:"PELIGROSO"},
    {en:"HEAVY", es:"PESADO"}, {en:"LIGHT", es:"LIVIANO"}, {en:"EXPENSIVE", es:"CARO"},
    {en:"CHEAP", es:"BARATO"}, {en:"FAIR", es:"JUSTO"}, {en:"UNFAIR", es:"INJUSTO"},
    {en:"FAST", es:"RÁPIDO"}, {en:"SLOW", es:"LENTO"}, {en:"DELICIOUS", es:"DELICIOSO"},
    {en:"TASTY", es:"SABROSO"}, {en:"BITTER", es:"AMARGO"}, {en:"SWEET", es:"DULCE"},
    {en:"SALTY", es:"SALADO"}, {en:"TIRED", es:"CANSADO"}, {en:"EXCITED", es:"EMOCIONADO"},
    {en:"CALM", es:"CALMADO"}, {en:"ANGRY", es:"ENojado"}, {en:"UPSET", es:"MOLESTO"},
    {en:"RELAXED", es:"RELajado"}, {en:"ANXIOUS", es:"ANSIOSO"}, {en:"CONFIDENT", es:"SEGURO"},
    {en:"CONFUSING", es:"CONFUSO"}, {en:"CORRECT", es:"CORRECTO"}, {en:"WRONG", es:"INCORRECTO"},
    {en:"HEALTHY", es:"SALUDABLE"}, {en:"SICK", es:"ENFERMO"}, {en:"FRESH", es:"FRESCO"},
    {en:"DIRTY", es:"SUCIO"}, {en:"CLEAN", es:"LIMPIO"}, {en:"WEAK", es:"DÉBIL"},
    {en:"POWERFUL", es:"PODEROSO"}, {en:"SMOOTH", es:"SUAVE"}, {en:"ROUGH", es:"ÁSPERO"},
    {en:"LEGAL", es:"LEGAL"}, {en:"ILLEGAL", es:"ILEGAL"}, {en:"LOCAL", es:"LOCAL"},
    {en:"INTERNATIONAL", es:"INTERNACIONAL"}, {en:"FAMOUS", es:"FAMOSO"}, {en:"UNKNOWN", es:"DESCONOCIDO"},
    {en:"BUSY", es:"OCUPADO"}, {en:"EMPTY", es:"VACÍO"}, {en:"ALIVE", es:"VIVO"}, {en:"DEAD", es:"MUERTO"},
    {en:"BRILLIANT", es:"BRILLANTE"}, {en:"TERRIBLE", es:"TERRIBLE"}, {en:"PERFECT", es:"PERFECTO"},
    {en:"IMPOSSIBLE", es:"IMPOSIBLE"}, {en:"WORSE", es:"PEOR"}, {en:"WONDERFUL", es:"MARAVILLOSO"},
    {en:"QUIET", es:"SILENCIOSO"}, {en:"NOISY", es:"RUIDOSO"}, {en:"FRIENDLY", es:"AMIGABLE"},
    {en:"UNFRIENDLY", es:"ANTIPÁTICO"}, {en:"HUNGRY", es:"HAMBRIENTO"}, {en:"THIRSTY", es:"SEDIENTO"},
    {en:"BUSY", es:"OCUPADO"}, {en:"RELAXING", es:"RELajANTE"}, {en:"BRIEF", es:"BREVE"},
    {en:"ROUND", es:"REDONDO"}, {en:"SQUARE", es:"CUADRADO"}, {en:"FLAT", es:"PLANO"},
    {en:"CURVED", es:"CURVADO"}, {en:"SOFT", es:"SUAVE"}, {en:"FIRM", es:"FIRME"},
    {en:"INTELLIGENT", es:"INTELIGENTE"}, {en:"STUPID", es:"ESTÚPIDO"}, {en:"WISE", es:"SABIO"},
    {en:"CREATIVE", es:"CREATIVO"}, {en:"ORIGINAL", es:"ORIGINAL"}, {en:"HONEST", es:"HONESTO"},
    {en:"DISHONEST", es:"DESHONESTO"}, {en:"GENTLE", es:"SUAVE"}, {en:"CRUEL", es:"CRUEL"},
    {en:"ACTIVE", es:"ACTIVO"}, {en:"PASSIVE", es:"PASIVO"}, {en:"BUSY", es:"OCUPADO"},
    {en:"EMPTY", es:"VACÍO"}, {en:"LONELY", es:"SOLO"}, {en:"CROWDED", es:"LLENO DE GENTE"},
    {en:"TOUGH", es:"DURO"}, {en:"TENDER", es:"TIERNO"}, {en:"RAPID", es:"RÁPIDO"},
    {en:"STEADY", es:"ESTABLE"}, {en:"WILD", es:"SALVAJE"}, {en:"DOMESTIC", es:"DOMÉSTICO"},
    {en:"HUMBLE", es:"HUMILDE"}, {en:"PROUD", es:"ORGULLOSO"}, {en:"LOVELY", es:"ENCANTADOR"},
    {en:"HELPFUL", es:"SERVICIAL"}, {en:"HOPEFUL", es:"ESPERANZADO"}, {en:"HOPELESS", es:"SIN ESPERANZA"},
    {en:"MAGICAL", es:"MÁGICO"}, {en:"MYSTERIOUS", es:"MISTERIOSO"}, {en:"NATURAL", es:"NATURAL"},
    {en:"ARTIFICIAL", es:"ARTIFICIAL"}, {en:"GLOBAL", es:"GLOBAL"}, {en:"RURAL", es:"RURAL"},
    {en:"URBAN", es:"URBANO"}, {en:"CENTRAL", es:"CENTRAL"}, {en:"REMOTE", es:"REMOTO"},
    {en:"CURRENT", es:"ACTUAL"}, {en:"FORMER", es:"ANTERIOR"}, {en:"FUTURE", es:"FUTURO"},
    {en:"INSTANT", es:"INSTANTÁNEO"}, {en:"TEMPORARY", es:"TEMPORAL"}, {en:"PERMANENT", es:"PERMANENTE"},
    {en:"SUPERIOR", es:"SUPERIOR"}, {en:"INFERIOR", es:"INFERIOR"}, {en:"VISIBLE", es:"VISIBLE"},
    {en:"INVISIBLE", es:"INVISIBLE"}, {en:"ACTIVE", es:"ACTIVO"}, {en:"PASSIVE", es:"PASIVO"},
    {en:"CHALLENGING", es:"DESAFIANTE"}, {en:"ENJOYABLE", es:"AGRADABLE"}, {en:"MEMORABLE", es:"MEMORABLE"}
],
 'FUNCTION WORDS': [
    // ---- CORE 80 (ya vistos) ----
    {en:"THE", es:"EL/LA/LOS/LAS"}, {en:"OF", es:"DE"}, {en:"AND", es:"Y"}, {en:"A", es:"UN/UNA"},
    {en:"TO", es:"A/PARA"}, {en:"IN", es:"EN"}, {en:"IS", es:"ES/ESTÁ"}, {en:"YOU", es:"TÚ/USTED"},
    {en:"THAT", es:"QUE/ESO"}, {en:"IT", es:"ESO/ELLA/ÉL (OBJETO)"}, {en:"HE", es:"ÉL"}, {en:"WAS", es:"ERA/ESTABA/FUE"},
    {en:"FOR", es:"PARA/POR"}, {en:"ON", es:"EN/SOBRE"}, {en:"ARE", es:"SON/ESTÁN"}, {en:"AS", es:"COMO"},
    {en:"WITH", es:"CON"}, {en:"HIS", es:"SU (DE ÉL)"}, {en:"THEY", es:"ELLOS/ELLAS"}, {en:"I", es:"YO"},
    {en:"AT", es:"EN/A"}, {en:"BE", es:"SER/ESTAR"}, {en:"THIS", es:"ESTE/ESTA"}, {en:"HAVE", es:"TENER/HABER"},
    {en:"FROM", es:"DE/DESDE"}, {en:"OR", es:"O"}, {en:"ONE", es:"UNO/UNA"}, {en:"HAD", es:"HABÍA/TUVO"},
    {en:"BY", es:"POR"}, {en:"BUT", es:"PERO"}, {en:"NOT", es:"NO"}, {en:"WHAT", es:"QUÉ"},
    {en:"ALL", es:"TODO"}, {en:"WILL", es:"(AUX) FUTURO"}, {en:"UP", es:"ARRIBA"}, {en:"OUT", es:"FUERA"},
    {en:"IF", es:"SI (CONDICIONAL)"}, {en:"ABOUT", es:"SOBRE/ACERCA DE"}, {en:"WHO", es:"QUIÉN"}, {en:"WHICH", es:"CUÁL"},
    {en:"WHEN", es:"CUANDO"}, {en:"THEIR", es:"SU (DE ELLOS)"}, {en:"CAN", es:"PODER (AUX)"}, {en:"THERE", es:"ALLÍ/HAY"},
    {en:"AN", es:"UN/UNA"}, {en:"YOUR", es:"TU/SU"}, {en:"MORE", es:"MÁS"}, {en:"NO", es:"NO/NINGUNO"},
    {en:"OTHER", es:"OTRO"}, {en:"DOES", es:"HACE (AUX)"}, {en:"DID", es:"HIZO (AUX)"}, {en:"SO", es:"ASÍ/ENTONCES"},
    {en:"THESE", es:"ESTOS/ESTAS"}, {en:"ANY", es:"ALGUNO/CUALQUIER"}, {en:"MAY", es:"PODER (PERMISO)"}, {en:"THOSE", es:"ESOS/ESAS"},
    {en:"HER", es:"SU/DE ELLA"}, {en:"OVER", es:"ENCIMA DE"}, {en:"MY", es:"MI"}, {en:"JUST", es:"SÓLO/APENAS"},
    {en:"INTO", es:"DENTRO DE"}, {en:"LIKE", es:"COMO"}, {en:"THEN", es:"LUEGO/ENTONCES"}, {en:"NOW", es:"AHORA"},
    {en:"ONLY", es:"SÓLO/SOLAMENTE"}, {en:"VERY", es:"MUY"}, {en:"HOW", es:"CÓMO"}, {en:"DOWN", es:"ABAJO"},
    {en:"MUST", es:"DEBER"}, {en:"SHOULD", es:"DEBERÍA"}, {en:"AGAIN", es:"DE NUEVO"}, {en:"BEFORE", es:"ANTES"},
    {en:"AFTER", es:"DESPUÉS"}, {en:"BETWEEN", es:"ENTRE"}, {en:"UNDER", es:"DEBAJO DE"}, {en:"AGAINST", es:"CONTRA"},
    {en:"DURING", es:"DURANTE"}, {en:"WITHOUT", es:"SIN"}, {en:"THROUGH", es:"A TRAVÉS DE"},

    // ---- EXTENDED LIST (120 MÁS) ----
    {en:"BECAUSE", es:"PORQUE"}, {en:"WHILE", es:"MIENTRAS"}, {en:"WHERE", es:"DÓNDE"},
    {en:"WHY", es:"POR QUÉ"}, {en:"WHEREAS", es:"MIENTRAS QUE"}, {en:"ALTHOUGH", es:"AUNQUE"},
    {en:"NOR", es:"NI"}, {en:"NOR", es:"NI"}, {en:"EACH", es:"CADA"}, {en:"EVERY", es:"CADA/TODOS"},
    {en:"EITHER", es:"CUALQUIERA/ALGUNO"}, {en:"NEITHER", es:"NINGUNO"}, {en:"BOTH", es:"AMBOS"},
    {en:"FEWER", es:"MENOS"}, {en:"LESS", es:"MENOS"}, {en:"MOST", es:"LA MAYORÍA"},
    {en:"SEVERAL", es:"VARIOS"}, {en:"MUCH", es:"MUCHO"}, {en:"EVER", es:"ALGUNA VEZ"},
    {en:"ALWAYS", es:"SIEMPRE"}, {en:"NEVER", es:"NUNCA"}, {en:"ALREADY", es:"YA"},
    {en:"YET", es:"TODAVÍA/AÚN"}, {en:"STILL", es:"AÚN/TODAVÍA"}, {en:"PERHAPS", es:"QUIZÁS"},
    {en:"MAYBE", es:"QUIZÁS"}, {en:"THUS", es:"ASÍ/POR LO TANTO"}, {en:"HENCE", es:"DE AHÍ"},
    {en:"THEREFORE", es:"POR LO TANTO"}, {en:"WHEREVER", es:"DONDE SEA"}, {en:"WHEREVER", es:"DONDEQUIERA"},
    {en:"WHOEVER", es:"QUIEN SEA"}, {en:"WHATEVER", es:"LO QUE SEA"}, {en:"WHICHEVER", es:"EL QUE SEA"},
    {en:"SOME", es:"ALGUNOS"}, {en:"SOMETHING", es:"ALGO"}, {en:"SOMEONE", es:"ALGUIEN"},
    {en:"ANYONE", es:"CUALQUIERA"}, {en:"ANYTHING", es:"ALGO/CUALQUIER COSA"},
    {en:"EVERYONE", es:"TODOS"}, {en:"EVERYTHING", es:"TODO"}, {en:"NOBODY", es:"NADIE"},
    {en:"NOTHING", es:"NADA"}, {en:"ANYWHERE", es:"EN CUALQUIER PARTE"}, {en:"SOMEWHERE", es:"EN ALGÚN LUGAR"},
    {en:"EVERYWHERE", es:"EN TODAS PARTES"}, {en:"NOWHERE", es:"EN NINGÚN LUGAR"},
    {en:"BEYOND", es:"MÁS ALLÁ DE"}, {en:"UPON", es:"SOBRE"}, {en:"ALONG", es:"A LO LARGO DE"},
    {en:"ACROSS", es:"A TRAVÉS DE"}, {en:"TOWARD", es:"HACIA"}, {en:"TOWARDS", es:"HACIA"},
    {en:"WITHIN", es:"DENTRO DE"}, {en:"WITHOUT", es:"SIN"}, {en:"UNLESS", es:"A MENOS QUE"},
    {en:"SINCE", es:"DESDE/YA QUE"}, {en:"ONTO", es:"SOBRE"}, {en:"OFF", es:"FUERA/APAGADO"},
    {en:"PLUS", es:"MÁS"}, {en:"MINUS", es:"MENOS"}, {en:"AMONG", es:"ENTRE"},
    {en:"AMID", es:"EN MEDIO DE"}, {en:"VIA", es:"VÍA/MEDIANTE"}, {en:"DESPITE", es:"A PESAR DE"},
    {en:"REGARDING", es:"CON RESPECTO A"}, {en:"CONCERNING", es:"ACERCA DE"}, {en:"BEYOND", es:"MÁS ALLÁ DE"},
    {en:"BEHIND", es:"DETRÁS DE"}, {en:"BENEATH", es:"DEBAJO DE"}, {en:"BESIDES", es:"ADEMÁS DE"},
    {en:"UNTO", es:"A/HACIA"}, {en:"WHEREIN", es:"EN EL CUAL"}, {en:"WHEREBY", es:"POR EL CUAL"},
    {en:"WHEREAS", es:"MIENTRAS QUE"}, {en:"UPWARDS", es:"HACIA ARRIBA"}, {en:"DOWNWARDS", es:"HACIA ABAJO"},
    {en:"APART", es:"SEPARADO"}, {en:"ABOVE", es:"ENCIMA DE"}, {en:"BELOW", es:"DEBAJO DE"},
    {en:"AMIDST", es:"EN MEDIO DE"}, {en:"MID", es:"A MITAD DE"}, {en:"ONTO", es:"HACIA ARRIBA DE"},
    {en:"NEAR", es:"CERCA"}, {en:"NEARBY", es:"CERCA"}, {en:"THROUGHOUT", es:"A LO LARGO DE/TODO A TRAVÉS DE"},
    {en:"UNLIKE", es:"A DIFERENCIA DE"}, {en:"ALBEIT", es:"AUNQUE"}, {en:"THOUGH", es:"AUNQUE"},
    {en:"UNLIKE", es:"A DIFERENCIA DE"}, {en:"VIA", es:"POR MEDIO DE"}, {en:"EXCEPT", es:"EXCEPTO"},
    {en:"EXCEPT FOR", es:"EXCEPTO POR"}, {en:"INCLUDING", es:"INCLUYENDO"}, {en:"EXCLUDING", es:"EXCLUYENDO"},
    {en:"BESIDE", es:"AL LADO DE"}, {en:"AMONGST", es:"ENTRE"}, {en:"WHEREABOUTS", es:"PARADERO"},
    {en:"MEANWHILE", es:"MIENTRAS TANTO"}, {en:"FURTHER", es:"MÁS ADELANTE"}, {en:"FURTHERMORE", es:"ADEMÁS"},
    {en:"ELSE", es:"OTRO/DEMÁS"}, {en:"ELSEWHERE", es:"EN OTRO LUGAR"}, {en:"ALSO", es:"TAMBIÉN"},
    {en:"TOO", es:"TAMBIÉN"}, {en:"EITHER", es:"TAMPOCO"}, {en:"NOR", es:"NI"}, {en:"LATER", es:"LUEGO"},
    {en:"EARLIER", es:"ANTES"}, {en:"SOMETIMES", es:"A VECES"}, {en:"OFTEN", es:"A MENUDO"},
    {en:"SELDOM", es:"RARA VEZ"}, {en:"RARELY", es:"RARAMENTE"}, {en:"FREQUENTLY", es:"FRECUENTEMENTE"},
    {en:"ALMOST", es:"CASI"}, {en:"NEARLY", es:"CASI"}, {en:"BARELY", es:"APENAS"},
    {en:"QUITE", es:"BASTANTE"}, {en:"RATHER", es:"MÁS BIEN"}, {en:"EVEN", es:"INCLUSO"},
    {en:"ALTHOUGH", es:"AUNQUE"}, {en:"WHEREUPON", es:"DESPUÉS DE LO CUAL"}
]
};

/* =========================================
   2. CONFIGURATION & STATE
   ========================================= */
const CONFIG_KEY = 'vocab_robot_config_v12'; // Updated Key
const DISABLED_WORDS_KEY = 'vocab_robot_disabled_v1';

// UPDATED DEFAULTS: 0 Difficulty except Bombs (30)
let userSettings = {
    vocabSource: 'LOCAL', 
    dataPercent: 100, 
    spawnLevel: 1,      // MIN
    enemySpeed: 0.5,    // MIN
    bombChance: 30,     // 30%
    bombSpeed: 1.0,     // MIN
    playerColor: '#4f46e5',
    quizEnabled: false, quizInterval: 30,
    masterVolume: 50,
    audioFX: true,
    audioWords: true,
    audioBombs: true
};
let gameVars = { spawnInterval: 3500, bombProb: 0.005 };
let disabledWords = new Set(); 

// Variables para el Quiz
let quizTimer = 0;
let currentQuizWord = null;

// --- MENUS & UI ---
function renderCategoryBar() {
    const wrapper = document.getElementById('category-bar-wrapper');
    wrapper.innerHTML = '';
    const opts = [{val: 'LOCAL', txt: 'MY DB'}, {val: 'MIXED', txt: 'MIXED'}, {val: 'ALL_INTERNAL', txt: 'ALL INTERNAL'}];
    Object.keys(INTERNAL_VOCAB).forEach(key => opts.push({val: key, txt: key}));

    opts.forEach(o => {
        const chip = document.createElement('div');
        chip.className = 'category-chip' + (userSettings.vocabSource === o.val ? ' active' : '');
        chip.textContent = o.txt;
        chip.onclick = () => {
            document.getElementById('cfg-source').value = o.val;
            updateConfig('source');
        };
        wrapper.appendChild(chip);
    });

    const help = document.createElement('div');
    help.className = 'category-chip help-btn';
    help.textContent = 'CONFIG / HELP';
    help.onclick = toggleStudyGuide;
    wrapper.appendChild(help);
}

function updateDataPercent(val) {
    userSettings.dataPercent = parseInt(val);
    document.getElementById('lbl-percent').textContent = userSettings.dataPercent + '%';
    updateConfig('percent_only');
}

function populateSourceMenu() {
    const select = document.getElementById('cfg-source');
    select.innerHTML = '';
    const opts = [
        {val: 'LOCAL', txt: 'MY DATABASE (Custom)'},
        {val: 'ALL_INTERNAL', txt: 'INTERNAL: ALL MIXED'},
        {val: 'MIXED', txt: 'EVERYTHING (Local + Internal)'}
    ];
    Object.keys(INTERNAL_VOCAB).forEach(key => opts.push({val: key, txt: `INTERNAL: ${key}`}));
    opts.forEach(o => {
        const op = document.createElement('option');
        op.value = o.val; op.textContent = o.txt;
        select.appendChild(op);
    });
}

function loadConfig() {
    populateSourceMenu();
    const saved = localStorage.getItem(CONFIG_KEY);
    if(saved) {
        try { userSettings = { ...userSettings, ...JSON.parse(saved) }; } 
        catch(e) { console.error("Config error", e); }
    }
    const savedDisabled = localStorage.getItem(DISABLED_WORDS_KEY);
    if(savedDisabled) {
        try { disabledWords = new Set(JSON.parse(savedDisabled)); }
        catch(e) { disabledWords = new Set(); }
    }
    applyConfigToUI();
    recalcGameVars();
}

function applyConfigToUI() {
    document.getElementById('cfg-source').value = userSettings.vocabSource;
    document.getElementById('mini-slider-percent').value = userSettings.dataPercent;
    document.getElementById('lbl-percent').textContent = userSettings.dataPercent + '%';

    document.getElementById('chk-quiz').checked = userSettings.quizEnabled;
    document.getElementById('cfg-quiz-time').value = userSettings.quizInterval;
    document.getElementById('val-quiz-time').textContent = userSettings.quizInterval + 's';

    document.getElementById('cfg-volume').value = userSettings.masterVolume;
    document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
    
    // Audio Toggles
    document.getElementById('chk-sfx').checked = userSettings.audioFX !== false;
    document.getElementById('chk-voice-words').checked = userSettings.audioWords !== false;
    document.getElementById('chk-voice-bombs').checked = userSettings.audioBombs !== false;

    document.getElementById('cfg-spawn').value = userSettings.spawnLevel;
    document.getElementById('val-spawn').textContent = userSettings.spawnLevel;
    document.getElementById('cfg-speed').value = userSettings.enemySpeed;
    document.getElementById('val-speed').textContent = userSettings.enemySpeed + "x";
    document.getElementById('cfg-bomb').value = userSettings.bombChance;
    document.getElementById('val-bomb').textContent = userSettings.bombChance + "%";
    document.getElementById('cfg-bspeed').value = userSettings.bombSpeed;
    document.getElementById('val-bspeed').textContent = userSettings.bombSpeed;
    document.getElementById('cfg-color').value = userSettings.playerColor;
    player.color = userSettings.playerColor;
}

function recalcGameVars() {
    gameVars.spawnInterval = 5500 - (userSettings.spawnLevel * 500); 
    gameVars.bombProb = userSettings.bombChance / 2000; 
}

function updateConfig(key) {
    if(key === 'source') {
        userSettings.vocabSource = document.getElementById('cfg-source').value;
        loadVocabData(); populateStudyGuide(); renderCategoryBar();
        if(gameRunning) enemies = []; 
    }
    else if(key === 'percent_only') {
        loadVocabData(); populateStudyGuide();
        if(gameRunning) enemies = [];
    }
    else if(key === 'volume') {
        userSettings.masterVolume = parseInt(document.getElementById('cfg-volume').value);
        document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
        playSound('shoot'); 
    }
    else if(key === 'audio_toggles') {
        userSettings.audioFX = document.getElementById('chk-sfx').checked;
        userSettings.audioWords = document.getElementById('chk-voice-words').checked;
        userSettings.audioBombs = document.getElementById('chk-voice-bombs').checked;
    }
    else if(key === 'quiz') {
        userSettings.quizEnabled = document.getElementById('chk-quiz').checked;
        userSettings.quizInterval = parseInt(document.getElementById('cfg-quiz-time').value);
        document.getElementById('val-quiz-time').textContent = userSettings.quizInterval + 's';
        quizTimer = 0; 
    }
    else if(key === 'spawn') userSettings.spawnLevel = parseInt(document.getElementById('cfg-spawn').value);
    else if(key === 'speed') userSettings.enemySpeed = parseFloat(document.getElementById('cfg-speed').value);
    else if(key === 'bomb') userSettings.bombChance = parseInt(document.getElementById('cfg-bomb').value);
    else if(key === 'bspeed') userSettings.bombSpeed = parseFloat(document.getElementById('cfg-bspeed').value);
    else if(key === 'color') {
        userSettings.playerColor = document.getElementById('cfg-color').value;
        player.color = userSettings.playerColor;
    }
    
    if(key !== 'percent_only' && key !== 'volume') {
        applyConfigToUI(); 
    }
    recalcGameVars();
    localStorage.setItem(CONFIG_KEY, JSON.stringify(userSettings));
}

function resetConfig() {
    localStorage.removeItem(CONFIG_KEY);
    localStorage.removeItem(DISABLED_WORDS_KEY);
    disabledWords.clear();
    // Default Reset with Low Difficulty
    userSettings = { 
        vocabSource: 'LOCAL', dataPercent: 100, 
        spawnLevel: 1, enemySpeed: 0.5, bombChance: 30, bombSpeed: 1.0, 
        playerColor: '#4f46e5', quizEnabled: false, quizInterval: 30, 
        masterVolume: 50, audioFX:true, audioWords:true, audioBombs:true 
    };
    loadConfig(); loadVocabData(); populateStudyGuide(); renderCategoryBar();
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    if(tabName === 'db') document.querySelector('button[onclick="switchTab(\'db\')"]').classList.add('active');
    else document.querySelector('button[onclick="switchTab(\'settings\')"]').classList.add('active');
}

// --- 3. DATA & CLEANING (ACENTOS FIX) ---
let activeVocabList = []; 
let gameDeck = [];        

const cleanText = (str) => {
    if(!str) return "";
    // NFD + Remove diacritics = Ignore accents (CAMIÓN -> CAMION)
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
              .replace(/[.,;¡!¿?]/g, '').trim().toUpperCase();
};

function loadVocabData() {
    let tempVocabList = [];
    const countWords = (str) => str.trim().split(/\s+/).length;
    const processItem = (en, es) => {
        const safeEn = cleanText(en);
        const safeEs = cleanText(es);
        
        if(safeEn && safeEs && countWords(safeEn) <= 2) {
            tempVocabList.push({en: safeEn, es: [safeEs]});
        }
    };

    if (userSettings.vocabSource === 'LOCAL' || userSettings.vocabSource === 'MIXED') {
        try {
            const saved = localStorage.getItem('mdc_vocab_list');
            const items = saved ? JSON.parse(saved) : [];
            items.forEach(item => {
                if (item.isFolder && item.items) {
                    item.items.forEach(sub => processItem(sub.eng, sub.esp));
                } else if (!item.isFolder) {
                    processItem(item.eng, item.esp);
                }
            });
        } catch (e) { console.error("Local Load Error", e); }
    }

    if (userSettings.vocabSource !== 'LOCAL') {
        let sourcesToLoad = [];
        if (userSettings.vocabSource === 'ALL_INTERNAL' || userSettings.vocabSource === 'MIXED') {
            sourcesToLoad = Object.keys(INTERNAL_VOCAB);
        } else {
            sourcesToLoad = [userSettings.vocabSource];
        }
        sourcesToLoad.forEach(catKey => {
            if(INTERNAL_VOCAB[catKey]) {
                INTERNAL_VOCAB[catKey].forEach(i => processItem(i.en, i.es));
            }
        });
    }

    if (tempVocabList.length > 0) {
        const limit = Math.ceil(tempVocabList.length * (userSettings.dataPercent / 100));
        activeVocabList = tempVocabList.slice(0, limit);
    } else {
        activeVocabList = [];
    }

    if (activeVocabList.length === 0) activeVocabList.push({ en: "NO DATA", es: ["VACIO"] });
    refreshGameDeck();
}

function refreshGameDeck() {
    gameDeck = activeVocabList.filter(item => !disabledWords.has(item.en));
    if(gameDeck.length === 0) gameDeck.push({en: "NO ACTIVE", es: ["CHECK LIST"]});
}

function toggleWordStatus(engWord) {
    if(disabledWords.has(engWord)) disabledWords.delete(engWord);
    else disabledWords.add(engWord);
    localStorage.setItem(DISABLED_WORDS_KEY, JSON.stringify([...disabledWords]));
    refreshGameDeck();
}

// --- ALGORITMO LEVENSHTEIN ---
function similarity(s1, s2) {
    var longer = s1;
    var shorter = s2;
    if (s1.length < s2.length) { longer = s2; shorter = s1; }
    var longerLength = longer.length;
    if (longerLength == 0) return 1.0;
    return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
    var costs = new Array();
    for (var i = 0; i <= s1.length; i++) {
        var lastValue = i;
        for (var j = 0; j <= s2.length; j++) {
            if (i == 0) costs[j] = j;
            else {
                if (j > 0) {
                    var newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1))
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

// --- POP QUIZ LOGIC ---
function triggerPopQuiz() {
    gameRunning = false; 
    const randomItem = gameDeck[Math.floor(Math.random() * gameDeck.length)];
    currentQuizWord = randomItem;
    
    const mode = Math.random() > 0.5 ? 'EN_TO_ES' : 'ES_TO_EN';
    currentQuizWord.mode = mode;

    const qEl = document.getElementById('quiz-question');
    const iEl = document.getElementById('quiz-input');
    const fEl = document.getElementById('quiz-feedback');
    const titleEl = document.getElementById('quiz-title');
    const overlay = document.getElementById('quiz-overlay');
    
    iEl.value = "";
    fEl.innerText = "";
    titleEl.innerText = "SYSTEM HACK!";
    titleEl.style.color = "var(--neon-red)";
    overlay.style.borderColor = "var(--neon-red)";
    
    if (mode === 'EN_TO_ES') {
        qEl.innerText = `TRANSLATE: ${randomItem.en}`;
        iEl.placeholder = "TYPE IN SPANISH";
    } else {
        qEl.innerText = `TRANSLATE: ${randomItem.es[0]}`; 
        iEl.placeholder = "TYPE IN ENGLISH";
    }

    document.getElementById('quiz-screen').style.display = 'flex';
    document.getElementById('quiz-input').focus();
}

function skipQuiz() {
    score = Math.max(0, score - 500); 
    scoreEl.innerText = score;
    const feedback = document.getElementById('quiz-feedback');
    feedback.style.color = '#ffaa00';
    feedback.innerText = `CORRECT WAS: ${currentQuizWord.mode === 'EN_TO_ES' ? currentQuizWord.es[0] : currentQuizWord.en}`;
    
    setTimeout(() => {
        document.getElementById('quiz-screen').style.display = 'none';
        quizTimer = 0; 
        gameRunning = true;
        lastTime = performance.now();
        gameLoopId = requestAnimationFrame(loop);
    }, 2000); 
}

function checkQuizAnswer() {
    const userInput = cleanText(document.getElementById('quiz-input').value);
    const feedback = document.getElementById('quiz-feedback');
    const overlay = document.getElementById('quiz-overlay');
    const titleEl = document.getElementById('quiz-title');
    
    let correctAnswers = [];
    if (currentQuizWord.mode === 'EN_TO_ES') correctAnswers = currentQuizWord.es; 
    else correctAnswers = [currentQuizWord.en];

    let maxSim = 0;
    let bestMatch = "";
    
    correctAnswers.forEach(ans => {
        const sim = similarity(userInput, ans);
        if (sim > maxSim) { maxSim = sim; bestMatch = ans; }
    });

    if (maxSim >= 1.0) {
        feedback.style.color = '#0f0';
        feedback.innerText = "SYSTEM RESTORED! BOMB CLEAR ACTIVATED!";
        setTimeout(resolveQuizSuccess, 1000);
    } else {
        const inputEl = document.getElementById('quiz-input');
        inputEl.classList.add('shake');
        setTimeout(()=>inputEl.classList.remove('shake'), 500);
        titleEl.innerText = "CRITICAL FAILURE!";
        overlay.style.borderColor = "#ff0000";
        feedback.innerHTML = `INCORRECT. REPAIR SEQUENCE REQUIRED:<br><span class="correct-ans-highlight">${bestMatch}</span>`;
        inputEl.value = "";
        inputEl.placeholder = "TYPE THE WORD ABOVE";
        inputEl.focus();
    }
}

function launchFireworks() {
    for(let i=0; i<10; i++) {
        setTimeout(() => {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const color = `hsl(${Math.random()*360}, 100%, 50%)`;
            createExplosion(x, y, color, 40); 
            playSound('firework'); 
        }, i * 200); 
    }
}

function resolveQuizSuccess() {
    quizTimer = 0; 
    document.getElementById('quiz-screen').style.display = 'none';
    
    launchFireworks();

    enemyBombs = []; 
    enemies.forEach(e => {
        e.fading = true;
        createExplosion(e.x, e.y, e.color, 20);
        score += 50;
    });
    
    gameRunning = true;
    lastTime = performance.now();
    gameLoopId = requestAnimationFrame(loop);
}

document.getElementById('quiz-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') checkQuizAnswer();
});


/* =========================================
   4. GAME ENGINE
   ========================================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const livesEl = document.getElementById('lives');
const highScoreEl = document.getElementById('highScore');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const studyGuide = document.getElementById('study-guide');
const studyTableContainer = document.getElementById('study-table-container');

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let gameLoopId;

/* =========================================
   AUDIO MANAGER (MEJORADO - HIGH QUALITY)
   ========================================= */
const audioQueue = [];
let isSpeaking = false;
let availableVoices = [];

// Cargar las voces disponibles
function loadVoices() {
    availableVoices = window.speechSynthesis.getVoices();
}
if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
}

setInterval(() => {
    if (!isSpeaking && audioQueue.length > 0) {
        const next = audioQueue.shift();
        playText(next.text, next.lang);
    }
}, 100);

function speak(text, lang, isBomb = false) {
    if (isBomb) {
        if (!userSettings.audioBombs) return;
    } else {
        if (!userSettings.audioWords) return;
    }
    audioQueue.push({text, lang});
}

function getBestVoice(lang) {
    if (availableVoices.length === 0) loadVoices();
    
    // 1. Filtrar por idioma base (ej: 'es' para 'es-MX')
    const baseLang = lang.split('-')[0];
    const candidates = availableVoices.filter(v => v.lang.startsWith(baseLang));
    
    if (candidates.length === 0) return null;

    // 2. Sistema de Puntuación para encontrar la mejor voz
    // Preferimos: Coincidencia Exacta > Google/Premium > Default
    const scoreVoice = (v) => {
        let score = 0;
        if (v.lang === lang) score += 10; // Coincidencia exacta de región
        if (v.name.includes("Google") || v.name.includes("Premium") || v.name.includes("Enhanced")) score += 5; // Alta calidad
        if (v.default) score += 1;
        return score;
    };

    candidates.sort((a, b) => scoreVoice(b) - scoreVoice(a));
    return candidates[0];
}

function playText(text, lang) {
    if (!window.speechSynthesis) return;
    
    isSpeaking = true;
    window.speechSynthesis.cancel();
    
    let textToSpeak = text.toLowerCase();
    if (text.length === 1 && text.match(/[A-Z]/i)) textToSpeak = text.toLowerCase() + ".";
    
    const u = new SpeechSynthesisUtterance(textToSpeak);
    u.lang = lang; 
    u.rate = 1.1; 

    // Usar la lógica de mejor voz
    const bestVoice = getBestVoice(lang);
    if (bestVoice) u.voice = bestVoice;
    
    u.onend = () => { setTimeout(() => { isSpeaking = false; }, 400); };
    u.onerror = () => { isSpeaking = false; };

    window.speechSynthesis.speak(u);
}

function playSound(type) {
    // Check SFX Toggle
    if (!userSettings.audioFX) return;
    
    // Check if context exists/resume it
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    
    // Master Volume Check
    if(userSettings.masterVolume <= 0) return;
    const vol = userSettings.masterVolume / 100;

    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const n = audioCtx.currentTime;
    
    if(type==='shoot'){
        o.type='square'; o.frequency.setValueAtTime(400,n); o.frequency.exponentialRampToValueAtTime(100,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.1);
    }
    else if(type==='hit_eng'){
        o.type='sawtooth'; o.frequency.setValueAtTime(600,n); o.frequency.linearRampToValueAtTime(800,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.15);
    }
    else if(type==='hit_syn'){
        o.type='sine'; o.frequency.setValueAtTime(1200,n); o.frequency.linearRampToValueAtTime(1800,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.3);
    }
    else if(type==='player_hit'){
        o.type='sawtooth'; o.frequency.setValueAtTime(120,n); o.frequency.linearRampToValueAtTime(8,n+.3);
        g.gain.setValueAtTime(0.2 * vol, n); g.gain.linearRampToValueAtTime(0,n+.5);
    }
    else if(type==='firework'){ // NEW FIREWORK SOUND
        o.type='triangle'; o.frequency.setValueAtTime(300,n); o.frequency.exponentialRampToValueAtTime(50,n+.3);
        g.gain.setValueAtTime(0.2 * vol, n); g.gain.exponentialRampToValueAtTime(0.01,n+.3);
    }
    
    o.start(n); o.stop(n + 0.5);
}

let gameRunning=false, score=0, combo=0, lives=5, highScore=0, lastTime=0;
let spawnTimer = 0;
const player = {x:0, y:0, w:48, h:48, speed:8, color:'#4f46e5', invincible:false, invTimer:0}; 
let bullets=[], enemies=[], particles=[], stars=[], enemyBombs=[], keys={};

function loadHighScore(){const s=localStorage.getItem('synonymHunterHighScore');highScore=s?parseInt(s):0;highScoreEl.innerText=highScore;}

function populateStudyGuide(){
    document.getElementById('db-title').innerText = "DATABASE: " + userSettings.vocabSource;
    let html='<table><thead><tr><th class="chk-cell">PLAY?</th><th>ENGLISH</th><th>TRANSLATION</th></tr></thead><tbody>';
    activeVocabList.forEach(v => {
        const isChecked = !disabledWords.has(v.en);
        html += `<tr>
            <td class="chk-cell">
                <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleWordStatus('${v.en.replace(/'/g, "\\'")}')">
            </td>
            <td class="en-word">${v.en}</td>
            <td>${v.es[0]||"-"}</td>
        </tr>`;
    });
    html+='</tbody></table>';
    studyTableContainer.innerHTML=html;
}

function toggleStudyGuide(){
    const isOpen = studyGuide.style.display==='flex';
    if(isOpen){
        studyGuide.style.display='none';
        if(startScreen.style.display==='none' && gameOverScreen.style.display==='none'){
            gameRunning=true; lastTime=performance.now(); 
            gameLoopId = requestAnimationFrame(loop);
        }
    }else{
        gameRunning=false; cancelAnimationFrame(gameLoopId);
        populateStudyGuide(); studyGuide.style.display='flex';
        // Wake audio context on interaction
        if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    }
}

function resize(){
    canvas.width=innerWidth; canvas.height=innerHeight;
    player.y=canvas.height-130; player.x=canvas.width/2-player.w/2;
}
window.addEventListener('resize',resize);

for(let i=0;i<80;i++) stars.push({
    x:Math.random()*innerWidth, y:Math.random()*innerHeight,
    size:Math.random()*2, speed:Math.random()*0.2+0.1,
    alphaBase: Math.random()*0.5+0.3, phase: Math.random() * Math.PI * 2
});

function getRandomBombContent() {
    if (Math.random() > 0.5) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        return chars.charAt(Math.floor(Math.random() * chars.length));
    } else {
        return Math.floor(Math.random() * (9999 - 10) + 10).toString();
    }
}

function spawnEnemy(){
    if(gameDeck.length===0) return;
    const d=gameDeck[Math.floor(Math.random()*gameDeck.length)];
    ctx.font='16px "Press Start 2P"';
    const textWidth=ctx.measureText(d.en).width;
    const vx = (Math.random() - 0.5) * 2.0;
    const baseSpeed = (Math.random()*0.8+0.4) * userSettings.enemySpeed;

    enemies.push({
        x:Math.random()*(canvas.width-textWidth-50)+textWidth/2+25, 
        y:-40, 
        wordData:d, text:d.en, 
        stage:0, hits:0, 
        speed: baseSpeed, 
        vx: vx, 
        color:'#ffffff', 
        timer:0, fading:false, w:textWidth, droppedBomb: false 
    });
}

function createExplosion(x,y,c,n=10){
    for(let i=0;i<n;i++) {
        if(particles.length > 300) particles.shift(); 
        particles.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,life:1,color:c});
    }
}

function checkCollisionRect(r1, r2) {
    return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
}

function drawRobot(ctx, x, y, w, h, color) {
    ctx.fillStyle = color; ctx.fillRect(x + 8, y + 15, w - 16, h - 20);
    ctx.fillStyle = '#ccc'; ctx.fillRect(x + 4, y, w - 8, 20);
    ctx.fillStyle = gameRunning ? '#0f0' : '#f00';
    ctx.fillRect(x + 10, y + 5, 8, 8); ctx.fillRect(x + w - 18, y + 5, 8, 8);
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(x + w/2, y); ctx.lineTo(x + w/2, y - 10); ctx.stroke();
    const time = Date.now();
    ctx.fillStyle = (Math.floor(time/200)%2===0) ? 'red' : '#500';
    ctx.beginPath(); ctx.arc(x + w/2, y - 10, 3, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#555'; ctx.fillRect(x + 4, y + h - 5, 10, 5); ctx.fillRect(x + w - 14, y + h - 5, 10, 5);
}

// === OPTIMIZATION: 30 FPS LOCK ===
let lastFrameTime = 0;
const targetFPS = 30; // 30 FPS Retro Cap
const frameInterval = 1000 / targetFPS;

function loop(timestamp) {
    if (!gameRunning) return;

    // Request next frame immediately
    gameLoopId = requestAnimationFrame(loop);

    // === THROTTLE TO 30 FPS ===
    const elapsed = timestamp - lastFrameTime;
    if (elapsed < frameInterval) return;

    lastFrameTime = timestamp - (elapsed % frameInterval);

    // Calculate timeScale to maintain game speed at 30fps
    // Normalizing against standard 60fps (16.66ms)
    // At 30fps, elapsed is ~33ms, so timeScale is ~2.0
    const timeScale = elapsed / (1000/60); 

    update(elapsed, timeScale);
    draw(timestamp);
}

function update(dt, timeScale){
    // Clamp timeScale to prevent glitches if tab was inactive
    if(timeScale > 4) timeScale = 1;

    // QUIZ TIMER FIX: Independent from variable dt (uses fixed frame time)
    if (userSettings.quizEnabled) {
        quizTimer += 33; // ~33ms per frame locked at 30fps
        if (quizTimer >= userSettings.quizInterval * 1000) {
            triggerPopQuiz();
            return; 
        }
    }

    if(player.invincible){player.invTimer-=dt;if(player.invTimer<=0)player.invincible=false;}
    
    // MOVEMENT MULTIPLIED BY TIME SCALE
    if(keys['ArrowLeft']&&player.x>0)player.x -= player.speed * timeScale;
    if(keys['ArrowRight']&&player.x<canvas.width-player.w)player.x += player.speed * timeScale;
    
    stars.forEach(s=>{
        s.y += s.speed * timeScale; 
        if(s.y>canvas.height)s.y=0;
    });
    
    spawnTimer-=dt; 
    if(spawnTimer<0){spawnEnemy(); spawnTimer=gameVars.spawnInterval;}
    
    for(let i=enemyBombs.length-1; i>=0; i--){
        let b = enemyBombs[i];
        b.y += b.vy * timeScale; 
        b.x += (Math.sin(b.y * 0.05) * 1.5) * timeScale; 
        
        if(!player.invincible && checkCollisionRect(player, b)){
             lives--; livesEl.innerText=lives;
             createExplosion(player.x+player.w/2, player.y+player.h/2, '#ff4444', 30);
             playSound('player_hit');
             player.invincible=true; player.invTimer=2000;
             enemyBombs.splice(i,1);
             if(lives<=0){gameOver();return;}
             continue;
        }

        for(let j=bullets.length-1; j>=0; j--){
            let bullet = bullets[j];
            if(bullet.x > b.x-20 && bullet.x < b.x+b.w+20 && bullet.y > b.y && bullet.y < b.y+b.h){
                bullets.splice(j,1);
                createExplosion(b.x, b.y, b.color, 15);
                playSound('hit_eng');
                speak(b.text, 'en-US', true); // True = Is Bomb
                score += 25; scoreEl.innerText = score;
                enemyBombs.splice(i,1);
                break;
            }
        }
        if(b.y > canvas.height) enemyBombs.splice(i,1);
    }

    for(let i=bullets.length-1;i>=0;i--){
        bullets[i].y -= 12 * timeScale; // Scaled Bullet Speed
        if(bullets[i].y<0)bullets.splice(i,1);
    }
    
    for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        if(!e.fading && !e.droppedBomb && e.stage < 2 && Math.random() < (gameVars.bombProb * timeScale)) {
            e.droppedBomb = true; 
            enemyBombs.push({
                x: e.x, y: e.y + 40,
                text: getRandomBombContent(),
                color: `hsl(${Math.random()*360}, 100%, 70%)`,
                vy: e.speed + userSettings.bombSpeed, 
                w: 20, h: 30
            });
        }

        if(e.fading){createExplosion(e.x,e.y,e.color,1);enemies.splice(i,1);continue;}
        
        e.y += e.speed * timeScale; 
        e.x += e.vx * timeScale; 

        if (e.x < e.w/2 + 10 || e.x > canvas.width - e.w/2 - 10) {
            e.vx *= -1; 
            if(e.x < e.w/2 + 10) e.x = e.w/2 + 11;
            if(e.x > canvas.width - e.w/2 - 10) e.x = canvas.width - e.w/2 - 11;
        }

        const eRect = {x: e.x-e.w/2, y: e.y-15, w: e.w, h:30};
        if(!player.invincible && checkCollisionRect(player, eRect)){
            lives--;livesEl.innerText=lives;createExplosion(player.x+player.w/2,player.y+player.h/2,'#ff4444',30);playSound('player_hit');
            player.invincible=true;player.invTimer=2000;enemies.splice(i,1);combo=0;comboEl.innerText=combo;
            if(lives<=0){gameOver();return;}
            continue;
        }
        
        if(e.stage===1){e.timer+=dt;if(e.timer>4000)e.fading=true;}
        
        for(let j=bullets.length-1;j>=0;j--){
            const b=bullets[j];
            if(b.x>e.x-e.w/2-10 && b.x<e.x+e.w/2+10 && b.y>e.y-20 && b.y<e.y+10){
                bullets.splice(j,1); e.timer=0;
                
                if(e.stage===0){
                    e.hits++; 
                    if(e.hits === 1) speak(e.text, 'en-US', false); // False = Word
                    playSound('hit_eng');score+=10;
                    if(e.hits >= 3) {
                        e.stage = 1; e.text = e.wordData.es[0]; e.color='#00ff00';
                        createExplosion(e.x,e.y,'#00ff00',20);
                        score+=50; combo++;
                        ctx.font='20px "Press Start 2P"'; e.w = ctx.measureText(e.text).width;
                    }
                }
                else if(e.stage===1){
                    e.fading=true;
                    createExplosion(e.x,e.y,'#ffffff',40);
                    playSound('hit_syn'); score+=150; combo++;
                    speak(e.text, 'es-ES', false); // False = Word
                }
                scoreEl.innerText=score;comboEl.innerText=combo;
                break;
            }
        }
        if(e.y>canvas.height){if(e.stage<1)combo=0;comboEl.innerText=combo;enemies.splice(i,1);}
    }
    
    for(let i=particles.length-1;i>=0;i--){
        const p=particles[i]; 
        p.x += p.vx * timeScale; 
        p.y += p.vy * timeScale; 
        p.life -= 0.04 * timeScale; 
        if(p.life<=0)particles.splice(i,1);
    }
}

function draw(timestamp){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Stars
    stars.forEach(s=>{
        const opacity = s.alphaBase + Math.sin(timestamp * 0.005 + s.phase) * 0.2;
        ctx.fillStyle=`rgba(255,255,255,${Math.max(0.1, opacity)})`;
        ctx.beginPath();ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fill();
    });
    
    // Player
    if(!player.invincible||(Math.floor(Date.now()/100)%2===0)){
        drawRobot(ctx, player.x, player.y, player.w, player.h, player.color);
    }

    ctx.textAlign='center'; ctx.textBaseline='middle';
    
    // Bombs
    enemyBombs.forEach(b => {
        ctx.strokeStyle='#fff'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(b.x-10, b.y-15); ctx.lineTo(b.x-4, b.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(b.x+10, b.y-15); ctx.lineTo(b.x+4, b.y); ctx.stroke();
        ctx.fillStyle=b.color;
        // Simple shape instead of shadow
        ctx.beginPath(); ctx.arc(b.x, b.y-15, 12, Math.PI, 0); ctx.fill();
        ctx.font='12px "Press Start 2P"'; ctx.fillStyle='#fff';
        ctx.fillText(b.text, b.x, b.y+10);
    });

    // Bullets (High contrast instead of shadow)
    ctx.fillStyle='#ff0055';
    bullets.forEach(b=>ctx.fillRect(b.x-2,b.y,4,15));
    
    // Enemies
    enemies.forEach(e=>{
        ctx.font=e.stage>=1?'20px "Press Start 2P"':'16px "Press Start 2P"';
        ctx.fillStyle=e.color;
        
        // Use text stroke for "glow" effect (cheaper than shadowBlur)
        if(e.stage>=1){
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#003300';
            ctx.strokeText(e.text, e.x, e.y);
        }
        
        ctx.fillText(e.text,e.x,e.y);
        
        for(let k=0;k<4;k++){
            if(k<3) ctx.fillStyle = (e.stage===0 && k<e.hits) || e.stage>0 ? '#00ff00' : '#444';
            else ctx.fillStyle = '#444';
            ctx.beginPath();ctx.arc(e.x-22+(k*15),e.y+25,3,0,Math.PI*2);ctx.fill();
        }
    });
    
    // Particles
    particles.forEach(p=>{
        ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,3,3);
    });
    ctx.globalAlpha=1;
}

function gameOver(){
    gameRunning=false; cancelAnimationFrame(gameLoopId);
    if(score>highScore){highScore=score;localStorage.setItem('synonymHunterHighScore',highScore);highScoreEl.innerText=highScore;}
    document.getElementById('finalScore').innerText=score;
    gameOverScreen.style.display='flex';
}
function startGame(){
    if(gameRunning) return;
    
    // --- TRUCO PARA DESBLOQUEAR VOZ EN CELULAR ---
    // Al iniciar, forzamos al navegador a "hablar" silencio.
    // Esto le da permiso al juego para seguir hablando después.
    if(window.speechSynthesis) {
        window.speechSynthesis.cancel(); // Limpiar cola anterior
        let unlockVoice = new SpeechSynthesisUtterance(""); // Frase vacía
        unlockVoice.volume = 0; // Volumen 0 por si acaso
        window.speechSynthesis.speak(unlockVoice);
    }
    // ---------------------------------------------

    resize();
    startScreen.style.display='none'; gameOverScreen.style.display='none'; studyGuide.style.display='none';
    score=combo=0; lives=5; enemies=[]; bullets=[]; particles=[]; enemyBombs=[]; player.invincible=false;
    scoreEl.innerText=comboEl.innerText='0'; livesEl.innerText='5';
    loadHighScore();
    
    gameRunning=true; 
    lastFrameTime = performance.now(); 
    spawnTimer = gameVars.spawnInterval;
    quizTimer = 0;
    
    // Intentar reanudar el contexto de audio (Efectos de sonido)
    if(audioCtx.state==='suspended') audioCtx.resume().catch(e=>{});
    
    gameLoopId = requestAnimationFrame(loop);
}

// === MOBILE INPUT HANDLERS ===
const btnLeft = document.getElementById('btn-left');
const btnRight = document.getElementById('btn-right');
const btnFire = document.getElementById('btn-fire');

const handleTouchStart = (key) => {
    keys[key] = true;
    if(key === 'Space' && gameRunning) {
         bullets.push({x:player.x+player.w/2,y:player.y});
         playSound('shoot');
    }
};
const handleTouchEnd = (key) => {
    keys[key] = false;
};

// Add listeners preventing default to stop selection/zoom
['touchstart', 'mousedown'].forEach(evt => {
    btnLeft.addEventListener(evt, (e) => { e.preventDefault(); handleTouchStart('ArrowLeft'); });
    btnRight.addEventListener(evt, (e) => { e.preventDefault(); handleTouchStart('ArrowRight'); });
    btnFire.addEventListener(evt, (e) => { e.preventDefault(); handleTouchStart('Space'); });
});

['touchend', 'mouseup', 'mouseleave'].forEach(evt => {
    btnLeft.addEventListener(evt, (e) => { e.preventDefault(); handleTouchEnd('ArrowLeft'); });
    btnRight.addEventListener(evt, (e) => { e.preventDefault(); handleTouchEnd('ArrowRight'); });
    btnFire.addEventListener(evt, (e) => { e.preventDefault(); handleTouchEnd('Space'); });
});

document.addEventListener('keydown', e=>{
    if((e.code==='Tab'||e.code==='Escape') && startScreen.style.display==='none' && gameOverScreen.style.display==='none'){e.preventDefault(); toggleStudyGuide();}
    keys[e.code]=true;
    if(e.code==='Space' && gameRunning){
        e.preventDefault();
        bullets.push({x:player.x+player.w/2,y:player.y});
        playSound('shoot');
    }
});
document.addEventListener('keyup', e=>keys[e.code]=false);

window.onload=()=>{
    loadConfig(); 
    loadVocabData();
    resize();
    renderCategoryBar();
};
</script>
</body>
</html>

