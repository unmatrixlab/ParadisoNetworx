<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC Cloud Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #f2f2f7; --card-bg: #ffffff; --primary: #007AFF; --danger: #FF3B30;
            --success: #34C759; --warning: #FF9500; --text-main: #1c1c1e; --text-sec: #8e8e93; --border: #e5e5ea;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 600px; width: 100%; }
        .header { margin-bottom: 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-top: 5px; background: #e5e5ea; color: #888; }
        .status-badge.online { background: #d1fae5; color: var(--success); }
        .status-badge.error { background: #fee2e2; color: var(--danger); }

        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; text-transform: uppercase; color: var(--text-sec); background: rgba(255,255,255,0.5); display: flex; justify-content: space-between; align-items: center;}
        .data-row { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .data-row:last-child { border-bottom: none; }
        .data-label { font-weight: 500; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .data-value { color: var(--text-sec); font-size: 15px; }
        
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 17px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; margin-bottom: 10px; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        
        /* CLOUD BUTTONS */
        .btn-cloud-save { background: linear-gradient(135deg, #007AFF, #0056b3); color: white; box-shadow: 0 4px 15px rgba(0,122,255,0.3); }
        .btn-cloud-load { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-file { background: transparent; color: var(--text-sec); border: 1px solid var(--border); font-size: 14px; padding: 10px; }

        .app-icon { width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
        .last-sync { text-align: center; font-size: 12px; color: var(--text-sec); margin-top: -10px; margin-bottom: 20px; font-style: italic; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e5ea; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-msg" style="font-weight:600; color:var(--primary);">Processing...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>MDC Cloud Sync</h1>
            <span id="connection-status" class="status-badge">Connecting...</span>
        </div>

        <div class="card">
            <div class="card-header">
                <span>‚òÅÔ∏è CLOUD SYNC</span>
                <span style="font-size:10px;">FIREBASE</span>
            </div>
            <div style="padding: 20px;">
                <button class="btn btn-cloud-save" onclick="saveToCloud()">
                    ‚¨ÜÔ∏è SUBIR A LA NUBE (SAVE)
                </button>
                <button class="btn btn-cloud-load" onclick="loadFromCloud()">
                    ‚¨áÔ∏è BAJAR DE LA NUBE (RESTORE)
                </button>
                <div class="last-sync" id="last-sync-time">Nunca sincronizado en este dispositivo</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Local Data Status</div>
            <div class="data-row">
                <div class="data-label"><div class="app-icon" style="background: #4f46e5;">DB</div>Vocabulario</div>
                <div class="data-value" id="stat-vocab">...</div>
            </div>
            <div class="data-row">
                <div class="data-label"><div class="app-icon" style="background: #ef4444;">PL</div>Player History</div>
                <div class="data-value" id="stat-player">...</div>
            </div>
            <div class="data-row">
                <div class="data-label"><div class="app-icon" style="background: #007AFF;">AI</div>AI Exercises</div>
                <div class="data-value" id="stat-ai">...</div>
            </div>
            <div class="data-row">
                <div class="data-label"><div class="app-icon" style="background: #10b981;">LN</div>Game Progress</div>
                <div class="data-value" id="stat-game">...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Respaldo Manual (Archivo)</div>
            <div style="padding: 15px; display:flex; gap:10px;">
                <button class="btn btn-file" onclick="backupToFile()">üíæ Guardar .JSON</button>
                <button class="btn btn-file" onclick="document.getElementById('restore-input').click()">üìÇ Cargar .JSON</button>
                <input type="file" id="restore-input" accept=".json" onchange="restoreFromFile(this)">
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" style="background:transparent; color:var(--danger); border:1px solid var(--border); width:auto; padding:10px 20px; font-size:14px;" onclick="wipeSystem()">
                ‚ö†Ô∏è Borrar Datos Locales
            </button>
        </div>
    </div>

   <script>
        // ======================================================
        // ‚öôÔ∏è TUS CLAVES DE FIREBASE (Ya configuradas)
        // ======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAxXKLpXk4sa3TVN2pCustVkpxV_uMZjr8",
            authDomain: "nexushub-6bfc4.firebaseapp.com",
            databaseURL: "https://nexushub-6bfc4-default-rtdb.firebaseio.com",
            projectId: "nexushub-6bfc4",
            storageBucket: "nexushub-6bfc4.firebasestorage.app",
            messagingSenderId: "426532214270",
            appId: "1:426532214270:web:6816040ca1aba8e8655caf",
            measurementId: "G-NZZ1PLEH0V"
        };

        // Inicializar Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            
            const connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", (snap) => {
                const badge = document.getElementById('connection-status');
                if (snap.val() === true) {
                    badge.innerText = "üü¢ Conectado";
                    badge.className = "status-badge online";
                    checkCloudVersion(); // Revisar si hay versi√≥n m√°s nueva al conectar
                } else {
                    badge.innerText = "‚ö™ Desconectado";
                    badge.className = "status-badge";
                }
            });

        } catch (e) {
            alert("Error configurando Firebase: " + e.message);
        }

        const PREFIXES = ['mdc_', 'LN_'];
        // Claves principales para estad√≠sticas
        const KEYS = { vocab: 'mdc_vocab_list', history: 'mdc_studio_history', ai: 'mdc_ai_exercises', game: 'LN_V8_HYBRID' };

        document.addEventListener('DOMContentLoaded', () => {
            refreshStats();
            const last = localStorage.getItem('mdc_last_sync_date');
            if(last) document.getElementById('last-sync-time').innerText = "Tu √∫ltima copia local: " + last;
        });

        // --- L√ìGICA INTELIGENTE DE NUBE ---

        function showLoading(msg) {
            document.getElementById('loading-msg').innerText = msg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

        // Compara fechas para avisarte si vas a sobrescribir algo nuevo con algo viejo
        async function checkCloudVersion() {
            try {
                const snap = await db.ref('my_backup/meta').once('value');
                const meta = snap.val();
                if(meta && meta.timestamp) {
                    const localTime = parseInt(localStorage.getItem('mdc_last_sync_ts') || '0');
                    const cloudTime = meta.timestamp;
                    
                    const btnLoad = document.querySelector('.btn-cloud-load');
                    
                    if(cloudTime > localTime) {
                        btnLoad.innerHTML = "‚¨áÔ∏è BAJAR DE LA NUBE (Hay versi√≥n m√°s nueva üî•)";
                        btnLoad.style.borderColor = "#34C759";
                        btnLoad.style.color = "#34C759";
                    } else {
                        btnLoad.innerHTML = "‚¨áÔ∏è BAJAR DE LA NUBE (Restore)";
                        btnLoad.style.borderColor = "";
                        btnLoad.style.color = "";
                    }
                }
            } catch(e) { console.log("Check version skipped"); }
        }

        async function saveToCloud() {
            if(!db) return alert("Error de conexi√≥n.");
            showLoading("Subiendo...");

            const payload = {};
            let count = 0;
            // Recolectar datos
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (PREFIXES.some(p => key.startsWith(p))) {
                    const val = localStorage.getItem(key);
                    try { payload[key] = JSON.parse(val); } catch(e) { payload[key] = val; }
                    count++;
                }
            }

            if(count === 0) { hideLoading(); return alert("No hay datos para guardar."); }

            try {
                const now = Date.now();
                const dateStr = new Date().toLocaleString();
                
                // Guardamos en dos nodos: 'data' (pesado) y 'meta' (ligero para chequear fechas)
                await db.ref('my_backup').set({
                    data: payload,
                    meta: {
                        timestamp: now,
                        date_str: dateStr,
                        device: navigator.userAgent
                    }
                });
                
                // Actualizamos marcas de tiempo locales
                localStorage.setItem('mdc_last_sync_date', dateStr);
                localStorage.setItem('mdc_last_sync_ts', now);
                
                document.getElementById('last-sync-time').innerText = "Sincronizado: " + dateStr;
                hideLoading();
                // Feedback visual breve
                alert("‚úÖ Guardado en la nube correctamente.");
            } catch (error) {
                hideLoading();
                alert("‚ùå Error: " + error.message);
            }
        }

        async function loadFromCloud() {
            if(!db) return alert("Error de conexi√≥n.");
            
            // Confirmaci√≥n de seguridad
            if(!confirm("‚ö†Ô∏è CUIDADO: Esto BORRAR√Å los datos actuales de este dispositivo y pondr√° los de la nube.\n\n¬øSeguro que quieres reemplazar todo?")) return;

            showLoading("Descargando...");

            try {
                const snapshot = await db.ref('my_backup').once('value');
                const val = snapshot.val();

                if (!val || !val.data) {
                    hideLoading();
                    return alert("‚ö†Ô∏è No hay copia de seguridad en la nube.");
                }

                const cloudData = val.data;
                const cloudMeta = val.meta || {};

                // 1. LIMPIEZA QUIR√öRGICA: Borramos solo las claves del ecosistema antes de escribir
                // Esto asegura que si borraste una clave en la nube, se borre aqu√≠ tambi√©n.
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (PREFIXES.some(p => key.startsWith(p))) keysToRemove.push(key);
                }
                keysToRemove.forEach(k => localStorage.removeItem(k));

                // 2. RESTAURACI√ìN (Reemplazo total)
                let restoredCount = 0;
                Object.keys(cloudData).forEach(key => {
                    const content = cloudData[key];
                    if (typeof content === 'object') {
                        localStorage.setItem(key, JSON.stringify(content));
                    } else {
                        localStorage.setItem(key, content);
                    }
                    restoredCount++;
                });

                // 3. Actualizar fecha local para que coincida con la nube
                localStorage.setItem('mdc_last_sync_date', cloudMeta.date_str || new Date().toLocaleString());
                localStorage.setItem('mdc_last_sync_ts', cloudMeta.timestamp || Date.now());

                hideLoading();
                
                // 4. AUTO-RELOAD CR√çTICO
                // Esto evita el problema de la "Memoria Zombie". Al recargar, obligamos a todas
                // las pesta√±as a leer los datos nuevos.
                alert(`‚úÖ ¬°Restauraci√≥n completa!\n\nSe descargaron ${restoredCount} elementos del ${cloudMeta.date_str}.\n\nLa p√°gina se recargar√° para aplicar cambios.`);
                window.location.reload(); 

            } catch (error) {
                hideLoading();
                alert("‚ùå Error al bajar: " + error.message);
            }
        }

        // --- BACKUP MANUAL (ARCHIVO) ---
        function backupToFile() {
            const backup = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (PREFIXES.some(p => key.startsWith(p))) backup[key] = localStorage.getItem(key);
            }
            const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `MDC_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function restoreFromFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.keys(data).forEach(key => {
                        if (PREFIXES.some(p => key.startsWith(p))) localStorage.setItem(key, data[key]);
                    });
                    alert("Datos restaurados. Recargando...");
                    window.location.reload();
                } catch (err) { alert("Archivo inv√°lido."); }
            };
            reader.readAsText(file);
        }

        function refreshStats() {
            const getLen = (k) => { const s=localStorage.getItem(k); return s?JSON.parse(s).length:0; };
            updateRow('stat-vocab', getLen(KEYS.vocab) + " items", getLen(KEYS.vocab)>0);
            updateRow('stat-player', getLen(KEYS.history) + " videos", getLen(KEYS.history)>0);
            updateRow('stat-ai', getLen(KEYS.ai) + " sets", getLen(KEYS.ai)>0);
            const gameRaw = localStorage.getItem(KEYS.game);
            updateRow('stat-game', gameRaw ? "Activo" : "No Data", !!gameRaw);
        }

        function updateRow(id, text, active) {
            const el = document.getElementById(id);
            el.innerText = text;
            el.style.color = active ? 'var(--text-main)' : 'var(--text-sec)';
        }

        function wipeSystem() {
            if(confirm("¬øBORRAR TODO? Esto es irreversible.")) {
                const toRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (PREFIXES.some(p => key.startsWith(p))) toRemove.push(key);
                }
                toRemove.forEach(k => localStorage.removeItem(k));
                window.location.reload();
            }
        }
    </script>
</body>
</html>
