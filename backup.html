<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC System Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f2f2f7;
            --card-bg: #ffffff;
            --primary: #007AFF;
            --danger: #FF3B30;
            --success: #34C759;
            --text-main: #1c1c1e;
            --text-sec: #8e8e93;
            --border: #e5e5ea;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { max-width: 600px; width: 100%; }

        .header {
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }
        .header p { margin: 5px 0 0; color: var(--text-sec); font-size: 14px; }

        /* CARDS */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-sec);
            background: rgba(255,255,255,0.5);
        }

        .data-row {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .data-row:last-child { border-bottom: none; }

        .data-label { font-weight: 500; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .data-value { color: var(--text-sec); font-size: 15px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .dot-green { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .dot-gray { background: #d1d1d6; }

        /* BUTTONS */
        .action-group { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.98); opacity: 0.8; }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .btn-secondary { background: white; color: var(--primary); border: 1px solid var(--primary); }
        .btn-danger { background: white; color: var(--danger); border: 1px solid var(--danger); margin-top: 10px; font-size: 14px; padding: 12px;}

        /* STORAGE METER */
        .storage-meter {
            height: 6px;
            background: #f2f2f7;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        .storage-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.5s ease;
        }

        input[type="file"] { display: none; }

        .app-icon {
            width: 30px; height: 30px; 
            border-radius: 6px; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>MDC System Dashboard</h1>
            <p>Control Center & Backup Utility</p>
        </div>

        <div class="card">
            <div class="card-header">System Status</div>
            
            <div class="data-row">
                <div class="data-label">
                    <div class="app-icon" style="background: #4f46e5;">DB</div>
                    Vocabulary DB
                </div>
                <div class="data-value" id="stat-vocab">Checking...</div>
            </div>

            <div class="data-row">
                <div class="data-label">
                    <div class="app-icon" style="background: #ef4444;">PL</div>
                    Studio Player History
                </div>
                <div class="data-value" id="stat-player">Checking...</div>
            </div>

            <div class="data-row">
                <div class="data-label">
                    <div class="app-icon" style="background: #007AFF;">AI</div>
                    AI Exercises
                </div>
                <div class="data-value" id="stat-ai">Checking...</div>
            </div>

            <div class="data-row">
                <div class="data-label">
                    <div class="app-icon" style="background: #10b981;">LN</div>
                    Lingua Nexus Progress
                </div>
                <div class="data-value" id="stat-game">Checking...</div>
            </div>

            <div class="data-row" style="display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span class="data-label" style="font-size:13px; color:var(--text-sec);">TOTAL STORAGE USED</span>
                    <span class="data-value" id="stat-total-size">0 KB</span>
                </div>
                <div class="storage-meter"><div class="storage-fill" id="storage-bar"></div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Data Management</div>
            <div class="action-group">
                <button class="btn btn-primary" onclick="backupSystem()">
                    <span>☁️</span> Backup Full Ecosystem
                </button>
                
                <button class="btn btn-secondary" onclick="document.getElementById('restore-input').click()">
                    <span>Pb</span> Restore from Backup
                </button>
                <input type="file" id="restore-input" accept=".json" onchange="restoreSystem(this)">
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-danger" onclick="wipeSystem()">
                ⚠️ Factory Reset (Delete All Data)
            </button>
            <p style="font-size: 11px; color: var(--text-sec); margin-top: 10px;">
                This will delete localStorage for: mdc_*, LN_*
            </p>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        // Prefijos que definen tu ecosistema
        const PREFIXES = ['mdc_', 'LN_'];

        // Nombres de claves específicas para mostrar estadísticas
        const KEYS = {
            vocab: 'mdc_vocab_list',
            history: 'mdc_studio_history',
            ai: 'mdc_ai_exercises',
            game: 'LN_V8_HYBRID'
        };

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            refreshStats();
        });

        // === STATISTICS LOGIC ===
        function refreshStats() {
            // 1. Vocab Count
            const vocabRaw = localStorage.getItem(KEYS.vocab);
            const vocabCount = vocabRaw ? JSON.parse(vocabRaw).length : 0;
            updateRow('stat-vocab', vocabCount > 0, `${vocabCount} items`);

            // 2. Player History
            const histRaw = localStorage.getItem(KEYS.history);
            const histCount = histRaw ? JSON.parse(histRaw).length : 0;
            updateRow('stat-player', histCount > 0, `${histCount} videos`);

            // 3. AI Exercises
            const aiRaw = localStorage.getItem(KEYS.ai);
            const aiCount = aiRaw ? JSON.parse(aiRaw).length : 0;
            updateRow('stat-ai', aiCount > 0, `${aiCount} sets`);

            // 4. Lingua Nexus
            const gameRaw = localStorage.getItem(KEYS.game);
            let gameLabel = "No Data";
            let hasGame = false;
            if (gameRaw) {
                const gameData = JSON.parse(gameRaw);
                const banned = gameData.banned ? gameData.banned.length : 0;
                const mastered = gameData.prog ? Object.keys(gameData.prog).filter(k => gameData.prog[k].lvl === 4).length : 0;
                gameLabel = `M: ${mastered} | Banned: ${banned}`;
                hasGame = true;
            }
            updateRow('stat-game', hasGame, gameLabel);

            // 5. Total Size Calculation
            let totalBytes = 0;
            let ecosystemBytes = 0;
            
            for (let key in localStorage) {
                if (!localStorage.hasOwnProperty(key)) continue;
                const size = (localStorage[key].length + key.length) * 2; // aprox bytes
                totalBytes += size;
                if (PREFIXES.some(p => key.startsWith(p))) {
                    ecosystemBytes += size;
                }
            }

            const kb = (ecosystemBytes / 1024).toFixed(2);
            document.getElementById('stat-total-size').innerText = `${kb} KB`;
            
            // Visual bar (Assuming 5MB limit typical for browsers, visual scale just for effect)
            const pct = Math.min(100, (ecosystemBytes / (1024 * 1024 * 5)) * 100 * 50); // Scale up for visibility
            document.getElementById('storage-bar').style.width = Math.max(1, pct) + '%';
        }

        function updateRow(id, isActive, text) {
            const el = document.getElementById(id);
            el.innerHTML = text;
            el.style.color = isActive ? 'var(--text-main)' : 'var(--text-sec)';
            if(isActive) el.innerHTML += ' <span class="status-dot dot-green"></span>';
            else el.innerHTML += ' <span class="status-dot dot-gray"></span>';
        }

        // === BACKUP FUNCTION ===
        function backupSystem() {
            const backup = {};
            let count = 0;

            // Iterar sobre todo localStorage y filtrar
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (PREFIXES.some(p => key.startsWith(p))) {
                    backup[key] = localStorage.getItem(key);
                    count++;
                }
            }

            if (count === 0) {
                alert("No MDC/LN data found to backup.");
                return;
            }

            // Crear y descargar archivo
            const dateStr = new Date().toISOString().slice(0, 10);
            const fileName = `MDC_Full_Backup_${dateStr}.json`;
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // === RESTORE FUNCTION ===
        function restoreSystem(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    let restoredCount = 0;

                    // Validación básica
                    const keys = Object.keys(data);
                    const validKeys = keys.filter(k => PREFIXES.some(p => k.startsWith(p)));

                    if (validKeys.length === 0) {
                        alert("Error: This JSON does not contain valid MDC system data.");
                        return;
                    }

                    if (!confirm(`Found ${validKeys.length} items. This will OVERWRITE current data. Continue?`)) {
                        input.value = '';
                        return;
                    }

                    validKeys.forEach(key => {
                        localStorage.setItem(key, data[key]);
                        restoredCount++;
                    });

                    alert(`Success! Restored ${restoredCount} system items.`);
                    refreshStats();
                } catch (err) {
                    alert("Error parsing backup file: " + err);
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        // === WIPE FUNCTION ===
        function wipeSystem() {
            if (confirm("Are you sure? This will DELETE ALL progress, vocabulary, and settings for ALL MDC apps.")) {
                if (confirm("Really? There is no undo.")) {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (PREFIXES.some(p => key.startsWith(p))) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(k => localStorage.removeItem(k));
                    alert("System wiped clean.");
                    refreshStats();
                }
            }
        }
    </script>
</body>
</html>
