<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scribe's Shelf: Ultimate Study</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #0f0;
            --neon-red: #ff4444;
            --neon-blue: #4f46e5;
            --neon-yellow: #ffff00;
            --dark-bg: #050505;
            --panel-bg: rgba(0, 15, 0, 0.95);
        }
        body {
            margin: 0; overflow: hidden; background: var(--dark-bg);
            font-family: 'Press Start 2P', monospace; color: white; user-select: none;
        }
        canvas { display: block; }
       
        /* CRT SCANLINE EFFECT */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 999; pointer-events: none;
        }
        /* UI Overlays */
        #ui {
            position: absolute; top: 20px; left: 20px; right: 20px; z-index: 10;
            pointer-events: none; display: flex; justify-content: space-between;
            text-shadow: 2px 2px 0 #000;
        }
        #lives-panel { color: var(--neon-red); }
        #score-panel { color: var(--neon-green); }
        /* INPUT BAR */
        #input-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 60px;
            background: rgba(0, 0, 0, 0.9); z-index: 15;
            display: flex; justify-content: center; align-items: center;
            border-top: 2px solid var(--neon-green);
            box-shadow: 0 -5px 20px rgba(0, 255, 0, 0.2);
        }
        #typing-input {
            width: 70%; max-width: 600px;
            background: #111; color: var(--neon-green);
            border: 2px solid #005500; padding: 12px;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px; text-transform: uppercase;
            outline: none; text-align: center;
            transition: all 0.2s;
        }
        #typing-input:focus {
            border-color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        /* CATEGORY BAR */
        #category-bar-wrapper {
            position: absolute; bottom: 60px; left: 0; width: 100%;
            padding: 10px 0; background: rgba(0, 0, 0, 0.8);
            z-index: 14;
            overflow-x: auto; white-space: nowrap; display: flex; justify-content: center;
            border-top: 1px solid #333;
        }
        .category-chip {
            padding: 8px 16px; margin: 0 8px; background: #111; color: #666;
            font-size: 10px; cursor: pointer; border: 1px solid #444; transition: 0.2s;
            pointer-events: all; display: inline-block;
        }
        .category-chip:hover { border-color: #888; color: #888; }
        .category-chip.active {
            color: var(--neon-green); background: #002200;
            border-color: var(--neon-green); box-shadow: 0 0 10px var(--neon-green);
        }
        .category-chip.help-btn {
            border-color: var(--neon-yellow); color: var(--neon-yellow);
        }
        .category-chip.help-btn:hover {
            background: #222200; box-shadow: 0 0 10px var(--neon-yellow);
        }
        /* SCREENS */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
        }
        .blink { animation: blinker 1s linear infinite; color: var(--neon-green); margin-top: 20px; cursor: pointer;}
        @keyframes blinker { 50% { opacity: 0; } }
       
        h1 { color: var(--neon-green); text-shadow: 4px 4px 0 #003300; margin-bottom: 30px; line-height: 1.5; }
        p { color: #ccc; font-size: 12px; line-height: 1.8; max-width: 600px; padding: 0 20px;}
        #study-content {
            background: var(--panel-bg);
            padding: 30px;
            border: 2px solid var(--neon-green);
            width: 80%; max-width: 800px; height: 70%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.2);
        }
        #study-content::-webkit-scrollbar { width: 10px; }
        #study-content::-webkit-scrollbar-track { background: #111; }
        #study-content::-webkit-scrollbar-thumb { background: #333; border: 1px solid var(--neon-green); }
        #study-content table {
            width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px;
            font-size: 12px;
        }
        #study-content th {
            color: var(--neon-green); text-align: left;
            border-bottom: 2px solid var(--neon-green); padding: 10px;
            position: sticky; top: 0; background: #001500; z-index: 2;
        }
        #study-content td {
            padding: 12px 10px; border-bottom: 1px solid #333; color: #aaa;
        }
        #study-content tr:hover td { background: #002200; color: #fff; cursor: crosshair; }
        #study-content .en-word { color: var(--neon-blue); font-weight: bold; }
       
        .close-btn {
            position: absolute; top: 15px; right: 20px;
            font-size: 20px; color: var(--neon-red); cursor: pointer; border: 1px solid var(--neon-red);
            padding: 5px 10px; z-index: 10;
        }
        .close-btn:hover { background: var(--neon-red); color: #000; }
        .key-hint {
            display: inline-block; padding: 2px 6px;
            border: 1px solid #666; border-radius: 4px;
            color: #fff; background: #222; font-size: 10px;
            box-shadow: 1px 1px 0 #000;
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="ui">
        <div id="score-panel">SCORE: <span id="score">0</span> | COMBO: <span id="combo">0</span></div>
        <div id="lives-panel">LIVES: <span id="lives">5</span></div>
        <div id="high-score-panel">HIGH: <span id="highScore">0</span></div>
    </div>
   
    <div id="category-bar-wrapper"></div>
    <div id="input-bar">
        <input type="text" id="typing-input" placeholder="TYPE ANSWER HERE" autocomplete="off">
    </div>

    <div id="start-screen" class="overlay-screen" onclick="startGame()">
        <h1>SCRIBE'S SHELF<br><span style="font-size: 14px; color: #fff;">VOCABULARY DEFENSE</span></h1>
        <p>
            1. Enemies appear with a Spanish definition or synonym.<br>
            2. Type the correct English word to destroy them.<br>
            3. Don't let them reach the left side.<br><br>
            <span class="key-hint">ENTER</span> Submit Answer <br>
            <span class="key-hint">TAB</span> Open Study Guide
        </p>
        <div class="blink">CLICK TO INITIALIZE SYSTEM</div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;" onclick="startGame()">
        <h1 style="color: var(--neon-red);">SYSTEM FAILURE</h1>
        <p>FINAL SCORE: <span id="finalScore" style="color:white;">0</span></p>
        <p>NEW HIGH SCORE: <span id="newHighScore" style="color: var(--neon-green);">NO</span></p>
        <div class="blink">CLICK TO REBOOT</div>
    </div>

    <div id="study-guide" class="overlay-screen" style="display:none;">
        <div id="study-content">
            <span class="close-btn" onclick="toggleStudyGuide()">X</span>
            <h2 style="color: var(--neon-green); margin-top: 0; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 10px;">
                DATABASE: <span id="study-category-title" style="color: white;">NOUNS</span>
            </h2>
            <div id="study-table-container"></div>
            <p style="margin-top: 20px; text-align: center; color: #666; font-size: 10px;">
                GAME PAUSED. PRESS <span class="key-hint">TAB</span> OR <span class="key-hint">ESC</span> TO RESUME.
            </p>
        </div>
    </div>
   
    <canvas id="gameCanvas"></canvas>

<script>
/* --- BASE DE DATOS --- */
const wordsDB = {
    'NOUNS': [
        {en: "MALAISE", es: ["MALESTAR", "INDISPOSICIÓN", "DECAIMIENTO"]},
        {en: "CULMINATION", es: ["EPÍLOGO", "CESE", "PERORATA"]},
        {en: "AVARICE", es: ["CODICIA", "USURA", "CAJETERÍA"]},
        {en: "MENDICANT", es: ["INDIGENTE", "MENDIGO", "LIMOSNERO"]},
        {en: "TREPIDATION", es: ["TEMOR", "MIEDO", "RECELO"]}
    ],
    'VERBS': [
        {en: "PREVARICATE", es: ["ENGAÑAR", "EVASIVA", "MENTIR"]},
        {en: "ESCHEW", es: ["EVITAR", "REHUIR", "ELUDIR"]},
        {en: "JETTISON", es: ["DESECHAR", "ABANDONAR", "DESCARTAR"]},
        {en: "DENIGRATE", es: ["DIFAMAR", "CALUMNIAR", "VILIPENDIAR"]},
        {en: "UPBRAID", es: ["CRITICAR", "REPRENDER", "RECENSURAR"]}
    ],
    'ADJECTIVES': [
        {en: "PLIABLE", es: ["DÚCTIL", "MOLDEABLE", "FLEXIBLE"]},
        {en: "ERUDITE", es: ["DOCTO", "VERSADO", "SABIO"]},
        {en: "LACONIC", es: ["CONCISO", "SUCINTO", "BREVE"]},
        {en: "STOLID", es: ["IMPÁVIDO", "IMPONENTE", "APLOMADO"]},
        {en: "SANGUINE", es: ["OPTIMISTA", "ENTUSIASTA", "VITAL"]}
    ]
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const livesEl = document.getElementById('lives');
const highScoreEl = document.getElementById('highScore');
const typingInput = document.getElementById('typing-input');
const categoryBarWrapper = document.getElementById('category-bar-wrapper');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const studyGuide = document.getElementById('study-guide');
const studyCategoryTitle = document.getElementById('study-category-title');
const studyTableContainer = document.getElementById('study-table-container');
const inputBar = document.getElementById('input-bar');

/* --- AUDIO --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let musicInterval;

function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    if (type === 'hit_correct') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
        gain.gain.setValueAtTime(0.08, now); gain.gain.linearRampToValueAtTime(0, now + 0.15);
        osc.start(now); osc.stop(now + 0.15);
    } else if (type === 'hit_review') {
        osc.type = 'square'; osc.frequency.setValueAtTime(440, now);
        gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.15);
    } else if (type === 'hit_final') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(1500, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'hit_fail') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
        osc.start(now); osc.stop(now + 0.5);
    }
}

function startMusic() {
    let step = 0;
    const melody = [110, 0, 130, 0, 164, 0, 130, 0];
    if(musicInterval) clearInterval(musicInterval);
    musicInterval = setInterval(() => {
        if(melody[step] > 0) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'triangle';
            osc.frequency.value = melody[step] * 0.5;
            gain.gain.value = 0.02;
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.25);
        }
        step = (step + 1) % melody.length;
    }, 400);
}

/* --- GAME STATE --- */
let gameRunning = false;
let score = 0;
let combo = 0;
let lives = 5;
let highScore = 0;
let lastTime = 0;
let currentCategory = 'NOUNS';
const SPAWN_INTERVAL = 3000;
let spawnTimer = SPAWN_INTERVAL;
let enemies = [];
let particles = [];
let stars = [];

for(let i=0; i<60; i++) {
    stars.push({
        x: Math.random() * window.innerWidth,
        y: Math.random() * window.innerHeight,
        size: Math.random() * 2,
        speed: Math.random() * 0.5 + 0.1
    });
}

function loadHighScore() {
    const saved = localStorage.getItem('scribeShelfHighScore');
    highScore = saved ? parseInt(saved) : 0;
    highScoreEl.innerText = highScore;
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);

/* --- CORE LOGIC --- */
function setCategory(category) {
    currentCategory = category;
    renderCategoryBar();
    enemies.forEach(e => e.fading = true);
    if(studyGuide.style.display === 'flex') populateStudyGuide();
}

function spawnEnemy() {
    const words = wordsDB[currentCategory];
    if (!words || words.length === 0) return;
    const data = words[Math.floor(Math.random() * words.length)];
    const synonymIndex = (Math.random() < 0.5) ? 1 : 2;
    ctx.font = '16px "Press Start 2P"';
    const textWidth = ctx.measureText(data.en).width * 1.2;

    enemies.push({
        x: canvas.width + 50,
        y: Math.random() * (canvas.height - 250) + 80,
        wordData: data,
        text: data.en,
        stage: 0,
        synonymIndex: synonymIndex,
        speed: 0.6 + (score / 2500),
        color: '#ffffff',
        timer: 0,
        w: textWidth,
        fading: false
    });
}

function createExplosion(x, y, color, count=10) {
    for(let i=0; i<count; i++) {
        particles.push({
            x, y,
            vx: (Math.random() - 0.5) * 8,
            vy: (Math.random() - 0.5) * 8,
            life: 1.0,
            color
        });
    }
}

function getRequiredAnswer(enemy) {
    switch (enemy.stage) {
        case 0: return enemy.wordData.es[0].toLowerCase();
        case 1: return enemy.wordData.es[enemy.synonymIndex].toLowerCase();
        case 2: return enemy.wordData.en.toLowerCase();
        case 3: return enemy.wordData.en.toLowerCase();
        default: return "";
    }
}

function advanceEnemyStage(enemy) {
    enemy.stage++;
    enemy.timer = 0;
    if (enemy.stage === 1) {
        enemy.text = enemy.wordData.es[0];
        enemy.color = '#00ff00';
        playSound('hit_correct');
        score += 10;
    } else if (enemy.stage === 2) {
        enemy.text = enemy.wordData.es[enemy.synonymIndex];
        enemy.color = '#ffff00';
        createExplosion(enemy.x, enemy.y, '#ffff00', 15);
        playSound('hit_correct');
        score += 50;
        combo++;
    } else if (enemy.stage === 3) {
        enemy.text = enemy.wordData.en;
        enemy.color = '#4f46e5';
        createExplosion(enemy.x, enemy.y, '#4f46e5', 10);
        playSound('hit_review');
        score += 100;
        combo++;
    } else if (enemy.stage === 4) {
        enemy.fading = true;
        createExplosion(enemy.x, enemy.y, '#ffffff', 30);
        playSound('hit_final');
        score += 150;
        combo++;
    }
    scoreEl.innerText = score;
    comboEl.innerText = combo;
}

function checkAnswer() {
    const inputVal = typingInput.value.trim().toUpperCase();
    if (!inputVal) return;

    let target = null;
    let lowestX = Infinity;
    for (let e of enemies) {
        if (!e.fading && e.x < lowestX) {
            lowestX = e.x;
            target = e;
        }
    }

    if (target) {
        const required = getRequiredAnswer(target).toUpperCase();
        if (inputVal === required) {
            advanceEnemyStage(target);
            typingInput.value = '';
            typingInput.style.borderColor = '#00ff00';
            setTimeout(() => typingInput.style.borderColor = '#005500', 200);
        } else {
            lives--;
            livesEl.innerText = lives;
            typingInput.style.borderColor = '#ff4444';
            setTimeout(() => typingInput.style.borderColor = '#005500', 300);
            playSound('hit_fail');
            combo = 0;
            comboEl.innerText = combo;
            if (lives <= 0) gameOver();
        }
    }
}

function update(dt) {
    if (!gameRunning) return;
    spawnTimer -= dt;
    if (spawnTimer < 0) { spawnEnemy(); spawnTimer = SPAWN_INTERVAL; }

    stars.forEach(s => { s.y += s.speed; if(s.y > canvas.height) s.y = 0; });

    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        if (e.fading) {
            createExplosion(e.x, e.y, e.color, 1);
            enemies.splice(i, 1);
            continue;
        }
        e.x -= e.speed;
        if (e.stage >= 1) e.timer += dt;
        if (e.stage >= 1 && e.timer > 8000) e.fading = true;

        if (e.x < -100) {
            lives--;
            livesEl.innerText = lives;
            enemies.splice(i, 1);
            combo = 0;
            comboEl.innerText = combo;
            playSound('hit_fail');
            if (lives <= 0) gameOver();
        }
    }

    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy;
        p.life -= 0.04;
        if (p.life <= 0) particles.splice(i, 1);
    }
}

function draw() {
    if (!gameRunning) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    stars.forEach(s => {
        ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.5+0.3})`;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
    });

    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    enemies.forEach(e => {
        ctx.font = e.stage >= 1 ? '20px "Press Start 2P"' : '16px "Press Start 2P"';
        ctx.fillStyle = e.color;
        if (e.stage >= 1) { ctx.shadowBlur = 15; ctx.shadowColor = e.color; }
        ctx.fillText(e.text, e.x, e.y);
        ctx.shadowBlur = 0;

        for(let k=0; k<4; k++) {
            ctx.fillStyle = k < e.stage ? '#00ff00' : '#333';
            ctx.beginPath();
            ctx.arc(e.x - 22 + (k*15), e.y + 25, 3, 0, Math.PI*2);
            ctx.fill();
        }
    });

    particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 4, 4);
    });
    ctx.globalAlpha = 1;

    requestAnimationFrame(() => {
        const now = performance.now();
        update(now - lastTime);
        lastTime = now;
        draw();
    });
}

function gameOver() {
    gameRunning = false;
    clearInterval(musicInterval);
    const newHS = score > highScore;
    if (newHS) {
        highScore = score;
        localStorage.setItem('scribeShelfHighScore', highScore);
        highScoreEl.innerText = highScore;
    }
    document.getElementById('finalScore').innerText = score;
    document.getElementById('newHighScore').innerText = newHS ? 'YES!' : 'NO';
    gameOverScreen.style.display = 'flex';
    inputBar.style.display = 'none';
}

/* --- UI --- */
function renderCategoryBar() {
    categoryBarWrapper.innerHTML = '';
    Object.keys(wordsDB).forEach(cat => {
        const chip = document.createElement('div');
        chip.className = 'category-chip' + (cat === currentCategory ? ' active' : '');
        chip.textContent = cat;
        chip.onclick = () => setCategory(cat);
        categoryBarWrapper.appendChild(chip);
    });
    const helpBtn = document.createElement('div');
    helpBtn.className = 'category-chip help-btn';
    helpBtn.textContent = 'HELP / STUDY';
    helpBtn.onclick = toggleStudyGuide;
    categoryBarWrapper.appendChild(helpBtn);
}

function populateStudyGuide() {
    studyCategoryTitle.textContent = currentCategory;
    const words = wordsDB[currentCategory];
    let html = '<table><thead><tr><th>ENGLISH</th><th>PRIMARY</th><th>SYN A</th><th>SYN B</th></tr></thead><tbody>';
    words.forEach(w => {
        html += `<tr><td class="en-word">${w.en}</td><td>${w.es[0]||"-"}</td><td>${w.es[1]||"-"}</td><td>${w.es[2]||"-"}</td></tr>`;
    });
    html += '</tbody></table>';
    studyTableContainer.innerHTML = html;
}

/* === FUNCIÓN CLAVE CORREGIDA === */
function toggleStudyGuide() {
    const isOpen = studyGuide.style.display === 'flex';

    if (isOpen) {
        // CERRAR STUDY GUIDE → REANUDAR JUEGO
        studyGuide.style.display = 'none';

        // ¡¡LO MÁS IMPORTANTE!! Recuperar foco (funciona en iframe)
        setTimeout(() => {
            typingInput.focus();
            typingInput.select();
        }, 100);

        if (gameRunning || (!gameOverScreen.style.display && startScreen.style.display === 'none')) {
            gameRunning = true;
            lastTime = performance.now();
            startMusic();
            draw();
        }
    } else {
        // ABRIR STUDY GUIDE → PAUSAR
        gameRunning = false;
        clearInterval(musicInterval);
        populateStudyGuide();
        studyGuide.style.display = 'flex';
    }
}

/* --- CONTROLES MEJORADOS --- */
document.addEventListener('keydown', e => {
    // Tab o Escape siempre abren/cierran el study guide (si el juego está activo)
    if ((e.code === 'Tab' || e.code === 'Escape') && 
        startScreen.style.display === 'none' && 
        gameOverScreen.style.display === 'none') {
        e.preventDefault();
        toggleStudyGuide();
    }

    // Enter envía la respuesta
    if (e.key === 'Enter' && gameRunning) {
        e.preventDefault();
        checkAnswer();
    }
});

// Recuperar foco al hacer clic en cualquier lado del juego
canvas.addEventListener('click', () => {
    if (gameRunning && studyGuide.style.display === 'none') {
        typingInput.focus();
    }
});

document.body.addEventListener('click', () => {
    if (gameRunning && studyGuide.style.display === 'none' && gameOverScreen.style.display === 'none') {
        setTimeout(() => typingInput.focus(), 50);
    }
});

/* --- INICIO --- */
function startGame() {
    if (gameRunning) return;
    resize();
    loadHighScore();
    startScreen.style.display = 'none';
    gameOverScreen.style.display = 'none';
    studyGuide.style.display = 'none';
    inputBar.style.display = 'flex';

    score = combo = 0; lives = 5;
    enemies.length = particles.length = 0;
    scoreEl.innerText = comboEl.innerText = '0';
    livesEl.innerText = '5';

    renderCategoryBar();
    gameRunning = true;
    lastTime = performance.now();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    startMusic();
    draw();
    typingInput.focus();
}

window.addEventListener('load', () => {
    resize();
    renderCategoryBar();
    loadHighScore();
});
</script>
</body>
</html>
