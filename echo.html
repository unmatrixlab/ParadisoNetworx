<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINGUA NEXUS | ECHO STREAM PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --bg-deep: #050505;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --text-main: #ffffff;
            --glass: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* === SCANLINE & VIGNETTE === */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.7); /* Vi√±eta oscura en bordes */
        }

        /* === STREAM CONTAINER === */
        #stream-container {
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .echo-card {
            width: 100%;
            height: 100%;
            scroll-snap-align: start;
            scroll-snap-stop: always; /* üöÄ SENSACI√ìN S√ìLIDA AL PARAR */
            position: relative;
            background: #000;
            overflow: hidden;
        }

        /* === VIDEO LAYER (ZOOM HACK) === */
        /* üöÄ Hacemos el video m√°s grande que la caja para simular object-fit: cover */
        .video-layer {
            position: absolute; 
            top: -15%; left: -15%; width: 130%; height: 130%; /* Zoom in */
            pointer-events: none; /* Clicks pasan al overlay */
            transition: opacity 0.5s;
            opacity: 0;
        }
        .echo-card.playing .video-layer { opacity: 1; }
        
        /* Iframe ocupa todo el espacio del wrapper aumentado */
        .video-layer iframe { width: 100%; height: 100%; }

        /* === INTERACTION OVERLAY (CLICK ZONE) === */
        .click-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; cursor: pointer;
        }

        /* === PLAY/PAUSE ICON ANIMATION === */
        .center-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            font-size: 80px; color: rgba(255,255,255,0.8);
            opacity: 0; pointer-events: none; transition: 0.2s; z-index: 60;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .paused-state .center-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* === HUD LAYER === */
        .hud-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px;
            padding-bottom: 90px; /* Espacio para barra progreso y nav */
            z-index: 10;
            /* üöÄ Gradiente m√°s profesional y legible */
            background: linear-gradient(to top, 
                rgba(0,0,0,0.95) 0%, 
                rgba(0,0,0,0.6) 50%, 
                rgba(0,0,0,0) 100%);
            pointer-events: none; /* Dejar pasar clicks al video */
        }

        .meta-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
            padding: 4px 8px; border-radius: 4px;
            display: inline-flex; align-items: center; gap: 6px;
            margin-bottom: 10px; border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
        }
        
        .main-word {
            font-family: 'Syncopate', sans-serif;
            font-size: 36px; line-height: 1; font-weight: 700;
            color: #fff; text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.4); /* Neon glow */
            margin-bottom: 5px;
        }

        .translation {
            font-size: 16px; color: var(--neon-pink); font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            margin-bottom: 10px;
        }

        .context-sentence {
            font-size: 15px; color: #ccc; line-height: 1.5; font-style: italic;
            border-left: 3px solid var(--neon-blue);
            padding-left: 10px;
        }

        /* BLIND MODE */
        .blind-active .main-word, 
        .blind-active .translation, 
        .blind-active .context-sentence {
            filter: blur(12px); opacity: 0; transition: 0.3s;
        }

        /* === PROGRESS BAR === */
        .progress-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
            background: rgba(255,255,255,0.1);
            z-index: 20;
        }
        .progress-bar {
            height: 100%; width: 0%;
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue);
            transition: width 0.1s linear;
        }

        /* === CONTROLS RAIL === */
        .controls-rail {
            position: absolute; right: 15px; bottom: 120px; z-index: 30;
            display: flex; flex-direction: column; gap: 20px;
            pointer-events: auto; /* Reactivar clicks aqu√≠ */
        }

        .rail-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white; font-size: 22px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .rail-btn:active { transform: scale(0.9); }
        .rail-btn.active { color: var(--bg-deep); background: var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue); border-color: var(--neon-blue); }

        /* === LOADER === */
        .loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; border-radius: 50%;
            border: 3px solid transparent; border-top-color: var(--neon-blue); border-bottom-color: var(--neon-pink);
            animation: spin 0.8s ease-in-out infinite; z-index: 5;
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        .empty-state {
            height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #666; font-family: monospace;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <div id="stream-container"></div>

    <script>
        const STORAGE_KEY = 'mdc_vocab_list';
        let items = [];
        let players = {}; 
        let progressIntervals = {}; // üöÄ Para la barra de progreso
        let observer;
        let blindMode = false;

        function init() {
            loadData();
            renderStream();
            setupObserver();
        }

        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                const all = JSON.parse(raw || '[]');
                items = [];
                const extractItems = (list) => {
                    list.forEach(item => {
                        if (item.isFolder && item.items) extractItems(item.items);
                        else if (item.source && item.source.type === 'youtube') items.push(item);
                    });
                };
                extractItems(all);
                items.sort(() => Math.random() - 0.5);
            } catch (e) { items = []; }
        }

        function renderStream() {
            const container = document.getElementById('stream-container');
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state"><h2>SYSTEM OFFLINE</h2><p>Please load vocabulary.</p></div>`;
                return;
            }

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'echo-card';
                card.id = `card-${index}`;
                card.dataset.index = index;
                card.dataset.videoId = item.source.videoId;
                
                // üöÄ C√°lculo mejorado: Buffer de 1.5s antes y 3s despu√©s
                const startT = Math.max(0, parseFloat(item.source.timestamp) - 1.5);
                const endT = parseFloat(item.source.timestamp) + 3.0;
                
                card.dataset.start = startT;
                card.dataset.end = endT;

                card.innerHTML = `
                    <div class="loader"></div>
                    
                    <div class="video-layer" id="video-wrapper-${index}"></div>
                    
                    <div class="click-zone" onclick="togglePlayPause(${index})"></div>
                    <div class="center-icon">‚ñ∂</div>

                    <div class="hud-layer">
                        <div class="meta-tag">
                            <span>‚óè REC</span>
                            <span>${new Date(item.dateAdded || Date.now()).toLocaleDateString()}</span>
                        </div>
                        <div class="main-word">${item.eng}</div>
                        <div class="translation">${item.esp || '...'}</div>
                        <div class="context-sentence">"${item.source.context || '...'}"</div>
                    </div>

                    <div class="controls-rail">
                        <button class="rail-btn" onclick="toggleBlindMode(this)" title="Blind Mode">üëÅÔ∏è</button>
                        <button class="rail-btn" onclick="replayCard(${index})" title="Replay">‚Ü∫</button>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar" id="progress-${index}"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function setupObserver() {
            const options = { root: document.getElementById('stream-container'), threshold: 0.7 }; // 0.7 requiere que el 70% de la tarjeta est√© visible
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const idx = entry.target.dataset.index;
                    if (entry.isIntersecting) loadAndPlayVideo(idx);
                    else destroyVideo(idx);
                });
            }, options);
            document.querySelectorAll('.echo-card').forEach(card => observer.observe(card));
        }

        function loadAndPlayVideo(index) {
            const card = document.getElementById(`card-${index}`);
            if(!card) return;
            const videoId = card.dataset.videoId;
            const start = parseFloat(card.dataset.start);
            const end = parseFloat(card.dataset.end);

            if (players[index]) return; 

            const tempDiv = document.createElement('div');
            tempDiv.id = `yt-player-${index}`;
            document.getElementById(`video-wrapper-${index}`).innerHTML = ''; 
            document.getElementById(`video-wrapper-${index}`).appendChild(tempDiv);

            players[index] = new YT.Player(`yt-player-${index}`, {
                height: '100%', width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1, 'controls': 0, 'rel': 0, 'showinfo': 0,
                    'modestbranding': 1, 'playsinline': 1, 'iv_load_policy': 3, 'fs': 0, 'disablekb': 1,
                    'start': Math.floor(start) // Ayuda a cargar cerca
                },
                events: {
                    'onReady': (event) => {
                        event.target.mute();
                        event.target.seekTo(start, true);
                        event.target.playVideo();
                        
                        // üöÄ Fade In de Audio para elegancia
                        setTimeout(() => {
                            event.target.unMute();
                            event.target.setVolume(100);
                        }, 400);

                        card.querySelector('.loader').style.display = 'none';
                        card.classList.add('playing');
                        
                        // üöÄ Iniciar Tracking de Progreso
                        startProgressTracking(index, start, end);
                    },
                    'onStateChange': (event) => {
                        if (event.data === YT.PlayerState.ENDED) {
                            event.target.seekTo(start, true);
                            event.target.playVideo();
                        }
                    }
                }
            });
        }

        // üöÄ Nueva funci√≥n para manejar el Loop y la Barra de Progreso manualmente
        function startProgressTracking(index, start, end) {
            if(progressIntervals[index]) clearInterval(progressIntervals[index]);
            
            const progressBar = document.getElementById(`progress-${index}`);
            const duration = end - start;
            
            progressIntervals[index] = setInterval(() => {
                const player = players[index];
                if(!player || !player.getCurrentTime) return;

                const current = player.getCurrentTime();
                
                // L√≥gica de Loop Manual (M√°s precisa que YouTube Playlist)
                if(current >= end) {
                    player.seekTo(start, true);
                }

                // Actualizar barra visual
                const percent = ((current - start) / duration) * 100;
                if(progressBar) progressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;

            }, 100); // 10fps es suficiente para UI fluida
        }

        function togglePlayPause(index) {
            const player = players[index];
            const card = document.getElementById(`card-${index}`);
            if (!player || typeof player.getPlayerState !== 'function') return;

            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
                card.classList.add('paused-state'); // Muestra icono
            } else {
                player.playVideo();
                card.classList.remove('paused-state'); // Oculta icono
            }
        }

        function destroyVideo(index) {
            if(progressIntervals[index]) clearInterval(progressIntervals[index]); // Limpiar intervalo
            
            if (players[index]) {
                try { players[index].destroy(); } catch(e){}
                delete players[index];
                const card = document.getElementById(`card-${index}`);
                if(card) {
                    card.classList.remove('playing', 'paused-state');
                    card.querySelector('.loader').style.display = 'block';
                    document.getElementById(`video-wrapper-${index}`).innerHTML = '';
                    const bar = document.getElementById(`progress-${index}`);
                    if(bar) bar.style.width = '0%';
                }
            }
        }

        // --- CONTROLS ---
        window.toggleBlindMode = function(btn) {
            blindMode = !blindMode;
            btn.classList.toggle('active', blindMode);
            document.querySelectorAll('.echo-card').forEach(card => {
                const hud = card.querySelector('.hud-layer');
                if(blindMode) hud.classList.add('blind-active');
                else hud.classList.remove('blind-active');
            });
        };

        window.replayCard = function(index) {
            if(players[index]) {
                const card = document.getElementById(`card-${index}`);
                const start = parseFloat(card.dataset.start);
                players[index].seekTo(start, true);
                players[index].playVideo();
                card.classList.remove('paused-state');
            }
        };

        window.onYouTubeIframeAPIReady = function() { console.log("Echo Stream Pro: Ready"); };

        init();
    </script>
</body>
</html>
