<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Code Runner (Hard Reset)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-editor: #1e1e1e;
            --bg-ui: #252526;
            --accent: #4f46e5;
            --accent-hover: #4338ca;
            --text-main: #e5e7eb;
            --text-sec: #9ca3af;
            --border: #3f3f46;
        }

        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: black;
        }

        /* --- EDITOR (Panel Superior) --- */
        .editor-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 55%;
            background-color: var(--bg-editor);
            display: flex; flex-direction: column;
            border-bottom: 4px solid var(--accent);
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .editor-wrapper.collapsed {
            transform: translateY(-100%);
        }

        .editor-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: var(--bg-ui); border-bottom: 1px solid var(--border);
        }
        .app-title { font-size: 14px; font-weight: 700; color: var(--text-sec); letter-spacing: 1px; }
        .app-title span { color: var(--accent); }

        #htmlInput {
            flex-grow: 1;
            background-color: var(--bg-editor);
            color: #d4d4d4;
            border: none;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            outline: none;
            line-height: 1.5;
        }

        .action-bar {
            padding: 10px 15px;
            background: var(--bg-ui);
            display: flex; gap: 10px; align-items: center;
            border-top: 1px solid var(--border);
        }

        /* --- BOTONES --- */
        .btn {
            border: none; border-radius: 6px; padding: 10px 20px;
            font-size: 13px; font-weight: 700; cursor: pointer;
            transition: 0.2s; font-family: 'Inter', sans-serif;
        }
        .btn-run { background-color: var(--accent); color: white; flex-grow: 1; max-width: 200px; display: flex; justify-content: center; gap: 10px; align-items: center; }
        .btn-run:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        .btn-run:active { transform: translateY(0); }
        
        .btn-icon { background: transparent; color: var(--text-sec); padding: 10px; font-size: 16px; }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.1); }

        /* --- HISTORIAL --- */
        .history-container {
            flex-grow: 1; display: flex; gap: 5px; overflow-x: auto; padding-bottom: 2px;
        }
        .history-container::-webkit-scrollbar { height: 4px; }
        .history-container::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px; }

        .hist-chip {
            background: #2d2d30; color: var(--text-sec);
            padding: 5px 10px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; cursor: pointer;
            border: 1px solid transparent; transition: 0.2s;
            max-width: 100px; overflow: hidden; text-overflow: ellipsis;
        }
        .hist-chip:hover { border-color: var(--accent); color: white; background: #3f3f46; }

        /* --- CONTENEDOR DEL RESULTADO --- */
        #preview-container {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: black;
            z-index: 1;
        }
        
        /* Iframe generado din√°micamente */
        iframe {
            width: 100%; height: 100%; border: none; display: block;
        }

        /* --- BOT√ìN FLOTANTE EDITAR --- */
        #floating-edit {
            position: fixed; top: 15px; right: 15px;
            background: var(--bg-ui); color: white;
            padding: 10px 15px; border-radius: 30px;
            font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
            z-index: 200;
            transform: translateY(-150%);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; gap: 8px; font-size: 13px;
        }
        #floating-edit.visible { transform: translateY(0); }
        #floating-edit:hover { background: var(--accent); border-color: var(--accent); }

    </style>
</head>
<body>

    <div class="editor-wrapper" id="editorPanel">
        <div class="editor-header">
            <div class="app-title">CODE <span>RUNNER</span></div>
            <div style="font-size: 11px; color: #666;">Ctrl + Enter</div>
        </div>
        
        <textarea id="htmlInput" placeholder="Pega tu c√≥digo aqu√≠..." spellcheck="false"></textarea>

        <div class="action-bar">
            <div class="history-container" id="historyList"></div>
            <button class="btn btn-icon" onclick="clearEditor()" title="Borrar">üóëÔ∏è</button>
            <button class="btn btn-run" id="runBtn">
                RUN <span>‚ñ∂</span>
            </button>
        </div>
    </div>

    <button id="floating-edit" onclick="toggleEditor(true)">‚úèÔ∏è EDIT</button>

    <div id="preview-container"></div>

    <script>
        const MAX_HISTORY = 10;
        const STORAGE_KEY = 'mdc_code_runner_v3';

        // Elementos
        const editorPanel = document.getElementById('editorPanel');
        const floatingBtn = document.getElementById('floating-edit');
        const input = document.getElementById('htmlInput');
        const container = document.getElementById('preview-container');
        const runBtn = document.getElementById('runBtn');
        const historyList = document.getElementById('historyList');

        // --- FUNCI√ìN NUCLEAR: RUN ---
        function runCode() {
            const code = input.value;
            
            // 1. Limpieza Total: Borramos el iframe anterior si existe
            container.innerHTML = '';

            // 2. Creaci√≥n Din√°mica: Creamos un iframe nuevo desde cero
            const iframe = document.createElement('iframe');
            
            // Atributos de seguridad permisivos para juegos locales
            iframe.setAttribute('sandbox', 'allow-scripts allow-modals allow-same-origin allow-pointer-lock allow-forms');
            
            // 3. Inyecci√≥n en el DOM
            container.appendChild(iframe);

            // 4. Escritura del c√≥digo
            // Usamos un peque√±o timeout para asegurar que el iframe est√° listo en el DOM
            setTimeout(() => {
                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(code);
                doc.close();

                // 5. ENFOQUE (CRUCIAL PARA EL JUEGO)
                // Le damos el foco a la ventana del iframe para que capte el teclado
                iframe.contentWindow.focus();
            }, 10);

            // 6. Guardar y Ocultar UI
            if(code.trim().length > 0) saveToHistory(code);
            toggleEditor(false);
        }

        // --- UI ---
        function toggleEditor(show) {
            if(show) {
                editorPanel.classList.remove('collapsed');
                floatingBtn.classList.remove('visible');
                input.focus();
            } else {
                editorPanel.classList.add('collapsed');
                floatingBtn.classList.add('visible');
            }
        }

        // --- HISTORIAL ---
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            renderHistoryUI(history);
            if(history.length > 0 && input.value === '') input.value = history[0];
        }

        function saveToHistory(code) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if (history.length > 0 && history[0] === code) return; // No duplicar el actual

            history = history.filter(item => item !== code); // Mover al principio si existe
            history.unshift(code);
            
            if(history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);

            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistoryUI(history);
        }

        function renderHistoryUI(history) {
            historyList.innerHTML = '';
            if(history.length === 0) {
                historyList.innerHTML = '<span style="font-size:11px; color:#555; padding:5px;">Historial vac√≠o</span>';
                return;
            }
            history.forEach((snippet, index) => {
                // Intentar sacar un t√≠tulo del c√≥digo (<title> o primeros caracteres)
                let titleMatch = snippet.match(/<title>(.*?)<\/title>/i);
                let cleanSnippet = snippet.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
                let displayTitle = titleMatch ? titleMatch[1] : (cleanSnippet.substring(0, 12) || `Code ${index + 1}`);
                
                const chip = document.createElement('div');
                chip.className = 'hist-chip';
                chip.textContent = displayTitle;
                chip.onclick = () => {
                    input.value = snippet;
                    // Feedback visual
                    input.style.opacity = '0.5';
                    setTimeout(() => input.style.opacity = '1', 200);
                };
                historyList.appendChild(chip);
            });
        }

        function clearEditor() {
            if(confirm("¬øBorrar c√≥digo actual?")) {
                input.value = '';
                input.focus();
            }
        }

        // --- EVENTOS ---
        runBtn.addEventListener('click', runCode);

        document.addEventListener('keydown', (e) => {
            // Ejecutar con Ctrl + Enter
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            // Abrir editor con Escape si est√° oculto
            if (e.key === 'Escape' && editorPanel.classList.contains('collapsed')) {
                toggleEditor(true);
            }
        });

        // Iniciar
        loadHistory();

    </script>
</body>
</html>
