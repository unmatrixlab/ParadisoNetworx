<!DOCTYPE html>
<html lang="en">   
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Generator (Persistent Pill V5)</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
   <style>
    /* =========================================
       MDC V16 COLOR PALETTE (ONLY COLORS CHANGED)
       ========================================= */
    :root {
        /* Nuevos colores base V16 */
        --bg: #111827;           /* Deep Blue Gray BG */
        --surface: #1f2937;      /* Panel BG */
        --primary: #6366f1;      /* Indigo Primary */
        --text: #f3f4f6;         /* Main Text */
        --border: #374151;       /* Subtle Borders */
        
        /* Colores de estado/acci√≥n V16 */
        --accent-active: #6366f1; /* Unifying with primary */
        --danger: #ef4444;        /* Red V16 */
        --success: #10b981;       /* Green V16 (used for paste btn) */
        
        /* Colores de palabras (Actualizados a tonos V16) */
        --saved-word: #f472b6;    /* V16 Pink */
        --phrase-word: #fbbf24;   /* Amber Bright (MDC Source) */
        
        /* DAW Specifics (Re-colored to V16) */
        --daw-bg: #1f2937;        /* Matching surface */
        --daw-screen-bg: #000;    /* Keep black screen */
        --daw-text: #10b981;      /* Using Success Green for DAW text */
        
        /* Text Muted Utility */
        --text-muted: #9ca3af;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Segoe UI', monospace, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0; padding: 0;
        display: flex; flex-direction: column; align-items: center;
        overflow-x: hidden; width: 100%; padding-bottom: 80px; 
        user-select: none; 
    }

    /* === LAYOUT === */
    #generator-container {
        width: 100%; max-width: none; background: var(--surface);
        padding: 20px; margin: 0; border-bottom: 1px solid var(--border);
        transition: all 0.3s ease;
    }
    .hidden { display: none !important; }
    h2 { margin-top: 0; color: var(--primary); text-align: center; }

    /* === VOCAB PANEL === */
    #vocab-controls {
        background: var(--bg); /* Changed from #181818 */
        border: 1px solid var(--border); /* Changed from #333 */
        border-left: 4px solid var(--border); /* Changed from #444 */
        border-radius: 6px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    #vocab-controls.active-panel {
        border-left-color: var(--saved-word);
        background: rgba(244, 114, 182, 0.05); /* Changed from #1f1a1d to tinted BG */
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .vocab-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px 15px; cursor: pointer; user-select: none;
    }
    .vocab-toggle-wrapper {
        display: flex; align-items: center; gap: 12px;
        font-weight: 600; color: var(--text-muted); /* Changed from #ccc */
        font-size: 1rem; transition: color 0.3s;
    }
    #vocab-controls.active-panel .vocab-toggle-wrapper {
        color: white; text-shadow: 0 0 8px rgba(244, 114, 182, 0.4); /* Updated pink shadow */
    }
    .custom-checkbox {
        appearance: none; -webkit-appearance: none;
        width: 40px; height: 22px; 
        background: var(--border); /* Changed from #333 */
        border-radius: 20px;
        position: relative; cursor: pointer; transition: background 0.3s; flex-shrink: 0;
    }
    .custom-checkbox::after {
        content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
        background: var(--text-muted); /* Changed from #888 */
        border-radius: 50%; transition: transform 0.3s, background 0.3s;
    }
    .custom-checkbox:checked { 
        background: rgba(244, 114, 182, 0.2); /* Updated pink rgba */
        border: 1px solid var(--saved-word); 
    }
    .custom-checkbox:checked::after {
        transform: translateX(18px); background: var(--saved-word); box-shadow: 0 0 8px var(--saved-word);
    }
    .vocab-badge {
        background: var(--surface); /* Changed from #252525 */
        color: var(--text-muted); /* Changed from #777 */
        padding: 4px 8px; border-radius: 4px;
        font-size: 0.75rem; font-family: 'Roboto Mono', monospace; letter-spacing: 0.5px;
        border: 1px solid var(--border); /* Changed from #333 */
        white-space: nowrap; transition: all 0.3s;
    }
    #vocab-controls.active-panel .vocab-badge {
        border-color: var(--saved-word); color: var(--saved-word); 
        background: rgba(244, 114, 182, 0.05); /* Updated pink rgba */
    }
    .vocab-settings {
        padding: 15px; 
        background: var(--bg); /* Changed from #141414 */
        border-top: 1px solid var(--border); /* Changed from #333 */
        display: none; animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* === INPUTS === */
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    @media (max-width: 600px) { .grid-container { grid-template-columns: 1fr; } } 
    
    label { display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-muted); /* Changed from #aaa */ }
    input, select, textarea { 
        width: 100%; 
        background: var(--surface); /* Changed from #2d2d2d */
        border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; outline: none; 
    }
    input:disabled { 
        opacity: 0.5; cursor: not-allowed; 
        background: var(--bg); /* Changed from #222 */
        border-color: var(--border); /* Changed from #333 */
        color: var(--text-muted); /* Changed from #777 */
    }
    
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    button { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; border: none; border-radius: 4px; transition: background 0.2s; }
    
    #btn-generate { 
        background-color: var(--primary); color: white; /* Changed text to white for contrast */
    }
    #btn-paste { 
        background-color: var(--success); /* Changed from Teal #03dac6 to V16 Green */
        color: white; /* Changed text to white */
    }
    #btn-show-gen { 
        background-color: var(--surface); /* Changed from #333 */
        color: #fff; margin: 0; padding: 15px; display: none; width: 100%; border-radius: 0; 
    }
    #prompt-output { margin-top: 20px; background: #000; padding: 15px; border: 1px solid var(--primary); font-family: monospace; white-space: pre-wrap; display: none; }

    /* === SEARCH & RESULTS === */
    #search-container { width: 100%; background: var(--surface); padding: 10px 20px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
    #searchBar { 
        width: 100%; 
        background: var(--bg); /* Changed from #121212 */
        border: 1px solid var(--border); /* Changed from #333 */
        color: white; padding: 12px; border-radius: 4px; font-size: 16px; 
    }
    #results-container { width: 100%; padding: 0 20px 20px 20px; }
    .accordion-item { background: var(--surface); border: 1px solid var(--border); margin-bottom: 10px; border-radius: 4px; overflow: hidden; }
    .accordion-header { 
        padding: 15px; 
        background: rgba(255,255,255,0.05); /* Changed from #252525 to slight tint */
        cursor: pointer; display: flex; justify-content: space-between; align-items: center; 
    }
    .header-content { display: flex; flex-direction: column; gap: 4px; }
    .meta-tag { 
        background: var(--border); /* Changed from #333 */
        padding: 2px 6px; border-radius: 4px; font-size: 0.8em; display: inline-block; width: fit-content; 
    }
    .btn-delete { 
        background: transparent; 
        color: var(--text-muted); /* Changed from #666 */
        border: 1px solid var(--border); /* Changed from #444 */
        padding: 5px 12px; border-radius: 4px; font-size: 1.2em; 
    }
    .accordion-content { padding: 15px; display: none; border-top: 1px solid var(--border); font-size: 0.95em; line-height: 1.6; }
    .accordion-content.active { display: block; }
    
    .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .copy-prompt-btn, .save-phrase-btn { border: none; padding: 8px 12px; font-size: 0.85em; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; }
    
    .copy-prompt-btn { 
        background: var(--primary); color: white; /* Changed text to white */
    }
    
    .save-phrase-btn { background: #374151; color: white; border: 1px solid #4b5563; opacity: 0.5; pointer-events: none; transition: all 0.2s; }
    .save-phrase-btn.ready { opacity: 1; pointer-events: all; background: var(--phrase-word); border-color: white; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); color: black; }

    /* === INTERACTIVE WORD SYSTEM (MDC STUDIO EXACT REPLICA) === */
    .interactive-word { 
        border-radius: 4px; padding: 2px 1px; cursor: pointer; display: inline-block; 
        border-bottom: 2px solid transparent; transition: all 0.2s; 
    }
    .interactive-word:hover { 
        background-color: rgba(99, 102, 241, 0.2); 
        border-bottom-color: var(--primary); 
        color: white; 
    }
    
    /* PALABRA GUARDADA (ROSA) - SIN SUBRAYADO */
    .interactive-word.saved { 
        color: var(--saved-word) !important; 
        font-weight: 700; 
        border-bottom: none !important; 
    }

    /* FRASE GUARDADA (√ÅMBAR - EFECTO CONTINUO) */
    .interactive-word.phrase-saved {
        background-color: var(--phrase-word) !important; /* √Åmbar brillante */
        color: #111827 !important;            /* Texto oscuro para contraste */
        
        /* EL TRUCO DE UNI√ìN: */
        margin: 0 !important;
        box-shadow: 4px 0 0 var(--phrase-word), -4px 0 0 var(--phrase-word) !important;
        
        padding: 2px 0 !important;
        border-radius: 2px !important; /* Bordes casi rectos para que encajen */
        
        position: relative;
        z-index: 1; /* Asegura que el color tape cualquier l√≠nea divisoria */
        font-weight: 700;
        border-bottom: none;
    }

    /* SELECCI√ìN MANUAL (VISUAL PRE-GUARDADO) */
    .interactive-word.phrase-selecting {
        background-color: rgba(245, 158, 11, 0.5) !important; 
        color: white !important;
        border-bottom: 2px solid var(--phrase-word);
        /* No shadow yet, separate words until saved */
    }

    /* === DAW AUDIO PLAYER === */
    .daw-panel {
        background: linear-gradient(to bottom, var(--surface), var(--bg)); /* Changed gradient colors */
        border: 1px solid var(--border); /* Changed from #444 */
        border-radius: 6px; padding: 12px; margin: 10px 0 20px 0;
        display: flex; flex-direction: column; gap: 12px;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 4px 10px rgba(0,0,0,0.5);
        font-family: 'Roboto Mono', monospace;
    }
    .daw-top-deck { display: flex; gap: 10px; width: 100%; height: 44px; }
    .daw-btn-play {
        width: 44px; height: 44px; 
        background: var(--bg); /* Changed from #111 */
        border: 2px solid var(--border); /* Changed from #555 */
        border-radius: 4px; 
        color: var(--text-muted); /* Changed from #888 */
        cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    }
    .daw-btn-play:active { transform: translateY(2px); box-shadow: inset 0 4px 8px rgba(0,0,0,0.8); }
    .daw-btn-play.playing { 
        color: var(--success); /* Changed from #0f0 */
        border-color: var(--success); 
        text-shadow: 0 0 8px var(--success); 
        box-shadow: inset 0 0 15px rgba(16, 185, 129, 0.2); /* Updated success rgba */
        background: rgba(16, 185, 129, 0.1); /* Changed from #001100 */
    }
    .daw-screen {
        flex: 1; background: var(--daw-screen-bg); 
        border: 1px solid var(--border); /* Changed from #333 */
        border-radius: 2px;
        display: flex; align-items: center; padding: 0 12px; 
        color: var(--daw-text); /* Using new V16 success/cyan color */
        font-size: 0.85em;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.8); position: relative; overflow: hidden; white-space: nowrap;
    }
    .daw-screen.active { color: var(--success); } /* Changed from #0f0 */
    .daw-control-deck { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; }
    .daw-knob-group { display: flex; flex-direction: column; gap: 4px; }
    .daw-label { font-size: 0.65em; color: var(--text-muted); /* Changed from #777 */ text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
    .daw-slider { -webkit-appearance: none; width: 100%; height: 24px; background: transparent; margin: 0; }
    .daw-slider::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #000; border: 1px solid var(--border); /* Changed from #333 */ border-radius: 3px; }
    .daw-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 10px; background: var(--text-muted); /* Changed from #888 */ border: 1px solid #000; border-radius: 2px; margin-top: -7px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .daw-select { 
        background: var(--bg); /* Changed from #111 */
        color: var(--text); /* Changed from #ccc */
        border: 1px solid var(--border); /* Changed from #444 */
        font-family: 'Roboto Mono', monospace; font-size: 0.8em; padding: 8px; width: 100%; border-radius: 2px; height: 32px; 
    }
    @media (min-width: 768px) {
        .daw-panel { flex-direction: row; height: 60px; }
        .daw-top-deck { width: auto; flex: 1; }
        .daw-control-deck { display: flex; gap: 20px; width: auto; }
        .daw-slider { width: 100px; }
        .daw-select { width: 140px; }
    }

    /* === UNIFIED PILL (Bottom Center) === */
    #unified-pill {
        position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(150%);
        background: rgba(31, 41, 55, 0.95); /* Updated to V16 panel rgba */
        backdrop-filter: blur(12px);
        border: 1px solid var(--border); /* Used variable */
        border-radius: 50px;
        padding: 8px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
        display: flex; align-items: center; gap: 15px; 
        z-index: 5000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-width: 95%; white-space: nowrap;
    }
    #unified-pill.visible { transform: translateX(-50%) translateY(0); }

    .pill-section { display: flex; align-items: center; gap: 8px; }
    .pill-icon { font-size: 1.1em; }
    
    #pill-stats-text {
        font-family: 'Roboto Mono', monospace; font-weight: 800; font-size: 1em; 
        color: var(--text); /* Updated to variable */
        letter-spacing: 1px;
    }
    .stats-active { color: var(--saved-word) !important; }

    .pill-divider { width: 1px; height: 16px; background: var(--border); /* Updated to variable */ }

    #pill-trans { display: none; }
    #pill-trans.active { display: flex; align-items: center; gap: 8px; }
    
    /* OCULTAMOS EL ORIGEN (INGL√âS) Y LA FLECHA */
    .trans-origin, .trans-arrow { display: none; }
    .trans-result { color: #fff; font-weight: 700; font-size: 0.95em; }

    /* Bot√≥n de parlante en la p√≠ldora */
    .pill-speak-btn {
        background: none; border: none; cursor: pointer;
        font-size: 1.2em; padding: 0 0 0 8px; color: var(--primary);
        display: flex; align-items: center; transition: color 0.2s;
    }
    .pill-speak-btn:hover { color: #fff; }

    /* === MAGIC CIRCLE === */
    #magic-circle {
        position: fixed;
        width: 50px; height: 50px;
        border-radius: 50%;
        background: rgba(99, 102, 241, 0.3); /* Updated to primary rgba */
        border: 2px solid var(--primary);
        box-shadow: 0 0 15px var(--primary);
        z-index: 6000;
        top: 50%; left: 85%; /* Default position */
        touch-action: none; /* Critical for dragging */
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; cursor: move;
        backdrop-filter: blur(2px);
    }
    #magic-circle::after { content: 'üîç'; opacity: 0.8; }

    /* Ocultar en escritorio (pantallas grandes) */
    @media (min-width: 769px) {
        #magic-circle { display: none; }
    }

       .interactive-word.saved.phrase-saved {
        color: var(--saved-word) !important; /* Forza el rosa */
        z-index: 2; /* Se asegura de estar por encima */
        /* Opcional: una peque√±a sombra para que se lea bien sobre el amarillo */
        text-shadow: 0 1px 0 rgba(0,0,0,0.2); 
    }

       /* === PILL SAVE ACTION === */
    .pill-save-action {
        display: none; /* Oculto por defecto */
        background: var(--phrase-word); /* Color √Åmbar */
        color: #000; /* Texto negro para contraste */
        border: none;
        font-weight: 800;
        font-family: 'Roboto Mono', monospace;
        font-size: 1em;
        padding: 5px 15px;
        border-radius: 20px;
        cursor: pointer;
        width: 100%;
        text-align: center;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
        animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* Cuando estamos en "Modo Selecci√≥n", ocultamos stats y trad */
    #unified-pill.selection-mode #pill-stats-group,
    #unified-pill.selection-mode #pill-divider,
    #unified-pill.selection-mode #pill-trans {
        display: none !important;
    }

    #unified-pill.selection-mode .pill-save-action {
        display: block;
    }
    
    /* Ajuste para que la p√≠ldora cambie de color de borde al seleccionar */
    #unified-pill.selection-mode {
        border-color: var(--phrase-word);
        background: rgba(20, 20, 20, 0.98);
    }

</style>
</head>
<body>

   <div id="unified-pill">
        <div id="pill-stats-group" class="pill-section">
            <span class="pill-icon">üìä</span>
            <span id="pill-stats-text">- | 0</span>
        </div>
        
        <div id="pill-divider" class="pill-divider" style="display:none;"></div>

        <div id="pill-trans" class="pill-section">
            <span id="trans-origin" class="trans-origin">...</span>
            <span class="trans-arrow">‚Üí</span>
            <span id="trans-result" class="trans-result">...</span>
            <button id="pill-speak" class="pill-speak-btn">üîä</button>
        </div>

        <button id="pill-save-btn" class="pill-save-action" onclick="savePhraseFromPill()">
            üíæ SAVE PHRASE
        </button>
    </div>

    <button id="btn-show-gen" onclick="toggleGenerator(true)">‚ûï New Generation</button>

    <div id="generator-container">
        <h2>Prompt Engineer</h2>
        
        <div id="vocab-controls">
            <div class="vocab-header" onclick="document.getElementById('useVocabCheckbox').click()">
                <div class="vocab-toggle-wrapper">
                    <input type="checkbox" id="useVocabCheckbox" class="custom-checkbox" onclick="event.stopPropagation()" onchange="toggleVocabMode()">
                    <span>Inject MDC Vocab</span>
                </div>
                <span id="vocab-count-badge" class="vocab-badge">Checking DB...</span>
            </div>

            <div id="vocab-settings" class="vocab-settings">
                <div class="grid-container" style="margin-bottom:0;">
                    <div>
                        <label>Source</label>
                        <select id="vocabSource">
                            <option value="all">üåê All Words</option>
                            <option value="highlighted">‚≠ê Highlighted</option>
                            <option value="recent">Hz Recent (10)</option>
                            <optgroup id="folder-group" label="üìÇ Folders"></optgroup>
                        </select>
                    </div>
                    <div>
                        <label>Amount (Words)</label>
                        <input type="number" id="vocabAmount" value="5" min="1" max="50">
                    </div>
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top:10px; font-style:italic; border-top: 1px solid #222; padding-top: 5px;">
                    ‚ÑπÔ∏è "Learning Mode" active: Topic is locked. Task dictates the Persona.
                </div>
            </div>
        </div>
        <div class="grid-container">
            <div>
                <label>Context</label>
                <input type="text" id="contextInput" list="context-history" placeholder="Ex: React, Finance...">
                <datalist id="context-history"></datalist>
            </div>
            <div>
                <label>Specific Topic</label>
                <input type="text" id="topicInput" list="topic-history" placeholder="Ex: Hooks, ROI...">
                <datalist id="topic-history"></datalist>
            </div>

            <div><label>Mode (Persona)</label><select id="modeSelect"></select></div>
            <div><label>Format</label><select id="formatSelect"></select></div>
            
            <div><label id="taskLabel">Task Type</label><select id="taskSelect" onchange="syncModeWithTask()"></select></div>
            
            <div><label>Voice/Tone</label><select id="voiceSelect"></select></div>
            <div><label>Length</label><select id="lengthSelect"></select></div>
            <div><label>Depth Level</label><select id="levelSelect"></select></div>
        </div>

        <div class="btn-group">
            <button id="btn-generate" onclick="generatePrompt()">‚ö° Generate Prompt</button>
            <button id="btn-paste" onclick="handlePasteResponse()">üìã Paste Response & Hide</button>
        </div>

        <div id="prompt-output"></div>
    </div>

    <div id="search-container">
        <input type="text" id="searchBar" placeholder="üîç Search saved prompts..." onkeyup="filterResults()">
    </div>

    <div id="results-container"></div>

<script>

/* 1. CONFIG DATA */
const COMMON_DATA = {
   MODES: [
        { id: 'tech', label: '‚öôÔ∏è TECHNICAL', role: 'Act as a Senior Engineer.', style: 'Cyberpunk/Terminal style.', goal: 'Technical accuracy and implementation detail.' },
        { id: 'art', label: 'üé® ART', role: 'Act as a Creative Director.', style: 'Minimalist Gallery / Editorial style.', goal: 'Aesthetic refinement and originality.' },
        { id: 'school', label: 'üìö SCHOOL', role: 'Act as a Professor.', style: 'Clean Textbook / Academic style.', goal: 'Structured education and conceptual clarity.' },
        { id: 'story', label: 'üìñ STORYTELLING', role: 'Act as a Master Novelist.', style: 'Cinematic, immersive narrative tone.', goal: 'Engaging storytelling and world-building.' },
        { id: 'marketing', label: 'üì£ MARKETING', role: 'Act as a Senior Copywriter.', style: 'Persuasive, high-conversion writing.', goal: 'Brand voice alignment & audience engagement.' },
        { id: 'business', label: 'üíº BUSINESS', role: 'Act as a Strategy Consultant.', style: 'Executive brief style.', goal: 'Clarity, precision, and actionable insights.' },
        { id: 'research', label: 'üî¨ RESEARCH', role: 'Act as a Research Scientist.', style: 'Peer-reviewed academic tone.', goal: 'Evidence-based rigor with citations when relevant.' },
        { id: 'casual', label: 'üòä CASUAL', role: 'Act as a friendly assistant.', style: 'Conversational, natural tone.', goal: 'Clarity, simplicity, and a human-sounding delivery.' },
        { id: 'ai', label: 'ü§ñ ARTIFICIAL INTELLIGENCE', role: 'Act as an AI Research Scientist.', style: 'Futuristic, code-infused style.', goal: 'Innovative AI solutions and ethical considerations.' },
        { id: 'math', label: 'üßÆ MATHEMATICS', role: 'Act as a Mathematician.', style: 'Formal proofs and equations style.', goal: 'Logical precision and theoretical depth.' },
        { id: 'physics', label: '‚öõÔ∏è PHYSICS', role: 'Act as a Theoretical Physicist.', style: 'Quantum/Einstein-inspired style.', goal: 'Fundamental laws and conceptual breakthroughs.' },
        { id: 'biology', label: 'üß¨ BIOLOGY', role: 'Act as a Biologist.', style: 'Scientific observation and diagrams style.', goal: 'Life processes and evolutionary insights.' },
        { id: 'chemistry', label: 'üß™ CHEMISTRY', role: 'Act as a Chemist.', style: 'Molecular and reaction-focused style.', goal: 'Synthesis, reactions, and material properties.' },
        { id: 'medicine', label: 'ü©∫ MEDICINE', role: 'Act as a Medical Doctor.', style: 'Clinical case study style.', goal: 'Diagnosis, treatment, and patient care.' },
        { id: 'data', label: 'üìä DATA SCIENCE', role: 'Act as a Data Scientist.', style: 'Statistical charts and insights style.', goal: 'Data-driven decisions and predictive modeling.' },
        { id: 'programming', label: 'üíª PROGRAMMING', role: 'Act as a Senior Software Developer.', style: 'Clean code and debugging style.', goal: 'Efficient algorithms and robust implementation.' },
        { id: 'design', label: '‚úèÔ∏è DESIGN', role: 'Act as a UX/UI Designer.', style: 'Visual mood boards and prototypes style.', goal: 'User-centered aesthetics and functionality.' },
        { id: 'music', label: 'üéµ MUSIC', role: 'Act as a Composer/Music Producer.', style: 'Symphonic or electronic score style.', goal: 'Harmonic innovation and emotional resonance.' },
        { id: 'literature', label: 'üìú LITERATURE', role: 'Act as a Literary Critic.', style: 'Prose analysis and quotes style.', goal: 'Deep textual interpretation and thematic exploration.' },
        { id: 'philosophy', label: 'ü§î PHILOSOPHY', role: 'Act as a Philosopher.', style: 'Socratic dialogue style.', goal: 'Ethical reasoning and existential inquiry.' },
        { id: 'history', label: 'üèõÔ∏è HISTORY', role: 'Act as a Historian.', style: 'Chronological narrative with sources style.', goal: 'Contextual understanding and lessons from the past.' },
        { id: 'psychology', label: 'üß† PSYCHOLOGY', role: 'Act as a Clinical Psychologist.', style: 'Therapeutic case study style.', goal: 'Mental health insights and behavioral analysis.' },
        { id: 'economics', label: 'üíπ ECONOMICS', role: 'Act as an Economist.', style: 'Graphs and policy analysis style.', goal: 'Market dynamics and resource allocation.' },
        { id: 'law', label: '‚öñÔ∏è LAW', role: 'Act as a Legal Expert.', style: 'Case law and statutes style.', goal: 'Legal reasoning and justice principles.' },
        { id: 'architecture', label: 'üèóÔ∏è ARCHITECTURE', role: 'Act as an Architect.', style: 'Blueprint and spatial design style.', goal: 'Functional beauty and sustainable structures.' },
        { id: 'film', label: 'üé¨ FILM', role: 'Act as a Film Director.', style: 'Script and storyboard style.', goal: 'Visual storytelling and cinematic impact.' },
        { id: 'photography', label: 'üì∏ PHOTOGRAPHY', role: 'Act as a Professional Photographer.', style: 'Composition and lighting style.', goal: 'Capturing moments with artistic vision.' },
        { id: 'painting', label: 'üñåÔ∏è PAINTING', role: 'Act as a Painter/Artist.', style: 'Brushstroke and palette style.', goal: 'Expressive color and form exploration.' },
        { id: 'dance', label: 'üíÉ DANCE', role: 'Act as a Choreographer.', style: 'Movement sequence style.', goal: 'Bodily expression and rhythmic innovation.' },
        { id: 'theater', label: 'üé≠ THEATER', role: 'Act as a Theater Director.', style: 'Stage directions and drama style.', goal: 'Live performance and emotional depth.' },
        { id: 'linguistics', label: 'üó£Ô∏è LINGUISTICS', role: 'Act as a Linguist.', style: 'Phonetic and syntactic analysis style.', goal: 'Language structure and communication.' },
        { id: 'sociology', label: 'üë• SOCIOLOGY', role: 'Act as a Sociologist.', style: 'Social patterns and surveys style.', goal: 'Society dynamics and cultural norms.' },
        { id: 'anthropology', label: 'üåç ANTHROPOLOGY', role: 'Act as an Anthropologist.', style: 'Ethnographic fieldwork style.', goal: 'Human cultures and evolution.' },
        { id: 'political', label: 'üó≥Ô∏è POLITICAL SCIENCE', role: 'Act as a Political Analyst.', style: 'Policy debate style.', goal: 'Governance, power, and international relations.' },
        { id: 'environmental', label: 'üåø ENVIRONMENTAL SCIENCE', role: 'Act as an Ecologist.', style: 'Ecosystem and sustainability style.', goal: 'Environmental protection and climate solutions.' },
        { id: 'astronomy', label: 'üî≠ ASTRONOMY', role: 'Act as an Astronomer.', style: 'Cosmic observation style.', goal: 'Universe exploration and celestial phenomena.' },
        { id: 'geology', label: 'ü™® GEOLOGY', role: 'Act as a Geologist.', style: 'Rock formations and maps style.', goal: 'Earth processes and resources.' },
        { id: 'finance', label: 'üí∞ FINANCE', role: 'Act as a Financial Analyst.', style: 'Balance sheets and forecasts style.', goal: 'Investment strategies and risk management.' },
        { id: 'entrepreneur', label: 'üöÄ ENTREPRENEURSHIP', role: 'Act as a Startup Founder.', style: 'Pitch deck and growth style.', goal: 'Innovation and business scaling.' },
        { id: 'hr', label: 'üë• HUMAN RESOURCES', role: 'Act as a HR Manager.', style: 'Talent development style.', goal: 'Team building and organizational culture.' },
        { id: 'education', label: 'üéì EDUCATION', role: 'Act as an Educational Designer.', style: 'Curriculum and pedagogy style.', goal: 'Learning outcomes and student engagement.' },
        { id: 'journalism', label: 'üì∞ JOURNALISM', role: 'Act as a Investigative Journalist.', style: 'News article style.', goal: 'Fact-based reporting and public awareness.' },
        { id: 'cooking', label: 'üë®‚Äçüç≥ CULINARY ARTS', role: 'Act as a Chef.', style: 'Recipe and plating style.', goal: 'Flavor innovation and gastronomic experience.' },
        { id: 'sports', label: '‚öΩ SPORTS', role: 'Act as a Sports Coach.', style: 'Training plan style.', goal: 'Performance optimization and strategy.' },
        { id: 'gaming', label: 'üéÆ GAME DESIGN', role: 'Act as a Game Designer.', style: 'Mechanics and narrative style.', goal: 'Immersive gameplay and player engagement.' },
        { id: 'fashion', label: 'üëó FASHION', role: 'Act as a Fashion Designer.', style: 'Trend and silhouette style.', goal: 'Style innovation and wearable art.' },
        { id: 'psychotherapy', label: 'üõãÔ∏è PSYCHOTHERAPY', role: 'Act as a Therapist.', style: 'Empathetic session style.', goal: 'Emotional healing and personal growth.' },
        { id: 'ethics', label: '‚öñÔ∏è ETHICS', role: 'Act as an Ethicist.', style: 'Moral dilemma analysis style.', goal: 'Ethical frameworks and decision-making.' },
        { id: 'robotics', label: 'ü¶æ ROBOTICS', role: 'Act as a Robotics Engineer.', style: 'Mechanical and AI integration style.', goal: 'Autonomous systems and practical applications.' },
        { id: 'poetry', label: 'üñãÔ∏è POETRY', role: 'Act as a Poet.', style: 'Verse and metaphor style.', goal: 'Lyrical expression and emotional depth.' },
        { id: 'africanart', label: 'ü™ò AFRICAN ART', role: 'Act as an African Tribal Artist.', style: 'Rhythmic patterns and ancestral symbolism style.', goal: 'Cultural heritage and communal storytelling.' },
        { id: 'japanesephilosophy', label: 'üà∂ JAPANESE PHILOSOPHY', role: 'Act as a Zen Master.', style: 'Wabi-sabi and minimalist koan style.', goal: 'Inner peace and impermanence contemplation.' },
        { id: 'latinliterature', label: 'üìñ LATIN AMERICAN LITERATURE', role: 'Act as a Magical Realist Writer.', style: 'Surreal blend of reality and fantasy style.', goal: 'Social commentary through mythical narratives.' },
        { id: 'indianmusic', label: 'ü™ï INDIAN MUSIC', role: 'Act as a Raga Composer.', style: 'Improvisational melodic raga style.', goal: 'Spiritual elevation and emotional raga expression.' },
        { id: 'chinesecalligraphy', label: 'üñåÔ∏è CHINESE CALLIGRAPHY', role: 'Act as a Calligrapher.', style: 'Brush strokes with qi energy style.', goal: 'Harmony of form and spirit in writing.' },
        { id: 'mexicandance', label: 'üíÉ MEXICAN DANCE', role: 'Act as a Folklorico Choreographer.', style: 'Vibrant regional folk dance style.', goal: 'Cultural identity and historical celebration.' },
        { id: 'arabicpoetry', label: 'üïå ARABIC POETRY', role: 'Act as a Sufi Poet.', style: 'Mystical qasida and ghazal style.', goal: 'Divine love and spiritual ecstasy.' },
        { id: 'australianaboriginalart', label: 'üåè AUSTRALIAN ABORIGINAL ART', role: 'Act as a Dreamtime Artist.', style: 'Dot painting and symbolic storytelling style.', goal: 'Connection to land and ancestral dreams.' },
        { id: 'russianliterature', label: '‚ùÑÔ∏è RUSSIAN LITERATURE', role: 'Act as a Dostoevskian Novelist.', style: 'Psychological depth and existential drama style.', goal: 'Human soul exploration and moral dilemmas.' },
        { id: 'koreanfilm', label: 'üé• KOREAN FILM', role: 'Act as a New Wave Director.', style: 'Thrilling social critique cinema style.', goal: 'Genre-bending and cultural reflection.' },
        { id: 'nigerianstorytelling', label: 'ü¶Ö NIGERIAN STORYTELLING', role: 'Act as an Oral Historian.', style: 'Griot tradition with proverbs style.', goal: 'Community wisdom and historical preservation.' },
        { id: 'frenchphilosophy', label: 'üá´üá∑ FRENCH PHILOSOPHY', role: 'Act as an Existentialist Thinker.', style: 'Absurdity and freedom discourse style.', goal: 'Authentic existence and rebellion against absurdity.' },
        { id: 'brazilianmusic', label: 'ü•Å BRAZILIAN MUSIC', role: 'Act as a Samba Composer.', style: 'Rhythmic carnival beat style.', goal: 'Joyful expression and cultural fusion.' },
        { id: 'indigenousanthropology', label: 'üåø INDIGENOUS ANTHROPOLOGY', role: 'Act as a Native Knowledge Keeper.', style: 'Oral tradition and ecological wisdom style.', goal: 'Sustainable living and cultural continuity.' },
        { id: 'spanishflamenco', label: 'ü™ï SPANISH FLAMENCO', role: 'Act as a Flamenco Artist.', style: 'Passionate duende performance style.', goal: 'Emotional catharsis and gypsy heritage.' },
        { id: 'canadianliterature', label: 'üçÅ CANADIAN LITERATURE', role: 'Act as a Multicultural Novelist.', style: 'Identity and landscape narrative style.', goal: 'Diverse voices and national mosaic.' },
        { id: 'egyptianhistory', label: 'üóø EGYPTIAN HISTORY', role: 'Act as a Pharaoh Chronicler.', style: 'Hieroglyphic epic recounting style.', goal: 'Ancient mysteries and Nile civilization.' },
        { id: 'vietnamesetheater', label: 'üé≠ VIETNAMESE THEATER', role: 'Act as a Water Puppet Director.', style: 'Aquatic folklore performance style.', goal: 'Rural life and mythical tales.' },
        { id: 'irishfolkmusic', label: 'üçÄ IRISH FOLK MUSIC', role: 'Act as a Celtic Bard.', style: 'Ballad and jig instrumental style.', goal: 'Heritage preservation and lively sessions.' },
        { id: 'peruvianarchaeology', label: 'üèîÔ∏è PERUVIAN ARCHAEOLOGY', role: 'Act as an Inca Explorer.', style: 'Andean artifact analysis style.', goal: 'Lost empires and cultural decoding.' },
        { id: 'turkishpoetry', label: 'üïå TURKISH POETRY', role: 'Act as an Ottoman Divan Poet.', style: 'Gazelle and mystical verse style.', goal: 'Love, wine, and divine inspiration.' },
        { id: 'mexicanmuralism', label: 'üñºÔ∏è MEXICAN MURALISM', role: 'Act as a Revolutionary Muralist.', style: 'Large-scale social realism style.', goal: 'Political activism and public art.' },
        { id: 'japaneseteaceremony', label: 'üçµ JAPANESE TEA CEREMONY', role: 'Act as a Chado Master.', style: 'Zen ritual and harmony style.', goal: 'Mindfulness and aesthetic simplicity.' },
        { id: 'africanrhythms', label: 'ü•Å AFRICAN RHYTHMS', role: 'Act as a Djembe Drummer.', style: 'Polyrhythmic tribal beat style.', goal: 'Community bonding and spiritual trance.' },
        { id: 'indianphilosophy', label: 'üïâÔ∏è INDIAN PHILOSOPHY', role: 'Act as a Vedantic Sage.', style: 'Upanishadic dialogue style.', goal: 'Self-realization and cosmic unity.' },
        { id: 'chileanpoetry', label: 'üåÑ CHILEAN POETRY', role: 'Act as a Nerudian Poet.', style: 'Sensual ode and epic verse style.', goal: 'Love, nature, and political passion.' },
        { id: 'mongolianthroatsinging', label: 'üèûÔ∏è MONGOLIAN THROAT SINGING', role: 'Act as a Khoomei Singer.', style: 'Harmonic overtone vocal style.', goal: 'Nature imitation and shamanic connection.' },
        { id: 'greekmythology', label: 'üèõÔ∏è GREEK MYTHOLOGY', role: 'Act as a Mythic Bard.', style: 'Epic Homeric recitation style.', goal: 'Heroic tales and moral lessons.' },
        { id: 'maoriart', label: 'üåø MAORI ART', role: 'Act as a Ta Moko Tattoo Artist.', style: 'Spiral and genealogical pattern style.', goal: 'Identity marking and cultural pride.' },
        { id: 'koreanpoetry', label: 'üñãÔ∏è KOREAN POETRY', role: 'Act as a Sijo Poet.', style: 'Three-line philosophical verse style.', goal: 'Nature reflection and human condition.' },
        { id: 'cubansalsa', label: 'üíÉ CUBAN SALSA', role: 'Act as a Salsa Choreographer.', style: 'Afro-Cuban rhythmic dance style.', goal: 'Joyful movement and social connection.' },
        { id: 'persianminiature', label: 'üñºÔ∏è PERSIAN MINIATURE', role: 'Act as a Miniaturist Painter.', style: 'Intricate illuminated manuscript style.', goal: 'Poetic scenes and royal chronicles.' },
        { id: 'scandinaviandesign', label: 'ü™ë SCANDINAVIAN DESIGN', role: 'Act as a Functionalist Designer.', style: 'Minimalist hygge aesthetic style.', goal: 'Simplicity, functionality, and coziness.' },
        { id: 'thaitheater', label: 'üé≠ THAI THEATER', role: 'Act as a Khon Performer.', style: 'Masked Ramayana epic style.', goal: 'Mythical storytelling and graceful movement.' },
        { id: 'jamaicanreggae', label: 'üé∏ JAMAICAN REGGAE', role: 'Act as a Reggae Musician.', style: 'Roots rhythm and social lyrics style.', goal: 'Protest music and Rastafarian spirituality.' },
        { id: 'aztecmythology', label: 'üóø AZTEC MYTHOLOGY', role: 'Act as a Nahua Storyteller.', style: 'Sacrificial cosmic narrative style.', goal: 'World creation and divine balance.' },
        { id: 'polynesiandance', label: 'üå∫ POLYNESIAN DANCE', role: 'Act as a Hula Choreographer.', style: 'Storytelling hip movement style.', goal: 'Cultural legends and ocean connection.' },
        { id: 'russianballet', label: 'ü©∞ RUSSIAN BALLET', role: 'Act as a Ballet Master.', style: 'Classical tutu and pointe style.', goal: 'Graceful expression and dramatic narrative.' },
        { id: 'chineseopera', label: 'üé≠ CHINESE OPERA', role: 'Act as a Peking Opera Performer.', style: 'Acrobatic facial makeup style.', goal: 'Historical drama and martial arts.' },
        { id: 'australiansurfing', label: 'üèÑ AUSTRALIAN SURFING', role: 'Act as a Surf Culture Expert.', style: 'Wave-riding lifestyle narrative style.', goal: 'Adventure and coastal harmony.' },
        { id: 'moroccanarchitecture', label: 'üïå MOROCCAN ARCHITECTURE', role: 'Act as a Riads Designer.', style: 'Intricate zellige tile style.', goal: 'Privacy, beauty, and Islamic geometry.' },
        { id: 'indonesianbatik', label: 'üñºÔ∏è INDONESIAN BATIK', role: 'Act as a Batik Artisan.', style: 'Wax-resist dyeing pattern style.', goal: 'Cultural symbols and textile art.' },
        { id: 'scottishfolklore', label: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø SCOTTISH FOLKLORE', role: 'Act as a Highland Storyteller.', style: 'Celtic myth and legend style.', goal: 'Supernatural beings and clan histories.' },
        { id: 'bolivianweaving', label: 'üß∂ BOLIVIAN WEAVING', role: 'Act as an Andean Weaver.', style: 'Colorful textile pattern style.', goal: 'Indigenous identity and craft tradition.' },
        { id: 'jewishphilosophy', label: '‚ú°Ô∏è JEWISH PHILOSOPHY', role: 'Act as a Kabbalist Scholar.', style: 'Mystical Torah interpretation style.', goal: 'Divine secrets and ethical living.' },
        { id: 'finnishsauna', label: 'üßñ FINNISH SAUNA', role: 'Act as a Sauna Ritual Master.', style: 'Steam and l√∂yly philosophical style.', goal: 'Purification and social equality.' },
        { id: 'haitianvoodoo', label: 'üïØÔ∏è HAITIAN VOODOO', role: 'Act as a Houngan Priest.', style: 'Ritual drumming and loa invocation style.', goal: 'Spiritual healing and ancestral connection.' },
        { id: 'italianopera', label: 'üéº ITALIAN OPERA', role: 'Act as a Bel Canto Composer.', style: 'Dramatic aria and recitative style.', goal: 'Emotional intensity and vocal virtuosity.' },
        { id: 'kenyanmasaiculture', label: 'ü¶Å KENYAN MASAI CULTURE', role: 'Act as a Warrior Elder.', style: 'Beadwork and oral history style.', goal: 'Nomadic traditions and lion hunting lore.' },
        { id: 'portuguesefado', label: 'üé∏ PORTUGUESE FADO', role: 'Act as a Fadista Singer.', style: 'Melancholic guitar lament style.', goal: 'Saudade emotion and seafaring nostalgia.' },
        { id: 'samiindigenous', label: '‚ùÑÔ∏è SAMI INDIGENOUS', role: 'Act as a Joik Chanter.', style: 'Vocal yoik improvisation style.', goal: 'Nature spirits and reindeer herding life.' },
        { id: 'armenianfolkdance', label: 'üíÉ ARMENIAN FOLK DANCE', role: 'Act as a Kochari Choreographer.', style: 'Circle dance rhythm style.', goal: 'Community unity and historical resilience.' },
        { id: 'mongolianhorse', label: 'üèá MONGOLIAN HORSE CULTURE', role: 'Act as a Steppe Nomad.', style: 'Epic yurt narrative style.', goal: 'Conquest legends and equestrian mastery.' },
        { id: 'cambodianapsara', label: 'üï∫ CAMBODIAN APSARA', role: 'Act as an Apsara Dancer.', style: 'Graceful hand gesture style.', goal: 'Khmer mythology and temple carvings.' },
        { id: 'algerianrai', label: 'üé§ ALGERIAN RAI', role: 'Act as a Rai Musician.', style: 'Rebellious love song style.', goal: 'Social taboo breaking and emotional release.' },
        { id: 'inuitthroatsinging', label: '‚ùÑÔ∏è INUIT THROAT SINGING', role: 'Act as a Katajjaq Performer.', style: 'Vocal game imitation style.', goal: 'Arctic survival and playful competition.' },
        { id: 'colombiancumbia', label: 'ü•Å COLOMBIAN CUMBIA', role: 'Act as a Cumbia Rhythm Master.', style: 'African-indigenous fusion dance style.', goal: 'Festive celebration and cultural mixing.' },
        { id: 'tibetanbuddhism', label: 'üïâÔ∏è TIBETAN BUDDHISM', role: 'Act as a Lama Teacher.', style: 'Mandala and mantra meditation style.', goal: 'Enlightenment path and compassion cultivation.' },
        { id: 'fijianmeke', label: 'üå∫ FIJIAN MEKE', role: 'Act as a Meke Performer.', style: 'War dance and legend chant style.', goal: 'Tribal history and Pacific island spirit.' },
        { id: 'lebanesedabke', label: 'üíÉ LEBANESE DABKE', role: 'Act as a Dabke Leader.', style: 'Line dance stomp rhythm style.', goal: 'Wedding joy and national pride.' },
        { id: 'malaysiansilat', label: 'ü•ã MALAYSIAN SILAT', role: 'Act as a Silat Guru.', style: 'Martial arts flow style.', goal: 'Self-defense and spiritual discipline.' },
        { id: 'ethiopianjazz', label: 'üé∑ ETHIOPIAN JAZZ', role: 'Act as an Ethio-Jazz Improviser.', style: 'Pentatonic scale fusion style.', goal: 'Cultural revival and rhythmic innovation.' },
        { id: 'balinese gamelan', label: 'üîî BALINESE GAMELAN', role: 'Act as a Gamelan Conductor.', style: 'Metallophone ensemble style.', goal: 'Ceremonial harmony and island rituals.' },
        { id: 'nativeamericanflute', label: 'ü™∂ NATIVE AMERICAN FLUTE', role: 'Act as a Flute Maker.', style: 'Melodic wind instrument style.', goal: 'Healing sounds and tribal legends.' },
        { id: 'uzbekminiaturism', label: 'üñºÔ∏è UZBEK MINIATURISM', role: 'Act as a Silk Road Painter.', style: 'Persian-influenced detail style.', goal: 'Epic tales and ornamental beauty.' },
        { id: 'romani gypsy music', label: 'üéª ROMANI GYPSY MUSIC', role: 'Act as a Violin Virtuoso.', style: 'Passionate nomadic melody style.', goal: 'Wanderlust expression and emotional fire.' },
        { id: 'srilankanmask', label: 'üé≠ SRI LANKAN MASK DRAMA', role: 'Act as a Kolam Performer.', style: 'Carved mask satire style.', goal: 'Social commentary and exorcism rituals.' },
        { id: 'ghanaiankente', label: 'üßµ GHANAIAN KENTE', role: 'Act as a Kente Weaver.', style: 'Woven strip pattern style.', goal: 'Royal symbolism and Akan proverbs.' },
        { id: 'icelandicsaga', label: '‚ùÑÔ∏è ICELANDIC SAGA', role: 'Act as a Viking Skald.', style: 'Epic prose-poetry style.', goal: 'Heroic deeds and settlement history.' },
        { id: 'burmesemarionette', label: 'üßµ BURMESE MARIONETTE', role: 'Act as a Yokthei Pwe Puppeteer.', style: 'String puppet theater style.', goal: 'Buddhist tales and skillful manipulation.' },
        { id: 'saudiarabianpoetry', label: 'üïå SAUDI ARABIAN POETRY', role: 'Act as a Bedouin Poet.', style: 'Desert qasida ode style.', goal: 'Tribal honor and nomadic life.' },
        { id: 'hawaiianhula', label: 'üå∫ HAWAIIAN HULA', role: 'Act as a Hula Kumu.', style: 'Hand gesture storytelling style.', goal: 'Polynesian history and aloha spirit.' },
        { id: 'zuluwarriordance', label: 'üõ°Ô∏è ZULU WARRIOR DANCE', role: 'Act as an Indlamu Dancer.', style: 'High-kick battle rhythm style.', goal: 'Tribal strength and ceremonial power.' },
        { id: 'nepalesemandala', label: 'üïâÔ∏è NEPALESE MANDALA', role: 'Act as a Thangka Painter.', style: 'Sacred geometric art style.', goal: 'Buddhist meditation and deity visualization.' },
        { id: 'albanianfolklore', label: 'ü¶Ö ALBANIAN FOLKLORE', role: 'Act as a Rhapsode Singer.', style: 'Epic lahuta ballad style.', goal: 'National heroes and mountain traditions.' },
        { id: 'filipinotinikling', label: 'üíÉ FILIPINO TINIKLING', role: 'Act as a Bamboo Dance Choreographer.', style: 'Bamboo pole rhythm style.', goal: 'Agility and colonial resistance.' },
        { id: 'kazakhdombra', label: 'ü™ï KAZAKH DOMBRA', role: 'Act as a Dombra Player.', style: 'Steppe string melody style.', goal: 'Nomadic epics and horse culture.' },
        { id: 'yemeniarchitecture', label: 'üè∞ YEMENI ARCHITECTURE', role: 'Act as a Mudbrick Builder.', style: 'Tower house qasr style.', goal: 'Defensive living and adobe artistry.' },
        { id: 'maasaimara', label: 'ü¶Å MAASAI MARA', role: 'Act as a Maasai Moran.', style: 'Beaded jewelry narrative style.', goal: 'Wildlife guardianship and rite of passage.' },
        { id: 'tahitianori', label: 'üå∫ TAHITIAN ORI', role: 'Act as an Ori Dancer.', style: 'Hip-shaking tamure style.', goal: 'Fertility celebration and island legends.' },
        { id: 'belarusianstrawart', label: 'üåæ BELARUSIAN STRAW ART', role: 'Act as a Solomopletenie Artisan.', style: 'Woven straw sculpture style.', goal: 'Folk magic and harvest symbols.' },
        { id: 'congolesesoukous', label: 'üé∏ CONGOLESE SOUKOUS', role: 'Act as a Soukous Guitarist.', style: 'Lingala rumba dance style.', goal: 'African groove and urban energy.' },
        { id: 'lithuanianfolksong', label: 'üé∂ LITHUANIAN FOLK SONG', role: 'Act as a Sutartines Singer.', style: 'Polyphonic canon harmony style.', goal: 'Baltic pagan roots and communal chant.' },
        { id: 'ecuadorianpasillo', label: 'üé∏ ECUADORIAN PASILLO', role: 'Act as a Pasillo Composer.', style: 'Waltz-like melancholy tune style.', goal: 'Love lament and Andean emotion.' }
    ],
      FORMATS: [
        { id: 'html', label: 'üåê HTML APP', instruction: 'Return a single HTML5 file with inline CSS/JS. No external files. Use overflow-y:auto for scrolling.' },
        { id: 'text', label: 'üìÑ TEXT GUIDE', instruction: 'Return clean Markdown text with clear headings, lists and structure.' },
        { id: 'code', label: 'üíª CODE SNIPPET', instruction: 'Return raw code only with explanatory comments. No extra text.' },
        { id: 'essay', label: '‚úçÔ∏è ESSAY', instruction: 'Return a polished, formal essay with introduction, body and conclusion.' },
        { id: 'dialogue', label: 'üí¨ DIALOGUE', instruction: 'Return a scripted scene or conversation with character names and stage directions.' },
        { id: 'template', label: 'üìã TEMPLATE', instruction: 'Return a reusable structured template with clear placeholders for customization.' },
        { id: 'checklist', label: '‚úÖ CHECKLIST', instruction: 'Return a concise, actionable checklist or standard operating procedure.' },
        { id: 'renaissance', label: 'üñºÔ∏è RENAISSANCE', instruction: 'Respond in the style of Renaissance art: balanced composition, classical ideals, perspective, humanism and rich symbolism.' },
        { id: 'baroque', label: 'üé≠ BAROQUE', instruction: 'Respond with dramatic intensity, ornate detail, strong contrast, movement and emotional grandeur typical of Baroque art.' },
        { id: 'romanticism', label: 'üåô ROMANTICISM', instruction: 'Respond with emotional depth, exaltation of nature, individualism, sublime beauty and passionate expression.' },
        { id: 'impressionism', label: 'üå∏ IMPRESSIONISM', instruction: 'Respond with loose brushwork feel, emphasis on light/color, fleeting moments and everyday scenes.' },
        { id: 'expressionism', label: 'üò± EXPRESSIONISM', instruction: 'Respond with emotional distortion, bold colors, raw feeling and subjective inner experience.' },
        { id: 'cubism', label: 'üî≥ CUBISM', instruction: 'Respond fragmenting reality into geometric planes, multiple viewpoints and abstract reconfiguration.' },
        { id: 'surrealism', label: 'üï≥Ô∏è SURREALISM', instruction: 'Respond with dream-like scenes, unexpected juxtapositions, unconscious imagery and bizarre logic.' },
        { id: 'dadaism', label: 'üé≤ DADAISM', instruction: 'Respond with absurdity, irony, anti-art provocation, randomness and rejection of logic.' },
        { id: 'popart', label: 'üí• POP ART', instruction: 'Respond using bold colors, commercial imagery, irony, mass culture references and repetition.' },
        { id: 'minimalism', label: '‚¨ú MINIMALISM', instruction: 'Respond with extreme simplicity, clean lines, reduction to essentials and neutral tones.' },
        { id: 'abstractexp', label: 'üåÄ ABSTRACT EXPRESSIONISM', instruction: 'Respond with gestural spontaneity, large scale, emotional intensity and non-representational forms.' },
        { id: 'classicism', label: 'üèõÔ∏è CLASSICISM', instruction: 'Respond with harmony, clarity, restraint, proportion and inspiration from ancient Greece/Rome.' },
        { id: 'gothic', label: '‚õ™ GOTHIC', instruction: 'Respond with verticality, pointed arches, intricate detail, mysticism and spiritual aspiration.' },
        { id: 'realism', label: 'üëÅÔ∏è REALISM', instruction: 'Respond with objective depiction of everyday life, social truth and unidealized subjects.' },
        { id: 'symbolism', label: 'ü¶ã SYMBOLISM', instruction: 'Respond using metaphors, suggestion, mystery and evocation of ideas/feelings through symbols.' },
        { id: 'fauvism', label: 'üé® FAUVISM', instruction: 'Respond with wild bold colors, strong painterly qualities and emotional rather than realistic representation.' },
        { id: 'futurism', label: '‚ö° FUTURISM', instruction: 'Respond celebrating speed, technology, machinery, youth and violence with dynamic fragmentation.' },
        { id: 'constructivism', label: '‚öôÔ∏è CONSTRUCTIVISM', instruction: 'Respond with geometric abstraction, industrial materials and functional purpose serving society.' },
        { id: 'bauhaus', label: 'üè≠ BAUHAUS', instruction: 'Respond combining crafts and fine arts, functionality, clean modern design and "form follows function".' },
        { id: 'artdeco', label: 'üóº ART DECO', instruction: 'Respond with luxurious glamour, geometric patterns, bold colors and streamlined modern elegance.' },
        { id: 'postmodern', label: 'üÉè POSTMODERN', instruction: 'Respond with irony, pastiche, eclecticism, playful references and rejection of grand narratives.' },
        { id: 'conceptual', label: 'üí° CONCEPTUAL ART', instruction: 'Respond prioritizing idea over aesthetic, using text, documentation and minimal visual elements.' },
        { id: 'streetart', label: 'üé® STREET ART', instruction: 'Respond with urban energy, stencils, murals, social commentary and rebellious spirit.' },
        { id: 'cinematic', label: 'üé¨ CINEMATIC', instruction: 'Respond as a film sequence: describe shots, lighting, camera movement and dramatic pacing.' },
        { id: 'poetic', label: 'üñãÔ∏è POETIC', instruction: 'Respond in free verse or structured poetry form with rich imagery and rhythm.' },
        { id: 'operatic', label: 'üéº OPERATIC', instruction: 'Respond with grand emotional arias, dramatic recitatives and theatrical intensity.' },
        { id: 'jazz', label: 'üé∑ JAZZ', instruction: 'Respond with improvisation, syncopation, swing feel and spontaneous creative variation.' },
        { id: 'flamenco', label: 'üíÉ FLAMENCO', instruction: 'Respond with passionate duende, rhythmic footwork, intense emotion and raw vocal cries.' },
        { id: 'screenplay', label: 'üìΩÔ∏è SCREENPLAY', instruction: 'Return properly formatted screenplay pages (FADE IN, scene headings, action lines, dialogue).' },
        { id: 'storyboard', label: 'üìã STORYBOARD', instruction: 'Describe sequential panels with shot composition, camera angles and key dialogue.' },
        { id: 'manifesto', label: 'üì£ MANIFESTO', instruction: 'Return a bold, provocative artistic manifesto declaring principles and intentions.' },
        { id: 'sonnet', label: 'üìú SONNET', instruction: 'Return a 14-line sonnet (Shakespearean or Petrarchan) on the topic.' },
        { id: 'haiku', label: 'üå∏ HAIKU', instruction: 'Return traditional or modern haiku(s) capturing essence and seasonal reference.' },
        { id: 'react', label: '‚öõÔ∏è REACT COMPONENT', instruction: 'Return a complete, modern React functional component with hooks and inline styles if needed.' },
        { id: 'json', label: 'üóÇÔ∏è JSON OUTPUT', instruction: 'Return valid JSON only, structured for the requested data.' },
        { id: 'mermaid', label: 'üßú‚Äç‚ôÄÔ∏è MERMAID DIAGRAM', instruction: 'Return Mermaid.js syntax for flowchart, sequence, class or other diagram.' },
        { id: 'svg', label: 'üé≠ SVG GRAPHIC', instruction: 'Return standalone SVG code that visually represents the concept.' },
        { id: 'ascii', label: '‚å®Ô∏è ASCII ART', instruction: 'Return detailed ASCII art representing the subject.' },
        { id: 'letter', label: '‚úâÔ∏è LETTER', instruction: 'Return a formatted personal or formal letter with salutation and signature.' },
        { id: 'recipe', label: 'üç≥ RECIPE', instruction: 'Return a complete recipe with ingredients list and step-by-step instructions.' },
        { id: 'timeline', label: '‚è≥ TIMELINE', instruction: 'Return a chronological timeline of events with dates and descriptions.' },
        { id: 'mindmap', label: 'üó∫Ô∏è MIND MAP', instruction: 'Return a text-based hierarchical mind map structure with branches.' },
        { id: 'kabuki', label: 'üé≠ KABUKI THEATER', instruction: 'Respond with stylized gestures, dramatic makeup, and kabuki narrative flair from Japanese tradition.' },
        { id: 'bollywood', label: 'üé• BOLLYWOOD', instruction: 'Respond with song-and-dance sequences, melodramatic plots, and colorful Indian cinema style.' },
        { id: 'mariachi', label: 'üé∫ MARIACHI', instruction: 'Respond with vibrant trumpet fanfares, romantic serenades, and Mexican folk ensemble energy.' },
        { id: 'tango', label: 'üíÉ TANGO', instruction: 'Respond with passionate embraces, intricate footwork, and Argentine melancholic rhythm.' },
        { id: 'kathakali', label: 'üé≠ KATHAKALI', instruction: 'Respond with elaborate costumes, facial expressions, and mythological storytelling from Kerala, India.' },
        { id: 'sufiwhirling', label: 'üïäÔ∏è SUFI WHIRLING', instruction: 'Respond with spinning meditation, divine ecstasy, and Persian mystical poetry integration.' },
        { id: 'celticfolklore', label: 'üçÄ CELTIC FOLKLORE', instruction: 'Respond with fairy tales, druidic wisdom, and Irish-Scottish mythical creature narratives.' },
        { id: 'afrobeat', label: 'ü•Å AFROBEAT', instruction: 'Respond with polyrhythmic grooves, social commentary, and Nigerian highlife fusion.' },
        { id: 'ikebana', label: 'üå∏ IKEBANA', instruction: 'Respond with asymmetrical flower arrangements, zen minimalism, and Japanese harmony principles.' },
        { id: 'capoeira', label: 'ü•ã CAPOEIRA', instruction: 'Respond with acrobatic martial dance, ginga rhythm, and Brazilian slave resistance history.' },
        { id: 'origami', label: 'üïäÔ∏è ORIGAMI', instruction: 'Respond with paper folding instructions, symbolic forms, and Japanese precision artistry.' },
        { id: 'calypso', label: 'üèùÔ∏è CALYPSO', instruction: 'Respond with witty lyrics, steel pan melodies, and Trinidadian carnival satire.' },
        { id: 'bonsai', label: 'üå≥ BONSAI', instruction: 'Respond with miniature tree cultivation, patience philosophy, and Japanese aesthetic pruning.' },
        { id: 'didgeridoo', label: 'üé∫ DIDGERIDOO', instruction: 'Respond with circular breathing drones, Aboriginal dreamtime sounds, and Australian outback vibes.' },
        { id: 'batik', label: 'üñºÔ∏è BATIK', instruction: 'Respond with wax-resist dyeing patterns, Javanese motifs, and Indonesian textile narratives.' },
        { id: 'bharatanatyam', label: 'üíÉ BHARATANATYAM', instruction: 'Respond with expressive mudras, rhythmic footwork, and South Indian temple dance devotion.' },
        { id: 'taiko', label: 'ü•Å TAIKO', instruction: 'Respond with thunderous drumming ensembles, martial energy, and Japanese festival power.' },
        { id: 'qawwali', label: 'üïå QAWWALI', instruction: 'Respond with devotional Sufi singing, harmonium accompaniment, and Pakistani spiritual trance.' },
        { id: 'wayangkulit', label: 'üé≠ WAYANG KULIT', instruction: 'Respond with shadow puppet epics, gamelan orchestration, and Indonesian Ramayana adaptations.' },
        { id: 'gnawa', label: 'ü™ò GNAWA', instruction: 'Respond with healing trance music, krakebs clacking, and Moroccan spiritual possession rituals.' },
        { id: 'haka', label: 'üó£Ô∏è HAKA', instruction: 'Respond with war chants, stomping postures, and Maori challenge performances.' },
        { id: 'koto', label: 'ü™ï KOTO', instruction: 'Respond with zither string plucking, traditional scales, and Japanese court elegance.' },
        { id: 'sitar', label: 'ü™ï SITAR', instruction: 'Respond with raga improvisations, sympathetic strings, and North Indian classical depth.' },
        { id: 'ukiyo-e', label: 'üñºÔ∏è UKIYO-E', instruction: 'Respond with woodblock print scenes, floating world aesthetics, and Edo period vibrancy.' },
        { id: 'merengue', label: 'üíÉ MERENGUE', instruction: 'Respond with fast-paced accordion rhythms, hip-swaying, and Dominican party spirit.' },
        { id: 'shakuhachi', label: 'üéç SHAKUHACHI', instruction: 'Respond with bamboo flute meditations, honkyoku pieces, and Zen breathing techniques.' },
        { id: 'zajal', label: 'üó£Ô∏è ZAJAL', instruction: 'Respond with colloquial Arabic poetry duels, Levantine dialect, and improvisational wit.' },
        { id: 'morna', label: 'üé∏ MORNA', instruction: 'Respond with Cape Verdean blues, saudade melodies, and Ces√°ria √âvora-style longing.' },
        { id: 'pansori', label: 'üé§ PANSORI', instruction: 'Respond with epic vocal storytelling, drum accompaniment, and Korean han emotion.' },
        { id: 'rongo', label: 'üóø RONGO RONGO', instruction: 'Respond with mysterious glyph interpretations, Easter Island scripts, and Polynesian enigmas.' },
        { id: 'tarot', label: 'üÉè TAROT READING', instruction: 'Respond with card spread interpretations, symbolic archetypes, and intuitive guidance from global traditions.' },
        { id: 'yodel', label: 'üèîÔ∏è YODEL', instruction: 'Respond with Alpine echo calls, vocal leaps, and Swiss mountain herding songs.' },
        { id: 'huayno', label: 'ü•Å HUAYNO', instruction: 'Respond with Andean flute and harp rhythms, Quechua lyrics, and Peruvian highland dances.' },
        { id: 'klezmer', label: 'üéª KLEZMER', instruction: 'Respond with clarinet wails, joyful freylekhs, and Eastern European Jewish wedding music.' },
        { id: 'lavani', label: 'üíÉ LAVANI', instruction: 'Respond with seductive tamasha performances, Maharashtrian folk theater, and empowering female narratives.' },
        { id: 'samba', label: 'ü•Å SAMBA', instruction: 'Respond with carnival percussion parades, Afro-Brazilian roots, and Rio street energy.' },
        { id: 'noh', label: 'üé≠ NOH', instruction: 'Respond with masked slow-motion drama, yugen aesthetics, and Japanese medieval ghosts.' },
        { id: 'fado', label: 'üé∏ FADO', instruction: 'Respond with fateful Portuguese guitar laments, saudade soul, and Lisbon tavern intimacy.' },
        { id: 'joik', label: 'üé§ JOIK', instruction: 'Respond with Sami vocal evocations, nature personifications, and Lapland shamanic chants.' },
        { id: 'bhangra', label: 'ü•Å BHANGRA', instruction: 'Respond with Punjabi harvest beats, energetic dhol drumming, and celebratory dances.' },
        { id: 'odissi', label: 'üíÉ ODISSI', instruction: 'Respond with temple sculpture poses, lasya grace, and Odishan devotional expressions.' },
        { id: 'gagaku', label: 'üéº GAGAKU', instruction: 'Respond with ancient court orchestras, slow imperial elegance, and Japanese Shinto-Buddhist fusion.' },
        { id: 'rumba', label: 'ü•Å RUMBA', instruction: 'Respond with Afro-Cuban conga rhythms, call-and-response songs, and Havana street parties.' },
        { id: 'shamisen', label: 'ü™ï SHAMISEN', instruction: 'Respond with three-stringed lute plucks, geisha accompaniment, and Edo storytelling.' },
        { id: 'mariachiband', label: 'üé∫ MARIACHI BAND', instruction: 'Respond with vihuela strums, trumpet flourishes, and Mexican ranchera passion.' },
        { id: 'bulgarfolkdance', label: 'üíÉ BULGARIAN FOLK DANCE', instruction: 'Respond with asymmetric rhythms, pravo horo chains, and Balkan village festivities.' },
        { id: 'candombe', label: 'ü•Å CANDOMBRE', instruction: 'Respond with Uruguayan drum calls, Afro-descendant processions, and Montevideo carnival beats.' },
        { id: 'kora', label: 'ü™ï KORA', instruction: 'Respond with West African harp-lute melodies, griot histories, and Mandinka epics.' },
        { id: 'griot', label: 'üó£Ô∏è GRIOT', instruction: 'Respond with oral genealogy recitals, kora-backed praises, and Senegalese wisdom keeping.' },
        { id: 'kyogen', label: 'üé≠ KYOGEN', instruction: 'Respond with comic interlude farces, Noh companion humor, and Japanese satirical dialogues.' },
        { id: 'balletfolklorico', label: 'üíÉ BALLET FOLKLORICO', instruction: 'Respond with regional Mexican costumes, zapateado footwork, and cultural mosaic performances.' },
        { id: 'mbira', label: 'ü™ï MBIRA', instruction: 'Respond with Zimbabwean thumb piano tunes, Shona spirit possession, and ancestral communications.' },
        { id: 'cantejondo', label: 'üé§ CANTE JONDO', instruction: 'Respond with deep Andalusian flamenco song, gitano soul cries, and profound duende.' },
        { id: 'huasteco', label: 'üéª HUASTECO', instruction: 'Respond with Mexican son violin falsettos, jarana strums, and Veracruz huapango dances.' },
        { id: 'sephardic', label: 'üéº SEPHARDIC MUSIC', instruction: 'Respond with Ladino ballads, oud melodies, and Jewish-Spanish diaspora laments.' },
        { id: 'tuareg', label: 'üèúÔ∏è TUAREG MUSIC', instruction: 'Respond with Saharan electric guitar riffs, nomadic blues, and Tamasheq poetry.' },
        { id: 'bunraku', label: 'üßµ BUNRAKU', instruction: 'Respond with puppet theater narrations, shamisen music, and Osaka dramatic epics.' },
        { id: 'andeanflute', label: 'üéç ANDEAN FLUTE', instruction: 'Respond with quena and siku panpipes, highland melodies, and Incan wind spirits.' },
        { id: 'accordianpolka', label: 'üéπ ACCORDION POLKA', instruction: 'Respond with Czech-German oompah beats, lively hops, and beer hall merriment.' },
        { id: 'sardana', label: 'üíÉ SARDANA', instruction: 'Respond with Catalan circle dances, cobla wind ensembles, and national unity symbols.' },
        { id: 'balafon', label: 'ü™ò BALAFON', instruction: 'Respond with Malian xylophone cascades, griot accompaniments, and village ceremonies.' },
        { id: 'mari', label: 'ü™∂ MARI INDIGENOUS', role: 'Act as a Mari Shaman.', style: 'Finno-Ugric ritual chant style.', goal: 'Forest spirits and pagan harmony.' },
        { id: 'yorubaoriki', label: 'üó£Ô∏è YORUBA ORIKI', instruction: 'Respond with Nigerian praise poetry, rhythmic invocations, and lineage celebrations.' }
    ]
};

const VOCAB_TASKS = [
    { id: 'v_story', label: 'üìñ VOCAB: Creative Story', instruction: 'Write a short, engaging story incorporating the target vocabulary naturally.', linkedMode: 'story' },
    { id: 'v_quiz', label: '‚ùì VOCAB: Quiz Generator', instruction: 'Create a multiple-choice quiz (with answer key) testing the definition and usage of these words.', linkedMode: 'school' },
    { id: 'v_dialogue', label: 'üí¨ VOCAB: Roleplay Dialogue', instruction: 'Write a script for a realistic conversation between two people using these words.', linkedMode: 'casual' },
    { id: 'v_sentences', label: '‚úçÔ∏è VOCAB: Sentence Drill', instruction: 'Generate 3 distinct sentences (Context A, B, and C) for each target word.', linkedMode: 'school' },
    { id: 'v_explain', label: 'üß† VOCAB: Deep Explanation', instruction: 'Explain the etymology, nuance, and common collocations for each word.', linkedMode: 'research' },
    { id: 'v_idiom', label: 'üó£Ô∏è VOCAB: Idiom Integration', instruction: 'Create idioms or proverbs using the words, with explanations in multiple languages.', linkedMode: 'linguistics' },
    { id: 'v_poem', label: 'üñãÔ∏è VOCAB: Poetic Verse', instruction: 'Compose a poem incorporating the words, drawing from global poetic traditions like haiku or ghazal.', linkedMode: 'poetry' },
    { id: 'v_etymologytree', label: 'üå≥ VOCAB: Etymology Tree', instruction: 'Map the word origins across cultures, showing linguistic borrowings and evolutions.', linkedMode: 'history' },
    { id: 'v_multilingual', label: 'üåç VOCAB: Multilingual Translation', instruction: 'Provide translations and cultural nuances in 5 diverse languages for each word.', linkedMode: 'anthropology' },
    { id: 'v_songlyrics', label: 'üéµ VOCAB: Song Lyrics', instruction: 'Write lyrics for a song using the words, inspired by world music genres like reggae or fado.', linkedMode: 'music' },
    { id: 'v_flashcards', label: 'üÉè VOCAB: Flashcard Set', instruction: 'Design digital flashcards with images from global cultures representing the words.', linkedMode: 'education' },
    { id: 'v_culturalcontext', label: 'üåê VOCAB: Cultural Context', instruction: 'Explain how each word is used in different cultural rituals or festivals worldwide.', linkedMode: 'sociology' },
    { id: 'v_riddle', label: 'üß© VOCAB: Riddle Challenge', instruction: 'Create riddles using the words, drawing from African griot or Norse skald traditions.', linkedMode: 'philosophy' },
    { id: 'v_newsarticle', label: 'üì∞ VOCAB: News Article', instruction: 'Write a short news piece incorporating the words, in the style of international journalism.', linkedMode: 'journalism' },
    { id: 'v_recipe', label: 'üç≥ VOCAB: Culinary Usage', instruction: 'Incorporate words into a global fusion recipe description with cultural notes.', linkedMode: 'cooking' },
    { id: 'v_myth', label: 'üóø VOCAB: Mythical Tale', instruction: 'Weave words into a short myth inspired by Aztec, Greek, or Maori legends.', linkedMode: 'story' },
    { id: 'v_dance', label: 'üíÉ VOCAB: Dance Narrative', instruction: 'Describe a dance routine using the words, based on flamenco, bhangra, or hula.', linkedMode: 'dance' },
    { id: 'v_artdescription', label: 'üñºÔ∏è VOCAB: Art Description', instruction: 'Describe an imaginary artwork using the words, in styles like ukiyo-e or aboriginal dot painting.', linkedMode: 'art' },
    { id: 'v_proverb', label: 'üìú VOCAB: Proverb Creation', instruction: 'Invent proverbs with the words, blending African, Chinese, and Native American wisdom styles.', linkedMode: 'philosophy' },
    { id: 'v_haiku', label: 'üå∏ VOCAB: Haiku Series', instruction: 'Create a series of haiku incorporating the words, with seasonal kigo from various cultures.', linkedMode: 'poetry' },
    { id: 'v_dialoguemulti', label: 'üí¨ VOCAB: Multilingual Dialogue', instruction: 'Write a conversation mixing languages and cultures using the words.', linkedMode: 'linguistics' },
    { id: 'v_folktale', label: 'üìñ VOCAB: Folk Tale', instruction: 'Retell a folk tale from Grimm, Anansi, or Kojiki incorporating the vocabulary.', linkedMode: 'story' },
    { id: 'v_sonnetglobal', label: 'üìú VOCAB: Global Sonnet', instruction: 'Compose a sonnet blending Shakespearean form with Persian or Italian influences using the words.', linkedMode: 'literature' },
    { id: 'v_musicnotation', label: 'üéº VOCAB: Music Notation', instruction: 'Describe a melody using words, inspired by raga, gamelan, or Gregorian chant.', linkedMode: 'music' },
    { id: 'v_visualpoem', label: 'üñºÔ∏è VOCAB: Visual Poem', instruction: 'Create a concrete poem shaped by cultural symbols incorporating the words.', linkedMode: 'poetry' },
    { id: 'v_culturalquiz', label: '‚ùì VOCAB: Cultural Quiz', instruction: 'Design a quiz testing words in contexts from diverse global festivals.', linkedMode: 'education' },
    { id: 'v_idiomtranslation', label: 'üåê VOCAB: Idiom Translation', instruction: 'Translate idioms using the words into equivalent expressions from other cultures.', linkedMode: 'anthropology' },
    { id: 'v_storymulti', label: 'üìñ VOCAB: Multicultural Story', instruction: 'Write a story blending elements from Asian, African, and Latin American folklore with the words.', linkedMode: 'story' },
    { id: 'v_etymologymap', label: 'üó∫Ô∏è VOCAB: Etymology Map', instruction: 'Create a visual text map of word journeys across continents and languages.', linkedMode: 'history' },
    { id: 'v_songglobal', label: 'üéµ VOCAB: Global Song', instruction: 'Write lyrics for a fusion song mixing genres like k-pop, salsa, and bhangra using the words.', linkedMode: 'music' }
    ];

const SYSTEM_DATA = {
    TASK_TYPES: [
            { id: 'explain', label: 'üí° DEMYSTIFY', instruction: 'Take the specific topic and break it down from first principles. Reveal the underlying logic clearly, making the complex intuitive.' },
            { id: 'analysis', label: 'üîç DECONSTRUCT', instruction: 'Perform a deep-dive analysis. Identify root causes, systemic connections, variables, and potential edge cases within the context.' },
            { id: 'create', label: '‚ú® IDEATE & SYNTHESIZE', instruction: 'Generate novel, non-obvious content. Combine disparate concepts from the context to create something original and transformative.' },
            { id: 'teach', label: 'üìñ SCAFFOLDED MASTERY', instruction: 'Design a learning path. Introduce the concept, show a concrete example, explain the nuance, and provide a test/challenge for the user.' },
            { id: 'improve', label: '‚úçÔ∏è REFACTOR & ELEVATE', instruction: 'Critique the input. Optimize for clarity, efficiency, and impact. Explain specifically what was improved and why.' },
            { id: 'compare', label: '‚öñÔ∏è JUXTAPOSE & EVALUATE', instruction: 'Compare entities using rigorous criteria. Highlight trade-offs, synergies, and contextual suitability. Declare a winner based on the specific context.' },
            { id: 'build', label: 'üõ†Ô∏è ARCHITECT', instruction: 'Construct a complete artifact (plan, blueprint, codebase) from start to finish. Ensure all components logically fit together into a working whole.' },
            { id: 'brainstorm', label: 'üí≠ DIVERGE & EXPLORE', instruction: 'Generate a wide spectrum of ideas, possibilities, and creative directions without judgment or filtering. Push boundaries and explore the unconventional.' },
            { id: 'critique', label: 'üñãÔ∏è DISSECT & REFINE', instruction: 'Provide sharp, constructive criticism. Highlight strengths, expose weaknesses, and offer precise, actionable recommendations for improvement.' },
            { id: 'summarize', label: 'üìù DISTILL & CRYSTALLIZE', instruction: 'Condense complex or lengthy input into its purest essence. Retain all critical meaning while eliminating noise and redundancy.' },
            { id: 'debate', label: 'üó£Ô∏è DEBATE & COUNTERPOINT', instruction: 'Simulate a multi-sided debate, presenting nuanced arguments from diverse cultural perspectives.' },
            { id: 'design', label: 'üé® DESIGN & INNOVATE', instruction: 'Craft interdisciplinary designs blending global artistic currents and functional needs.' },
            { id: 'solve', label: 'üîë DIAGNOSE & RESOLVE', instruction: 'Identify the core problem, explore multiple solution paths, evaluate feasibility, and deliver the optimal, step-by-step resolution.' },
            { id: 'plan', label: 'üó∫Ô∏è STRATEGIZE & SEQUENCE', instruction: 'Create a detailed, phased plan with milestones, dependencies, resources, and risk mitigation. Ensure realistic and executable steps.' },
            { id: 'narrate', label: 'üìö IMMERSE & UNFOLD', instruction: 'Transform the topic into a compelling narrative. Use vivid storytelling, character, tension, and pacing to make ideas memorable and emotionally resonant.' },
            { id: 'translate', label: 'üåê TRANSLATE & ADAPT', instruction: 'Translate across languages while adapting cultural nuances and idiomatic expressions.' },
            { id: 'research', label: 'üî¨ INVESTIGATE & SYNTHESIZE', instruction: 'Gather, evaluate, and integrate the most relevant and credible information on the topic into a coherent, well-supported overview.' },
            { id: 'simulate', label: 'üß© MODEL & PLAY OUT', instruction: 'Construct and run a mental or explicit simulation of a process, scenario, or system. Reveal dynamics, outcomes, and emergent behavior.' },
            { id: 'evaluate', label: 'üìä EVALUATE & BENCHMARK', instruction: 'Assess using multicultural criteria, drawing from global standards and perspectives.' },
            { id: 'persuade', label: 'üóØÔ∏è ADVOCATE & SWAY', instruction: 'Craft a compelling, evidence-backed argument to convince the audience of a specific position. Use logic, emotion, and credibility strategically.' },
            { id: 'reflect', label: 'ü™û INTROSPECT & ILLUMINATE', instruction: 'Explore deeper implications, personal meaning, philosophical layers, or long-term consequences of the topic.' },
            { id: 'experiment', label: 'üß™ EXPERIMENT & ITERATE', instruction: 'Design cross-disciplinary experiments blending science, art, and cultural methods.' },
            { id: 'review', label: '‚≠ê REVIEW & CONTEXTUALIZE', instruction: 'Provide balanced reviews incorporating international viewpoints and artistic critiques.' },
            { id: 'forecast', label: 'üîÆ EXTRAPOLATE & PREDICT', instruction: 'Analyze current trends, drivers, and constraints to project plausible future scenarios. Provide probabilities and leading indicators.' },
            { id: 'roleplay', label: 'üé≠ EMBODY & ENACT', instruction: 'Assume a specific persona, historical figure, or expert role and respond fully in-character while staying true to their knowledge and perspective.' },
            { id: 'synthesize', label: 'üîó SYNTHESIZE & FUSE', instruction: 'Combine multiple sources or ideas into a coherent new understanding or framework.' },
            { id: 'visualize', label: 'üëÅÔ∏è RENDER & ILLUSTRATE', instruction: 'Translate abstract or complex ideas into clear visual metaphors, diagrams, or mental images that enhance understanding.' },
            { id: 'optimize', label: '‚ö° OPTIMIZE & REFINE', instruction: 'Improve efficiency drawing from global best practices across disciplines.' },
            { id: 'debug', label: 'üêû DEBUG & TROUBLESHOOT', instruction: 'Identify issues using multidisciplinary diagnostic approaches.' },
            { id: 'inspire', label: 'üåü INSPIRE & IGNITE', instruction: 'Draw from world myths, arts, and philosophies to motivate creatively.' },
            { id: 'fuse', label: 'üî• FUSE & HYBRIDIZE', instruction: 'Blend concepts from diverse cultures and disciplines into novel hybrids.' },
            { id: 'decolonize', label: '‚úä DECOLONIZE & REFRAME', instruction: 'Challenge Western-centric views, incorporating indigenous and global south perspectives.' },
            { id: 'ecodesign', label: 'üåø ECO-DESIGN & SUSTAIN', instruction: 'Create sustainable solutions inspired by biomimicry and traditional ecological knowledge.' },
            { id: 'mythweave', label: 'üßµ MYTHWEAVE & LEGENDIZE', instruction: 'Weave modern topics into ancient global mythological frameworks.' },
            { id: 'ritualize', label: 'üïØÔ∏è RITUALIZE & CEREMONIALIZE', instruction: 'Transform processes into ritualistic experiences drawing from world ceremonies.' },
            { id: 'polyrhythm', label: 'ü•Å POLYRHYTHM & LAYER', instruction: 'Layer multiple cultural rhythms and patterns into complex compositions.' },
            { id: 'transcend', label: 'üïäÔ∏è TRANSCEND & ELEVATE', instruction: 'Elevate ideas to spiritual or transcendental levels using global mystic traditions.' },
            { id: 'collaborate', label: 'üë• COLLABORATE & CO-CREATE', instruction: 'Simulate multicultural team input for co-created outcomes.' },
            { id: 'remix', label: 'üîÄ REMIX & REINTERPRET', instruction: 'Remix concepts across artistic currents and cultural boundaries.' },
            { id: 'harmonize', label: 'üéº HARMONIZE & UNIFY', instruction: 'Unify disparate elements into cohesive wholes inspired by world music harmonies.' }
        ],
       VOICES: [
    { id: 'neutral', label: '‚öñÔ∏è Objective / Analytical', instruction: 'Maintain a bias-free, factual, and observably detached tone.' },
    { id: 'friendly', label: 'üòä Warm / Collaborative', instruction: 'Use an inviting, encouraging, and psychologically safe tone.' },
    { id: 'authoritative', label: 'üéì Commanding / Expert', instruction: 'Use decisive, unwavering language. Project absolute confidence.' },
    { id: 'poetic', label: 'üñãÔ∏è Lyrical / Evocative', instruction: 'Use metaphor, rhythm, and sensory imagery to paint a picture with words.' },
    { id: 'concise', label: '‚úÇÔ∏è Minimalist / Direct', instruction: 'Maximize information density. Remove all fluff. Be surgical.' },
    { id: 'humorous', label: 'üòÇ Witty / Playful', instruction: 'Employ sharp wit, irony, and light-hearted humor while staying on-topic.' },
    { id: 'sarcastic', label: 'üòè Dry / Sardonic', instruction: 'Use subtle irony, understatement, and clever mockery without overt hostility.' },
    { id: 'enthusiastic', label: 'üî• Vibrant / Energetic', instruction: 'Convey genuine excitement and high energy through vivid language and exclamation.' },
    { id: 'empathetic', label: 'ü§ó Compassionate / Supportive', instruction: 'Show deep understanding of emotions. Validate feelings and offer gentle guidance.' },
    { id: 'dramatic', label: 'üé≠ Theatrical / Intense', instruction: 'Heighten stakes with powerful language, tension, and vivid dramatic flair.' },
    { id: 'mysterious', label: 'üïØÔ∏è Enigmatic / Suggestive', instruction: 'Hint rather than state directly. Build intrigue through implication and shadow.' },
    { id: 'formal', label: 'üé© Elegant / Professional', instruction: 'Employ polished, sophisticated language with impeccable structure and decorum.' },
    { id: 'casual', label: 'üòé Relaxed / Conversational', instruction: 'Use everyday speech, contractions, and a laid-back, approachable style.' },
    { id: 'inspirational', label: 'üåü Visionary / Uplifting', instruction: 'Ignite motivation and hope through powerful, aspirational, and empowering language.' },
    { id: 'cynical', label: 'üòí Skeptical / World-Weary', instruction: 'Express doubt and subtle disillusionment while remaining intellectually sharp.' },
    { id: 'narrative', label: 'üìñ Storytelling / Immersive', instruction: 'Speak as a masterful storyteller, weaving events into a compelling, flowing narrative.' },
    { id: 'philosophical', label: 'ü§î Contemplative / Profound', instruction: 'Explore deeper truths and existential questions with reflective, measured insight.' },
    { id: 'playful', label: 'üéà Whimsical / Teasing', instruction: 'Infuse fun wordplay, light teasing, and imaginative flair from global folk tales.' },
    { id: 'serious', label: 'üßê Grave / Earnest', instruction: 'Convey weighty matters with solemnity drawn from ancient wisdom traditions.' },
    { id: 'romantic', label: '‚ù§Ô∏è Tender / Passionate', instruction: 'Evoke intimacy and desire inspired by ghazals, sonnets, and boleros.' },
    { id: 'scientific', label: 'üî¨ Precise / Empirical', instruction: 'Use rigorous terminology, evidence-based claims, and clinical detachment.' },
    { id: 'journalistic', label: 'üì∞ Factual / Investigative', instruction: 'Report with who/what/when/where/why, blending global media styles.' },
    { id: 'childlike', label: 'üë∂ Innocent / Wonderous', instruction: 'Speak with curiosity and simplicity, like worldwide children\'s folklore.' },
    { id: 'epic', label: '‚öîÔ∏è Heroic / Legendary', instruction: 'Narrate grandly, echoing epics from Gilgamesh to Mahabharata.' },
    { id: 'minimalist', label: '‚¨ú Sparse / Essential', instruction: 'Use deliberate brevity, inspired by haiku and zen koans.' },
    { id: 'confident', label: 'üí™ Bold / Assured', instruction: 'Project certainty with warrior-like conviction from diverse cultures.' },
    { id: 'whisper', label: 'ü§´ Intimate / Secretive', instruction: 'Share confidences softly, like Sufi whispers or indigenous dream talks.' },
    { id: 'urgent', label: 'üö® Pressing / Immediate', instruction: 'Convey time-sensitive alarms, drawing from global crisis narratives.' },
    { id: 'nostalgic', label: 'üìª Wistful / Reminiscent', instruction: 'Evoke past memories through fado saudade or tango melancholy.' },
    { id: 'rebellious', label: '‚úä Defiant / Revolutionary', instruction: 'Challenge norms with punk energy mixed with global protest songs.' },
    { id: 'shamanic', label: 'üïØÔ∏è Mystic / Trance-like', instruction: 'Invoke spirits with rhythmic chants from Siberian to Amazonian traditions.' },
    { id: 'folksy', label: 'üçÄ Rustic / Down-to-Earth', instruction: 'Use homespun wisdom from Appalachian ballads or African proverbs.' },
    { id: 'operatic', label: 'üéº Grand / Emotional', instruction: 'Swell with arias of passion, blending Italian opera and Chinese jingju.' },
    { id: 'surreal', label: 'üï≥Ô∏è Dreamlike / Bizarre', instruction: 'Warp reality with Dali-esque twists and Latin magical realism.' },
    { id: 'ritualistic', label: 'üïäÔ∏è Ceremonial / Sacred', instruction: 'Perform with incantatory repetition from Voodoo to Shinto rites.' },
    { id: 'nomadic', label: 'üèúÔ∏è Wandering / Free-Spirited', instruction: 'Roam freely like Tuareg poetry or Gypsy flamenco tales.' },
    { id: 'imperial', label: 'üèØ Regal / Commanding', instruction: 'Decree with Ottoman grandeur or Incan authority.' },
    { id: 'ecstatic', label: 'üåà Joyful / Transcendent', instruction: 'Overflow with bhakti devotion or gospel exaltation.' },
    { id: 'melancholic', label: 'üåßÔ∏è Sorrowful / Reflective', instruction: 'Lament softly with Irish keening or Portuguese fado.' },
    { id: 'warrior', label: 'üõ°Ô∏è Fierce / Resilient', instruction: 'Charge with Maori haka power or Samurai bushido resolve.' },
    { id: 'visionary', label: 'üîÆ Prophetic / Futuristic', instruction: 'Foreshadow with oracle-like insight from Delphi to Mayan calendars.' },
    { id: 'harmonious', label: 'üéº Balanced / Unified', instruction: 'Blend voices like Balinese gamelan or Native American circle songs.' }
],
    LENGTH: [
    { id: 'one-liner', label: 'üí¨ 1 l√≠nea', instruction: 'Una sola frase contundente. M√°x. 20 palabras.' },
    { id: 'caption', label: 'üì∏ Caption', instruction: '1‚Äì2 frases. Ideal para t√≠tulos, captions o hooks breves.' },
    { id: 'instant', label: '‚ö° 15 seg', instruction: 'M√°x. 50 palabras. Sin contexto extra ni explicaciones.' },
    { id: 'tweet', label: 'üê¶ 30 seg', instruction: 'M√°x. 280 caracteres. Una sola idea. Impacto inmediato.' },
    { id: 'hook', label: 'üé£ Hook', instruction: 'Inicio poderoso. 1‚Äì3 frases dise√±adas para captar atenci√≥n inmediata.' },
    { id: 'flash', label: '‚ú® 1 min', instruction: '150‚Äì200 palabras. Lectura de 1 minuto, directa y clara.' },
    { id: 'quick', label: 'üìÑ 2 min', instruction: '300‚Äì400 palabras. Respuesta corta pero completa (2 min de lectura).' },
    { id: 'bite', label: 'üç™ 3 min', instruction: '500‚Äì600 palabras. Tama√±o ideal para un art√≠culo corto o bite-sized.' },
    { id: 'coffee', label: '‚òï 5 min', instruction: '800‚Äì1000 palabras. Lectura t√≠pica de pausa caf√© (est√°ndar blog).' },
    { id: 'focus', label: 'üß† 8 min', instruction: '1200‚Äì1600 palabras. Profundidad media con ejemplos y estructura.' },
    { id: 'deep', label: 'üîç 10 min', instruction: '1800‚Äì2200 palabras. Inmersi√≥n real de 10 minutos.' },
    { id: 'longread', label: 'üìú 15 min', instruction: '2500‚Äì3500 palabras. Lectura profunda y detallada.' },
    { id: 'essay', label: '‚úçÔ∏è 20 min', instruction: '4000‚Äì5000 palabras. Ensayo completo o gu√≠a exhaustiva.' },
    { id: 'feature', label: 'üì∞ 30 min', instruction: '6000‚Äì8000 palabras. Art√≠culo de fondo o reportaje largo.' },
    { id: 'chapter', label: 'üìñ 45+ min', instruction: '>10.000 palabras. Cap√≠tulo de libro o tratado extenso.' },
    { id: 'snippet', label: 'üß© Snippet', instruction: 'Fragmento breve y reutilizable que puede insertarse dentro de otro texto.' },
    { id: 'summary', label: 'üßæ Resumen', instruction: 'S√≠ntesis clara de los puntos clave. Longitud m√≠nima necesaria.' },
    { id: 'tldr', label: '‚ö° TL;DR', instruction: 'Resumen ultra corto de todo el contenido.' },
    { id: 'bullets', label: 'üîπ Vi√±etas', instruction: 'Respuesta en puntos claros y concisos. M√°x. una l√≠nea por vi√±eta.' },
    { id: 'outline', label: 'üóÇÔ∏è Esquema', instruction: 'Estructura jer√°rquica con secciones y subsecciones.' },
    { id: 'sections', label: 'üß© Secciones', instruction: 'Contenido dividido en secciones claras con t√≠tulos breves.' },
    { id: 'framework', label: 'üèóÔ∏è Framework', instruction: 'Estructura reutilizable con pasos o bloques conceptuales.' },
    { id: 'essential', label: '‚¨ú Lo esencial', instruction: 'Lo m√°s breve posible sin perder nada importante.' },
    { id: 'full', label: 'üß† Completo', instruction: 'Todo lo necesario, sin l√≠mite artificial de longitud.' }
],
    FADER_LEVELS: ["- Level 1: Surface.", "- Level 2: Context.", "- Level 3: Mechanics.", "- Level 4: Nuance.", "- Level 5: Mastery."],
    RESTRICTIONS: ["Strict format.", "No filler.", "Align tone.", "Integrate context.", "Complete output.", "Always respond in English even if the question is asked in another language."]
};

/* 2. GLOBAL STATE */
let lastGeneratedPrompt = ""; 
let currentData = SYSTEM_DATA; 
let nexusHistory = [];
const NEXUS_STORAGE_KEY = 'nexus_prompt_history';
const MDC_VOCAB_KEY = 'mdc_vocab_list';
const PREF_AUDIO_VOICE = 'nexus_audio_voice';
const PREF_AUDIO_SPEED = 'nexus_audio_speed';
let availableVoices = [];

// PILL STATE & WATCHER
let currentStatsContext = null;
let currentWordStats = { occurrences: "-", uniqueTotal: 0 };
let lastStorageString = "";

// VARS PARA LONG PRESS & SELECCI√ìN
let pressTimer;
let isLongPressHandled = false;
let pendingPhraseStartIdx = null; // Para el sistema de rango MDC

/* 3. INITIALIZATION */
document.addEventListener('DOMContentLoaded', () => {
    populateSelect('modeSelect', COMMON_DATA.MODES);
    populateSelect('formatSelect', COMMON_DATA.FORMATS);
    updateDynamicDropdowns();
    loadHistory('contextInput', 'context-history');
    loadHistory('topicInput', 'topic-history');
    loadNexusHistory();
    loadVocabFolders();
    startStorageWatcher(); 
    initMagicCircle(); 
    
    if(window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();
    }
});

/* === MAGIC CIRCLE LOGIC === */
function initMagicCircle() {
    const circle = document.getElementById('magic-circle');
    let lastTarget = null;

    circle.addEventListener('touchmove', (e) => {
        e.preventDefault(); 
        const touch = e.touches[0];
        circle.style.left = (touch.clientX - 25) + 'px';
        circle.style.top = (touch.clientY - 25) + 'px';

        circle.style.visibility = 'hidden'; 
        let elem = document.elementFromPoint(touch.clientX, touch.clientY);
        circle.style.visibility = 'visible';

        if (elem && elem.classList.contains('interactive-word')) {
            if (lastTarget !== elem) {
                lastTarget = elem;
                handleHoverStart(elem); 
            }
        } else {
            if (lastTarget) {
                handleHoverEnd(); 
                lastTarget = null;
            }
        }
    }, { passive: false });

    circle.addEventListener('touchend', () => {
        if(lastTarget) {
            handleHoverEnd();
            lastTarget = null;
        }
    });
}

/* === REAL-TIME SYNC ENGINE === */
function startStorageWatcher() {
    lastStorageString = localStorage.getItem(MDC_VOCAB_KEY) || "";
    setInterval(() => {
        const currentString = localStorage.getItem(MDC_VOCAB_KEY) || "";
        if (currentString !== lastStorageString) {
            lastStorageString = currentString;
            loadVocabFolders(); 
            refreshActiveView(); 
        }
    }, 500);
}

function refreshActiveView() {
    const activeContent = document.querySelector('.accordion-content.active .interactive-content');
    if (!activeContent) return;

    const rawData = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]');
    const savedWordsSet = new Set();
    const savedPhrases = [];

    const extract = (obj) => {
        const text = sanitizeText(obj.eng).toLowerCase();
        if(text.includes(" ")) savedPhrases.push(text);
        else savedWordsSet.add(text);
    };

    rawData.forEach(item => {
        if(item.isFolder && item.items) item.items.forEach(sub => extract(sub));
        else if(!item.isFolder && item.eng) extract(item);
    });

    const allWords = Array.from(activeContent.querySelectorAll('.interactive-word'));
    
    // Limpieza
    allWords.forEach(el => {
        if (!el.classList.contains('phrase-selecting')) {
            el.classList.remove('saved', 'phrase-saved');
        }
    });

    // 1. Highlight palabras simples
    allWords.forEach(el => {
        const clean = sanitizeText(el.innerText).toLowerCase();
        if (savedWordsSet.has(clean) && !el.classList.contains('phrase-selecting')) {
            el.classList.add('saved');
        }
    });

    // 2. Highlight Frases (MDC Logic - Yellow Highlighter)
    savedPhrases.sort((a, b) => b.length - a.length);
    const lineTextArr = allWords.map(el => sanitizeText(el.innerText).toLowerCase());

    savedPhrases.forEach(phrase => {
        const phraseArr = phrase.split(" ");
        for (let i = 0; i <= lineTextArr.length - phraseArr.length; i++) {
            let match = true;
            for (let j = 0; j < phraseArr.length; j++) {
                if (lineTextArr[i + j] !== phraseArr[j]) { match = false; break; }
            }
            if (match) {
                for (let k = 0; k < phraseArr.length; k++) {
                    const targetEl = allWords[i + k];
                    if (!targetEl.classList.contains('phrase-selecting')) {
                       // targetEl.classList.remove('saved'); 
                        targetEl.classList.add('phrase-saved'); // Yellow style
                    }
                }
            }
        }
    });

    currentStatsContext = activeContent;
    updateUnifiedPill(null);
}

/* === INTERACTION LOGIC (MDC COPY) === */
function startPress(el) {
    isLongPressHandled = false;
    pressTimer = setTimeout(() => {
        handleLongPress(el);
        isLongPressHandled = true;
    }, 500); 
}

function endPress(el, e) {
    clearTimeout(pressTimer);
    if(e.type === 'touchend' && isLongPressHandled) {
        e.preventDefault(); 
    }
}

// === HOVER LOGIC ===
let hoverTimerRef;

function handleHoverStart(el) {
    clearTimeout(hoverTimerRef);
    hoverTimerRef = setTimeout(() => {
        const rawText = el.innerText.replace(/[^a-zA-Z0-9]/g, "");
        translateWord(rawText);
    }, 500);
}

function handleHoverEnd() {
    clearTimeout(hoverTimerRef);
}

function handleShortClick(el) {
    if (isLongPressHandled) return; 
    
    // Si hay una selecci√≥n manual activa, limpiarla
    if (document.querySelector('.interactive-word.phrase-selecting')) {
        clearManualSelection();
        return;
    }
    
    saveWordToMDC(el.innerText, el); 
}

function handleLongPress(el) {
    if (navigator.vibrate) navigator.vibrate(50);
    const currentIdx = parseInt(el.dataset.idx);

    // === ZONA DE BORRADO DE FRASES AMARILLAS ===
    if (el.classList.contains('phrase-saved')) {
        const contentDiv = el.closest('.interactive-content');
        const allWords = Array.from(contentDiv.querySelectorAll('.interactive-word'));
        const textArr = allWords.map(w => sanitizeText(w.innerText).toLowerCase());

        const rawData = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]');
        let savedPhrases = [];
        
        const extractPhrases = (list) => {
            list.forEach(item => {
                if (item.isFolder) extractPhrases(item.items);
                else if (item.eng && item.eng.includes(" ")) savedPhrases.push(item.eng.toLowerCase());
            });
        };
        extractPhrases(rawData);
        savedPhrases.sort((a, b) => b.length - a.length);

        let phraseToDelete = null;

        for (let phrase of savedPhrases) {
            const phraseArr = phrase.split(" ");
            for (let i = 0; i <= textArr.length - phraseArr.length; i++) {
                let match = true;
                for (let j = 0; j < phraseArr.length; j++) {
                    if (textArr[i + j] !== phraseArr[j]) { match = false; break; }
                }

                if (match) {
                    if (currentIdx >= i && currentIdx < i + phraseArr.length) {
                        phraseToDelete = phrase;
                        break; 
                    }
                }
            }
            if (phraseToDelete) break;
        }

        // --- CAMBIO AQU√ç: BORRADO DIRECTO SIN CONFIRMACI√ìN ---
        if (phraseToDelete) {
             // Vibraci√≥n doble para confirmar tactilmente el borrado
             if (navigator.vibrate) navigator.vibrate([50, 100]); 
             
             deletePhraseFromDB(phraseToDelete);
             clearManualSelection();
             refreshActiveView();
        }
        
        return; 
    }
    // ========================================================

    // L√ìGICA DE SELECCI√ìN DE RANGO (MDC SYSTEM)
    if (pendingPhraseStartIdx === null) {
        clearManualSelection();
        el.classList.add('phrase-selecting');
        el.dataset.userSelected = "true";
        pendingPhraseStartIdx = currentIdx;
    } else {
        const contentDiv = el.closest('.interactive-content');
        const start = Math.min(pendingPhraseStartIdx, currentIdx);
        const end = Math.max(pendingPhraseStartIdx, currentIdx);
        
        if (end - start > 12) {
             if (navigator.vibrate) navigator.vibrate([50, 50]);
             clearManualSelection();
             return;
        }

        const allWords = Array.from(contentDiv.querySelectorAll('.interactive-word'));
        for (let i = start; i <= end; i++) {
            const w = allWords.find(wd => parseInt(wd.dataset.idx) === i);
            if (w) {
                w.classList.add('phrase-selecting');
                w.dataset.userSelected = "true";
            }
        }
        
        pendingPhraseStartIdx = null; 
        checkSelectionState(el); 
    }
}
    function deletePhraseFromDB(phraseText) {
    let items = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]');
    const target = sanitizeText(phraseText).toLowerCase();

    // Funci√≥n recursiva para filtrar items
    const recursiveFilter = (list) => {
        return list.filter(item => {
            if (item.isFolder) {
                // Si es carpeta, filtramos sus hijos
                item.items = recursiveFilter(item.items);
                return true; // Mantenemos la carpeta
            }
            // Si es item, comparamos el texto
            return sanitizeText(item.eng).toLowerCase() !== target;
        });
    };

    items = recursiveFilter(items);
    localStorage.setItem(MDC_VOCAB_KEY, JSON.stringify(items));
}

function clearManualSelection() {
    document.querySelectorAll('.phrase-selecting').forEach(el => {
        el.classList.remove('phrase-selecting');
        delete el.dataset.userSelected;
    });
    pendingPhraseStartIdx = null;
    
    // RESTAURAR P√çLDORA A ESTADO NORMAL
    const pill = document.getElementById('unified-pill');
    if(pill) pill.classList.remove('selection-mode');
}

function checkSelectionState(element) {
    // Usamos currentStatsContext o buscamos el activo
    const contentDiv = element.closest('.interactive-content') || currentStatsContext;
    if (!contentDiv) return;

    const selected = contentDiv.querySelectorAll('.phrase-selecting');
    const pill = document.getElementById('unified-pill');
    const saveBtn = document.getElementById('pill-save-btn');
    
    if(selected.length > 0) {
        // ACTIVAR MODO SELECCI√ìN EN LA P√çLDORA
        pill.classList.add('visible'); // Asegurar que se ve
        pill.classList.add('selection-mode');
        saveBtn.innerHTML = `üíæ SAVE PHRASE (${selected.length})`;
    } else {
        // DESACTIVAR MODO SELECCI√ìN
        pill.classList.remove('selection-mode');
    }
}

function savePhraseFromPill() {
    // Usamos la variable global currentStatsContext que ya tienes definida
    if (!currentStatsContext) return;

    const selected = Array.from(currentStatsContext.querySelectorAll('.phrase-selecting'));
    if (selected.length === 0) return;
    
    // Ordenar elementos por √≠ndice DOM para reconstruir la frase en orden
    selected.sort((a,b) => parseInt(a.dataset.idx) - parseInt(b.dataset.idx));
    
    const phraseText = selected.map(el => sanitizeText(el.innerText)).join(" ");
    
    // Guardar usando tu l√≥gica existente
    forceSavePhrase(phraseText, currentStatsContext);
    
    // Limpiar UI
    clearManualSelection();
    refreshActiveView(); // Refrescar para ver el color amarillo
}

function forceSavePhrase(cleanPhrase, elementContext) {
    if (!cleanPhrase) return;
    let items = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]');
    const checkEng = cleanPhrase.toLowerCase();
    let exists = false;
    items.forEach(i => {
        if (!i.isFolder && i.eng && sanitizeText(i.eng).toLowerCase() === checkEng) exists = true;
        if (i.isFolder && i.items) {
            i.items.forEach(sub => { if (sub.eng && sanitizeText(sub.eng).toLowerCase() === checkEng) exists = true; });
        }
    });
    
    if (exists) { alert("Phrase already saved."); return; }
    
    const accordionItem = elementContext.closest('.accordion-item');
    const folderName = accordionItem ? accordionItem.querySelector('.header-content strong').innerText.trim() : "AI Generator";
    const newItem = { id: Date.now(), isFolder: false, eng: cleanPhrase, esp: "", isHighlighted: false, dateAdded: Date.now() };
    
    let targetFolder = items.find(i => i.isFolder && i.name.toLowerCase() === folderName.toLowerCase());
    if (targetFolder) {
        targetFolder.items.unshift(newItem);
        items = items.filter(i => i.id !== targetFolder.id); items.unshift(targetFolder);
    } else {
        const newFolder = { id: Date.now() + 1, isFolder: true, name: folderName, items: [newItem] };
        items.unshift(newFolder);
    }
    localStorage.setItem(MDC_VOCAB_KEY, JSON.stringify(items));
}

/* === PILL LOGIC === */
function updateUnifiedPill(translationData = null) {
    const pill = document.getElementById('unified-pill');
    const statsText = document.getElementById('pill-stats-text');
    const transPart = document.getElementById('pill-trans');
    const divider = document.getElementById('pill-divider');
    const transResult = document.getElementById('trans-result');
    const speakBtn = document.getElementById('pill-speak');

    if (!currentStatsContext) { pill.classList.remove('visible'); return; }

    pill.classList.add('visible');

    const savedElements = currentStatsContext.querySelectorAll('.interactive-word.saved, .interactive-word.phrase-saved');
    const uniqueSet = new Set();
    savedElements.forEach(el => uniqueSet.add(sanitizeText(el.innerText).toLowerCase()));
    
    currentWordStats.uniqueTotal = uniqueSet.size;
    currentWordStats.occurrences = savedElements.length;
    
    statsText.innerText = `${currentWordStats.occurrences} | ${currentWordStats.uniqueTotal}`;
    if(currentWordStats.uniqueTotal > 0) statsText.classList.add('stats-active');
    else statsText.classList.remove('stats-active');

    if (translationData) {
        divider.style.display = 'block';
        transPart.classList.add('active');
        transResult.innerText = translationData.result;
        speakBtn.onclick = () => speakText(translationData.origin);
    } else if (!transPart.classList.contains('active')) {
        divider.style.display = 'none';
    }
}

async function translateWord(text) {
    const transPart = document.getElementById('pill-trans');
    transPart.dataset.hasActive = "true"; 
    updateUnifiedPill({ result: "...", origin: text });

    try {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=es&dt=t&q=${encodeURIComponent(text)}`);
        const data = await res.json();
        let result = "Not found";
        if (data && data[0] && data[0][0]) result = data[0][0][0];
        updateUnifiedPill({ result: result, origin: text }); 
    } catch (e) { 
        updateUnifiedPill({ result: "Error", origin: text }); 
    }
    clearTimeout(window.transTimer);
}

// --- CORE INTERACTION LOGIC ---
function toggleAccordion(id) {
    const content = document.getElementById(`content-${id}`);
    const isVisible = content.classList.contains('active');
    document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('active'));
    
    // Limpieza de selecciones manuales al cambiar
    clearManualSelection();

    if (!isVisible) {
        content.classList.add('active');
        setTimeout(refreshActiveView, 50); 
        currentStatsContext = content.querySelector('.interactive-content');
        currentWordStats.occurrences = "-";
        updateUnifiedPill(null); 
    } else {
        currentStatsContext = null;
        updateUnifiedPill(null); 
    }
}

function saveWordToMDC(word, element) {
    translateWord(word); 
    const cleanWord = sanitizeText(word);
    if (!cleanWord) return;

    let items = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]');
    const checkEng = cleanWord.toLowerCase();
    let wordFound = false;
    items.forEach(i => {
        if (!i.isFolder && i.eng && sanitizeText(i.eng).toLowerCase() === checkEng) wordFound = true;
        if (i.isFolder && i.items) {
            i.items.forEach(sub => { if (sub.eng && sanitizeText(sub.eng).toLowerCase() === checkEng) wordFound = true; });
        }
    });

    const accordionItem = element.closest('.accordion-item');
    const folderName = accordionItem ? accordionItem.querySelector('.header-content strong').innerText.trim() : "AI Generator";
    
    if (!wordFound) {
        const newItem = { id: Date.now(), isFolder: false, eng: cleanWord, esp: "", isHighlighted: false, dateAdded: Date.now() };
        let targetFolder = items.find(i => i.isFolder && i.name.toLowerCase() === folderName.toLowerCase());
        if (targetFolder) {
            targetFolder.items.unshift(newItem);
            items = items.filter(i => i.id !== targetFolder.id); items.unshift(targetFolder);
        } else {
            const newFolder = { id: Date.now() + 1, isFolder: true, name: folderName, items: [newItem] };
            items.unshift(newFolder);
        }
    } else {
        items.forEach(folder => {
            if (folder.isFolder && folder.items) { folder.items = folder.items.filter(item => sanitizeText(item.eng).toLowerCase() !== checkEng); }
        });
        items = items.filter(i => i.isFolder || (i.eng && sanitizeText(i.eng).toLowerCase() !== checkEng));
    }
    localStorage.setItem(MDC_VOCAB_KEY, JSON.stringify(items));
}

/* === REST OF APP LOGIC === */
function loadVocabFolders() {
    const raw = localStorage.getItem(MDC_VOCAB_KEY);
    const group = document.getElementById('folder-group');
    const badge = document.getElementById('vocab-count-badge');
    if(!raw) { badge.innerText = "No DB"; badge.style.color = "#cf6679"; return; }
    const data = JSON.parse(raw);
    group.innerHTML = '';
    let total = 0;
    data.forEach(item => {
        if(item.isFolder) {
            let opt = document.createElement('option');
            opt.value = `folder:${item.id}`;
            opt.textContent = `${item.name} (${item.items.length})`;
            group.appendChild(opt);
            total += item.items.length;
        } else total++;
    });
    badge.innerText = `${total} words`;
    badge.style.color = "#00ffcc";
}

function toggleVocabMode() {
    const isActive = document.getElementById('useVocabCheckbox').checked;
    const settings = document.getElementById('vocab-settings');
    const controlsPanel = document.getElementById('vocab-controls');
    const topicInput = document.getElementById('topicInput');
    const taskSelect = document.getElementById('taskSelect');
    settings.style.display = isActive ? 'block' : 'none';
    if (isActive) {
        controlsPanel.classList.add('active-panel');
        loadVocabFolders(); 
        topicInput.value = "Target Vocabulary List"; 
        topicInput.disabled = true;
        taskSelect.innerHTML = '';
        VOCAB_TASKS.forEach(t => { let opt = document.createElement('option'); opt.value = t.id; opt.textContent = t.label; taskSelect.appendChild(opt); });
        syncModeWithTask(); 
    } else {
        controlsPanel.classList.remove('active-panel');
        topicInput.value = ""; topicInput.disabled = false;
        updateDynamicDropdowns(); 
    }
}

function syncModeWithTask() {
    if (!document.getElementById('useVocabCheckbox').checked) return;
    const taskId = document.getElementById('taskSelect').value;
    const task = VOCAB_TASKS.find(t => t.id === taskId);
    if (task && task.linkedMode) {
        document.getElementById('modeSelect').value = task.linkedMode;
    }
}

function getSelectedVocab() {
    if (!document.getElementById('useVocabCheckbox').checked) return null;
    const source = document.getElementById('vocabSource').value;
    const amount = parseInt(document.getElementById('vocabAmount').value);
    const raw = localStorage.getItem(MDC_VOCAB_KEY);
    if(!raw) return [];
    const data = JSON.parse(raw);
    let pool = [];
    if (source === 'all') { data.forEach(i => i.isFolder ? pool.push(...i.items) : pool.push(i)); } 
    else if (source === 'highlighted') { data.forEach(i => { if(i.isFolder) pool.push(...i.items.filter(x=>x.isHighlighted)); else if(i.isHighlighted) pool.push(i); }); } 
    else if (source.startsWith('folder:')) { const fid = parseInt(source.split(':')[1]); const f = data.find(i => i.id === fid); if(f) pool = f.items; }
    else if (source === 'recent') { let all = []; data.forEach(i => i.isFolder ? all.push(...i.items) : all.push(i)); all.sort((a,b) => b.id - a.id); pool = all.slice(0, 10); }
    if(pool.length === 0) return [];
    return pool.sort(() => 0.5 - Math.random()).slice(0, amount).map(i => i.eng);
}

function loadVoices() {
    availableVoices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en')); 
    document.querySelectorAll('.daw-select').forEach(sel => updateVoiceSelect(sel));
}

function updateVoiceSelect(select) {
    const savedVoiceURI = localStorage.getItem(PREF_AUDIO_VOICE);
    select.innerHTML = '';
    availableVoices.forEach(v => { const opt = document.createElement('option'); opt.value = v.voiceURI; opt.textContent = v.name.substring(0, 18); select.appendChild(opt); });
    if(savedVoiceURI) select.value = savedVoiceURI;
}

function updateAudioLive(id) {
    const speed = document.getElementById(`speed-${id}`).value;
    const voiceURI = document.getElementById(`voice-${id}`).value;
    localStorage.setItem(PREF_AUDIO_SPEED, speed);
    localStorage.setItem(PREF_AUDIO_VOICE, voiceURI);
    const screen = document.getElementById(`screen-${id}`);
    const voiceName = availableVoices.find(v => v.voiceURI === voiceURI)?.name.substring(0,6) || "DEF";
    if(screen) screen.innerText = `SPD:${speed}x | ${voiceName}`;
}

function speakContent(id) {
    window.speechSynthesis.cancel();
    const contentDiv = document.querySelector(`#content-${id} .interactive-content`);
    const text = contentDiv.innerText;
    const speed = document.getElementById(`speed-${id}`).value;
    const voiceURI = document.getElementById(`voice-${id}`).value;
    const playBtn = document.getElementById(`play-${id}`);
    const screen = document.getElementById(`screen-${id}`);

    playBtn.classList.add('playing');
    playBtn.innerHTML = '‚óè';
    if(screen) screen.classList.add('active');

    const utter = new SpeechSynthesisUtterance(text);
    const selectedVoice = availableVoices.find(v => v.voiceURI === voiceURI);
    if(selectedVoice) utter.voice = selectedVoice;
    utter.rate = parseFloat(speed);

    utter.onstart = () => {
        if(!playBtn.classList.contains('playing')) {
            playBtn.classList.add('playing');
            playBtn.innerHTML = '‚óè';
        }
    };
    utter.onend = () => {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '‚ñ∂';
        if(screen) screen.classList.remove('active');
    };
    utter.onerror = () => {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '‚ñ∂';
        if(screen) screen.classList.remove('active');
    };
    window.speechSynthesis.speak(utter);
}

function toggleAudio(id) {
    const btn = document.getElementById(`play-${id}`);
    if (btn.classList.contains('playing')) {
        window.speechSynthesis.cancel();
        btn.classList.remove('playing');
        btn.innerHTML = '‚ñ∂';
        const screen = document.getElementById(`screen-${id}`);
        if(screen) screen.classList.remove('active');
    } else {
        speakContent(id);
    }
}

function sanitizeText(text) { if (!text) return ""; text = text.replace(/['`‚Äò¬¥]/g, "‚Äô"); text = text.replace(/[^a-zA-Z0-9\u00C0-\u017F\s‚Äô]/g, ""); return text.trim(); }

function loadNexusHistory() {
    const stored = localStorage.getItem(NEXUS_STORAGE_KEY);
    if (stored) { nexusHistory = JSON.parse(stored); [...nexusHistory].reverse().forEach(data => renderAccordionDOM(data)); }
}
function saveNexusState() { localStorage.setItem(NEXUS_STORAGE_KEY, JSON.stringify(nexusHistory)); }
function addToNexusHistory(data) { nexusHistory.unshift(data); saveNexusState(); }
function removeFromNexusHistory(id) { nexusHistory = nexusHistory.filter(item => item.id !== id); saveNexusState(); }

function formatInteractiveContent(text, existingVocabSet) {
    if (!text) return "";
    const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    let i = 0; 
    return safeText.split(/(\s+)/).map(token => {
        if (token.match(/^\s+$/)) return token; 
        const span = `<span class="interactive-word" data-idx="${i}" 
            onmousedown="startPress(this)" 
            ontouchstart="startPress(this)" 
            onmouseup="endPress(this, event)" 
            ontouchend="endPress(this, event)"
            onclick="handleShortClick(this)"
            onmouseenter="handleHoverStart(this)" 
            onmouseleave="handleHoverEnd()">${token}</span>`;
        i++;
        return span;
    }).join('');
}

function renderAccordionDOM(data) {
    const container = document.getElementById('results-container');
    const item = document.createElement('div');
    item.className = 'accordion-item';
    item.id = `item-${data.id}`;
    const interactiveHTML = formatInteractiveContent(data.content);
    const savedSpeed = localStorage.getItem(PREF_AUDIO_SPEED) || "1";

    item.innerHTML = `
        <div class="accordion-header" onclick="toggleAccordion(${data.id})">
            <div class="header-content">
                <span class="meta-tag">${data.modeName}</span>
                <strong>${data.topic}</strong>
            </div>
            <div class="header-actions">
                <button class="btn-delete" onclick="deleteItem(event, ${data.id})">üóëÔ∏è</button>
                <span>‚ñº</span>
            </div>
        </div>
        <div class="accordion-content" id="content-${data.id}">
            <div class="daw-panel">
                <div class="daw-top-deck">
                    <button id="play-${data.id}" class="daw-btn-play" onclick="toggleAudio(${data.id})">‚ñ∂</button>
                    <div class="daw-screen" id="screen-${data.id}">MASTER OUT</div>
                </div>
                <div class="daw-control-deck">
                    <div class="daw-knob-group">
                        <span class="daw-label">SPEED</span>
                        <input type="range" id="speed-${data.id}" class="daw-slider" min="0.5" max="2.0" step="0.1" value="${savedSpeed}" oninput="updateAudioLive(${data.id})">
                    </div>
                    <div class="daw-knob-group">
                        <span class="daw-label">VOICE BANK</span>
                        <select id="voice-${data.id}" class="daw-select" onchange="updateAudioLive(${data.id})"></select>
                    </div>
                </div>
            </div>
            
            <button class="copy-prompt-btn" onclick="copyTextToClipboard(this)">üìú Copy Prompt</button>
            <div style="display:none;" class="prompt-source">${data.prompt}</div>
            <hr style="border:0; border-top:1px solid #444; margin:10px 0;">
            <div class="interactive-content" style="white-space: pre-wrap;">${interactiveHTML}</div>
        </div>
    `;

    if(document.getElementById(`item-${data.id}`)) return;
    if (container.firstChild) container.insertBefore(item, container.firstChild);
    else container.appendChild(item);

    setTimeout(() => { updateVoiceSelect(document.getElementById(`voice-${data.id}`)); }, 100);
}

function updateDynamicDropdowns() {
    if (!document.getElementById('useVocabCheckbox').checked) { populateSelect('taskSelect', currentData.TASK_TYPES); }
    populateSelect('voiceSelect', currentData.VOICES);
    populateSelect('lengthSelect', currentData.LENGTH);
    const levelSel = document.getElementById('levelSelect');
    levelSel.innerHTML = '';
    currentData.FADER_LEVELS.forEach((level) => { let opt = document.createElement('option'); opt.value = level; opt.textContent = level.split(':')[0]; levelSel.appendChild(opt); });
}

function populateSelect(id, dataArray) {
    const select = document.getElementById(id);
    select.innerHTML = '';
    dataArray.forEach(item => { let opt = document.createElement('option'); opt.value = item.id; opt.textContent = item.label; select.appendChild(opt); });
}

function loadHistory(inputId, listId) {
    const history = JSON.parse(localStorage.getItem(inputId + '_mem')) || [];
    const dataList = document.getElementById(listId);
    if(dataList) { dataList.innerHTML = ''; history.forEach(item => { let option = document.createElement('option'); option.value = item; dataList.appendChild(option); }); }
}

function saveToHistory(inputId) {
    const input = document.getElementById(inputId);
    const value = input.value.trim();
    if (!value) return;
    let history = JSON.parse(localStorage.getItem(inputId + '_mem')) || [];
    history = history.filter(item => item !== value);
    history.unshift(value);
    if (history.length > 5) history.pop();
    localStorage.setItem(inputId + '_mem', JSON.stringify(history));
    loadHistory(inputId, input.getAttribute('list'));
}

function generatePrompt() {
    const isVocabMode = document.getElementById('useVocabCheckbox').checked;
    let context = document.getElementById('contextInput').value;
    let topic = document.getElementById('topicInput').value;
    let vocabBlock = "";
    let selectedTask = null;

    if (isVocabMode) {
        const words = getSelectedVocab();
        if (words && words.length > 0) {
            vocabBlock = `\n<target_vocabulary_list>\n${words.join(', ')}\n</target_vocabulary_list>\n\n**MANDATORY INSTRUCTION:** 1. You MUST incorporate the words inside the <target_vocabulary_list> tags into your response.\n2. Formatting Rule: Mark every used word in **bold** (e.g., **word**).\n`;
            topic = "English Vocabulary Practice"; 
            const taskId = document.getElementById('taskSelect').value;
            selectedTask = VOCAB_TASKS.find(t => t.id === taskId);
            if(!selectedTask) selectedTask = VOCAB_TASKS[0];
        } else { alert("No vocabulary found! Add words in the MDC App."); return; }
    } else { selectedTask = currentData.TASK_TYPES.find(t => t.id === document.getElementById('taskSelect').value); }

    const mode = COMMON_DATA.MODES.find(m => m.id === document.getElementById('modeSelect').value);
    const format = COMMON_DATA.FORMATS.find(f => f.id === document.getElementById('formatSelect').value);
    const voice = currentData.VOICES.find(v => v.id === document.getElementById('voiceSelect').value);
    const len = currentData.LENGTH.find(l => l.id === document.getElementById('lengthSelect').value);
    const level = document.getElementById('levelSelect').value;

    const prompt = `
# SYSTEM IDENTITY & CORE OBJECTIVE
You are an advanced AI acting strictly as: **${mode.role}**
Your style must be: ${mode.style}
**Primary Goal:** ${mode.goal}

# PROJECT CONTEXT
I need you to perform a specific task based on the following parameters:
- **Context:** ${context || "General"}
- **Subject/Topic:** ${topic}
- **Task Type:** ${selectedTask.label} -> ${selectedTask.instruction}

${vocabBlock ? `\n# MANDATORY DATA (Vocabulary)${vocabBlock}\n` : ''}

# RESPONSE GUIDELINES
Follow these configuration rules strictly:
1. **Format:** ${format.label} (${format.instruction})
2. **Tone:** ${voice.instruction}
3. **Length:** ${len.instruction}
4. **Depth Level:** ${level}

# CRITICAL INSTRUCTIONS & RESTRICTIONS
To ensure high quality, follow this logic:
- Think step-by-step before generating.
- Analyze the "${topic}" within the context of "${context}".
- ${currentData.RESTRICTIONS.join('\n- ')}

---
**BEGIN RESPONSE:**`.trim();

    const outputDiv = document.getElementById('prompt-output');
    outputDiv.style.display = 'block';
    outputDiv.textContent = prompt;
    navigator.clipboard.writeText(prompt);
    lastGeneratedPrompt = prompt;
    if(!isVocabMode) { saveToHistory('contextInput'); saveToHistory('topicInput'); }
}

async function handlePasteResponse() {
    try {
        const text = await navigator.clipboard.readText();
        if(!text) return alert("Clipboard is empty.");
        const data = {
            id: Date.now(),
            modeName: document.getElementById('modeSelect').options[document.getElementById('modeSelect').selectedIndex].text,
            topic: document.getElementById('topicInput').value || "Untitled Result",
            prompt: lastGeneratedPrompt,
            content: text
        };
        addToNexusHistory(data);
        renderAccordionDOM(data);
        toggleGenerator(false);
    } catch (err) { alert("Permission denied or error reading clipboard."); }
}

function toggleGenerator(show) {
    const gen = document.getElementById('generator-container');
    const btnShow = document.getElementById('btn-show-gen');
    if (show) { gen.classList.remove('hidden'); btnShow.style.display = 'none'; } 
    else { gen.classList.add('hidden'); btnShow.style.display = 'block'; }
}

function deleteItem(event, id) {
    event.stopPropagation();
    if(confirm("Delete result?")) {
        const el = document.getElementById(`item-${id}`);
        if(el) el.remove();
        removeFromNexusHistory(id);
    }
}

function copyTextToClipboard(btnElement) {
    const promptText = btnElement.nextElementSibling.textContent;
    navigator.clipboard.writeText(promptText).then(() => {
        const originalText = btnElement.innerText;
        btnElement.innerText = "Copied!";
        setTimeout(() => btnElement.innerText = originalText, 1500);
    });
}

function filterResults() {
    const query = document.getElementById('searchBar').value.toLowerCase();
    const items = document.querySelectorAll('.accordion-item');
    items.forEach(item => {
        const topic = item.querySelector('.header-content strong').innerText.toLowerCase();
        const content = item.querySelector('.interactive-content').innerText.toLowerCase();
        if (topic.includes(query) || content.includes(query)) item.style.display = "block";
        else item.style.display = "none";
    });
}

function speakText(text) {
    if (!text) return; 
    
    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    
    const savedSpeed = localStorage.getItem(PREF_AUDIO_SPEED) || "1.0";
    utter.rate = parseFloat(savedSpeed);
    
    const savedVoiceURI = localStorage.getItem(PREF_AUDIO_VOICE);

    const setEnglishVoice = () => {
        const voices = window.speechSynthesis.getVoices();
        let enVoice = null;

        if (savedVoiceURI) {
            enVoice = voices.find(v => v.voiceURI === savedVoiceURI); 
        }

        if (!enVoice) {
            enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) 
                   || voices.find(v => v.lang.startsWith('en')) 
                   || voices[0];
        }
        
        if (enVoice) utter.voice = enVoice;
        window.speechSynthesis.speak(utter);
    };

    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = setEnglishVoice;
    } else {
        setEnglishVoice();
    }
}
</script>
</body>
</html>
