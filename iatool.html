<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEXUS | Studio V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* =========================================
           1. ESTILOS VISUALES (CORE)
           ========================================= */
        :root {
            --bg-body: #050505;
            --glass-border: rgba(255, 255, 255, 0.08);
            --neon-gen: #00f2ea;
            --neon-del: #ff4444;
            --neon-edit: #ffd700;
            --ease-snap: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg-body); color: #fff; font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        body.locked .scroll-container { overflow: hidden; pointer-events: none; }

        /* CONTENEDOR PRINCIPAL */
        .scroll-container { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px 0 450px 0; width: 100%; max-width: 600px; margin: 0 auto; position: relative; }
        #deck-list { display: flex; flex-direction: column; gap: 12px; min-height: 50px; }

        /* TARJETAS (ACORDEÓN) */
        .card { background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0) 100%); border: 1px solid var(--glass-border); border-left: 3px solid var(--neon-gen); border-radius: 8px; margin: 0 16px; position: relative; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .card-header { padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; gap: 15px; cursor: pointer; transition: background 0.3s; z-index: 2; position: relative; }
        .title-group { display: flex; align-items: center; gap: 15px; overflow: hidden; flex: 1; }
        .card-title { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 1.5px; color: #ccc; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .card-tag { 
            font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; text-transform: uppercase; 
            padding: 3px 8px; border-radius: 2px; background: rgba(0, 242, 234, 0.1); 
            color: var(--neon-gen); border: 1px solid rgba(0, 242, 234, 0.2); flex-shrink: 0; 
        }
        /* Tag especial para texto */
        .card-tag.text-mode { color: #ffd700; border-color: rgba(255, 215, 0, 0.3); background: rgba(255, 215, 0, 0.1); }

        .card-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .btn-delete-card { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255, 68, 68, 0.1); color: var(--neon-del); border: 1px solid rgba(255, 68, 68, 0.3); cursor: pointer; }
        .btn-delete-card:hover { background: var(--neon-del); color: #fff; }

        /* ESTADO ACTIVO (EXPANDIDO) */
        .card.active { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; z-index: 9999; margin: 0; border: none; background: #000; display: flex; flex-direction: column; animation: expandCard 0.3s var(--ease-snap) forwards; }
        @keyframes expandCard { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card.active .card-header { background: rgba(20,20,20,0.98); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .card.active .card-title { color: #fff; }
        .card.active .btn-delete-card { display: none; }
        
        .card-content { display: none; background: #000; flex: 1; position: relative; }
        .card.active .card-content { display: flex; animation: fadeIn 0.5s ease 0.2s forwards; opacity: 0; }
        @keyframes fadeIn { to { opacity: 1; } }
        iframe { width: 100%; height: 100%; border: none; background: #fff; display: block; }

        /* GENERADOR (PANEL INFERIOR) */
        .generator-panel { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--glass-border); padding: 15px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
        .gen-container { max-width: 600px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; gap: 10px; }

        /* PREVIEW WINDOW */
        .prompt-preview-window { position: absolute; bottom: 100%; left: 0; width: 100%; max-height: 0; background: rgba(0,0,0,0.9); border: 1px solid var(--neon-gen); border-bottom: none; border-radius: 8px 8px 0 0; color: #ccc; font-family: monospace; font-size: 11px; opacity: 0; pointer-events: none; overflow: hidden; transition: 0.3s; }
        .prompt-preview-window.visible { max-height: 200px; opacity: 1; padding: 15px; margin-bottom: 15px; pointer-events: auto; overflow-y: auto; }
        .preview-header { color: var(--neon-gen); font-size: 9px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; }

        /* CHIPS (Selector Tags) */
        .row-label { font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 4px; font-weight: 700; letter-spacing: 1px; }
        .chip-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .chip { padding: 6px 12px; border-radius: 4px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: #888; font-size: 11px; font-weight: 600; cursor: pointer; text-transform: uppercase; transition: 0.2s; user-select: none; }
        .chip:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .chip.active-mode { background: rgba(0, 242, 234, 0.15); border-color: var(--neon-gen); color: var(--neon-gen); box-shadow: 0 0 8px rgba(0, 242, 234, 0.2); }
        .chip.active-format { background: rgba(255, 215, 0, 0.15); border-color: var(--neon-edit); color: var(--neon-edit); box-shadow: 0 0 8px rgba(255, 215, 0, 0.2); }

        /* FADER */
        .fader-container { width: 100%; padding: 5px 0; }
        input[type=range].fader { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range].fader:focus { outline: none; }
        input[type=range].fader::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        input[type=range].fader::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #fff; border: 2px solid var(--neon-gen); cursor: pointer; -webkit-appearance: none; margin-top: -6px; transition: 0.1s; }

        .gen-input { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #fff; padding: 10px; font-size: 14px; border-radius: 6px; width: 100%; }
        .gen-input:focus { border-color: var(--neon-gen); }
        .gen-controls { display: flex; gap: 8px; margin-top: 5px; }
        .gen-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: 600; text-transform: uppercase; font-size: 11px; cursor: pointer; }
        .btn-copy { background: #333; color: #fff; border: 1px solid #444; }
        .btn-paste { background: var(--neon-gen); color: #000; box-shadow: 0 0 10px rgba(0, 242, 234, 0.3); }
        .status-toast { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid var(--neon-gen); color: var(--neon-gen); padding: 8px 16px; border-radius: 20px; font-size: 12px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 6000; }
    </style>
</head>
<body>

    <div class="scroll-container">
        <div id="deck-list"></div>
    </div>

    <div class="generator-panel">
        <div class="status-toast" id="toast">Action Completed</div>
        <div class="gen-container">
            
            <div class="prompt-preview-window" id="previewWindow">
                <div class="preview-header">
                    <span>Prompt Matrix</span>
                    <span id="matrixInfo"></span>
                </div>
                <div id="previewText" style="white-space: pre-wrap;">Type to generate...</div>
            </div>

            <div>
                <div class="row-label">1. IDENTITY (Who)</div>
                <div class="chip-row" id="modeContainer"></div>
            </div>

            <div>
                <div class="row-label">2. OUTPUT FORMAT (How)</div>
                <div class="chip-row" id="formatContainer"></div>
            </div>

            <div class="fader-container">
                <input type="range" min="1" max="5" value="3" class="fader" id="detailFader" oninput="updatePrompt()">
            </div>

            <input type="text" id="topicInput" class="gen-input" placeholder="Topic..." oninput="updatePrompt()">
            <input type="text" id="extraInput" class="gen-input" style="font-size: 12px; color: #aaa;" placeholder="Extra details..." oninput="updatePrompt()">
            
            <div class="gen-controls">
                <button class="gen-btn btn-copy" onclick="copyPrompt()">1. Copy Prompt</button>
                <button class="gen-btn btn-paste" onclick="pasteAndCreate()">2. Paste (Code or Text)</button>
            </div>
        </div>
    </div>

<script>
    // =================================================================
    // 1. CONFIGURACIÓN MATRIX (Totalmente editable)
    // =================================================================
    
    // MODOS (La "Personalidad" de la IA)
    const MODES = [
        { id: 'tech', label: 'TECHNICAL', role: 'Act as a Senior Engineer.', style: 'Cyberpunk/Terminal style.', goal: 'Technical accuracy.' },
        { id: 'art', label: 'ART', role: 'Act as a Curator/Designer.', style: 'Minimalist Gallery style.', goal: 'Visual aesthetics.' },
        { id: 'school', label: 'SCHOOL', role: 'Act as a Professor.', style: 'Clean Textbook style.', goal: 'Education.' }
    ];

    // FORMATOS (Cómo entrega el resultado)
    const FORMATS = [
        { id: 'html', label: 'HTML APP', instruction: 'Return a single interactive HTML file with CSS/JS embedded. NO markdown wrappers.' },
        { id: 'code', label: 'PYTHON/JS', instruction: 'Return raw code script (Python or JS). Use comments for explanation.' },
        { id: 'text', label: 'TEXT GUIDE', instruction: 'Return a comprehensive text guide in Markdown format.' }
    ];

    // NIVELES DE PROFUNDIDAD (Fader)
    const FADER_LEVELS = [
        "- Level 1: Basic Definition and Summary.",
        "- Level 2: Add Context, History, or Parameters.",
        "- Level 3: Add Interaction (Logic loops or Accordions).",
        "- Level 4: Add Troubleshooting, Edge-cases, or Quiz.",
        "- Level 5: Full production-ready structure with error handling."
    ];

    // =================================================================
    // 2. LÓGICA DEL SISTEMA
    // =================================================================

    // ¡IMPORTANTE! Usamos 'nexus_studio_v3' para limpiar errores de versiones pasadas
    let userDecks = JSON.parse(localStorage.getItem('nexus_studio_v3')) || [];
    let activeModeId = MODES[0].id;
    let activeFormatId = FORMATS[0].id;
    let generatedPromptText = "";

    function initInterface() {
        // Renderizar botones de MODO
        const modeCont = document.getElementById('modeContainer');
        MODES.forEach(m => {
            const chip = document.createElement('div');
            chip.className = `chip ${m.id === activeModeId ? 'active-mode' : ''}`;
            chip.textContent = m.label;
            chip.onclick = () => { activeModeId = m.id; renderChips(); updatePrompt(); };
            modeCont.appendChild(chip);
        });

        // Renderizar botones de FORMATO
        const fmtCont = document.getElementById('formatContainer');
        FORMATS.forEach(f => {
            const chip = document.createElement('div');
            chip.className = `chip ${f.id === activeFormatId ? 'active-format' : ''}`;
            chip.textContent = f.label;
            chip.onclick = () => { activeFormatId = f.id; renderChips(); updatePrompt(); };
            fmtCont.appendChild(chip);
        });

        document.getElementById('detailFader').max = FADER_LEVELS.length;
    }

    function renderChips() {
        document.querySelectorAll('#modeContainer .chip').forEach((c, i) => {
            c.className = `chip ${MODES[i].id === activeModeId ? 'active-mode' : ''}`;
        });
        document.querySelectorAll('#formatContainer .chip').forEach((c, i) => {
            c.className = `chip ${FORMATS[i].id === activeFormatId ? 'active-format' : ''}`;
        });
    }

    function updatePrompt() {
        const topic = document.getElementById('topicInput').value.trim();
        const extra = document.getElementById('extraInput').value.trim();
        const level = parseInt(document.getElementById('detailFader').value);
        const previewWindow = document.getElementById('previewWindow');
        
        if (topic.length > 0 || extra.length > 0) {
            previewWindow.classList.add('visible');
        } else {
            previewWindow.classList.remove('visible');
            return;
        }

        const mode = MODES.find(m => m.id === activeModeId);
        const format = FORMATS.find(f => f.id === activeFormatId);
        let depth = FADER_LEVELS.slice(0, level).join("\n");

        generatedPromptText = `${mode.role}
Topic: "${topic}"
Goal: ${mode.goal}
Style: ${mode.style}

REQUIRED OUTPUT: ${format.instruction}

COMPLEXITY (${level}/${FADER_LEVELS.length}):
${depth}

${extra ? `EXTRA NOTES: "${extra}"` : ""}

IMPORTANT: If HTML, return raw code. If Text, return Markdown.`;

        document.getElementById('previewText').textContent = generatedPromptText;
        document.getElementById('matrixInfo').textContent = `${mode.label} + ${format.label} [${level}]`;
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 2000);
    }

    function copyPrompt() {
        if (!generatedPromptText) updatePrompt();
        if (!document.getElementById('topicInput').value) { showToast('Type a topic'); return; }
        navigator.clipboard.writeText(generatedPromptText).then(() => showToast('Copied!'));
    }

    // =================================================================
    // 3. SISTEMA DE ACORDEÓN (Estricto como pediste)
    // =================================================================
    const deckList = document.getElementById('deck-list');

    function saveDecks() { localStorage.setItem('nexus_studio_v3', JSON.stringify(userDecks)); }

    function renderDecks() {
        deckList.innerHTML = '';
        userDecks.forEach(deck => {
            const card = document.createElement('div');
            card.className = 'card';
            card.setAttribute('data-id', deck.id);
            
            // Etiqueta inteligente
            let tagClass = "card-tag";
            let tagText = deck.formatLabel || "DOC";
            if (deck.isTextPaste) {
                tagClass += " text-mode";
                tagText = "NOTE";
            }
            
            card.innerHTML = `
                <div class="card-header" onclick="toggleCard('${deck.id}')">
                    <div class="title-group">
                        <h2 class="card-title">${deck.title}</h2>
                        <span class="${tagClass}">${tagText}</span>
                    </div>
                    <div class="card-actions">
                        <div class="btn-delete-card" onclick="deleteDeck(event, '${deck.id}')">&#10005;</div>
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
                    </div>
                </div>
                <div class="card-content" id="content-${deck.id}"></div>
            `;
            deckList.appendChild(card);
        });
    }

    new Sortable(deckList, { animation: 300, handle: '.card-header', onEnd: () => {
        const newOrder = Array.from(deckList.children).map(c => c.getAttribute('data-id'));
        userDecks.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
        saveDecks();
    }});

    // === LÓGICA DE PEGADO INTELIGENTE (TEXTO vs CÓDIGO) ===
    async function pasteAndCreate() {
        const title = document.getElementById('topicInput').value.trim() || "Untitled";
        
        try {
            let content = await navigator.clipboard.readText();
            if (!content || !content.trim()) { showToast('Clipboard Empty'); return; }
            
            const trimmed = content.trim();
            let finalCode = "";
            let isText = false;
            let formatLabel = FORMATS.find(f => f.id === activeFormatId).label;

            // DETECCIÓN: ¿Es código HTML completo?
            if (trimmed.startsWith('<') && trimmed.includes('<!DOCTYPE')) {
                // Es una App HTML completa, usar tal cual
                finalCode = content;
                formatLabel = "APP";
            } else {
                // Es Texto o Fragmento de código -> Convertir a visor HTML bonito
                isText = true;
                
                // Usamos Marked.js para convertir Markdown a HTML
                const htmlBody = marked.parse(content);

                finalCode = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Note</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
    body { background: #050505; color: #e0e0e0; font-family: 'Inter', sans-serif; padding: 25px; line-height: 1.6; margin:0; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { color: #00f2ea; font-family: 'Bebas Neue', sans-serif; font-size: 32px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    h2, h3 { color: #fff; margin-top: 25px; border-left: 3px solid #ffd700; padding-left: 10px; }
    strong { color: #00f2ea; }
    code { background: #1a1a1a; padding: 2px 5px; border-radius: 4px; color: #ff79c6; font-family: monospace; }
    pre { background: #111; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; }
    pre code { background: transparent; color: #f8f8f2; padding: 0; }
    blockquote { border-left: 3px solid #00f2ea; margin: 0; padding-left: 15px; color: #aaa; font-style: italic; }
    ul, ol { padding-left: 20px; }
    li { margin-bottom: 5px; }
    a { color: #00f2ea; text-decoration: none; }
</style>
</head>
<body>
    <div class="container">
        <h1>${title}</h1>
        ${htmlBody}
    </div>
</body>
</html>`;
            }

            userDecks.push({ 
                id: 'd_' + Date.now(), 
                title: title, 
                code: finalCode, 
                formatLabel: formatLabel,
                isTextPaste: isText 
            });
            
            saveDecks();
            renderDecks();
            
            // Scroll al fondo
            setTimeout(() => { document.querySelector('.scroll-container').scrollTo({top: 10000, behavior:'smooth'}); }, 100);
            showToast(isText ? 'Note Created!' : 'App Created!');
            
        } catch (e) { 
            console.error(e);
            showToast('Error pasting'); 
        }
    }

    function deleteDeck(e, id) {
        e.stopPropagation();
        if(confirm("Delete this?")) { userDecks = userDecks.filter(d => d.id !== id); saveDecks(); renderDecks(); }
    }

    function toggleCard(id) {
        const card = document.querySelector(`.card[data-id="${id}"]`);
        const content = document.getElementById(`content-${id}`);
        
        if(card.classList.contains('active')) {
            card.classList.remove('active'); document.body.classList.remove('locked');
            setTimeout(() => content.innerHTML = '', 300);
        } else {
            // Cerrar otros
            document.querySelectorAll('.active').forEach(c => { c.classList.remove('active'); c.querySelector('.card-content').innerHTML=''; });
            
            // Abrir actual
            card.classList.add('active'); document.body.classList.add('locked');
            const deck = userDecks.find(d => d.id === id);
            if(deck) {
                const ifr = document.createElement('iframe');
                content.appendChild(ifr);
                ifr.contentWindow.document.open();
                ifr.contentWindow.document.write(deck.code);
                ifr.contentWindow.document.close();
            }
        }
    }

    // INICIAR
    initInterface();
    renderDecks();

</script>
</body>
</html>
