<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vocabulary Hunter: Final Tuning</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #0f0;
            --neon-red: #ff4444;
            --neon-blue: #4f46e5;
            --neon-yellow: #ffff00;
            --dark-bg: #050505;
            --panel-bg: rgba(0, 15, 0, 0.95);
        }
        body {margin:0;overflow:hidden;background:var(--dark-bg);font-family:'Press Start 2P',monospace;color:white;user-select:none;}
        canvas {display:block;}
        .scanlines {position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,255,255,0) 50%,rgba(0,0,0,0.2) 50%,rgba(0,0,0,0.2));background-size:100% 4px;z-index:999;pointer-events:none;}
        
        #ui {position:absolute;top:20px;left:20px;right:20px;z-index:10;pointer-events:none;display:flex;justify-content:space-between;text-shadow:2px 2px 0 #000;}
        #lives-panel {color:var(--neon-red);}
        #score-panel {color:var(--neon-green);}
        
        #category-bar-wrapper {position:absolute;bottom:30px;left:0;width:100%;padding:10px 0;background:rgba(0,0,0,0.85);z-index:15;overflow-x:auto;white-space:nowrap;display:flex;justify-content:center;border-top:1px solid #333;box-shadow:0 -5px 15px rgba(0,255,0,0.1);}
        .category-chip {padding:8px 16px;margin:0 8px;background:#111;color:#666;font-size:10px;cursor:pointer;border:1px solid #444;transition:.2s;pointer-events:all;display:inline-block;}
        .category-chip:hover {border-color:#888;color:#888;}
        .category-chip.help-btn {border-color:var(--neon-yellow);color:var(--neon-yellow);}
        .category-chip.help-btn:hover {background:#222200;box-shadow:0 0 10px var(--neon-yellow);}
        
        .overlay-screen {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
        h1 {color:var(--neon-green);text-shadow:4px 4px #003300;font-size:35px;margin-bottom:20px;line-height:1.5;}
        h2 {color:var(--neon-red);font-size:30px;margin-bottom:20px;text-shadow:3px 3px 0 #300;}
        p {line-height:2;color:#aaa;font-size:12px;max-width:600px;padding:0 20px;}
        .key-hint {display:inline-block;padding:2px 6px;border:1px solid #666;border-radius:4px;color:#fff;background:#222;font-size:10px;}
        .blink {animation:blinker 1s linear infinite;color:var(--neon-yellow);margin-top:40px;font-size:14px;cursor:pointer;}
        @keyframes blinker {50%{opacity:0;}}
        
        #study-content {
            background:var(--panel-bg);
            padding:0;
            border:2px solid var(--neon-green);
            width:80%; max-width:800px; height:80%;
            display: flex; flex-direction: column;
            position:relative; box-shadow:0 0 30px rgba(0,255,0,0.2); text-align:left;
        }

        .tabs-header { display: flex; border-bottom: 2px solid var(--neon-green); background: #002200; }
        .tab-btn {
            flex: 1; padding: 15px; cursor: pointer; text-align: center; font-size: 12px;
            background: transparent; border: none; color: #666; font-family: 'Press Start 2P';
            transition: 0.2s;
        }
        .tab-btn:hover { background: #003300; color: #fff; }
        .tab-btn.active { background: var(--neon-green); color: #000; font-weight: bold; }

        .tab-content { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        
        table {width:100%;border-collapse:separate;border-spacing:0;font-size:12px;}
        th {color:var(--neon-green);text-align:left;border-bottom:2px solid var(--neon-green);padding:10px;position:sticky;top:0;background:#050505;z-index:2;}
        td {padding:12px 10px;border-bottom:1px solid #333;color:#aaa;}
        .en-word {color:var(--neon-blue);font-weight:bold;}

        /* SLIDERS CLAROS */
        .config-group { margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .config-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #ddd; }
        .config-val { color: var(--neon-yellow); }
        .slider-desc { font-size: 8px; color: #666; margin-top: 5px; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--neon-green); }
        input[type=color] { cursor: pointer; border: none; width: 50px; height: 30px; }
        
        .reset-btn {
            width: 100%; padding: 15px; background: #330000; color: var(--neon-red); border: 1px solid var(--neon-red);
            font-family: 'Press Start 2P'; cursor: pointer; margin-top: 20px; font-size: 10px;
        }
        .reset-btn:hover { background: var(--neon-red); color: #000; }

        .close-btn {position:absolute;top:-15px;right:-15px;width:30px;height:30px;background:var(--neon-red);color:white;font-weight:bold;border:2px solid #fff;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:20;font-size:14px;}
        
        ::-webkit-scrollbar {width:10px;}
        ::-webkit-scrollbar-track {background:#111;}
        ::-webkit-scrollbar-thumb {background:#333;border:1px solid var(--neon-green);}
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="ui">
        <div id="score-panel">SCORE: <span id="score">0</span> | COMBO: <span id="combo">0</span></div>
        <div id="lives-panel">LIVES: <span id="lives">5</span></div>
        <div id="high-score-panel">HIGH: <span id="highScore">0</span></div>
    </div>
    <div id="category-bar-wrapper"></div>

    <div id="start-screen" class="overlay-screen" onclick="startGame()">
        <h1>VOCAB ROBOT</h1>
        <p>
            1. Enemies drop English words & <strong>Bombs</strong>.<br>
            2. Shoot 3 times to Translate -> 1 time to Destroy.<br>
            3. Shoot Parachutes (Letters/Numbers) to hear them.<br><br>
            <span class="key-hint">← →</span> Move &nbsp;&nbsp; <span class="key-hint">SPACE</span> Shoot &nbsp;&nbsp; <span class="key-hint">TAB</span> Menu
        </p>
        <div class="blink">CLICK TO START MISSION</div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;" onclick="startGame()">
        <h2>MISSION FAILED</h2>
        <p>FINAL SCORE: <span id="finalScore" style="color:white;">0</span></p>
        <div class="blink">CLICK TO RETRY</div>
    </div>

    <div id="study-guide" class="overlay-screen" style="display:none;">
        <div id="study-content">
            <div class="close-btn" onclick="toggleStudyGuide()">X</div>
            
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('db')">DATABASE</button>
                <button class="tab-btn" onclick="switchTab('settings')">GAME CONFIG</button>
            </div>

            <div id="tab-db" class="tab-content active">
                <h2 style="color:var(--neon-green);margin-top:0;font-size:14px;">WORDS LOADED</h2>
                <div id="study-table-container"></div>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2 style="color:var(--neon-yellow);margin-top:0;font-size:14px;">SYSTEM CONFIGURATION</h2>
                
                <div class="config-group">
                    <label class="config-label">ENEMY FREQUENCY (More Enemies)<span id="val-spawn" class="config-val">5</span></label>
                    <input type="range" id="cfg-spawn" min="1" max="10" step="1" value="5" oninput="updateConfig('spawn')">
                    <div class="slider-desc"><span>FEW</span><span>MANY</span></div>
                </div>

                <div class="config-group">
                    <label class="config-label">ENEMY SPEED<span id="val-speed" class="config-val">1.0x</span></label>
                    <input type="range" id="cfg-speed" min="0.5" max="3.0" step="0.1" value="1.0" oninput="updateConfig('speed')">
                    <div class="slider-desc"><span>SLOW</span><span>FAST</span></div>
                </div>

                <div class="config-group">
                    <label class="config-label">BOMB QUANTITY<span id="val-bomb" class="config-val">50%</span></label>
                    <input type="range" id="cfg-bomb" min="0" max="100" step="10" value="50" oninput="updateConfig('bomb')">
                    <div class="slider-desc"><span>NONE</span><span>RAIN</span></div>
                </div>
                
                <div class="config-group">
                    <label class="config-label">BOMB FALL SPEED<span id="val-bspeed" class="config-val">2.0</span></label>
                    <input type="range" id="cfg-bspeed" min="1.0" max="5.0" step="0.1" value="2.0" oninput="updateConfig('bspeed')">
                    <div class="slider-desc"><span>FLOAT</span><span>DROP</span></div>
                </div>

                <div class="config-group">
                    <label class="config-label">PLAYER COLOR</label>
                    <input type="color" id="cfg-color" value="#4f46e5" onchange="updateConfig('color')">
                </div>

                <button class="reset-btn" onclick="resetConfig()">RESET DEFAULTS</button>
            </div>

            <p style="margin-top:auto;text-align:center;color:#666;font-size:10px;padding:10px;">
                PRESS <span class="key-hint">TAB</span> TO RESUME GAME.
            </p>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
// --- GESTIÓN DE CONFIGURACIÓN ---
const CONFIG_KEY = 'vocab_robot_config_v2';

// Valores por defecto (User Friendly Scales)
let userSettings = {
    spawnLevel: 5,      // 1-10
    enemySpeed: 1.0,    // Multiplier
    bombChance: 30,     // 0-100 (Scale)
    bombSpeed: 2.0,     // Pixel Speed
    playerColor: '#4f46e5'
};

// Variables reales del juego (Calculadas)
let gameVars = {
    spawnInterval: 3500,
    bombProb: 0.005 
};

function loadConfig() {
    const saved = localStorage.getItem(CONFIG_KEY);
    if(saved) {
        try { userSettings = { ...userSettings, ...JSON.parse(saved) }; } 
        catch(e) { console.error("Config error", e); }
    }
    applyConfigToUI();
    recalcGameVars();
}

function applyConfigToUI() {
    document.getElementById('cfg-spawn').value = userSettings.spawnLevel;
    document.getElementById('val-spawn').textContent = userSettings.spawnLevel;
    
    document.getElementById('cfg-speed').value = userSettings.enemySpeed;
    document.getElementById('val-speed').textContent = userSettings.enemySpeed + "x";
    
    document.getElementById('cfg-bomb').value = userSettings.bombChance;
    document.getElementById('val-bomb').textContent = userSettings.bombChance + "%";

    document.getElementById('cfg-bspeed').value = userSettings.bombSpeed;
    document.getElementById('val-bspeed').textContent = userSettings.bombSpeed;

    document.getElementById('cfg-color').value = userSettings.playerColor;
    player.color = userSettings.playerColor;
}

function recalcGameVars() {
    // 3. SLIDERS MÁS CLAROS (Más es Más)
    // Spawn Level 1 (Lento) -> 5000ms
    // Spawn Level 10 (Rápido) -> 500ms
    // Formula: MaxTime - ((Level/10) * (MaxTime - MinTime))
    gameVars.spawnInterval = 5500 - (userSettings.spawnLevel * 500); 
    spawnTimer = gameVars.spawnInterval;

    // Bomb Chance 0-100 (Scale) -> 0.00 to 0.02 (Probability)
    gameVars.bombProb = userSettings.bombChance / 2000; 
}

function updateConfig(key) {
    if(key === 'spawn') userSettings.spawnLevel = parseInt(document.getElementById('cfg-spawn').value);
    else if(key === 'speed') userSettings.enemySpeed = parseFloat(document.getElementById('cfg-speed').value);
    else if(key === 'bomb') userSettings.bombChance = parseInt(document.getElementById('cfg-bomb').value);
    else if(key === 'bspeed') userSettings.bombSpeed = parseFloat(document.getElementById('cfg-bspeed').value);
    else if(key === 'color') {
        userSettings.playerColor = document.getElementById('cfg-color').value;
        player.color = userSettings.playerColor;
    }
    
    applyConfigToUI(); // Actualizar textos
    recalcGameVars();  // Actualizar lógica
    localStorage.setItem(CONFIG_KEY, JSON.stringify(userSettings));
}

function resetConfig() {
    localStorage.removeItem(CONFIG_KEY);
    userSettings = { spawnLevel: 5, enemySpeed: 1.0, bombChance: 30, bombSpeed: 2.0, playerColor: '#4f46e5' };
    loadConfig();
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    if(tabName === 'db') document.querySelector('button[onclick="switchTab(\'db\')"]').classList.add('active');
    else document.querySelector('button[onclick="switchTab(\'settings\')"]').classList.add('active');
}

// --- DATABASE & GAME ---
const STORAGE_KEY = 'mdc_vocab_list';
let wordsDB = { 'ALL_VOCAB': [] };
const currentCategory = 'ALL_VOCAB';

function loadVocabDataFromLocalStorage() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        const items = saved ? JSON.parse(saved) : [];
        let vocabList = [];
        const countWords = (str) => str.trim().split(/\s+/).length;

        items.forEach(item => {
            if (item.isFolder && item.items) {
                item.items.forEach(subItem => {
                    if (subItem.eng && subItem.esp) {
                        if (countWords(subItem.eng) <= 2) vocabList.push({en: subItem.eng.toUpperCase(), es: [subItem.esp]});
                    }
                });
            } else if (!item.isFolder && item.eng && item.esp) {
                if (countWords(item.eng) <= 2) vocabList.push({en: item.eng.toUpperCase(), es: [item.esp]});
            }
        });

        if (vocabList.length === 0) vocabList.push({ en: "NO SHORT WORDS", es: ["NO HAY PALABRAS CORTAS"] });
        wordsDB['ALL_VOCAB'] = vocabList;
    } catch (error) {
        console.error(error);
        wordsDB['ALL_VOCAB'] = [{ en: "ERROR", es: ["ERROR"] }];
    }
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const livesEl = document.getElementById('lives');
const highScoreEl = document.getElementById('highScore');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const categoryBarWrapper = document.getElementById('category-bar-wrapper');
const studyGuide = document.getElementById('study-guide');
const studyTableContainer = document.getElementById('study-table-container');

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let musicInterval;

// --- 2. HACK ANTI-CAPITAL (PRONUNCIACIÓN) ---
function speak(text, lang) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    
    let textToSpeak = text;
    // Si es una sola letra, la pasamos a minúscula para que no diga "Capital A"
    if (text.length === 1 && text.match(/[A-Z]/i)) {
        textToSpeak = text.toLowerCase(); 
    }

    const u = new SpeechSynthesisUtterance(textToSpeak);
    u.lang = lang;
    u.rate = 1.1; 
    window.speechSynthesis.speak(u);
}

function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const n = audioCtx.currentTime;
    if(type==='shoot'){o.type='square';o.frequency.setValueAtTime(400,n);o.frequency.exponentialRampToValueAtTime(100,n+.1);g.gain.setValueAtTime(.05,n);g.gain.linearRampToValueAtTime(0,n+.1);}
    else if(type==='hit_eng'){o.type='sawtooth';o.frequency.setValueAtTime(600,n);o.frequency.linearRampToValueAtTime(800,n+.1);g.gain.setValueAtTime(.05,n);g.gain.linearRampToValueAtTime(0,n+.15);}
    else if(type==='hit_syn'){o.type='sine';o.frequency.setValueAtTime(1200,n);o.frequency.linearRampToValueAtTime(1800,n+.1);g.gain.setValueAtTime(.05,n);g.gain.linearRampToValueAtTime(0,n+.3);}
    else if(type==='player_hit'){o.type='sawtooth';o.frequency.setValueAtTime(120,n);o.frequency.linearRampToValueAtTime(80,n+.3);g.gain.setValueAtTime(.1,n);g.gain.linearRampToValueAtTime(0,n+.5);}
    o.start(n); o.stop(n + 0.5);
}

function startMusic(){let s=0;const m=[220,0,261,0,329,0,261,0];clearInterval(musicInterval);musicInterval=setInterval(()=>{if(m[s]>0){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='triangle';o.frequency.value=m[s]*.5;g.gain.value=.02;g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.15);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+.25);}s=(s+1)%m.length;},200);}

let gameRunning=false,score=0,combo=0,lives=5,highScore=0,lastTime=0;
let spawnTimer=3500;
const player = {x:0,y:0,w:48,h:48,speed:8,color:'#4f46e5',invincible:false,invTimer:0}; 
let bullets=[], enemies=[], particles=[], stars=[], enemyBombs=[], keys={};

function loadHighScore(){const s=localStorage.getItem('synonymHunterHighScore');highScore=s?parseInt(s):0;highScoreEl.innerText=highScore;}

function renderCategoryBar(){
    categoryBarWrapper.innerHTML='';
    const help=document.createElement('div');
    help.className='category-chip help-btn';
    help.textContent='MENU / SETTINGS';
    help.onclick=toggleStudyGuide;
    categoryBarWrapper.appendChild(help);
}

function populateStudyGuide(){
    const w=wordsDB[currentCategory];
    let html='<table><thead><tr><th>ENGLISH</th><th>TRANSLATION</th></tr></thead><tbody>';
    w.forEach(v=>html+=`<tr><td class="en-word">${v.en}</td><td>${v.es[0]||"-"}</td></tr>`);
    html+='</tbody></table>';
    studyTableContainer.innerHTML=html;
}

function toggleStudyGuide(){
    const isOpen = studyGuide.style.display==='flex';
    if(isOpen){
        studyGuide.style.display='none';
        if(startScreen.style.display==='none' && gameOverScreen.style.display==='none'){
            gameRunning=true; lastTime=performance.now(); startMusic(); draw();
        }
    }else{
        gameRunning=false; clearInterval(musicInterval); populateStudyGuide(); studyGuide.style.display='flex';
    }
}

function resize(){
    canvas.width=innerWidth; canvas.height=innerHeight;
    player.y=canvas.height-130; player.x=canvas.width/2-player.w/2;
}
window.addEventListener('resize',resize);

for(let i=0;i<80;i++)stars.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,size:Math.random()*2,speed:Math.random()*0.2+0.1});

function getRandomBombContent() {
    if (Math.random() > 0.5) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        return chars.charAt(Math.floor(Math.random() * chars.length));
    } else {
        return Math.floor(Math.random() * (9999 - 10) + 10).toString();
    }
}

function spawnEnemy(){
    const words=wordsDB[currentCategory]; if(!words||words.length===0)return;
    const d=words[Math.floor(Math.random()*words.length)];
    ctx.font='16px "Press Start 2P"';
    const textWidth=ctx.measureText(d.en).width;
    const vx = (Math.random() - 0.5) * 2.0;
    const baseSpeed = (Math.random()*0.8+0.4) * userSettings.enemySpeed;

    enemies.push({
        x:Math.random()*(canvas.width-textWidth-50)+textWidth/2+25, 
        y:-40, 
        wordData:d, text:d.en, 
        stage:0, hits:0, 
        speed: baseSpeed, 
        vx: vx, 
        color:'#ffffff', 
        timer:0, fading:false, w:textWidth,
        droppedBomb: false // 1. BANDERA: Solo una bomba
    });
}

function createExplosion(x,y,c,n=10){for(let i=0;i<n;i++)particles.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,life:1,color:c});}

function checkCollisionRect(r1, r2) {
    return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
           r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
}

function drawRobot(ctx, x, y, w, h, color) {
    ctx.fillStyle = color; ctx.fillRect(x + 8, y + 15, w - 16, h - 20);
    ctx.fillStyle = '#ccc'; ctx.fillRect(x + 4, y, w - 8, 20);
    ctx.fillStyle = gameRunning ? '#0f0' : '#f00';
    ctx.fillRect(x + 10, y + 5, 8, 8); ctx.fillRect(x + w - 18, y + 5, 8, 8);
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(x + w/2, y); ctx.lineTo(x + w/2, y - 10); ctx.stroke();
    ctx.fillStyle = (Math.floor(Date.now()/200)%2===0) ? 'red' : '#500';
    ctx.beginPath(); ctx.arc(x + w/2, y - 10, 3, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#555'; ctx.fillRect(x + 4, y + h - 5, 10, 5); ctx.fillRect(x + w - 14, y + h - 5, 10, 5);
}

function update(dt){
    if(!gameRunning)return;
    if(player.invincible){player.invTimer-=dt;if(player.invTimer<=0)player.invincible=false;}
    if(keys['ArrowLeft']&&player.x>0)player.x-=player.speed;
    if(keys['ArrowRight']&&player.x<canvas.width-player.w)player.x+=player.speed;
    stars.forEach(s=>{s.y+=s.speed;if(s.y>canvas.height)s.y=0;});
    
    spawnTimer-=dt; if(spawnTimer<0){spawnEnemy();spawnTimer=gameVars.spawnInterval;}
    
    for(let i=enemyBombs.length-1; i>=0; i--){
        let b = enemyBombs[i];
        b.y += b.vy;
        b.x += Math.sin(b.y * 0.05) * 1.5; 
        
        if(!player.invincible && checkCollisionRect(player, b)){
             lives--; livesEl.innerText=lives;
             createExplosion(player.x+player.w/2, player.y+player.h/2, '#ff4444', 30);
             playSound('player_hit');
             player.invincible=true; player.invTimer=2000;
             enemyBombs.splice(i,1);
             if(lives<=0){gameOver();return;}
             continue;
        }

        for(let j=bullets.length-1; j>=0; j--){
            let bullet = bullets[j];
            if(bullet.x > b.x-20 && bullet.x < b.x+b.w+20 && bullet.y > b.y && bullet.y < b.y+b.h){
                bullets.splice(j,1);
                createExplosion(b.x, b.y, b.color, 15);
                playSound('hit_eng');
                speak(b.text, 'en-US');
                score += 25; scoreEl.innerText = score;
                enemyBombs.splice(i,1);
                break;
            }
        }
        if(b.y > canvas.height) enemyBombs.splice(i,1);
    }

    for(let i=bullets.length-1;i>=0;i--){bullets[i].y-=12;if(bullets[i].y<0)bullets.splice(i,1);}
    
    for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        
        // 1. BOMBA ÚNICA: Check droppedBomb && Chance
        if(!e.fading && !e.droppedBomb && e.stage < 2 && Math.random() < gameVars.bombProb) {
            e.droppedBomb = true; // MARCAR COMO USADA
            enemyBombs.push({
                x: e.x, 
                y: e.y + 40, // 1. SEPARACIÓN: Nace más abajo
                text: getRandomBombContent(),
                color: `hsl(${Math.random()*360}, 100%, 70%)`,
                vy: e.speed + userSettings.bombSpeed, // 1. VELOCIDAD: Cae más rápido que la palabra
                w: 20, h: 30
            });
        }

        if(e.fading){createExplosion(e.x,e.y,e.color,1);enemies.splice(i,1);continue;}
        
        e.y += e.speed;
        e.x += e.vx; 

        if (e.x < e.w/2 + 10 || e.x > canvas.width - e.w/2 - 10) {
            e.vx *= -1; 
            if(e.x < e.w/2 + 10) e.x = e.w/2 + 11;
            if(e.x > canvas.width - e.w/2 - 10) e.x = canvas.width - e.w/2 - 11;
        }

        const eRect = {x: e.x-e.w/2, y: e.y-15, w: e.w, h:30};
        if(!player.invincible && checkCollisionRect(player, eRect)){
            lives--;livesEl.innerText=lives;createExplosion(player.x+player.w/2,player.y+player.h/2,'#ff4444',30);playSound('player_hit');
            player.invincible=true;player.invTimer=2000;enemies.splice(i,1);combo=0;comboEl.innerText=combo;
            if(lives<=0){gameOver();return;}
            continue;
        }
        
        if(e.stage===1){e.timer+=dt;if(e.timer>4000)e.fading=true;}
        
        for(let j=bullets.length-1;j>=0;j--){
            const b=bullets[j];
            if(b.x>e.x-e.w/2-10 && b.x<e.x+e.w/2+10 && b.y>e.y-20 && b.y<e.y+10){
                bullets.splice(j,1); e.timer=0;
                
                if(e.stage===0){
                    e.hits++; 
                    if(e.hits === 1) speak(e.text, 'en-US');
                    playSound('hit_eng');score+=10;
                    if(e.hits >= 3) {
                        e.stage = 1; e.text = e.wordData.es[0]; e.color='#00ff00';
                        createExplosion(e.x,e.y,'#00ff00',20);
                        score+=50; combo++;
                        ctx.font='20px "Press Start 2P"';
                        e.w = ctx.measureText(e.text).width;
                    }
                }
                else if(e.stage===1){
                    e.fading=true;
                    createExplosion(e.x,e.y,'#ffffff',40);
                    playSound('hit_syn'); score+=150; combo++;
                    speak(e.text, 'es-ES');
                }
                scoreEl.innerText=score;comboEl.innerText=combo;
                break;
            }
        }
        if(e.y>canvas.height){if(e.stage<1)combo=0;comboEl.innerText=combo;enemies.splice(i,1);}
    }
    for(let i=particles.length-1;i>=0;i--){const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=.04; if(p.life<=0)particles.splice(i,1);}
}

function draw(){
    if(!gameRunning)return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    stars.forEach(s=>{ctx.fillStyle=`rgba(255,255,255,${Math.random()*0.5+0.3})`;ctx.beginPath();ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fill();});
    
    if(!player.invincible||(Math.floor(player.invTimer/100)%2===0)){
        drawRobot(ctx, player.x, player.y, player.w, player.h, player.color);
    }

    ctx.textAlign='center'; ctx.textBaseline='middle';
    enemyBombs.forEach(b => {
        ctx.strokeStyle='#fff'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(b.x-10, b.y-15); ctx.lineTo(b.x-4, b.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(b.x+10, b.y-15); ctx.lineTo(b.x+4, b.y); ctx.stroke();
        ctx.fillStyle=b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y-15, 12, Math.PI, 0); ctx.fill();
        ctx.font='12px "Press Start 2P"'; ctx.fillStyle='#fff';
        ctx.fillText(b.text, b.x, b.y+10);
    });

    ctx.fillStyle='#ff0055';ctx.shadowBlur=5;ctx.shadowColor='#ff0055';
    bullets.forEach(b=>ctx.fillRect(b.x-2,b.y,4,15));ctx.shadowBlur=0;
    
    enemies.forEach(e=>{
        ctx.font=e.stage>=1?'20px "Press Start 2P"':'16px "Press Start 2P"';
        ctx.fillStyle=e.color;
        if(e.stage>=1){ctx.shadowBlur=10;ctx.shadowColor='#00ff00';}
        ctx.fillText(e.text,e.x,e.y);ctx.shadowBlur=0;
        
        for(let k=0;k<4;k++){
            if(k<3) ctx.fillStyle = (e.stage===0 && k<e.hits) || e.stage>0 ? '#00ff00' : '#444';
            else ctx.fillStyle = '#444';
            ctx.beginPath();ctx.arc(e.x-22+(k*15),e.y+25,3,0,Math.PI*2);ctx.fill();
        }
    });
    particles.forEach(p=>{ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,3,3);});ctx.globalAlpha=1;
    requestAnimationFrame(()=>{const now=performance.now();update(now-lastTime);lastTime=now;draw();});
}

function gameOver(){
    gameRunning=false;clearInterval(musicInterval);
    if(score>highScore){highScore=score;localStorage.setItem('synonymHunterHighScore',highScore);highScoreEl.innerText=highScore;}
    document.getElementById('finalScore').innerText=score;
    gameOverScreen.style.display='flex';
}

function startGame(){
    if(gameRunning)return;
    resize();
    startScreen.style.display='none';gameOverScreen.style.display='none';studyGuide.style.display='none';
    score=combo=0;lives=5;enemies=[];bullets=[];particles=[];enemyBombs=[];player.invincible=false;
    scoreEl.innerText=comboEl.innerText='0';livesEl.innerText='5';
    renderCategoryBar();loadHighScore();
    gameRunning=true;lastTime=performance.now();
    if(audioCtx.state==='suspended')audioCtx.resume();
    startMusic();draw();
}

document.addEventListener('keydown', e=>{
    if((e.code==='Tab'||e.code==='Escape') && startScreen.style.display==='none' && gameOverScreen.style.display==='none'){e.preventDefault(); toggleStudyGuide();}
    keys[e.code]=true;
    if(e.code==='Space' && gameRunning){
        e.preventDefault();
        bullets.push({x:player.x+player.w/2,y:player.y});
        playSound('shoot');
    }
});
document.addEventListener('keyup', e=>keys[e.code]=false);

window.onload=()=>{
    loadConfig(); 
    loadVocabDataFromLocalStorage();
    resize();
    renderCategoryBar();
};
</script>
</body>
</html>
