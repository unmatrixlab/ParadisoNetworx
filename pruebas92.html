<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Polyglot Tutor V32</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Dancing+Script:wght@700&family=Playfair+Display:wght@600&family=Courier+Prime:wght@700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
<style>
        :root {
            --primary: #007AFF;
            --bg-body: #F2F2F7;
            --text-main: #111111;
            --card-bg: #FFFFFF;
            --radius: 16px;
            --header-height: 60px;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            padding-top: var(--header-height);
            padding-bottom: 60px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* HEADER */
        #mdc-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: rgba(10, 20, 35, 0.95); backdrop-filter: blur(16px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #mdc-header a { text-decoration: none; font-weight: 900; font-size: 22px; letter-spacing: 1px; color: white; }

        /* CONTROL BAR */
        .control-bar {
            width: 95%; max-width: 1200px; margin: 20px auto 15px auto;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border: 1px solid #d1d1d6; border-radius: 16px; padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap; z-index: 900;
        }
        .control-left { display: flex; align-items: center; gap: 12px; flex-grow: 1; }
        .compact-search { position: relative; width: 100%; max-width: 400px; }
        .compact-search input { width: 100%; padding: 10px 12px 10px 36px; border-radius: 10px; border: 1px solid #ccc; background: #fff; outline: none; }
        .compact-search .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.6; }
        .control-right { display: flex; align-items: center; gap: 10px; }

        .btn-new-session { background: #000; color: white; padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: flex; gap: 8px; }
        .btn-new-session:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .data-dropdown-container { position: relative; }
        .btn-data-mini { width: 42px; height: 42px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        .data-menu-popup { display: none; position: absolute; top: 55px; right: 0; width: 240px; background: white; border: 1px solid #d1d1d6; border-radius: 14px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); padding: 8px; z-index: 2000; }
        .data-menu-popup.active { display: block; }
        .data-menu-item { display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px; border: none; background: transparent; text-align: left; font-weight: 600; cursor: pointer; }
        .data-menu-item:hover { background: #f2f2f7; }
        .data-menu-item.danger { color: #cc0000; }
        .data-divider { height: 1px; background: #e0e0e0; margin: 6px 0; }

        /* GRID */
        .section-header { width: 95%; max-width: 1200px; margin: 20px auto 15px auto; font-weight: 900; font-size: 1.1rem; color: #444; text-transform: uppercase; border-bottom: 2px solid #e5e5ea; padding-bottom: 5px; }
        .grid-container { width: 95%; max-width: 1200px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding-bottom: 60px; margin: 0 auto; }
        .resource-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 260px; border: 1px solid #e5e5ea; }
        .media-area { position: relative; width: 100%; height: 150px; background: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow:hidden;}
        .media-area img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .play-icon { position: absolute; width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .play-icon svg { width: 20px; height: 20px; }
        .media-area.audio { background: linear-gradient(135deg, #FF9500, #FF3B30); }
        .audio-icon { font-size: 3rem; color: white; }
        .media-area.web { background: #f0f0f5; flex-direction: column; align-items: flex-start; justify-content: flex-end; padding: 15px; }
        .web-domain-tag { background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; margin-bottom: auto; }
        .web-favicon-box { width: 40px; height: 40px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .web-favicon-box img { width: 24px; height: 24px; }
        .web-domain-text { font-weight: 800; color: #333; }
        .card-info { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-actions { display: flex; gap: 8px; margin-top: auto; }
        .btn-action { flex: 1; background: #f9f9fb; border: 1px solid #e5e5ea; cursor: pointer; padding: 8px 0; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .btn-action:hover { transform: translateY(-2px); }

        /* EDITOR */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .editor-popup { background: white; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 900px) { .editor-popup { width: 96%; max-width: 1600px; height: 90vh; flex-direction: row; border-radius: 20px; } .editor-popup.is-fullscreen { width: 100vw !important; height: 100vh !important; border-radius: 0 !important; } }
        .desktop-media-container { display: none; background: #111; position: relative; }
        @media (min-width: 900px) { .desktop-media-container { display: flex; width: 45%; } .editor-content-panel { flex: 1; } }
        .editor-content-panel { display: flex; flex-direction: column; height: 100%; background: white; width: 100%;}
        .resizer-gutter { display: none; width: 12px; background: #f2f2f7; cursor: col-resize; border-left: 1px solid #d1d1d6; border-right: 1px solid #d1d1d6; }
        @media (min-width: 900px) { .resizer-gutter { display: block; } }
        
        .editor-header { padding: 12px 20px; border-bottom: 1px solid #e5e5ea; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .editor-title { font-weight: 800; font-size: 1.1rem; }
        .btn-header-icon { background: #f2f2f7; border: 1px solid #e5e5ea; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #btn-fullscreen { display: none; }
        @media (min-width: 900px) { #btn-fullscreen { display: flex; } }

        /* Toolbar */
        .editor-toolbar { padding: 10px 20px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; gap: 15px; overflow-x: auto; }
        .delicate-group { display: flex; align-items: center; gap: 8px; background: #f7f7f9; border: 1px solid #e5e5ea; border-radius: 20px; padding: 4px 10px; }
        .delicate-sep { width: 1px; height: 18px; background: #d1d1d6; margin: 0 4px; }
        .color-circle { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-circle.active { border-color: #000; transform: scale(1.2); }
        .font-btn { border: none; background: none; font-weight: 600; color: #888; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
        .font-btn.active { background: white; color: #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .style-icon { border: none; background: none; font-weight: 700; color: #666; cursor: pointer; width: 24px; }
        .style-icon.active { color: #000; }
        
        .btn-ai-trigger { background: linear-gradient(135deg, #e3f2fd, #90caf9); color: #007AFF; width: 36px; height: 36px; border-radius: 10px; border: 1px solid #bbdefb; cursor: pointer; font-weight: 700; }
        .btn-save-template { background: #fff8e1; color: #b45309; padding: 6px 12px; border-radius: 8px; border: 1px solid #fcd34d; font-weight: 700; cursor: pointer; }
        .ctrl-target-group { display: flex; background: #f2f2f7; border-radius: 8px; padding: 4px; gap: 4px; }
        .btn-target { width: 28px; height: 28px; border: none; border-radius: 6px; font-weight: 800; color: #999; cursor: pointer; }
        .btn-target.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-lock { border: none; background: transparent; cursor: pointer; opacity: 0.4; }
        .btn-lock.locked { opacity: 1; }
        .media-controls { display: flex; gap: 10px; }
        .btn-media { padding: 0 16px; height: 40px; background: #f2f2f7; border: 1px solid #e5e5ea; border-radius: 10px; cursor: pointer; font-weight: 700; }
        .btn-media:hover { background: #e5e5ea; }
        .btn-clear { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e5ea; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        
        .editor-area { flex: 1; padding: 40px; overflow-y: auto; outline: none; font-size: 18px; line-height: 1.7; }
        .editor-footer { padding: 12px 20px; border-top: 1px solid #e5e5ea; text-align: right; background: #f9f9fb; font-size: 0.8rem; color: #888; }

        /* TABS */
        .media-iframe-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; background: #e5e5ea; }
        .web-tab-nav { display: flex; background: #f2f2f7; border-bottom: 1px solid #d1d1d6; height: 44px; }
        .web-tab-btn { flex: 1; border: none; background: #f2f2f7; font-weight: 700; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .web-tab-btn.active { color: #000; background: #fff; }
        .web-content-area { flex: 1; position: relative; background: #fff; }
        .web-frame-container { width: 100%; height: 100%; display: none; }
        .web-frame-container.active { display: block; }
        .web-frame-container iframe { width: 100%; height: 100%; border: none; }

        /* ====== AI HUB (CORREGIDO) ====== */
        .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .ai-popup-overlay.active { display: flex; }
        .ai-popup-box { background: #fff; width: 95%; max-width: 800px; border-radius: 24px; box-shadow: 0 40px 100px rgba(0,0,0,0.25); display: flex; flex-direction: column; max-height: 92vh; overflow: hidden; }
        .ai-header { padding: 18px 24px; border-bottom: 1px solid #e5e5ea; display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 1.2rem; }
        .ai-close { border: none; background: #f2f2f7; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        .ai-body { padding: 24px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 20px; }

        /* NUEVOS BOTONES ACORDEON (REEMPLAZO DE DETAILS) */
        .accordion-toggle {
            width: 100%;
            background: #111; /* Negro para alto contraste */
            color: #fff;
            padding: 15px;
            border-radius: 12px;
            font-weight: 800;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
            border: 2px solid #000;
        }
        .accordion-toggle:hover { opacity: 0.9; }
        .accordion-toggle span:last-child { font-size: 1.5rem; font-weight: 300; }
        
        .accordion-panel {
            display: none; /* Oculto por defecto */
            background: #fff;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
        .accordion-panel.open { display: block; }

        /* Resto de estilos AI */
        .ai-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .ai-card-group { background: #F9F9FB; border: 1px solid #e5e5ea; border-radius: 16px; padding: 4px; display: flex; flex-direction: column; }
        .ai-card-label { padding: 8px 12px; font-size: 0.75rem; font-weight: 800; color: #888; text-transform: uppercase; }
        .ai-select { width: 100%; padding: 8px 12px; border: none; background: transparent; font-weight: 600; outline: none; }
        .ai-custom-input { width: 100%; padding: 10px 12px; border: none; border-top: 1px solid #e5e5ea; background: #fff; outline: none; border-radius: 0 0 12px 12px; }
        .level-btn { flex: 1; padding: 8px; border: none; background: transparent; font-weight: 700; color: #666; cursor: pointer; }
        .level-btn.selected { background: #fff; color: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .segmented-control { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; }
        
        .flag-group { display: flex; gap: 12px; }
        .flag-btn { font-size: 1.5rem; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; border: 2px solid transparent; opacity: 0.5; filter: grayscale(100%); }
        .flag-btn.selected { opacity: 1; filter: grayscale(0%); background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .flag-btn.hidden { display: none; }

        .ai-footer-actions { display: flex; gap: 15px; margin-top: 10px; }
        .btn-ai-action { flex: 1; padding: 16px; border: none; border-radius: 14px; font-weight: 800; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-ai-primary { background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%); color: #333; }
        #btn-paste-json { background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%); color: #333; }

        .ai-preview-box { border: 2px solid #34C759; border-radius: 16px; margin: 20px 0; overflow: hidden; }
        
        .voice-inner { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .voice-item-label { font-weight: 800; font-size: 0.75rem; color: #666; margin-bottom: 5px; display: block; }
        .voice-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }

        /* Memory */
        .saved-exercises-list { max-height: 200px; overflow-y: auto; border: 1px solid #e5e5ea; border-radius: 12px; margin-bottom: 10px; }
        .saved-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; }
        .saved-info { flex: 1; }
        .saved-name { font-weight: 700; font-size: 0.9rem; }
        .saved-date { font-size: 0.7rem; color: #888; }
        .mem-actions { display: flex; gap: 6px; }
        .btn-insert { background: #34C759; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
        .btn-icon-action { width: 30px; height: 30px; border: none; background: #f2f2f7; border-radius: 6px; cursor: pointer; }
        .mem-controls { display: flex; gap: 10px; }
        .btn-mem-ctrl { flex: 1; padding: 10px; background: #f2f2f7; border: 1px solid #ddd; border-radius: 8px; font-weight: 700; cursor: pointer; }

        /* Exercise Render */
        .exercise-box { background: #fff; border: 1px solid #e5e5ea; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .exercise-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #f2f2f7; padding-bottom: 10px; font-weight: 700; color: var(--primary); }
        .exercise-row { margin-bottom: 15px; }
        .theory-box, .hint-box, .trans-box { display: none; padding: 10px; border-radius: 8px; margin-top: 8px; font-size: 0.9rem; }
        .theory-box { background: #f9f9fb; display: block; margin-bottom: 15px;}
        .hint-box { background: #fffbe6; border-left: 4px solid #FF9500; }
        .trans-box { background: #f0f9ff; border-left: 4px solid #007AFF; }
        .ex-select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: white; margin: 0 5px; }
        .ex-select.correct { background: #e8f5e9; border-color: #34C759; color: #1b5e20; }
        .ex-select.wrong { background: #ffebee; border-color: #FF3B30; color: #b71c1c; }
        
        /* Popup Tabs */
        .tab-settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 5000; }
        .tab-settings-modal.active { display: flex; }
        .tab-popup-content { background: white; padding: 20px; border-radius: 16px; width: 600px; max-width: 90%; }
        .tab-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-input-group input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        .tab-btn-action { padding: 0 15px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
        .fav-list { list-style: none; max-height: 300px; overflow-y: auto; }
        .fav-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .fav-item:hover { background: #f9f9f9; }
        .fav-icon { width: 20px; height: 20px; }
    </style>
</head>
<body>

    <div id="mdc-header"><a href="#">MDC ENG</a></div>

    <div class="control-bar">
        <div class="control-left">
            <div class="compact-search"><span class="icon">üîç</span><input type="text" id="searchInput" placeholder="Search..." oninput="applySearch()"></div>
        </div>
        <div class="control-right">
            <button class="btn-new-session" onclick="openFreeEditor()"><span>+ Whiteboard</span></button>
            <div class="data-dropdown-container">
                <button class="btn-data-mini" onclick="document.getElementById('data-popup').classList.toggle('active')">‚öôÔ∏è</button>
                <div id="data-popup" class="data-menu-popup">
                    <button class="data-menu-item" onclick="downloadBackup()">‚¨áÔ∏è Backup</button>
                    <input type="file" id="importFile" hidden onchange="importBackup(this)">
                    <button class="data-menu-item" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import</button>
                    <div class="data-divider"></div>
                    <button class="data-menu-item danger" onclick="clearResources('all')">üóëÔ∏è Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <div class="section-header"><span>üìö Library</span></div>
    <div class="grid-container" id="video-grid"></div>

    <div class="modal-overlay" id="editor-modal">
        <div class="editor-popup" id="editor-popup">
            <div class="desktop-media-container" id="desktop-media-wrapper"></div>
            <div class="resizer-gutter" id="drag-resizer"></div>
            <div class="editor-content-panel" id="editor-panel">
                <div class="editor-header">
                    <span class="editor-title">Note Editor</span>
                    <div class="header-actions">
                        <button class="btn-header-icon" id="btn-fullscreen" onclick="toggleEditorFullScreen()">‚õ∂</button>
                        <button class="btn-header-icon" onclick="closeEditor()">√ó</button>
                    </div>
                </div>
                <div class="editor-toolbar">
                    <div class="delicate-group">
                        <div class="color-circle" style="background:#111" onclick="applyColor('#1d1d1f')"></div>
                        <div class="color-circle" style="background:#FF3B30" onclick="applyColor('#FF3B30')"></div>
                        <div class="color-circle" style="background:#007AFF" onclick="applyColor('#007AFF')"></div>
                        <div class="color-circle" style="background:#34C759" onclick="applyColor('#34C759')"></div>
                        <div class="delicate-sep"></div>
                        <button class="style-icon" id="btn-bold" onclick="toggleBold()">B</button>
                        <button class="style-icon" onclick="setSize(5)">T+</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn-ai-trigger" onclick="openAIMenu()">‚ö°</button>
                        <button class="btn-save-template" onclick="saveEditorAsTemplate()">üíæ</button>
                    </div>
                    <div class="toolbar-group">
                        <div class="ctrl-target-group">
                            <button class="btn-lock locked" id="btn-sync-lock" onclick="toggleSyncLock()">üîí</button>
                            <button class="btn-target channel-1 active" onclick="setControlTarget(0)">1</button>
                            <button class="btn-target channel-2" onclick="setControlTarget(1)">2</button>
                            <button class="btn-target channel-3" onclick="setControlTarget(2)">3</button>
                            <button class="btn-target channel-4" onclick="setControlTarget(3)">4</button>
                            <button class="btn-target channel-5" onclick="setControlTarget(4)">5</button>
                        </div>
                        <button class="btn-media" id="btn-main-play" onclick="togglePlay()">‚èØÔ∏è</button>
                    </div>
                    <button class="btn-clear" onclick="document.getElementById('editor-text').innerHTML='';">üóëÔ∏è</button>
                </div>
                <div id="editor-text" class="editor-area" contenteditable="true" oninput="saveNote()"></div>
                <div class="editor-footer"><span class="save-indicator">‚úì Saved</span></div>
            </div>
        </div>
    </div>

    <div class="ai-popup-overlay" id="ai-hub-modal">
        <div class="ai-popup-box">
            <div class="ai-header">
                <span>‚ö° Polyglot AI Hub</span>
                <button class="ai-close" onclick="closeAIMenu()">√ó</button>
            </div>
            
            <div class="ai-body">
                
                <div class="accordion-toggle" onclick="toggleAccordion('help-panel')">
                    <span>‚ÑπÔ∏è How to create exercises</span>
                    <span>+</span>
                </div>
                <div id="help-panel" class="accordion-panel">
                    1. Select Context, Grammar, and Type.<br>
                    2. Or type in "Custom" fields (overrides selection).<br>
                    3. Click <b>Create Mission</b> to copy prompt.<br>
                    4. Paste into AI, copy JSON, click <b>Import</b>.
                </div>

                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üåç Context</div>
                        <select id="ai-context-select" class="ai-select">
                            <option value="" disabled selected>Select...</option>
                            <option value="Daily Routine">Daily Routine</option>
                            <option value="Travel">Travel & Airport</option>
                            <option value="Business">Business & Work</option>
                            <option value="Academic">Academic</option>
                        </select>
                        <input type="text" id="ai-context-custom" class="ai-custom-input" placeholder="Custom context...">
                    </div>
                    <div class="ai-card-group">
                        <div class="ai-card-label">üß† Grammar</div>
                        <select id="ai-grammar-select" class="ai-select">
                            <option value="" disabled selected>Select...</option>
                            <option value="Present Simple">Present Simple</option>
                            <option value="Past Simple">Past Simple</option>
                            <option value="Present Perfect">Present Perfect</option>
                            <option value="Future Forms">Future Forms</option>
                            <option value="Conditionals">Conditionals</option>
                        </select>
                        <input type="text" id="ai-grammar-custom" class="ai-custom-input" placeholder="Custom grammar...">
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üìù Format</div>
                        <select id="ai-type-select" class="ai-select">
                            <option value="Fill in the Blanks (Cloze)" selected>Fill in the Blanks</option>
                            <option value="Multiple Choice Quiz">Multiple Choice</option>
                            <option value="Find and Fix the Mistake">Find and Fix</option>
                            <option value="True or False">True or False</option>
                        </select>
                        <input type="text" id="ai-type-custom" class="ai-custom-input" placeholder="Custom format...">
                    </div>
                    <div class="ai-card-group">
                        <div class="ai-card-label">QTY & Level</div>
                        <div style="display:flex; gap:10px; padding:0 10px 10px;">
                            <input type="number" id="ai-sentence-count" value="5" min="1" style="width:50px; padding:5px;">
                            <div class="segmented-control" id="level-group" style="flex:1">
                                <button class="level-btn" onclick="selectLevel(this, 'A1')">A1</button>
                                <button class="level-btn selected" onclick="selectLevel(this, 'B1')">B1</button>
                                <button class="level-btn" onclick="selectLevel(this, 'C1')">C1</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div>
                        <div class="ai-card-label">Target</div>
                        <div class="flag-group" id="target-lang-group">
                            <div class="flag-btn selected" onclick="selectTarget(this, 'en')">üá∫üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'es')">üá™üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'pt')">üáßüá∑</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'it')">üáÆüáπ</div>
                        </div>
                    </div>
                    <div>
                        <div class="ai-card-label">Translate To</div>
                        <div class="flag-group" id="trans-lang-group">
                            <div class="flag-btn hidden" data-lang="en">üá∫üá∏</div>
                            <div class="flag-btn selected" data-lang="es" onclick="toggleTrans(this, 'es')">üá™üá∏</div>
                            <div class="flag-btn" data-lang="pt" onclick="toggleTrans(this, 'pt')">üáßüá∑</div>
                            <div class="flag-btn" data-lang="it" onclick="toggleTrans(this, 'it')">üáÆüáπ</div>
                        </div>
                    </div>
                </div>

                <div class="ai-card-label">Extra Instructions</div>
                <textarea id="ai-extra-data" class="ai-custom-input" placeholder="E.g. British English, Medical terms..."></textarea>

                <div class="ai-footer-actions">
                    <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">‚ú® CREATE MISSION</button>
                    <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">‚ú® PASTE MISSION</button>
                </div>

                <div id="ai-latest-preview"></div>

                <div class="accordion-toggle" onclick="toggleAccordion('voice-panel')">
                    <span>üîä Voice Settings</span>
                    <span>+</span>
                </div>
                <div id="voice-panel" class="accordion-panel"> <div class="voice-inner">
                        <div><label class="voice-item-label">üá∫üá∏ English</label><select id="voice-en" class="voice-select"></select></div>
                        <div><label class="voice-item-label">üá™üá∏ Spanish</label><select id="voice-es" class="voice-select"></select></div>
                        <div><label class="voice-item-label">üáßüá∑ Portuguese</label><select id="voice-pt" class="voice-select"></select></div>
                        <div><label class="voice-item-label">üáÆüáπ Italian</label><select id="voice-it" class="voice-select"></select></div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="ai-card-label">üéì Memory Bank</div>
                    <div class="saved-exercises-list" id="ai-memory-list"></div>
                    <div class="mem-controls">
                        <button class="btn-mem-ctrl" onclick="exportMemoryBank()">Export</button>
                        <input type="file" id="importMemFile" hidden onchange="importMemoryBank(this)">
                        <button class="btn-mem-ctrl" onclick="document.getElementById('importMemFile').click()">Import</button>
                        <button class="btn-mem-ctrl" style="color:red" onclick="clearAIMemory()">Clear</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="tab-settings-modal" class="tab-settings-modal" onclick="if(event.target===this) closeTabPopup()">
        <div class="tab-popup-content">
            <div class="tab-popup-header"><span>Tab Settings</span><span class="tab-popup-close" onclick="closeTabPopup()">‚úï</span></div>
            <div class="tab-input-group">
                <input type="text" id="tab-url-input" placeholder="URL...">
                <button class="tab-btn-action" onclick="pasteToTabInput()">üìã</button>
                <button class="tab-btn-action" onclick="applyTabUrlFromInput()">Go</button>
            </div>
            <div class="fav-list-title">Favorites</div>
            <ul class="fav-list" id="tab-fav-list"></ul>
        </div>
    </div>

        <script>
    /* ====== CONFIG & STATE ====== */
    const STORAGE_KEY = 'mdc_saved_favorites';
    const AI_MEM_KEY = 'mdc_ai_exercises';
    const FAV_KEY = 'mdc_tab_favs'; 
    
    // Data Guardian Keys
    const MIRROR_RES_KEY = 'mdc_mirror_res_bak';
    const MIRROR_AI_KEY = 'mdc_mirror_ai_bak';

    let currentTargetLang = 'en'; 
    let currentLevel = 'B1-B2 (Intermediate)';
    const transLangs = new Set(['es']); 
    const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian' };
    
    const grid = document.getElementById('video-grid');
    let gridPlayer = null; 
    let players = [null, null, null, null, null]; 
    let controlTarget = 0; 

    let currentEditIndex = -1; 
    let trackingInterval = null; 
    let currentResourceId = null; 
    let voices = [];
    let selectedResourceType = 'auto'; 
    let currentFilter = 'all'; 
    let searchQuery = '';

    const modal = document.getElementById('editor-modal');
    const editorArea = document.getElementById('editor-text');
    const aiModal = document.getElementById('ai-hub-modal');

    // Variables para el sistema de pesta√±as y Sincronizaci√≥n
    let activeTabIndexForPopup = 0;
    let isSyncLocked = true; // Por defecto el candado est√° cerrado (Activo)

    /* ====== INITIALIZATION ====== */
    document.addEventListener('DOMContentLoaded', () => {
        loadResources(); 
        renderAiList(); 
        updateTransFlagsVisibility(); 
        initVoices(); 
        initResizer(); 
        initDataGuardian(); // Seguridad V2
    });

    // Cierra el men√∫ de datos si clicamos fuera
    document.addEventListener('click', function(e) {
        const popup = document.getElementById('data-popup');
        const btn = document.querySelector('.btn-data-mini');
        if (popup && popup.classList.contains('active') && !popup.contains(e.target) && !btn.contains(e.target)) {
            popup.classList.remove('active');
        }
    });

    /* ====== SYNC LOCK SYSTEM ====== */
    function toggleSyncLock() {
        isSyncLocked = !isSyncLocked;
        const btn = document.getElementById('btn-sync-lock');
        if(isSyncLocked) {
            btn.innerText = "üîí";
            btn.classList.add('locked');
            // Al bloquear, sincronizamos inmediatamente el control a la pesta√±a que estamos viendo
            setControlTarget(activeTabIndexForPopup, true); 
        } else {
            btn.innerText = "üîì";
            btn.classList.remove('locked');
        }
    }

    /* ====== TAB SETTINGS POPUP LOGIC ====== */
    
    window.editTabUrl = function(index, event) {
        event.stopPropagation();
        if(currentEditIndex === -1) {
            if(confirm("To configure tabs, you must save the whiteboard first. Save now?")) { 
                saveFreeModeWork("Study Session Project"); 
            } else { 
                return; 
            }
        }
        activeTabIndexForPopup = index;
        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const r = resources[currentEditIndex];
        
        let key = index === 0 ? 'url' : `url${index + 1}`;
        // Para pesta√±as 2-5, si est√° vac√≠o intentamos no mostrar 'undefined'
        const currentUrl = r[key] || '';
        
        document.getElementById('tab-url-input').value = currentUrl;
        renderTabFavorites();
        document.getElementById('tab-settings-modal').classList.add('active');
    }

    function closeTabPopup() { document.getElementById('tab-settings-modal').classList.remove('active'); }

    /* NUEVAS FUNCIONES PARA EL POPUP (LIMPIAR / COPIAR) */
    function clearTabUrl() {
        document.getElementById('tab-url-input').value = '';
        document.getElementById('tab-url-input').focus();
    }

    function copyTabUrlFromInput() {
        const val = document.getElementById('tab-url-input').value;
        if(val) {
            navigator.clipboard.writeText(val);
            // Efecto visual r√°pido en el bot√≥n
            const btn = document.querySelector('.tab-btn-extra[onclick="copyTabUrlFromInput()"]');
            const original = btn.innerText;
            btn.innerText = "‚úì";
            setTimeout(() => btn.innerText = original, 1000);
        }
    }

    async function pasteToTabInput() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('tab-url-input').value = text;
        } catch (err) {
            alert('Failed to paste: ' + err);
        }
    }

    function applyTabUrlFromInput() {
        const val = document.getElementById('tab-url-input').value.trim();
        // Permitimos guardar vac√≠o para limpiar la pesta√±a
        
        const favs = getTabFavorites(); 
        const exists = favs.some(f => f.url === val);
        
        // Auto-save a favoritos si es una URL compleja y no existe
        if (val && !exists && val !== 'internal:editor' && val.includes('.')) { 
            if(confirm("Add this site to your Favorites list?")) { 
                const defaultName = getDomain(val).charAt(0).toUpperCase() + getDomain(val).slice(1);
                const customName = prompt("Enter a name for this favorite:", defaultName);
                if(customName) {
                    addTabFavorite(val, customName); 
                }
            } 
        }
        selectTabUrl(val);
    }

    function selectTabUrl(newUrl) {
        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY)); 
        const r = resources[currentEditIndex]; 
        const idx = activeTabIndexForPopup;
        
        let key = idx === 0 ? 'url' : `url${idx + 1}`; 
        r[key] = newUrl;
        
        // Detect type change only for main tab (0) to update card icon
        if (idx === 0) { 
            const ytId = getYouTubeID(newUrl); 
            if (ytId) r.type = 'video'; 
            else if (newUrl.match(/\.(mp3|wav|ogg)$/i)) r.type = 'audio'; 
            else r.type = 'web'; 
        }
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); 
        closeTabPopup(); 
        openEditorById(r.id); 
        setTimeout(() => switchWebTab(idx), 300);
    }

 /* ====== FAVORITES LOGIC ====== */
    function getTabFavorites() {
        const defaults = [
            { title: "Google Translate", url: "https://translate.google.com", icon: "https://www.google.com/s2/favicons?domain=translate.google.com" },
            { title: "WordReference", url: "https://www.wordreference.com", icon: "https://www.google.com/s2/favicons?domain=wordreference.com" },
            { title: "ChatGPT", url: "https://chatgpt.com", icon: "https://www.google.com/s2/favicons?domain=openai.com" }
        ];
        const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
        return [...defaults, ...saved];
    }

    function renderTabFavorites() {
        const list = document.getElementById('tab-fav-list'); list.innerHTML = '';
        const favs = getTabFavorites();
        favs.forEach((fav, idx) => {
            const isDefault = idx < 3; 
            const deleteBtn = isDefault ? '' : `<div class="btn-fav-mini btn-fav-del" onclick="deleteTabFavorite(${idx - 3}, event)" title="Delete">‚úï</div>`;
            const actionBtns = `
                <div class="fav-actions">
                    <div class="btn-fav-mini" onclick="copyTabFavorite('${fav.url}', event)" title="Copy">üîó</div>
                    ${!fav.url.startsWith('internal:') ? `<div class="btn-fav-mini" onclick="openTabFavoriteExternal('${fav.url}', event)" title="Open External">‚ÜóÔ∏è</div>` : ''}
                    ${deleteBtn}
                </div>`;

            list.innerHTML += `
                <li class="fav-item" onclick="selectTabUrl('${fav.url}')">
                    <img src="${fav.icon}" class="fav-icon" onerror="this.src='about:blank'">
                    <span class="fav-name">${fav.title}</span>
                    ${actionBtns}
                </li>`;
        });
    }

    function addTabFavorite(url, customName) {
        const titleToUse = customName || (getDomain(url).charAt(0).toUpperCase() + getDomain(url).slice(1));
        const newFav = { title: titleToUse, url: url, icon: `https://www.google.com/s2/favicons?domain=${url}&sz=64` };
        const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); saved.push(newFav); localStorage.setItem(FAV_KEY, JSON.stringify(saved));
    }

    function deleteTabFavorite(savedIndex, e) {
        e.stopPropagation(); if(!confirm("Remove from favorites?")) return;
        const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); saved.splice(savedIndex, 1); localStorage.setItem(FAV_KEY, JSON.stringify(saved)); renderTabFavorites();
    }

    function copyTabFavorite(url, e) {
        e.stopPropagation();
        navigator.clipboard.writeText(url).then(() => alert("URL Copied"));
    }

    function openTabFavoriteExternal(url, e) {
        e.stopPropagation();
        if (url.startsWith('internal:')) return;
        window.open(url, '_blank');
    }

    /* ====== CORE HELPER FUNCTIONS ====== */
    function getYouTubeID(url) { if (!url) return null; const match = (url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|live\/)([^#&?]*).*/) || [])[2]; return (match && match.length === 11) ? match : null; }
    function getDomain(url) { try { return new URL(url).hostname.replace('www.', ''); } catch(e) { return 'web'; } }
    function generatePastelColor() { const hue = Math.floor(Math.random() * 360); return `hsl(${hue}, 70%, 90%)`; }
    function escapeHtml(text) { if (!text) return ""; return text.replace(/'/g, "\\'").replace(/"/g, "&quot;"); }

    function initResizer() {
        const resizer = document.getElementById('drag-resizer'); const leftSide = document.getElementById('desktop-media-wrapper'); const popup = document.getElementById('editor-popup'); let x = 0; let leftWidth = 0;
        const mouseDownHandler = function(e) { x = e.clientX; leftWidth = leftSide.getBoundingClientRect().width; document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler); resizer.classList.add('dragging'); leftSide.style.pointerEvents = 'none'; };
        const mouseMoveHandler = function(e) { const dx = e.clientX - x; const newWidth = leftWidth + dx; const percentage = (newWidth / popup.getBoundingClientRect().width) * 100; if (percentage > 20 && percentage < 80) leftSide.style.width = `${percentage}%`; };
        const mouseUpHandler = function() { document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler); resizer.classList.remove('dragging'); leftSide.style.pointerEvents = 'auto'; };
        if(resizer) resizer.addEventListener('mousedown', mouseDownHandler);
    }
    
    function toggleEditorFullScreen() { document.getElementById('editor-popup').classList.toggle('is-fullscreen'); document.getElementById('btn-fullscreen').classList.toggle('active'); }
    
    // --- SOLUCION 1: VOICES FIX ---
    function initVoices() { 
        window.speechSynthesis.onvoiceschanged = populateVoiceLists; 
        populateVoiceLists(); 
    }
    
    function populateVoiceLists() {
        voices = window.speechSynthesis.getVoices();
        
        // ELIMINADO EL BLOQUEO: if (voices.length === 0) return;
        
        const map = { 'en': 'en', 'es': 'es', 'pt': 'pt', 'it': 'it' };
        for (const [code, prefix] of Object.entries(map)) {
            const select = document.getElementById(`voice-${code}`); 
            if(!select) continue;
            
            select.innerHTML = ''; // Limpiar
            const available = voices.filter(v => v.lang.toLowerCase().startsWith(prefix));
            
            if(available.length === 0) { 
                const opt = document.createElement('option'); 
                // Mensaje informativo si aun cargan o no hay
                opt.text = voices.length === 0 ? "Loading voices..." : "Default Voice"; 
                select.add(opt); 
            } else { 
                available.forEach((v, i) => { 
                    const opt = document.createElement('option'); 
                    opt.textContent = `${v.name} (${v.lang})`; // M√°s detalle
                    opt.value = i; 
                    opt.setAttribute('data-name', v.name); 
                    select.appendChild(opt); 
                }); 
            }
        }
    }

    function selectTarget(el, lang) { document.querySelectorAll('#target-lang-group .flag-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentTargetLang = lang; updateTransFlagsVisibility(); }
    function selectLevel(el, levelDesc) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentLevel = levelDesc; }
    function updateTransFlagsVisibility() { document.querySelectorAll('#trans-lang-group .flag-btn').forEach(btn => { const btnLang = btn.getAttribute('data-lang'); if (btnLang === currentTargetLang) { btn.classList.add('hidden'); btn.classList.remove('selected'); transLangs.delete(btnLang); } else { btn.classList.remove('hidden'); } }); }
    function toggleTrans(el, lang) { if (transLangs.has(lang)) { transLangs.delete(lang); el.classList.remove('selected'); } else { if (transLangs.size >= 3) return alert("Max 3 translation languages."); transLangs.add(lang); el.classList.add('selected'); } }

    /* ====== RESOURCE CRUD ====== */
    function saveFreeModeWork(defaultTitle) {
        const uniqueCardId = Date.now().toString() + Math.floor(Math.random() * 1000); 
        const newRes = { 
            id: uniqueCardId, url: '', url2: '', url3: '', url4: '', url5: '', 
            type: 'web', title: defaultTitle, date: new Date().toLocaleDateString(), 
            note: editorArea.innerHTML, lastTime: 0, color: generatePastelColor() 
        };
        let resources = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; 
        resources.unshift(newRes); 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); 
        loadResources();
        const newIndex = resources.findIndex(r => r.id === uniqueCardId); 
        currentEditIndex = newIndex; 
        currentResourceId = uniqueCardId; 
        document.getElementById('editor-popup').classList.remove('free-mode'); 
        return uniqueCardId;
    }
    
    function deleteResourceById(id) { 
        if(confirm("Delete this resource?")) { 
            let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); 
            resources = resources.filter(r => String(r.id) !== String(id)); 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); 
            loadResources(); 
        } 
    }
    
    function duplicateResourceById(id) { 
        let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); 
        const original = resources.find(r => String(r.id) === String(id)); 
        if (!original) return; 
        const copy = JSON.parse(JSON.stringify(original)); 
        copy.title = copy.title + " (Copy)"; 
        copy.id = Date.now().toString() + Math.floor(Math.random() * 1000); 
        resources.unshift(copy); 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); 
        loadResources(); 
    }
    
    function editResourceMetaById(id) { 
        let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); 
        const index = resources.findIndex(r => String(r.id) === String(id)); 
        if (index === -1) return; 
        const r = resources[index]; 
        const newTitle = prompt("Edit Title:", r.title); if (newTitle === null) return; 
        const newUrl = prompt("Edit Primary URL (Tab 1):", r.url); if (newUrl === null) return; 
        r.title = newTitle; r.url = newUrl; 
        const ytId = getYouTubeID(newUrl); 
        if (ytId) r.type = 'video'; else if (newUrl.match(/\.(mp3|wav|ogg)$/i)) r.type = 'audio'; else r.type = 'web'; 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); 
        loadResources(); 
    }

    function clearResources(type) { 
        if(!confirm(`Are you sure you want to delete ${type === 'all' ? 'EVERYTHING' : 'all ' + type + ' resources'}?`)) return; 
        let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); 
        if(type === 'all') { data = []; } else { data = data.filter(r => { const rType = r.type || 'video'; return rType !== type; }); } 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
        loadResources(); 
        const popup = document.getElementById('data-popup');
        if(popup) popup.classList.remove('active');
    }

    function applySearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); loadResources(); }
    
    function loadResources() { 
        const data = localStorage.getItem(STORAGE_KEY); 
        let allResources = []; 
        try { allResources = data ? JSON.parse(data) : []; if (!Array.isArray(allResources)) throw new Error("Data is not an array"); } catch (e) { allResources = []; } 
        const filtered = allResources.filter(item => { 
            const type = item.type || 'video'; 
            if (currentFilter !== 'all' && type !== currentFilter) return false; 
            if (searchQuery && !item.title.toLowerCase().includes(searchQuery)) return false; 
            return true; 
        }); 
        renderGrid(filtered); 
    }

    function renderGrid(resources) {
        grid.innerHTML = resources.length ? '' : '<div style="grid-column:1/-1;text-align:center;color:#666;margin-top:40px">No resources found.</div>';
        resources.forEach((r) => {
            const hasNote = r.note && r.note.replace(/<[^>]*>/g, '').trim().length > 0;
            const type = r.type || 'video'; let mediaContent = '';
            if (type === 'video') { const videoId = getYouTubeID(r.url); if (videoId) { mediaContent = `<div class="media-area video" onclick="initGridPlayer(this, '${r.id}', '${videoId}')"><img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg"><div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>`; } else { mediaContent = `<div class="media-area video" style="background:#000; display:flex; align-items:center; justify-content:center; color:#666; font-size:0.8rem;">Invalid URL</div>`; } } 
            else if (type === 'audio') { mediaContent = `<div class="media-area audio" onclick="openEditorById('${r.id}')"><div class="audio-icon">üéß</div></div>`; } 
            else if (type === 'web') { const domain = getDomain(r.url || r.id); const faviconUrl = `https://www.google.com/s2/favicons?domain=${r.url || r.id}&sz=128`; mediaContent = `<div class="media-area web" style="background:${r.color || '#e3f2fd'}" onclick="openEditorById('${r.id}')"><div class="web-favicon-box"><img src="${faviconUrl}" onerror="this.src='about:blank'"></div><div class="web-domain-tag">WEB RESOURCE</div><div class="web-domain-text">${domain}</div></div>`; }
            grid.innerHTML += `<div class="resource-card">${mediaContent}<div class="card-info"><div class="card-title">${hasNote ? 'üìù ' : ''}${r.title}</div><div class="card-actions"><button class="btn-action btn-edit" onclick="openEditorById('${r.id}')" title="Open Editor">‚úèÔ∏è</button><button class="btn-action btn-duplicate" onclick="duplicateResourceById('${r.id}')" title="Duplicate">üìÑ</button><button class="btn-action btn-meta" onclick="editResourceMetaById('${r.id}')" title="Edit Data">üîß</button><button class="btn-action btn-delete" onclick="deleteResourceById('${r.id}')" title="Delete">üóëÔ∏è</button></div></div></div>`;
        });
    }

    /* ====== MEDIA PLAYERS ====== */
    function initGridPlayer(el, cardId, videoId) { if (!videoId) return alert("Video ID not found."); currentResourceId = cardId; const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); const resData = resources.find(v => String(v.id) === String(cardId)); const startTime = resData ? (resData.lastTime || 0) : 0; el.innerHTML = `<div id="p-${cardId}" class="video-target"></div>`; el.onclick = null; gridPlayer = new YT.Player(`p-${cardId}`, { width:'100%', height:'100%', videoId: videoId, playerVars: { autoplay: 1, rel: 0, start: Math.floor(startTime) }, events: { 'onReady': (e) => { e.target.playVideo(); players[0] = gridPlayer; }, 'onStateChange': (e) => onPlayerStateChange(e, cardId, gridPlayer) } }); }
    function onPlayerStateChange(event, id, playerInstance) { const playBtn = document.getElementById('btn-main-play'); const isControlled = (players[controlTarget] === playerInstance); if (event.data === 1) { stopTracking(); trackingInterval = setInterval(() => saveMediaTime(playerInstance, id), 5000); if(playBtn && isControlled) { playBtn.innerText = "‚è∏Ô∏è"; playBtn.classList.add('is-playing'); playBtn.classList.remove('is-paused'); } } else { saveMediaTime(playerInstance, id); stopTracking(); if(playBtn && isControlled) { playBtn.innerText = "‚ñ∂Ô∏è"; playBtn.classList.add('is-paused'); playBtn.classList.remove('is-playing'); } } }
    function saveMediaTime(player, id) { if (!player) return; let currentTime = 0; if (typeof player.getCurrentTime === 'function') { currentTime = player.getCurrentTime(); } else if (player.tagName === 'AUDIO') { currentTime = player.currentTime; } if (currentTime > 0) { const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); const index = resources.findIndex(v => String(v.id) === String(id)); if (index !== -1) { resources[index].lastTime = currentTime; localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); } } }
    function stopTracking() { if (trackingInterval) { clearInterval(trackingInterval); trackingInterval = null; } }

    /* ====== BACKUP & RESTORE ====== */
    function downloadBackup() { 
        const rawResources = localStorage.getItem(STORAGE_KEY); const rawMemory = localStorage.getItem(AI_MEM_KEY); const rawFavs = localStorage.getItem(FAV_KEY); 
        const resources = rawResources ? JSON.parse(rawResources) : []; const memory = rawMemory ? JSON.parse(rawMemory) : []; const favs = rawFavs ? JSON.parse(rawFavs) : [];
        alert(`Generating Backup:\nüìö Resources: ${resources.length}\nüß† AI Exercises: ${memory.length}\n‚≠ê Tab Favorites: ${favs.length}`);
        const fullData = { version: 3, resources: resources, memory: memory, favs: favs }; const d = JSON.stringify(fullData); const encodedData = btoa(unescape(encodeURIComponent(d)));
        const htmlContent = `<!DOCTYPE html><html><head><title>MDC Full Backup</title></head><body><h1>MDC Polyglot Full Backup</h1><p>Data Summary: ${resources.length} Resources, ${memory.length} AI Exercises.</p><p><strong>Upload this file using the Import button.</strong></p><script>const backupData = "${encodedData}";<\/script></body></html>`;
        const b = new Blob([htmlContent], {type: 'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); const dateStr = new Date().toISOString().split('T')[0]; a.download = `MDC_FullBackup_${dateStr}.html`; document.body.appendChild(a); a.click(); document.body.removeChild(a); 
    }

    function importBackup(inp) { 
        const file = inp.files[0]; if (!file) return;
        const r = new FileReader(); r.onload = e => { 
            try { 
                const content = e.target.result;
                let match = content.match(/const backupData\s*=\s*"(.*?)";/); if (!match) match = content.match(/const backupData=(.*?)(;|<\/script>)/s); if (!match) throw new Error("No backup data found.");
                let json = match[1]; try { json = decodeURIComponent(escape(atob(json))); } catch(e) { console.log("Legacy decode fallback"); } const parsedData = JSON.parse(json);
                if (parsedData.version >= 2 || (parsedData.resources && parsedData.memory)) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(parsedData.resources)); localStorage.setItem(AI_MEM_KEY, JSON.stringify(parsedData.memory));
                    if(parsedData.favs) localStorage.setItem(FAV_KEY, JSON.stringify(parsedData.favs));
                    alert(`‚úÖ RESTORE COMPLETE:\nüìö Resources: ${parsedData.resources.length}\nüß† AI Exercises: ${parsedData.memory.length}`);
                } else if (Array.isArray(parsedData)) {
                    if(confirm("Legacy backup detected. Keep existing AI data?")) { localStorage.setItem(STORAGE_KEY, JSON.stringify(parsedData)); } 
                    else { localStorage.setItem(STORAGE_KEY, JSON.stringify(parsedData)); localStorage.setItem(AI_MEM_KEY, '[]'); }
                    alert("‚úÖ Resources restored (Legacy format).");
                } else { throw new Error("Unknown format."); }
                loadResources(); renderAiList(); inp.value = ''; 
            } catch (err) { alert("‚ùå Error importing: " + err.message); }
        }; r.readAsText(file); 
    }

    /* ====== CONTROL & TAB SWITCHING ====== */
    window.setControlTarget = function(idx, fromSync = false) {
        controlTarget = idx;
        document.querySelectorAll('.btn-target').forEach((b, i) => { 
            if(i === idx) b.classList.add('active'); else b.classList.remove('active'); 
        });
        
        // Sync Lock Logic: Sync Tab to Control
        if (isSyncLocked && !fromSync) { switchWebTab(idx, true); }

        const p = players[controlTarget];
        const playBtn = document.getElementById('btn-main-play');
        if(p && typeof p.getPlayerState === 'function') {
            if(p.getPlayerState() === 1) { playBtn.innerText = "‚è∏Ô∏è"; playBtn.classList.add('is-playing'); } 
            else { playBtn.innerText = "‚ñ∂Ô∏è"; playBtn.classList.remove('is-playing'); }
        }
    }

    function openFreeEditor() { 
        currentEditIndex = -1; currentResourceId = null; editorArea.innerHTML = ""; modal.classList.add('active'); document.getElementById('editor-popup').classList.remove('free-mode'); document.getElementById('editor-popup').style.opacity = 1; players = [null, null, null, null, null]; 
        const container = document.getElementById('desktop-media-wrapper'); 
        const getBtn = (idx) => `<button class="web-tab-btn channel-${idx+1} ${idx===0?'active':''}" onclick="switchWebTab(${idx})">Tab ${idx + 1}<span class="tab-gear" onclick="window.editTabUrl(${idx}, event)">‚öôÔ∏è</span></button>`; 
        const getContent = (idx) => `<div class="web-frame-container ${idx===0?'active':''}" id="tab-content-${idx}"><div class="web-error-bg"><span>Empty Tab<br><small>Click ‚öôÔ∏è to add resource</small></span></div></div>`; 
        let tabsHtml = `<div class="media-iframe-wrapper"><div class="web-tab-nav">${getBtn(0)}${getBtn(1)}${getBtn(2)}${getBtn(3)}${getBtn(4)}</div><div class="web-content-area">${getContent(0)}${getContent(1)}${getContent(2)}${getContent(3)}${getContent(4)}</div></div>`; 
        container.innerHTML = tabsHtml; if(gridPlayer) gridPlayer.pauseVideo(); updateToolbarState(); 
    }

    window.switchWebTab = function(idx, fromSync = false) { 
        activeTabIndexForPopup = idx;
        document.querySelectorAll('.web-tab-btn').forEach((b, i) => { 
            if(b.innerText.includes('Externally')) return; 
            const buttons = Array.from(document.querySelectorAll('.web-tab-btn')).filter(btn => !btn.innerText.includes('Externally')); 
            if(buttons[idx]) { buttons.forEach(btn => btn.classList.remove('active')); buttons[idx].classList.add('active'); } 
        }); 
        document.querySelectorAll('.web-frame-container').forEach((f, i) => { if(i === idx) f.classList.add('active'); else f.classList.remove('active'); }); 
        
        // Sync Lock Logic: Sync Control to Tab
        if (isSyncLocked && !fromSync) { setControlTarget(idx, true); }
    };

    function openEditorById(id) {
        const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const index = resources.findIndex(r => String(r.id) === String(id));
        if (index === -1) return;
        currentEditIndex = index; const resData = resources[index]; currentResourceId = resData.id;
        editorArea.innerHTML = resData.note || ""; const type = resData.type || 'video';
        modal.classList.add('active'); document.getElementById('editor-popup').classList.remove('free-mode'); document.getElementById('editor-popup').style.opacity = 1;
        const container = document.getElementById('desktop-media-wrapper'); container.innerHTML = ''; 
        const isDesktop = window.matchMedia("(min-width: 900px)").matches; let startTime = resData.lastTime || 0;
        players = [null, null, null, null, null]; setControlTarget(0, true); 

        const ytId1 = getYouTubeID(resData.url);
        const ytId2 = getYouTubeID(resData.url2);
        const ytId3 = getYouTubeID(resData.url3);
        const ytId4 = getYouTubeID(resData.url4); 
        const ytId5 = getYouTubeID(resData.url5); 

        const renderTabs = (content1, content2, content3, content4, content5) => {
            const getBtn = (idx, link) => {
                const activeClass = idx === 0 ? 'active' : '';
                return `<button class="web-tab-btn channel-${idx+1} ${activeClass}" onclick="switchWebTab(${idx})" title="${link || ''}">Tab ${idx + 1}<span class="tab-gear" onclick="window.editTabUrl(${idx}, event)">‚öôÔ∏è</span></button>`;
            };
            return `<div class="media-iframe-wrapper"><div class="web-tab-nav">${getBtn(0, resData.url)}${resData.url2 ? getBtn(1, resData.url2) : getBtn(1, '')}${resData.url3 ? getBtn(2, resData.url3) : getBtn(2, '')}${resData.url4 ? getBtn(3, resData.url4) : getBtn(3, '')}${resData.url5 ? getBtn(4, resData.url5) : getBtn(4, '')}</div><div class="web-content-area"><div class="web-frame-container active" id="tab-content-0">${content1}</div><div class="web-frame-container" id="tab-content-1">${content2 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-2">${content3 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-3">${content4 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-4">${content5 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div></div></div>`;
        };

        const getTabContent = (link, ytId, index) => {
            if (link === 'internal:editor') { return `<div class="embedded-editor-area" contenteditable="true" oninput="document.getElementById('editor-text').innerHTML = this.innerHTML; window.saveNote();">${resData.note || ''}</div><div style="position:absolute; bottom:5px; right:5px; font-size:10px; color:#aaa; background:#fff; padding:2px;">Linked to Main Note</div>`; }
            if(ytId) return `<div id="player-tab-${index}" style="width:100%;height:100%"></div>`;
            if(link) return `<iframe src="${link}" allowfullscreen style="width:100%;height:100%;border:none;position:relative;z-index:2"></iframe>`;
            return null;
        };

        const htmlContent2 = getTabContent(resData.url2, ytId2, 2);
        const htmlContent3 = getTabContent(resData.url3, ytId3, 3);
        const htmlContent4 = getTabContent(resData.url4, ytId4, 4); 
        const htmlContent5 = getTabContent(resData.url5, ytId5, 5); 

        const initSubPlayers = () => {
            if(ytId2) players[1] = new YT.Player(`player-tab-2`, { width: '100%', height: '100%', videoId: ytId2, playerVars: { rel: 0 } });
            if(ytId3) players[2] = new YT.Player(`player-tab-3`, { width: '100%', height: '100%', videoId: ytId3, playerVars: { rel: 0 } });
            if(ytId4) players[3] = new YT.Player(`player-tab-4`, { width: '100%', height: '100%', videoId: ytId4, playerVars: { rel: 0 } }); 
            if(ytId5) players[4] = new YT.Player(`player-tab-5`, { width: '100%', height: '100%', videoId: ytId5, playerVars: { rel: 0 } }); 
        };

        if (type === 'video') {
            if (isDesktop) {
                if (gridPlayer && typeof gridPlayer.getCurrentTime === 'function' && gridPlayer.getVideoData().video_id === ytId1) { startTime = gridPlayer.getCurrentTime(); gridPlayer.pauseVideo(); }
                container.innerHTML = renderTabs('<div id="desktop-player-target" style="width:100%; height:100%;"></div>', htmlContent2, htmlContent3, htmlContent4, htmlContent5);
                if (ytId1) { players[0] = new YT.Player('desktop-player-target', { width: '100%', height: '100%', videoId: ytId1, playerVars: { autoplay: 0, rel: 0, start: Math.floor(startTime) }, events: { 'onStateChange': (e) => onPlayerStateChange(e, id, players[0]) } }); }
                initSubPlayers();
            } else { if (gridPlayer) { players[0] = gridPlayer; gridPlayer.pauseVideo(); } }
        } else if (type === 'audio') {
            if (isDesktop) {
                const audioHtml = `<div class="media-audio-wrapper"><audio controls id="modal-audio-player" src="${resData.url}"></audio></div>`;
                container.innerHTML = renderTabs(audioHtml, htmlContent2, htmlContent3, htmlContent4, htmlContent5);
                const audioEl = document.getElementById('modal-audio-player'); audioEl.currentTime = startTime; players[0] = audioEl;
                audioEl.addEventListener('play', () => { stopTracking(); trackingInterval = setInterval(() => saveMediaTime(audioEl, id), 5000); });
                audioEl.addEventListener('pause', () => { saveMediaTime(audioEl, id); stopTracking(); });
                initSubPlayers();
            }
        } else if (type === 'web') {
            if (isDesktop) {
                const webContent1 = `<iframe src="${resData.url}" allowfullscreen style="width:100%;height:100%;border:none;position:relative;z-index:2"></iframe>`;
                container.innerHTML = renderTabs(webContent1, htmlContent2, htmlContent3, htmlContent4, htmlContent5);
                players[0] = null; initSubPlayers();
            }
        }
        updateToolbarState();
    }

    function closeEditor() {
        if(currentEditIndex === -1) {
            const hasContent = editorArea.innerText.trim().length > 0 || editorArea.innerHTML.includes('<img') || editorArea.innerHTML.includes('<iframe');
            if(hasContent && confirm("Save current whiteboard session?")) { saveFreeModeWork("Saved Session " + new Date().toLocaleTimeString()); }
        }
        if (players[0] && currentResourceId) { saveMediaTime(players[0], currentResourceId); stopTracking(); } 
        players.forEach(p => { if (p && typeof p.destroy === 'function') { p.destroy(); } }); players = [null, null, null, null, null];
        loadResources(); modal.classList.remove('active'); document.getElementById('editor-popup').classList.remove('is-fullscreen'); document.getElementById('btn-fullscreen').classList.remove('active'); document.getElementById('editor-popup').classList.remove('free-mode'); document.getElementById('desktop-media-wrapper').innerHTML = ''; currentEditIndex = -1; gridPlayer = null; closeAIMenu();
    }
    
    window.saveNote = function() { if(currentEditIndex > -1) { const selects = editorArea.querySelectorAll('select'); selects.forEach(s => { const val = s.value; const opts = s.querySelectorAll('option'); opts.forEach(o => { if (o.value === val) o.setAttribute('selected', 'true'); else o.removeAttribute('selected'); }); }); const resources = JSON.parse(localStorage.getItem(STORAGE_KEY)); resources[currentEditIndex].note = editorArea.innerHTML; localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); } }
    window.resetExerciseBlock = function(btn) { const box = btn.closest('.exercise-box'); if(box) { const selects = box.querySelectorAll('select'); selects.forEach(s => { s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); s.selectedIndex = 0; }); window.saveNote(); } };
    function seekVideo(s) { const p = players[controlTarget]; if(!p) return; if(typeof p.seekTo === 'function') { p.seekTo(p.getCurrentTime()+s, true); } else if (p.tagName === 'AUDIO') { p.currentTime += s; } }
    function togglePlay() { const p = players[controlTarget]; if(!p) return; if(typeof p.getPlayerState === 'function') { p.getPlayerState()===1 ? p.pauseVideo() : p.playVideo(); } else if (p.tagName === 'AUDIO') { p.paused ? p.play() : p.pause(); } }
    function cycleSpeed() { const p = players[controlTarget]; if (!p) return; let r = 1; const t = document.getElementById('btn-speed').innerText; if(t==='1x') r=0.9; else if(t==='0.9x') r=0.8; else if(t==='0.8x') r=0.7; else if(t==='0.7x') r=0.6; else if(t==='0.6x') r=0.5; if(typeof p.setPlaybackRate === 'function') { p.setPlaybackRate(r); } else if (p.tagName === 'AUDIO') { p.playbackRate = r; } document.getElementById('btn-speed').innerText=r+'x'; }
    function applyColor(hex) { document.execCommand('foreColor', false, hex); updateToolbarState(); }
    function toggleBold() { document.execCommand('bold'); updateToolbarState(); }
    function setSize(size) { document.execCommand('fontSize', false, size); updateToolbarState(); }
    function setFont(fontName) { document.execCommand('fontName', false, fontName); updateToolbarState(); }

    editorArea.addEventListener('keyup', updateToolbarState); editorArea.addEventListener('mouseup', updateToolbarState); editorArea.addEventListener('click', updateToolbarState); editorArea.addEventListener('input', window.saveNote);
    
    function updateToolbarState() { 
        const isBold = document.queryCommandState('bold'); 
        document.getElementById('btn-bold').classList.toggle('active', isBold); 
        
        const size = document.queryCommandValue('fontSize'); 
        document.getElementById('btn-size-lg').classList.toggle('active', size === '5' || size === 'x-large'); 
        document.getElementById('btn-size-norm').classList.toggle('active', size !== '5' && size !== 'x-large'); 
        
        const rgb = document.queryCommandValue('foreColor'); 
        document.querySelectorAll('.color-circle').forEach(b => b.classList.remove('active')); 
        if(rgb) {
            if(rgb.includes('255, 59, 48')) document.querySelectorAll('.color-circle')[1].classList.add('active'); 
            else if (rgb.includes('0, 122, 255')) document.querySelectorAll('.color-circle')[2].classList.add('active'); 
            else if (rgb.includes('52, 199, 89')) document.querySelectorAll('.color-circle')[3].classList.add('active'); 
            else document.querySelectorAll('.color-circle')[0].classList.add('active'); 
        }

        const font = document.queryCommandValue('fontName');
        document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
        if(font) {
            if(font.includes('Inter')) document.querySelectorAll('.font-btn')[0].classList.add('active');
            else if(font.includes('Playfair')) document.querySelectorAll('.font-btn')[1].classList.add('active');
            else if(font.includes('Courier')) document.querySelectorAll('.font-btn')[2].classList.add('active');
            else if(font.includes('Dancing')) document.querySelectorAll('.font-btn')[3].classList.add('active');
        }
    }

    /* ====== AI HUB LOGIC ====== */
    function openAIMenu() { aiModal.classList.add('active'); renderAiList(); }
    function closeAIMenu() { aiModal.classList.remove('active'); }
    function checkCustomOverride(inputId, selectId) { const inputVal = document.getElementById(inputId).value.trim(); const selectEl = document.getElementById(selectId); if(inputVal.length > 0) { selectEl.classList.add('override-warning'); } else { selectEl.classList.remove('override-warning'); } }
    
    function saveEditorAsTemplate() { const rawContent = document.getElementById('editor-text').innerHTML.trim(); if(!rawContent || rawContent === "<br>") return alert("Editor is empty."); const name = prompt("Name this lesson template:"); if(!name) return; const tempDiv = document.createElement('div'); tempDiv.innerHTML = rawContent; tempDiv.querySelectorAll('select').forEach(s => { s.value = ""; s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); }); tempDiv.querySelectorAll('.hint-box, .trans-box, .theory-box').forEach(box => { box.style.display = 'none'; }); const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory.unshift({ id: Date.now(), title: name, isHtml: true, htmlContent: tempDiv.innerHTML, lang: 'en', date: new Date().toLocaleDateString(), data: [] }); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); alert("Template saved!"); renderAiList(); }
    
    function exportMemoryBank() { const data = localStorage.getItem(AI_MEM_KEY); if(!data || data === '[]') return alert("Memory is empty."); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'polyglot_memory_full.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function importMemoryBank(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if(!Array.isArray(importedData)) throw new Error("Invalid format"); const current = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const combined = [...importedData, ...current]; localStorage.setItem(AI_MEM_KEY, JSON.stringify(combined)); renderAiList(); alert("Import Successful!"); } catch(err) { alert("Error importing: " + err.message); } }; reader.readAsText(file); }
    function renameMemoryItem(id) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const idx = memory.findIndex(i => i.id === id); if(idx > -1) { const newTitle = prompt("New Title:", memory[idx].title); if(newTitle) { memory[idx].title = newTitle; localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } } }
    function exportSingleItem(id) { const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const item = memory.find(x => x.id === id); if(!item) return; const data = JSON.stringify([item], null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const safeName = (item.title || 'exercise').replace(/[^a-z0-9]/gi, '_').toLowerCase(); a.download = `${safeName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function deleteMemoryItem(id) { if(confirm("Delete?")) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory = memory.filter(item => item.id !== id); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } }
    function clearAIMemory() { if(confirm("Clear all?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }
    
    function renderAiList() { 
        const listContainer = document.getElementById('ai-memory-list'); 
        const previewContainer = document.getElementById('ai-latest-preview');
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); 
        
        previewContainer.innerHTML = '';
        listContainer.innerHTML = '';

        if (memory.length === 0) { 
            listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>'; 
            return; 
        } 

        const createItemHtml = (item, index, isPreview = false) => {
            let flag = "üá¨üáß"; if(item.lang === 'es') flag = "üá™üá∏"; if(item.lang === 'pt') flag = "üáßüá∑"; if(item.lang === 'it') flag = "üáÆüáπ"; 
            let newBadge = (index === 0 && !isPreview) ? '<span class="badge-new">NEW</span>' : ''; 
            let typeBadge = item.isHtml ? '<span class="badge-tpl">TEMPLATE</span>' : `‚Ä¢ ${item.data.length} Qs`; 
            
            // Clase diferente si es el preview
            let boxClass = isPreview ? 'saved-item ai-preview-box' : 'saved-item';
            let titlePrefix = isPreview ? 'üÜï LATEST CREATED: ' : '';

            return `<div class="${boxClass}" style="${isPreview ? 'background:#f0fff4; border-bottom:none;' : ''}">
                <div class="saved-num">${isPreview ? '‚≠ê' : '#' + (index + 1)}</div>
                <div class="saved-info">
                    <span class="saved-name">${flag} ${titlePrefix}${item.title} ${newBadge}</span>
                    <span class="saved-date">${item.date} ${typeBadge}</span>
                </div>
                <div class="mem-actions">
                    <button class="btn-insert" onclick="insertExerciseFromMem(${item.id})">Insert</button>
                    <button class="btn-icon-action btn-export-item" onclick="exportSingleItem(${item.id})" title="Export JSON">‚¨áÔ∏è</button>
                    <button class="btn-icon-action btn-rename" onclick="renameMemoryItem(${item.id})" title="Rename">‚úèÔ∏è</button>
                    <button class="btn-icon-action btn-delete-item" onclick="deleteMemoryItem(${item.id})" title="Delete">√ó</button>
                </div>
            </div>`; 
        };

        // Renderizar el √∫ltimo (preview)
        if(memory.length > 0) {
            previewContainer.innerHTML = createItemHtml(memory[0], 0, true);
        }

        // Renderizar la lista completa (Bank)
        let listHtml = '';
        memory.forEach((item, index) => { 
            listHtml += createItemHtml(item, index, false);
        }); 
        listContainer.innerHTML = listHtml; 
    }
    
    // --- SOLUCION 2: PROMPT FIX ---
    function copyProfessorPrompt() {
        const ctxSel = document.getElementById('ai-context-select').value;
        const graSel = document.getElementById('ai-grammar-select').value;
        const typSel = document.getElementById('ai-type-select').value;
        const gapCount = document.getElementById('ai-gap-count').value;
        const ctxCust = document.getElementById('ai-context-custom').value.trim();
        const graCust = document.getElementById('ai-grammar-custom').value.trim();
        const typCust = document.getElementById('ai-type-custom').value.trim();
        const extraData = document.getElementById('ai-extra-data').value.trim();
        
        // Nuevo: Obtener cantidad
        const quantity = document.getElementById('ai-sentence-count').value || 5;

        let requirements = [];
        let isGrammarFocus = false;
        let typeStr = typCust ? typCust : typSel;

        if(ctxCust) requirements.push(`Topic Context: ${ctxCust}`);
        else if(ctxSel) requirements.push(`Topic Context: ${ctxSel}`);

        if(graCust) {
            requirements.push(`Grammar Focus: ${graCust}`);
            isGrammarFocus = true;
        } else if(graSel) {
            requirements.push(`Grammar Focus: ${graSel}`);
            isGrammarFocus = true;
        }

        if(typeStr) requirements.push(`Exercise Format: ${typeStr}`);

        if(requirements.length === 0) return alert("‚ö†Ô∏è Please select at least one option.");

        const finalTopic = requirements.join(", ");
        const target = LANG_NAMES[currentTargetLang];
        
        // Instrucciones base
        let languageInstruction = `CRITICAL LANGUAGE RULE: The sentences AND the options inside the gaps {opt1|opt2...} MUST BE in **${target.toUpperCase()}**. Do NOT use English words inside the gaps. Example in ${target}: "Ele {fala|falou|falar}..." (NOT "Ele {speak|spoke}...")`;
        let strictInstruction = "";
        let gapInstruction = "";

        if (typeStr && typeStr.includes("Find and Fix")) {
            strictInstruction += ` TYPE: FIND AND FIX THE MISTAKE. VISUAL REQUIREMENT: You MUST include the mistake crossed out using HTML tags <s>mistake</s> immediately before the correct gap. Format: "Yesterday I <s>goed</s> {went|go} to the park." (Space between </s> and {).`;
        } else if (typeStr && typeStr.includes("Sentence Reordering")) {
            strictInstruction += ` TYPE: SENTENCE REORDERING via MULTIPLE CHOICE. The prompt MUST be the scrambled words. The options MUST be full sentences in ${target}.`;
        } else if (typeStr && typeStr.includes("Vocabulary Matching")) {
            strictInstruction += ` TYPE: VOCABULARY MATCHING. Format: "Definition text (${target})... {CorrectWord|Distractor1|Distractor2}"`;
        } else if (typeStr && typeStr.includes("True or False")) {
            strictInstruction += ` TYPE: READING COMPREHENSION (TRUE/FALSE). Format: "Statement about the text... {True|False}" (Localize True/False if appropriate for ${target}).`;
        }

        if (typeStr && typeStr.includes("True or False")) {
            gapInstruction = "Provide options {True|False}.";
        } else if (gapCount === 'random') {
            gapInstruction = ` GAP REQUIREMENT: For EVERY gap, you MUST provide 3 to 4 options in ${target}. For VERBS, include variations in Tense, Person, and Form. Mix of 1, 2, or 3 gaps per sentence.`;
        } else {
            gapInstruction = ` GAP REQUIREMENT: For EVERY gap, you MUST provide 3 to 4 options in ${target}. For VERBS, include variations in Tense, Person, and Form. Provide exactly ${gapCount} gap(s) per sentence.`;
        }

        if (isGrammarFocus && !typeStr.includes("Reordering")) {
            strictInstruction += ` Focus gaps ONLY on the requested GRAMMAR rule (verbs/auxiliaries).`;
        }
        
        const jsonExample = `
        {
          "cloze_text": "Sentence in ${target} with {option1|option2|option3} gaps.",
          "hint": "Brief clue",
          "translations": { ${Array.from(transLangs).map(l => `"${l}": "Translation"`).join(', ')} },
          "full_sentence": "Full sentence in ${target} without gaps."
        }`;
        
        // USO DE \n PARA SALTO DE LINEA REAL
        const promptText = 
`ACT AS: Senior ${target} Linguist.
LEVEL: CEFR ${currentLevel}.
TASK: Create a structured JSON exercise with exactly ${quantity} sentences.

REQUIREMENTS: 
${finalTopic}

RULES:
1. ${languageInstruction}
2. GAP DENSITY: ${gapInstruction}
3. ${strictInstruction}
${extraData ? `4. EXTRA INSTRUCTIONS: ${extraData}` : ''}

OUTPUT FORMAT: RAW JSON ONLY.
JSON STRUCTURE:
{ 
  "title": "Short descriptive title in ${target}", 
  "lang_code": "${currentTargetLang}", 
  "theory": "Brief rules explanation...", 
  "exercises": [ ${jsonExample} ] 
}`.trim();
        
        navigator.clipboard.writeText(promptText).then(() => {
            const btn = document.querySelector('.btn-ai-primary');
            const orig = btn.innerText;
            btn.innerText = "‚úÖ Copied!";
            setTimeout(() => btn.innerText = orig, 2000);
        }).catch(err => alert("Error copying: " + err));
    }
    
    async function pasteAIJson() {
        let jsonString = "";
        try {
            jsonString = await navigator.clipboard.readText();
        } catch (err) {
            jsonString = prompt("Paste JSON here:");
        }
        if (!jsonString) return;
        processJsonAndSave(jsonString);
    }
    
    function processJsonAndSave(jsonString) {
        try {
            let cleanString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const aiData = JSON.parse(cleanString);
            let finalData = Array.isArray(aiData) ? {
                title: "Exercise",
                lang_code: "en",
                theory: "Review rules.",
                exercises: aiData
            } : aiData;
            if (!finalData.lang_code) finalData.lang_code = "en";
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            memory.unshift({
                id: Date.now(),
                title: finalData.title || "Untitled",
                lang: finalData.lang_code,
                theory: finalData.theory,
                date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                data: finalData.exercises
            });
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
            renderAiList();
        } catch (e) {
            alert("‚ùå Invalid JSON.\nError: " + e.message);
        }
    }
    
    function insertExerciseFromMem(id) {
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        const item = memory.find(x => x.id === id);
        if (!item) return;
        if (item.isHtml) {
            if (confirm("Insert template?")) {
                editorArea.insertAdjacentHTML('beforeend', item.htmlContent + '<p><br></p>');
                closeAIMenu();
                window.saveNote();
            }
            return;
        }
        const insertTime = Date.now();
        const theoryId = `theory-${id}-${insertTime}`;
        const targetLang = item.lang || 'en';
        let htmlBlock = `<div class="exercise-box" contenteditable="false"><div class="exercise-header"><span>‚úçÔ∏è ${item.title}</span><div style="display:flex; align-items:center;"><button class="btn-theory" onclick="document.getElementById('${theoryId}').style.display = document.getElementById('${theoryId}').style.display === 'block' ? 'none' : 'block'">üìò Theory</button><button class="btn-reset-block" contenteditable="false" onclick="window.resetExerciseBlock(this)" title="Reset">‚Ü∫</button><button class="btn-del-block" contenteditable="false" onclick="if(confirm('Delete block?')) { this.closest('.exercise-box').remove(); window.saveNote(); }" title="Delete">üóëÔ∏è</button></div></div><div class="theory-box" id="${theoryId}">${item.theory || "No theory."}</div>`;
        item.data.forEach((ex, index) => {
            const uId = `ex-${id}-${index}-${insertTime}`;
            const hId = `hint-${id}-${index}-${insertTime}`;
            const tId = `trans-${id}-${index}-${insertTime}`;
            let exerciseContent = "";
            if (ex.cloze_text) {
                let parsedHtml = ex.cloze_text.replace(/\{([^}]+)\}/g, (match, content) => {
                    const parts = content.split('|');
                    const correctAns = parts[0].trim();
                    const shuffled = [...parts].sort(() => Math.random() - 0.5);
                    let optsHtml = `<option value="" disabled selected>...</option>`;
                    shuffled.forEach(opt => {
                        optsHtml += `<option value="${escapeHtml(opt.trim())}">${opt.trim()}</option>`;
                    });
                    return `<span class="cloze-gap-container"><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(correctAns)}')">${optsHtml}</select></span>`;
                });
                exerciseContent = `<span><b>${index + 1}.</b> ${parsedHtml}</span>`;
            } else {
                let optsHtml = `<option value="" disabled selected>...</option>`;
                const shuffled = [...ex.options].sort(() => Math.random() - 0.5);
                shuffled.forEach(opt => {
                    optsHtml += `<option value="${escapeHtml(opt)}">${opt}</option>`;
                });
                exerciseContent = `<span><b>${index + 1}.</b> ${ex.pre || ''}</span><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(ex.answer)}')">${optsHtml}</select><span>${ex.post || ''}</span>`;
            }
            let transContent = "";
            if (ex.translations) {
                for (const [key, val] of Object.entries(ex.translations)) {
                    let f = "üá¨üáß";
                    if (key === 'es') f = "üá™üá∏";
                    if (key === 'pt') f = "üáßüá∑";
                    if (key === 'it') f = "üáÆüáπ";
                    transContent += `<div class="trans-line"><button class="btn-mini-speak" contenteditable="false" onclick="window.speakText('${escapeHtml(val)}', '${key}')">üîä</button><span>${f} ${val}</span></div>`;
                }
            } else {
                transContent = "No translation";
            }
            htmlBlock += `<div class="exercise-row" id="${uId}">${exerciseContent}<div style="display:inline-flex; gap:5px; margin-left:10px;"><button class="ex-btn-icon" contenteditable="false" onclick="window.speakText('${escapeHtml(ex.full_sentence)}', '${targetLang}')">üîä</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${tId}').style.display = document.getElementById('${tId}').style.display === 'block' ? 'none' : 'block'">üåê</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${hId}').style.display = document.getElementById('${hId}').style.display === 'block' ? 'none' : 'block'">‚ùì</button></div><div class="hint-box" id="${hId}">üí° ${ex.hint}</div><div class="trans-box" id="${tId}">${transContent}</div></div>`;
        });
        htmlBlock += '</div><p><br></p>';
        editorArea.insertAdjacentHTML('beforeend', htmlBlock);
        setTimeout(() => {
            editorArea.scrollTop = editorArea.scrollHeight;
            window.saveNote();
        }, 50);
        closeAIMenu();
    }
    
    window.validateExercise = function(s, a) {
        s.classList.remove('correct', 'wrong');
        if (s.value.trim().toLowerCase() === a.trim().toLowerCase()) {
            s.classList.add('correct');
        } else {
            s.classList.add('wrong');
            if (navigator.vibrate) navigator.vibrate(200);
        }
        window.saveNote();
    };
    
    window.speakText = function(text, langCode) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const sel = document.querySelector(`#voice-${langCode} option:checked`)?.getAttribute('data-name');
            const all = window.speechSynthesis.getVoices();
            if (sel) {
                const v = all.find(val => val.name === sel);
                if (v) u.voice = v;
            } else {
                const m = {
                    'en': 'en-US',
                    'es': 'es-ES',
                    'pt': 'pt-BR',
                    'it': 'it-IT'
                };
                u.lang = m[langCode] || 'en-US';
            }
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        } else {
            alert("TTS not supported.");
        }
    };

    /* ====== DATA GUARDIAN (SECURITY V2) ====== */
    function initDataGuardian() {
        if (navigator.storage && navigator.storage.persist) {
            navigator.storage.persist().then(granted => {
                if (granted) console.log("üõ°Ô∏è Data Guardian: Persistence Granted.");
                else console.warn("‚ö†Ô∏è Data Guardian: Storage not persistent.");
            });
        }

        // Auto-Restore Logic
        const mainRes = localStorage.getItem(STORAGE_KEY);
        const mirrorRes = localStorage.getItem(MIRROR_RES_KEY);

        if ((!mainRes || mainRes === '[]') && (mirrorRes && mirrorRes.length > 50)) {
            if (confirm("‚ö†Ô∏è SECURITY ALERT ‚ö†Ô∏è\n\nYour main library appears empty, but a safety mirror exists.\n\nRESTORE data from mirror?")) {
                localStorage.setItem(STORAGE_KEY, mirrorRes);
                alert("‚úÖ Data rescued successfully.");
                location.reload();
            }
        }

        const mainAi = localStorage.getItem(AI_MEM_KEY);
        const mirrorAi = localStorage.getItem(MIRROR_AI_KEY);
        if ((!mainAi || mainAi === '[]') && (mirrorAi && mirrorAi.length > 50)) {
            console.warn("Auto-restoring AI memory from mirror...");
            localStorage.setItem(AI_MEM_KEY, mirrorAi);
        }

        setInterval(updateSecurityMirror, 60000);
    }

    function updateSecurityMirror() {
        const currentRes = localStorage.getItem(STORAGE_KEY);
        const currentAi = localStorage.getItem(AI_MEM_KEY);
        if (currentRes && currentRes.length > 50) localStorage.setItem(MIRROR_RES_KEY, currentRes);
        if (currentAi && currentAi.length > 50) localStorage.setItem(MIRROR_AI_KEY, currentAi);
    }

    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        originalSetItem.apply(this, [key, value]);
        if (key === STORAGE_KEY || key === AI_MEM_KEY) {
            setTimeout(() => {
                if (key === STORAGE_KEY && value.length > 50) originalSetItem.apply(this, [MIRROR_RES_KEY, value]);
                if (key === AI_MEM_KEY && value.length > 50) originalSetItem.apply(this, [MIRROR_AI_KEY, value]);
            }, 100);
        }
    };
</script>
</body>
</html>
