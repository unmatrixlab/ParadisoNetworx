<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>MDC Video Player (Lite)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        // 1. SOLICITUD DE CLAVE AL INICIO (Bloqueante)
        (function() {
            let authorized = false;
            while (!authorized) {
                let pass = prompt("üîí Acceso restringido. Ingrese la clave:");
                if (pass === "1990") {
                    authorized = true;
                } else {
                    if(pass === null) window.location.reload(); // Si cancela, recarga
                    else alert("Clave incorrecta.");
                }
            }
        })();
    </script>
    <style>
        :root { --primary: #4f46e5; --primary-hover: #4338ca; --bg-body: #31353b; --card-bg: #ffffff; --text-main: #1f2937; --text-sec: #6b7280; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 12px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        /* === SETUP SCREEN === */
        #setup-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #31353b; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 40px 20px; overflow-y: auto; }
        .setup-container { width: 100%; max-width: 900px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        @media (max-width: 800px) { .setup-container { grid-template-columns: 1fr; } }
        
        .setup-card { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e5e7eb; 
            height: fit-content; 
            position: relative; 
            min-width: 0; 
        }

        .setup-title { font-size: 20px; font-weight: 800; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-sec); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .text-input { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: monospace; transition: 0.2s; }
        .text-input:focus { border-color: var(--primary); outline: none; }
        select.text-input { font-family: 'Inter', sans-serif; cursor: pointer; background-color: white; }
        
        .start-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 10px; transition: 0.2s; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
        .start-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .gen-json-btn { background: #374151; color: white; border: none; width: 100%; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .gen-json-btn:hover { background: #1f2937; }

        .backup-btn { position: relative; flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; color: var(--text-main); font-weight: 600; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; overflow: hidden; }
        .backup-btn:hover { background: #f9fafb; border-color: var(--primary); color: var(--primary); }
        input[type="file"] { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; top:0; left:0; }
        .backup-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }

        /* === FILTERS === */
        .cat-filter-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; scrollbar-width: none; }
        .cat-filter-container::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid #e5e7eb; background: white; color: var(--text-sec); font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .cat-btn:hover { border-color: var(--primary); color: var(--primary); }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .history-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .history-item { display: flex; align-items: center; padding: 12px; background: #f3f4f6; border-radius: 10px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .history-item:hover { background: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .h-thumb { width: 50px; height: 38px; border-radius: 4px; background: #000; margin-right: 12px; background-size: cover; background-position: center; flex-shrink: 0; }
        .h-info { flex: 1; min-width: 0; }
        .h-title { font-size: 14px; font-weight: 700; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .h-date { font-size: 11px; color: var(--text-sec); display: flex; align-items: center; gap: 6px; }
        .h-tag { background: #e0e7ff; color: var(--primary); padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .h-btn-del { padding: 5px 8px; font-size: 12px; color: #ef4444; background: transparent; border: none; cursor: pointer; opacity: 0.5; }
        .h-btn-del:hover { opacity: 1; background: #fee2e2; border-radius: 4px; }
        .empty-history { text-align: center; color: #9ca3af; font-size: 14px; padding: 20px; font-style: italic; }
        .library-section { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .library-label { display: block; font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* === JSON MODAL STYLE === */
        #json-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 6000;
            align-items: center; justify-content: center;
            padding: 20px;
        }
        .json-modal-content {
            background: #1f2937; color: #fff;
            width: 100%; max-width: 600px;
            border-radius: 12px; padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #json-output {
            width: 100%; height: 150px;
            background: #111827; color: #a5f3fc;
            border: 1px solid #374151; border-radius: 8px;
            padding: 10px; font-family: monospace; font-size: 12px;
            resize: none; outline: none;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .close-modal-btn { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 700; }

        /* === PLAYER UI === */
        #player-ui { 
            display: none; 
            width: 100%; 
            height: 100%; 
            position: fixed; 
            top: 0; 
            left: 0;
            background: var(--bg-body);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Cambiado para permitir scroll si el texto crece mucho */
            padding-top: 20px;
            overflow-y: auto; /* Scroll en la pagina del player */
        }

        .page-max-width { 
            max-width: 1200px; 
            margin: 0 auto; 
            width: 95%; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            padding-bottom: 50px;
        }

        .video-wrapper { 
            position: relative; 
            width: 100%; 
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0; 
            background: #000; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            border-radius: 20px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        #home-btn { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 600; 
            background: rgba(255,255,255,0.1); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.2); 
            padding: 10px 16px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            backdrop-filter: blur(10px); 
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        #home-btn:hover { background: rgba(255,255,255,0.2); }

        /* 2. ESTILOS PARA EL CAMPO DE TEXTO */
        .notes-area {
            width: 100%;
            max-width: 600px; /* Campo estrecho */
            margin: 30px auto 0 auto; /* Centrado */
            background-color: #1a1c20; /* Mas oscuro que el fondo #31353b */
            color: #9ca3af; /* Texto gris */
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            resize: none; /* Quitamos el resize manual */
            overflow: hidden; /* Ocultamos scrollbar */
            min-height: 60px;
            transition: border-color 0.2s;
            display: block;
        }
        .notes-area:focus {
            border-color: var(--primary);
        }
        .notes-area::placeholder {
            color: #4b5563;
        }

    </style>
</head>
<body>

<div id="setup-screen">
        <div class="setup-container">
            <div class="setup-card">
                <div class="setup-title">‚ú® New Session</div>
                <div class="input-group">
                    <label class="input-label">1. Video ID or URL</label>
                    <input type="text" id="input-yt-id" class="text-input" placeholder="Paste YouTube URL..." autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Category</label>
                    <select id="input-category" class="text-input">
                        <option value="Tutorial">Tutorial</option>
                        <option value="Interview">Interview</option>
                        <option value="Movie">Movie</option>
                        <option value="Podcast">Podcast</option>
                        <option value="Music">Music</option>
                        <option value="Documentary">Documentary</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <button class="start-btn" onclick="startNewSession()">PLAY VIDEO üöÄ</button>
                
                <button class="gen-json-btn" onclick="generateLibraryJSON()">
                    üìã Generate JSON for Library
                </button>
            </div>

            <div class="setup-card">
                <div class="cat-filter-container">
                    <button class="cat-btn active" onclick="setCategoryFilter('All')">All</button>
                    <button class="cat-btn" onclick="setCategoryFilter('Tutorial')">Tutorial</button>
                    <button class="cat-btn" onclick="setCategoryFilter('Interview')">Interview</button>
                    <button class="cat-btn" onclick="setCategoryFilter('Movie')">Movie</button>
                    <button class="cat-btn" onclick="setCategoryFilter('Podcast')">Podcast</button>
                    <button class="cat-btn" onclick="setCategoryFilter('Music')">Music</button>
                    <button class="cat-btn" onclick="setCategoryFilter('Documentary')">Documentary</button>
                </div>

                <div class="library-section" id="library-container">
                    <div class="library-label">üî• Library 2.0</div>
                    <div id="library-list" class="history-list">
                        <div class="empty-history">Waiting for connection...</div>
                    </div>
                </div>
                
                <div class="setup-title">üìö Personal History</div>
                <div id="history-container" class="history-list">
                    <div class="empty-history">No recent history.</div>
                </div>

                <div class="backup-actions">
                    <button class="backup-btn" onclick="exportBackup()">üíæ Backup Data</button>
                    <div class="backup-btn">
                        <span>üìÇ Restore</span>
                        <input type="file" accept=".json" onchange="importBackup(this)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="json-modal">
        <div class="json-modal-content">
            <h3 style="margin:0;">üìú JSON Generated</h3>
            <p style="margin:0; font-size:12px; opacity:0.7;">Copy this and add it to your biblioteca2.json file.</p>
            <textarea id="json-output" readonly></textarea>
            <div class="modal-actions">
                <button class="close-modal-btn" onclick="document.getElementById('json-modal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <div id="player-ui">
        <button id="home-btn" onclick="goHome()">üè† Back to Menu</button>

        <div class="page-max-width">
            <div class="video-wrapper">
                <div id="player"></div>
            </div>
            
            <textarea id="video-notes" class="notes-area" placeholder="Escribe tus notas aqu√≠..." oninput="autoResizeAndSave(this)"></textarea>

        </div>
    </div>

    <script>
    let YOUTUBE_ID = '';
    let VIDEO_TITLE = 'Video Loaded';
    const HISTORY_KEY = 'mdc_simple_history';
    const LIBRARY_URL = 'https://paradisonetworx.com/biblioteca2.json'; 
    let REMOTE_LIBRARY = [];
    let activeCategoryFilter = 'All';
    let player;
    let STORAGE_KEY_TIME;

    document.addEventListener('DOMContentLoaded', () => { 
        renderHistoryList();
        loadRemoteLibrary(); 
    });

    function setCategoryFilter(category) {
        activeCategoryFilter = category;
        document.querySelectorAll('.cat-btn').forEach(btn => {
            if(btn.innerText === category) btn.classList.add('active');
            else btn.classList.remove('active');
        });
        renderHistoryList();
        renderLibraryItems();
    }

    async function loadRemoteLibrary() {
        const list = document.getElementById('library-list');
        list.innerHTML = '<div class="empty-history" style="color:#4f46e5;">‚è≥ Buscando videos...</div>';
        try {
            const response = await fetch(LIBRARY_URL + '?t=' + new Date().getTime());
            if (!response.ok) throw new Error("Error de conexi√≥n");
            let data = await response.json();
            
            if (data.pin && data.videos) REMOTE_LIBRARY = data.videos;
            else if (Array.isArray(data)) REMOTE_LIBRARY = data;
            else REMOTE_LIBRARY = [];
            
            renderLibraryItems(); 
        } catch (error) {
            console.error(error);
            list.innerHTML = `<div class="empty-history" style="color:#ef4444;">‚ùå No se pudo cargar la biblioteca.</div>`;
        }
    }

    function renderLibraryItems() {
        const list = document.getElementById('library-list');
        list.innerHTML = '';
        const filteredLib = (activeCategoryFilter === 'All') 
            ? REMOTE_LIBRARY 
            : REMOTE_LIBRARY.filter(item => item.category === activeCategoryFilter);

        if(filteredLib.length === 0) { list.innerHTML = '<div class="empty-history">No hay videos en esta categor√≠a.</div>'; return; }
        
        filteredLib.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.style.borderLeft = "4px solid #4f46e5";
            div.onclick = () => loadVideo(item.id, item.title);
            const catDisplay = item.category ? `<span class="h-tag">${item.category}</span>` : '';
            div.innerHTML = `
                <div class="h-thumb" style="background-image: url('https://img.youtube.com/vi/${item.id}/default.jpg')"></div>
                <div class="h-info">
                    <div class="h-title">${item.title}</div>
                    <div class="h-date" style="color:#4f46e5; font-weight:600;">‚òÅÔ∏è ${catDisplay}</div>
                </div>
                <div style="font-size:18px; color:#aaa;">‚ñ∂</div>`;
            list.appendChild(div);
        });
    }

    function extractVideoID(url) {
        const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=|shorts\/)|youtu\.be\/)([^"&?\/\s]{11})/;
        const match = url.match(regExp);
        return (match && match[1]) ? match[1] : false;
    }

    function startNewSession() {
        const rawInput = document.getElementById('input-yt-id').value.trim();
        const category = document.getElementById('input-category').value;
        let extractedID = extractVideoID(rawInput);
        if (!extractedID && rawInput.length === 11) extractedID = rawInput;
        
        if (!extractedID) return alert("‚ùå URL o ID de video inv√°lido.");
        
        loadVideo(extractedID, "Cargando t√≠tulo...", category);
    }

    function generateLibraryJSON() {
        const rawInput = document.getElementById('input-yt-id').value.trim();
        const category = document.getElementById('input-category').value;
        let extractedID = extractVideoID(rawInput);
        if (!extractedID && rawInput.length === 11) extractedID = rawInput;
        
        if (!extractedID) { alert("‚ùå ID invalido."); return; }

        const jsonObj = {
            id: extractedID,
            title: "TITULO_AQUI", 
            category: category
        };
        
        const jsonString = JSON.stringify(jsonObj, null, 2) + ",";
        
        document.getElementById('json-output').value = jsonString;
        document.getElementById('json-modal').style.display = 'flex';
    }

    function loadFromHistory(id) {
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        const item = history.find(i => i.id === id);
        if(item) {
            loadVideo(item.id, item.title);
        }
    }

    function loadVideo(id, title = "Video", category = "Other") {
        YOUTUBE_ID = id;
        VIDEO_TITLE = title;
        
        addToHistory(id, title, category);

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('player-ui').style.display = 'flex';
        
        STORAGE_KEY_TIME = 'mdc_time_' + YOUTUBE_ID;

        // Cargar notas guardadas
        const notesField = document.getElementById('video-notes');
        const savedNotes = localStorage.getItem('mdc_notes_' + YOUTUBE_ID) || '';
        notesField.value = savedNotes;
        // Ajustar altura inicial
        notesField.style.height = 'auto';
        notesField.style.height = (notesField.scrollHeight) + 'px';

        if(window.YT && window.YT.Player) {
            if(player) { 
                player.loadVideoById(id); 
                const savedTime = localStorage.getItem(STORAGE_KEY_TIME);
                if (savedTime) { player.seekTo(parseFloat(savedTime)); }
            } else { 
                onYouTubeIframeAPIReady(); 
            }
        } else {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);
        }
    }

    function goHome() {
        if(player && typeof player.pauseVideo === 'function') {
            player.pauseVideo();
            if(player.getCurrentTime) localStorage.setItem(STORAGE_KEY_TIME, player.getCurrentTime());
        }
        document.getElementById('player-ui').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'flex';
        renderHistoryList();
    }

    function addToHistory(id, title, category = 'Other') {
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        history = history.filter(item => item.id !== id);
        history.unshift({ id, title, category, date: new Date().getTime() });
        if(history.length > 50) history.pop(); 
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function updateHistoryTitle(id, newTitle) {
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        const idx = history.findIndex(i => i.id === id);
        if(idx !== -1) { history[idx].title = newTitle; localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }
    }

    function deleteHistoryItem(e, id) {
        e.stopPropagation();
        if(!confirm('¬øBorrar este video del historial?')) return;
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        history = history.filter(i => i.id !== id);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        renderHistoryList();
    }

    function renderHistoryList() {
        const list = document.getElementById('history-container');
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        
        const filteredHistory = (activeCategoryFilter === 'All') 
            ? history 
            : history.filter(item => (item.category || 'Other') === activeCategoryFilter);

        if(filteredHistory.length === 0) { list.innerHTML = '<div class="empty-history">No hay videos en esta categor√≠a.</div>'; return; }
        
        list.innerHTML = '';
        filteredHistory.forEach(item => {
            const date = new Date(item.date).toLocaleDateString();
            const cat = item.category || 'Other';
            const div = document.createElement('div');
            div.className = 'history-item';
            div.onclick = () => loadFromHistory(item.id);
            div.innerHTML = `
                <div class="h-thumb" style="background-image: url('https://img.youtube.com/vi/${item.id}/default.jpg')"></div>
                <div class="h-info">
                    <div class="h-title">${item.title}</div>
                    <div class="h-date">
                        <span class="h-tag">${cat}</span>
                        <span>${date}</span>
                    </div>
                </div>
                <button class="h-btn-del" onclick="deleteHistoryItem(event, '${item.id}')">‚úï</button>`;
            list.appendChild(div);
        });
    }

    function exportBackup() {
        const data = {};
        // Exportamos historial y notas
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key.startsWith('mdc_')) data[key] = localStorage.getItem(key);
        }
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `mdc_full_backup.json`;
        a.click();
    }

    function importBackup(input) {
        if(!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                Object.keys(data).forEach(key => localStorage.setItem(key, data[key]));
                alert("Restauraci√≥n completada."); location.reload();
            } catch(err) { alert("Archivo inv√°lido."); }
        };
        reader.readAsText(input.files[0]);
    }

    /* === FUNCION NOTAS === */
    function autoResizeAndSave(textarea) {
        // Auto-crecer
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        // Guardar
        if(YOUTUBE_ID) {
            localStorage.setItem('mdc_notes_' + YOUTUBE_ID, textarea.value);
        }
    }

    /* === YOUTUBE API === */
    window.onYouTubeIframeAPIReady = function() {
        if(!YOUTUBE_ID) return; 
        if(player && typeof player.destroy === 'function') { player.destroy(); }
        player = new YT.Player('player', {
            videoId: YOUTUBE_ID,
            playerVars: { playsinline: 1, rel: 0, modestbranding: 1, controls: 1, autoplay: 1 },
            events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
        });
    };

    function onPlayerReady(event) {
        const data = player.getVideoData();
        if(data && data.title) { 
            VIDEO_TITLE = data.title; 
            updateHistoryTitle(YOUTUBE_ID, data.title); 
        }
        const savedTime = localStorage.getItem(STORAGE_KEY_TIME);
        if (savedTime) { player.seekTo(parseFloat(savedTime)); }
    }

    let saveInterval;
    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) { 
            clearInterval(saveInterval);
            saveInterval = setInterval(() => {
                if(player && player.getCurrentTime) localStorage.setItem(STORAGE_KEY_TIME, player.getCurrentTime());
            }, 5000); 
        } else {
            clearInterval(saveInterval);
            if(player && player.getCurrentTime) localStorage.setItem(STORAGE_KEY_TIME, player.getCurrentTime());
        }
    }

    </script>
</body>
</html>
