<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LINGUA NEXUS | V24 Full Context Tracking</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== ESTILOS BASE ==================== */
        :root {
            --bg-deep: #050505; --bg-card: #121214; --bg-hover: #1f1f22; --bg-input: #18181b;
            --txt-main: #f4f4f5; --txt-sec: #71717a; --border: #27272a;
            --c-noun: #0ea5e9; --c-adj: #d946ef; --c-reg: #22c55e; --c-irreg:#f59e0b; --c-func: #6366f1; 
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; --purple: #a855f7;
            --font-head: 'Bebas Neue', sans-serif; --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        :root.light-mode {
            --bg-deep: #f8fafc; --bg-card: #ffffff; --bg-hover: #f1f5f9; --bg-input: #e2e8f0;
            --txt-main: #0f172a; --txt-sec: #64748b; --border: #e2e8f0;
            --c-noun: #0284c7; --c-adj: #c026d3; --c-reg: #16a34a; --c-irreg:#d97706; --c-func: #4f46e5; --c-mixed: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { background-color: var(--bg-deep); color: var(--txt-main); font-family: var(--font-ui); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }

        /* HEADER */
        header { height: 64px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; background: rgba(5,5,5,0.95); border-bottom: 1px solid var(--border); z-index: 50; backdrop-filter: blur(10px); }
        .brand-area { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .brand { font-family: var(--font-head); font-size: 26px; letter-spacing: 2px; color: var(--txt-main); text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .back-btn { display: none; color: var(--txt-sec); }
        body:not(.is-home) .back-btn { display: block; }
        body:not(.is-home) .brand { display: none; } 
        .header-actions { display: flex; gap: 20px; }
        .icon-btn { background: none; border: none; color: var(--txt-sec); cursor: pointer; padding: 0; transition: 0.2s; }
        .icon-btn.active { color: var(--primary); filter: drop-shadow(0 0 5px var(--primary)); }

        /* MAIN & SCROLL FIX */
        main { flex: 1; position: relative; width: 100%; overflow: hidden; }
        .view-screen { display: none; flex-direction: column; width: 100%; height: 100%; padding: 20px; padding-bottom: calc(40px + var(--safe-bottom)); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .view-screen.active { display: flex; }
        #view-game { overflow: hidden; padding-bottom: calc(20px + var(--safe-bottom)); }

        /* HOME UI */
        .welcome-text { margin-bottom: 30px; text-align: center; margin-top: 10px; }
        .welcome-text h1 { font-family: var(--font-head); font-size: 52px; margin: 0; line-height: 0.9; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .stat-pill { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
        .stat-val { font-family: var(--font-code); font-weight: 700; font-size: 24px; display: block; }
        .stat-lbl { font-size: 10px; font-weight: 600; color: var(--txt-sec); text-transform: uppercase; margin-top: 4px; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%; padding-bottom: 20px; }
        .menu-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .menu-card:active { transform: scale(0.96); }
        .card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 15px; background: rgba(255,255,255,0.05); }
        .menu-card h3 { margin: 0; font-family: var(--font-head); font-size: 28px; line-height: 1; letter-spacing: 1px; }
        .menu-card span { font-size: 12px; color: var(--txt-sec); font-weight: 500; margin-top: 6px; display: block; }

        .menu-card[data-type="noun"] { border-color: rgba(14, 165, 233, 0.3); color: var(--c-noun); } 
        .menu-card[data-type="adj"] { border-color: rgba(217, 70, 239, 0.3); color: var(--c-adj); }
        .menu-card[data-type="reg"] { border-color: rgba(34, 197, 94, 0.3); color: var(--c-reg); }
        .menu-card[data-type="irreg"] { border-color: rgba(245, 158, 11, 0.3); color: var(--c-irreg); }
        .menu-card[data-type="func"] { border-color: rgba(99, 102, 241, 0.3); color: var(--c-func); }
        .menu-card[data-type="mixed"] { border-color: var(--border); color: #fff; }
        .menu-card[data-type="folder"] { border-color: rgba(251, 191, 36, 0.3); color: var(--gold); }
        
        .menu-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; border-style: dashed; }

        /* FOLDER LIST UI */
        .folder-grid { display: grid; gap: 10px; }
        .folder-item { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .folder-item:active { transform: scale(0.98); background: var(--bg-hover); }
        .folder-info h4 { margin: 0; font-size: 18px; color: var(--txt-main); }
        .folder-info span { font-size: 12px; color: var(--txt-sec); font-weight: 600; }
        .folder-play { width: 40px; height: 40px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); }
        
        .folder-item.sys-all { border-color: var(--purple); background: linear-gradient(90deg, rgba(168, 85, 247, 0.05), transparent); }
        .folder-item.sys-all .folder-play { color: var(--purple); }
        .folder-item.sys-off { border-color: var(--c-noun); } .folder-item.sys-off .folder-play { color: var(--c-noun); }
        .folder-item.sys-imp { border-color: var(--gold); } .folder-item.sys-imp .folder-play { color: var(--gold); }

        /* SETTINGS & LIBRARY */
        .section-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; flex-shrink: 0; }
        .section-head { font-family: var(--font-head); font-size: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; letter-spacing: 1px; }
        .row-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .num-inp { background: var(--bg-input); border: 1px solid var(--border); color: var(--txt-main); border-radius: 8px; padding: 8px; width: 70px; text-align: center; font-family: var(--font-code); }
        .lib-search { width: 100%; background: var(--bg-card); border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: var(--txt-main); font-size: 16px; margin-bottom: 15px; flex-shrink: 0; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; flex-shrink: 0; }
        .filter-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; flex: 1; min-width: 50px; text-align: center; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 0 10px rgba(59,130,246,0.3); }
        
        .active-folder-banner { padding: 10px; background: rgba(251, 191, 36, 0.1); border: 1px solid var(--gold); color: var(--gold); font-size: 12px; font-weight: bold; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .active-folder-banner button { background: none; border: none; color: var(--txt-main); font-size: 18px; cursor: pointer; }

        .lib-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
        .lib-content { padding: 15px; }
        .lib-en { font-weight: 700; font-size: 16px; color: var(--txt-main); }
        .lib-es { font-size: 13px; color: var(--txt-sec); margin-top: 2px; }
        .prog-track { width: 100%; height: 4px; background: var(--bg-input); }
        .prog-fill { height: 100%; width: 0%; }
        .lvl-1 .prog-fill { background: var(--danger); } .lvl-2 .prog-fill { background: var(--c-irreg); }
        .lvl-3 .prog-fill { background: var(--primary); } .lvl-4 .prog-fill { background: var(--success); }
        .lib-badge { position: absolute; right: 15px; top: 15px; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: var(--bg-input); color: var(--txt-sec); }
        .load-more-btn { width: 100%; padding: 15px; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-main); border-radius: 12px; margin-top: 10px; cursor: pointer; font-weight: 700; font-size: 12px; letter-spacing: 1px; flex-shrink: 0; }
        .queue-grid { display: grid; gap: 8px; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-deep); border: 1px solid var(--border); padding: 10px 14px; border-radius: 8px; font-size: 14px; }
        .queue-tag { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; letter-spacing: 0.5px; }
        
        .tag-0 { background: var(--c-noun); color: #fff; } 
        .tag-1 { background: var(--danger); color: #fff; } 
        .tag-2 { background: var(--c-irreg); color: #000; } 
        .tag-3 { background: var(--primary); color: #fff; } 
        .tag-4 { background: var(--success); color: #fff; } 

        /* ==================== GAME UI ==================== */
        .game-top-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; z-index: 60; position: relative; flex-shrink: 0; }
        .stage-pill { display: inline-flex; padding: 6px 14px; border-radius: 100px; font-size: 11px; font-weight: 700; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); text-transform: uppercase; letter-spacing: 1px; }
        .timer-badge { font-family: var(--font-code); font-size: 12px; color: var(--primary); background: rgba(59, 130, 246, 0.1); padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); margin-left: 10px; font-weight: bold; }
        .audio-toggle-btn { background: var(--bg-card); border: 1px solid var(--border); width: 48px; height: 48px; border-radius: 12px; color: var(--txt-sec); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-left: auto; margin-right: 15px; }
        .audio-toggle-btn.active { background: var(--bg-input); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .mini-chart { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .chart-hole { width: 38px; height: 38px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; }
        #chart-pct { font-size: 10px; font-weight: 800; font-family: var(--font-code); color: var(--txt-main); }

        #game-layout-wrapper { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        #game-canvas-container { flex: 1; position: relative; width: 100%; background: #050505; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; box-shadow: inset 0 0 30px rgba(0,0,0,0.8); }
        canvas { display: block; width: 100%; height: 100%; }

        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 150px; flex-shrink: 0; padding: 5px; }
        
        /* PREMIUM BUTTONS */
        .ans-btn { 
            position: relative;
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); 
            border-bottom-color: rgba(255, 255, 255, 0.02); border-right-color: rgba(255, 255, 255, 0.02);
            color: var(--txt-main); padding: 12px; border-radius: 16px; font-size: 16px; font-weight: 700;
            letter-spacing: 0.5px; text-align: center; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; justify-content: center; 
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.15), inset 0 -2px 5px rgba(0, 0, 0, 0.2), 0 8px 20px rgba(0, 0, 0, 0.2), 0 0 0 1px transparent;
            backdrop-filter: blur(12px); text-shadow: 0 2px 4px rgba(0,0,0,0.3); overflow: hidden;
        }
        .ans-btn::after {
             content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
             background: linear-gradient(to bottom right, rgba(255,255,255,0.1) 0%, transparent 40%, transparent 100%);
             transform: rotate(30deg); pointer-events: none; transition: 0.5s; opacity: 0.6;
        }
        .ans-btn:hover::after { opacity: 1; transform: rotate(30deg) translate(10%, 10%); }
        .ans-btn:active { transform: translateY(4px) scale(0.97); box-shadow: inset 0 3px 6px rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.3); border-color: rgba(255, 255, 255, 0.05); }
        .ans-btn.correct-flash { background: linear-gradient(135deg, var(--success), #047857) !important; color: #fff !important; border: 1px solid #34d399 !important; box-shadow: 0 0 35px var(--success), inset 0 0 20px rgba(255,255,255,0.4) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5); z-index: 10; transform: translateY(0) scale(1.02); }
        .ans-btn.error-flash { background: linear-gradient(135deg, var(--danger), #991b1b) !important; color: #fff !important; border: 1px solid #f87171 !important; box-shadow: 0 0 35px var(--danger), inset 0 0 20px rgba(255,255,255,0.4) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    </style>
</head>
<body class="is-home">

    <script src="https://paradisonetworx.com/database.js"></script>

    <header>
        <div class="brand-area" onclick="Game.stop(); App.nav('home')">
            <svg class="back-btn" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path></svg>
            <div class="brand">LINGUA NEXUS</div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="Profile.toggleTheme()">
                <svg id="theme-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button id="btn-settings-nav" class="icon-btn" onclick="Game.stop(); App.nav('settings')">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <main>
        <div id="view-home" class="view-screen active">
            <div class="welcome-text"><h1>TRAINING HUB</h1></div>
            <div class="stats-row">
                <div class="stat-pill"><span class="stat-val" style="color:var(--success)" id="stat-m">0</span><span class="stat-lbl">Mastered</span></div>
                <div class="stat-pill"><span class="stat-val" style="color:var(--c-noun)" id="stat-t">0</span><span class="stat-lbl">Total Seen</span></div>
            </div>
            <div class="grid-menu">
                <div class="menu-card" data-type="noun" onclick="App.start('nouns')"><div class="card-icon">N</div><div><h3>NOUNS</h3><span>Objects & Things</span></div></div>
                <div class="menu-card" data-type="adj" onclick="App.start('adjectives')"><div class="card-icon">A</div><div><h3>ADJECTIVES</h3><span>Descriptions</span></div></div>
                <div class="menu-card" data-type="reg" onclick="App.start('verbs_reg')"><div class="card-icon">R</div><div><h3>REGULAR</h3><span>Standard Verbs</span></div></div>
                <div class="menu-card" data-type="irreg" onclick="App.start('verbs_irreg')"><div class="card-icon">I</div><div><h3>IRREGULAR</h3><span>Complex Forms</span></div></div>
                <div class="menu-card" data-type="func" onclick="App.start('functionals')"><div class="card-icon">L</div><div><h3>LOGIC & SYNTAX</h3><span>Connectors & Structure</span></div></div>
                <div class="menu-card" data-type="folder" onclick="App.nav('folders')"><div class="card-icon" style="color:var(--gold)">F</div><div><h3>MY FOLDERS</h3><span>Custom Collections</span></div></div>
            </div>
        </div>

        <div id="view-folders" class="view-screen">
            <div class="section-box" style="border-color: var(--gold);">
                <div class="section-head" style="color: var(--gold);">SELECT A FOLDER</div>
                <div id="folder-list-container" class="folder-grid">
                    </div>
            </div>
        </div>

        <div id="view-settings" class="view-screen">
            <div id="active-folder-display" class="active-folder-banner" style="display:none">
                <span id="active-folder-name">ACTIVE: NONE</span>
                <button onclick="App.clearFolderContext()">×</button>
            </div>

            <div class="section-box" style="border-color: var(--c-func);">
                <div class="section-head" style="color: var(--c-func);">ARCADE MODE SELECTION</div>
                <div class="row-ctrl">
                    <span class="row-lbl">Game Engine</span>
                    <select id="cfg-mode" class="num-inp" style="width:220px; text-align:left;" onchange="Profile.saveCfg()">
                        <option value="meteor">NEON FALL (Classic)</option>
                        <option value="bubble">ZERO GRAVITY (Float)</option>
                        <option value="orbit">ORBITAL DEFENSE (360°)</option>
                        <option value="flower">FLOWER POWER (Falling)</option>
                        <option value="heart">HEART FLOAT (Rising)</option>
                        <option value="butterfly">BUTTERFLY RING (360°)</option>
                    </select>
                </div>
                <div class="row-ctrl"><span class="row-lbl">Game Speed</span><select id="cfg-speed" class="num-inp" onchange="Profile.saveCfg()"><option value="1">Slow</option><option value="2">Normal</option><option value="3">Fast</option></select></div>
            </div>
            
            <div class="section-box">
                <div class="section-head">SESSION</div>
                <div class="row-ctrl"><span class="row-lbl">Words per Session</span><input type="number" id="cfg-count" class="num-inp" value="10" onchange="Profile.saveCfg()"></div>
                <div class="row-ctrl"><span class="row-lbl">Time Limit (Min)</span><input type="number" id="cfg-time" class="num-inp" value="0" onchange="Profile.saveCfg()"></div>
            </div>
            <div class="section-box"><div class="section-head">DANGER ZONE</div><div class="row-ctrl"><span class="row-lbl" style="color:var(--danger)">Reset All Progress</span><button onclick="Profile.wipe()" style="background:var(--danger); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:bold;">WIPE</button></div></div>
            <div class="section-box" style="border-color: var(--primary);"><div class="section-head" style="color:var(--primary)">UP NEXT IN QUEUE</div><div id="study-queue-list" class="queue-grid"></div></div>
            <input type="text" id="inp-search" class="lib-search" placeholder="Search Database..." onkeyup="App.resetRender()">
            <div class="filter-bar"><button class="filter-btn active" onclick="App.setLibFilter('all', this)">ALL</button><button class="filter-btn" onclick="App.setLibFilter(0, this)">LVL 0</button><button class="filter-btn" onclick="App.setLibFilter(1, this)">LVL 1</button><button class="filter-btn" onclick="App.setLibFilter(2, this)">LVL 2</button><button class="filter-btn" onclick="App.setLibFilter(3, this)">LVL 3</button><button class="filter-btn" onclick="App.setLibFilter(4, this)">LVL 4</button></div>
            <div id="lib-list" style="padding-bottom:20px;"></div><button id="btn-load-more" class="load-more-btn" onclick="App.renderMore()">LOAD MORE...</button>
        </div>

        <div id="view-game" class="view-screen">
            <div class="game-top-bar">
                <div class="stage-pill" id="game-cat-pill">CATEGORY</div>
                <div class="timer-badge" id="game-timer" style="display:none">00:00</div>
                <button id="btn-audio-mode" class="audio-toggle-btn active" onclick="App.toggleAudioMode()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
                </button>
                <div class="mini-chart" id="game-chart"><div class="chart-hole"><span id="chart-pct">0%</span></div></div>
            </div>
            <div id="game-layout-wrapper">
                <div id="game-canvas-container"><canvas id="game-canvas"></canvas></div>
                <div class="answers-grid" id="control-dock"></div>
            </div>
        </div>
    </main>

<script>
// --- DB & PROFILE ---
const DB = {
    data: {},
    customData: [],
    async init() {
        // Load Custom Data (MDC Vocab List) from LocalStorage
        try {
            this.customData = JSON.parse(localStorage.getItem('mdc_vocab_list') || '[]');
        } catch(e) { this.customData = []; }

        return new Promise(r => {
            const t = setInterval(() => {
                if (typeof INTERNAL_VOCAB !== 'undefined') {
                    this.data = INTERNAL_VOCAB;
                    clearInterval(t);
                    r();
                }
            }, 50);
        });
    },
    // NEW: Get flattened words from a specific folder by ID (or SYSTEM ID)
    getFolderWords(folderId) {
        // --- SYSTEM FOLDERS: GLOBAL MIX ---
        if (folderId === 'sys_official') {
            let all = [];
            Object.keys(this.data).forEach(k => all = all.concat(this.data[k].map(x => ({...x, cat: 'official'}))));
            return all;
        }
        if (folderId === 'sys_custom') {
            let all = [];
            const extract = (list) => {
                list.forEach(i => {
                    if(i.isFolder && i.items) extract(i.items);
                    else if(i.eng) all.push({ en: i.eng, es: i.esp, cat: 'custom' });
                });
            };
            extract(this.customData);
            return all;
        }
        if (folderId === 'sys_everything') {
            const off = this.getFolderWords('sys_official');
            const cus = this.getFolderWords('sys_custom');
            return off.concat(cus);
        }

        // --- STANDARD USER FOLDERS ---
        let words = [];
        const findFolder = (list) => {
            for(let item of list) {
                if(item.isFolder) {
                    if(item.id === folderId) return item.items || [];
                    const found = findFolder(item.items || []);
                    if(found) return found;
                }
            }
            return null;
        };
        const rawItems = findFolder(this.customData);
        if(!rawItems) return [];

        // Flatten recursion
        const extract = (list) => {
            list.forEach(i => {
                if(i.isFolder && i.items) extract(i.items);
                else if(i.eng) words.push({ en: i.eng, es: i.esp, cat: 'custom' });
            });
        };
        extract(rawItems);
        return words;
    },
    // NEW: Get list of folders
    getFolderList() {
        let folders = [];
        const extract = (list) => {
            list.forEach(i => {
                if(i.isFolder) {
                    // Count words inside
                    let count = 0;
                    const c = (sub) => sub.forEach(x => { if(x.isFolder && x.items) c(x.items); else if(x.eng) count++; });
                    if(i.items) c(i.items);
                    folders.push({ id: i.id, name: i.name, count: count });
                    if(i.items) extract(i.items);
                }
            });
        };
        extract(this.customData);
        return folders;
    },
    get(cat) {
        // Standard Categories
        const k = { nouns: 'NOUNS', adjectives: 'ADJECTIVES', verbs_reg: 'REGULAR_VERBS', verbs_irreg: 'IRREGULAR_VERBS', functionals: 'FUNCTION WORDS' };
        if (cat === 'mixed') {
            let a = [];
            Object.keys(k).forEach(key => { a = a.concat((this.data[k[key]] || []).map(x => ({ ...x, cat: key }))); });
            return a;
        }
        return (this.data[k[cat]] || []).map(x => ({ ...x, cat }));
    },
    all() {
        // Fallback for search if no context is active
        let a = [];
        Object.keys(this.data).forEach(k => a = a.concat(this.data[k]));
        return a;
    }
};

const Profile = {
    cfg: { count: 10, time: 0, theme: 'dark', prog: {}, speed: 2, gameMode: 'meteor' },
    load() {
        const s = localStorage.getItem('LN_V7');
        if (s) this.cfg = { ...this.cfg, ...JSON.parse(s) };
        this.applyDecay();
        this.applyTheme();
        const elC = document.getElementById('cfg-count'), elSp = document.getElementById('cfg-speed'), elT = document.getElementById('cfg-time'), elM = document.getElementById('cfg-mode');
        if (elC) elC.value = this.cfg.count;
        if (elSp) elSp.value = this.cfg.speed || 2;
        if (elT) elT.value = this.cfg.time || 0;
        if (elM) elM.value = this.cfg.gameMode || 'meteor';
        this.calcStats();
    },
    saveCfg() {
        this.cfg.count = parseInt(document.getElementById('cfg-count').value) || 10;
        this.cfg.speed = parseInt(document.getElementById('cfg-speed').value) || 2;
        this.cfg.time = parseInt(document.getElementById('cfg-time').value) || 0;
        this.cfg.gameMode = document.getElementById('cfg-mode').value;
        this.save();
        App.renderQueue();
    },
    save() { localStorage.setItem('LN_V7', JSON.stringify(this.cfg)); },
    applyTheme() {
        const d = document.documentElement, i = document.getElementById('theme-icon');
        if (this.cfg.theme === 'light') {
            d.classList.add('light-mode');
            if (i) i.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>';
        } else {
            d.classList.remove('light-mode');
            if (i) i.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        }
    },
    toggleTheme() { this.cfg.theme = this.cfg.theme === 'dark' ? 'light' : 'dark'; this.applyTheme(); this.save(); },
    getData(w) { let v = this.cfg.prog[w]; if (v === undefined) return { lvl: 0, date: 0 }; if (typeof v === 'number') return { lvl: v, date: 0 }; return v; },
    setProg(w, ok) {
        let e = this.getData(w), l = e.lvl;
        if (ok) { if (l < 4) l++; } else { l = Math.max(0, l - 1); }
        this.cfg.prog[w] = { lvl: l, date: Date.now() };
        this.save();
        this.calcStats();
    },
    getLvl(w) { return this.getData(w).lvl; },
    getDate(w) { return this.getData(w).date; },
    wipe() { if (confirm("Clear progress?")) { this.cfg.prog = {}; this.save(); App.nav('home'); } },
    calcStats() {
        const k = Object.keys(this.cfg.prog), m = k.filter(x => this.getData(x).lvl === 4).length, elM = document.getElementById('stat-m'), elT = document.getElementById('stat-t');
        if (elM) elM.innerText = m;
        if (elT) elT.innerText = k.length;
    },
    applyDecay() {
        const NOW = Date.now(), DECAY = 30 * 24 * 60 * 60 * 1000;
        let ch = false;
        Object.keys(this.cfg.prog).forEach(w => {
            let e = this.cfg.prog[w];
            if (typeof e === 'object' && e.lvl === 4 && NOW - e.date > DECAY) { e.lvl = 3; e.date = NOW; ch = true; }
        });
        if (ch) this.save();
    }
};

const App = {
    audioMode: true,
    activeFolderContext: null, // NEW: Tracks selected folder info for settings view { id, name }
    
    async boot() { await DB.init(); Profile.load(); this.nav('home'); },
    nav(v) {
        document.querySelectorAll('.view-screen').forEach(e => e.classList.remove('active'));
        document.getElementById('view-' + v).classList.add('active');
        document.body.className = (v === 'home') ? 'is-home' : '';
        const btn = document.getElementById('btn-settings-nav');
        if (v === 'settings') {
            btn.classList.add('active');
            
            // Check context
            const banner = document.getElementById('active-folder-display');
            const nameSpan = document.getElementById('active-folder-name');
            if(this.activeFolderContext) {
                banner.style.display = 'flex';
                nameSpan.innerText = "ACTIVE: " + this.activeFolderContext.name;
            } else {
                banner.style.display = 'none';
            }

            this.setLibFilter('all', document.querySelector('.filter-bar .filter-btn'));
            this.renderQueue();
        } else {
            btn.classList.remove('active');
        }
        
        if (v === 'folders') {
            this.renderFolderList();
        }
        
        // If going Home, clear context
        if (v === 'home') {
            this.activeFolderContext = null; 
        }
    },
    toggleAudioMode() { this.audioMode = !this.audioMode; const btn = document.getElementById('btn-audio-mode'); if (this.audioMode) { btn.classList.add('active'); btn.style.opacity = '1'; } else { btn.classList.remove('active'); btn.style.opacity = '0.5'; } },
    
    renderFolderList() {
        const c = document.getElementById('folder-list-container');
        c.innerHTML = '';
        
        const sysFolders = [
            { id: 'sys_everything', name: 'ULTIMATE DATABASE (ALL)', class: 'sys-all', count: 'FULL' },
            { id: 'sys_official', name: 'OFFICIAL DB (FULL)', class: 'sys-off', count: 'INT' },
            { id: 'sys_custom', name: 'IMPORTED DB (FULL)', class: 'sys-imp', count: 'EXT' }
        ];

        sysFolders.forEach(f => {
            const div = document.createElement('div');
            div.className = `folder-item ${f.class}`;
            div.innerHTML = `
                <div class="folder-info"><h4>${f.name}</h4><span style="font-weight:800; opacity:0.7;">${f.count}</span></div>
                <div class="folder-play" onclick="event.stopPropagation(); App.selectFolderForSettings('${f.id}', '${f.name}')"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
            `;
            // Main click starts game
            div.onclick = () => this.startFolder(f.id, f.name);
            c.appendChild(div);
        });

        const folders = DB.getFolderList();
        if(folders.length > 0) {
            const sep = document.createElement('div');
            sep.style.cssText = "margin-top:15px; margin-bottom:5px; font-size:11px; font-weight:700; color:var(--txt-sec); text-transform:uppercase; letter-spacing:1px;";
            sep.innerText = "YOUR COLLECTIONS";
            c.appendChild(sep);

            folders.forEach(f => {
                const div = document.createElement('div');
                div.className = 'folder-item';
                div.innerHTML = `
                    <div class="folder-info"><h4>${f.name}</h4><span>${f.count} Words</span></div>
                    <div class="folder-play" onclick="event.stopPropagation(); App.selectFolderForSettings('${f.id}', '${f.name}')"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                `;
                div.onclick = () => this.startFolder(f.id, f.name);
                c.appendChild(div);
            });
        }
    },

    // NEW: User clicks the GEAR icon on a folder to view it in Settings/Library
    selectFolderForSettings(fid, fname) {
        this.activeFolderContext = { id: fid, name: fname };
        this.nav('settings');
    },
    
    // NEW: Clear selection
    clearFolderContext() {
        this.activeFolderContext = null;
        this.nav('settings'); // Refresh view
    },

    // NEW: Helper to get data based on current context
    getContextData() {
        if (this.activeFolderContext) {
            return DB.getFolderWords(this.activeFolderContext.id);
        } else {
            // Default "Mixed" view if no specific folder selected
            return DB.get('mixed'); 
        }
    },

    startFolder(fid, fname) {
        const raw = DB.getFolderWords(fid);
        if(raw.length === 0) return alert("Folder is empty!");
        this.runGame(raw, 'custom', fname);
    },

    start(cat) {
        const raw = DB.get(cat);
        this.runGame(raw, cat, cat === 'mixed' ? "MIXED BAG" : cat.toUpperCase());
    },

    runGame(raw, catKey, title) {
        // Deep copy raw to avoid mutation issues if reused
        let gameData = JSON.parse(JSON.stringify(raw));
        
        for (let i = gameData.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [gameData[i], gameData[j]] = [gameData[j], gameData[i]]; }
        
        const sorted = gameData.sort((a, b) => {
            const ga = (l = Profile.getLvl(a.en)) => l > 0 && l < 4 ? 1 : l === 0 ? 2 : 3;
            const gb = (l = Profile.getLvl(b.en)) => l > 0 && l < 4 ? 1 : l === 0 ? 2 : 3;
            if (ga(Profile.getLvl(a.en)) !== gb(Profile.getLvl(b.en))) return ga(Profile.getLvl(a.en)) - gb(Profile.getLvl(b.en));
            return Profile.getDate(a.en) - Profile.getDate(b.en);
        });
        
        const queue = sorted.slice(0, Profile.cfg.count);
        if (queue.length === 0) return alert("No words available.");
        
        this.nav('game');
        
        const pills = { nouns: '--c-noun', adjectives: '--c-adj', verbs_reg: '--c-reg', verbs_irreg: '--c-irreg', functionals: '--c-func', mixed: '--c-mixed', custom: '--gold' };
        const p = document.getElementById('game-cat-pill');
        const cVar = (catKey === 'custom' || !pills[catKey]) ? '--gold' : pills[catKey];
        
        p.innerText = title;
        p.style.color = `var(${cVar})`; p.style.borderColor = `var(${cVar})`;
        
        Game.init(queue, catKey, `var(${cVar})`, sorted); 
        this.updateChart(queue);
    },

    updateChart(sourceData) {
        const t = sourceData.length;
        const c = [0, 0, 0, 0, 0];
        if (t === 0) return;
        sourceData.forEach(w => c[Profile.getLvl(w.en)]++);
        const p4 = c[4] / t * 100;
        const p3 = c[3] / t * 100;
        const p2 = c[2] / t * 100;
        const p1 = c[1] / t * 100;
        const domChart = document.getElementById('game-chart');
        if (domChart) {
            domChart.style.background = `conic-gradient(var(--success) 0% ${p4}%, var(--primary) ${p4}% ${p4 + p3}%, var(--c-irreg) ${p4 + p3}% ${p4 + p3 + p2}%, var(--danger) ${p4 + p3 + p2}% ${p4 + p3 + p2 + p1}%, var(--bg-input) ${p4 + p3 + p2 + p1}% 100%)`;
            document.getElementById('chart-pct').innerText = Math.round(p4) + '%';
        }
    },
    
    // UPDATED: Now uses getContextData for accurate searching
    setLibFilter(lvl, btn) { this.filterLvl = lvl; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); if (btn) btn.classList.add('active'); this.resetRender(); },
    resetRender() { this.renderCount = 50; this.calculateFilteredList(); this.renderLib(); },
    renderMore() { this.renderCount += 50; this.renderLib(); },
    
    calculateFilteredList() { 
        const s = document.getElementById('inp-search').value; 
        const term = s.toLowerCase(); 
        
        // Context Awareness
        const sourceList = this.getContextData(); // Uses Active Folder or Mixed
        
        this.filteredResults = sourceList.filter(x => { 
            const matchesText = !s || x.en.toLowerCase().includes(term); 
            if (!matchesText) return false; 
            if (this.filterLvl === 'all') return true; 
            return Profile.getLvl(x.en) === this.filterLvl; 
        }); 
    },
    
    renderLib() { const c = document.getElementById('lib-list'); c.innerHTML = ''; const btnMore = document.getElementById('btn-load-more'); if (this.filteredResults.length > this.renderCount) { btnMore.style.display = 'block'; btnMore.innerText = `LOAD MORE (${this.filteredResults.length - this.renderCount} REMAINING)`; } else { btnMore.style.display = 'none'; } const frag = document.createDocumentFragment(); this.filteredResults.slice(0, this.renderCount).forEach(w => { const l = Profile.getLvl(w.en); const pct = l * 25; const d = document.createElement('div'); d.className = `lib-card lvl-${l}`; d.innerHTML = `<div class="lib-content"><span class="lib-badge">LVL ${l}</span><div class="lib-en">${w.en}</div><div class="lib-es">${Array.isArray(w.es) ? w.es[0] : w.es}</div></div><div class="prog-track"><div class="prog-fill" style="width:${pct}%"></div></div>`; frag.appendChild(d); }); c.appendChild(frag); },
    
    // UPDATED: Uses context for UP NEXT list
    renderQueue() {
        // Context Awareness for Queue
        let raw = this.getContextData();
        
        // Shuffle & Sort Logic duplicated here for preview consistency
        for (let i = raw.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [raw[i], raw[j]] = [raw[j], raw[i]]; }
        const sorted = raw.sort((a, b) => {
            const ga = (l = Profile.getLvl(a.en)) => l > 0 && l < 4 ? 1 : l === 0 ? 2 : 3;
            const gb = (l = Profile.getLvl(b.en)) => l > 0 && l < 4 ? 1 : l === 0 ? 2 : 3;
            if (ga(Profile.getLvl(a.en)) !== gb(Profile.getLvl(b.en))) return ga(Profile.getLvl(a.en)) - gb(Profile.getLvl(b.en));
            return Profile.getDate(a.en) - Profile.getDate(b.en);
        });

        const sessionLimit = Profile.cfg.count;
        const nextBatch = sorted.slice(0, sessionLimit);
        const container = document.getElementById('study-queue-list');
        if (!container) return;
        container.innerHTML = '';
        if (nextBatch.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--txt-sec)">No words available.</div>';
            return;
        }
        const countInfo = document.createElement('div');
        countInfo.style.cssText = "font-size:11px; color:var(--primary); margin-bottom:10px; font-weight:700;";
        countInfo.innerText = `NEXT ${nextBatch.length} WORDS (BASED ON SETTINGS):`;
        container.appendChild(countInfo);
        nextBatch.forEach(w => {
            const lvl = Profile.getLvl(w.en);
            let tagClass = 'tag-' + lvl; 
            let tagText = lvl === 0 ? 'NEW' : (lvl === 4 ? 'MASTER' : `LVL ${lvl}`);
            const div = document.createElement('div');
            div.className = 'queue-item';
            div.innerHTML = `<div><span style="font-weight:700; color:var(--txt-main)">${w.en}</span></div><div class="queue-tag ${tagClass}">${tagText}</div>`;
            container.appendChild(div);
        });
    },
    
    // Kept for backward compatibility if needed, but getContextData is preferred now
    getSortedData(cat) {
        let raw = DB.get(cat);
        for (let i = raw.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [raw[i], raw[j]] = [raw[j], raw[i]]; }
        return raw.sort((a, b) => {
            const la = Profile.getLvl(a.en);
            const lb = Profile.getLvl(b.en);
            const getGroup = (l) => { if (l > 0 && l < 4) return 1; if (l === 0) return 2; return 3; };
            const ga = getGroup(la);
            const gb = getGroup(lb);
            if (ga !== gb) return ga - gb;
            return Profile.getDate(a.en) - Profile.getDate(b.en);
        });
    }
};

// ==================== GAME ENGINE V24 (STABLE + CONTEXT) ====================
const Game = {
    canvas: null, ctx: null, queue: [], pool: [], fullList: [], idx: 0,
    width: 0, height: 0, loopId: null, lastTime: 0,
    activeWord: null, particles: [], stars: [], laser: null, ghosts: [], shockwaves: [], clouds: [],
    score: 0, startTime: 0, timeLimit: 0, themeColor: '#fff',
    flashIntensity: 0, combo: 0, gridOffset: 0, showingGhost: false,
    category: '', timerId: null, isPlaying: false,

    init(queue, cat, colorVar, fullList) {
        this.queue = queue; 
        this.category = cat; 
        this.fullList = fullList; 
        
        this.pool = (cat === 'custom' || cat === 'mixed') ? (this.fullList.length > 4 ? this.fullList : DB.all()) : DB.all();
        
        this.idx = 0; this.score = 0; this.ghosts = []; this.shockwaves = []; this.combo = 0;
        this.showingGhost = false;
        this.isPlaying = true;
        
        this.canvas = document.getElementById('game-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        
        this.mode = Profile.cfg.gameMode || 'meteor';
        this.speedMult = Profile.cfg.speed === 1 ? 0.6 : (Profile.cfg.speed === 3 ? 1.5 : 1.0);
        this.startTime = Date.now();
        this.timeLimit = Profile.cfg.time * 60 * 1000;
        
        const tempDiv = document.createElement('div'); tempDiv.style.color = colorVar; document.body.appendChild(tempDiv);
        this.themeColor = getComputedStyle(tempDiv).color; document.body.removeChild(tempDiv);
        
        if (this.mode === 'flower' || this.mode === 'heart' || this.mode === 'butterfly') {
            const pastels = { '--c-noun': '#93c5fd', '--c-adj': '#f0abfc', '--c-reg': '#86efac', '--c-irreg': '#fcd34d', '--c-func': '#a5b4fc', '--primary': '#fda4af', '--gold': '#fcd34d' };
            const varName = colorVar.replace('var(', '').replace(')', '');
            this.themeColor = pastels[varName] || this.themeColor;
        }

        document.getElementById('game-timer').style.display = this.timeLimit > 0 ? 'block' : 'none';

        this.stars = [];
        for (let i = 0; i < 80; i++) this.stars.push({ x: Math.random() * this.width, y: Math.random() * this.height, size: Math.random() * 2, speed: 0.2 + Math.random() * 0.5 });
        
        this.clouds = [];
        if (this.mode === 'flower' || this.mode === 'heart' || this.mode === 'butterfly') {
            for (let i = 0; i < 5; i++) this.clouds.push({ x: Math.random() * this.width, y: Math.random() * this.height, size: 30 + Math.random() * 50, speed: 0.1 + Math.random() * 0.1 });
        }

        this.spawn();
        this.lastTime = performance.now();
        this.loopId = requestAnimationFrame(t => this.loop(t));
    },

    resize() {
        const con = document.getElementById('game-canvas-container');
        this.canvas.width = con.offsetWidth; this.canvas.height = con.offsetHeight;
        this.width = this.canvas.width; this.height = this.canvas.height;
    },

    stop() { 
        this.isPlaying = false; 
        cancelAnimationFrame(this.loopId); 
        clearTimeout(this.timerId); 
        this.activeWord = null; 
    },

    spawn() {
        if (!this.isPlaying) return;
        if (this.showingGhost) return;

        if (this.idx >= this.queue.length) {
            this.idx = 0; 
            if (this.timeLimit === 0 && this.queue.every(w => Profile.getLvl(w.en) === 4)) {
                alert("SESSION COMPLETE! ALL WORDS MASTERED.");
                this.stop();
                App.nav('home');
                return;
            }
        }

        const data = this.queue[this.idx];
        const size = 60;
        let x, y, vx, vy;

        if (this.mode === 'orbit' || this.mode === 'butterfly') {
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.max(this.width, this.height) / 2 + size + 20;
            x = (this.width / 2) + Math.cos(angle) * dist;
            y = (this.height / 2) + Math.sin(angle) * dist;
            const dx = (this.width / 2) - x; const dy = (this.height / 2) - y;
            const mag = Math.hypot(dx, dy);
            vx = (dx / mag) * (0.8 * this.speedMult);
            vy = (dy / mag) * (0.8 * this.speedMult);
        } else {
            x = size + Math.random() * (this.width - size * 2);
            const isFalling = (this.mode === 'meteor' || this.mode === 'flower');
            y = isFalling ? -60 : this.height + 60;
            vx = (Math.random() - 0.5) * 0.5;
            vy = isFalling ? (1 + Math.random()) * this.speedMult : (-1 - Math.random()) * this.speedMult;
        }
        
        this.activeWord = {
            data: data, x: x, y: y, vx: vx, vy: vy,
            rot: 0, rotSpeed: (Math.random() - 0.5) * 0.02,
            size: size, color: this.themeColor,
            trail: []
        };
        this.renderButtons(data);
    },

    renderButtons(correct) {
        const dock = document.getElementById('control-dock'); dock.innerHTML = '';
        let opts = [correct]; let i = 0;
        while (opts.length < 4 && i < 100) { const r = this.pool[Math.floor(Math.random() * this.pool.length)]; if (!opts.find(x => x.en === r.en)) opts.push(r); i++; }
        opts.sort(() => Math.random() - 0.5);
        opts.forEach(opt => {
            const btn = document.createElement('button'); btn.className = 'ans-btn';
            btn.innerText = Array.isArray(opt.es) ? opt.es[0] : opt.es;
            btn.onclick = () => this.fire(opt, correct, btn);
            dock.appendChild(btn);
        });
    },

    spawnGhost(x, y, text) {
        if (!this.isPlaying) return;
        if (this.showingGhost) return;
        let gx = Math.max(50, Math.min(this.width - 50, x));
        let gy = Math.max(50, Math.min(this.height - 50, y));
        let ghostText = Array.isArray(text) ? text[0] : text;
        this.ghosts.push({ x: gx, y: gy, text: ghostText, life: 1.0, vy: -0.5 });
        this.showingGhost = true;
    },

    triggerShockwave(x, y, color) {
        this.shockwaves.push({ x: x, y: y, radius: 10, alpha: 1.0, color: color });
    },

    replaceMasteredWord(oldWordEn) {
        const indexToRemove = this.queue.findIndex(w => w.en === oldWordEn);
        if (indexToRemove === -1) return;
        this.queue.splice(indexToRemove, 1);
        const candidates = this.fullList.filter(w => !this.queue.find(qw => qw.en === w.en));
        if (candidates.length > 0) { this.queue.push(candidates[0]); }
        if (indexToRemove < this.idx) { this.idx--; } else if (indexToRemove === this.idx) { this.idx--; }
    },

    fire(sel, cor, btn) {
        if (!this.activeWord) return;
        const rect = btn.getBoundingClientRect(); const canRect = this.canvas.getBoundingClientRect();
        
        let ox = (rect.left + rect.width / 2) - canRect.left;
        let oy = this.height;
        if (this.mode === 'orbit' || this.mode === 'butterfly') { ox = this.width / 2; oy = this.height / 2; }

        const isFem = (this.mode === 'flower' || this.mode === 'heart' || this.mode === 'butterfly');
        const laserColor = sel.en === cor.en ? (isFem ? '#86efac' : '#10b981') : (isFem ? '#fda4af' : '#ef4444');

        this.laser = { x1: ox, y1: oy, x2: this.activeWord.x, y2: this.activeWord.y, life: 1.0, color: laserColor, time: 0 };

        if (sel.en === cor.en) {
            btn.classList.add('correct-flash');
            if (App.audioMode) this.speak(cor.en);
            this.triggerShockwave(this.activeWord.x, this.activeWord.y, this.activeWord.color);
            this.flashIntensity = 0.3;
            this.combo++;
            this.createExplosion(this.activeWord.x, this.activeWord.y, this.activeWord.color);
            
            Profile.setProg(cor.en, true);
            const newLvl = Profile.getLvl(cor.en);
            if (newLvl === 4) { this.replaceMasteredWord(cor.en); }
            
            App.updateChart(this.queue);
            this.activeWord = null; this.idx++; 
            if (!this.showingGhost) this.timerId = setTimeout(() => this.spawn(), 500);
        } else {
            btn.classList.add('error-flash');
            this.screenShake();
            this.spawnGhost(this.activeWord.x, this.activeWord.y, cor.es);
            this.combo = 0;
        }
    },

    createExplosion(x, y, color) {
        for (let i = 0; i < 25; i++) {
            const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 2;
            this.particles.push({ x: x, y: y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 1.0, color: color, size: Math.random() * 4 });
        }
    },

    fail() {
        if (App.audioMode) this.speak(this.activeWord.data.en);
        this.screenShake();
        this.spawnGhost(this.activeWord.x, this.activeWord.y, this.activeWord.data.es);
        Profile.setProg(this.activeWord.data.en, false);
        App.updateChart(this.queue);
        this.createExplosion(this.activeWord.x, this.activeWord.y, '#555');
        this.activeWord = null; this.idx++; this.combo = 0;
    },

    speak(txt) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-US'; u.rate = 1.1; window.speechSynthesis.speak(u); },
    screenShake() { const c = document.getElementById('game-canvas'); c.style.transform = `translate(${Math.random() * 10 - 5}px, ${Math.random() * 10 - 5}px)`; setTimeout(() => c.style.transform = 'none', 200); },

    // --- DRAWING HELPERS ---
    drawGrid(ctx) {
        ctx.strokeStyle = "rgba(59, 130, 246, 0.2)"; ctx.lineWidth = 1;
        const horizon = this.height * 0.4; const speed = 2;
        this.gridOffset = (this.gridOffset + speed) % 40;
        for (let x = -this.width; x < this.width * 2; x += 80) { ctx.beginPath(); ctx.moveTo(x, this.height); ctx.lineTo(this.width / 2 + (x - this.width / 2) * 0.2, horizon); ctx.stroke(); }
        for (let z = 0; z < this.height; z += 40) {
            let y = (z + this.gridOffset) % this.height; if (y < horizon) continue;
            let perspectiveY = horizon + Math.pow((y - horizon) / (this.height - horizon), 2) * (this.height - horizon);
            ctx.beginPath(); ctx.moveTo(0, perspectiveY); ctx.lineTo(this.width, perspectiveY); ctx.stroke();
        }
        const grad = ctx.createLinearGradient(0, horizon, 0, this.height); grad.addColorStop(0, "rgba(5,5,5,1)"); grad.addColorStop(0.2, "rgba(5,5,5,0)");
        ctx.fillStyle = grad; ctx.fillRect(0, horizon, this.width, this.height - horizon);
    },

    drawClouds(ctx) {
        this.clouds.forEach(c => {
            c.x += c.speed; if (c.x > this.width + 100) c.x = -100;
            ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
            ctx.beginPath(); ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2); ctx.arc(c.x + c.size * 0.8, c.y - c.size * 0.2, c.size * 0.7, 0, Math.PI * 2); ctx.arc(c.x - c.size * 0.8, c.y - c.size * 0.2, c.size * 0.7, 0, Math.PI * 2); ctx.fill();
        });
    },

    drawHeart(ctx, x, y, size, color) {
        const scale = 1 + Math.sin(Date.now() * 0.002) * 0.05;
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.beginPath(); var h = size * 0.3; ctx.moveTo(0, h);
        ctx.bezierCurveTo(0, 0, -size / 2, 0, -size / 2, h);
        ctx.bezierCurveTo(-size / 2, (size + h) / 2, 0, (size + h) / 2, 0, size);
        ctx.bezierCurveTo(0, (size + h) / 2, size / 2, (size + h) / 2, size / 2, h);
        ctx.bezierCurveTo(size / 2, 0, 0, 0, 0, h);
        ctx.closePath(); ctx.fillStyle = color; ctx.fill();
        ctx.restore();
    },
    drawFlower(ctx, x, y, size, color) {
        const p = size / 2.5; ctx.fillStyle = color;
        ctx.save(); ctx.translate(x, y); ctx.rotate(Date.now() * 0.0005);
        for (let i = 0; i < 5; i++) { ctx.beginPath(); ctx.ellipse(Math.cos(i * 2 * Math.PI / 5) * p, Math.sin(i * 2 * Math.PI / 5) * p, p, p / 2, i * 2 * Math.PI / 5, 0, 2 * Math.PI); ctx.fill(); }
        ctx.beginPath(); ctx.arc(0, 0, size / 4, 0, Math.PI * 2); ctx.fillStyle = '#fffbea'; ctx.fill();
        ctx.restore();
    },
    drawButterfly(ctx, x, y, size, color) {
        const flap = Math.abs(Math.sin(Date.now() * 0.0025));
        ctx.save(); ctx.translate(x, y);
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.ellipse(-size / 3, -size / 4, size / 2 * flap, size / 3, -Math.PI / 4, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(-size / 3, size / 4, size / 2.5 * flap, size / 4, Math.PI / 4, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(size / 3, -size / 4, size / 2 * flap, size / 3, Math.PI / 4, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(size / 3, size / 4, size / 2.5 * flap, size / 4, -Math.PI / 4, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.ellipse(0, 0, size / 8, size / 2, 0, 0, Math.PI * 2); ctx.fill();
        ctx.restore();
    },

    // --- NEW THICK WEB LASER ---
    drawWebLaser(ctx, l) {
        const dist = Math.hypot(l.x2 - l.x1, l.y2 - l.y1);
        const angle = Math.atan2(l.y2 - l.y1, l.x2 - l.x1);
        const baseFreq = 0.05;
        const baseAmp = 15 * l.life;

        ctx.shadowBlur = 20; ctx.shadowColor = l.color;

        const drawStrand = (lineWidth, opacityMult, freqOffset, ampMult) => {
            ctx.beginPath(); ctx.strokeStyle = l.color; ctx.lineWidth = lineWidth; ctx.globalAlpha = l.life * opacityMult;
            for (let i = 0; i <= dist; i += 8) {
                const currentFreq = baseFreq + freqOffset; const currentAmp = baseAmp * ampMult;
                const wobble = Math.sin(i * 0.1 + l.time * 2) * 5 * l.life;
                const x = l.x1 + Math.cos(angle) * i - Math.sin(angle) * (Math.sin(i * currentFreq + l.time) * currentAmp + wobble);
                const y = l.y1 + Math.sin(angle) * i + Math.cos(angle) * (Math.sin(i * currentFreq + l.time) * currentAmp + wobble);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
        };

        drawStrand(6, 0.6, 0, 1.0); // Main core
        drawStrand(3, 1.0, 0.02, 1.2); // Strand 1
        drawStrand(3, 1.0, -0.02, 0.8); // Strand 2

        ctx.globalAlpha = 1.0; ctx.shadowBlur = 0; l.time += 0.05;
    },

    loop(now) {
        if (!this.isPlaying) return;

        const dt = (now - this.lastTime) / 16; this.lastTime = now;
        this.ctx.fillStyle = '#050505'; this.ctx.fillRect(0, 0, this.width, this.height);
        
        // --- 1. BACKGROUNDS ---
        const isFem = (this.mode === 'flower' || this.mode === 'heart' || this.mode === 'butterfly');
        if (!isFem) this.drawGrid(this.ctx);
        if (isFem) {
            const grad = this.ctx.createLinearGradient(0, 0, 0, this.height); grad.addColorStop(0, "#0f172a"); grad.addColorStop(1, "#1e1b4b");
            this.ctx.fillStyle = grad; this.ctx.fillRect(0, 0, this.width, this.height);
            this.drawClouds(this.ctx);
        } else {
            this.ctx.fillStyle = '#ffffff';
            this.stars.forEach(s => { s.y += s.speed; if (s.y > this.height) s.y = 0; this.ctx.globalAlpha = 0.3 + Math.random() * 0.5; this.ctx.beginPath(); this.ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); this.ctx.fill(); });
        }
        this.ctx.globalAlpha = 1.0;

        // --- 2. PLAYER/CORE ---
        const cx = this.width / 2; const cy = this.height / 2;
        if (this.mode === 'orbit' || this.mode === 'butterfly') {
            if (this.mode === 'butterfly') {
                this.drawFlower(this.ctx, cx, cy, 40, '#fcd34d');
                this.ctx.beginPath(); this.ctx.arc(cx, cy, 50, 0, Math.PI * 2); this.ctx.strokeStyle = '#fcd34d'; this.ctx.lineWidth = 1; this.ctx.stroke();
            } else {
                this.ctx.beginPath(); this.ctx.arc(cx, cy, 30, 0, Math.PI * 2); this.ctx.fillStyle = '#111'; this.ctx.fill();
                this.ctx.strokeStyle = '#3b82f6'; this.ctx.lineWidth = 2; this.ctx.stroke();
                this.ctx.beginPath(); this.ctx.arc(cx, cy, 10, 0, Math.PI * 2); this.ctx.fillStyle = '#3b82f6'; this.ctx.fill();
            }
        }

        // --- 3. ACTIVE WORD ---
        if (this.activeWord) {
            const w = this.activeWord; w.x += w.vx * dt; w.y += w.vy * dt; w.rot += w.rotSpeed * dt;
            
            if (this.mode === 'meteor') {
                w.trail.push({ x: w.x, y: w.y }); if (w.trail.length > 15) w.trail.shift(); // Longer trail
                this.ctx.globalCompositeOperation = 'lighter';
                w.trail.forEach((p, i) => { this.ctx.fillStyle = w.color; this.ctx.globalAlpha = i / 15; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, w.size * (i / 20), 0, Math.PI * 2); this.ctx.fill(); });
                this.ctx.globalCompositeOperation = 'source-over'; this.ctx.globalAlpha = 1;
            }

            let failed = false;
            if ((this.mode === 'meteor' || this.mode === 'flower') && w.y > this.height - 50) failed = true;
            else if ((this.mode === 'bubble' || this.mode === 'heart') && w.y < 50) failed = true;
            else if ((this.mode === 'orbit' || this.mode === 'butterfly') && Math.hypot(cx - w.x, cy - w.y) < 40) failed = true;

            if (failed) { this.fail(); } else {
                this.ctx.save(); this.ctx.translate(w.x, w.y);
                if (this.mode === 'orbit' || this.mode === 'butterfly') { const ang = Math.atan2(cy - w.y, cx - w.x); this.ctx.rotate(ang + Math.PI / 2); }
                else { this.ctx.rotate(w.rot); }
                
                this.ctx.shadowBlur = 20; this.ctx.shadowColor = w.color;
                if (isFem) { this.ctx.fillStyle = w.color; this.ctx.shadowBlur = 15; }
                else { this.ctx.strokeStyle = w.color; this.ctx.lineWidth = 3; }

                this.ctx.beginPath();
                if (this.mode === 'meteor') { for (let i = 0; i < 6; i++) this.ctx.lineTo(w.size * Math.cos(i * Math.PI / 3), w.size * Math.sin(i * Math.PI / 3)); this.ctx.closePath(); this.ctx.stroke(); this.ctx.fillStyle = "rgba(0,0,0,0.8)"; this.ctx.fill(); }
                else if (this.mode === 'bubble') { this.ctx.arc(0, 0, w.size, 0, Math.PI * 2); this.ctx.stroke(); this.ctx.fillStyle = "rgba(255,255,255,0.05)"; this.ctx.fill(); }
                else if (this.mode === 'orbit') { this.ctx.moveTo(0, 20); this.ctx.lineTo(-20, -20); this.ctx.lineTo(20, -20); this.ctx.closePath(); this.ctx.stroke(); this.ctx.fillStyle = "rgba(0,0,0,0.8)"; this.ctx.fill(); }
                else if (this.mode === 'flower') { this.drawFlower(this.ctx, 0, 0, w.size, w.color); }
                else if (this.mode === 'heart') { this.drawHeart(this.ctx, 0, -w.size / 2, w.size, w.color); }
                else if (this.mode === 'butterfly') { this.drawButterfly(this.ctx, 0, 0, w.size, w.color); }
                
                this.ctx.restore();
                
                this.ctx.font = "bold 26px 'Bebas Neue'"; this.ctx.textAlign = "center"; this.ctx.textBaseline = "middle"; this.ctx.shadowBlur = 0;
                this.ctx.lineWidth = 4; this.ctx.strokeStyle = "rgba(0,0,0,0.8)"; this.ctx.strokeText(w.data.en, w.x, w.y);
                this.ctx.fillStyle = "#fff"; this.ctx.fillText(w.data.en, w.x, w.y);
            }
        }

        // --- 4. EFFECTS ---
        if (this.laser) {
            this.ctx.globalCompositeOperation = 'lighter';
            this.drawWebLaser(this.ctx, this.laser);
            this.laser.life -= 0.005; 
            if (this.laser.life <= 0) this.laser = null;
            this.ctx.globalCompositeOperation = 'source-over';
        }

        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i]; p.x += p.vx; p.y += p.vy;
            p.life -= 0.005; 
            if (this.mode !== 'orbit' && this.mode !== 'butterfly') p.vy += 0.05; 
            if (p.life <= 0) this.particles.splice(i, 1);
            else {
                this.ctx.globalCompositeOperation = 'lighter';
                this.ctx.globalAlpha = p.life; this.ctx.fillStyle = p.color; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.globalCompositeOperation = 'source-over';
            }
        }
        this.ctx.globalAlpha = 1.0;

        for (let i = this.shockwaves.length - 1; i >= 0; i--) {
            let s = this.shockwaves[i]; s.radius += 3; s.alpha -= 0.02; 
            if (s.alpha <= 0) this.shockwaves.splice(i, 1);
            else {
                this.ctx.strokeStyle = s.color; this.ctx.lineWidth = 3; this.ctx.globalAlpha = s.alpha;
                this.ctx.beginPath(); this.ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2); this.ctx.stroke();
                this.ctx.globalAlpha = 1;
            }
        }

        if (this.flashIntensity > 0) {
            this.ctx.fillStyle = this.themeColor; this.ctx.globalAlpha = this.flashIntensity; this.ctx.fillRect(0, 0, this.width, this.height);
            this.ctx.globalAlpha = 1; this.flashIntensity -= 0.02; 
        }

        // --- 5. UI GHOSTS ---
        for (let i = this.ghosts.length - 1; i >= 0; i--) {
            let g = this.ghosts[i]; g.y += g.vy; g.life -= 0.003;
            if (g.life <= 0) {
                this.ghosts.splice(i, 1);
                this.showingGhost = false;
                if (!this.activeWord) this.spawn(); 
            }
            else {
                this.ctx.save();
                if (g.life > 0.9) { let s = 1 + (1 - g.life) * 5; this.ctx.translate(g.x, g.y); this.ctx.scale(s, s); this.ctx.translate(-g.x, -g.y); }
                this.ctx.globalAlpha = g.life; this.ctx.font = "bold 24px 'Inter'"; this.ctx.textAlign = "center";
                this.ctx.lineWidth = 3; this.ctx.strokeStyle = "#000"; this.ctx.strokeText(g.text, g.x, g.y);
                this.ctx.fillStyle = "#fbbf24"; this.ctx.fillText(g.text, g.x, g.y);
                this.ctx.restore();
            }
        }
        this.ctx.globalAlpha = 1.0;

        if (this.combo > 1) {
            this.ctx.font = "italic 900 30px 'Bebas Neue'"; this.ctx.fillStyle = "#fff"; this.ctx.strokeStyle = "#000"; this.ctx.lineWidth = 4;
            this.ctx.strokeText(`x${this.combo} COMBO!`, this.width - 70, 40); this.ctx.fillText(`x${this.combo} COMBO!`, this.width - 70, 40);
        }

        if (this.timeLimit > 0) {
            const left = this.timeLimit - (Date.now() - this.startTime);
            if (left <= 0) { 
                this.stop(); 
                alert("TIME'S UP!"); 
                App.nav('home'); 
                return;
            }
            else { 
                const m = Math.floor(left / 60000); 
                const s = Math.floor((left % 60000) / 1000); 
                document.getElementById('game-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; 
            }
        }

        this.loopId = requestAnimationFrame(t => this.loop(t));
    }
};

window.onload = () => App.boot();
</script>
</body>
</html>
