<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocabulary Hunter: Console Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #39ff14;
            --neon-red: #ff3131;
            --neon-blue: #04d9ff;
            --neon-yellow: #fff01f;
            --dark-bg: #0a0a0a;
            --panel-bg: rgba(10, 10, 12, 0.96);
            --glass: rgba(255, 255, 255, 0.05);
        }
        * { box-sizing: border-box; }
        body {margin:0;overflow:hidden;background:var(--dark-bg);font-family:'Press Start 2P',monospace;color:white;user-select:none;touch-action:none;}
        canvas {display:block;}
        
        /* SCANLINES & VIGNETTE */
        .scanlines {
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,255,255,0) 50%,rgba(0,0,0,0.2) 50%,rgba(0,0,0,0.2));
            background-size:100% 4px;z-index:998;pointer-events:none;
        }
        .vignette {
            position:fixed;top:0;left:0;width:100%;height:100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
            z-index:999; pointer-events: none;
        }
        
        #ui {position:absolute;top:15px;left:15px;right:15px;z-index:10;pointer-events:none;display:flex;justify-content:space-between;text-shadow:2px 2px 0 #000; font-size: 10px; letter-spacing: 1px;}
        #lives-panel {color:var(--neon-red);}
        #score-panel {color:var(--neon-green);}
        
        /* --- CONSOLE CONTROLS DESIGN --- */
        #mobile-controls {
            display: none; 
            position: absolute; bottom: 30px; width: 100%;
            justify-content: space-between; padding: 0 30px; 
            z-index: 20; pointer-events: none; align-items: flex-end;
        }

        /* LEFT: D-PAD CAPSULE */
        .d-pad {
            display: flex; background: var(--glass);
            border: 2px solid var(--neon-green);
            border-radius: 40px; padding: 5px;
            gap: 10px; pointer-events: auto;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.2);
            backdrop-filter: blur(5px);
            margin-bottom: 20px;
        }
        .pad-btn {
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: var(--neon-green);
            border-radius: 50%; transition: 0.1s;
        }
        .pad-btn:active { background: var(--neon-green); color: black; box-shadow: 0 0 20px var(--neon-green); }

        /* RIGHT: ACTION CLUSTER */
        .action-cluster {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr;
            gap: 15px; pointer-events: auto;
            margin-bottom: 40px;
        }

        /* Common Button Style */
        .action-btn {
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid; backdrop-filter: blur(5px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.5); /* 3D effect */
            transition: transform 0.1s, box-shadow 0.1s; text-shadow: 1px 1px 0 #000;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: 0 0 0; }

        /* Specific Buttons */
        .btn-boost {
            grid-column: 2; grid-row: 1; /* Top Right */
            width: 55px; height: 55px; 
            border-color: var(--neon-yellow); color: var(--neon-yellow); background: rgba(255, 240, 31, 0.1);
            font-size: 24px;
        }
        .btn-boost:active { background: var(--neon-yellow); color: black; }

        .btn-ban {
            grid-column: 1; grid-row: 1; /* Top Left (relative to cluster) */
            width: 55px; height: 55px; margin-top: 20px; /* Offset for ergonomic arc */
            border-color: var(--neon-blue); color: var(--neon-blue); background: rgba(4, 217, 255, 0.1);
            font-size: 14px;
        }
        .btn-ban:active { background: var(--neon-blue); color: black; }

        .btn-fire {
            grid-column: 1 / span 2; grid-row: 2; /* Bottom Center */
            width: 80px; height: 80px; justify-self: center;
            border-color: var(--neon-red); color: var(--neon-red); background: rgba(255, 49, 49, 0.1);
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-fire:active { background: var(--neon-red); color: white; }

        @media (max-width: 1024px) or (pointer: coarse) {
            #mobile-controls { display: flex; }
            #category-bar-wrapper { bottom: 10px; display: none; } /* Ocultar barra categorias en juego movil para limpiar vista */
            h1 { font-size: 20px; }
            p { font-size: 10px; line-height: 1.5; }
        }

        /* --- UI ELEMENTS --- */
        #category-bar-wrapper {
            position:absolute; bottom:20px; left:0; width:100%; padding:10px 0;
            background:rgba(0,0,0,0.8); z-index:15; overflow-x:auto; white-space:nowrap;
            display:flex; justify-content:center; border-top:1px solid #333;
        }
        .category-chip {
            padding:8px 16px; margin:0 5px; background:#111; color:#777;
            font-size:9px; cursor:pointer; border:1px solid #333; 
            display:inline-block; border-radius: 4px;
        }
        .category-chip.active { color:black; background:var(--neon-green); border-color:var(--neon-green); }
        .category-chip.help-btn { border-color:var(--neon-yellow); color:var(--neon-yellow); }
        
        /* --- MODALS --- */
        .overlay-screen {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
        h1 {color:var(--neon-green); text-shadow:0 0 20px var(--neon-green); font-size:35px; margin-bottom:20px;}
        h2 {color:var(--neon-red); font-size:24px; margin-bottom:15px;}
        .key-hint {display:inline-block;padding:3px 6px;border:1px solid #666;border-radius:4px;color:#fff;background:#222;font-size:10px;}
        .blink {animation:blinker 1s linear infinite;color:var(--neon-yellow);margin-top:30px;font-size:14px;cursor:pointer;}
        @keyframes blinker {50%{opacity:0;}}
        
        /* STUDY POPUP (FIXED LAYOUT) */
        #study-content {
            background: #0f0f12; padding: 0; border: 2px solid var(--neon-green);
            width: 95%; max-width: 650px; height: 85vh; display: flex; flex-direction: column;
            position: relative; box-shadow: 0 0 50px rgba(57,255,20,0.1);
            border-radius: 8px; overflow: hidden; /* Evita scroll global */
        }
        .close-btn {
            position:absolute; top:10px; right:10px;
            font-size:16px; color:var(--neon-red); cursor:pointer;
            border:1px solid var(--neon-red); padding:5px 8px;
            z-index:20; background: #000; font-weight: bold;
        }
        
        /* TABS */
        .tabs-header { display: flex; background: #000; border-bottom: 2px solid #333; }
        .tab-btn {
            flex: 1; padding: 15px; cursor: pointer; text-align: center; font-size: 10px;
            background: transparent; border: none; color: #666; font-family: 'Press Start 2P';
            border-right: 1px solid #222;
        }
        .tab-btn.active { background: #1a1a1a; color: var(--neon-green); border-bottom: 2px solid var(--neon-green); }
        
        /* CONTENT SCROLLABLE AREA */
        .tab-content { 
            flex: 1; overflow-y: auto; overflow-x: hidden; /* Scroll vertical solo aquí */
            padding: 20px; display: none; 
        }
        .tab-content.active { display: block; }

        /* DATABASE TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
        th { 
            color: var(--neon-green); text-align: left; padding: 10px 5px; 
            border-bottom: 2px solid #333; position: sticky; top: -20px; background: #0f0f12; z-index: 5; 
        }
        td { padding: 12px 5px; border-bottom: 1px solid #222; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* COLUMNS WIDTH */
        .col-check { width: 40px; text-align: center; }
        .col-star { width: 40px; text-align: center; font-size: 14px; cursor: pointer; }
        .col-word { width: 40%; font-weight: bold; color: var(--neon-blue); }
        .col-trans { width: auto; color: #888; }

        /* INTERACTIVE ELEMENTS */
        .star-icon { color: #444; transition: 0.2s; }
        .star-icon:hover { color: #fff; }
        .is-boosted .star-icon { color: var(--neon-yellow); text-shadow: 0 0 8px var(--neon-yellow); }
        tr.is-boosted .col-word { color: var(--neon-yellow); }
        tr:hover { background: #111; }

        input[type=checkbox] { accent-color: var(--neon-red); cursor: pointer; }

        /* SETTINGS FORM */
        .config-group { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #222; }
        .config-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 10px; color: #ccc; }
        .config-val { color: var(--neon-yellow); }
        input[type=range] { width: 100%; accent-color: var(--neon-green); }
        select { width: 100%; padding: 8px; background: #000; color: white; border: 1px solid #444; font-family: inherit; font-size: 10px; }
        
        .reset-btn { width: 100%; padding: 15px; background: #300; color: #f55; border: 1px solid #f00; font-family: inherit; cursor: pointer; margin-top: 30px; font-size: 10px; }

        /* QUIZ */
        #quiz-overlay {
            background: #000; border: 2px solid var(--neon-red);
            padding: 20px; width: 85%; max-width: 400px;
            box-shadow: 0 0 50px rgba(255,0,0,0.3);
        }
        #quiz-input { background: #111; border: 1px solid #444; color: #fff; padding: 10px; font-family: inherit; text-align: center; width: 100%; margin-top: 10px; }
        .quiz-actions { display: flex; gap: 10px; margin-top: 15px; }
        .quiz-btn { flex: 1; padding: 10px; border: 1px solid; background: transparent; color: white; font-family: inherit; cursor: pointer; font-size: 9px; }
        
        ::-webkit-scrollbar {width:6px;}
        ::-webkit-scrollbar-track {background:#000;}
        ::-webkit-scrollbar-thumb {background:#333;border-radius:3px;}
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="vignette"></div>
    
    <div id="ui">
        <div id="score-panel">SCORE: <span id="score">0</span></div>
        <div id="combo-panel">COMBO: <span id="combo">0</span></div>
        <div id="lives-panel">HP: <span id="lives">5</span></div>
    </div>
    
    <div id="mobile-controls">
        <div class="d-pad">
            <div class="pad-btn" id="btn-left">←</div>
            <div class="pad-btn" id="btn-right">→</div>
        </div>
        
        <div class="action-cluster">
            <div class="action-btn btn-ban" id="btn-ban">X</div>
            <div class="action-btn btn-boost" id="btn-boost">★</div>
            <div class="action-btn btn-fire" id="btn-fire">FIRE</div>
        </div>
    </div>

    <div id="category-bar-wrapper"></div>

    <div id="start-screen" class="overlay-screen" onclick="startGame()">
        <h1>VOCAB ROBOT</h1>
        <p style="color:#aaa; margin-bottom: 30px;">SYSTEM READY...</p>
        <p>
            <span style="color:var(--neon-red)">[FIRE]</span> Red Bullet: 3 hits to destroy/normalize.<br>
            <span style="color:var(--neon-blue)">[X]</span> Blue Bullet: 3 hits to BAN word.<br>
            <span style="color:var(--neon-yellow)">[★]</span> Yellow Bullet: 3 hits to BOOST (capture).
        </p>
        <div class="blink">TAP TO START</div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;" onclick="startGame()">
        <h2>GAME OVER</h2>
        <p>SCORE: <span id="finalScore" style="color:white;">0</span></p>
        <div class="blink">RETRY</div>
    </div>

    <div id="quiz-screen" class="overlay-screen" style="display:none;">
        <div id="quiz-overlay">
            <h2 style="color:var(--neon-red); font-size: 16px;">SECURITY BREACH</h2>
            <p style="font-size:10px; color:#aaa; margin-bottom: 10px;">TRANSLATE TO FIX</p>
            <div id="quiz-question" style="color:var(--neon-blue); margin: 15px 0;">WORD</div>
            <input type="text" id="quiz-input" placeholder="TRANSLATION..." autocomplete="off">
            <div id="quiz-feedback"></div>
            <div class="quiz-actions">
                <button class="quiz-btn" style="border-color:#555" onclick="skipQuiz()">SKIP (-500)</button>
                <button class="quiz-btn" style="border-color:var(--neon-green); color:var(--neon-green)" onclick="checkQuizAnswer()">ENTER</button>
            </div>
        </div>
    </div>

    <div id="study-guide" class="overlay-screen" style="display:none;">
        <div id="study-content">
            <span class="close-btn" onclick="toggleStudyGuide()">X</span>
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('db')">DATABASE</button>
                <button class="tab-btn" onclick="switchTab('settings')">CONFIG</button>
            </div>
            
            <div id="tab-db" class="tab-content active">
                <div class="config-group">
                    <label class="config-label">DATA LIMIT<span id="lbl-percent" class="config-val">100%</span></label>
                    <input type="range" id="mini-slider-percent" min="1" max="100" value="100" oninput="updateDataPercent(this.value)">
                </div>
                <div id="study-table-container"></div>
            </div>

            <div id="tab-settings" class="tab-content">
                <div class="config-group">
                      <label class="config-label">VOLUME<span id="val-volume" class="config-val">50%</span></label>
                      <input type="range" id="cfg-volume" min="0" max="100" step="10" value="50" oninput="updateConfig('volume')">
                </div>
                <div class="config-group">
                    <label class="config-label">SOURCE</label>
                    <select id="cfg-source" onchange="updateConfig('source')"></select>
                </div>
                <div class="config-group">
                    <label class="config-label">GAME SPEED<span id="val-speed" class="config-val">0.5x</span></label>
                    <input type="range" id="cfg-speed" min="0.5" max="3.0" step="0.1" value="0.5" oninput="updateConfig('speed')">
                </div>
                <div class="config-group">
                    <label class="config-label">
                        <input type="checkbox" id="chk-quiz" onchange="updateConfig('quiz')"> QUIZ TIMER
                    </label>
                    <input type="range" id="cfg-quiz-time" min="10" max="60" step="5" value="30" oninput="updateConfig('quiz')">
                </div>
                
                <div class="config-group">
                    <label class="config-label"><input type="checkbox" id="chk-sfx" onchange="updateConfig('audio_toggles')" checked> SFX</label>
                    <label class="config-label"><input type="checkbox" id="chk-voice-words" onchange="updateConfig('audio_toggles')" checked> VOICE: WORDS</label>
                    <label class="config-label"><input type="checkbox" id="chk-voice-bombs" onchange="updateConfig('audio_toggles')" checked> VOICE: BOMBS</label>
                </div>

                <div class="config-group">
                    <label class="config-label">PLAYER COLOR</label>
                    <input type="color" id="cfg-color" value="#4f46e5" onchange="updateConfig('color')">
                </div>
                
                <input type="hidden" id="cfg-boss-freq" value="15">
                <input type="hidden" id="cfg-spawn" value="1">
                <input type="hidden" id="cfg-bomb" value="30">
                <input type="hidden" id="cfg-bspeed" value="1.0">

                <button class="reset-btn" onclick="resetConfig()">FACTORY RESET</button>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/* =========================================
   1. INTERNAL DATA (COMPLETE)
   ========================================= */
const INTERNAL_VOCAB = {
    'IRREGULAR_VERBS': [
        {en: "ABIDE", past: "ABODE", part: "ABIDDEN", es: "ACATAR", type: "IRREGULAR"},
        {en: "ARISE", past: "AROSE", part: "ARISEN", es: "SURGIR", type: "IRREGULAR"},
        {en: "AWAKE", past: "AWOKE", part: "AWOKEN", es: "DESPERTAR", type: "IRREGULAR"},
        {en: "BE", past: "WAS/WERE", part: "BEEN", es: "SER/ESTAR", type: "IRREGULAR"},
        {en: "BEAR", past: "BORE", part: "BORN", es: "SOPORTAR", type: "IRREGULAR"},
        {en: "BEAT", past: "BEAT", part: "BEATEN", es: "GOLPEAR", type: "IRREGULAR"},
        {en: "BECOME", past: "BECAME", part: "BECOME", es: "CONVERTIRSE", type: "IRREGULAR"},
        {en: "BEGIN", past: "BEGAN", part: "BEGUN", es: "EMPEZAR", type: "IRREGULAR"},
        {en: "BEND", past: "BENT", part: "BENT", es: "DOBLAR", type: "IRREGULAR"},
        {en: "BET", past: "BET", part: "BET", es: "APOSTAR", type: "IRREGULAR"},
        {en: "BIND", past: "BOUND", part: "BOUND", es: "ATAR", type: "IRREGULAR"},
        {en: "BITE", past: "BIT", part: "BITTEN", es: "MORDER", type: "IRREGULAR"},
        {en: "BLEED", past: "BLED", part: "BLED", es: "SANGRAR", type: "IRREGULAR"},
        {en: "BLOW", past: "BLEW", part: "BLOWN", es: "SOPLAR", type: "IRREGULAR"},
        {en: "BREAK", past: "BROKE", part: "BROKEN", es: "ROMPER", type: "IRREGULAR"},
        {en: "BRING", past: "BROUGHT", part: "BROUGHT", es: "TRAER", type: "IRREGULAR"},
        {en: "BUILD", past: "BUILT", part: "BUILT", es: "CONSTRUIR", type: "IRREGULAR"},
        {en: "BUY", past: "BOUGHT", part: "BOUGHT", es: "COMPRAR", type: "IRREGULAR"},
        {en: "CATCH", past: "CAUGHT", part: "CAUGHT", es: "ATRAPAR", type: "IRREGULAR"},
        {en: "CHOOSE", past: "CHOSE", part: "CHOSEN", es: "ELEGIR", type: "IRREGULAR"},
        {en: "COME", past: "CAME", part: "COME", es: "VENIR", type: "IRREGULAR"},
        {en: "COST", past: "COST", part: "COST", es: "COSTAR", type: "IRREGULAR"},
        {en: "CUT", past: "CUT", part: "CUT", es: "CORTAR", type: "IRREGULAR"},
        {en: "DO", past: "DID", part: "DONE", es: "HACER", type: "IRREGULAR"},
        {en: "DRAW", past: "DREW", part: "DRAWN", es: "DIBUJAR", type: "IRREGULAR"},
        {en: "DRINK", past: "DRANK", part: "DRUNK", es: "BEBER", type: "IRREGULAR"},
        {en: "DRIVE", past: "DROVE", part: "DRIVEN", es: "CONDUCIR", type: "IRREGULAR"},
        {en: "EAT", past: "ATE", part: "EATEN", es: "COMER", type: "IRREGULAR"},
        {en: "FALL", past: "FELL", part: "FALLEN", es: "CAER", type: "IRREGULAR"},
        {en: "FEED", past: "FED", part: "FED", es: "ALIMENTAR", type: "IRREGULAR"},
        {en: "FEEL", past: "FELT", part: "FELT", es: "SENTIR", type: "IRREGULAR"},
        {en: "FIGHT", past: "FOUGHT", part: "FOUGHT", es: "PELEAR", type: "IRREGULAR"},
        {en: "FIND", past: "FOUND", part: "FOUND", es: "ENCONTRAR", type: "IRREGULAR"},
        {en: "FLY", past: "FLEW", part: "FLOWN", es: "VOLAR", type: "IRREGULAR"},
        {en: "FORGET", past: "FORGOT", part: "FORGOTTEN", es: "OLVIDAR", type: "IRREGULAR"},
        {en: "GET", past: "GOT", part: "GOTTEN", es: "OBTENER", type: "IRREGULAR"},
        {en: "GIVE", past: "GAVE", part: "GIVEN", es: "DAR", type: "IRREGULAR"},
        {en: "GO", past: "WENT", part: "GONE", es: "IR", type: "IRREGULAR"},
        {en: "GROW", past: "GREW", part: "GROWN", es: "CRECER", type: "IRREGULAR"},
        {en: "HAVE", past: "HAD", part: "HAD", es: "TENER", type: "IRREGULAR"},
        {en: "HEAR", past: "HEARD", part: "HEARD", es: "OÍR", type: "IRREGULAR"},
        {en: "HIDE", past: "HID", part: "HIDDEN", es: "ESCONDER", type: "IRREGULAR"},
        {en: "HIT", past: "HIT", part: "HIT", es: "GOLPEAR", type: "IRREGULAR"},
        {en: "HOLD", past: "HELD", part: "HELD", es: "SOSTENER", type: "IRREGULAR"},
        {en: "HURT", past: "HURT", part: "HURT", es: "HERIR", type: "IRREGULAR"},
        {en: "KEEP", past: "KEPT", part: "KEPT", es: "MANTENER", type: "IRREGULAR"},
        {en: "KNOW", past: "KNEW", part: "KNOWN", es: "SABER", type: "IRREGULAR"},
        {en: "LEARN", past: "LEARNT", part: "LEARNT", es: "APRENDER", type: "IRREGULAR"},
        {en: "LEAVE", past: "LEFT", part: "LEFT", es: "DEJAR", type: "IRREGULAR"},
        {en: "LOSE", past: "LOST", part: "LOST", es: "PERDER", type: "IRREGULAR"},
        {en: "MAKE", past: "MADE", part: "MADE", es: "HACER", type: "IRREGULAR"},
        {en: "MEET", past: "MET", part: "MET", es: "CONOCER", type: "IRREGULAR"},
        {en: "PAY", past: "PAID", part: "PAID", es: "PAGAR", type: "IRREGULAR"},
        {en: "PUT", past: "PUT", part: "PUT", es: "PONER", type: "IRREGULAR"},
        {en: "READ", past: "READ", part: "READ", es: "LEER", type: "IRREGULAR"},
        {en: "RIDE", past: "RODE", part: "RIDDEN", es: "MONTAR", type: "IRREGULAR"},
        {en: "RING", past: "RANG", part: "RUNG", es: "SONAR", type: "IRREGULAR"},
        {en: "RUN", past: "RAN", part: "RUN", es: "CORRER", type: "IRREGULAR"},
        {en: "SAY", past: "SAID", part: "SAID", es: "DECIR", type: "IRREGULAR"},
        {en: "SEE", past: "SAW", part: "SEEN", es: "VER", type: "IRREGULAR"},
        {en: "SELL", past: "SOLD", part: "SOLD", es: "VENDER", type: "IRREGULAR"},
        {en: "SEND", past: "SENT", part: "SENT", es: "ENVIAR", type: "IRREGULAR"},
        {en: "SING", past: "SANG", part: "SUNG", es: "CANTAR", type: "IRREGULAR"},
        {en: "SIT", past: "SAT", part: "SAT", es: "SENTARSE", type: "IRREGULAR"},
        {en: "SLEEP", past: "SLEPT", part: "SLEPT", es: "DORMIR", type: "IRREGULAR"},
        {en: "SPEAK", past: "SPOKE", part: "SPOKEN", es: "HABLAR", type: "IRREGULAR"},
        {en: "SPEND", past: "SPENT", part: "SPENT", es: "GASTAR", type: "IRREGULAR"},
        {en: "STAND", past: "STOOD", part: "STOOD", es: "ESTAR DE PIE", type: "IRREGULAR"},
        {en: "SWIM", past: "SWAM", part: "SWUM", es: "NADAR", type: "IRREGULAR"},
        {en: "TAKE", past: "TOOK", part: "TAKEN", es: "TOMAR", type: "IRREGULAR"},
        {en: "TEACH", past: "TAUGHT", part: "TAUGHT", es: "ENSEÑAR", type: "IRREGULAR"},
        {en: "TELL", past: "TOLD", part: "TOLD", es: "CONTAR", type: "IRREGULAR"},
        {en: "THINK", past: "THOUGHT", part: "THOUGHT", es: "PENSAR", type: "IRREGULAR"},
        {en: "UNDERSTAND", past: "UNDERSTOOD", part: "UNDERSTOOD", es: "ENTENDER", type: "IRREGULAR"},
        {en: "WAKE", past: "WOKE", part: "WOKEN", es: "DESPERTAR", type: "IRREGULAR"},
        {en: "WEAR", past: "WORE", part: "WORN", es: "VESTIR", type: "IRREGULAR"},
        {en: "WIN", past: "WON", part: "WON", es: "GANAR", type: "IRREGULAR"},
        {en: "WRITE", past: "WROTE", part: "WRITTEN", es: "ESCRIBIR", type: "IRREGULAR"}
    ],
    'REGULAR_VERBS': [
        {en: "ACCEPT", past: "ACCEPTED", part: "ACCEPTED", es: "ACEPTAR", type: "REGULAR"},
        {en: "ASK", past: "ASKED", part: "ASKED", es: "PREGUNTAR", type: "REGULAR"},
        {en: "BELIEVE", past: "BELIEVED", part: "BELIEVED", es: "CREER", type: "REGULAR"},
        {en: "CALL", past: "CALLED", part: "CALLED", es: "LLAMAR", type: "REGULAR"},
        {en: "CHANGE", past: "CHANGED", part: "CHANGED", es: "CAMBIAR", type: "REGULAR"},
        {en: "CLEAN", past: "CLEANED", part: "CLEANED", es: "LIMPIAR", type: "REGULAR"},
        {en: "CLOSE", past: "CLOSED", part: "CLOSED", es: "CERRAR", type: "REGULAR"},
        {en: "COOK", past: "COOKED", part: "COOKED", es: "COCINAR", type: "REGULAR"},
        {en: "CRY", past: "CRIED", part: "CRIED", es: "LLORAR", type: "REGULAR"},
        {en: "DANCE", past: "DANCED", part: "DANCED", es: "BAILAR", type: "REGULAR"},
        {en: "DECIDE", past: "DECIDED", part: "DECIDED", es: "DECIDIR", type: "REGULAR"},
        {en: "HELP", past: "HELPED", part: "HELPED", es: "AYUDAR", type: "REGULAR"},
        {en: "HOPE", past: "HOPED", part: "HOPED", es: "ESPERAR", type: "REGULAR"},
        {en: "INVITE", past: "INVITED", part: "INVITED", es: "INVITAR", type: "REGULAR"},
        {en: "JUMP", past: "JUMPED", part: "JUMPED", es: "SALTAR", type: "REGULAR"},
        {en: "LIKE", past: "LIKED", part: "LIKED", es: "GUSTAR", type: "REGULAR"},
        {en: "LISTEN", past: "LISTENED", part: "LISTENED", es: "ESCUCHAR", type: "REGULAR"},
        {en: "LIVE", past: "LIVED", part: "LIVED", es: "VIVIR", type: "REGULAR"},
        {en: "LOOK", past: "LOOKED", part: "LOOKED", es: "MIRAR", type: "REGULAR"},
        {en: "LOVE", past: "LOVED", part: "LOVED", es: "AMAR", type: "REGULAR"},
        {en: "NEED", past: "NEEDED", part: "NEEDED", es: "NECESITAR", type: "REGULAR"},
        {en: "OPEN", past: "OPENED", part: "OPENED", es: "ABRIR", type: "REGULAR"},
        {en: "PLAY", past: "PLAYED", part: "PLAYED", es: "JUGAR", type: "REGULAR"},
        {en: "REMEMBER", past: "REMEMBERED", part: "REMEMBERED", es: "RECORDAR", type: "REGULAR"},
        {en: "SMOKE", past: "SMOKED", part: "SMOKED", es: "FUMAR", type: "REGULAR"},
        {en: "START", past: "STARTED", part: "STARTED", es: "EMPEZAR", type: "REGULAR"},
        {en: "STOP", past: "STOPPED", part: "STOPPED", es: "PARAR", type: "REGULAR"},
        {en: "STUDY", past: "STUDIED", part: "STUDIED", es: "ESTUDIAR", type: "REGULAR"},
        {en: "TALK", past: "TALKED", part: "TALKED", es: "HABLAR", type: "REGULAR"},
        {en: "TRAVEL", past: "TRAVELED", part: "TRAVELED", es: "VIAJAR", type: "REGULAR"},
        {en: "TRY", past: "TRIED", part: "TRIED", es: "INTENTAR", type: "REGULAR"},
        {en: "USE", past: "USED", part: "USED", es: "USAR", type: "REGULAR"},
        {en: "VISIT", past: "VISITED", part: "VISITED", es: "VISITAR", type: "REGULAR"},
        {en: "WAIT", past: "WAITED", part: "WAITED", es: "ESPERAR", type: "REGULAR"},
        {en: "WALK", past: "WALKED", part: "WALKED", es: "CAMINAR", type: "REGULAR"},
        {en: "WANT", past: "WANTED", part: "WANTED", es: "QUERER", type: "REGULAR"},
        {en: "WASH", past: "WASHED", part: "WASHED", es: "LAVAR", type: "REGULAR"},
        {en: "WATCH", past: "WATCHED", part: "WATCHED", es: "MIRAR", type: "REGULAR"},
        {en: "WORK", past: "WORKED", part: "WORKED", es: "TRABAJAR", type: "REGULAR"},
        {en: "WORRY", past: "WORRIED", part: "WORRIED", es: "PREOCUPARSE", type: "REGULAR"}
    ],
    'NOUNS': [
        {en:"TIME", es:"TIEMPO"}, {en:"YEAR", es:"AÑO"}, {en:"WAY", es:"MANERA"}, {en:"DAY", es:"DÍA"},
        {en:"MAN", es:"HOMBRE"}, {en:"WORLD", es:"MUNDO"}, {en:"LIFE", es:"VIDA"}, {en:"HAND", es:"MANO"},
        {en:"PART", es:"PARTE"}, {en:"CHILD", es:"NIÑO"}, {en:"EYE", es:"OJO"}, {en:"WOMAN", es:"MUJER"},
        {en:"PLACE", es:"LUGAR"}, {en:"WORK", es:"TRABAJO"}, {en:"WEEK", es:"SEMANA"}, {en:"CASE", es:"CASO"},
        {en:"POINT", es:"PUNTO"}, {en:"COMPANY", es:"EMPRESA"}, {en:"NUMBER", es:"NÚMERO"}, {en:"GROUP", es:"GRUPO"},
        {en:"PROBLEM", es:"PROBLEMA"}, {en:"FACT", es:"HECHO"}, {en:"HOUSE", es:"CASA"}, {en:"WATER", es:"AGUA"},
        {en:"ROOM", es:"HABITACIÓN"}, {en:"MOTHER", es:"MADRE"}, {en:"AREA", es:"ÁREA"}, {en:"MONEY", es:"DINERO"},
        {en:"STORY", es:"HISTORIA"}, {en:"MONTH", es:"MES"}, {en:"LOT", es:"MUCHO"}, {en:"RIGHT", es:"DERECHO"},
        {en:"STUDY", es:"ESTUDIO"}, {en:"BOOK", es:"LIBRO"}, {en:"WORD", es:"PALABRA"}, {en:"BUSINESS", es:"NEGOCIO"},
        {en:"ISSUE", es:"ASUNTO"}, {en:"SIDE", es:"LADO"}, {en:"KIND", es:"TIPO"}, {en:"HEAD", es:"CABEZA"},
        {en:"HOUR", es:"HORA"}, {en:"GAME", es:"JUEGO"}, {en:"LINE", es:"LÍNEA"}, {en:"END", es:"FIN"},
        {en:"MEMBER", es:"MIEMBRO"}, {en:"LAW", es:"LEY"}, {en:"CAR", es:"COCHE"}, {en:"CITY", es:"CIUDAD"},
        {en:"COMMUNITY", es:"COMUNIDAD"}, {en:"NAME", es:"NOMBRE"}, {en:"PRESIDENT", es:"PRESIDENTE"}, {en:"TEAM", es:"EQUIPO"},
        {en:"MINUTE", es:"MINUTO"}, {en:"IDEA", es:"IDEA"}, {en:"KID", es:"NIÑO"}, {en:"BODY", es:"CUERPO"},
        {en:"INFORMATION", es:"INFORMACIÓN"}, {en:"BACK", es:"ESPALDA"}, {en:"PARENT", es:"PADRE"}, {en:"FACE", es:"CARA"},
        {en:"OTHERS", es:"OTROS"}, {en:"LEVEL", es:"NIVEL"}, {en:"OFFICE", es:"OFICINA"}, {en:"DOOR", es:"PUERTA"},
        {en:"HEALTH", es:"SALUD"}, {en:"PERSON", es:"PERSONA"}, {en:"ART", es:"ARTE"}, {en:"WAR", es:"GUERRA"},
        {en:"HISTORY", es:"HISTORIA"}, {en:"PARTY", es:"FIESTA"}, {en:"RESULT", es:"RESULTADO"}, {en:"CHANGE", es:"CAMBIO"},
        {en:"MORNING", es:"MAÑANA"}, {en:"REASON", es:"RAZÓN"}, {en:"RESEARCH", es:"INVESTIGACIÓN"}, {en:"GIRL", es:"CHICA"},
        {en:"GUY", es:"CHICO"}, {en:"MOMENT", es:"MOMENTO"}, {en:"AIR", es:"AIRE"}, {en:"TEACHER", es:"PROFESOR"},
        {en:"FORCE", es:"FUERZA"}, {en:"EDUCATION", es:"EDUCACIÓN"}
    ]
};

/* =========================================
   2. CONFIGURATION & STATE
   ========================================= */
const CONFIG_KEY = 'vocab_hunter_v17'; 
const DISABLED_KEY = 'vh_disabled_v1';
const REINFORCED_KEY = 'vh_reinforced_v1';

let userSettings = {
    vocabSource: 'ALL_INTERNAL', 
    dataPercent: 100, 
    spawnLevel: 1, enemySpeed: 0.5,    
    bombChance: 30, bombSpeed: 1.0,     
    playerColor: '#4f46e5',
    quizEnabled: false, quizInterval: 30,
    masterVolume: 50,
    audioFX: true, audioWords: true, audioBombs: true,
    bossFrequency: 15
};
let gameVars = { spawnInterval: 3500, bombProb: 0.005 };
let disabledWords = new Set(); 
let reinforcedWords = new Set(); 

let quizTimer = 0;
let currentQuizWord = null;
let lockedEnemyId = null;

// --- INITIALIZATION ---
function loadConfig() {
    populateSourceMenu();
    try {
        const saved = localStorage.getItem(CONFIG_KEY);
        if(saved) userSettings = { ...userSettings, ...JSON.parse(saved) };
        
        const savedDis = localStorage.getItem(DISABLED_KEY);
        if(savedDis) disabledWords = new Set(JSON.parse(savedDis));
        
        const savedRe = localStorage.getItem(REINFORCED_KEY);
        if(savedRe) reinforcedWords = new Set(JSON.parse(savedRe));
    } catch(e) { console.error("Save Load Error", e); }
    
    applyConfigToUI();
    recalcGameVars();
}

function applyConfigToUI() {
    document.getElementById('cfg-source').value = userSettings.vocabSource;
    document.getElementById('mini-slider-percent').value = userSettings.dataPercent;
    document.getElementById('lbl-percent').textContent = userSettings.dataPercent + '%';
    document.getElementById('chk-quiz').checked = userSettings.quizEnabled;
    document.getElementById('cfg-quiz-time').value = userSettings.quizInterval;
    document.getElementById('cfg-volume').value = userSettings.masterVolume;
    document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
    document.getElementById('chk-sfx').checked = userSettings.audioFX;
    document.getElementById('chk-voice-words').checked = userSettings.audioWords;
    document.getElementById('chk-voice-bombs').checked = userSettings.audioBombs;
    document.getElementById('cfg-speed').value = userSettings.enemySpeed;
    document.getElementById('val-speed').textContent = userSettings.enemySpeed + "x";
    document.getElementById('cfg-color').value = userSettings.playerColor;
    player.color = userSettings.playerColor;
}

function recalcGameVars() {
    gameVars.spawnInterval = 5500 - (userSettings.spawnLevel * 500); 
    gameVars.bombProb = userSettings.bombChance / 2000; 
}

// --- DATA LOGIC ---
let activeVocabList = []; 
let gameDeck = [];        

function cleanText(str) { return str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase() : ""; }

function loadVocabData() {
    let temp = [];
    const add = (en, es) => {
        const cEn = cleanText(en), cEs = cleanText(es);
        if(cEn && cEs) temp.push({en: cEn, es: [cEs]});
    };

    // Load Logic
    if (userSettings.vocabSource === 'LOCAL' || userSettings.vocabSource === 'MIXED') {
        try {
            const saved = localStorage.getItem('mdc_vocab_list');
            if(saved) JSON.parse(saved).forEach(i => {
                if(i.items) i.items.forEach(s => add(s.eng, s.esp));
                else add(i.eng, i.esp);
            });
        } catch(e){}
    }
    
    // Fallback if local empty or internal requested
    if (userSettings.vocabSource !== 'LOCAL' || temp.length === 0) {
        let keys = (userSettings.vocabSource === 'ALL_INTERNAL' || userSettings.vocabSource === 'MIXED' || temp.length === 0) 
            ? Object.keys(INTERNAL_VOCAB) 
            : [userSettings.vocabSource];
        keys.forEach(k => { if(INTERNAL_VOCAB[k]) INTERNAL_VOCAB[k].forEach(i => add(i.en, i.es)); });
    }

    if (temp.length > 0) {
        // temp.sort(() => Math.random() - 0.5); // Shuffle on load? No, keep deterministic for checking
        const limit = Math.ceil(temp.length * (userSettings.dataPercent / 100));
        activeVocabList = temp.slice(0, limit);
    } else {
        activeVocabList = [{en: "NO DATA", es: ["VACIO"]}];
    }
    refreshGameDeck();
}

function refreshGameDeck() {
    gameDeck = [];
    if(activeVocabList[0].en === "NO DATA") return;
    
    activeVocabList.forEach(item => {
        if (!disabledWords.has(item.en)) {
            gameDeck.push(item);
            if (reinforcedWords.has(item.en)) {
                for(let k=0; k<10; k++) gameDeck.push(item); // 10x probability
            }
        }
    });
}

// --- UI HELPERS ---
function populateSourceMenu() {
    const s = document.getElementById('cfg-source'); s.innerHTML = '';
    const o = [
        {v: 'LOCAL', t: 'MY DATABASE'}, {v: 'ALL_INTERNAL', t: 'INTERNAL (ALL)'}, {v: 'MIXED', t: 'MIXED (LOCAL+INT)'}
    ];
    Object.keys(INTERNAL_VOCAB).forEach(k => o.push({v: k, t: `INTERNAL: ${k}`}));
    o.forEach(x => { const el = document.createElement('option'); el.value = x.v; el.textContent = x.t; s.appendChild(el); });
}

function renderCategoryBar() {
    const w = document.getElementById('category-bar-wrapper'); w.innerHTML = '';
    // Show current internal categories for quick switch
    Object.keys(INTERNAL_VOCAB).forEach(key => {
        const c = document.createElement('div');
        c.className = 'category-chip' + (userSettings.vocabSource === key ? ' active' : '');
        c.textContent = key;
        c.onclick = () => { document.getElementById('cfg-source').value = key; updateConfig('source'); };
        w.appendChild(c);
    });
    // Add Help
    const h = document.createElement('div'); h.className='category-chip help-btn'; h.textContent='CONFIG'; h.onclick=toggleStudyGuide;
    w.appendChild(h);
}

function populateStudyGuide(){
    const list = document.getElementById('study-table-container');
    let html = '<table><thead><tr><th class="col-check">ON</th><th class="col-star">BST</th><th class="col-word">ENGLISH</th><th class="col-trans">SPANISH</th></tr></thead><tbody>';
    
    activeVocabList.forEach(v => {
        const isDis = disabledWords.has(v.en);
        const isBoost = reinforcedWords.has(v.en);
        const rowClass = isBoost ? 'is-boosted' : '';
        const starChar = isBoost ? '★' : '☆';
        
        html += `<tr class="${rowClass}">
            <td class="col-check"><input type="checkbox" ${!isDis ? 'checked' : ''} onchange="toggleWordStatus('${v.en.replace(/'/g, "\\'")}')"></td>
            <td class="col-star" onclick="toggleReinforceStatus('${v.en.replace(/'/g, "\\'")}')"><span class="star-icon">${starChar}</span></td>
            <td class="col-word">${v.en}</td>
            <td class="col-trans">${v.es[0]}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    list.innerHTML = html;
}

// --- STATE MANAGEMENT ---
function toggleWordStatus(word) {
    if(disabledWords.has(word)) disabledWords.delete(word); else disabledWords.add(word);
    saveAndRefresh();
}
function toggleReinforceStatus(word) {
    if(reinforcedWords.has(word)) reinforcedWords.delete(word); else reinforcedWords.add(word);
    saveAndRefresh(); populateStudyGuide(); // Re-render to show star
}
function saveAndRefresh(){
    localStorage.setItem(DISABLED_KEY, JSON.stringify([...disabledWords]));
    localStorage.setItem(REINFORCED_KEY, JSON.stringify([...reinforcedWords]));
    refreshGameDeck();
}

function updateConfig(key) {
    if(key === 'source') {
        userSettings.vocabSource = document.getElementById('cfg-source').value;
        loadVocabData(); populateStudyGuide(); renderCategoryBar();
        if(gameRunning) enemies = [];
    }
    else if(key === 'percent_only') {
        userSettings.dataPercent = document.getElementById('mini-slider-percent').value;
        document.getElementById('lbl-percent').textContent = userSettings.dataPercent + '%';
        loadVocabData(); populateStudyGuide();
    }
    else if(key === 'volume') {
        userSettings.masterVolume = document.getElementById('cfg-volume').value;
        document.getElementById('val-volume').textContent = userSettings.masterVolume + '%';
    }
    else {
        // Generic update from UI to State
        userSettings.quizEnabled = document.getElementById('chk-quiz').checked;
        userSettings.quizInterval = document.getElementById('cfg-quiz-time').value;
        userSettings.audioFX = document.getElementById('chk-sfx').checked;
        userSettings.audioWords = document.getElementById('chk-voice-words').checked;
        userSettings.audioBombs = document.getElementById('chk-voice-bombs').checked;
        userSettings.enemySpeed = document.getElementById('cfg-speed').value;
        document.getElementById('val-speed').textContent = userSettings.enemySpeed + 'x';
        userSettings.playerColor = document.getElementById('cfg-color').value;
        player.color = userSettings.playerColor;
    }
    
    localStorage.setItem(CONFIG_KEY, JSON.stringify(userSettings));
    recalcGameVars();
}

function resetConfig() {
    localStorage.removeItem(CONFIG_KEY); localStorage.removeItem(DISABLED_KEY); localStorage.removeItem(REINFORCED_KEY);
    disabledWords = new Set(); reinforcedWords = new Set();
    userSettings = { vocabSource: 'ALL_INTERNAL', dataPercent: 100, spawnLevel: 1, enemySpeed: 0.5, bombChance: 30, bombSpeed: 1.0, playerColor: '#4f46e5', quizEnabled: false, quizInterval: 30, masterVolume: 50, audioFX:true, audioWords:true, audioBombs:true, bossFrequency: 15 };
    loadConfig(); loadVocabData(); populateStudyGuide(); renderCategoryBar();
}

function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    // Simple visual toggle for button
    const btns = document.querySelectorAll('.tab-btn');
    if(t==='db') btns[0].classList.add('active'); else btns[1].classList.add('active');
}

function toggleStudyGuide() {
    const el = document.getElementById('study-guide');
    if(el.style.display==='flex') {
        el.style.display='none';
        if(document.getElementById('start-screen').style.display==='none' && !gameRunning) {
            gameRunning=true; lastTime=performance.now(); gameLoopId=requestAnimationFrame(loop);
        }
    } else {
        gameRunning=false; cancelAnimationFrame(gameLoopId);
        populateStudyGuide(); el.style.display='flex';
    }
}

// --- GAME LOGIC ---
// (Helper functions for game loop)
function similarity(s1, s2) {
    var longer = s1; var shorter = s2;
    if (s1.length < s2.length) { longer = s2; shorter = s1; }
    var longerLength = longer.length;
    if (longerLength == 0) return 1.0;
    return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}
function editDistance(s1, s2) {
    s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
    var costs = new Array();
    for (var i = 0; i <= s1.length; i++) {
        var lastValue = i;
        for (var j = 0; j <= s2.length; j++) {
            if (i == 0) costs[j] = j;
            else {
                if (j > 0) {
                    var newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue; lastValue = newValue;
                }
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

/* === AUDIO & TTS === */
function speak(text, lang) {
    if(!userSettings.audioWords) return;
    const u = new SpeechSynthesisUtterance(text); u.lang = lang; u.rate = 0.9;
    window.speechSynthesis.speak(u);
}
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if(!userSettings.audioFX) return;
    if(audioCtx.state==='suspended') audioCtx.resume();
    const vol = userSettings.masterVolume/100;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const n = audioCtx.currentTime;
    
    if(type==='shoot'){ o.frequency.setValueAtTime(400,n); o.frequency.exponentialRampToValueAtTime(100,n+.1); g.gain.setValueAtTime(0.1*vol,n); g.gain.linearRampToValueAtTime(0,n+.1); }
    else if(type==='ban_shoot'){ o.type='sine'; o.frequency.setValueAtTime(800,n); o.frequency.exponentialRampToValueAtTime(200,n+.1); g.gain.setValueAtTime(0.1*vol,n); g.gain.linearRampToValueAtTime(0,n+.1); }
    else if(type==='boost_shoot'){ o.type='square'; o.frequency.setValueAtTime(200,n); o.frequency.linearRampToValueAtTime(600,n+.1); g.gain.setValueAtTime(0.1*vol,n); g.gain.linearRampToValueAtTime(0,n+.1); }
    else if(type==='hit_eng'){ o.type='sawtooth'; o.frequency.setValueAtTime(600,n); o.frequency.linearRampToValueAtTime(800,n+.1); g.gain.setValueAtTime(0.1*vol,n); g.gain.linearRampToValueAtTime(0,n+.15); }
    else if(type==='hit_syn'){ o.type='sine'; o.frequency.setValueAtTime(1200,n); o.frequency.linearRampToValueAtTime(1800,n+.1); g.gain.setValueAtTime(0.1*vol,n); g.gain.linearRampToValueAtTime(0,n+.3); }
    else if(type==='ban_success'){ o.type='sine'; o.frequency.setValueAtTime(200,n); o.frequency.linearRampToValueAtTime(50,n+.5); g.gain.setValueAtTime(0.2*vol,n); g.gain.linearRampToValueAtTime(0,n+.5); }
    else if(type==='boost_success'){ o.type='triangle'; o.frequency.setValueAtTime(400,n); o.frequency.linearRampToValueAtTime(1200,n+.4); g.gain.setValueAtTime(0.2*vol,n); g.gain.linearRampToValueAtTime(0,n+.4); }
    
    o.start(n); o.stop(n+0.5);
}

/* === LOOP & UPDATE === */
function spawnEnemy() {
    if(gameDeck.length === 0) return;
    
    // Boss Logic
    if (enemiesSpawnedCount > 0 && enemiesSpawnedCount % userSettings.bossFrequency === 0) {
        // Spawn Boss code simplified
        const item = INTERNAL_VOCAB.IRREGULAR_VERBS[Math.floor(Math.random()*INTERNAL_VOCAB.IRREGULAR_VERBS.length)];
        if(item) {
            enemies.push({
                id: Math.random(), x: canvas.width/2, y: -100, isBoss: true,
                wordData: item, phases: [{text:item.en, hits:0}, {text:item.past, hits:0}, {text:item.part, hits:0}],
                activePhase: 0, speed: 0.3 * userSettings.enemySpeed, vx: 0, color: '#00ffff', w: 100,
                banHits:0, boostHits:0, demoteHits:0, fading:false, bossFinished:false
            });
            enemiesSpawnedCount++;
            return;
        }
    }

    const d = gameDeck[Math.floor(Math.random()*gameDeck.length)];
    const isBoosted = reinforcedWords.has(d.en);
    ctx.font='16px "Press Start 2P"';
    const w = ctx.measureText(d.en).width;
    const x = Math.random() * (canvas.width - w - 20) + w/2 + 10;
    
    enemies.push({
        id: Math.random(), x: x, y: -40, isBoss: false,
        wordData: d, text: d.en, stage: 0, hits: 0,
        banHits: 0, boostHits: 0, demoteHits: 0,
        speed: (Math.random()*0.5 + 0.5) * userSettings.enemySpeed,
        vx: (Math.random() - 0.5) * 1.5,
        color: isBoosted ? '#FFD700' : '#fff',
        isBoosted: isBoosted,
        w: w, timer: 0, fading: false
    });
    enemiesSpawnedCount++;
}

function update(dt, timeScale) {
    // Quiz Check
    if(userSettings.quizEnabled) {
        quizTimer += dt;
        if(quizTimer > userSettings.quizInterval * 1000) { triggerPopQuiz(); quizTimer = 0; return; }
    }

    // Player
    if(player.invincible) { player.invTimer -= dt; if(player.invTimer<=0) player.invincible=false; }
    if(keys['ArrowLeft'] && player.x > 0) player.x -= player.speed * timeScale;
    if(keys['ArrowRight'] && player.x < canvas.width - player.w) player.x += player.speed * timeScale;

    // Spawning
    spawnTimer -= dt; if(spawnTimer < 0) { spawnEnemy(); spawnTimer = gameVars.spawnInterval; }

    // Bullets
    for(let i=bullets.length-1; i>=0; i--) {
        bullets[i].y -= 12 * timeScale;
        if(bullets[i].y < 0) bullets.splice(i,1);
    }

    // Enemies
    for(let i=enemies.length-1; i>=0; i--) {
        let e = enemies[i];
        
        // Move
        if(!e.bossFinished) {
            e.y += e.speed * timeScale;
            e.x += e.vx * timeScale;
            if(e.x < e.w/2 || e.x > canvas.width - e.w/2) e.vx *= -1;
        } else {
            e.timer += dt; if(e.timer > 3000) e.fading = true;
        }

        // Hit Detection
        for(let j=bullets.length-1; j>=0; j--) {
            let b = bullets[j];
            // Lock On Logic
            if(lockedEnemyId !== null && lockedEnemyId !== e.id) continue;

            // Hitbox
            let hit = false;
            let targetY = e.y;
            if(e.isBoss) {
                targetY = e.y - (e.activePhase * 30);
                if(b.x > e.x-e.w/2-10 && b.x < e.x+e.w/2+10 && b.y > targetY-20 && b.y < targetY+10) hit = true;
            } else {
                if(b.x > e.x-e.w/2-10 && b.x < e.x+e.w/2+10 && b.y > e.y-20 && b.y < e.y+10) hit = true;
            }

            if(hit) {
                bullets.splice(j,1);
                if(lockedEnemyId === null) lockedEnemyId = e.id;

                // --- LOGIC: BAN (BLUE) ---
                if(b.type === 'ban') {
                    e.banHits++; playSound('hit_eng');
                    if(e.banHits >= 3) {
                        toggleWordStatus(e.wordData.en);
                        e.fading = true; playSound('ban_success');
                        score += 0;
                    }
                }
                // --- LOGIC: BOOST (YELLOW) ---
                else if(b.type === 'boost') {
                    e.boostHits++; playSound('hit_eng');
                    if(e.boostHits >= 3) {
                        if(!reinforcedWords.has(e.wordData.en)) {
                            toggleReinforceStatus(e.wordData.en);
                            e.fading = true; playSound('boost_success'); score += 200;
                        } else {
                            e.fading = true; // Just remove if already boosted
                        }
                    }
                }
                // --- LOGIC: NORMAL (RED) ---
                else {
                    if(e.isBoosted) {
                        e.demoteHits++; playSound('hit_eng');
                        if(e.demoteHits >= 3) {
                            toggleReinforceStatus(e.wordData.en); // Un-boost
                            e.isBoosted = false; e.color = '#fff'; e.demoteHits=0;
                            playSound('hit_syn'); // Feedback sound
                        }
                    } else if (e.isBoss && !e.bossFinished) {
                        e.phases[e.activePhase].hits++; playSound('hit_eng');
                        if(e.phases[e.activePhase].hits >= 3) {
                            e.phases[e.activePhase].completed = true;
                            e.activePhase++;
                            if(e.activePhase >= 3) {
                                e.bossFinished = true; playSound('hit_syn');
                                score += 500;
                            }
                        }
                    } else if (!e.isBoss) {
                        if(e.stage === 0) {
                            e.hits++; playSound('hit_eng');
                            if(e.hits >= 3) {
                                e.stage = 1; e.text = e.wordData.es[0]; e.color = '#0f0';
                                score += 50;
                            }
                        } else {
                            e.fading = true; playSound('hit_syn');
                            score += 100;
                        }
                    }
                }
                document.getElementById('score').innerText = score;
                break;
            }
        }

        // Fading
        if(e.fading) {
            if(lockedEnemyId === e.id) lockedEnemyId = null;
            enemies.splice(i,1); continue;
        }
        // Collision Player
        if(!player.invincible && !e.bossFinished && Math.abs(e.x - player.x - player.w/2) < 30 && Math.abs(e.y - player.y) < 30) {
            lives--; document.getElementById('lives').innerText = lives;
            player.invincible = true; player.invTimer = 2000;
            playSound('player_hit');
            if(lockedEnemyId === e.id) lockedEnemyId = null;
            enemies.splice(i,1);
            if(lives <= 0) { gameRunning = false; document.getElementById('game-over-screen').style.display = 'flex'; }
        }
        // Bottom
        if(e.y > canvas.height) {
            if(lockedEnemyId === e.id) lockedEnemyId = null;
            enemies.splice(i,1);
        }
    }
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Draw Player
    if(!player.invincible || Date.now() % 200 < 100) {
        ctx.fillStyle = player.color; ctx.fillRect(player.x, player.y, player.w, player.h);
        // Console style detail
        ctx.fillStyle = '#000'; ctx.fillRect(player.x+10, player.y+10, 5, 20); ctx.fillRect(player.x+33, player.y+10, 5, 20);
    }

    // Draw Bullets
    bullets.forEach(b => {
        ctx.fillStyle = b.type === 'ban' ? '#04d9ff' : (b.type === 'boost' ? '#fff01f' : '#ff3131');
        ctx.fillRect(b.x-3, b.y, 6, 15);
    });

    // Draw Enemies
    enemies.forEach(e => {
        ctx.globalAlpha = (lockedEnemyId !== null && lockedEnemyId !== e.id) ? 0.2 : 1.0;
        
        ctx.font = '16px "Press Start 2P"';
        ctx.textAlign = 'center';
        
        // Draw Text
        if(e.isBoss) {
            e.phases.forEach((p, idx) => {
                let yPos = e.y - (idx*25);
                ctx.fillStyle = p.completed ? '#444' : (idx === e.activePhase ? e.color : '#222');
                ctx.fillText(p.text, e.x, yPos);
                
                // Dots for Boss
                if(idx === e.activePhase) {
                    for(let k=0; k<3; k++) {
                        ctx.fillStyle = k < p.hits ? '#ff3131' : '#444';
                        ctx.fillRect(e.x - 20 + (k*15), yPos + 5, 4, 4);
                    }
                }
            });
        } else {
            ctx.fillStyle = e.isBoosted ? '#FFD700' : e.color;
            if(e.isBoosted) ctx.shadowBlur = 10; ctx.shadowColor = '#FFD700';
            ctx.fillText(e.text, e.x, e.y);
            ctx.shadowBlur = 0;

            // Dots Logic
            let dotsY = e.y + 15;
            // Red (Normal)
            if(!e.isBoosted && e.banHits === 0 && e.boostHits === 0) {
                for(let k=0; k<3; k++) {
                    ctx.fillStyle = (e.stage===0 && k<e.hits) ? '#0f0' : '#333';
                    ctx.fillRect(e.x - 15 + (k*12), dotsY, 4, 4);
                }
            }
            // Blue (Ban)
            if(e.banHits > 0) {
                for(let k=0; k<3; k++) {
                    ctx.fillStyle = k < e.banHits ? '#04d9ff' : '#333';
                    ctx.fillRect(e.x - 15 + (k*12), dotsY, 4, 4);
                }
            }
            // Yellow (Boost)
            if(e.boostHits > 0) {
                for(let k=0; k<3; k++) {
                    ctx.fillStyle = k < e.boostHits ? '#fff01f' : '#333';
                    ctx.fillRect(e.x - 15 + (k*12), dotsY, 4, 4);
                }
            }
            // Red on Boosted (Demote)
            if(e.isBoosted && e.demoteHits > 0) {
                for(let k=0; k<3; k++) {
                    ctx.fillStyle = k < e.demoteHits ? '#ff3131' : '#333';
                    ctx.fillRect(e.x - 15 + (k*12), dotsY, 4, 4);
                }
            }
        }
        ctx.globalAlpha = 1.0;
    });
}

function startGame() {
    document.getElementById('start-screen').style.display='none';
    document.getElementById('game-over-screen').style.display='none';
    resize();
    lives = 5; score = 0; enemies = []; bullets = [];
    document.getElementById('lives').innerText = lives;
    document.getElementById('score').innerText = score;
    gameRunning = true; 
    loop(0);
}

// --- INPUTS ---
const keys = {};
document.addEventListener('keydown', e => {
    keys[e.code] = true;
    if(gameRunning) {
        if(e.code === 'Space') { e.preventDefault(); bullets.push({x:player.x+player.w/2, y:player.y, type:'normal'}); playSound('shoot'); }
        if(e.code === 'KeyB') { e.preventDefault(); bullets.push({x:player.x+player.w/2, y:player.y, type:'ban'}); playSound('ban_shoot'); }
        if(e.code === 'KeyV') { e.preventDefault(); bullets.push({x:player.x+player.w/2, y:player.y, type:'boost'}); playSound('boost_shoot'); }
    }
});
document.addEventListener('keyup', e => keys[e.code] = false);

// Touch
const touchStart = (type) => { 
    if(!gameRunning) return;
    bullets.push({x:player.x+player.w/2, y:player.y, type:type}); 
    playSound(type === 'normal' ? 'shoot' : (type === 'ban' ? 'ban_shoot' : 'boost_shoot'));
};
document.getElementById('btn-left').addEventListener('touchstart', (e)=>{ e.preventDefault(); keys['ArrowLeft']=true; });
document.getElementById('btn-left').addEventListener('touchend', (e)=>{ e.preventDefault(); keys['ArrowLeft']=false; });
document.getElementById('btn-right').addEventListener('touchstart', (e)=>{ e.preventDefault(); keys['ArrowRight']=true; });
document.getElementById('btn-right').addEventListener('touchend', (e)=>{ e.preventDefault(); keys['ArrowRight']=false; });

document.getElementById('btn-fire').addEventListener('touchstart', (e)=>{ e.preventDefault(); touchStart('normal'); });
document.getElementById('btn-ban').addEventListener('touchstart', (e)=>{ e.preventDefault(); touchStart('ban'); });
document.getElementById('btn-boost').addEventListener('touchstart', (e)=>{ e.preventDefault(); touchStart('boost'); });

window.onload = () => { loadConfig(); loadVocabData(); resize(); renderCategoryBar(); };
</script>
</body>
</html>
