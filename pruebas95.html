<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Polyglot Tutor V29</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #005ec4;
            --primary-soft: #e3f2fd;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
            --bg-body: #F2F2F7;
            --text-main: #1C1C1E;
            --text-muted: #8E8E93;
            --card-bg: #FFFFFF;
            --radius: 16px;
            --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.04);
            --header-height: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            padding-top: var(--header-height);
            padding-bottom: 60px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ====== HEADER ====== */
        #mdc-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        #mdc-header a {
            text-decoration: none; font-weight: 800; font-size: 20px; letter-spacing: 0.5px;
            color: white; 
        }

        /* ====== DASHBOARD ====== */
        .dashboard-container {
            width: 95%; max-width: 1100px; margin-top: 30px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dash-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 24px; box-shadow: var(--shadow-soft);
            display: flex; flex-direction: column; gap: 15px;
            transition: transform 0.2s ease;
            position: relative;
        }
        .dash-card:hover { transform: translateY(-2px); }
        
        .dash-header-row { display: flex; justify-content: space-between; align-items: center; }
        .dash-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .dash-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.4; flex-grow: 1; }

        /* Settings Gear & Menu */
        .btn-gear { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #d1d1d6; padding: 5px; transition: color 0.2s; }
        .btn-gear:hover { color: var(--text-main); }
        .settings-dropdown {
            display: none; position: absolute; top: 50px; right: 20px; width: 200px;
            background: white; border: 1px solid #e5e5ea; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 10; padding: 8px;
        }
        .settings-dropdown.active { display: block; }
        .settings-label { font-size: 0.7rem; font-weight: 700; color: #8e8e93; padding: 4px 8px; text-transform: uppercase; margin-bottom: 4px; }
        .menu-item {
            width: 100%; text-align: left; padding: 10px; border: none; background: none;
            font-size: 0.85rem; font-weight: 600; color: #1c1c1e; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .menu-item:hover { background: #f2f2f7; }
        .menu-item.danger { color: var(--danger); }
        .menu-item.danger:hover { background: #fff5f5; }

        /* Free Study Button */
        .btn-free-study {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white; border: none; padding: 16px; border-radius: 12px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
        }
        .btn-free-study:hover { opacity: 0.95; }

        /* Type Selectors */
        .type-selector { display: flex; gap: 8px; margin-bottom: 5px; }
        .type-pill {
            padding: 6px 12px; border-radius: 20px; border: 1px solid #e5e5ea;
            font-size: 0.75rem; font-weight: 600; cursor: pointer; background: #fff; color: var(--text-muted);
            transition: all 0.2s;
        }
        .type-pill.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        .type-pill:hover:not(.active) { background: #f2f2f7; }

        .input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #e5e5ea; border-radius: 8px; font-size: 0.95rem; background: #f9f9fb; transition: border 0.2s; }
        input[type="text"]:focus { border-color: var(--primary); outline: none; background: #fff; }
        
        .btn-add-resource { width: 100%; padding: 12px; background: var(--text-main); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        
        /* Data Actions */
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-data { padding: 10px; background: #f2f2f7; color: var(--text-main); border: 1px solid #e5e5ea; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 6px;}
        .btn-data:hover { background: #e5e5ea; }

        /* ====== FILTER & SEARCH TOOLBAR ====== */
        .filter-toolbar {
            width: 95%; max-width: 1100px; margin-top: 30px; margin-bottom: 10px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between;
        }
        .filter-pills { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-btn {
            padding: 8px 16px; border-radius: 20px; background: #e5e5ea; border: none;
            color: #666; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .filter-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(0,122,255,0.3); }
        .search-box { position: relative; flex-grow: 1; max-width: 300px; }
        .search-box input { 
            padding-left: 34px; border-radius: 20px; background: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; font-size: 0.9rem; pointer-events: none; }

        /* ====== GRID ====== */
        .section-header { width: 95%; max-width: 1100px; margin-top: 10px; margin-bottom: 15px; font-weight: 800; font-size: 1.2rem; color: var(--text-main); display:flex; align-items:center; justify-content:space-between; }
        .grid-container { width: 95%; max-width: 1100px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding-bottom: 40px; }
        
        .resource-card { background: white; border-radius: 14px; overflow: hidden; box-shadow: var(--shadow-soft); transition: transform 0.2s; display: flex; flex-direction: column; position: relative; height: 100%; }
        .resource-card:hover { transform: translateY(-3px); }
        
        .media-area { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .media-area.video img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; transition: transform 0.2s; z-index: 2; }
        .media-area:hover .play-icon { transform: translate(-50%, -50%) scale(1.1); }
        .play-icon svg { width: 20px; height: 20px; fill: black; margin-left: 2px; }
        .media-area.audio { background: linear-gradient(135deg, #FF9500, #FF3B30); }
        .audio-icon { font-size: 3rem; color: white; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .media-area.web { flex-direction: column; align-items: flex-start; justify-content: flex-end; padding: 20px; box-sizing: border-box; }
        .web-domain-tag { background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; color: #333; margin-bottom: auto; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .web-favicon-box { width: 48px; height: 48px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 8px; }
        .web-favicon-box img { width: 28px; height: 28px; object-fit: contain; }
        .web-domain-text { font-size: 1rem; font-weight: 800; color: rgba(0,0,0,0.7); }

        .card-info { padding: 14px; display: flex; justify-content: space-between; gap: 10px; flex-grow: 1; }
        .card-title { font-weight: 600; font-size: 0.9rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: #1d1d1f; }
        .card-actions { display: flex; gap: 4px; align-items: flex-start; flex-wrap: wrap; justify-content: flex-end; }
        .btn-action { background: #f2f2f7; border: none; cursor: pointer; padding: 6px 10px; border-radius: 8px; font-size: 0.9rem; transition: background 0.2s; }
        .btn-edit:hover { background: var(--primary); color: white; }
        .btn-delete:hover { background: var(--danger); color: white; }
        .btn-duplicate:hover { background: var(--success); color: white; }
        .btn-meta:hover { background: var(--warning); color: white; }

        /* ====== EDITOR ====== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .editor-popup { background: white; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        
        @media (min-width: 900px) {
            .editor-popup { width: 95%; max-width: 1500px; height: 85vh; flex-direction: row; border-radius: 18px; }
            .editor-popup.is-fullscreen { width: 100vw !important; height: 100vh !important; max-width: none !important; border-radius: 0 !important; }
        }

        .desktop-media-container { display: none; background: #000; align-items: center; justify-content: center; flex-direction: column; }
        @media (min-width: 900px) { 
            .desktop-media-container { display: flex; width: 40%; flex-shrink: 0; position: relative; } 
            .editor-content-panel { flex: 1; min-width: 300px; } 
            .opacity-control-group { display: none !important; }
            .editor-popup.free-mode .desktop-media-container { display: none !important; }
            .editor-popup.free-mode .resizer-gutter { display: none !important; }
            .editor-popup.free-mode .editor-content-panel { width: 100% !important; }
            .editor-popup.free-mode #btn-main-play, .editor-popup.free-mode .btn-media { display: none !important; }
        }
        
        /* WEB TAB STYLES */
        .media-iframe-wrapper { width: 100%; height: 100%; position: relative; background: #f9f9fb; display: flex; flex-direction: column; }
        .web-tab-nav {
            display: flex; background: #f2f2f7; border-bottom: 1px solid #e5e5ea; height: 40px; flex-shrink: 0; overflow-x: auto;
        }
        .web-tab-btn {
            flex: 1; border: none; background: transparent; font-size: 0.8rem; font-weight: 600; color: #86868b; min-width: 80px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;
            border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 8px;
        }
        .web-tab-btn:hover { background: rgba(0,0,0,0.02); }
        .web-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        
        /* New Gear style in tab */
        .tab-gear {
            font-size: 0.75rem; opacity: 0.5; margin-left: 4px; padding: 2px; border-radius: 50%;
        }
        .tab-gear:hover { opacity: 1; background: rgba(0,0,0,0.05); color: var(--text-main); }

        .web-content-area {
            flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; background: #f0f0f3;
        }
        .web-frame-container {
            width: 100%; height: 100%; display: none; position: relative;
        }
        .web-frame-container.active { display: block; }
        .web-frame-container iframe { width: 100%; height: 100%; border: none; position: relative; z-index: 2; background: transparent; }
        
        /* Error/Empty State Background */
        .web-error-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #c7c7cc; z-index: 1;
        }
        .web-error-bg svg { width: 48px; height: 48px; fill: #d1d1d6; margin-bottom: 10px; }
        
        .media-audio-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #1c1c1e; }
        audio { width: 80%; }

        .editor-content-panel { display: flex; flex-direction: column; height: 100%; background: white; }
        .resizer-gutter { display: none; width: 10px; background: #f2f2f7; cursor: col-resize; flex-shrink: 0; border-left: 1px solid #e5e5ea; border-right: 1px solid #e5e5ea; }
        @media (min-width: 900px) { .resizer-gutter { display: block; } }

        .editor-header { padding: 10px 16px; background: rgba(255,255,255,0.95); border-bottom: 1px solid #e5e5ea; display: flex; justify-content: space-between; align-items: center; }
        .editor-title { font-weight: 700; font-size: 1rem; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn-header-icon { background: #f2f2f7; border: none; width: 34px; height: 34px; border-radius: 50%; cursor: pointer; color: #8e8e93; display: flex; align-items: center; justify-content: center; }
        .btn-header-icon:hover { background: #e5e5ea; color: #1c1c1e; }
        .btn-header-icon.active { background: var(--primary); color: white; }
        #btn-fullscreen { display: none; }
        @media (min-width: 900px) { #btn-fullscreen { display: flex; } }

        .editor-toolbar { width: 100%; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; gap: 14px; overflow-x: auto; scrollbar-width: none; }
        .toolbar-group { display: flex; align-items: center; gap: 8px; padding-right: 14px; border-right: 1px solid #e5e5ea; flex-shrink: 0; }
        .toolbar-group:last-child { border-right: none; }
        .btn-fmt { width: 38px; height: 38px; border: none; background: #f2f2f7; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: all 0.2s;}
        .btn-fmt.is-active { background: var(--primary); color: white; }
        .btn-ai-trigger { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #007AFF; }
        .btn-ai-trigger:hover { transform: scale(1.05); }
        .btn-save-template { background: #fff8e1; color: #d97706; font-size: 0.8rem; width: auto; padding: 0 12px; }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; margin: 0 3px;}
        .color-dot.active { border-color: #000; transform: scale(1.15); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* New Target Selector Group */
        .ctrl-target-group { display: flex; background: #e5e5ea; border-radius: 8px; padding: 2px; margin-right: 8px; }
        .btn-target { width: 24px; height: 100%; border: none; background: transparent; border-radius: 6px; font-size: 0.7rem; font-weight: 700; color: #8e8e93; cursor: pointer; }
        .btn-target.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .media-controls { display: flex; gap: 8px; }
        .btn-media { padding: 0 14px; height: 38px; background: #f2f2f7; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display:flex; align-items:center; justify-content:center; }
        #btn-main-play { min-width: 44px; font-size: 1.1rem; }
        #btn-main-play.is-playing { background-color: #fff3cd; color: #d97706; }
        #btn-main-play.is-paused { background-color: #d1e7dd; color: #198754; }
        .btn-clear { width: 38px; height: 38px; border-radius: 10px; border: 1px solid #e5e5ea; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-clear svg { width: 20px; height: 20px; fill: var(--text-muted); }

        .editor-area { flex: 1; width: 100%; padding: 30px; border: none; font-family: 'Inter', sans-serif; font-size: 17px; line-height: 1.6; overflow-y: auto; outline: none; }
        .editor-footer { padding: 12px 16px; border-top: 1px solid #e5e5ea; text-align: right; background: #fbfbfd; font-size: 0.8rem; color: #86868b; }

        /* ====== AI HUB ====== */
        .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .ai-popup-overlay.active { display: flex; }
        .ai-popup-box { background: white; width: 92%; max-width: 700px; border-radius: 18px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; font-family: 'Inter', sans-serif; max-height: 90vh; }
        .ai-header { background: #F9F9FB; border-bottom: 1px solid #e5e5ea; color: var(--text-main); padding: 16px 20px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .ai-close { background: #e5e5ea; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ai-body { padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; flex:1; }
        .ai-label { font-size: 0.7rem; font-weight: 700; color: #86868b; text-transform: uppercase; margin-bottom: 2px; margin-top: 8px;}
        .ai-select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; background: #fff; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; }
        .ai-select.override-warning { border-color: var(--danger); background-color: #fff0f0; color: #b71c1c; opacity: 0.6; }
        .ai-help-box { display: none; background: #eef2ff; color: #3730a3; padding: 14px; border-radius: 10px; font-size: 0.85rem; margin-bottom: 10px; border: 1px solid #c7d2fe; line-height: 1.5; }
        .ai-custom-input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d1d1d6; background: #fff; font-size: 0.85rem; margin-top: 4px; font-family: inherit; transition: border-color 0.2s; }
        .ai-custom-input:focus { border-color: var(--primary); outline: none; }
        textarea.ai-custom-input { resize: vertical; min-height: 60px; }
        .level-group { display: flex; gap: 8px; }
        .level-btn { flex: 1; padding: 10px; border: 1px solid #e5e5ea; border-radius: 8px; background: #fff; color: #666; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .level-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .flag-group { display: flex; gap: 10px; }
        .flag-btn { border: 1px solid #e5e5ea; border-radius: 10px; background: #fff; font-size: 1.6rem; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; filter: grayscale(100%); }
        .flag-btn:hover { opacity: 1; filter: grayscale(0%); }
        .flag-btn.selected { border-color: var(--primary); background: #e3f2fd; opacity: 1; filter: grayscale(0%); }
        .flag-btn.hidden { display: none !important; }
        .flag-sm { width: 40px; height: 40px; font-size: 1.2rem; }
        .ai-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .btn-ai-action { padding: 14px; border: none; border-radius: 12px; background: #f2f2f7; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-ai-primary { background: var(--primary); color: white; }
        .saved-item { background: #fff; border: 1px solid #e5e5ea; border-radius: 12px; padding: 12px; display: flex; align-items: flex-start; gap: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); position: relative; overflow: hidden; }
        .saved-num { font-size: 1.1rem; font-weight: 800; color: #e5e5ea; min-width: 30px; text-align: center; padding-top: 2px; }
        .saved-info { flex: 1; min-width: 0; display: flex; flex-direction: column; }
        .saved-name { font-weight: 600; font-size: 0.9rem; color: #1d1d1f; white-space: normal; word-break: break-word; line-height: 1.4; display: block; }
        .saved-date { font-size: 0.7rem; color: #86868b; margin-top: 2px;}
        .badge-new { background: var(--success); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; vertical-align: middle; display: inline-block; }
        .badge-tpl { background: var(--warning); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
        .mem-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; margin-top: 5px; }
        .btn-insert { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap;}
        .btn-icon-action { width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer; display:flex; align-items:center; justify-content:center;}
        .btn-rename { background: #f2f2f7; color: #666; }
        .btn-delete-item { background: #fff5f5; color: var(--danger); }
        .btn-export-item { background: #e3f2fd; color: var(--primary); }
        .btn-clear-mem { margin-top: 10px; width: 100%; padding: 12px; border: none; background: #fff0f0; color: var(--danger); font-size: 0.9rem; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .mem-controls { display: flex; gap: 8px; margin-top: 10px; }
        .btn-mem-ctrl { flex: 1; padding: 10px; border: 1px solid #e5e5ea; background: #f9f9fb; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-mem-ctrl:hover { background: #e5e5ea; }
        .voice-section { background: #f9f9fb; padding: 16px; border-top: 1px solid #e5e5ea; margin-top: 20px; }
        .voice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .voice-label { font-size: 0.8rem; font-weight: 700; color: #1c1c1e; text-transform: uppercase; }
        .btn-help { width: 22px; height: 22px; background: #e5e5ea; color: #8e8e93; border: none; border-radius: 50%; cursor: pointer; font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
        .btn-help:hover { background: var(--primary); color: white; }
        .voice-help-box { display: none; background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #e5e5ea; font-size: 0.8rem; color: #333; margin-bottom: 15px; line-height: 1.5; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .voice-item-label { display: block; font-size: 0.75rem; font-weight: 600; color: #666; margin-bottom: 4px; margin-top: 10px; }
        .voice-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d1d1d6; background: #fff; }
        
        /* ====== EXERCISE RENDER ====== */
        .exercise-box { background: #fff; border: 1px solid #e5e5ea; border-radius: 12px; padding: 20px; margin: 20px 0; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .exercise-header { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 16px; border-bottom: 1px solid #f2f2f7; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .exercise-header span { flex: 1; word-wrap: break-word; overflow-wrap: break-word; }
        .btn-theory { background: var(--primary-soft); color: var(--primary); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
        .btn-del-block { background: #fff5f5; color: var(--danger); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 5px; }
        .btn-reset-block { background: #fff8e1; color: #d97706; border: none; padding: 6px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: 700; white-space: nowrap; margin-left: 5px; }
        .theory-box { display: none; background: #f9f9fb; padding: 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; }
        .exercise-row { margin-bottom: 16px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; line-height: 1.8; position: relative; } 
        .hint-box, .trans-box { display: none; width: 100%; margin-top: 8px; padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; }
        .hint-box { background: #fffbe6; border-left: 4px solid #f59e0b; color: #78350f; }
        .trans-box { background: #f0f9ff; border-left: 4px solid #007AFF; color: #0c4a6e; }
        .trans-line { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .btn-mini-speak { background: #fff; border: 1px solid #d1d1d6; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .ex-select { padding: 8px 14px; border: 1px solid #d1d1d6; border-radius: 8px; background: white; cursor: pointer; outline: none; font-size: 0.95rem; appearance: none; padding-right: 2.5rem; max-width: 100%; white-space: normal; }
        .ex-select.correct { border-color: var(--success) !important; background-color: #e8f5e9 !important; color: #1b5e20 !important; font-weight: 700; }
        .ex-select.wrong { border-color: var(--danger) !important; background-color: #ffebee !important; color: #b71c1c !important; animation: shake 0.3s; }
        .ex-btn-icon { background: #f2f2f7; border: none; border-radius: 8px; cursor: pointer; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; color: #1d1d1f; }
        .ex-btn-icon:hover { background: #e5e5ea; color: var(--primary); }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        /* ====== SPECIAL EXERCISE STYLES ====== */
        /* Find and Fix Mistake styling */
        .exercise-row s {
            color: var(--danger);
            text-decoration: line-through;
            text-decoration-thickness: 2px;
            text-decoration-color: var(--danger);
            background-color: rgba(255, 59, 48, 0.1);
            padding: 2px 6px;
            border-radius: 6px;
            margin-right: 8px;
            font-weight: 600;
            display: inline-block;
        }
        .exercise-row s::before { content: "‚úñ"; font-size: 0.7em; margin-right: 4px; vertical-align: text-top; opacity: 0.6; }
        
        /* Better dropdown alignment in text */
        .cloze-gap-container { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 4px; }
    </style>
</head>
<body>

    <div id="mdc-header">
        <a href="https://paradisonetworx.com/mdceng.html">MDC ENG</a>
    </div>

    <div class="dashboard-container">
        
        <div class="dash-card" style="border-top: 4px solid var(--primary);">
            <div class="dash-header-row">
                <div class="dash-title">
                    <span style="font-size:1.5rem">üìù</span> Study Whiteboard
                </div>
            </div>
            <div class="dash-desc">
                Open the editor without media. Ideal for Templates, designing lessons, or practicing AI exercises.
            </div>
            <button class="btn-free-study" onclick="openFreeEditor()">
                <span>Open Editor</span>
                <span>‚Üí</span>
            </button>
        </div>

        <div class="dash-card">
            <div class="dash-header-row">
                <div class="dash-title">
                    <span style="font-size:1.5rem">üîó</span> Add Resource
                </div>
                <button class="btn-gear" onclick="toggleSettingsMenu()" title="Manage Resources">‚öôÔ∏è</button>
            </div>
            
            <div id="settings-menu" class="settings-dropdown">
                <div class="settings-label">DELETE RESOURCES</div>
                <button class="menu-item" onclick="clearResources('video')">üóëÔ∏è Clear All Videos</button>
                <button class="menu-item" onclick="clearResources('audio')">üóëÔ∏è Clear All Audio</button>
                <button class="menu-item" onclick="clearResources('web')">üóëÔ∏è Clear All Web</button>
                <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
                <button class="menu-item danger" onclick="clearResources('all')">‚ö†Ô∏è Clear Everything</button>
            </div>

            <div class="type-selector">
                <div class="type-pill active" onclick="setResourceType('auto')" id="type-auto">‚ú® Auto</div>
                <div class="type-pill" onclick="setResourceType('video')" id="type-video">üé• Video</div>
                <div class="type-pill" onclick="setResourceType('audio')" id="type-audio">üéß Audio</div>
                <div class="type-pill" onclick="setResourceType('web')" id="type-web">üåê Web</div>
            </div>

            <div class="input-group">
                <label>URL 1 (Primary)</label>
                <input type="text" id="resUrl" placeholder="Paste URL here...">
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>URL 2 (Tab 2)</label>
                <input type="text" id="resUrl2" placeholder="Second Link (Video/Web)...">
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>URL 3 (Tab 3)</label>
                <input type="text" id="resUrl3" placeholder="Third Link (Video/Web)...">
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>URL 4 (Tab 4)</label>
                <input type="text" id="resUrl4" placeholder="Fourth Link (Video/Web)...">
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>URL 5 (Tab 5)</label>
                <input type="text" id="resUrl5" placeholder="Fifth Link (Video/Web)...">
            </div>

            <div class="input-group" style="margin-top:10px;">
                <label>Title</label>
                <input type="text" id="resTitle" placeholder="e.g. French Article">
            </div>
            <button class="btn-add-resource" onclick="addResource()" style="margin-top:10px;">Save to Library</button>
        </div>

        <div class="dash-card">
            <div class="dash-header-row">
                <div class="dash-title">
                    <span style="font-size:1.5rem">üíæ</span> Data & Backup
                </div>
            </div>
            <div class="dash-desc">
                Backup your entire library and notes to avoid losing progress.
            </div>
            <div class="data-grid">
                <button class="btn-data" onclick="downloadBackup()">‚¨áÔ∏è Backup</button>
                <input type="file" id="importFile" accept=".html,.json" style="display:none" onchange="importBackup(this)">
                <button class="btn-data" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import</button>
            </div>
        </div>

    </div>

    <div class="filter-toolbar">
        <div class="filter-pills">
            <button class="filter-btn active" onclick="applyFilter('all', this)">All</button>
            <button class="filter-btn" onclick="applyFilter('video', this)">Video</button>
            <button class="filter-btn" onclick="applyFilter('audio', this)">Audio</button>
            <button class="filter-btn" onclick="applyFilter('web', this)">Web</button>
        </div>
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Search title..." oninput="applySearch()">
        </div>
    </div>

    <div class="section-header">
        <span>üìö Library</span>
    </div>

    <div class="grid-container" id="video-grid"></div>

    <div class="modal-overlay" id="editor-modal">
        <div class="editor-popup" id="editor-popup">
            <div class="desktop-media-container" id="desktop-media-wrapper"></div>
            <div class="resizer-gutter" id="drag-resizer"></div>
            <div class="editor-content-panel" id="editor-panel">
                <div class="editor-header">
                    <span class="editor-title">Note Editor</span>
                    <div class="header-actions">
                        <button class="btn-header-icon" id="btn-fullscreen" onclick="toggleEditorFullScreen()" title="Expand Editor">‚õ∂</button>
                        <button class="btn-header-icon" onclick="closeEditor()" title="Close">√ó</button>
                    </div>
                </div>
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <div class="color-dot" style="background:#1d1d1f" onmousedown="event.preventDefault(); applyColor('#1d1d1f')"></div>
                        <div class="color-dot" style="background:#FF3B30" onmousedown="event.preventDefault(); applyColor('#FF3B30')"></div>
                        <div class="color-dot" style="background:#007AFF" onmousedown="event.preventDefault(); applyColor('#007AFF')"></div>
                        <div class="color-dot" style="background:#34C759" onmousedown="event.preventDefault(); applyColor('#34C759')"></div>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn-fmt" id="btn-bold" onmousedown="event.preventDefault(); toggleBold()">B</button>
                        <button class="btn-fmt" id="btn-size-norm" onmousedown="event.preventDefault(); setSize(3)">T</button>
                        <button class="btn-fmt" id="btn-size-lg" onmousedown="event.preventDefault(); setSize(5)" style="font-size:1.2rem">T+</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn-fmt btn-ai-trigger" onclick="openAIMenu()" title="AI Exercise Hub">‚ö°</button>
                        <button class="btn-fmt btn-save-template" onclick="saveEditorAsTemplate()" title="Save current editor content as reusable template">üíæ Save Template</button>
                    </div>
                    <div class="toolbar-group">
                        <div class="ctrl-target-group">
                            <button class="btn-target active" onclick="setControlTarget(0)">1</button>
                            <button class="btn-target" onclick="setControlTarget(1)">2</button>
                            <button class="btn-target" onclick="setControlTarget(2)">3</button>
                            <button class="btn-target" onclick="setControlTarget(3)">4</button>
                            <button class="btn-target" onclick="setControlTarget(4)">5</button>
                        </div>
                        <button class="btn-media" onclick="seekVideo(-3)">-3s</button>
                        <button class="btn-media" id="btn-main-play" onclick="togglePlay()">‚èØÔ∏è</button>
                        <button class="btn-media" onclick="seekVideo(3)">+3s</button>
                        <button class="btn-media btn-speed" id="btn-speed" onclick="cycleSpeed()">1x</button>
                    </div>
                    <button class="btn-clear" onclick="if(confirm('Clear all?')) { document.getElementById('editor-text').innerHTML=''; saveNote(); }" title="Clear All">
                        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </button>
                </div>
                <div class="opacity-control-group" style="padding: 10px 16px;">
                    <label>Opacity</label>
                    <input type="range" min="0.2" max="1" step="0.1" value="1" oninput="document.getElementById('editor-popup').style.opacity = this.value" style="width:100%">
                </div>
                <div id="editor-text" class="editor-area" contenteditable="true" placeholder="Type here..." oninput="saveNote()"></div>
                <div class="editor-footer"><span class="save-indicator">‚úì Saved</span></div>
            </div>
        </div>
    </div>

    <div class="ai-popup-overlay" id="ai-hub-modal">
        <div class="ai-popup-box">
            <div class="ai-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>‚ö° Polyglot AI Hub</span>
                    <button class="btn-help" onclick="toggleAiHelp()" title="Help">?</button>
                </div>
                <button class="ai-close" onclick="closeAIMenu()">√ó</button>
            </div>
            <div class="ai-body">
                
                <div id="ai-help-box" class="ai-help-box">
                    <b>How to create exercises:</b><br>
                    1. Select options in Context, Grammar, and Type.<br>
                    2. If you type in "Custom" fields, selected options will be ignored.<br>
                    3. Click <b>Create Mission</b> to copy the prompt.<br>
                    4. Paste into your AI (ChatGPT/Gemini), copy JSON, click <b>Import</b>.
                </div>

                <div class="ai-label">1. Context & Situation:</div>
<select id="ai-context-select" class="ai-select">
    <option value="" selected disabled>-- Select Context --</option>
    <optgroup label="üè† Daily Life & Lifestyle">
        <option value="Daily Routine & Habits">Daily Routine & Habits</option>
        <option value="Family & Relationships">Family & Relationships</option>
        <option value="House & Chores">House, Furniture & Chores</option>
        <option value="Food, Cooking & Restaurants">Food, Cooking & Restaurants</option>
        <option value="Health, Fitness & Body">Health, Fitness & Doctors</option>
        <option value="Hobbies, Music & Movies">Hobbies, Music & Movies</option>
    </optgroup>
    <optgroup label="‚úàÔ∏è Travel & Adventure">
        <option value="At the Airport & Flying">At the Airport & Flying</option>
        <option value="Hotel Check-in & Problems">Hotel Situations</option>
        <option value="Asking for Directions & City">City & Directions</option>
        <option value="Car Rental & Driving">Car Rental & Driving</option>
    </optgroup>
    <optgroup label="üíº Work & Business">
        <option value="Job Interviews & CVs">Job Interviews & HR</option>
        <option value="Business Meetings & Strategy">Meetings & Negotiations</option>
        <option value="Emails & Formal Communication">Formal Emails</option>
        <option value="Tech, IT & Programming">Tech, IT & Programming</option>
        <option value="Marketing & Sales">Marketing & Sales</option>
        <option value="Customer Service Scenarios">Customer Service Issues</option>
    </optgroup>
    <optgroup label="üéì Academic & Abstract">
        <option value="University & Campus Life">University & Campus Life</option>
        <option value="Science & Environment">Science & Environment</option>
        <option value="Debating Opinions & Ethics">Debating Opinions</option>
        <option value="News & Current Events">News & Current Events</option>
    </optgroup>
</select>
                <input type="text" id="ai-context-custom" class="ai-custom-input" placeholder="Or type custom context..." oninput="checkCustomOverride('ai-context-custom', 'ai-context-select')">

<div class="ai-label">2. Grammar Focus:</div>
<select id="ai-grammar-select" class="ai-select">
    <option value="" selected disabled>-- Select Grammar Topic --</option>
    <optgroup label="üïí Present Tenses">
        <option value="Present Simple">Present Simple (Habits & Facts)</option>
        <option value="Present Continuous">Present Continuous (Now & Future)</option>
        <option value="Present Perfect">Present Perfect (Experiences)</option>
        <option value="Present Perfect Continuous">Present Perfect Continuous</option>
        <option value="Present Simple vs Continuous">Mix: Simple vs Continuous</option>
    </optgroup>
    <optgroup label="üîô Past Tenses">
        <option value="Past Simple">Past Simple (Finished Actions)</option>
        <option value="Past Continuous">Past Continuous (Interrupted Actions)</option>
        <option value="Past Perfect">Past Perfect (The Past before the Past)</option>
        <option value="Past Perfect Continuous">Past Perfect Continuous</option>
        <option value="Narrative Tenses Mix">Mix: Narrative Tenses (Storytelling)</option>
    </optgroup>
    <optgroup label="üöÄ Future Tenses">
        <option value="Future Simple (Will)">Future Simple (Will - Spontaneous)</option>
        <option value="Be Going To">Be Going To (Plans)</option>
        <option value="Future Continuous">Future Continuous (In progress later)</option>
        <option value="Future Perfect">Future Perfect (Completed by then)</option>
        <option value="Future Forms Mix">Mix: Will / Going to / Present Cont.</option>
    </optgroup>
    <optgroup label="‚öôÔ∏è Advanced Structures">
        <option value="Conditionals 0 & 1">Conditionals 0 & 1 (Real)</option>
        <option value="Conditionals 2 & 3">Conditionals 2 & 3 (Unreal)</option>
        <option value="Mixed Conditionals">Mixed Conditionals</option>
        <option value="Passive Voice">Passive Voice</option>
        <option value="Reported Speech">Reported Speech (Indirect)</option>
        <option value="Relative Clauses">Relative Clauses (Who, Which, That)</option>
        <option value="Causative (Have/Get something done)">Causative Form</option>
    </optgroup>
    <optgroup label="üß© Particles & Modals">
        <option value="Modal Verbs (Can, Could, Should, Must)">Modal Verbs</option>
        <option value="Modals of Deduction (Must have, Can't have)">Modals of Past Deduction</option>
        <option value="Phrasal Verbs">Phrasal Verbs (General)</option>
        <option value="Prepositions of Place & Time">Prepositions (In, On, At, By)</option>
        <option value="Articles (A, An, The, Zero)">Articles (A / An / The)</option>
        <option value="Gerunds vs Infinitives">Gerunds vs Infinitives</option>
    </optgroup>
</select>
                <input type="text" id="ai-grammar-custom" class="ai-custom-input" placeholder="Or type custom grammar..." oninput="checkCustomOverride('ai-grammar-custom', 'ai-grammar-select')">

                <div class="ai-label">3. Exercise Type:</div>
<select id="ai-type-select" class="ai-select">
    <option value="" selected disabled>-- Select Format --</option>
    <optgroup label="‚úçÔ∏è Standard Practice">
        <option value="Fill in the Blanks (Cloze)">Fill in the Blanks (Classic)</option>
        <option value="Multiple Choice Quiz">Multiple Choice Quiz</option>
        <option value="Find and Fix the Mistake">Find and Fix the Mistake</option>
        <option value="True or False (Reading)">True or False (Reading Comp.)</option>
    </optgroup>
    <optgroup label="üß† Vocabulary & Logic">
        <option value="Vocabulary Matching">Vocabulary Matching (Def - Word)</option>
        <option value="Synonym & Antonym Finder">Synonym Finder</option>
        <option value="Sentence Reordering">Sentence Reordering (Scrambled)</option>
        <option value="Choose the Odd One Out">Odd One Out (Logic)</option>
    </optgroup>
    <optgroup label="üîÑ Translation">
        <option value="Reverse Translation (ES->EN)">Reverse Translation (See ES, Pick EN)</option>
    </optgroup>
</select>
                <input type="text" id="ai-type-custom" class="ai-custom-input" placeholder="Or type custom format..." oninput="checkCustomOverride('ai-type-custom', 'ai-type-select')">

                <div class="ai-label">Gap Density (Difficulty):</div>
                <select id="ai-gap-count" class="ai-select">
                    <option value="1" selected>1 Gap (Standard)</option>
                    <option value="2">2 Gaps per sentence</option>
                    <option value="3">3 Gaps per sentence</option>
                    <option value="random">Random Mix (1-3 gaps)</option>
                </select>

                <div class="ai-label">4. Extra Instructions (Post Data):</div>
                <textarea id="ai-extra-data" class="ai-custom-input" placeholder="E.g. Use British slang, make it funny, focus on medical terms..."></textarea>

                <div class="ai-label">Level:</div>
                <div class="level-group" id="level-group">
                    <button class="level-btn" onclick="selectLevel(this, 'A1-A2 (Beginner)')">A1-A2</button>
                    <button class="level-btn selected" onclick="selectLevel(this, 'B1-B2 (Intermediate)')">B1-B2</button>
                    <button class="level-btn" onclick="selectLevel(this, 'C1-C2 (Advanced)')">C1-C2</button>
                </div>

                <div class="ai-label">Target Language:</div>
                <div class="flag-group" id="target-lang-group">
                    <div class="flag-btn selected" onclick="selectTarget(this, 'en')" title="English">üá∫üá∏</div>
                    <div class="flag-btn" onclick="selectTarget(this, 'es')" title="Spanish">üá™üá∏</div>
                    <div class="flag-btn" onclick="selectTarget(this, 'pt')" title="Portuguese">üáßüá∑</div>
                    <div class="flag-btn" onclick="selectTarget(this, 'it')" title="Italian">üáÆüáπ</div>
                </div>

                <div class="ai-label">Translations:</div>
                <div class="flag-group" id="trans-lang-group">
                    <div class="flag-btn flag-sm" data-lang="en" onclick="toggleTrans(this, 'en')" title="Translate to English">üá∫üá∏</div>
                    <div class="flag-btn flag-sm selected" data-lang="es" onclick="toggleTrans(this, 'es')" title="Translate to Spanish">üá™üá∏</div>
                    <div class="flag-btn flag-sm" data-lang="pt" onclick="toggleTrans(this, 'pt')" title="Translate to Portuguese">üáßüá∑</div>
                    <div class="flag-btn flag-sm" data-lang="it" onclick="toggleTrans(this, 'it')" title="Translate to Italian">üáÆüáπ</div>
                </div>

                <div class="ai-actions">
                    <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">‚ú® Create Mission</button>
                    <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">üì• Import (Paste)</button>
                </div>

                <div class="ai-label">Memory Bank</div>
                <div class="saved-exercises-list" id="ai-memory-list">
                    <div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>
                </div>
                
                <div class="mem-controls">
                    <button class="btn-mem-ctrl" onclick="exportMemoryBank()">‚¨áÔ∏è Export Bank</button>
                    <input type="file" id="importMemFile" accept=".json" style="display:none" onchange="importMemoryBank(this)">
                    <button class="btn-mem-ctrl" onclick="document.getElementById('importMemFile').click()">‚¨ÜÔ∏è Import Bank</button>
                </div>

                <button class="btn-clear-mem" onclick="clearAIMemory()">üóëÔ∏è Clear Memory</button>

                <div class="voice-section">
                    <div class="voice-header">
                        <span class="voice-label">‚öôÔ∏è Voice Settings</span>
                        <button class="btn-help" onclick="document.getElementById('voice-help-box').style.display = document.getElementById('voice-help-box').style.display === 'block' ? 'none' : 'block'" title="Help">?</button>
                    </div>
                    
                    <div id="voice-help-box" class="voice-help-box">
                        <b>Want more voices?</b> Voices depend on your device (System TTS).<br>
                        ‚Ä¢ <b>iPhone/iPad:</b> Settings > Accessibility > Spoken Content > Voices.<br>
                        ‚Ä¢ <b>Android:</b> Settings > Accessibility > Text-to-speech output.<br>
                        ‚Ä¢ <b>Windows:</b> Settings > Time & Language > Speech > Add Voices.
                    </div>

                    <label class="voice-item-label">üá∫üá∏ English Voice</label>
                    <select id="voice-en" class="voice-select"></select>

                    <label class="voice-item-label">üá™üá∏ Spanish Voice</label>
                    <select id="voice-es" class="voice-select"></select>

                    <label class="voice-item-label">üáßüá∑ Portuguese Voice</label>
                    <select id="voice-pt" class="voice-select"></select>

                    <label class="voice-item-label">üáÆüáπ Italian Voice</label>
                    <select id="voice-it" class="voice-select"></select>
                </div>

            </div>
        </div>
    </div>

<script>
        const STORAGE_KEY = 'mdc_saved_favorites';
        const AI_MEM_KEY = 'mdc_ai_exercises';
        let currentTargetLang = 'en'; 
        let currentLevel = 'B1-B2 (Intermediate)';
        const transLangs = new Set(['es']); 
        const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian' };
        
        const grid = document.getElementById('video-grid');
        let gridPlayer = null; 
        
        // Multi-player storage
        let players = [null, null, null, null, null]; 
        let controlTarget = 0; // 0, 1, 2, 3, 4

        let currentEditIndex = -1; let trackingInterval = null; let currentResourceId = null; let voices = [];

        // V27 Variables
        let selectedResourceType = 'auto';
        let currentFilter = 'all';
        let searchQuery = '';

        const modal = document.getElementById('editor-modal');
        const editorArea = document.getElementById('editor-text');
        const aiModal = document.getElementById('ai-hub-modal');

        document.addEventListener('DOMContentLoaded', () => {
            loadResources(); renderAiList(); updateTransFlagsVisibility(); initVoices(); initResizer();
        });

        // --- FUNCIONES AUXILIARES GLOBALES ---
        function getYouTubeID(url) {
            if (!url) return null;
            const match = (url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|live\/)([^#&?]*).*/) || [])[2];
            return (match && match.length === 11) ? match : null;
        }

        function getDomain(url) {
            try { return new URL(url).hostname.replace('www.', ''); } catch(e) { return 'web'; }
        }

        function generatePastelColor() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 90%)`;
        }

        // RESIZER
        function initResizer() {
            const resizer = document.getElementById('drag-resizer');
            const leftSide = document.getElementById('desktop-media-wrapper');
            const popup = document.getElementById('editor-popup');
            let x = 0; let leftWidth = 0;
            const mouseDownHandler = function(e) { x = e.clientX; leftWidth = leftSide.getBoundingClientRect().width; document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler); resizer.classList.add('dragging'); leftSide.style.pointerEvents = 'none'; };
            const mouseMoveHandler = function(e) { const dx = e.clientX - x; const newWidth = leftWidth + dx; const percentage = (newWidth / popup.getBoundingClientRect().width) * 100; if (percentage > 20 && percentage < 80) leftSide.style.width = `${percentage}%`; };
            const mouseUpHandler = function() { document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler); resizer.classList.remove('dragging'); leftSide.style.pointerEvents = 'auto'; };
            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        function toggleEditorFullScreen() {
            document.getElementById('editor-popup').classList.toggle('is-fullscreen');
            document.getElementById('btn-fullscreen').classList.toggle('active');
        }

        // VOICES
        function initVoices() { window.speechSynthesis.onvoiceschanged = populateVoiceLists; populateVoiceLists(); }
        function populateVoiceLists() {
            voices = window.speechSynthesis.getVoices(); if (voices.length === 0) return;
            const map = { 'en': 'en', 'es': 'es', 'pt': 'pt', 'it': 'it' };
            for (const [code, prefix] of Object.entries(map)) {
                const select = document.getElementById(`voice-${code}`); select.innerHTML = '';
                const available = voices.filter(v => v.lang.toLowerCase().startsWith(prefix));
                if(available.length === 0) { const opt = document.createElement('option'); opt.text = "Default / No Voices Found"; select.add(opt); } 
                else { available.forEach((v, i) => { const opt = document.createElement('option'); opt.textContent = `${v.name}`; opt.value = i; opt.setAttribute('data-name', v.name); select.appendChild(opt); }); }
            }
        }

        // SELECTIONS
        function selectTarget(el, lang) { document.querySelectorAll('#target-lang-group .flag-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentTargetLang = lang; updateTransFlagsVisibility(); }
        function selectLevel(el, levelDesc) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentLevel = levelDesc; }
        function updateTransFlagsVisibility() {
            document.querySelectorAll('#trans-lang-group .flag-btn').forEach(btn => {
                const btnLang = btn.getAttribute('data-lang');
                if (btnLang === currentTargetLang) { btn.classList.add('hidden'); btn.classList.remove('selected'); transLangs.delete(btnLang); } else { btn.classList.remove('hidden'); }
            });
        }
        function toggleTrans(el, lang) {
            if (transLangs.has(lang)) { transLangs.delete(lang); el.classList.remove('selected'); } 
            else { if (transLangs.size >= 3) return alert("Max 3 translation languages."); transLangs.add(lang); el.classList.add('selected'); }
        }

        /* ====== RESOURCE MANAGEMENT ====== */
        function setResourceType(type) {
            selectedResourceType = type;
            document.querySelectorAll('.type-pill').forEach(el => el.classList.remove('active'));
            document.getElementById(`type-${type}`).classList.add('active');
        }

        function addResource() {
            const url = document.getElementById('resUrl').value.trim();
            const url2 = document.getElementById('resUrl2').value.trim(); 
            const url3 = document.getElementById('resUrl3').value.trim(); 
            const url4 = document.getElementById('resUrl4').value.trim();
            const url5 = document.getElementById('resUrl5').value.trim();
            const title = document.getElementById('resTitle').value.trim();

            if (!url) return alert("Please enter a URL");

            let type = selectedResourceType;
            if (type === 'auto') {
                if (url.includes('youtube.com') || url.includes('youtu.be')) type = 'video';
                else if (url.match(/\.(mp3|wav|ogg)$/i)) type = 'audio';
                else type = 'web';
            }

            // ID √öNICO
            const uniqueCardId = Date.now().toString() + Math.floor(Math.random() * 1000); 

            let resources = [];
            try {
                resources = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
                if(!Array.isArray(resources)) resources = [];
            } catch(e) { resources = []; }

            resources.unshift({ 
                id: uniqueCardId,
                url: url,
                url2: url2, 
                url3: url3,
                url4: url4,
                url5: url5,
                type: type, 
                title: title || (type === 'web' ? getDomain(url) : "New Resource"), 
                date: new Date().toLocaleDateString(), 
                note: "", 
                lastTime: 0,
                color: type === 'web' ? generatePastelColor() : null
            });
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); 
            loadResources();
            
            document.getElementById('resUrl').value = ''; 
            document.getElementById('resUrl2').value = ''; 
            document.getElementById('resUrl3').value = ''; 
            document.getElementById('resUrl4').value = ''; 
            document.getElementById('resUrl5').value = ''; 
            document.getElementById('resTitle').value = '';
            setResourceType('auto');
        }

        function deleteResourceById(id) {
            if(confirm("Delete this resource?")) { 
                let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                resources = resources.filter(r => String(r.id) !== String(id)); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));
                loadResources();
            }
        }

        function duplicateResourceById(id) {
            let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const original = resources.find(r => String(r.id) === String(id));
            if (!original) return;
            
            const copy = JSON.parse(JSON.stringify(original));
            copy.title = copy.title + " (Copy)";
            copy.id = Date.now().toString() + Math.floor(Math.random() * 1000);
            
            resources.unshift(copy);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));
            loadResources();
        }

        function editResourceMetaById(id) {
            let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const index = resources.findIndex(r => String(r.id) === String(id));
            if (index === -1) return;
            
            const r = resources[index];
            const newTitle = prompt("Edit Title:", r.title);
            if (newTitle === null) return;
            
            const newUrl = prompt("Edit Primary URL:", r.url);
            if (newUrl === null) return;

            r.title = newTitle;
            r.url = newUrl;
            
            const ytId = getYouTubeID(newUrl);
            if (ytId) r.type = 'video';
            else if (newUrl.match(/\.(mp3|wav|ogg)$/i)) r.type = 'audio';
            else r.type = 'web';

            localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));
            loadResources();
        }

        function toggleSettingsMenu() { document.getElementById('settings-menu').classList.toggle('active'); }

        function clearResources(type) {
            if(!confirm(`Are you sure you want to delete ${type === 'all' ? 'EVERYTHING' : 'all ' + type + ' resources'}?`)) return;
            let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if(type === 'all') { data = []; } else { data = data.filter(r => { const rType = r.type || 'video'; return rType !== type; }); }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            loadResources(); toggleSettingsMenu();
        }

        function applyFilter(filterType, btn) {
            currentFilter = filterType;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadResources();
        }

        function applySearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); loadResources(); }

        /* ====== GRID RENDER ====== */
        function loadResources() { 
            const data = localStorage.getItem(STORAGE_KEY); 
            let allResources = [];
            try {
                allResources = data ? JSON.parse(data) : [];
                if (!Array.isArray(allResources)) throw new Error("Data is not an array");
            } catch (e) {
                allResources = [];
            }

            const filtered = allResources.filter(item => {
                const type = item.type || 'video';
                if (currentFilter !== 'all' && type !== currentFilter) return false;
                if (searchQuery && !item.title.toLowerCase().includes(searchQuery)) return false;
                return true;
            });
            renderGrid(filtered); 
        }

        function renderGrid(resources) {
            grid.innerHTML = resources.length ? '' : '<div style="grid-column:1/-1;text-align:center;color:#666;margin-top:40px">No resources found.</div>';
            
            resources.forEach((r) => {
                const hasNote = r.note && r.note.replace(/<[^>]*>/g, '').trim().length > 0;
                const type = r.type || 'video'; 
                let mediaContent = '';

                if (type === 'video') {
                    const videoId = getYouTubeID(r.url);
                    if (videoId) {
                        mediaContent = `<div class="media-area video" onclick="initGridPlayer(this, '${r.id}', '${videoId}')">
                            <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg">
                            <div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
                        </div>`;
                    } else {
                        mediaContent = `<div class="media-area video" style="background:#000; display:flex; align-items:center; justify-content:center; color:#666; font-size:0.8rem;">Invalid URL</div>`;
                    }
                } else if (type === 'audio') {
                    mediaContent = `<div class="media-area audio" onclick="openEditorById('${r.id}')"><div class="audio-icon">üéß</div></div>`;
                } else if (type === 'web') {
                    const domain = getDomain(r.url || r.id);
                    const faviconUrl = `https://www.google.com/s2/favicons?domain=${r.url || r.id}&sz=128`;
                    mediaContent = `<div class="media-area web" style="background:${r.color || '#e3f2fd'}" onclick="openEditorById('${r.id}')"><div class="web-favicon-box"><img src="${faviconUrl}" onerror="this.src='about:blank'"></div><div class="web-domain-tag">WEB RESOURCE</div><div class="web-domain-text">${domain}</div></div>`;
                }
                
                grid.innerHTML += `
                <div class="resource-card">
                    ${mediaContent}
                    <div class="card-info">
                        <div class="card-title">${hasNote ? 'üìù ' : ''}${r.title}</div>
                        <div class="card-actions">
                            <button class="btn-action btn-edit" onclick="openEditorById('${r.id}')" title="Open Editor">‚úèÔ∏è Open</button>
                            <button class="btn-action btn-duplicate" onclick="duplicateResourceById('${r.id}')" title="Duplicate">üìÑ</button>
                            <button class="btn-action btn-meta" onclick="editResourceMetaById('${r.id}')" title="Edit Data">üîß</button>
                            <button class="btn-action btn-delete" onclick="deleteResourceById('${r.id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function initGridPlayer(el, cardId, videoId) {
            if (!videoId) return alert("Video ID not found.");
            currentResourceId = cardId; 
            const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); 
            const resData = resources.find(v => String(v.id) === String(cardId)); 
            const startTime = resData ? (resData.lastTime || 0) : 0;
            
            el.innerHTML = `<div id="p-${cardId}" class="video-target"></div>`; 
            el.onclick = null;
            
            gridPlayer = new YT.Player(`p-${cardId}`, { 
                width:'100%', height:'100%', videoId: videoId, 
                playerVars: { autoplay: 1, rel: 0, start: Math.floor(startTime) }, 
                events: { 
                    'onReady': (e) => { e.target.playVideo(); players[0] = gridPlayer; }, 
                    'onStateChange': (e) => onPlayerStateChange(e, cardId, gridPlayer) 
                } 
            });
        }

        function onPlayerStateChange(event, id, playerInstance) {
            const playBtn = document.getElementById('btn-main-play');
            const isControlled = (players[controlTarget] === playerInstance);
            if (event.data === 1) { 
                stopTracking(); trackingInterval = setInterval(() => saveMediaTime(playerInstance, id), 5000); 
                if(playBtn && isControlled) { playBtn.innerText = "‚è∏Ô∏è"; playBtn.classList.add('is-playing'); playBtn.classList.remove('is-paused'); } 
            } else { 
                saveMediaTime(playerInstance, id); stopTracking(); 
                if(playBtn && isControlled) { playBtn.innerText = "‚ñ∂Ô∏è"; playBtn.classList.add('is-paused'); playBtn.classList.remove('is-playing'); } 
            }
        }

        function saveMediaTime(player, id) {
            if (!player) return;
            let currentTime = 0;
            if (typeof player.getCurrentTime === 'function') { currentTime = player.getCurrentTime(); } 
            else if (player.tagName === 'AUDIO') { currentTime = player.currentTime; }
            if (currentTime > 0) { 
                const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); 
                const index = resources.findIndex(v => String(v.id) === String(id)); 
                if (index !== -1) { resources[index].lastTime = currentTime; localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); } 
            }
        }
        function stopTracking() { if (trackingInterval) { clearInterval(trackingInterval); trackingInterval = null; } }

        /* ====== BACKUP ====== */
        function downloadBackup() { 
            const d = localStorage.getItem(STORAGE_KEY) || '[]';
            const encodedData = btoa(unescape(encodeURIComponent(d)));
            const htmlContent = `<!DOCTYPE html><html><head><title>MDC Backup</title></head><body><h1>MDC Polyglot Backup</h1><p>Upload this file using the "Import" button in your app.</p><script>const backupData = "${encodedData}";<\/script></body></html>`;
            const b = new Blob([htmlContent], {type: 'text/html'}); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(b); a.download = 'MDC_Backup.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); 
        }

        function importBackup(inp) { 
            const file = inp.files[0]; if (!file) return;
            const r = new FileReader(); 
            r.onload = e => { 
                try {
                    let match = e.target.result.match(/const backupData = "(.*?)";/);
                    if (!match) match = e.target.result.match(/const backupData=(.*?)(;|<\/script>)/s);
                    if (!match) throw new Error("Invalid backup.");
                    let json = match[1] ? decodeURIComponent(escape(atob(match[1]))) : match[1];
                    localStorage.setItem(STORAGE_KEY, json); 
                    loadResources(); alert("Imported!");
                } catch (err) { alert("Error: " + err.message); }
                inp.value = ''; 
            }; 
            r.readAsText(file); 
        }

        /* ====== CONTROL LOGIC ====== */
        window.setControlTarget = function(idx) {
            controlTarget = idx;
            document.querySelectorAll('.btn-target').forEach((b, i) => { if(i===idx) b.classList.add('active'); else b.classList.remove('active'); });
            const p = players[controlTarget];
            const playBtn = document.getElementById('btn-main-play');
            if(p && typeof p.getPlayerState === 'function') {
                if(p.getPlayerState() === 1) { playBtn.innerText = "‚è∏Ô∏è"; playBtn.classList.add('is-playing'); } else { playBtn.innerText = "‚ñ∂Ô∏è"; playBtn.classList.remove('is-playing'); }
            }
        }

        function openFreeEditor() {
            currentEditIndex = -1; currentResourceId = null;
            editorArea.innerHTML = ""; modal.classList.add('active'); document.getElementById('editor-popup').classList.add('free-mode'); document.getElementById('editor-popup').style.opacity = 1;
            players = [null, null, null, null, null];
            if(gridPlayer) gridPlayer.pauseVideo(); updateToolbarState();
        }
        
        // --- EDIT TAB URL ---
        window.editTabUrl = function(index, event) {
            event.stopPropagation();
            const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
            const r = resources[currentEditIndex];
            
            let key = 'url';
            if(index === 1) key = 'url2'; if(index === 2) key = 'url3'; if(index === 3) key = 'url4'; if(index === 4) key = 'url5';

            const newUrl = prompt(`Enter new URL for Tab ${index + 1}:`, r[key] || '');
            if(newUrl !== null) {
                const trimmedUrl = newUrl.trim();
                r[key] = trimmedUrl;
                if (index === 0) {
                     const ytId = getYouTubeID(trimmedUrl);
                     if (ytId) { r.type = 'video'; } else if (trimmedUrl.match(/\.(mp3|wav|ogg)$/i)) { r.type = 'audio'; } else { r.type = 'web'; }
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));
                openEditorById(r.id); 
            }
        }

        window.switchWebTab = function(idx) {
            document.querySelectorAll('.web-tab-btn').forEach((b, i) => {
                if(b.innerText.includes('Externally')) return;
                const buttons = Array.from(document.querySelectorAll('.web-tab-btn')).filter(btn => !btn.innerText.includes('Externally'));
                if(buttons[idx]) { buttons.forEach(btn => btn.classList.remove('active')); buttons[idx].classList.add('active'); }
            });
            document.querySelectorAll('.web-frame-container').forEach((f, i) => { if(i === idx) f.classList.add('active'); else f.classList.remove('active'); });
        };

        function openEditorById(id) {
            const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
            const index = resources.findIndex(r => String(r.id) === String(id));
            if (index === -1) return;
            currentEditIndex = index;
            const resData = resources[index];
            currentResourceId = resData.id;
            editorArea.innerHTML = resData.note || "";
            const type = resData.type || 'video';
            modal.classList.add('active');
            document.getElementById('editor-popup').classList.remove('free-mode');
            document.getElementById('editor-popup').style.opacity = 1;
            const container = document.getElementById('desktop-media-wrapper');
            container.innerHTML = ''; 
            const isDesktop = window.matchMedia("(min-width: 900px)").matches;
            let startTime = resData.lastTime || 0;
            
            players = [null, null, null, null, null];
            setControlTarget(0); 

            const ytId1 = getYouTubeID(resData.url);
            const ytId2 = getYouTubeID(resData.url2);
            const ytId3 = getYouTubeID(resData.url3);
            const ytId4 = getYouTubeID(resData.url4); 
            const ytId5 = getYouTubeID(resData.url5); 

            const renderTabs = (content1, content2, content3, content4, content5) => {
                const getBtn = (idx, link) => {
                    const activeClass = idx === 0 ? 'active' : '';
                    return `<button class="web-tab-btn ${activeClass}" onclick="switchWebTab(${idx})" title="${link || ''}">Tab ${idx + 1}<span class="tab-gear" onclick="window.editTabUrl(${idx}, event)">‚öôÔ∏è</span></button>`;
                };
                return `<div class="media-iframe-wrapper"><div class="web-tab-nav">${getBtn(0, resData.url)}${resData.url2 ? getBtn(1, resData.url2) : getBtn(1, '')}${resData.url3 ? getBtn(2, resData.url3) : getBtn(2, '')}${resData.url4 ? getBtn(3, resData.url4) : getBtn(3, '')}${resData.url5 ? getBtn(4, resData.url5) : getBtn(4, '')}</div><div class="web-content-area"><div class="web-frame-container active" id="tab-content-0">${content1}</div><div class="web-frame-container" id="tab-content-1">${content2 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-2">${content3 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-3">${content4 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-4">${content5 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div></div></div>`;
            };

            const getTabContent = (link, ytId, index) => {
                if(ytId) return `<div id="player-tab-${index}" style="width:100%;height:100%"></div>`;
                if(link) return `<iframe src="${link}" allowfullscreen style="width:100%;height:100%;border:none;position:relative;z-index:2"></iframe>`;
                return null;
            };

            const htmlContent2 = getTabContent(resData.url2, ytId2, 2);
            const htmlContent3 = getTabContent(resData.url3, ytId3, 3);
            const htmlContent4 = getTabContent(resData.url4, ytId4, 4); 
            const htmlContent5 = getTabContent(resData.url5, ytId5, 5); 

            const initSubPlayers = () => {
                if(ytId2) players[1] = new YT.Player(`player-tab-2`, { width: '100%', height: '100%', videoId: ytId2, playerVars: { rel: 0 } });
                if(ytId3) players[2] = new YT.Player(`player-tab-3`, { width: '100%', height: '100%', videoId: ytId3, playerVars: { rel: 0 } });
                if(ytId4) players[3] = new YT.Player(`player-tab-4`, { width: '100%', height: '100%', videoId: ytId4, playerVars: { rel: 0 } }); 
                if(ytId5) players[4] = new YT.Player(`player-tab-5`, { width: '100%', height: '100%', videoId: ytId5, playerVars: { rel: 0 } }); 
            };

            if (type === 'video') {
                if (isDesktop) {
                    if (gridPlayer && typeof gridPlayer.getCurrentTime === 'function' && gridPlayer.getVideoData().video_id === ytId1) { 
                        startTime = gridPlayer.getCurrentTime(); 
                        gridPlayer.pauseVideo(); 
                    }
                    container.innerHTML = renderTabs('<div id="desktop-player-target" style="width:100%; height:100%;"></div>', htmlContent2, htmlContent3, htmlContent4, htmlContent5);
                    if (ytId1) {
                        players[0] = new YT.Player('desktop-player-target', { 
                            width: '100%', height: '100%', videoId: ytId1, 
                            playerVars: { autoplay: 0, rel: 0, start: Math.floor(startTime) }, 
                            events: { 'onStateChange': (e) => onPlayerStateChange(e, id, players[0]) } 
                        });
                    }
                    initSubPlayers();
                } else { if (gridPlayer) { players[0] = gridPlayer; gridPlayer.pauseVideo(); } }
            } else if (type === 'audio') {
                if (isDesktop) {
                    const audioHtml = `<div class="media-audio-wrapper"><audio controls id="modal-audio-player" src="${resData.url}"></audio></div>`;
                    container.innerHTML = renderTabs(audioHtml, htmlContent2, htmlContent3, htmlContent4, htmlContent5);
                    const audioEl = document.getElementById('modal-audio-player');
                    audioEl.currentTime = startTime; players[0] = audioEl;
                    audioEl.addEventListener('play', () => { stopTracking(); trackingInterval = setInterval(() => saveMediaTime(audioEl, id), 5000); });
                    audioEl.addEventListener('pause', () => { saveMediaTime(audioEl, id); stopTracking(); });
                    initSubPlayers();
                }
            } else if (type === 'web') {
                if (isDesktop) {
                    const webContent1 = `<iframe src="${resData.url}" allowfullscreen style="width:100%;height:100%;border:none;position:relative;z-index:2"></iframe>`;
                    container.innerHTML = renderTabs(webContent1, htmlContent2, htmlContent3, htmlContent4, htmlContent5);
                    players[0] = null; initSubPlayers();
                }
            }
            updateToolbarState();
        }

        function closeEditor() {
            if (players[0] && currentResourceId) { saveMediaTime(players[0], currentResourceId); stopTracking(); } 
            players.forEach(p => { if (p && typeof p.destroy === 'function') { p.destroy(); } });
            players = [null, null, null, null, null];
            loadResources(); 
            modal.classList.remove('active');
            document.getElementById('editor-popup').classList.remove('is-fullscreen'); 
            document.getElementById('btn-fullscreen').classList.remove('active');
            document.getElementById('editor-popup').classList.remove('free-mode');
            document.getElementById('desktop-media-wrapper').innerHTML = '';
            currentEditIndex = -1; gridPlayer = null; closeAIMenu();
        }

        // --- HERE IS THE FIX FOR SAVING ANSWERS ---
        function saveNote() { 
            if(currentEditIndex > -1) { 
                // "Bake" selects: force attribute update
                const selects = editorArea.querySelectorAll('select');
                selects.forEach(s => {
                    const val = s.value;
                    const opts = s.querySelectorAll('option');
                    opts.forEach(o => {
                        if (o.value === val) o.setAttribute('selected', 'true');
                        else o.removeAttribute('selected');
                    });
                });

                const resources = JSON.parse(localStorage.getItem(STORAGE_KEY)); 
                resources[currentEditIndex].note = editorArea.innerHTML; 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); 
            } 
        }
        
        function seekVideo(s) { const p = players[controlTarget]; if(!p) return; if(typeof p.seekTo === 'function') { p.seekTo(p.getCurrentTime()+s, true); } else if (p.tagName === 'AUDIO') { p.currentTime += s; } }
        function togglePlay() { const p = players[controlTarget]; if(!p) return; if(typeof p.getPlayerState === 'function') { p.getPlayerState()===1 ? p.pauseVideo() : p.playVideo(); } else if (p.tagName === 'AUDIO') { p.paused ? p.play() : p.pause(); } }
        function cycleSpeed() { const p = players[controlTarget]; if (!p) return; let r = 1; const t = document.getElementById('btn-speed').innerText; if(t==='1x') r=0.9; else if(t==='0.9x') r=0.8; else if(t==='0.8x') r=0.7; else if(t==='0.7x') r=0.6; else if(t==='0.6x') r=0.5; if(typeof p.setPlaybackRate === 'function') { p.setPlaybackRate(r); } else if (p.tagName === 'AUDIO') { p.playbackRate = r; } document.getElementById('btn-speed').innerText=r+'x'; }
        
        function applyColor(hex) { document.execCommand('foreColor', false, hex); updateToolbarState(); }
        function toggleBold() { document.execCommand('bold'); updateToolbarState(); }
        function setSize(size) { document.execCommand('fontSize', false, size); updateToolbarState(); }
        editorArea.addEventListener('keyup', updateToolbarState); editorArea.addEventListener('mouseup', updateToolbarState); editorArea.addEventListener('click', updateToolbarState);
        // Important: trigger Save on input
        editorArea.addEventListener('input', saveNote);

        function updateToolbarState() {
            const isBold = document.queryCommandState('bold'); document.getElementById('btn-bold').classList.toggle('is-active', isBold);
            const size = document.queryCommandValue('fontSize'); document.getElementById('btn-size-lg').classList.toggle('is-active', size === '5' || size === 'x-large'); document.getElementById('btn-size-norm').classList.toggle('is-active', size !== '5' && size !== 'x-large');
            const rgb = document.queryCommandValue('foreColor'); document.querySelectorAll('.color-dot').forEach(b => b.classList.remove('active'));
            if(rgb.includes('255, 59, 48')) document.querySelectorAll('.color-dot')[1].classList.add('active'); else if (rgb.includes('0, 122, 255')) document.querySelectorAll('.color-dot')[2].classList.add('active'); else if (rgb.includes('52, 199, 89')) document.querySelectorAll('.color-dot')[3].classList.add('active'); else document.querySelectorAll('.color-dot')[0].classList.add('active');
        }

        /* ====== AI LOGIC & MEMORY BANK ====== */
        function openAIMenu() { aiModal.classList.add('active'); renderAiList(); }
        function closeAIMenu() { aiModal.classList.remove('active'); }
        function toggleAiHelp() { const box = document.getElementById('ai-help-box'); box.style.display = box.style.display === 'block' ? 'none' : 'block'; }
        function checkCustomOverride(inputId, selectId) { const inputVal = document.getElementById(inputId).value.trim(); const selectEl = document.getElementById(selectId); if(inputVal.length > 0) { selectEl.classList.add('override-warning'); } else { selectEl.classList.remove('override-warning'); } }

        function saveEditorAsTemplate() {
            const rawContent = document.getElementById('editor-text').innerHTML.trim();
            if(!rawContent || rawContent === "<br>") return alert("Editor is empty.");
            const name = prompt("Name this lesson template:"); if(!name) return;
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = rawContent;
            tempDiv.querySelectorAll('select').forEach(s => { s.value = ""; s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); });
            tempDiv.querySelectorAll('.hint-box, .trans-box, .theory-box').forEach(box => { box.style.display = 'none'; });
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            memory.unshift({ id: Date.now(), title: name, isHtml: true, htmlContent: tempDiv.innerHTML, lang: 'en', date: new Date().toLocaleDateString(), data: [] });
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); alert("Template saved!"); renderAiList();
        }
        
        function exportMemoryBank() {
            const data = localStorage.getItem(AI_MEM_KEY); if(!data || data === '[]') return alert("Memory is empty.");
            const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'polyglot_memory_full.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function importMemoryBank(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if(!Array.isArray(importedData)) throw new Error("Invalid format"); const current = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const combined = [...importedData, ...current]; localStorage.setItem(AI_MEM_KEY, JSON.stringify(combined)); renderAiList(); alert("Import Successful!"); } catch(err) { alert("Error importing: " + err.message); } };
            reader.readAsText(file);
        }

        function renameMemoryItem(id) {
            let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const idx = memory.findIndex(i => i.id === id);
            if(idx > -1) { const newTitle = prompt("New Title:", memory[idx].title); if(newTitle) { memory[idx].title = newTitle; localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } }
        }
        function exportSingleItem(id) {
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const item = memory.find(x => x.id === id); if(!item) return;
            const data = JSON.stringify([item], null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
            const safeName = (item.title || 'exercise').replace(/[^a-z0-9]/gi, '_').toLowerCase(); a.download = `${safeName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function deleteMemoryItem(id) { if(confirm("Delete?")) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory = memory.filter(item => item.id !== id); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } }
        function clearAIMemory() { if(confirm("Clear all?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }

        function renderAiList() {
            const listContainer = document.getElementById('ai-memory-list'); const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            if (memory.length === 0) { listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>'; return; }
            let html = '';
            memory.forEach((item, index) => {
                let flag = "üá¨üáß"; if(item.lang === 'es') flag = "üá™üá∏"; if(item.lang === 'pt') flag = "üáßüá∑"; if(item.lang === 'it') flag = "üáÆüáπ";
                let newBadge = (index === 0) ? '<span class="badge-new">NEW</span>' : ''; let typeBadge = item.isHtml ? '<span class="badge-tpl">TEMPLATE</span>' : `‚Ä¢ ${item.data.length} Qs`;
                html += `<div class="saved-item"><div class="saved-num">#${index + 1}</div><div class="saved-info"><span class="saved-name">${flag} ${item.title} ${newBadge}</span><span class="saved-date">${item.date} ${typeBadge}</span></div><div class="mem-actions"><button class="btn-insert" onclick="insertExerciseFromMem(${item.id})">Insert</button><button class="btn-icon-action btn-export-item" onclick="exportSingleItem(${item.id})" title="Export JSON">‚¨áÔ∏è</button><button class="btn-icon-action btn-rename" onclick="renameMemoryItem(${item.id})" title="Rename">‚úèÔ∏è</button><button class="btn-icon-action btn-delete-item" onclick="deleteMemoryItem(${item.id})" title="Delete">√ó</button></div></div>`;
            });
            listContainer.innerHTML = html;
        }

       /* ====== V27.9 PROMPT GENERATION ====== */
        function copyProfessorPrompt() {
            const ctxSel = document.getElementById('ai-context-select').value;
            const graSel = document.getElementById('ai-grammar-select').value;
            const typSel = document.getElementById('ai-type-select').value;
            const gapCount = document.getElementById('ai-gap-count').value;
            const ctxCust = document.getElementById('ai-context-custom').value.trim();
            const graCust = document.getElementById('ai-grammar-custom').value.trim();
            const typCust = document.getElementById('ai-type-custom').value.trim();
            const extraData = document.getElementById('ai-extra-data').value.trim();
            let requirements = []; let isGrammarFocus = false; let typeStr = typCust ? typCust : typSel;
            if(ctxCust) requirements.push(`Topic Context: ${ctxCust}`); else if(ctxSel) requirements.push(`Topic Context: ${ctxSel}`);
            if(graCust) { requirements.push(`Grammar Focus: ${graCust}`); isGrammarFocus = true; } else if(graSel) { requirements.push(`Grammar Focus: ${graSel}`); isGrammarFocus = true; }
            if(typeStr) requirements.push(`Exercise Format: ${typeStr}`);
            if(requirements.length === 0) return alert("‚ö†Ô∏è Please select at least one option.");
            
            const finalTopic = requirements.join(", ");
            const target = LANG_NAMES[currentTargetLang]; 
            
            let languageInstruction = `CRITICAL LANGUAGE RULE: The sentences AND the options inside the gaps {opt1|opt2...} MUST BE in **${target.toUpperCase()}**. Do NOT use English words inside the gaps. Example in ${target}: "Ele {fala|falou|falar}..." (NOT "Ele {speak|spoke}...")`;
            let strictInstruction = ""; let gapInstruction = "";

            if (typeStr && typeStr.includes("Find and Fix")) { strictInstruction += ` TYPE: FIND AND FIX THE MISTAKE. VISUAL REQUIREMENT: You MUST include the mistake crossed out using HTML tags <s>mistake</s> immediately before the correct gap. Format: "Yesterday I <s>goed</s> {went|go} to the park." (Space between </s> and {).`; } 
            else if (typeStr && typeStr.includes("Sentence Reordering")) { strictInstruction += ` TYPE: SENTENCE REORDERING via MULTIPLE CHOICE. The prompt MUST be the scrambled words. The options MUST be full sentences in ${target}.`; } 
            else if (typeStr && typeStr.includes("Vocabulary Matching")) { strictInstruction += ` TYPE: VOCABULARY MATCHING. Format: "Definition text (${target})... {CorrectWord|Distractor1|Distractor2}"`; } 
            else if (typeStr && typeStr.includes("True or False")) { strictInstruction += ` TYPE: READING COMPREHENSION (TRUE/FALSE). Format: "Statement about the text... {True|False}" (Localize True/False if appropriate for ${target}).`; }

            if (typeStr && typeStr.includes("True or False")) { gapInstruction = "Provide options {True|False}."; } 
            else if (gapCount === 'random') { gapInstruction = ` GAP REQUIREMENT: For EVERY gap, you MUST provide 3 to 4 options in ${target}. For VERBS, include variations in Tense, Person, and Form. Mix of 1, 2, or 3 gaps per sentence.`; } 
            else { gapInstruction = ` GAP REQUIREMENT: For EVERY gap, you MUST provide 3 to 4 options in ${target}. For VERBS, include variations in Tense, Person, and Form. Provide exactly ${gapCount} gap(s) per sentence.`; }

            if (isGrammarFocus && !typeStr.includes("Reordering")) { strictInstruction += ` Focus gaps ONLY on the requested GRAMMAR rule (verbs/auxiliaries).`; }

            const jsonExample = ` { "cloze_text": "Sentence in ${target} with {option1|option2|option3} gaps.", "hint": "Brief clue", "translations": { ${Array.from(transLangs).map(l => `"${l}": "Translation in ${LANG_NAMES[l]}"`).join(', ')} }, "full_sentence": "Full sentence in ${target} without gaps." }`;
            const promptText = `ACT AS: Senior ${target} Linguist. LEVEL: CEFR ${currentLevel}. TASK: Create a structured JSON exercise. REQUIREMENTS: ${finalTopic}. ${languageInstruction} GAP DENSITY: ${gapInstruction} ${strictInstruction} ${extraData ? `EXTRA INSTRUCTIONS: ${extraData}` : ''} OUTPUT FORMAT: RAW JSON ONLY. JSON STRUCTURE: { "title": "Short descriptive title in ${target}", "lang_code": "${currentTargetLang}", "theory": "Brief rules explanation...", "exercises": [ ${jsonExample}, ] }`.trim();
            navigator.clipboard.writeText(promptText).then(() => { const btn = document.querySelector('.btn-ai-primary'); const orig = btn.innerText; btn.innerText = "‚úÖ Copied!"; setTimeout(() => btn.innerText = orig, 2000); }).catch(err => alert("Error: " + err));
        }

        async function pasteAIJson() {
            let jsonString = ""; try { jsonString = await navigator.clipboard.readText(); } catch (err) { jsonString = prompt("Paste JSON here:"); }
            if (!jsonString) return; processJsonAndSave(jsonString);
        }

        function processJsonAndSave(jsonString) {
            try {
                let cleanString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                const aiData = JSON.parse(cleanString);
                let finalData = Array.isArray(aiData) ? { title: "Exercise", lang_code: "en", theory: "Review rules.", exercises: aiData } : aiData;
                if (!finalData.lang_code) finalData.lang_code = "en";
                const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
                memory.unshift({ id: Date.now(), title: finalData.title || "Untitled", lang: finalData.lang_code, theory: finalData.theory, date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), data: finalData.exercises });
                localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList();
            } catch (e) { alert("‚ùå Invalid JSON.\nError: " + e.message); }
        }

        function insertExerciseFromMem(id) {
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const item = memory.find(x => x.id === id); if (!item) return;
            if(item.isHtml) { if(confirm("Insert template?")) { editorArea.insertAdjacentHTML('beforeend', item.htmlContent + '<p><br></p>'); closeAIMenu(); saveNote(); } return; }
            
            const insertTime = Date.now(); const theoryId = `theory-${id}-${insertTime}`; const targetLang = item.lang || 'en';
            let htmlBlock = `<div class="exercise-box" contenteditable="false"><div class="exercise-header"><span>‚úçÔ∏è ${item.title}</span><div style="display:flex; align-items:center;"><button class="btn-theory" onclick="document.getElementById('${theoryId}').style.display = document.getElementById('${theoryId}').style.display === 'block' ? 'none' : 'block'">üìò Theory</button><button class="btn-reset-block" contenteditable="false" onclick="window.resetExerciseBlock(this)" title="Reset">‚Ü∫</button><button class="btn-del-block" contenteditable="false" onclick="if(confirm('Delete block?')) { this.closest('.exercise-box').remove(); window.saveNote(); }" title="Delete">üóëÔ∏è</button></div></div><div class="theory-box" id="${theoryId}">${item.theory || "No theory."}</div>`;
            
            item.data.forEach((ex, index) => {
                const uId = `ex-${id}-${index}-${insertTime}`; const hId = `hint-${id}-${index}-${insertTime}`; const tId = `trans-${id}-${index}-${insertTime}`;
                let exerciseContent = "";
                if (ex.cloze_text) {
                    let parsedHtml = ex.cloze_text.replace(/\{([^}]+)\}/g, (match, content) => {
                        const parts = content.split('|'); const correctAns = parts[0].trim();
                        const shuffled = [...parts].sort(() => Math.random() - 0.5);
                        let optsHtml = `<option value="" disabled selected>...</option>`;
                        shuffled.forEach(opt => { optsHtml += `<option value="${opt.trim()}">${opt.trim()}</option>`; });
                        return `<span class="cloze-gap-container"><select class="ex-select" onchange="window.validateExercise(this, '${correctAns.replace(/'/g, "\\'")}')">${optsHtml}</select></span>`;
                    });
                    exerciseContent = `<span><b>${index + 1}.</b> ${parsedHtml}</span>`;
                } else {
                    let optsHtml = `<option value="" disabled selected>...</option>`;
                    const shuffled = [...ex.options].sort(() => Math.random() - 0.5);
                    shuffled.forEach(opt => { optsHtml += `<option value="${opt}">${opt}</option>`; });
                    exerciseContent = `<span><b>${index + 1}.</b> ${ex.pre || ''}</span><select class="ex-select" onchange="window.validateExercise(this, '${ex.answer}')">${optsHtml}</select><span>${ex.post || ''}</span>`;
                }
                let transContent = ""; if (ex.translations) { for (const [key, val] of Object.entries(ex.translations)) { let f = "üá¨üáß"; if(key==='es') f="üá™üá∏"; if(key==='pt') f="üáßüá∑"; if(key==='it') f="üáÆüáπ"; transContent += `<div class="trans-line"><button class="btn-mini-speak" contenteditable="false" onclick="window.speakText('${val.replace(/'/g, "\\'")}', '${key}')">üîä</button><span>${f} ${val}</span></div>`; } } else { transContent = "No translation"; }
                htmlBlock += `<div class="exercise-row" id="${uId}">${exerciseContent}<div style="display:inline-flex; gap:5px; margin-left:10px;"><button class="ex-btn-icon" contenteditable="false" onclick="window.speakText('${ex.full_sentence.replace(/'/g, "\\'")}', '${targetLang}')">üîä</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${tId}').style.display = document.getElementById('${tId}').style.display === 'block' ? 'none' : 'block'">üåê</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${hId}').style.display = document.getElementById('${hId}').style.display === 'block' ? 'none' : 'block'">‚ùì</button></div><div class="hint-box" id="${hId}">üí° ${ex.hint}</div><div class="trans-box" id="${tId}">${transContent}</div></div>`;
            });
            htmlBlock += '</div><p><br></p>'; editorArea.insertAdjacentHTML('beforeend', htmlBlock); setTimeout(() => { editorArea.scrollTop = editorArea.scrollHeight; saveNote(); }, 50); closeAIMenu();
        }

     window.resetExerciseBlock = function(btn) { 
    const box = btn.closest('.exercise-box'); 
    if(box) { 
        const selects = box.querySelectorAll('select'); 
        selects.forEach(s => { 
            s.selectedIndex = 0; // <--- PON ESTO EN SU LUGAR
            s.classList.remove('correct', 'wrong'); 
            s.querySelectorAll('option').forEach(o => o.removeAttribute('selected'));
        }); 
        window.saveNote(); 
    } 
};
        
        window.validateExercise = function(s, a) { 
            s.classList.remove('correct', 'wrong'); 
            if (s.value.trim().toLowerCase() === a.trim().toLowerCase()) { s.classList.add('correct'); } 
            else { s.classList.add('wrong'); if(navigator.vibrate) navigator.vibrate(200); } 
            window.saveNote(); // Save immediately on interaction
        };
        
        window.speakText = function(text, langCode) {
            if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); const sel = document.querySelector(`#voice-${langCode} option:checked`)?.getAttribute('data-name'); const all = window.speechSynthesis.getVoices(); if (sel) { const v = all.find(val => val.name === sel); if (v) u.voice = v; } else { const m = { 'en': 'en-US', 'es': 'es-ES', 'pt': 'pt-BR', 'it': 'it-IT' }; u.lang = m[langCode] || 'en-US'; } u.rate = 0.9; window.speechSynthesis.speak(u); } else { alert("TTS not supported."); }
        };
    </script>
</body>
</html>
