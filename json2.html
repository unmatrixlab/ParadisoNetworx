<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Biblioteca JSON</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #f3f4f6; --card: #ffffff; --error: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px 20px; min-height: 100vh; margin: 0; color: #1f2937; }
        .container { background: var(--card); width: 100%; max-width: 700px; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); position: relative; }
        
        h1 { margin-top: 0; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .badge { background: #e0e7ff; color: var(--primary); font-size: 12px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; }

        /* SECTIONS */
        .step-section { margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fafafa; position: relative; transition: 0.3s; }
        .step-number { position: absolute; top: -12px; left: 20px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .step-title { font-weight: 800; margin-bottom: 15px; display: block; color: #374151; }

        /* SECURITY OVERLAY */
        .blur-content { filter: blur(5px); pointer-events: none; user-select: none; opacity: 0.6; }
        .security-modal { display: none; margin-top: 20px; padding: 20px; background: #fff1f2; border: 1px solid #fecdd3; border-radius: 12px; text-align: center; }
        .security-modal.active { display: block; animation: fadeIn 0.3s ease; }
        .pin-input { font-size: 24px; letter-spacing: 10px; text-align: center; width: 150px !important; margin: 0 auto; }

        /* INPUTS */
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 700; color: #6b7280; margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; outline: none; box-sizing: border-box; }
        input[type="text"]:focus, input[type="password"]:focus { border-color: var(--primary); }
        
        /* FILE UPLOADS */
        .file-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .file-box { border: 2px dashed #cbd5e1; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; position: relative; transition: 0.2s; background: white; }
        .file-box:hover { border-color: var(--primary); background: #eef2ff; }
        .file-box input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-status { font-weight: 600; color: #4b5563; font-size: 13px; }
        .file-box.loaded { border-color: var(--success); background: #d1fae5; }
        .file-box.loaded .file-status { color: #065f46; }

        /* BUTTONS */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-load { background: #374151; color: white; margin-top: 10px; }
        .btn-skip { background: transparent; color: #6b7280; border: 2px solid #e5e7eb; margin-top: 10px; }
        .btn-skip:hover { border-color: #9ca3af; color: #374151; }
        
        .btn-unlock { background: var(--primary); color: white; margin-top: 10px; width: auto; padding: 10px 30px; }
        .btn-generate { background: var(--primary); color: white; font-size: 16px; margin-top: 10px; }
        .btn-generate:hover { background: #4338ca; transform: translateY(-2px); }
        
        textarea { width: 100%; height: 200px; margin-top: 20px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; font-size: 12px; resize: vertical; display: none; background: #1f2937; color: #a5f3fc; box-sizing: border-box; }
        
        .copy-btn { background: var(--success); color: white; margin-top: 10px; display: none; }
        .status-msg { font-size: 12px; margin-top: 5px; color: #6b7280; font-style: italic; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Gestor de Biblioteca <span class="badge">V2.2</span></h1>
    <p style="color:#666; font-size:14px; margin-bottom:25px;">Crea o actualiza tu archivo biblioteca.json.</p>

    <div class="step-section">
        <div class="step-number">PASO 1</div>
        <span class="step-title">Origen de Datos</span>
        <div class="group">
            <label>URL Raw de GitHub (Opcional)</label>
            <input type="text" id="existing-url" placeholder="https://raw.githubusercontent.com/.../biblioteca.json">
        </div>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
            <button class="btn-load" onclick="loadExistingLibrary()">üì• DESCARGAR</button>
            <button class="btn-skip" onclick="startFromScratch()">NO TENGO, INICIAR</button>
        </div>
        <div id="load-status" class="status-msg">Introduce URL o inicia de cero.</div>

        <div id="security-check" class="security-modal">
            <h3 style="margin:0 0 10px 0; color:#991b1b;">üîí Archivo Protegido</h3>
            <p style="font-size:13px; margin-bottom:15px;">Este archivo requiere un PIN de acceso.</p>
            <input type="password" id="pin-entry" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <br>
            <button class="btn-unlock" onclick="verifyPin()">DESBLOQUEAR</button>
            <p id="pin-error" style="color:var(--error); font-size:12px; display:none; margin-top:5px;">PIN Incorrecto</p>
        </div>
    </div>

    <div id="app-content">
        <div class="step-section" id="step-2" style="opacity:0.5; pointer-events:none;">
            <div class="step-number">PASO 2</div>
            <span class="step-title">Nuevo Video (Opcional)</span>
            <p style="font-size:12px; color:#6b7280; margin-top:-10px; margin-bottom:15px;">
                Deja esto en blanco si solo quieres generar el archivo de configuraci√≥n base con PIN.
            </p>
            
            <div class="group">
                <label>URL de YouTube</label>
                <input type="text" id="yt-url" placeholder="https://www.youtube.com/watch?v=..." oninput="validateYoutube()">
            </div>
            <div class="group">
                <label>T√≠tulo del Video</label>
                <input type="text" id="vid-title" placeholder="Ej: Entrevista con Elon Musk">
            </div>
            <div class="group">
                <label>Archivos de Subt√≠tulos (.srt)</label>
                <div class="file-grid">
                    <div class="file-box" id="box-en">
                        <span class="file-status" id="status-en">üá∫üá∏ Ingl√©s</span>
                        <input type="file" id="file-en" accept=".srt" onchange="updateStatus(this, 'box-en', 'status-en')">
                    </div>
                    <div class="file-box" id="box-es">
                        <span class="file-status" id="status-es">üá™üá∏ Espa√±ol</span>
                        <input type="file" id="file-es" accept=".srt" onchange="updateStatus(this, 'box-es', 'status-es')">
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px; padding-top:20px; border-top:1px dashed #e5e7eb;">
                <label style="color:#4f46e5;">üõ°Ô∏è Seguridad / Configuraci√≥n</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="new-pin-set" maxlength="4" placeholder="PIN" style="width:80px; text-align:center;">
                    <span style="font-size:11px; color:#666;">Define un PIN de 4 d√≠gitos para proteger este archivo json.</span>
                </div>
            </div>
        </div>

        <button class="btn-generate" id="btn-gen" onclick="generateMergedJSON()" disabled style="opacity:0.5;">GENERAR JSON FINAL ‚ú®</button>
        
        <textarea id="output" readonly></textarea>
        <button class="copy-btn" id="btn-copy" onclick="copyToClipboard()">COPIAR JSON COMPLETO üìã</button>
    </div>
</div>

<script>
    let RAW_DATA = null;     
    let VIDEO_LIST = [];     
    let STORED_PIN = null;   

    // 1. INICIAR SIN ARCHIVO
    function startFromScratch() {
        VIDEO_LIST = [];
        STORED_PIN = null;
        document.getElementById('existing-url').value = '';
        unlockApp(0, "Modo creaci√≥n desde cero activado.");
    }

    // 2. CARGAR LIBRER√çA EXISTENTE
    async function loadExistingLibrary() {
        const url = document.getElementById('existing-url').value.trim();
        const status = document.getElementById('load-status');
        const securityModal = document.getElementById('security-check');
        const appContent = document.getElementById('app-content');
        
        if(!url) return alert("Pega una URL o pulsa 'Iniciar sin archivo'.");
        
        status.innerText = "‚è≥ Conectando...";
        status.style.color = "#4f46e5";
        securityModal.classList.remove('active');
        appContent.classList.remove('blur-content');

        try {
            const res = await fetch(url + '?t=' + new Date().getTime());
            if(!res.ok) throw new Error("Error " + res.status);
            
            RAW_DATA = await res.json();
            
            if(Array.isArray(RAW_DATA)) {
                // Formato antiguo (sin pin)
                VIDEO_LIST = RAW_DATA;
                STORED_PIN = null;
                unlockApp(VIDEO_LIST.length, `Cargados ${VIDEO_LIST.length} videos.`);
            } 
            else if (RAW_DATA.pin && Array.isArray(RAW_DATA.videos)) {
                // Formato nuevo (con pin)
                STORED_PIN = RAW_DATA.pin;
                VIDEO_LIST = RAW_DATA.videos;
                
                // Bloquear
                status.innerText = "üîí Archivo bloqueado.";
                status.style.color = "#b91c1c";
                securityModal.classList.add('active');
                appContent.classList.add('blur-content');
                document.getElementById('pin-entry').value = '';
                document.getElementById('pin-entry').focus();
            }
            else {
                // Archivo vacio o raro
                VIDEO_LIST = [];
                unlockApp(0, "Archivo irreconocible, iniciando vac√≠o.");
            }

        } catch (e) {
            console.error(e);
            if(confirm("No se pudo cargar la URL. ¬øQuieres empezar de cero?")) {
                startFromScratch();
            } else {
                status.innerText = "‚ùå Error: " + e.message;
                status.style.color = "#ef4444";
            }
        }
    }

    function verifyPin() {
        const inputPin = document.getElementById('pin-entry').value;
        const errorMsg = document.getElementById('pin-error');
        
        if(inputPin === STORED_PIN) {
            document.getElementById('security-check').classList.remove('active');
            document.getElementById('app-content').classList.remove('blur-content');
            document.getElementById('new-pin-set').value = STORED_PIN; // Precargar PIN existente
            unlockApp(VIDEO_LIST.length, "Desbloqueo exitoso.");
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('pin-entry').value = '';
        }
    }

    function unlockApp(count, msg) {
        const status = document.getElementById('load-status');
        status.innerText = `‚úÖ ${msg}`;
        status.style.color = "#065f46";
        
        const step2 = document.getElementById('step-2');
        step2.style.opacity = "1";
        step2.style.pointerEvents = "auto";
        document.getElementById('btn-gen').disabled = false;
        document.getElementById('btn-gen').style.opacity = "1";
    }

    // UI Helpers
    function validateYoutube() {
        const url = document.getElementById('yt-url').value;
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        if (match && match[7].length == 11) {
            document.getElementById('yt-url').style.borderColor = "#10b981";
        }
    }

    function updateStatus(input, boxId, statusId) {
        if(input.files && input.files[0]) {
            document.getElementById(boxId).classList.add('loaded');
            document.getElementById(statusId).innerText = "‚úì " + input.files[0].name;
        }
    }

    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    }

    // 3. GENERAR EL JSON (Modificado para permitir "Solo Estructura")
    async function generateMergedJSON() {
        const url = document.getElementById('yt-url').value.trim();
        const title = document.getElementById('vid-title').value.trim();
        const fileEn = document.getElementById('file-en').files[0];
        const fileEs = document.getElementById('file-es').files[0];
        const newPin = document.getElementById('new-pin-set').value.trim();

        // Detectar si el usuario intenta agregar un video
        const hasVideoIntention = (url || title || fileEn || fileEs);
        
        if (hasVideoIntention) {
            // Si hay intenci√≥n, VALIDAMOS todo rigurosamente
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            const videoId = (match && match[7].length == 11) ? match[7] : null;

            if(!videoId) return alert("Si vas a agregar un video, la URL debe ser v√°lida.");
            if(!title) return alert("Falta el t√≠tulo del video.");
            if(!fileEn || !fileEs) return alert("Debes subir ambos archivos .srt");

            try {
                const textEn = await readFile(fileEn);
                const textEs = await readFile(fileEs);

                const newVideo = {
                    id: videoId,
                    title: title,
                    srtEn: textEn,
                    srtEs: textEs
                };
                
                VIDEO_LIST.unshift(newVideo); // Agregamos el video

            } catch (e) {
                return alert("Error leyendo archivos: " + e);
            }
        } 
        else {
            // Si NO hay intenci√≥n de video (campos vac√≠os)
            // Solo seguimos adelante para generar el JSON con (o sin) PIN.
            if(VIDEO_LIST.length === 0 && !newPin) {
                return alert("La lista est√° vac√≠a y no has puesto PIN. No hay nada que generar.");
            }
        }

        // GENERACI√ìN DEL OUTPUT FINAL
        let finalOutput;

        if (newPin.length === 4) {
            finalOutput = {
                pin: newPin,
                videos: VIDEO_LIST
            };
        } else {
            if(newPin.length > 0 && newPin.length !== 4) return alert("El PIN debe tener exactamente 4 d√≠gitos.");
            
            // Si no hay pin, guardamos como array simple (formato antiguo)
            finalOutput = VIDEO_LIST;
        }

        const jsonString = JSON.stringify(finalOutput, null, 4);
        const output = document.getElementById('output');
        output.value = jsonString;
        output.style.display = 'block';
        
        const btnCopy = document.getElementById('btn-copy');
        btnCopy.style.display = 'block';
        output.scrollIntoView({behavior: "smooth"});
        
        let msg = hasVideoIntention ? "¬°Video agregado! " : "¬°Archivo generado! ";
        msg += newPin ? "üîí JSON Protegido con PIN." : "üîì JSON P√∫blico.";
        alert(msg);
    }

    function copyToClipboard() {
        const output = document.getElementById('output');
        output.select();
        document.execCommand('copy');
        const btn = document.getElementById('btn-copy');
        btn.innerText = "¬°COPIADO!";
        setTimeout(() => btn.innerText = "COPIAR JSON COMPLETO üìã", 2000);
    }
</script>

</body>
</html>
