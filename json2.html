<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Biblioteca JSON</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #f3f4f6; --card: #ffffff; --error: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px 20px; min-height: 100vh; margin: 0; color: #1f2937; }
        .container { background: var(--card); width: 100%; max-width: 700px; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); position: relative; }
        
        h1 { margin-top: 0; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .badge { background: #e0e7ff; color: var(--primary); font-size: 12px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; }

        /* SECTIONS */
        .step-section { margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fafafa; position: relative; transition: 0.3s; }
        .step-number { position: absolute; top: -12px; left: 20px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .step-title { font-weight: 800; margin-bottom: 15px; display: block; color: #374151; }

        /* SECURITY OVERLAY */
        .blur-content { filter: blur(5px); pointer-events: none; user-select: none; opacity: 0.6; }
        .security-modal { display: none; margin-top: 20px; padding: 20px; background: #fff1f2; border: 1px solid #fecdd3; border-radius: 12px; text-align: center; }
        .security-modal.active { display: block; animation: fadeIn 0.3s ease; }
        .pin-input { font-size: 24px; letter-spacing: 10px; text-align: center; width: 150px !important; margin: 0 auto; }

        /* INPUTS */
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 700; color: #6b7280; margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; outline: none; box-sizing: border-box; }
        input[type="text"]:focus, input[type="password"]:focus { border-color: var(--primary); }
        
        /* FILE UPLOADS */
        .file-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .file-box { border: 2px dashed #cbd5e1; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; position: relative; transition: 0.2s; background: white; }
        .file-box:hover { border-color: var(--primary); background: #eef2ff; }
        .file-box input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-status { font-weight: 600; color: #4b5563; font-size: 13px; }
        .file-box.loaded { border-color: var(--success); background: #d1fae5; }
        .file-box.loaded .file-status { color: #065f46; }

        /* BUTTONS */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-load { background: #374151; color: white; margin-top: 10px; }
        .btn-unlock { background: var(--primary); color: white; margin-top: 10px; width: auto; padding: 10px 30px; }
        .btn-generate { background: var(--primary); color: white; font-size: 16px; margin-top: 10px; }
        .btn-generate:hover { background: #4338ca; transform: translateY(-2px); }
        
        textarea { width: 100%; height: 200px; margin-top: 20px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; font-size: 12px; resize: vertical; display: none; background: #1f2937; color: #a5f3fc; box-sizing: border-box; }
        
        .copy-btn { background: var(--success); color: white; margin-top: 10px; display: none; }
        .status-msg { font-size: 12px; margin-top: 5px; color: #6b7280; font-style: italic; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Gestor de Biblioteca <span class="badge">V2.1 SECURE</span></h1>
    <p style="color:#666; font-size:14px; margin-bottom:25px;">Agrega videos a tu lista existente sin romper el formato.</p>

    <div class="step-section">
        <div class="step-number">PASO 1</div>
        <span class="step-title">Cargar Biblioteca Actual</span>
        <div class="group">
            <label>URL Raw de GitHub (Tu archivo biblioteca.json)</label>
            <input type="text" id="existing-url" placeholder="https://raw.githubusercontent.com/Usuario/Repo/main/biblioteca.json">
        </div>
        <button class="btn-load" onclick="loadExistingLibrary()">üì• DESCARGAR Y ANALIZAR</button>
        <div id="load-status" class="status-msg">Esperando URL...</div>

        <div id="security-check" class="security-modal">
            <h3 style="margin:0 0 10px 0; color:#991b1b;">üîí Archivo Protegido</h3>
            <p style="font-size:13px; margin-bottom:15px;">Este archivo requiere un PIN de acceso.</p>
            <input type="password" id="pin-entry" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <br>
            <button class="btn-unlock" onclick="verifyPin()">DESBLOQUEAR</button>
            <p id="pin-error" style="color:var(--error); font-size:12px; display:none; margin-top:5px;">PIN Incorrecto</p>
        </div>
    </div>

    <div id="app-content">
        <div class="step-section" id="step-2" style="opacity:0.5; pointer-events:none;">
            <div class="step-number">PASO 2</div>
            <span class="step-title">Datos del Nuevo Video</span>
            
            <div class="group">
                <label>URL de YouTube</label>
                <input type="text" id="yt-url" placeholder="https://www.youtube.com/watch?v=..." oninput="validateYoutube()">
            </div>
            <div class="group">
                <label>T√≠tulo del Video</label>
                <input type="text" id="vid-title" placeholder="Ej: Entrevista con Elon Musk">
            </div>
            <div class="group">
                <label>Archivos de Subt√≠tulos (.srt)</label>
                <div class="file-grid">
                    <div class="file-box" id="box-en">
                        <span class="file-status" id="status-en">üá∫üá∏ Ingl√©s</span>
                        <input type="file" id="file-en" accept=".srt" onchange="updateStatus(this, 'box-en', 'status-en')">
                    </div>
                    <div class="file-box" id="box-es">
                        <span class="file-status" id="status-es">üá™üá∏ Espa√±ol</span>
                        <input type="file" id="file-es" accept=".srt" onchange="updateStatus(this, 'box-es', 'status-es')">
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px; padding-top:20px; border-top:1px dashed #e5e7eb;">
                <label style="color:#4f46e5;">üõ°Ô∏è Seguridad (Opcional)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="new-pin-set" maxlength="4" placeholder="PIN" style="width:80px; text-align:center;">
                    <span style="font-size:11px; color:#666;">Introduce 4 d√≠gitos para proteger futuras ediciones. D√©jalo vac√≠o para dejarlo p√∫blico.</span>
                </div>
            </div>
        </div>

        <button class="btn-generate" id="btn-gen" onclick="generateMergedJSON()" disabled style="opacity:0.5;">FUSIONAR Y GENERAR C√ìDIGO ‚ú®</button>
        
        <textarea id="output" readonly></textarea>
        <button class="copy-btn" id="btn-copy" onclick="copyToClipboard()">COPIAR JSON COMPLETO üìã</button>
    </div>
</div>

<script>
    let RAW_DATA = null;     // El JSON tal cual viene de la nube
    let VIDEO_LIST = [];     // Solo el array de videos
    let STORED_PIN = null;   // El PIN si existe
    let IS_LOCKED = false;

    // 1. CARGAR LIBRER√çA EXISTENTE
    async function loadExistingLibrary() {
        const url = document.getElementById('existing-url').value.trim();
        const status = document.getElementById('load-status');
        const securityModal = document.getElementById('security-check');
        const appContent = document.getElementById('app-content');
        
        if(!url) return alert("Pega la URL Raw de GitHub primero.");
        
        status.innerText = "‚è≥ Conectando...";
        status.style.color = "#4f46e5";
        securityModal.classList.remove('active');
        appContent.classList.remove('blur-content');

        try {
            const res = await fetch(url + '?t=' + new Date().getTime());
            if(!res.ok) throw new Error("No se pudo conectar (Error " + res.status + ")");
            
            RAW_DATA = await res.json();
            
            // --- LOGICA DE SEGURIDAD ---
            
            // CASO A: Es el formato antiguo (Array simple)
            if(Array.isArray(RAW_DATA)) {
                VIDEO_LIST = RAW_DATA;
                STORED_PIN = null;
                unlockApp(VIDEO_LIST.length);
            } 
            // CASO B: Es el formato nuevo (Objeto con PIN)
            else if (RAW_DATA.pin && Array.isArray(RAW_DATA.videos)) {
                STORED_PIN = RAW_DATA.pin;
                VIDEO_LIST = RAW_DATA.videos;
                
                // Bloquear interfaz
                IS_LOCKED = true;
                status.innerText = "üîí Archivo bloqueado. Introduce el PIN.";
                status.style.color = "#b91c1c";
                securityModal.classList.add('active');
                appContent.classList.add('blur-content');
                document.getElementById('pin-entry').value = '';
                document.getElementById('pin-entry').focus();
            }
            // CASO C: JSON vac√≠o o estructura desconocida
            else {
                VIDEO_LIST = [];
                unlockApp(0);
            }

        } catch (e) {
            console.error(e);
            status.innerText = "‚ùå Error: " + e.message;
            status.style.color = "#ef4444";
        }
    }

    // 1.5 VERIFICAR PIN
    function verifyPin() {
        const inputPin = document.getElementById('pin-entry').value;
        const errorMsg = document.getElementById('pin-error');
        
        if(inputPin === STORED_PIN) {
            // PIN Correcto
            document.getElementById('security-check').classList.remove('active');
            document.getElementById('app-content').classList.remove('blur-content');
            // Precargar el PIN en el campo de "Nuevo PIN" para que no se pierda al guardar
            document.getElementById('new-pin-set').value = STORED_PIN;
            unlockApp(VIDEO_LIST.length);
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('pin-entry').value = '';
        }
    }

    function unlockApp(count) {
        const status = document.getElementById('load-status');
        status.innerHTML = `‚úÖ <b>¬°√âxito!</b> Se cargaron ${count} videos.`;
        status.style.color = "#065f46";
        
        const step2 = document.getElementById('step-2');
        step2.style.opacity = "1";
        step2.style.pointerEvents = "auto";
        document.getElementById('btn-gen').disabled = false;
        document.getElementById('btn-gen').style.opacity = "1";
    }

    // 2. VALIDACIONES UI
    function validateYoutube() {
        const url = document.getElementById('yt-url').value;
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        if (match && match[7].length == 11) {
            document.getElementById('yt-url').style.borderColor = "#10b981";
        }
    }

    function updateStatus(input, boxId, statusId) {
        if(input.files && input.files[0]) {
            document.getElementById(boxId).classList.add('loaded');
            document.getElementById(statusId).innerText = "‚úì " + input.files[0].name;
        }
    }

    // 3. FUSIONAR Y GENERAR
    async function generateMergedJSON() {
        // ... (Validaciones existentes) ...
        const url = document.getElementById('yt-url').value;
        const title = document.getElementById('vid-title').value;
        const fileEn = document.getElementById('file-en').files[0];
        const fileEs = document.getElementById('file-es').files[0];
        const newPin = document.getElementById('new-pin-set').value.trim();

        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        const videoId = (match && match[7].length == 11) ? match[7] : null;

        if(!videoId) return alert("URL de YouTube inv√°lida");
        if(!title) return alert("Escribe un t√≠tulo");
        if(!fileEn || !fileEs) return alert("Faltan los archivos SRT");

        try {
            const textEn = await readFile(fileEn);
            const textEs = await readFile(fileEs);

            const newVideo = {
                id: videoId,
                title: title,
                srtEn: textEn,
                srtEs: textEs
            };

            // Agregamos al array existente
            VIDEO_LIST.unshift(newVideo);

            // DECISI√ìN FINAL DE FORMATO
            let finalOutput;

            if (newPin.length === 4) {
                // Si hay un PIN definido, generamos la estructura segura
                finalOutput = {
                    pin: newPin,
                    videos: VIDEO_LIST
                };
            } else {
                // Si no hay PIN, generamos el Array simple (compatible antigua)
                finalOutput = VIDEO_LIST;
            }

            const jsonString = JSON.stringify(finalOutput, null, 4);

            const output = document.getElementById('output');
            output.value = jsonString;
            output.style.display = 'block';
            
            const btnCopy = document.getElementById('btn-copy');
            btnCopy.style.display = 'block';
            
            output.scrollIntoView({behavior: "smooth"});
            
            let msg = `¬°Listo! Agregado. Tienes ${VIDEO_LIST.length} videos.`;
            if(newPin) msg += " üîí ARCHIVO PROTEGIDO CON PIN.";
            alert(msg);

        } catch (e) {
            alert("Error procesando archivos: " + e);
        }
    }

    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    }

    function copyToClipboard() {
        const output = document.getElementById('output');
        output.select();
        document.execCommand('copy');
        const btn = document.getElementById('btn-copy');
        btn.innerText = "¬°COPIADO! ‚úÖ VE A GITHUB Y PEGA ESTO";
        setTimeout(() => btn.innerText = "COPIAR JSON COMPLETO üìã", 3000);
    }
</script>

</body>
</html>
