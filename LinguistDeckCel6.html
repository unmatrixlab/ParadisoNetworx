<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polyglot Tutor V33 - Fixed Logic</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Dancing+Script:wght=700&family=Playfair+Display:wght=600&family=Courier+Prime:wght=700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
        :root {
            --primary: #007AFF;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --bg-body: #FFFFFF;
            --text-main: #111111;
            --toolbar-bg: rgba(140, 148, 127, 0.95);
            --dropdown-bg: rgba(255, 255, 255, 0.98);
            --saved-word: #ff69b4; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ====== APP LAYOUT ====== */
        .main-container {
            width: 100%;
            height: 100vh;
            background: #292929;
            display: flex;
            flex-direction: column;
            border: none;
            overflow: hidden;
        }

        .sticky-top-wrapper {
            flex-shrink: 0;
            z-index: 100;
            background: var(--toolbar-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e5ea;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        .editor-header {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            max-width: 1000px; 
            margin: 0 auto;
            width: 100%;
        }
        .editor-title { font-weight: 800; font-size: 1.1rem; color: #111; display:flex; gap:10px; align-items:center; letter-spacing: -0.3px;}
        .save-indicator { font-size: 0.75rem; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: color 0.3s; }
        .save-indicator.saved { color: var(--success); }

        .editor-toolbar { 
            width: 100%; padding: 10px 20px; 
            display: flex; align-items: center; gap: 15px; overflow-x: auto; scrollbar-width: none;
            max-width: 1000px; margin: 0 auto;
        }
        
        .delicate-group {
            display: flex; align-items: center; gap: 8px; 
            background: #f7f7f9; border: 1px solid #e5e5ea; 
            border-radius: 20px; padding: 4px 10px;
            flex-shrink: 0;
        }
        .delicate-sep { width: 1px; height: 18px; background: #d1d1d6; margin: 0 4px; }
        .color-circle { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-circle:hover { transform: scale(1.2); }
        .color-circle.active { border-color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: scale(1.1); }
        .font-btn { background: none; border: none; font-size: 0.9rem; font-weight: 600; color: #888; cursor: pointer; padding: 2px 6px; border-radius: 6px; transition: all 0.2s; }
        .font-btn:hover { color: #000; background: #e5e5ea; }
        .font-btn.active { color: #007aff; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .style-icon { background: none; border: none; font-size: 0.85rem; font-weight: 700; color: #666; cursor: pointer; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .style-icon:hover { background: #e5e5ea; color: #000; }
        .style-icon.active { background: #000; color: #fff; }
        .toolbar-group { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        
        .btn-ai-trigger { background: linear-gradient(135deg, #e3f2fd, #90caf9); color: #007AFF; border: 1px solid #bbdefb; padding: 0 16px; height: 36px; border-radius: 10px; cursor: pointer; font-weight: 800; display:flex; align-items:center; justify-content:center; gap:6px; font-size: 0.9rem; transition: transform 0.2s; }
        .btn-ai-trigger:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,122,255,0.2); }
        .btn-clear { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e5ea; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0;}
        .btn-clear svg { width: 18px; height: 18px; fill: #888; }
        .editor-area { flex: 1; width: 100%; max-width: 900px; margin: 0 auto; padding: 40px 20px 100px 20px; border: none; font-family: 'Inter', sans-serif; font-size: 19px; line-height: 1.8; outline: none; color: #111; background: transparent; overflow-y: auto; }

        /* ====== AI HUB ====== */
        .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 3000; display: none; flex-direction: column; }
        .ai-popup-overlay.active { display: flex; }
        .ai-popup-box { background: #fff; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; border: none; border-radius: 0; box-shadow: none; }
        .ai-header { background: rgba(255,255,255,0.98); border-bottom: 1px solid #eee; color: #111; padding: 15px 20px; font-weight: 800; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; }
        .ai-close { background: #f2f2f7; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; transition: background 0.2s; font-size: 1.5rem;}
        .ai-close:hover { background: #e5e5ea; color: #000; }
        .ai-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; flex:1; background: #fff; width: 100%; max-width: 900px; margin: 0 auto; padding-bottom: 80px; }

        /* ====== CARDS & INPUTS ====== */
        .ai-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media(max-width: 600px) { .ai-grid-2 { grid-template-columns: 1fr; } }
        .ai-card-group { background: #F9F9FB; border-radius: 16px; padding: 6px; border: 1px solid #e5e5ea; display: flex; flex-direction: column; transition: border-color 0.2s; position: relative; }
        .ai-card-group:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .ai-card-label { font-size: 0.75rem; font-weight: 800; color: #888; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px 4px 12px; display: flex; align-items: center; gap: 6px; }

        /* ====== CUSTOM DROPDOWN SYSTEM ====== */
        .ai-select { display: none; } 
        .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
        .custom-select-trigger { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 12px; font-size: 0.95rem; font-weight: 600; color: #111; cursor: pointer; background: transparent; transition: all 0.2s; border-radius: 12px; }
        .custom-select-trigger:hover { background: rgba(0,0,0,0.03); }
        .custom-arrow { font-size: 0.8rem; color: #999; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); margin-left: 10px; }
        .custom-select-wrapper.open .custom-arrow { transform: rotate(180deg); color: var(--primary); }
        .custom-options { position: absolute; top: 110%; left: 0; right: 0; background: var(--dropdown-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.15); border-radius: 16px; z-index: 2000; opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-10px) scale(0.98); transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1); max-height: 300px; overflow-y: auto; padding: 8px; }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0) scale(1); }
        .custom-option { padding: 10px 12px; font-size: 0.9rem; color: #333; cursor: pointer; border-radius: 8px; transition: all 0.1s; display: flex; align-items: center; justify-content: space-between; }
        .custom-option:hover { background: var(--primary); color: white; }
        .custom-option.selected { background: #f2f2f7; color: #000; font-weight: 700; }
        .custom-option.selected:after { content: '‚úì'; color: var(--primary); font-weight: 800; }
        .custom-option:hover.selected { background: var(--primary); color: white; }
        .custom-option:hover.selected:after { color: white; }
        .custom-group-header { padding: 12px 12px 6px 12px; font-size: 0.7rem; text-transform: uppercase; color: #999; font-weight: 800; letter-spacing: 0.5px; pointer-events: none; margin-top: 4px; border-top: 1px solid #f2f2f7; }
        .custom-group-header:first-child { border-top: none; margin-top: 0; }
        .custom-options::-webkit-scrollbar { width: 5px; }
        .custom-options::-webkit-scrollbar-track { background: transparent; }
        .custom-options::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
        .custom-select-trigger.override-warning { color: var(--danger); }
        .custom-select-trigger.override-warning:after { content: '‚ö†Ô∏è'; font-size: 0.8rem; margin-left: auto; margin-right: 5px;}

        /* ====== INPUTS CUSTOM ====== */
        .ai-custom-input { width: 100%; padding: 12px; border: none; border-top: 1px solid #e5e5ea; background: #fff; font-size: 0.9rem; color: #333; outline: none; border-radius: 0 0 16px 16px; transition: background 0.2s; }
        .ai-custom-input:focus { background: #fff; color: #000; }
        
        /* ====== OTHER CONTROLS ====== */
        .segmented-control { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; gap: 2px; }
        .level-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; background: transparent; color: #666; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .level-btn:hover { color: #000; }
        .level-btn.selected { background: #fff; color: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .flag-group { display: flex; gap: 12px; flex-wrap: wrap;}
        .flag-btn { border: 2px solid transparent; border-radius: 50%; background: #f2f2f7; font-size: 1.5rem; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; filter: grayscale(100%); transition: all 0.2s; }
        .flag-btn:hover { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
        .flag-btn.selected { border-color: var(--primary); background: #fff; opacity: 1; filter: grayscale(0%); box-shadow: 0 4px 10px rgba(0,122,255,0.2); }
        .flag-btn.hidden { display: none !important; }
        .flag-sm { width: 40px; height: 40px; font-size: 1.2rem; }

        textarea.ai-custom-input { resize: vertical; min-height: 80px; border-radius: 12px; border: 1px solid #e5e5ea; background: #F9F9FB; margin-top: 0; }
        textarea.ai-custom-input:focus { background: #fff; border-color: var(--primary); }
        
        .ai-footer-actions { margin: 15px 0; padding: 0; background: transparent; border-top: none; display: flex; gap: 15px; z-index: 5; width: 100%; }
        .btn-ai-action { flex: 1; padding: 16px; border: none; border-radius: 14px; font-weight: 800; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); text-transform: uppercase; letter-spacing: 0.5px; border: 2px solid #fff; }
        .btn-ai-primary { background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%); color: #445; box-shadow: 0 8px 20px rgba(142, 197, 252, 0.25); }
        .btn-ai-primary:hover { transform: translateY(-2px); background: linear-gradient(135deg, #d3b0f5 0%, #7eb8f2 100%); box-shadow: 0 12px 25px rgba(142, 197, 252, 0.4); color: #223; }
        #btn-paste-json { background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%); color: #445; box-shadow: 0 8px 20px rgba(250, 208, 196, 0.25); }
        #btn-paste-json:hover { transform: translateY(-2px); background: linear-gradient(135deg, #f5c0b0 0%, #f5c0f5 100%); box-shadow: 0 12px 25px rgba(250, 208, 196, 0.4); color: #223; }

        .ai-preview-box { margin-bottom: 20px; border: 2px solid var(--success); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1); }
        .ai-preview-box.highlight { animation: highlightPulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) 3; }
        @keyframes highlightPulse { 0%, 100% { border-color: var(--success); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1); } 50% { border-color: var(--warning); box-shadow: 0 0 20px rgba(255, 149, 0, 0.5); } }

        .saved-exercises-list { max-height: 300px; overflow-y: auto; border: 1px solid #e5e5ea; border-radius: 12px; margin-bottom: 10px; }
        .saved-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .saved-item:nth-child(odd) { background: #fff; }
        .saved-item:nth-child(even) { background: #f4f4f7; }
        .saved-item:last-child { border-bottom: none; }
        .saved-info { flex: 1; }
        .saved-name { font-weight: 600; font-size: 0.9rem; color: #111; }
        .saved-date { font-size: 0.7rem; color: #888; }
        .badge-new { background: var(--success); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
        .badge-tpl { background: var(--warning); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
        .mem-actions { display: flex; gap: 6px; }
        .btn-icon-action { width: 30px; height: 30px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); color: #555; transition: all 0.2s;}
        .btn-icon-action:hover { background: #000; color: #fff; }
        .btn-insert { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
        .btn-delete-item:hover { background: #d00 !important; color: #fff !important; }
        .mem-controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn-mem-ctrl { flex: 1; padding: 10px; border: 1px solid #e5e5ea; background: #fff; border-radius: 10px; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .btn-mem-ctrl:hover { background: #f9f9f9; }

        /* ====== EXERCISE RENDER ====== */
        .exercise-box { background: #f9f9fb; border: 1px solid #e5e5ea; border-radius: 12px; padding: 25px; margin: 30px 0; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .exercise-header { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 16px; border-bottom: 1px solid #f2f2f7; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .exercise-header span { flex: 1; word-wrap: break-word; overflow-wrap: break-word; }
        .btn-theory { background: #e3f2fd; color: var(--primary); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
        .btn-del-block { background: #fff5f5; color: var(--danger); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 5px; }
        .btn-reset-block { background: #fff8e1; color: #d97706; border: none; padding: 6px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: 700; white-space: nowrap; margin-left: 5px; }
        .theory-box { display: none; background: #fff; padding: 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; border: 1px solid #e5e5ea;}
        .exercise-row { margin-bottom: 16px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; line-height: 1.8; position: relative; } 
        .hint-box, .trans-box { display: none; width: 100%; margin-top: 8px; padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; }
        .hint-box { background: #fffbe6; border-left: 4px solid #f59e0b; color: #78350f; }
        .trans-box { background: #f0f9ff; border-left: 4px solid #007AFF; color: #0c4a6e; }
        .trans-line { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .btn-mini-speak { background: #fff; border: 1px solid #d1d1d6; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ex-select { padding: 8px 14px; border: 1px solid #d1d1d6; border-radius: 8px; background: white; cursor: pointer; outline: none; font-size: 0.95rem; appearance: none; padding-right: 2.5rem; max-width: 100%; white-space: normal; }
        .ex-select.correct { border-color: var(--success) !important; background-color: #e8f5e9 !important; color: #1b5e20 !important; font-weight: 700; }
        .ex-select.wrong { border-color: var(--danger) !important; background-color: #ffebee !important; color: #b71c1c !important; animation: shake 0.3s; }
        .ex-btn-icon { background: #f2f2f7; border: none; border-radius: 8px; cursor: pointer; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; color: #1d1d1f; }
        .ex-btn-icon:hover { background: #e5e5ea; color: var(--primary); }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .exercise-row s { color: var(--danger); text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color: var(--danger); background-color: rgba(255, 59, 48, 0.1); padding: 2px 6px; border-radius: 6px; margin-right: 8px; font-weight: 600; display: inline-block; }
        .exercise-row s::before { content: "‚úñ"; font-size: 0.7em; margin-right: 4px; vertical-align: text-top; opacity: 0.6; }
        .cloze-gap-container { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 4px; }
    

/* --- NUEVOS ESTILOS PARA INTERACTIVIDAD & PILL --- */
.interactive-word {
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    display: inline-block;
}
.interactive-word:hover {
    background-color: rgba(0, 122, 255, 0.1);
    color: var(--primary);
}
.interactive-word.word-added {
    color: var(--saved-word) !important;
    font-weight: 700 !important;
    border-bottom-color: var(--saved-word) !important;
}

/* Bot√≥n de copiar peque√±o */
.btn-copy-text {
    background: transparent;
    border: 1px solid #d1d1d6;
    color: #666;
    border-radius: 6px;
    width: 24px;
    height: 24px;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    margin-left: auto;
}
.btn-copy-text:hover { background: #e5e5ea; color: #000; }
.btn-copy-text.copied { border-color: var(--success); color: var(--success); }

/* === UNIFIED PILL (Igual que en Generator) === */
#unified-pill {
    position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(150%);
    background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px;
    padding: 8px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    display: flex; align-items: center; gap: 15px; 
    z-index: 5000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-width: 95%; white-space: nowrap; pointer-events: none; opacity: 0;
}
#unified-pill.visible { transform: translateX(-50%) translateY(0); pointer-events: auto; opacity: 1; }

.pill-section { display: flex; align-items: center; gap: 8px; }
.pill-icon { font-size: 1.1em; }

/* Stats Section */
#pill-stats-text {
    font-family: 'Roboto Mono', monospace; font-weight: 800; font-size: 1em; 
    color: #e5e7eb; letter-spacing: 1px;
}
.stats-active { color: var(--saved-word) !important; }

/* Divider */
.pill-divider { width: 1px; height: 16px; background: rgba(255,255,255,0.2); }

/* Translate Section */
#pill-trans { display: none; }
#pill-trans.active { display: flex; }
.trans-origin { color: #aaa; font-style: italic; font-size: 0.9em; }
.trans-arrow { color: #666; font-size: 0.8em; margin: 0 4px; }
.trans-result { color: #fff; font-weight: 700; font-size: 0.95em; }

</style>
</head>
<body>

    <div id="unified-pill">
        <div class="pill-section">
            <span class="pill-icon">üìä</span>
            <span id="pill-stats-text">- | 0</span>
        </div>
        
        <div id="pill-divider" class="pill-divider" style="display:none;"></div>

        <div id="pill-trans" class="pill-section">
            <span id="trans-origin" class="trans-origin">...</span>
            <span class="trans-arrow">‚Üí</span>
            <span id="trans-result" class="trans-result">...</span>
        </div>
    </div>

    <div class="main-container">
        <div class="sticky-top-wrapper">
            <div class="editor-header">
                <div class="editor-title">
                    <span>üìò Polyglot Editor</span>
                </div>
                <div>
                      <span class="save-indicator" id="save-status">‚úì Ready</span>
                </div>
            </div>

            <div class="editor-toolbar">
                <div class="delicate-group">
                    <div class="color-circle" style="background:#fff; border-color:#ddd;" onmousedown="event.preventDefault(); applyColor('#ffffff')" title="White"></div>
                    <div class="color-circle" style="background:#FF3B30" onmousedown="event.preventDefault(); applyColor('#FF3B30')" title="Red"></div>
                    <div class="color-circle" style="background:#007AFF" onmousedown="event.preventDefault(); applyColor('#007AFF')" title="Blue"></div>
                    <div class="color-circle" style="background:#34C759" onmousedown="event.preventDefault(); applyColor('#34C759')" title="Green"></div>
                    <div class="delicate-sep"></div>
                    <button class="font-btn" style="font-family:'Inter'" onclick="setFont('Inter')" title="Sans Serif">Aa</button>
                    <button class="font-btn" style="font-family:'Playfair Display'" onclick="setFont('Playfair Display')" title="Serif">Aa</button>
                    <button class="font-btn" style="font-family:'Courier Prime'" onclick="setFont('Courier Prime')" title="Mono">Aa</button>
                    <div class="delicate-sep"></div>
                    <button class="style-icon" id="btn-bold" onmousedown="event.preventDefault(); toggleBold()" title="Bold">B</button>
                    <button class="style-icon" id="btn-size-norm" onmousedown="event.preventDefault(); setSize(3)" title="Normal">T</button>
                    <button class="style-icon" id="btn-size-lg" onmousedown="event.preventDefault(); setSize(5)" title="Large" style="font-size:1.1rem">T+</button>
                </div>

                <div class="toolbar-group">
                    <button class="btn-ai-trigger" onclick="openAIMenu()" title="AI Exercise Hub">
                        <span>‚ö° AI Hub</span>
                    </button>
                </div>
                
                <button class="btn-clear" onclick="if(confirm('Clear all content?')) { document.getElementById('editor-text').innerHTML=''; saveNote(); }" title="Clear All">
                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </div>
        </div>

        <div id="editor-text" class="editor-area" contenteditable="true" placeholder="Start typing..." oninput="saveNote()"></div>
    </div>

    <div class="ai-popup-overlay" id="ai-hub-modal">
        <div class="ai-popup-box">
            <div class="ai-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span>‚ö° Polyglot AI Hub</span>
                </div>
                <button class="ai-close" onclick="closeAIMenu()">√ó</button>
            </div>
            
            <div class="ai-body">
                
                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üåç Context</div>
                        <select id="ai-context-select" class="ai-select">
                            <option value="" selected disabled>Select Context...</option>
                            <optgroup label="üìö Vocabulary Builder DB">
                                <option value="vb_last_5">Last 5 Saved Words</option>
                                <option value="vb_last_10">Last 10 Saved Words</option>
                                <option value="vb_last_15">Last 15 Saved Words</option>
                                <option value="vb_random">Random Selection (15)</option>
                            </optgroup>
                            <optgroup label="üè† Daily Life & Lifestyle">
                                <option value="Daily Routine & Habits">Daily Routine & Habits</option>
                                <option value="Family & Relationships">Family & Relationships</option>
                                <option value="House & Chores">House, Furniture & Chores</option>
                                <option value="Food, Cooking & Restaurants">Food, Cooking & Restaurants</option>
                                <option value="Health, Fitness & Body">Health, Fitness & Doctors</option>
                                <option value="Hobbies, Music & Movies">Hobbies, Music & Movies</option>
                            </optgroup>
                            <optgroup label="‚úàÔ∏è Travel & Adventure">
                                <option value="At the Airport & Flying">At the Airport & Flying</option>
                                <option value="Hotel Check-in & Problems">Hotel Situations</option>
                                <option value="Asking for Directions & City">City & Directions</option>
                                <option value="Car Rental & Driving">Car Rental & Driving</option>
                            </optgroup>
                            <optgroup label="üíº Work & Business">
                                <option value="Job Interviews & CVs">Job Interviews & HR</option>
                                <option value="Business Meetings & Strategy">Meetings & Negotiations</option>
                                <option value="Emails & Formal Communication">Formal Emails</option>
                                <option value="Tech, IT & Programming">Tech, IT & Programming</option>
                                <option value="Marketing & Sales">Marketing & Sales</option>
                                <option value="Customer Service Scenarios">Customer Service Issues</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-context-custom" class="ai-custom-input" placeholder="Or type custom context..." oninput="checkCustomOverride('ai-context-custom', 'ai-context-select')">
                    </div>

                    <div class="ai-card-group">
                        <div class="ai-card-label">üß† Grammar</div>
                        <select id="ai-grammar-select" class="ai-select">
                            <option value="" selected disabled>Select Grammar...</option>
                            <optgroup label="üïí Present Tenses">
                                <option value="Present Simple">Present Simple (Habits & Facts)</option>
                                <option value="Present Continuous">Present Continuous (Now & Future)</option>
                                <option value="Present Perfect">Present Perfect (Experiences)</option>
                                <option value="Present Perfect Continuous">Present Perfect Continuous</option>
                                <option value="Present Simple vs Continuous">Mix: Simple vs Continuous</option>
                            </optgroup>
                            <optgroup label="üîô Past Tenses">
                                <option value="Past Simple">Past Simple (Finished Actions)</option>
                                <option value="Past Continuous">Past Continuous (Interrupted Actions)</option>
                                <option value="Past Perfect">Past Perfect (The Past before the Past)</option>
                                <option value="Past Perfect Continuous">Past Perfect Continuous</option>
                                <option value="Narrative Tenses Mix">Mix: Narrative Tenses (Storytelling)</option>
                            </optgroup>
                            <optgroup label="üöÄ Future Tenses">
                                <option value="Future Simple (Will)">Future Simple (Will - Spontaneous)</option>
                                <option value="Be Going To">Be Going To (Plans)</option>
                                <option value="Future Continuous">Future Continuous (In progress later)</option>
                                <option value="Future Perfect">Future Perfect (Completed by then)</option>
                                <option value="Future Forms Mix">Mix: Will / Going to / Present Cont.</option>
                            </optgroup>
                            <optgroup label="‚öôÔ∏è Advanced Structures">
                                <option value="Conditionals 0 & 1">Conditionals 0 & 1 (Real)</option>
                                <option value="Conditionals 2 & 3">Conditionals 2 & 3 (Unreal)</option>
                                <option value="Mixed Conditionals">Mixed Conditionals</option>
                                <option value="Passive Voice">Passive Voice</option>
                                <option value="Reported Speech">Reported Speech (Indirect)</option>
                                <option value="Relative Clauses">Relative Clauses (Who, Which, That)</option>
                                <option value="Causative (Have/Get something done)">Causative Form</option>
                            </optgroup>
                            <optgroup label="üß© Particles & Modals">
                                <option value="Modal Verbs (Can, Could, Should, Must)">Modal Verbs</option>
                                <option value="Modals of Deduction (Must have, Can't have)">Modals of Past Deduction</option>
                                <option value="Phrasal Verbs">Phrasal Verbs (General)</option>
                                <option value="Prepositions of Place & Time">Prepositions (In, On, At, By)</option>
                                <option value="Articles (A, An, The, Zero)">Articles (A / An / The)</option>
                                <option value="Gerunds vs Infinitives">Gerunds vs Infinitives</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-grammar-custom" class="ai-custom-input" placeholder="Or type custom grammar..." oninput="checkCustomOverride('ai-grammar-custom', 'ai-grammar-select')">
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üìù Format</div>
                        <select id="ai-type-select" class="ai-select">
                            <option value="" selected disabled>Select Format...</option>
                            <optgroup label="‚úçÔ∏è Standard Practice">
                                <option value="Fill in the Blanks (Cloze)">Fill in the Blanks (Classic)</option>
                                <option value="Multiple Choice Quiz">Multiple Choice Quiz</option>
                                <option value="Find and Fix the Mistake">Find and Fix the Mistake</option>
                                <option value="True or False (Reading)">True or False (Reading Comp.)</option>
                            </optgroup>
                            <optgroup label="üß† Vocabulary & Logic">
                                <option value="Vocabulary Matching">Vocabulary Matching (Def - Word)</option>
                                <option value="Synonym & Antonym Finder">Synonym Finder</option>
                                <option value="Sentence Reordering">Sentence Reordering (Scrambled)</option>
                                <option value="Choose the Odd One Out">Odd One Out (Logic)</option>
                            </optgroup>
                            <optgroup label="üîÑ Translation">
                                <option value="Reverse Translation (ES->EN)">Reverse Translation (See ES, Pick EN)</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-type-custom" class="ai-custom-input" placeholder="Or type custom format..." oninput="checkCustomOverride('ai-type-custom', 'ai-type-select')">
                    </div>

                    <div class="ai-card-group" style="justify-content: space-between;">
                        <div style="flex: 1;">
                            <div class="ai-card-label">‚öôÔ∏è Settings</div> 
                            <div style="display: flex; align-items: center; gap: 0; padding-right: 12px;"> 
                                <select id="ai-gap-count" class="ai-select" style="flex: 1; min-width: 0;" title="Gaps">
                                    <option value="1" selected>1 Gap</option>
                                    <option value="2">2 Gaps</option>
                                    <option value="3">3 Gaps</option>
                                    <option value="random">Mix</option>
                                </select>
                                <select id="ai-option-count" class="ai-select" style="flex: 1; min-width: 0; border-left: 1px solid #e5e5ea; padding-left:10px;" title="Options">
                                    <option value="2">2 Opts</option>
                                    <option value="3">3 Opts</option>
                                    <option value="4" selected>4 Opts</option>
                                    <option value="5">5 Opts</option>
                                </select>
                                <select id="ai-sentence-count" class="ai-select" style="flex: 1; min-width: 0; border-left: 1px solid #e5e5ea; padding-left:10px;" title="Quantity">
                                    <option value="3">3 Qs</option>
                                    <option value="6" selected>6 Qs</option>
                                    <option value="9">9 Qs</option>
                                    <option value="12">12 Qs</option>
                                </select>
                            </div>
                        </div>
                        <div style="padding: 0 10px 10px 10px;">
                            <div class="segmented-control" id="level-group">
                                <button class="level-btn" onclick="selectLevel(this, 'A1-A2 (Beginner)')">A1-A2</button>
                                <button class="level-btn selected" onclick="selectLevel(this, 'B1-B2 (Intermediate)')">B1-B2</button>
                                <button class="level-btn" onclick="selectLevel(this, 'C1-C2 (Advanced)')">C1-C2</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div>
                        <div class="ai-card-label">üéØ Target</div>
                        <div class="flag-group" id="target-lang-group">
                            <div class="flag-btn selected" onclick="selectTarget(this, 'en')" title="English">üá∫üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'es')" title="Spanish">üá™üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'pt')" title="Portuguese">üáßüá∑</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'it')" title="Italian">üáÆüáπ</div>
                        </div>
                    </div>
                    <div>
                        <div class="ai-card-label">üåê Translate</div>
                        <div class="flag-group" id="trans-lang-group">
                            <div class="flag-btn flag-sm" data-lang="en" onclick="toggleTrans(this, 'en')">üá∫üá∏</div>
                            <div class="flag-btn flag-sm selected" data-lang="es" onclick="toggleTrans(this, 'es')">üá™üá∏</div>
                            <div class="flag-btn flag-sm" data-lang="pt" onclick="toggleTrans(this, 'pt')">üáßüá∑</div>
                            <div class="flag-btn flag-sm" data-lang="it" onclick="toggleTrans(this, 'it')">üáÆüáπ</div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="ai-card-label">‚ö° Extra Instructions</div>
                    <textarea id="ai-extra-data" class="ai-custom-input" placeholder="E.g. Use British slang, make it funny..."></textarea>
                </div>

                <div class="ai-footer-actions">
                    <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">
                        <span>‚ú®</span> Create Mission
                    </button>
                    <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">
                        <span>‚ú®</span> Paste Mission
                    </button>
                </div>

                <div id="ai-latest-preview"></div>

                <div style="margin-top: 20px;">
                    <div class="ai-card-label" style="font-size: 0.9rem;">üéì Memory Bank</div>
                    <div class="saved-exercises-list" id="ai-memory-list">
                        <div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>
                    </div>
                    <div class="mem-controls">
                        <button class="btn-mem-ctrl" onclick="exportMemoryBank()">‚¨áÔ∏è Export</button>
                        <input type="file" id="importMemFile" accept=".json" style="display:none" onchange="importMemoryBank(this)">
                        <button class="btn-mem-ctrl" onclick="document.getElementById('importMemFile').click()">‚¨ÜÔ∏è Import</button>
                        <button class="btn-mem-ctrl" style="color:var(--danger)" onclick="clearAIMemory()">üóëÔ∏è Clear</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    /* ====== CONFIG & STATE ====== */
    const AI_MEM_KEY = 'mdc_ai_exercises';
    const EDITOR_KEY = 'mdc_simple_editor';
    const VOCAB_DB_KEY = 'mdc_vocab_list'; 
    
    let currentTargetLang = 'en'; 
    let currentLevel = 'B1-B2 (Intermediate)';
    const transLangs = new Set(['es']); 
    const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian' };
    
    const editorArea = document.getElementById('editor-text');
    const aiModal = document.getElementById('ai-hub-modal');

    // PILL STATE
    let currentWordStats = { occurrences: "-", uniqueTotal: 0 };
    let lastStorageString = "";

    /* ====== INITIALIZATION ====== */
    document.addEventListener('DOMContentLoaded', () => {
        loadEditorContent();
        renderAiList(); 
        updateTransFlagsVisibility();
        initCustomDropdowns(); 
        startStorageWatcher(); 
        refreshActiveView(); // Force initial highlight
    });

    /* ====== WATCHER SYSTEM ====== */
    function startStorageWatcher() {
        lastStorageString = localStorage.getItem(VOCAB_DB_KEY) || "";
        setInterval(() => {
            const currentString = localStorage.getItem(VOCAB_DB_KEY) || "";
            if (currentString !== lastStorageString) {
                lastStorageString = currentString;
                refreshActiveView(); 
            }
        }, 500); 
    }

    function refreshActiveView() {
        const currentVocab = getDbWordsSet();
        const editor = document.getElementById('editor-text');
        
        // Scan ALL existing interactive words in editor
        editor.querySelectorAll('.interactive-word').forEach(span => {
            const clean = sanitizeText(span.innerText).toLowerCase();
            if (currentVocab.has(clean)) {
                span.classList.add('word-added');
            } else {
                span.classList.remove('word-added');
            }
        });
        
        // Only update pill if it's currently visible
        if (document.getElementById('unified-pill').classList.contains('visible')) {
            updateUnifiedPill(null);
        }
    }

    /* ====== PILL LOGIC ====== */
    function updateUnifiedPill(translationData = null) {
        const pill = document.getElementById('unified-pill');
        const statsText = document.getElementById('pill-stats-text');
        const transPart = document.getElementById('pill-trans');
        const divider = document.getElementById('pill-divider');
        const transOrigin = document.getElementById('trans-origin');
        const transResult = document.getElementById('trans-result');

        pill.classList.add('visible');

        // 1. UPDATE STATS based on Editor content
        const savedWords = editorArea.querySelectorAll('.interactive-word.word-added');
        const uniqueSet = new Set();
        savedWords.forEach(el => uniqueSet.add(sanitizeText(el.innerText).toLowerCase()));
        currentWordStats.uniqueTotal = uniqueSet.size;
        
        statsText.innerText = `${currentWordStats.occurrences} | ${currentWordStats.uniqueTotal}`;
        
        if(currentWordStats.uniqueTotal > 0) statsText.style.color = "#ff69b4";
        else statsText.style.color = "#e5e7eb";

        // 2. UPDATE TRANSLATION
        if (translationData) {
            divider.style.display = 'block';
            transPart.style.display = 'flex';
            transOrigin.innerText = translationData.origin;
            transResult.innerText = translationData.result;
        } else {
            if (!transPart.dataset.hasActive) {
                divider.style.display = 'none';
                transPart.style.display = 'none';
            }
        }
    }

    async function translateWord(text) {
        const transPart = document.getElementById('pill-trans');
        transPart.dataset.hasActive = "true"; 
        
        updateUnifiedPill({ origin: text, result: "..." });

        try {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=es&dt=t&q=${encodeURIComponent(text)}`;
            const res = await fetch(url);
            const data = await res.json();
            let result = "Not found";
            if (data && data[0] && data[0][0]) result = data[0][0][0];
            
            updateUnifiedPill({ origin: text, result: result });
        } catch (e) { 
            updateUnifiedPill({ origin: text, result: "Error" });
        }
        
        clearTimeout(window.transTimer);
        window.transTimer = setTimeout(() => { 
            const transPart = document.getElementById('pill-trans');
            transPart.dataset.hasActive = ""; 
            updateUnifiedPill(null); 
        }, 5000);
    }

    /* ====== INTERACTIVE HANDLER ====== */
    window.handleWordClick = function(wordRaw, element, canSave = true) {
        // 1. Translate
        translateWord(wordRaw);

        // 2. Calc Occurrences
        const cleanWord = sanitizeText(wordRaw);
        const checkEng = cleanWord.toLowerCase();
        let count = 0;
        editorArea.querySelectorAll('.interactive-word').forEach(el => {
            if (sanitizeText(el.innerText).toLowerCase() === checkEng) count++;
        });
        currentWordStats.occurrences = count;

        if (!canSave) return; // FIX: Don't save translations

        // 3. Toggle Logic
        let items = JSON.parse(localStorage.getItem(VOCAB_DB_KEY) || '[]');
        let wordFound = false;
        
        // Deep search
        items.forEach(i => {
            if (!i.isFolder && i.eng && sanitizeText(i.eng).toLowerCase() === checkEng) wordFound = true;
            if (i.isFolder && i.items) {
                i.items.forEach(sub => { if (sub.eng && sanitizeText(sub.eng).toLowerCase() === checkEng) wordFound = true; });
            }
        });

        const folderName = "Editor Session"; 
        let isSaving = false;

        if (!wordFound) {
            isSaving = true;
            const newItem = { id: Date.now(), isFolder: false, eng: cleanWord, esp: "", isHighlighted: false, dateAdded: Date.now() };
            let targetFolder = items.find(i => i.isFolder && i.name === folderName);
            if (targetFolder) {
                targetFolder.items.unshift(newItem);
                items = items.filter(i => i.id !== targetFolder.id); items.unshift(targetFolder);
            } else {
                const newFolder = { id: Date.now() + 1, isFolder: true, name: folderName, items: [newItem] };
                items.unshift(newFolder);
            }
        } else {
            items.forEach(folder => {
                if (folder.isFolder && folder.items) { folder.items = folder.items.filter(item => sanitizeText(item.eng).toLowerCase() !== checkEng); }
            });
            items = items.filter(i => i.isFolder || (i.eng && sanitizeText(i.eng).toLowerCase() !== checkEng));
            isSaving = false;
        }

        localStorage.setItem(VOCAB_DB_KEY, JSON.stringify(items));
        
        // 4. Update Visuals
        editorArea.querySelectorAll('.interactive-word').forEach(span => {
            if (sanitizeText(span.innerText).toLowerCase() === checkEng) {
                if (isSaving) span.classList.add('word-added');
                else span.classList.remove('word-added');
            }
        });
        
        // 5. Update Stats
        updateUnifiedPill(null); // Keep translation open, update numbers
        window.saveNote(); 
    };

    /* ====== HELPER FUNCTIONS ====== */
    function sanitizeText(text) {
        if (!text) return "";
        text = text.replace(/['`‚Äò¬¥]/g, "‚Äô");
        text = text.replace(/[^a-zA-Z0-9\u00C0-\u017F\s‚Äô]/g, "");
        return text.trim();
    }

    function getDbWordsSet() {
        const raw = localStorage.getItem(VOCAB_DB_KEY);
        if(!raw) return new Set();
        const data = JSON.parse(raw);
        const set = new Set();
        const extract = (list) => {
            list.forEach(item => {
                if(item.isFolder) extract(item.items);
                else if(item.eng) set.add(sanitizeText(item.eng).toLowerCase());
            });
        };
        extract(data);
        return set;
    }

    function getDbWords(mode, count) {
        const raw = localStorage.getItem(VOCAB_DB_KEY);
        if(!raw) return [];
        const data = JSON.parse(raw);
        let allWords = [];
        const extract = (list) => {
            list.forEach(item => {
                if(item.isFolder) extract(item.items);
                else if(item.eng) allWords.push(item.eng);
            });
        };
        extract(data);
        if(mode === 'last') return allWords.slice(0, count);
        if(mode === 'random') return allWords.sort(() => 0.5 - Math.random()).slice(0, count);
        return [];
    }

    /* ====== CUSTOM DROPDOWN LOGIC ====== */
    function initCustomDropdowns() {
        const selects = document.querySelectorAll('.ai-select');
        selects.forEach(select => {
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-select-wrapper';
            select.parentNode.insertBefore(wrapper, select);
            wrapper.appendChild(select); 

            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';
            const selectedOpt = select.options[select.selectedIndex];
            trigger.innerHTML = `<span>${selectedOpt.text}</span><span class="custom-arrow">‚ñº</span>`;
            wrapper.appendChild(trigger);

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'custom-options';
            wrapper.appendChild(optionsContainer);

            Array.from(select.children).forEach(child => {
                if(child.tagName === 'OPTGROUP') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'custom-group-header';
                    groupHeader.innerText = child.label;
                    optionsContainer.appendChild(groupHeader);
                    
                    Array.from(child.children).forEach(opt => {
                        createCustomOption(opt, optionsContainer, trigger, select, wrapper);
                    });
                } else if (child.tagName === 'OPTION') {
                    createCustomOption(child, optionsContainer, trigger, select, wrapper);
                }
            });

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                    if(w !== wrapper) w.classList.remove('open');
                });
                wrapper.classList.toggle('open');
            });
        });

        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
        });
    }

    function createCustomOption(optElement, container, trigger, select, wrapper) {
        if(optElement.disabled) return; 

        const div = document.createElement('div');
        div.className = 'custom-option';
        if(optElement.selected) div.classList.add('selected');
        div.innerText = optElement.text;
        
        div.addEventListener('click', (e) => {
            e.stopPropagation();
            select.value = optElement.value;
            trigger.querySelector('span').innerText = optElement.text;
            container.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
            div.classList.add('selected');
            wrapper.classList.remove('open');
            const event = new Event('change');
            select.dispatchEvent(event);
        });

        container.appendChild(div);
    }

    function checkCustomOverride(inputId, selectId) { 
        const inputVal = document.getElementById(inputId).value.trim(); 
        const selectEl = document.getElementById(selectId);
        const wrapper = selectEl.closest('.custom-select-wrapper');
        const trigger = wrapper.querySelector('.custom-select-trigger');

        if(inputVal.length > 0) { 
            trigger.classList.add('override-warning'); 
        } else { 
            trigger.classList.remove('override-warning'); 
        } 
    }

    /* ====== EDITOR LOGIC ====== */
    function loadEditorContent() {
        const saved = localStorage.getItem(EDITOR_KEY);
        if(saved) {
            editorArea.innerHTML = saved;
            setTimeout(refreshActiveView, 100);
        }
    }

    window.saveNote = function() {
        const selects = editorArea.querySelectorAll('select'); 
        selects.forEach(s => { 
            const val = s.value; 
            const opts = s.querySelectorAll('option'); 
            opts.forEach(o => { 
                if (o.value === val) o.setAttribute('selected', 'true'); else o.removeAttribute('selected'); 
            }); 
        }); 
        localStorage.setItem(EDITOR_KEY, editorArea.innerHTML);
        
        const ind = document.getElementById('save-status');
        ind.innerText = "‚úì Saved";
        ind.classList.add('saved');
        setTimeout(() => { ind.innerText = "‚úì Ready"; ind.classList.remove('saved'); }, 1500);
    }

    function applyColor(hex) { document.execCommand('foreColor', false, hex); updateToolbarState(); }
    function toggleBold() { document.execCommand('bold'); updateToolbarState(); }
    function setSize(size) { document.execCommand('fontSize', false, size); updateToolbarState(); }
    function setFont(fontName) { document.execCommand('fontName', false, fontName); updateToolbarState(); }

    editorArea.addEventListener('keyup', updateToolbarState); 
    editorArea.addEventListener('mouseup', updateToolbarState); 
    editorArea.addEventListener('click', updateToolbarState); 
    editorArea.addEventListener('input', window.saveNote);
    
    function updateToolbarState() { 
        const isBold = document.queryCommandState('bold'); 
        document.getElementById('btn-bold').classList.toggle('active', isBold); 
        
        const size = document.queryCommandValue('fontSize'); 
        document.getElementById('btn-size-lg').classList.toggle('active', size === '5' || size === 'x-large'); 
        document.getElementById('btn-size-norm').classList.toggle('active', size !== '5' && size !== 'x-large'); 
        
        const rgb = document.queryCommandValue('foreColor'); 
        document.querySelectorAll('.color-circle').forEach(b => b.classList.remove('active')); 
        if(rgb) {
            if(rgb.includes('255, 59, 48')) document.querySelectorAll('.color-circle')[1].classList.add('active'); 
            else if (rgb.includes('0, 122, 255')) document.querySelectorAll('.color-circle')[2].classList.add('active'); 
            else if (rgb.includes('52, 199, 89')) document.querySelectorAll('.color-circle')[3].classList.add('active'); 
            else document.querySelectorAll('.color-circle')[0].classList.add('active'); 
        }

        const font = document.queryCommandValue('fontName');
        document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
        if(font) {
            if(font.includes('Inter')) document.querySelectorAll('.font-btn')[0].classList.add('active');
            else if(font.includes('Playfair')) document.querySelectorAll('.font-btn')[1].classList.add('active');
            else if(font.includes('Courier')) document.querySelectorAll('.font-btn')[2].classList.add('active');
        }
    }

    /* ====== AI HUB LOGIC ====== */
    function openAIMenu() { aiModal.classList.add('active'); renderAiList(); }
    function closeAIMenu() { aiModal.classList.remove('active'); }
    function selectTarget(el, lang) { document.querySelectorAll('#target-lang-group .flag-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentTargetLang = lang; updateTransFlagsVisibility(); }
    function selectLevel(el, levelDesc) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentLevel = levelDesc; }
    function updateTransFlagsVisibility() { document.querySelectorAll('#trans-lang-group .flag-btn').forEach(btn => { const btnLang = btn.getAttribute('data-lang'); if (btnLang === currentTargetLang) { btn.classList.add('hidden'); btn.classList.remove('selected'); transLangs.delete(btnLang); } else { btn.classList.remove('hidden'); } }); }
    function toggleTrans(el, lang) { if (transLangs.has(lang)) { transLangs.delete(lang); el.classList.remove('selected'); } else { if (transLangs.size >= 3) return alert("Max 3 translation languages."); transLangs.add(lang); el.classList.add('selected'); } }
    function escapeHtml(text) { if (!text) return ""; return text.replace(/'/g, "\\'").replace(/"/g, "&quot;"); }

    function exportMemoryBank() { const data = localStorage.getItem(AI_MEM_KEY); if(!data || data === '[]') return alert("Memory is empty."); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'polyglot_memory_full.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function importMemoryBank(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if(!Array.isArray(importedData)) throw new Error("Invalid format"); const current = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const combined = [...importedData, ...current]; localStorage.setItem(AI_MEM_KEY, JSON.stringify(combined)); renderAiList(); alert("Import Successful!"); } catch(err) { alert("Error importing: " + err.message); } }; reader.readAsText(file); }
    function renameMemoryItem(id) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const idx = memory.findIndex(i => i.id === id); if(idx > -1) { const newTitle = prompt("New Title:", memory[idx].title); if(newTitle) { memory[idx].title = newTitle; localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } } }
    function exportSingleItem(id) { const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const item = memory.find(x => x.id === id); if(!item) return; const data = JSON.stringify([item], null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const safeName = (item.title || 'exercise').replace(/[^a-z0-9]/gi, '_').toLowerCase(); a.download = `${safeName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function deleteMemoryItem(id) { if(confirm("Delete?")) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory = memory.filter(item => item.id !== id); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } }
    function clearAIMemory() { if(confirm("Clear all?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }
    
    function renderAiList() { 
        const listContainer = document.getElementById('ai-memory-list'); 
        const previewContainer = document.getElementById('ai-latest-preview');
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); 
        
        previewContainer.innerHTML = '';
        listContainer.innerHTML = '';

        if (memory.length === 0) { 
            listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>'; 
            return; 
        } 

        const createItemHtml = (item, index, isPreview = false) => {
            let flag = "üá¨üáß"; if(item.lang === 'es') flag = "üá™üá∏"; if(item.lang === 'pt') flag = "üáßüá∑"; if(item.lang === 'it') flag = "üáÆüáπ"; 
            let newBadge = (index === 0 && !isPreview) ? '<span class="badge-new">NEW</span>' : ''; 
            let typeBadge = item.isHtml ? '<span class="badge-tpl">TEMPLATE</span>' : `‚Ä¢ ${item.data.length} Qs`; 
            let boxClass = isPreview ? 'saved-item ai-preview-box' : 'saved-item';
            let titlePrefix = isPreview ? 'üÜï LATEST CREATED: ' : '';

            return `<div class="${boxClass}" style="${isPreview ? 'background:#f0fff4; border-bottom:none;' : ''}">
                <div class="saved-info">
                    <span class="saved-name">${flag} ${titlePrefix}${item.title} ${newBadge}</span>
                    <span class="saved-date">${item.date} ${typeBadge}</span>
                </div>
                <div class="mem-actions">
                    <button class="btn-insert" onclick="insertExerciseFromMem(${item.id})">Insert</button>
                    <button class="btn-icon-action btn-export-item" onclick="exportSingleItem(${item.id})" title="Export JSON">‚¨áÔ∏è</button>
                    <button class="btn-icon-action btn-rename" onclick="renameMemoryItem(${item.id})" title="Rename">‚úèÔ∏è</button>
                    <button class="btn-icon-action btn-delete-item" onclick="deleteMemoryItem(${item.id})" title="Delete">√ó</button>
                </div>
            </div>`; 
        };

        if(memory.length > 0) { previewContainer.innerHTML = createItemHtml(memory[0], 0, true); }
        let listHtml = '';
        memory.forEach((item, index) => { listHtml += createItemHtml(item, index, false); }); 
        listContainer.innerHTML = listHtml; 
    }
    
    function copyProfessorPrompt() {
        const ctxSel = document.getElementById('ai-context-select').value;
        const graSel = document.getElementById('ai-grammar-select').value;
        const typSel = document.getElementById('ai-type-select').value;
        const gapCount = document.getElementById('ai-gap-count').value;
        
        let finalOptionCount = document.getElementById('ai-option-count').value;
        const fullTypeCheck = (typSel || "").toLowerCase();
        if (fullTypeCheck.includes("true") || fullTypeCheck.includes("reading")) {
            finalOptionCount = 2;
        }

        const ctxCust = document.getElementById('ai-context-custom').value.trim();
        const graCust = document.getElementById('ai-grammar-custom').value.trim();
        const typCust = document.getElementById('ai-type-custom').value.trim();
        const extraData = document.getElementById('ai-extra-data').value.trim();
        const quantity = document.getElementById('ai-sentence-count').value || 6;
        const currentTarget = LANG_NAMES[currentTargetLang]; 

        let contextInstruction = ctxCust ? `Custom Topic: "${ctxCust}"` : (ctxSel ? `Topic: "${ctxSel}"` : "General Daily Life");
        
        let dbWords = [];
        if (ctxSel && ctxSel.startsWith('vb_')) {
            let mode = ctxSel.replace('vb_', '');
            dbWords = getDbWords(mode === 'random' ? 'random' : 'last', mode === 'random' ? 15 : parseInt(mode.split('_')[1] || 10));
        }

        let vocabBlock = "";
        if (dbWords.length > 0) {
            vocabBlock = `
            VOCABULARY INJECTION:
            List: [${dbWords.join(', ')}].
            CRITICAL RULE: Incorporate specific vocabulary naturally. 
            - Do NOT force all words. Use only 1 or 2 distinct words from this list per sentence maximum.
            - If a word doesn't fit the grammar topic perfectly, ignore it. Grammar accuracy is priority #1.`;
        }

        const fullType = (typSel + " " + typCust).toLowerCase();

        let isReordering = fullType.includes("reordering");
        let isTranslation = fullType.includes("translation") || fullType.includes("reverse");
        let isFix = fullType.includes("fix") || fullType.includes("mistake");
        let isOddOneOut = fullType.includes("odd");
        let isVocabMatch = fullType.includes("matching");
        let isTrueFalse = fullType.includes("true");

        let gapRule = '3. GAPS: Format is "{correct|distractor1|distractor2}". The correct answer must ALWAYS be the first option inside the brackets.';
        let distractorRule = "4. DISTRACTORS: Must be grammatically plausible but incorrect. NEVER use synonyms of the correct answer as distractors.";
        let sentenceRule = "5. FULL_SENTENCE: Must be the grammatically perfect, corrected version of the sentence (used for Text-to-Speech audio).";
        let visualRules = "VISUALS: Clean text. No markdown in the content strings.";
        
        let clozeExample = '"She {went|goes} to school."'; 

        if (isFix) {
             visualRules = "CRITICAL VISUAL RULE: Place the `<s>crossed out mistake</s>` html tags IMMEDIATELY BEFORE the opening `{` bracket. Do NOT put the `<s>` tags inside the `{...}` gap structure.";
             distractorRule = "4. DISTRACTORS: Options should be corrections of the mistake.";
             clozeExample = '"He <s>goed</s> {went|gone} to school."';
        }

        if (isReordering) {
            gapRule = '3. GAPS: For "Sentence Reordering", hide a CRITICAL SEGMENT (3-5 words) where word order is tricky.';
            distractorRule = '4. DISTRACTORS: Must be the SAME words as the answer but scrambled (incorrect order).';
        }
        
        if (isTranslation) {
             gapRule = '3. GAPS: The `cloze_text` must show the SOURCE language sentence (wrapped in <b> tags), a <br>, then the gap with Target language options.';
             distractorRule = '4. DISTRACTORS: False friends or literal incorrect translations.';
             clozeExample = '"<b>Hola mundo</b><br>{Hello world|Hi earth}"';
        }

        if (isOddOneOut) {
             gapRule = '3. GAPS: The gap contains 4 words. The "Correct" one (first pos) is the INTRUDER (the one that does not fit). Format: "{Intruder|Member1|Member2|Member3}".';
             visualRules = "CRITICAL: The sentence prompt (e.g., 'Which is not a fruit?') acts as the header.";
             sentenceRule = "5. FULL_SENTENCE: For Odd One Out, this field should simply read the correct word followed by a short explanation (e.g., 'Car. Because it is not a fruit').";
             clozeExample = '"Which is odd? {Car|Apple|Banana|Grape}"';
        }

        if (isVocabMatch) {
            visualRules = "CRITICAL CONTENT RULE: The sentence MUST be a definition or description. The gap is the word being defined. Example: 'A place where you sleep is a {bedroom|kitchen}'.";
            clozeExample = '"A domestic feline is a {cat|dog|bird}."';
        }

        if (isTrueFalse) {
            gapRule = '3. GAPS: Format is "{True|False}" or "{False|True}". Only 2 options.';
            distractorRule = '4. DISTRACTORS: The opposite of the correct answer.';
            clozeExample = '"The sun is cold. {False|True}"';
        }

        const activeTransLangs = Array.from(transLangs);
        const transTypeDefinition = activeTransLangs.length > 0 
            ? activeTransLangs.map(l => `${l}: string; // Translation in ${LANG_NAMES[l] || l}`).join('\n              ')
            : '// No translations requested';

        const tsInterface = `
        interface PolyglotExercise {
          title: string; // Title in ${currentTarget}
          lang_code: "${currentTargetLang}";
          theory: string; // Brief grammar explanation (HTML allowed: <b>, <ul>).
          exercises: Array<{
            full_sentence: string; 
            cloze_text: string; // Format specific syntax. Example: ${clozeExample}
            hint: string; // CONTEXTUAL RULE: Explain WHY based on keywords.
                          // SAFETY RULE: Use SINGLE QUOTES (') for internal emphasis. NEVER use double quotes inside this string.
                          // BAD: "Look at the word "yesterday"." (This BREAKS JSON)
                          // GOOD: "Look at the word 'yesterday'." (This works perfect)
            translations: {
              ${transTypeDefinition}
            };
          }>;
        }`;

        const promptText = `
        ROLE: Expert ${currentTarget} Linguist & JSON Generator.
        TASK: Generate a strictly valid JSON object.

        SETTINGS:
        - Target Level: ${currentLevel} (Adjust vocabulary difficulty accordingly).
        - Quantity: ${quantity} items.
        - Grammar Focus: ${graCust || graSel || "General Practice"}.
        - ${contextInstruction}
        - Format: ${typCust || typSel || "Cloze"}.
        - Gap Config: ${gapCount} gap(s), ${finalOptionCount} options.
        
        ${vocabBlock}
        ${visualRules}

        STRICT TYPESCRIPT INTERFACE:
        ${tsInterface}

        LOGIC RULES:
        1. OUTPUT ONLY RAW JSON. Do not include markdown \`\`\` tags.
        2. LANGUAGE: Target language is ${currentTarget}.
        ${gapRule}
        ${distractorRule}
        ${sentenceRule}
        6. JSON SAFETY: Use single quotes (') for emphasized words inside strings to avoid escaping issues.

        GENERATE JSON NOW:
        `.trim();

        navigator.clipboard.writeText(promptText).then(() => {
            const btn = document.querySelector('.btn-ai-primary'); 
            const orig = btn.innerText;
            btn.innerText = "‚úÖ Copied!"; 
            setTimeout(() => btn.innerText = orig, 2000);
        }).catch(err => alert("Error copying: " + err));
    }
    
    async function pasteAIJson() {
        let jsonString = "";
        try { jsonString = await navigator.clipboard.readText(); } catch (err) { jsonString = prompt("Paste JSON here:"); }
        if (!jsonString) return;
        
        const btn = document.getElementById('btn-paste-json'); 
        const orig = btn.innerHTML;
        btn.innerHTML = "<span>‚öôÔ∏è</span> Processing...";
        
        setTimeout(() => {
            processJsonAndSave(jsonString);
            btn.innerHTML = orig;
        }, 100);
    }
    
function processJsonAndSave(rawString) {
        try {
            let cleanString = rawString.trim();
            const markdownMatch = cleanString.match(/```(?:json)?([\s\S]*?)```/);
            if (markdownMatch && markdownMatch[1]) {
                cleanString = markdownMatch[1].trim();
            }

            const firstBrace = cleanString.search(/(\{|\[)/);
            const lastBrace = cleanString.lastIndexOf('}');
            const lastBracket = cleanString.lastIndexOf(']');
            const realEnd = Math.max(lastBrace, lastBracket);

            if (firstBrace === -1 || realEnd === -1) {
                throw new Error("No JSON structure found in response.");
            }

            cleanString = cleanString.substring(firstBrace, realEnd + 1);

            cleanString = cleanString
                .replace(/[\u0000-\u001F]+/g, " ") 
                .replace(/[\u201C\u201D\u201E\u201F\u275D\u275E]/g, '"'); 
            
            let aiData = JSON.parse(cleanString);

            let finalData;
            if (Array.isArray(aiData)) {
                finalData = { 
                    title: "AI Exercise Set", 
                    lang_code: currentTargetLang, 
                    theory: "Generated Practice", 
                    exercises: aiData 
                };
            } else {
                finalData = aiData;
            }

            if (!finalData.exercises || !Array.isArray(finalData.exercises)) {
                throw new Error("JSON structure is valid but missing 'exercises' array.");
            }

            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            const newItem = { 
                id: Date.now(), 
                title: finalData.title || "Untitled", 
                lang: finalData.lang_code || currentTargetLang, 
                theory: finalData.theory || "", 
                date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 
                data: finalData.exercises,
                isHtml: false
            };

            memory.unshift(newItem);
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
            
            renderAiList();
            
            const previewBox = document.querySelector('#ai-latest-preview .ai-preview-box');
            if (previewBox) { 
                previewBox.classList.add('highlight'); 
                setTimeout(() => previewBox.classList.remove('highlight'), 2000); 
            }

        } catch (e) {
            console.error(e);
            alert("‚ùå AI Generation Error.\n\n" + e.message);
        }
    }

    // 2. Funci√≥n para procesar texto y volverlo clickable
    function makeInteractable(text, canSave = true) {
        return text.split(' ').map(word => {
            const safeWord = word.replace(/'/g, "\\'"); 
            // HERE: Pass canSave flag
            return `<span class="interactive-word" onclick="window.handleWordClick('${safeWord}', this, ${canSave})">${word}</span>`;
        }).join(' ');
    }

    // 3. Funci√≥n para copiar texto de Teor√≠a o Hints
    window.copyDivText = function(elementId, btnElement) {
        const el = document.getElementById(elementId);
        if (!el) return;
        const textToCopy = el.innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            const original = btnElement.innerHTML;
            btnElement.innerHTML = "‚úì";
            btnElement.classList.add('copied');
            setTimeout(() => {
                btnElement.innerHTML = "üìã";
                btnElement.classList.remove('copied');
            }, 1500);
        });
    };
    
 function insertExerciseFromMem(id) {
        const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        const item = memory.find(x => x.id === id); if (!item) return;
        
        const insertTime = Date.now(); 
        const theoryId = `theory-${id}-${insertTime}`; 
        const targetLang = item.lang || 'en';

        let htmlBlock = `
        <div class="exercise-box" contenteditable="false">
            <div class="exercise-header">
                <span>‚úçÔ∏è ${item.title}</span>
                <div style="display:flex; align-items:center;">
                    <button class="btn-theory" onclick="document.getElementById('${theoryId}').style.display = document.getElementById('${theoryId}').style.display === 'block' ? 'none' : 'block'">üìò Theory</button>
                    <button class="btn-reset-block" contenteditable="false" onclick="window.resetExerciseBlock(this)" title="Reset">‚Ü∫</button>
                    <button class="btn-del-block" contenteditable="false" onclick="if(confirm('Delete block?')) { this.closest('.exercise-box').remove(); window.saveNote(); }" title="Delete">üóëÔ∏è</button>
                </div>
            </div>
            <div class="theory-box" id="${theoryId}">
                <div style="display:flex; justify-content:flex-end; margin-bottom:5px;">
                    <button class="btn-copy-text" onclick="window.copyDivText('${theoryId}-content', this)" title="Copy Theory">üìã</button>
                </div>
                <div id="${theoryId}-content">${makeInteractable(item.theory || "No theory.", true)}</div>
            </div>`;

        item.data.forEach((ex, index) => {
            const uId = `ex-${id}-${index}-${insertTime}`; 
            const hId = `hint-${id}-${index}-${insertTime}`; 
            const tId = `trans-${id}-${index}-${insertTime}`;
            
            let exerciseContent = "";

            if (ex.cloze_text) {
                const parts = ex.cloze_text.split(/(\{.*?\})/g);
                let interactiveHtml = "";
                
                parts.forEach(part => {
                    if (part.startsWith('{') && part.endsWith('}')) {
                        const content = part.slice(1, -1); 
                        const optsArr = content.split('|'); 
                        const correctAns = optsArr[0].trim(); 
                        const shuffled = [...optsArr].sort(() => Math.random() - 0.5);
                        let optsHtml = `<option value="" disabled selected>...</option>`;
                        shuffled.forEach(opt => { optsHtml += `<option value="${escapeHtml(opt.trim())}">${opt.trim()}</option>`; });
                        interactiveHtml += `<span class="cloze-gap-container"><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(correctAns)}')">${optsHtml}</select></span>`;
                    } else {
                        interactiveHtml += makeInteractable(part, true);
                    }
                });
                exerciseContent = `<span><b>${index + 1}.</b> ${interactiveHtml}</span>`;

            } else {
                let optsHtml = `<option value="" disabled selected>...</option>`; 
                const shuffled = [...ex.options].sort(() => Math.random() - 0.5);
                shuffled.forEach(opt => { optsHtml += `<option value="${escapeHtml(opt)}">${opt}</option>`; });
                const preText = makeInteractable(ex.pre || '', true);
                const postText = makeInteractable(ex.post || '', true);
                exerciseContent = `<span><b>${index + 1}.</b> ${preText}</span><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(ex.answer)}')">${optsHtml}</select><span>${postText}</span>`;
            }

            let transContent = "";
            if (ex.translations) {
                for (const [key, val] of Object.entries(ex.translations)) {
                    let f = "üá¨üáß"; if (key === 'es') f = "üá™üá∏"; if (key === 'pt') f = "üáßüá∑"; if (key === 'it') f = "üáÆüáπ";
                    // TRANSLATIONS: canSave = false
                    transContent += `<div class="trans-line"><button class="btn-mini-speak" contenteditable="false" onclick="window.speakText('${escapeHtml(val)}', '${key}')">üîä</button><span>${f} ${makeInteractable(val, false)}</span></div>`;
                }
            } else { transContent = "No translation"; }

            htmlBlock += `
            <div class="exercise-row" id="${uId}">
                ${exerciseContent}
                <div style="display:inline-flex; gap:5px; margin-left:10px;">
                    <button class="ex-btn-icon" contenteditable="false" onclick="window.speakText('${escapeHtml(ex.full_sentence)}', '${targetLang}')">üîä</button>
                    <button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${tId}').style.display = document.getElementById('${tId}').style.display === 'block' ? 'none' : 'block'">üåê</button>
                    <button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${hId}').style.display = document.getElementById('${hId}').style.display === 'block' ? 'none' : 'block'">‚ùì</button>
                </div>
                
                <div class="hint-box" id="${hId}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>üí° Tip</span>
                        <button class="btn-copy-text" onclick="window.copyDivText('${hId}-txt', this)" title="Copy Hint">üìã</button>
                    </div>
                    <div id="${hId}-txt">${makeInteractable(ex.hint, true)}</div>
                </div>
                
                <div class="trans-box" id="${tId}">${transContent}</div>
            </div>`;
        });
        
        htmlBlock += '</div><p><br></p>';
        editorArea.insertAdjacentHTML('beforeend', htmlBlock);
        // Force refresh
        setTimeout(() => { 
            refreshActiveView();
            editorArea.scrollTop = editorArea.scrollHeight; 
            window.saveNote(); 
        }, 100);
        closeAIMenu();
    }
    
    window.validateExercise = function(s, a) {
        s.classList.remove('correct', 'wrong');
        if (s.value.trim().toLowerCase() === a.trim().toLowerCase()) { s.classList.add('correct'); } else { s.classList.add('wrong'); if (navigator.vibrate) navigator.vibrate(200); }
        window.saveNote();
    };
    
    window.speakText = function(text, langCode) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text);
            const m = { 'en': 'en-US', 'es': 'es-ES', 'pt': 'pt-BR', 'it': 'it-IT' };
            u.lang = m[langCode] || 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u);
        } else { alert("TTS not supported."); }
    };
    window.resetExerciseBlock = function(btn) { const box = btn.closest('.exercise-box'); if(box) { const selects = box.querySelectorAll('select'); selects.forEach(s => { s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); s.selectedIndex = 0; }); window.saveNote(); } };
// === COMUNICACI√ìN CON NEXUS (C√ìDIGO 1) ===
window.addEventListener('message', function(event) {
    if (event.data === 'FORCE_PAUSE') {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }
    }
});

</script>

    <script>
(function() {
    const VOCAB_KEY = 'mdc_vocab_list';
    let isTranslating = false; // Bandera para evitar bucles infinitos

    // 1. EL TRUCO MAESTRO: Interceptar el guardado local (Misma pesta√±a)
    const originalSetItem = localStorage.setItem;
    
    localStorage.setItem = function(key, value) {
        // Primero, hacemos el guardado normal
        originalSetItem.apply(this, arguments);
        
        // Luego, si lo que se guard√≥ es nuestra lista, activamos la revisi√≥n
        if (key === VOCAB_KEY && !isTranslating) {
            // Usamos un peque√±o delay para asegurar que el dato ya asent√≥
            setTimeout(checkAndFixTranslations, 100);
        }
    };

    // 2. Escuchar guardados de OTRAS pesta√±as
    window.addEventListener('storage', (e) => {
        if (e.key === VOCAB_KEY && !isTranslating) {
            checkAndFixTranslations();
        }
    });

    // 3. Revisar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', checkAndFixTranslations);

    // --- L√ìGICA DE TRADUCCI√ìN ---
    async function checkAndFixTranslations() {
        if (isTranslating) return; // Si ya estoy trabajando, no me interrumpas
        
        const raw = localStorage.getItem(VOCAB_KEY);
        if (!raw) return;

        let items;
        try { items = JSON.parse(raw); } catch(e) { return; }
        
        let updated = false;

        // Funci√≥n auxiliar: conecta con Google
        const translate = async (text) => {
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=es&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                return (data && data[0]) ? data[0].map(s => s[0]).join('') : null;
            } catch (e) { return null; }
        };

        // Escaneo recursivo
        const scanItems = async (list) => {
            for (let item of list) {
                if (item.isFolder) {
                    await scanItems(item.items);
                } else {
                    // CONDICI√ìN: Hay ingl√©s PERO el espa√±ol est√° vac√≠o o no existe
                    if (item.eng && (!item.esp || item.esp.trim() === "")) {
                        isTranslating = true; // Bloqueamos para que nadie moleste
                        const translation = await translate(item.eng);
                        if (translation) {
                            item.esp = translation.replace(/['`‚Äò¬¥]/g, "‚Äô").replace(/[^a-zA-Z0-9\u00C0-\u017F\s‚Äô]/g, "");
                            updated = true;
                        }
                    }
                }
            }
        };

        await scanItems(items);

        if (updated) {
            console.log("ü§ñ MDC Translator: Nuevas palabras detectadas y traducidas.");
            
            // Guardamos usando la funci√≥n ORIGINAL para evitar un bucle infinito
            originalSetItem.call(localStorage, VOCAB_KEY, JSON.stringify(items));
            
            // Notificamos a la p√°gina actual para que se refresque visualmente
            refreshCurrentPage(items);
        }
        
        isTranslating = false; // Liberamos la bandera
    }

    // Funci√≥n para actualizar la interfaz visual sin recargar la p√°gina
    function refreshCurrentPage(items) {
        // Intenta actualizar el reproductor
        if (typeof updateAllWordStates === 'function') updateAllWordStates();
        
        // Intenta actualizar la lista de vocabulario
        if (typeof loadVocab === 'function') loadVocab();
        else if (typeof renderList === 'function') renderList(items);
    }

})();
</script>
</body>
</html>
