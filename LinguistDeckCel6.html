<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>Polyglot Tutor V33 - Fixed Logic</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Dancing+Script:wght=700&family=Playfair+Display:wght=600&family=Courier+Prime:wght=700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary: #007AFF;
Â  Â  Â  Â  Â  Â  --success: #34C759;
Â  Â  Â  Â  Â  Â  --warning: #FF9500;
Â  Â  Â  Â  Â  Â  --danger: #FF3B30;
Â  Â  Â  Â  Â  Â  --bg-body: #FFFFFF;
Â  Â  Â  Â  Â  Â  --text-main: #111111;
Â  Â  Â  Â  Â  Â  --toolbar-bg: rgba(140, 148, 127, 0.95);
Â  Â  Â  Â  Â  Â  --dropdown-bg: rgba(255, 255, 255, 0.98);
Â  Â  Â  Â  Â  Â  --saved-word: #ff69b4;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  background: var(--bg-body);
Â  Â  Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  color: var(--text-main);
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ====== APP LAYOUT ====== */
Â  Â  Â  Â  .main-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  background: #292929;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sticky-top-wrapper {
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  background: var(--toolbar-bg);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #e5e5ea;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 20px rgba(0,0,0,0.03);
Â  Â  Â  Â  }

Â  Â  Â  Â  .editor-header {
Â  Â  Â  Â  Â  Â  padding: 12px 20px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  height: 50px;
Â  Â  Â  Â  Â  Â  max-width: 1000px;Â 
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }
Â  Â  Â  Â  .editor-title { font-weight: 800; font-size: 1.1rem; color: #111; display:flex; gap:10px; align-items:center; letter-spacing: -0.3px;}
Â  Â  Â  Â  .save-indicator { font-size: 0.75rem; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: color 0.3s; }
Â  Â  Â  Â  .save-indicator.saved { color: var(--success); }

Â  Â  Â  Â  .editor-toolbar {Â 
Â  Â  Â  Â  Â  Â  width: 100%; padding: 10px 20px;Â 
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 15px; overflow-x: auto; scrollbar-width: none;
Â  Â  Â  Â  Â  Â  max-width: 1000px; margin: 0 auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .delicate-group {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 8px;Â 
Â  Â  Â  Â  Â  Â  background: #f7f7f9; border: 1px solid #e5e5ea;Â 
Â  Â  Â  Â  Â  Â  border-radius: 20px; padding: 4px 10px;
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .delicate-sep { width: 1px; height: 18px; background: #d1d1d6; margin: 0 4px; }
Â  Â  Â  Â  .color-circle { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
Â  Â  Â  Â  .color-circle:hover { transform: scale(1.2); }
Â  Â  Â  Â  .color-circle.active { border-color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: scale(1.1); }
Â  Â  Â  Â  .font-btn { background: none; border: none; font-size: 0.9rem; font-weight: 600; color: #888; cursor: pointer; padding: 2px 6px; border-radius: 6px; transition: all 0.2s; }
Â  Â  Â  Â  .font-btn:hover { color: #000; background: #e5e5ea; }
Â  Â  Â  Â  .font-btn.active { color: #007aff; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .style-icon { background: none; border: none; font-size: 0.85rem; font-weight: 700; color: #666; cursor: pointer; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
Â  Â  Â  Â  .style-icon:hover { background: #e5e5ea; color: #000; }
Â  Â  Â  Â  .style-icon.active { background: #000; color: #fff; }
Â  Â  Â  Â  .toolbar-group { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-ai-trigger { background: linear-gradient(135deg, #e3f2fd, #90caf9); color: #007AFF; border: 1px solid #bbdefb; padding: 0 16px; height: 36px; border-radius: 10px; cursor: pointer; font-weight: 800; display:flex; align-items:center; justify-content:center; gap:6px; font-size: 0.9rem; transition: transform 0.2s; }
Â  Â  Â  Â  .btn-ai-trigger:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,122,255,0.2); }
Â  Â  Â  Â  .btn-clear { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e5ea; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0;}
Â  Â  Â  Â  .btn-clear svg { width: 18px; height: 18px; fill: #888; }
Â  Â  Â  Â  .editor-area { flex: 1; width: 100%; max-width: 900px; margin: 0 auto; padding: 40px 20px 100px 20px; border: none; font-family: 'Inter', sans-serif; font-size: 19px; line-height: 1.8; outline: none; color: #111; background: transparent; overflow-y: auto; }

Â  Â  Â  Â  /* ====== AI HUB ====== */
Â  Â  Â  Â  .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 3000; display: none; flex-direction: column; }
Â  Â  Â  Â  .ai-popup-overlay.active { display: flex; }
Â  Â  Â  Â  .ai-popup-box { background: #fff; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; border: none; border-radius: 0; box-shadow: none; }
Â  Â  Â  Â  .ai-header { background: rgba(255,255,255,0.98); border-bottom: 1px solid #eee; color: #111; padding: 15px 20px; font-weight: 800; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; }
Â  Â  Â  Â  .ai-close { background: #f2f2f7; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; transition: background 0.2s; font-size: 1.5rem;}
Â  Â  Â  Â  .ai-close:hover { background: #e5e5ea; color: #000; }
Â  Â  Â  Â  .ai-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; flex:1; background: #fff; width: 100%; max-width: 900px; margin: 0 auto; padding-bottom: 80px; }

Â  Â  Â  Â  /* ====== CARDS & INPUTS ====== */
Â  Â  Â  Â  .ai-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
Â  Â  Â  Â  @media(max-width: 600px) { .ai-grid-2 { grid-template-columns: 1fr; } }
Â  Â  Â  Â  .ai-card-group { background: #F9F9FB; border-radius: 16px; padding: 6px; border: 1px solid #e5e5ea; display: flex; flex-direction: column; transition: border-color 0.2s; position: relative; }
Â  Â  Â  Â  .ai-card-group:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
Â  Â  Â  Â  .ai-card-label { font-size: 0.75rem; font-weight: 800; color: #888; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px 4px 12px; display: flex; align-items: center; gap: 6px; }

Â  Â  Â  Â  /* ====== CUSTOM DROPDOWN SYSTEM ====== */
Â  Â  Â  Â  .ai-select { display: none; }Â 
Â  Â  Â  Â  .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
Â  Â  Â  Â  .custom-select-trigger { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 12px; font-size: 0.95rem; font-weight: 600; color: #111; cursor: pointer; background: transparent; transition: all 0.2s; border-radius: 12px; }
Â  Â  Â  Â  .custom-select-trigger:hover { background: rgba(0,0,0,0.03); }
Â  Â  Â  Â  .custom-arrow { font-size: 0.8rem; color: #999; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); margin-left: 10px; }
Â  Â  Â  Â  .custom-select-wrapper.open .custom-arrow { transform: rotate(180deg); color: var(--primary); }
Â  Â  Â  Â  .custom-options { position: absolute; top: 110%; left: 0; right: 0; background: var(--dropdown-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.15); border-radius: 16px; z-index: 2000; opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-10px) scale(0.98); transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1); max-height: 300px; overflow-y: auto; padding: 8px; }
Â  Â  Â  Â  .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0) scale(1); }
Â  Â  Â  Â  .custom-option { padding: 10px 12px; font-size: 0.9rem; color: #333; cursor: pointer; border-radius: 8px; transition: all 0.1s; display: flex; align-items: center; justify-content: space-between; }
Â  Â  Â  Â  .custom-option:hover { background: var(--primary); color: white; }
Â  Â  Â  Â  .custom-option.selected { background: #f2f2f7; color: #000; font-weight: 700; }
Â  Â  Â  Â  .custom-option.selected:after { content: 'âœ“'; color: var(--primary); font-weight: 800; }
Â  Â  Â  Â  .custom-option:hover.selected { background: var(--primary); color: white; }
Â  Â  Â  Â  .custom-option:hover.selected:after { color: white; }
Â  Â  Â  Â  .custom-group-header { padding: 12px 12px 6px 12px; font-size: 0.7rem; text-transform: uppercase; color: #999; font-weight: 800; letter-spacing: 0.5px; pointer-events: none; margin-top: 4px; border-top: 1px solid #f2f2f7; }
Â  Â  Â  Â  .custom-group-header:first-child { border-top: none; margin-top: 0; }
Â  Â  Â  Â  .custom-options::-webkit-scrollbar { width: 5px; }
Â  Â  Â  Â  .custom-options::-webkit-scrollbar-track { background: transparent; }
Â  Â  Â  Â  .custom-options::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
Â  Â  Â  Â  .custom-select-trigger.override-warning { color: var(--danger); }
Â  Â  Â  Â  .custom-select-trigger.override-warning:after { content: 'âš ï¸'; font-size: 0.8rem; margin-left: auto; margin-right: 5px;}

Â  Â  Â  Â  /* ====== INPUTS CUSTOM ====== */
Â  Â  Â  Â  .ai-custom-input { width: 100%; padding: 12px; border: none; border-top: 1px solid #e5e5ea; background: #fff; font-size: 0.9rem; color: #333; outline: none; border-radius: 0 0 16px 16px; transition: background 0.2s; }
Â  Â  Â  Â  .ai-custom-input:focus { background: #fff; color: #000; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ====== OTHER CONTROLS ====== */
Â  Â  Â  Â  .segmented-control { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; gap: 2px; }
Â  Â  Â  Â  .level-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; background: transparent; color: #666; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
Â  Â  Â  Â  .level-btn:hover { color: #000; }
Â  Â  Â  Â  .level-btn.selected { background: #fff; color: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
Â  Â  Â  Â  .flag-group { display: flex; gap: 12px; flex-wrap: wrap;}
Â  Â  Â  Â  .flag-btn { border: 2px solid transparent; border-radius: 50%; background: #f2f2f7; font-size: 1.5rem; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; filter: grayscale(100%); transition: all 0.2s; }
Â  Â  Â  Â  .flag-btn:hover { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
Â  Â  Â  Â  .flag-btn.selected { border-color: var(--primary); background: #fff; opacity: 1; filter: grayscale(0%); box-shadow: 0 4px 10px rgba(0,122,255,0.2); }
Â  Â  Â  Â  .flag-btn.hidden { display: none !important; }
Â  Â  Â  Â  .flag-sm { width: 40px; height: 40px; font-size: 1.2rem; }

Â  Â  Â  Â  textarea.ai-custom-input { resize: vertical; min-height: 80px; border-radius: 12px; border: 1px solid #e5e5ea; background: #F9F9FB; margin-top: 0; }
Â  Â  Â  Â  textarea.ai-custom-input:focus { background: #fff; border-color: var(--primary); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .ai-footer-actions { margin: 15px 0; padding: 0; background: transparent; border-top: none; display: flex; gap: 15px; z-index: 5; width: 100%; }
Â  Â  Â  Â  .btn-ai-action { flex: 1; padding: 16px; border: none; border-radius: 14px; font-weight: 800; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); text-transform: uppercase; letter-spacing: 0.5px; border: 2px solid #fff; }
Â  Â  Â  Â  .btn-ai-primary { background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%); color: #445; box-shadow: 0 8px 20px rgba(142, 197, 252, 0.25); }
Â  Â  Â  Â  .btn-ai-primary:hover { transform: translateY(-2px); background: linear-gradient(135deg, #d3b0f5 0%, #7eb8f2 100%); box-shadow: 0 12px 25px rgba(142, 197, 252, 0.4); color: #223; }
Â  Â  Â  Â  #btn-paste-json { background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%); color: #445; box-shadow: 0 8px 20px rgba(250, 208, 196, 0.25); }
Â  Â  Â  Â  #btn-paste-json:hover { transform: translateY(-2px); background: linear-gradient(135deg, #f5c0b0 0%, #f5c0f5 100%); box-shadow: 0 12px 25px rgba(250, 208, 196, 0.4); color: #223; }

Â  Â  Â  Â  .ai-preview-box { margin-bottom: 20px; border: 2px solid var(--success); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1); }
Â  Â  Â  Â  .ai-preview-box.highlight { animation: highlightPulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) 3; }
Â  Â  Â  Â  @keyframes highlightPulse { 0%, 100% { border-color: var(--success); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1); } 50% { border-color: var(--warning); box-shadow: 0 0 20px rgba(255, 149, 0, 0.5); } }

Â  Â  Â  Â  .saved-exercises-list { max-height: 300px; overflow-y: auto; border: 1px solid #e5e5ea; border-radius: 12px; margin-bottom: 10px; }
Â  Â  Â  Â  .saved-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
Â  Â  Â  Â  .saved-item:nth-child(odd) { background: #fff; }
Â  Â  Â  Â  .saved-item:nth-child(even) { background: #f4f4f7; }
Â  Â  Â  Â  .saved-item:last-child { border-bottom: none; }
Â  Â  Â  Â  .saved-info { flex: 1; }
Â  Â  Â  Â  .saved-name { font-weight: 600; font-size: 0.9rem; color: #111; }
Â  Â  Â  Â  .saved-date { font-size: 0.7rem; color: #888; }
Â  Â  Â  Â  .badge-new { background: var(--success); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
Â  Â  Â  Â  .badge-tpl { background: var(--warning); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
Â  Â  Â  Â  .mem-actions { display: flex; gap: 6px; }
Â  Â  Â  Â  .btn-icon-action { width: 30px; height: 30px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); color: #555; transition: all 0.2s;}
Â  Â  Â  Â  .btn-icon-action:hover { background: #000; color: #fff; }
Â  Â  Â  Â  .btn-insert { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
Â  Â  Â  Â  .btn-delete-item:hover { background: #d00 !important; color: #fff !important; }
Â  Â  Â  Â  .mem-controls { display: flex; gap: 10px; margin-top: 10px; }
Â  Â  Â  Â  .btn-mem-ctrl { flex: 1; padding: 10px; border: 1px solid #e5e5ea; background: #fff; border-radius: 10px; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
Â  Â  Â  Â  .btn-mem-ctrl:hover { background: #f9f9f9; }

Â  Â  Â  Â  /* ====== EXERCISE RENDER ====== */
Â  Â  Â  Â  .exercise-box { background: #f9f9fb; border: 1px solid #e5e5ea; border-radius: 12px; padding: 25px; margin: 30px 0; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
Â  Â  Â  Â  .exercise-header { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 16px; border-bottom: 1px solid #f2f2f7; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
Â  Â  Â  Â  .exercise-header span { flex: 1; word-wrap: break-word; overflow-wrap: break-word; }
Â  Â  Â  Â  .btn-theory { background: #e3f2fd; color: var(--primary); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
Â  Â  Â  Â  .btn-del-block { background: #fff5f5; color: var(--danger); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 5px; }
Â  Â  Â  Â  .btn-reset-block { background: #fff8e1; color: #d97706; border: none; padding: 6px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: 700; white-space: nowrap; margin-left: 5px; }
Â  Â  Â  Â  .theory-box { display: none; background: #fff; padding: 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; border: 1px solid #e5e5ea;}
Â  Â  Â  Â  .exercise-row { margin-bottom: 16px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; line-height: 1.8; position: relative; }Â 
Â  Â  Â  Â  .hint-box, .trans-box { display: none; width: 100%; margin-top: 8px; padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; }
Â  Â  Â  Â  .hint-box { background: #fffbe6; border-left: 4px solid #f59e0b; color: #78350f; }
Â  Â  Â  Â  .trans-box { background: #f0f9ff; border-left: 4px solid #007AFF; color: #0c4a6e; }
Â  Â  Â  Â  .trans-line { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
Â  Â  Â  Â  .btn-mini-speak { background: #fff; border: 1px solid #d1d1d6; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
Â  Â  Â  Â  .ex-select { padding: 8px 14px; border: 1px solid #d1d1d6; border-radius: 8px; background: white; cursor: pointer; outline: none; font-size: 0.95rem; appearance: none; padding-right: 2.5rem; max-width: 100%; white-space: normal; }
Â  Â  Â  Â  .ex-select.correct { border-color: var(--success) !important; background-color: #e8f5e9 !important; color: #1b5e20 !important; font-weight: 700; }
Â  Â  Â  Â  .ex-select.wrong { border-color: var(--danger) !important; background-color: #ffebee !important; color: #b71c1c !important; animation: shake 0.3s; }
Â  Â  Â  Â  .ex-btn-icon { background: #f2f2f7; border: none; border-radius: 8px; cursor: pointer; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; color: #1d1d1f; }
Â  Â  Â  Â  .ex-btn-icon:hover { background: #e5e5ea; color: var(--primary); }
Â  Â  Â  Â  @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
Â  Â  Â  Â  .exercise-row s { color: var(--danger); text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color: var(--danger); background-color: rgba(255, 59, 48, 0.1); padding: 2px 6px; border-radius: 6px; margin-right: 8px; font-weight: 600; display: inline-block; }
Â  Â  Â  Â  .exercise-row s::before { content: "âœ–"; font-size: 0.7em; margin-right: 4px; vertical-align: text-top; opacity: 0.6; }
Â  Â  Â  Â  .cloze-gap-container { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 4px; }
Â  Â Â 

/* --- NUEVOS ESTILOS PARA INTERACTIVIDAD & PILL --- */
.interactive-word {
Â  Â  cursor: pointer;
Â  Â  border-bottom: 2px solid transparent;
Â  Â  transition: all 0.2s;
Â  Â  display: inline-block;
}
.interactive-word:hover {
Â  Â  background-color: rgba(0, 122, 255, 0.1);
Â  Â  color: var(--primary);
}
.interactive-word.word-added {
Â  Â  color: var(--saved-word) !important;
Â  Â  font-weight: 700 !important;
Â  Â  border-bottom-color: var(--saved-word) !important;
}

/* BotÃ³n de copiar pequeÃ±o */
.btn-copy-text {
Â  Â  background: transparent;
Â  Â  border: 1px solid #d1d1d6;
Â  Â  color: #666;
Â  Â  border-radius: 6px;
Â  Â  width: 24px;
Â  Â  height: 24px;
Â  Â  font-size: 0.8rem;
Â  Â  cursor: pointer;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  transition: all 0.2s;
Â  Â  margin-left: auto;
}
.btn-copy-text:hover { background: #e5e5ea; color: #000; }
.btn-copy-text.copied { border-color: var(--success); color: var(--success); }

/* === UNIFIED PILL (Igual que en Generator) === */
#unified-pill {
Â  Â  position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(150%);
Â  Â  background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(12px);
Â  Â  border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px;
Â  Â  padding: 8px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
Â  Â  display: flex; align-items: center; gap: 15px;Â 
Â  Â  z-index: 5000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  max-width: 95%; white-space: nowrap; pointer-events: none; opacity: 0;
}
#unified-pill.visible { transform: translateX(-50%) translateY(0); pointer-events: auto; opacity: 1; }

.pill-section { display: flex; align-items: center; gap: 8px; }
.pill-icon { font-size: 1.1em; }

/* Stats Section */
#pill-stats-text {
Â  Â  font-family: 'Roboto Mono', monospace; font-weight: 800; font-size: 1em;Â 
Â  Â  color: #e5e7eb; letter-spacing: 1px;
}
.stats-active { color: var(--saved-word) !important; }

/* Divider */
.pill-divider { width: 1px; height: 16px; background: rgba(255,255,255,0.2); }

/* Translate Section */
#pill-trans { display: none; }
#pill-trans.active { display: flex; }
.trans-origin { color: #aaa; font-style: italic; font-size: 0.9em; }
.trans-arrow { color: #666; font-size: 0.8em; margin: 0 4px; }
.trans-result { color: #fff; font-weight: 700; font-size: 0.95em; }

</style>
</head>
<body>

Â  Â  <div id="unified-pill">
Â  Â  Â  Â  <div class="pill-section">
Â  Â  Â  Â  Â  Â  <span class="pill-icon">ğŸ“Š</span>
Â  Â  Â  Â  Â  Â  <span id="pill-stats-text">- | 0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="pill-divider" class="pill-divider" style="display:none;"></div>

Â  Â  Â  Â  <div id="pill-trans" class="pill-section">
Â  Â  Â  Â  Â  Â  <span id="trans-origin" class="trans-origin">...</span>
Â  Â  Â  Â  Â  Â  <span class="trans-arrow">â†’</span>
Â  Â  Â  Â  Â  Â  <span id="trans-result" class="trans-result">...</span>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="main-container">
Â  Â  Â  Â  <div class="sticky-top-wrapper">
Â  Â  Â  Â  Â  Â  <div class="editor-header">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="editor-title">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ“˜ Polyglot Editor</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="save-indicator" id="save-status">âœ“ Ready</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="editor-toolbar">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="delicate-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="color-circle" style="background:#fff; border-color:#ddd;" onmousedown="event.preventDefault(); applyColor('#ffffff')" title="White"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="color-circle" style="background:#FF3B30" onmousedown="event.preventDefault(); applyColor('#FF3B30')" title="Red"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="color-circle" style="background:#007AFF" onmousedown="event.preventDefault(); applyColor('#007AFF')" title="Blue"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="color-circle" style="background:#34C759" onmousedown="event.preventDefault(); applyColor('#34C759')" title="Green"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="delicate-sep"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="font-btn" style="font-family:'Inter'" onclick="setFont('Inter')" title="Sans Serif">Aa</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="font-btn" style="font-family:'Playfair Display'" onclick="setFont('Playfair Display')" title="Serif">Aa</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="font-btn" style="font-family:'Courier Prime'" onclick="setFont('Courier Prime')" title="Mono">Aa</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="delicate-sep"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="style-icon" id="btn-bold" onmousedown="event.preventDefault(); toggleBold()" title="Bold">B</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="style-icon" id="btn-size-norm" onmousedown="event.preventDefault(); setSize(3)" title="Normal">T</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="style-icon" id="btn-size-lg" onmousedown="event.preventDefault(); setSize(5)" title="Large" style="font-size:1.1rem">T+</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="toolbar-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-ai-trigger" onclick="openAIMenu()" title="AI Exercise Hub">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âš¡ AI Hub</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-clear" onclick="if(confirm('Clear all content?')) { document.getElementById('editor-text').innerHTML=''; saveNote(); }" title="Clear All">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="editor-text" class="editor-area" contenteditable="true" placeholder="Start typing..." oninput="saveNote()"></div>
Â  Â  </div>

Â  Â  <div class="ai-popup-overlay" id="ai-hub-modal">
Â  Â  Â  Â  <div class="ai-popup-box">
Â  Â  Â  Â  Â  Â  <div class="ai-header">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; align-items:center; gap:12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âš¡ Polyglot AI Hub</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="ai-close" onclick="closeAIMenu()">Ã—</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="ai-body">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-grid-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label">ğŸŒ Context</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="ai-context-select" class="ai-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" selected disabled>Select Context...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ“š Vocabulary Builder DB">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="vb_last_5">Last 5 Saved Words</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="vb_last_10">Last 10 Saved Words</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="vb_last_15">Last 15 Saved Words</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="vb_random">Random Selection (15)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ  Daily Life & Lifestyle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Daily Routine & Habits">Daily Routine & Habits</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Family & Relationships">Family & Relationships</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="House & Chores">House, Furniture & Chores</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Food, Cooking & Restaurants">Food, Cooking & Restaurants</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Health, Fitness & Body">Health, Fitness & Doctors</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Hobbies, Music & Movies">Hobbies, Music & Movies</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="âœˆï¸ Travel & Adventure">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="At the Airport & Flying">At the Airport & Flying</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Hotel Check-in & Problems">Hotel Situations</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Asking for Directions & City">City & Directions</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Car Rental & Driving">Car Rental & Driving</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ’¼ Work & Business">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Job Interviews & CVs">Job Interviews & HR</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Business Meetings & Strategy">Meetings & Negotiations</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Emails & Formal Communication">Formal Emails</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Tech, IT & Programming">Tech, IT & Programming</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Marketing & Sales">Marketing & Sales</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Customer Service Scenarios">Customer Service Issues</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="ai-context-custom" class="ai-custom-input" placeholder="Or type custom context..." oninput="checkCustomOverride('ai-context-custom', 'ai-context-select')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label">ğŸ§  Grammar</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="ai-grammar-select" class="ai-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" selected disabled>Select Grammar...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ•’ Present Tenses">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Present Simple">Present Simple (Habits & Facts)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Present Continuous">Present Continuous (Now & Future)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Present Perfect">Present Perfect (Experiences)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Present Perfect Continuous">Present Perfect Continuous</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Present Simple vs Continuous">Mix: Simple vs Continuous</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ”™ Past Tenses">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Past Simple">Past Simple (Finished Actions)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Past Continuous">Past Continuous (Interrupted Actions)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Past Perfect">Past Perfect (The Past before the Past)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Past Perfect Continuous">Past Perfect Continuous</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Narrative Tenses Mix">Mix: Narrative Tenses (Storytelling)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸš€ Future Tenses">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Future Simple (Will)">Future Simple (Will - Spontaneous)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Be Going To">Be Going To (Plans)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Future Continuous">Future Continuous (In progress later)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Future Perfect">Future Perfect (Completed by then)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Future Forms Mix">Mix: Will / Going to / Present Cont.</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="âš™ï¸ Advanced Structures">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Conditionals 0 & 1">Conditionals 0 & 1 (Real)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Conditionals 2 & 3">Conditionals 2 & 3 (Unreal)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Mixed Conditionals">Mixed Conditionals</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Passive Voice">Passive Voice</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Reported Speech">Reported Speech (Indirect)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Relative Clauses">Relative Clauses (Who, Which, That)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Causative (Have/Get something done)">Causative Form</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ§© Particles & Modals">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Modal Verbs (Can, Could, Should, Must)">Modal Verbs</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Modals of Deduction (Must have, Can't have)">Modals of Past Deduction</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Phrasal Verbs">Phrasal Verbs (General)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Prepositions of Place & Time">Prepositions (In, On, At, By)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Articles (A, An, The, Zero)">Articles (A / An / The)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Gerunds vs Infinitives">Gerunds vs Infinitives</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="ai-grammar-custom" class="ai-custom-input" placeholder="Or type custom grammar..." oninput="checkCustomOverride('ai-grammar-custom', 'ai-grammar-select')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-grid-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label">ğŸ“ Format</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="ai-type-select" class="ai-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" selected disabled>Select Format...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="âœï¸ Standard Practice">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Fill in the Blanks (Cloze)">Fill in the Blanks (Classic)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Multiple Choice Quiz">Multiple Choice Quiz</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Find and Fix the Mistake">Find and Fix the Mistake</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="True or False (Reading)">True or False (Reading Comp.)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ§  Vocabulary & Logic">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Vocabulary Matching">Vocabulary Matching (Def - Word)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Synonym & Antonym Finder">Synonym Finder</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Sentence Reordering">Sentence Reordering (Scrambled)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Choose the Odd One Out">Odd One Out (Logic)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <optgroup label="ğŸ”„ Translation">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Reverse Translation (ES->EN)">Reverse Translation (See ES, Pick EN)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </optgroup>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="ai-type-custom" class="ai-custom-input" placeholder="Or type custom format..." oninput="checkCustomOverride('ai-type-custom', 'ai-type-select')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-group" style="justify-content: space-between;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label">âš™ï¸ Settings</div>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; gap: 0; padding-right: 12px;">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="ai-gap-count" class="ai-select" style="flex: 1; min-width: 0;" title="Gaps">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="1" selected>1 Gap</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="2">2 Gaps</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="3">3 Gaps</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="random">Mix</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="ai-option-count" class="ai-select" style="flex: 1; min-width: 0; border-left: 1px solid #e5e5ea; padding-left:10px;" title="Options">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="2">2 Opts</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="3">3 Opts</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="4" selected>4 Opts</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="5">5 Opts</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="ai-sentence-count" class="ai-select" style="flex: 1; min-width: 0; border-left: 1px solid #e5e5ea; padding-left:10px;" title="Quantity">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="3">3 Qs</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="6" selected>6 Qs</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="9">9 Qs</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="12">12 Qs</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="padding: 0 10px 10px 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="segmented-control" id="level-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="level-btn" onclick="selectLevel(this, 'A1-A2 (Beginner)')">A1-A2</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="level-btn selected" onclick="selectLevel(this, 'B1-B2 (Intermediate)')">B1-B2</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="level-btn" onclick="selectLevel(this, 'C1-C2 (Advanced)')">C1-C2</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-grid-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label">ğŸ¯ Target</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-group" id="target-lang-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn selected" onclick="selectTarget(this, 'en')" title="English">ğŸ‡ºğŸ‡¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn" onclick="selectTarget(this, 'es')" title="Spanish">ğŸ‡ªğŸ‡¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn" onclick="selectTarget(this, 'pt')" title="Portuguese">ğŸ‡§ğŸ‡·</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn" onclick="selectTarget(this, 'it')" title="Italian">ğŸ‡®ğŸ‡¹</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label">ğŸŒ Translate</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-group" id="trans-lang-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn flag-sm" data-lang="en" onclick="toggleTrans(this, 'en')">ğŸ‡ºğŸ‡¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn flag-sm selected" data-lang="es" onclick="toggleTrans(this, 'es')">ğŸ‡ªğŸ‡¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn flag-sm" data-lang="pt" onclick="toggleTrans(this, 'pt')">ğŸ‡§ğŸ‡·</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flag-btn flag-sm" data-lang="it" onclick="toggleTrans(this, 'it')">ğŸ‡®ğŸ‡¹</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label">âš¡ Extra Instructions</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="ai-extra-data" class="ai-custom-input" placeholder="E.g. Use British slang, make it funny..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-footer-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âœ¨</span> Create Mission
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âœ¨</span> Paste Mission
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="ai-latest-preview"></div>

Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ai-card-label" style="font-size: 0.9rem;">ğŸ“ Memory Bank</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="saved-exercises-list" id="ai-memory-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mem-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-mem-ctrl" onclick="exportMemoryBank()">â¬‡ï¸ Export</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="importMemFile" accept=".json" style="display:none" onchange="importMemoryBank(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-mem-ctrl" onclick="document.getElementById('importMemFile').click()">â¬†ï¸ Import</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-mem-ctrl" style="color:var(--danger)" onclick="clearAIMemory()">ğŸ—‘ï¸ Clear</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

<script>
Â  Â  /* ====== CONFIG & STATE ====== */
Â  Â  const AI_MEM_KEY = 'mdc_ai_exercises';
Â  Â  const EDITOR_KEY = 'mdc_simple_editor';
Â  Â  const VOCAB_DB_KEY = 'mdc_vocab_list';Â 
Â  Â Â 
Â  Â  let currentTargetLang = 'en';Â 
Â  Â  let currentLevel = 'B1-B2 (Intermediate)';
Â  Â  const transLangs = new Set(['es']);Â 
Â  Â  const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian' };
Â  Â Â 
Â  Â  const editorArea = document.getElementById('editor-text');
Â  Â  const aiModal = document.getElementById('ai-hub-modal');

Â  Â  // PILL STATE
Â  Â  let currentWordStats = { occurrences: "-", uniqueTotal: 0 };
Â  Â  let lastStorageString = "";

Â  Â  /* ====== INITIALIZATION ====== */
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  loadEditorContent();
Â  Â  Â  Â  renderAiList();Â 
Â  Â  Â  Â  updateTransFlagsVisibility();
Â  Â  Â  Â  initCustomDropdowns();Â 
Â  Â  Â  Â  startStorageWatcher();Â 
Â  Â  Â  Â  refreshActiveView(); // Force initial highlight
Â  Â  });

Â  Â  /* ====== WATCHER SYSTEM ====== */
Â  Â  function startStorageWatcher() {
Â  Â  Â  Â  lastStorageString = localStorage.getItem(VOCAB_DB_KEY) || "";
Â  Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  Â  Â  const currentString = localStorage.getItem(VOCAB_DB_KEY) || "";
Â  Â  Â  Â  Â  Â  if (currentString !== lastStorageString) {
Â  Â  Â  Â  Â  Â  Â  Â  lastStorageString = currentString;
Â  Â  Â  Â  Â  Â  Â  Â  refreshActiveView();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 500);Â 
Â  Â  }

Â  Â  function refreshActiveView() {
Â  Â  Â  Â  const currentVocab = getDbWordsSet();
Â  Â  Â  Â  const editor = document.getElementById('editor-text');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Scan ALL existing interactive words in editor
Â  Â  Â  Â  editor.querySelectorAll('.interactive-word').forEach(span => {
Â  Â  Â  Â  Â  Â  const clean = sanitizeText(span.innerText).toLowerCase();
Â  Â  Â  Â  Â  Â  if (currentVocab.has(clean)) {
Â  Â  Â  Â  Â  Â  Â  Â  span.classList.add('word-added');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  span.classList.remove('word-added');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Only update pill if it's currently visible
Â  Â  Â  Â  if (document.getElementById('unified-pill').classList.contains('visible')) {
Â  Â  Â  Â  Â  Â  updateUnifiedPill(null);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /* ====== PILL LOGIC ====== */
Â  Â  function updateUnifiedPill(translationData = null) {
Â  Â  Â  Â  const pill = document.getElementById('unified-pill');
Â  Â  Â  Â  const statsText = document.getElementById('pill-stats-text');
Â  Â  Â  Â  const transPart = document.getElementById('pill-trans');
Â  Â  Â  Â  const divider = document.getElementById('pill-divider');
Â  Â  Â  Â  const transOrigin = document.getElementById('trans-origin');
Â  Â  Â  Â  const transResult = document.getElementById('trans-result');

Â  Â  Â  Â  pill.classList.add('visible');

Â  Â  Â  Â  // 1. UPDATE STATS based on Editor content
Â  Â  Â  Â  const savedWords = editorArea.querySelectorAll('.interactive-word.word-added');
Â  Â  Â  Â  const uniqueSet = new Set();
Â  Â  Â  Â  savedWords.forEach(el => uniqueSet.add(sanitizeText(el.innerText).toLowerCase()));
Â  Â  Â  Â  currentWordStats.uniqueTotal = uniqueSet.size;
Â  Â  Â  Â Â 
Â  Â  Â  Â  statsText.innerText = `${currentWordStats.occurrences} | ${currentWordStats.uniqueTotal}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(currentWordStats.uniqueTotal > 0) statsText.style.color = "#ff69b4";
Â  Â  Â  Â  else statsText.style.color = "#e5e7eb";

Â  Â  Â  Â  // 2. UPDATE TRANSLATION
Â  Â  Â  Â  if (translationData) {
Â  Â  Â  Â  Â  Â  divider.style.display = 'block';
Â  Â  Â  Â  Â  Â  transPart.style.display = 'flex';
Â  Â  Â  Â  Â  Â  transOrigin.innerText = translationData.origin;
Â  Â  Â  Â  Â  Â  transResult.innerText = translationData.result;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (!transPart.dataset.hasActive) {
Â  Â  Â  Â  Â  Â  Â  Â  divider.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  transPart.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function translateWord(text) {
Â  Â  Â  Â  const transPart = document.getElementById('pill-trans');
Â  Â  Â  Â  transPart.dataset.hasActive = "true";Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  updateUnifiedPill({ origin: text, result: "..." });

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=es&dt=t&q=${encodeURIComponent(text)}`;
Â  Â  Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  let result = "Not found";
Â  Â  Â  Â  Â  Â  if (data && data[0] && data[0][0]) result = data[0][0][0];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  updateUnifiedPill({ origin: text, result: result });
Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  updateUnifiedPill({ origin: text, result: "Error" });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  clearTimeout(window.transTimer);
Â  Â  Â  Â  window.transTimer = setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  const transPart = document.getElementById('pill-trans');
Â  Â  Â  Â  Â  Â  transPart.dataset.hasActive = "";Â 
Â  Â  Â  Â  Â  Â  updateUnifiedPill(null);Â 
Â  Â  Â  Â  }, 5000);
Â  Â  }

Â  Â  /* ====== INTERACTIVE HANDLER ====== */
Â  Â  window.handleWordClick = function(wordRaw, element, canSave = true) {
Â  Â  Â  Â  // 1. Translate
Â  Â  Â  Â  translateWord(wordRaw);

Â  Â  Â  Â  // 2. Calc Occurrences
Â  Â  Â  Â  const cleanWord = sanitizeText(wordRaw);
Â  Â  Â  Â  const checkEng = cleanWord.toLowerCase();
Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  editorArea.querySelectorAll('.interactive-word').forEach(el => {
Â  Â  Â  Â  Â  Â  if (sanitizeText(el.innerText).toLowerCase() === checkEng) count++;
Â  Â  Â  Â  });
Â  Â  Â  Â  currentWordStats.occurrences = count;

Â  Â  Â  Â  if (!canSave) return; // FIX: Don't save translations

Â  Â  Â  Â  // 3. Toggle Logic
Â  Â  Â  Â  let items = JSON.parse(localStorage.getItem(VOCAB_DB_KEY) || '[]');
Â  Â  Â  Â  let wordFound = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Deep search
Â  Â  Â  Â  items.forEach(i => {
Â  Â  Â  Â  Â  Â  if (!i.isFolder && i.eng && sanitizeText(i.eng).toLowerCase() === checkEng) wordFound = true;
Â  Â  Â  Â  Â  Â  if (i.isFolder && i.items) {
Â  Â  Â  Â  Â  Â  Â  Â  i.items.forEach(sub => { if (sub.eng && sanitizeText(sub.eng).toLowerCase() === checkEng) wordFound = true; });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  const folderName = "Editor Session";Â 
Â  Â  Â  Â  let isSaving = false;

Â  Â  Â  Â  if (!wordFound) {
Â  Â  Â  Â  Â  Â  isSaving = true;
Â  Â  Â  Â  Â  Â  const newItem = { id: Date.now(), isFolder: false, eng: cleanWord, esp: "", isHighlighted: false, dateAdded: Date.now() };
Â  Â  Â  Â  Â  Â  let targetFolder = items.find(i => i.isFolder && i.name === folderName);
Â  Â  Â  Â  Â  Â  if (targetFolder) {
Â  Â  Â  Â  Â  Â  Â  Â  targetFolder.items.unshift(newItem);
Â  Â  Â  Â  Â  Â  Â  Â  items = items.filter(i => i.id !== targetFolder.id); items.unshift(targetFolder);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const newFolder = { id: Date.now() + 1, isFolder: true, name: folderName, items: [newItem] };
Â  Â  Â  Â  Â  Â  Â  Â  items.unshift(newFolder);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  items.forEach(folder => {
Â  Â  Â  Â  Â  Â  Â  Â  if (folder.isFolder && folder.items) { folder.items = folder.items.filter(item => sanitizeText(item.eng).toLowerCase() !== checkEng); }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  items = items.filter(i => i.isFolder || (i.eng && sanitizeText(i.eng).toLowerCase() !== checkEng));
Â  Â  Â  Â  Â  Â  isSaving = false;
Â  Â  Â  Â  }

Â  Â  Â  Â  localStorage.setItem(VOCAB_DB_KEY, JSON.stringify(items));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 4. Update Visuals
Â  Â  Â  Â  editorArea.querySelectorAll('.interactive-word').forEach(span => {
Â  Â  Â  Â  Â  Â  if (sanitizeText(span.innerText).toLowerCase() === checkEng) {
Â  Â  Â  Â  Â  Â  Â  Â  if (isSaving) span.classList.add('word-added');
Â  Â  Â  Â  Â  Â  Â  Â  else span.classList.remove('word-added');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 5. Update Stats
Â  Â  Â  Â  updateUnifiedPill(null); // Keep translation open, update numbers
Â  Â  Â  Â  window.saveNote();Â 
Â  Â  };

Â  Â  /* ====== HELPER FUNCTIONS ====== */
Â  Â  function sanitizeText(text) {
Â  Â  Â  Â  if (!text) return "";
Â  Â  Â  Â  text = text.replace(/['`â€˜Â´]/g, "â€™");
Â  Â  Â  Â  text = text.replace(/[^a-zA-Z0-9\u00C0-\u017F\sâ€™]/g, "");
Â  Â  Â  Â  return text.trim();
Â  Â  }

Â  Â  function getDbWordsSet() {
Â  Â  Â  Â  const raw = localStorage.getItem(VOCAB_DB_KEY);
Â  Â  Â  Â  if(!raw) return new Set();
Â  Â  Â  Â  const data = JSON.parse(raw);
Â  Â  Â  Â  const set = new Set();
Â  Â  Â  Â  const extract = (list) => {
Â  Â  Â  Â  Â  Â  list.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if(item.isFolder) extract(item.items);
Â  Â  Â  Â  Â  Â  Â  Â  else if(item.eng) set.add(sanitizeText(item.eng).toLowerCase());
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };
Â  Â  Â  Â  extract(data);
Â  Â  Â  Â  return set;
Â  Â  }

Â  Â  function getDbWords(mode, count) {
Â  Â  Â  Â  const raw = localStorage.getItem(VOCAB_DB_KEY);
Â  Â  Â  Â  if(!raw) return [];
Â  Â  Â  Â  const data = JSON.parse(raw);
Â  Â  Â  Â  let allWords = [];
Â  Â  Â  Â  const extract = (list) => {
Â  Â  Â  Â  Â  Â  list.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if(item.isFolder) extract(item.items);
Â  Â  Â  Â  Â  Â  Â  Â  else if(item.eng) allWords.push(item.eng);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };
Â  Â  Â  Â  extract(data);
Â  Â  Â  Â  if(mode === 'last') return allWords.slice(0, count);
Â  Â  Â  Â  if(mode === 'random') return allWords.sort(() => 0.5 - Math.random()).slice(0, count);
Â  Â  Â  Â  return [];
Â  Â  }

Â  Â  /* ====== CUSTOM DROPDOWN LOGIC ====== */
Â  Â  function initCustomDropdowns() {
Â  Â  Â  Â  const selects = document.querySelectorAll('.ai-select');
Â  Â  Â  Â  selects.forEach(select => {
Â  Â  Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  wrapper.className = 'custom-select-wrapper';
Â  Â  Â  Â  Â  Â  select.parentNode.insertBefore(wrapper, select);
Â  Â  Â  Â  Â  Â  wrapper.appendChild(select);Â 

Â  Â  Â  Â  Â  Â  const trigger = document.createElement('div');
Â  Â  Â  Â  Â  Â  trigger.className = 'custom-select-trigger';
Â  Â  Â  Â  Â  Â  const selectedOpt = select.options[select.selectedIndex];
Â  Â  Â  Â  Â  Â  trigger.innerHTML = `<span>${selectedOpt.text}</span><span class="custom-arrow">â–¼</span>`;
Â  Â  Â  Â  Â  Â  wrapper.appendChild(trigger);

Â  Â  Â  Â  Â  Â  const optionsContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  optionsContainer.className = 'custom-options';
Â  Â  Â  Â  Â  Â  wrapper.appendChild(optionsContainer);

Â  Â  Â  Â  Â  Â  Array.from(select.children).forEach(child => {
Â  Â  Â  Â  Â  Â  Â  Â  if(child.tagName === 'OPTGROUP') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const groupHeader = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groupHeader.className = 'custom-group-header';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groupHeader.innerText = child.label;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  optionsContainer.appendChild(groupHeader);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Array.from(child.children).forEach(opt => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createCustomOption(opt, optionsContainer, trigger, select, wrapper);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (child.tagName === 'OPTION') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createCustomOption(child, optionsContainer, trigger, select, wrapper);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  trigger.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.custom-select-wrapper').forEach(w => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(w !== wrapper) w.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.classList.toggle('open');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  document.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function createCustomOption(optElement, container, trigger, select, wrapper) {
Â  Â  Â  Â  if(optElement.disabled) return;Â 

Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'custom-option';
Â  Â  Â  Â  if(optElement.selected) div.classList.add('selected');
Â  Â  Â  Â  div.innerText = optElement.text;
Â  Â  Â  Â Â 
Â  Â  Â  Â  div.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  select.value = optElement.value;
Â  Â  Â  Â  Â  Â  trigger.querySelector('span').innerText = optElement.text;
Â  Â  Â  Â  Â  Â  container.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  div.classList.add('selected');
Â  Â  Â  Â  Â  Â  wrapper.classList.remove('open');
Â  Â  Â  Â  Â  Â  const event = new Event('change');
Â  Â  Â  Â  Â  Â  select.dispatchEvent(event);
Â  Â  Â  Â  });

Â  Â  Â  Â  container.appendChild(div);
Â  Â  }

Â  Â  function checkCustomOverride(inputId, selectId) {Â 
Â  Â  Â  Â  const inputVal = document.getElementById(inputId).value.trim();Â 
Â  Â  Â  Â  const selectEl = document.getElementById(selectId);
Â  Â  Â  Â  const wrapper = selectEl.closest('.custom-select-wrapper');
Â  Â  Â  Â  const trigger = wrapper.querySelector('.custom-select-trigger');

Â  Â  Â  Â  if(inputVal.length > 0) {Â 
Â  Â  Â  Â  Â  Â  trigger.classList.add('override-warning');Â 
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  trigger.classList.remove('override-warning');Â 
Â  Â  Â  Â  }Â 
Â  Â  }

Â  Â  /* ====== EDITOR LOGIC ====== */
Â  Â  function loadEditorContent() {
Â  Â  Â  Â  const saved = localStorage.getItem(EDITOR_KEY);
Â  Â  Â  Â  if(saved) {
Â  Â  Â  Â  Â  Â  editorArea.innerHTML = saved;
Â  Â  Â  Â  Â  Â  setTimeout(refreshActiveView, 100);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  window.saveNote = function() {
Â  Â  Â  Â  const selects = editorArea.querySelectorAll('select');Â 
Â  Â  Â  Â  selects.forEach(s => {Â 
Â  Â  Â  Â  Â  Â  const val = s.value;Â 
Â  Â  Â  Â  Â  Â  const opts = s.querySelectorAll('option');Â 
Â  Â  Â  Â  Â  Â  opts.forEach(o => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (o.value === val) o.setAttribute('selected', 'true'); else o.removeAttribute('selected');Â 
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  });Â 
Â  Â  Â  Â  localStorage.setItem(EDITOR_KEY, editorArea.innerHTML);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const ind = document.getElementById('save-status');
Â  Â  Â  Â  ind.innerText = "âœ“ Saved";
Â  Â  Â  Â  ind.classList.add('saved');
Â  Â  Â  Â  setTimeout(() => { ind.innerText = "âœ“ Ready"; ind.classList.remove('saved'); }, 1500);
Â  Â  }

Â  Â  function applyColor(hex) { document.execCommand('foreColor', false, hex); updateToolbarState(); }
Â  Â  function toggleBold() { document.execCommand('bold'); updateToolbarState(); }
Â  Â  function setSize(size) { document.execCommand('fontSize', false, size); updateToolbarState(); }
Â  Â  function setFont(fontName) { document.execCommand('fontName', false, fontName); updateToolbarState(); }

Â  Â  editorArea.addEventListener('keyup', updateToolbarState);Â 
Â  Â  editorArea.addEventListener('mouseup', updateToolbarState);Â 
Â  Â  editorArea.addEventListener('click', updateToolbarState);Â 
Â  Â  editorArea.addEventListener('input', window.saveNote);
Â  Â Â 
Â  Â  function updateToolbarState() {Â 
Â  Â  Â  Â  const isBold = document.queryCommandState('bold');Â 
Â  Â  Â  Â  document.getElementById('btn-bold').classList.toggle('active', isBold);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const size = document.queryCommandValue('fontSize');Â 
Â  Â  Â  Â  document.getElementById('btn-size-lg').classList.toggle('active', size === '5' || size === 'x-large');Â 
Â  Â  Â  Â  document.getElementById('btn-size-norm').classList.toggle('active', size !== '5' && size !== 'x-large');Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const rgb = document.queryCommandValue('foreColor');Â 
Â  Â  Â  Â  document.querySelectorAll('.color-circle').forEach(b => b.classList.remove('active'));Â 
Â  Â  Â  Â  if(rgb) {
Â  Â  Â  Â  Â  Â  if(rgb.includes('255, 59, 48')) document.querySelectorAll('.color-circle')[1].classList.add('active');Â 
Â  Â  Â  Â  Â  Â  else if (rgb.includes('0, 122, 255')) document.querySelectorAll('.color-circle')[2].classList.add('active');Â 
Â  Â  Â  Â  Â  Â  else if (rgb.includes('52, 199, 89')) document.querySelectorAll('.color-circle')[3].classList.add('active');Â 
Â  Â  Â  Â  Â  Â  else document.querySelectorAll('.color-circle')[0].classList.add('active');Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  const font = document.queryCommandValue('fontName');
Â  Â  Â  Â  document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  if(font) {
Â  Â  Â  Â  Â  Â  if(font.includes('Inter')) document.querySelectorAll('.font-btn')[0].classList.add('active');
Â  Â  Â  Â  Â  Â  else if(font.includes('Playfair')) document.querySelectorAll('.font-btn')[1].classList.add('active');
Â  Â  Â  Â  Â  Â  else if(font.includes('Courier')) document.querySelectorAll('.font-btn')[2].classList.add('active');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /* ====== AI HUB LOGIC ====== */
Â  Â  function openAIMenu() { aiModal.classList.add('active'); renderAiList(); }
Â  Â  function closeAIMenu() { aiModal.classList.remove('active'); }
Â  Â  function selectTarget(el, lang) { document.querySelectorAll('#target-lang-group .flag-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentTargetLang = lang; updateTransFlagsVisibility(); }
Â  Â  function selectLevel(el, levelDesc) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentLevel = levelDesc; }
Â  Â  function updateTransFlagsVisibility() { document.querySelectorAll('#trans-lang-group .flag-btn').forEach(btn => { const btnLang = btn.getAttribute('data-lang'); if (btnLang === currentTargetLang) { btn.classList.add('hidden'); btn.classList.remove('selected'); transLangs.delete(btnLang); } else { btn.classList.remove('hidden'); } }); }
Â  Â  function toggleTrans(el, lang) { if (transLangs.has(lang)) { transLangs.delete(lang); el.classList.remove('selected'); } else { if (transLangs.size >= 3) return alert("Max 3 translation languages."); transLangs.add(lang); el.classList.add('selected'); } }
Â  Â  function escapeHtml(text) { if (!text) return ""; return text.replace(/'/g, "\\'").replace(/"/g, "&quot;"); }

Â  Â  function exportMemoryBank() { const data = localStorage.getItem(AI_MEM_KEY); if(!data || data === '[]') return alert("Memory is empty."); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'polyglot_memory_full.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
Â  Â  function importMemoryBank(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if(!Array.isArray(importedData)) throw new Error("Invalid format"); const current = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const combined = [...importedData, ...current]; localStorage.setItem(AI_MEM_KEY, JSON.stringify(combined)); renderAiList(); alert("Import Successful!"); } catch(err) { alert("Error importing: " + err.message); } }; reader.readAsText(file); }
Â  Â  function renameMemoryItem(id) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const idx = memory.findIndex(i => i.id === id); if(idx > -1) { const newTitle = prompt("New Title:", memory[idx].title); if(newTitle) { memory[idx].title = newTitle; localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } } }
Â  Â  function exportSingleItem(id) { const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const item = memory.find(x => x.id === id); if(!item) return; const data = JSON.stringify([item], null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const safeName = (item.title || 'exercise').replace(/[^a-z0-9]/gi, '_').toLowerCase(); a.download = `${safeName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
Â  Â  function deleteMemoryItem(id) { if(confirm("Delete?")) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory = memory.filter(item => item.id !== id); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } }
Â  Â  function clearAIMemory() { if(confirm("Clear all?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }
Â  Â Â 
Â  Â  function renderAiList() {Â 
Â  Â  Â  Â  const listContainer = document.getElementById('ai-memory-list');Â 
Â  Â  Â  Â  const previewContainer = document.getElementById('ai-latest-preview');
Â  Â  Â  Â  const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  previewContainer.innerHTML = '';
Â  Â  Â  Â  listContainer.innerHTML = '';

Â  Â  Â  Â  if (memory.length === 0) {Â 
Â  Â  Â  Â  Â  Â  listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>';Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }Â 

Â  Â  Â  Â  const createItemHtml = (item, index, isPreview = false) => {
Â  Â  Â  Â  Â  Â  let flag = "ğŸ‡¬ğŸ‡§"; if(item.lang === 'es') flag = "ğŸ‡ªğŸ‡¸"; if(item.lang === 'pt') flag = "ğŸ‡§ğŸ‡·"; if(item.lang === 'it') flag = "ğŸ‡®ğŸ‡¹";Â 
Â  Â  Â  Â  Â  Â  let newBadge = (index === 0 && !isPreview) ? '<span class="badge-new">NEW</span>' : '';Â 
Â  Â  Â  Â  Â  Â  let typeBadge = item.isHtml ? '<span class="badge-tpl">TEMPLATE</span>' : `â€¢ ${item.data.length} Qs`;Â 
Â  Â  Â  Â  Â  Â  let boxClass = isPreview ? 'saved-item ai-preview-box' : 'saved-item';
Â  Â  Â  Â  Â  Â  let titlePrefix = isPreview ? 'ğŸ†• LATEST CREATED: ' : '';

Â  Â  Â  Â  Â  Â  return `<div class="${boxClass}" style="${isPreview ? 'background:#f0fff4; border-bottom:none;' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="saved-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="saved-name">${flag} ${titlePrefix}${item.title} ${newBadge}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="saved-date">${item.date} ${typeBadge}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mem-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-insert" onclick="insertExerciseFromMem(${item.id})">Insert</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-icon-action btn-export-item" onclick="exportSingleItem(${item.id})" title="Export JSON">â¬‡ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-icon-action btn-rename" onclick="renameMemoryItem(${item.id})" title="Rename">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-icon-action btn-delete-item" onclick="deleteMemoryItem(${item.id})" title="Delete">Ã—</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;Â 
Â  Â  Â  Â  };

Â  Â  Â  Â  if(memory.length > 0) { previewContainer.innerHTML = createItemHtml(memory[0], 0, true); }
Â  Â  Â  Â  let listHtml = '';
Â  Â  Â  Â  memory.forEach((item, index) => { listHtml += createItemHtml(item, index, false); });Â 
Â  Â  Â  Â  listContainer.innerHTML = listHtml;Â 
Â  Â  }
Â  Â Â 
Â  Â  function copyProfessorPrompt() {
Â  Â  Â  Â  const ctxSel = document.getElementById('ai-context-select').value;
Â  Â  Â  Â  const graSel = document.getElementById('ai-grammar-select').value;
Â  Â  Â  Â  const typSel = document.getElementById('ai-type-select').value;
Â  Â  Â  Â  const gapCount = document.getElementById('ai-gap-count').value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let finalOptionCount = document.getElementById('ai-option-count').value;
Â  Â  Â  Â  const fullTypeCheck = (typSel || "").toLowerCase();
Â  Â  Â  Â  if (fullTypeCheck.includes("true") || fullTypeCheck.includes("reading")) {
Â  Â  Â  Â  Â  Â  finalOptionCount = 2;
Â  Â  Â  Â  }

Â  Â  Â  Â  const ctxCust = document.getElementById('ai-context-custom').value.trim();
Â  Â  Â  Â  const graCust = document.getElementById('ai-grammar-custom').value.trim();
Â  Â  Â  Â  const typCust = document.getElementById('ai-type-custom').value.trim();
Â  Â  Â  Â  const extraData = document.getElementById('ai-extra-data').value.trim();
Â  Â  Â  Â  const quantity = document.getElementById('ai-sentence-count').value || 6;
Â  Â  Â  Â  const currentTarget = LANG_NAMES[currentTargetLang];Â 

Â  Â  Â  Â  let contextInstruction = ctxCust ? `Custom Topic: "${ctxCust}"` : (ctxSel ? `Topic: "${ctxSel}"` : "General Daily Life");
Â  Â  Â  Â Â 
Â  Â  Â  Â  let dbWords = [];
Â  Â  Â  Â  if (ctxSel && ctxSel.startsWith('vb_')) {
Â  Â  Â  Â  Â  Â  let mode = ctxSel.replace('vb_', '');
Â  Â  Â  Â  Â  Â  dbWords = getDbWords(mode === 'random' ? 'random' : 'last', mode === 'random' ? 15 : parseInt(mode.split('_')[1] || 10));
Â  Â  Â  Â  }

Â  Â  Â  Â  let vocabBlock = "";
Â  Â  Â  Â  if (dbWords.length > 0) {
Â  Â  Â  Â  Â  Â  vocabBlock = `
Â  Â  Â  Â  Â  Â  VOCABULARY INJECTION:
Â  Â  Â  Â  Â  Â  List: [${dbWords.join(', ')}].
Â  Â  Â  Â  Â  Â  CRITICAL RULE: Incorporate specific vocabulary naturally.Â 
Â  Â  Â  Â  Â  Â  - Do NOT force all words. Use only 1 or 2 distinct words from this list per sentence maximum.
Â  Â  Â  Â  Â  Â  - If a word doesn't fit the grammar topic perfectly, ignore it. Grammar accuracy is priority #1.`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const fullType = (typSel + " " + typCust).toLowerCase();

Â  Â  Â  Â  let isReordering = fullType.includes("reordering");
Â  Â  Â  Â  let isTranslation = fullType.includes("translation") || fullType.includes("reverse");
Â  Â  Â  Â  let isFix = fullType.includes("fix") || fullType.includes("mistake");
Â  Â  Â  Â  let isOddOneOut = fullType.includes("odd");
Â  Â  Â  Â  let isVocabMatch = fullType.includes("matching");
Â  Â  Â  Â  let isTrueFalse = fullType.includes("true");

Â  Â  Â  Â  let gapRule = '3. GAPS: Format is "{correct|distractor1|distractor2}". The correct answer must ALWAYS be the first option inside the brackets.';
Â  Â  Â  Â  let distractorRule = "4. DISTRACTORS: Must be grammatically plausible but incorrect. NEVER use synonyms of the correct answer as distractors.";
Â  Â  Â  Â  let sentenceRule = "5. FULL_SENTENCE: Must be the grammatically perfect, corrected version of the sentence (used for Text-to-Speech audio).";
Â  Â  Â  Â  let visualRules = "VISUALS: Clean text. No markdown in the content strings.";
Â  Â  Â  Â Â 
Â  Â  Â  Â  let clozeExample = '"She {went|goes} to school."';Â 

Â  Â  Â  Â  if (isFix) {
Â  Â  Â  Â  Â  Â  Â visualRules = "CRITICAL VISUAL RULE: Place the `<s>crossed out mistake</s>` html tags IMMEDIATELY BEFORE the opening `{` bracket. Do NOT put the `<s>` tags inside the `{...}` gap structure.";
Â  Â  Â  Â  Â  Â  Â distractorRule = "4. DISTRACTORS: Options should be corrections of the mistake.";
Â  Â  Â  Â  Â  Â  Â clozeExample = '"He <s>goed</s> {went|gone} to school."';
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isReordering) {
Â  Â  Â  Â  Â  Â  gapRule = '3. GAPS: For "Sentence Reordering", hide a CRITICAL SEGMENT (3-5 words) where word order is tricky.';
Â  Â  Â  Â  Â  Â  distractorRule = '4. DISTRACTORS: Must be the SAME words as the answer but scrambled (incorrect order).';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (isTranslation) {
Â  Â  Â  Â  Â  Â  Â gapRule = '3. GAPS: The `cloze_text` must show the SOURCE language sentence (wrapped in <b> tags), a <br>, then the gap with Target language options.';
Â  Â  Â  Â  Â  Â  Â distractorRule = '4. DISTRACTORS: False friends or literal incorrect translations.';
Â  Â  Â  Â  Â  Â  Â clozeExample = '"<b>Hola mundo</b><br>{Hello world|Hi earth}"';
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isOddOneOut) {
Â  Â  Â  Â  Â  Â  Â gapRule = '3. GAPS: The gap contains 4 words. The "Correct" one (first pos) is the INTRUDER (the one that does not fit). Format: "{Intruder|Member1|Member2|Member3}".';
Â  Â  Â  Â  Â  Â  Â visualRules = "CRITICAL: The sentence prompt (e.g., 'Which is not a fruit?') acts as the header.";
Â  Â  Â  Â  Â  Â  Â sentenceRule = "5. FULL_SENTENCE: For Odd One Out, this field should simply read the correct word followed by a short explanation (e.g., 'Car. Because it is not a fruit').";
Â  Â  Â  Â  Â  Â  Â clozeExample = '"Which is odd? {Car|Apple|Banana|Grape}"';
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isVocabMatch) {
Â  Â  Â  Â  Â  Â  visualRules = "CRITICAL CONTENT RULE: The sentence MUST be a definition or description. The gap is the word being defined. Example: 'A place where you sleep is a {bedroom|kitchen}'.";
Â  Â  Â  Â  Â  Â  clozeExample = '"A domestic feline is a {cat|dog|bird}."';
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isTrueFalse) {
Â  Â  Â  Â  Â  Â  gapRule = '3. GAPS: Format is "{True|False}" or "{False|True}". Only 2 options.';
Â  Â  Â  Â  Â  Â  distractorRule = '4. DISTRACTORS: The opposite of the correct answer.';
Â  Â  Â  Â  Â  Â  clozeExample = '"The sun is cold. {False|True}"';
Â  Â  Â  Â  }

Â  Â  Â  Â  const activeTransLangs = Array.from(transLangs);
Â  Â  Â  Â  const transTypeDefinition = activeTransLangs.length > 0Â 
Â  Â  Â  Â  Â  Â  ? activeTransLangs.map(l => `${l}: string; // Translation in ${LANG_NAMES[l] || l}`).join('\nÂ  Â  Â  Â  Â  Â  Â  ')
Â  Â  Â  Â  Â  Â  : '// No translations requested';

Â  Â  Â  Â  const tsInterface = `
Â  Â  Â  Â  interface PolyglotExercise {
Â  Â  Â  Â  Â  title: string; // Title in ${currentTarget}
Â  Â  Â  Â  Â  lang_code: "${currentTargetLang}";
Â  Â  Â  Â  Â  theory: string; // Brief grammar explanation (HTML allowed: <b>, <ul>).
Â  Â  Â  Â  Â  exercises: Array<{
Â  Â  Â  Â  Â  Â  full_sentence: string;Â 
Â  Â  Â  Â  Â  Â  cloze_text: string; // Format specific syntax. Example: ${clozeExample}
Â  Â  Â  Â  Â  Â  hint: string; // CONTEXTUAL RULE: Explain WHY based on keywords.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // SAFETY RULE: Use SINGLE QUOTES (') for internal emphasis. NEVER use double quotes inside this string.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // BAD: "Look at the word "yesterday"." (This BREAKS JSON)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // GOOD: "Look at the word 'yesterday'." (This works perfect)
Â  Â  Â  Â  Â  Â  translations: {
Â  Â  Â  Â  Â  Â  Â  ${transTypeDefinition}
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }>;
Â  Â  Â  Â  }`;

Â  Â  Â  Â  const promptText = `
Â  Â  Â  Â  ROLE: Expert ${currentTarget} Linguist & JSON Generator.
Â  Â  Â  Â  TASK: Generate a strictly valid JSON object.

Â  Â  Â  Â  SETTINGS:
Â  Â  Â  Â  - Target Level: ${currentLevel} (Adjust vocabulary difficulty accordingly).
Â  Â  Â  Â  - Quantity: ${quantity} items.
Â  Â  Â  Â  - Grammar Focus: ${graCust || graSel || "General Practice"}.
Â  Â  Â  Â  - ${contextInstruction}
Â  Â  Â  Â  - Format: ${typCust || typSel || "Cloze"}.
Â  Â  Â  Â  - Gap Config: ${gapCount} gap(s), ${finalOptionCount} options.
Â  Â  Â  Â Â 
Â  Â  Â  Â  ${vocabBlock}
Â  Â  Â  Â  ${visualRules}

Â  Â  Â  Â  STRICT TYPESCRIPT INTERFACE:
Â  Â  Â  Â  ${tsInterface}

Â  Â  Â  Â  LOGIC RULES:
Â  Â  Â  Â  1. OUTPUT ONLY RAW JSON. Do not include markdown \`\`\` tags.
Â  Â  Â  Â  2. LANGUAGE: Target language is ${currentTarget}.
Â  Â  Â  Â  ${gapRule}
Â  Â  Â  Â  ${distractorRule}
Â  Â  Â  Â  ${sentenceRule}
Â  Â  Â  Â  6. JSON SAFETY: Use single quotes (') for emphasized words inside strings to avoid escaping issues.

Â  Â  Â  Â  GENERATE JSON NOW:
Â  Â  Â  Â  `.trim();

Â  Â  Â  Â  navigator.clipboard.writeText(promptText).then(() => {
Â  Â  Â  Â  Â  Â  const btn = document.querySelector('.btn-ai-primary');Â 
Â  Â  Â  Â  Â  Â  const orig = btn.innerText;
Â  Â  Â  Â  Â  Â  btn.innerText = "âœ… Copied!";Â 
Â  Â  Â  Â  Â  Â  setTimeout(() => btn.innerText = orig, 2000);
Â  Â  Â  Â  }).catch(err => alert("Error copying: " + err));
Â  Â  }
Â  Â Â 
Â  Â  async function pasteAIJson() {
Â  Â  Â  Â  let jsonString = "";
Â  Â  Â  Â  try { jsonString = await navigator.clipboard.readText(); } catch (err) { jsonString = prompt("Paste JSON here:"); }
Â  Â  Â  Â  if (!jsonString) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const btn = document.getElementById('btn-paste-json');Â 
Â  Â  Â  Â  const orig = btn.innerHTML;
Â  Â  Â  Â  btn.innerHTML = "<span>âš™ï¸</span> Processing...";
Â  Â  Â  Â Â 
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  processJsonAndSave(jsonString);
Â  Â  Â  Â  Â  Â  btn.innerHTML = orig;
Â  Â  Â  Â  }, 100);
Â  Â  }
Â  Â Â 
function processJsonAndSave(rawString) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  let cleanString = rawString.trim();
Â  Â  Â  Â  Â  Â  const markdownMatch = cleanString.match(/```(?:json)?([\s\S]*?)```/);
Â  Â  Â  Â  Â  Â  if (markdownMatch && markdownMatch[1]) {
Â  Â  Â  Â  Â  Â  Â  Â  cleanString = markdownMatch[1].trim();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const firstBrace = cleanString.search(/(\{|\[)/);
Â  Â  Â  Â  Â  Â  const lastBrace = cleanString.lastIndexOf('}');
Â  Â  Â  Â  Â  Â  const lastBracket = cleanString.lastIndexOf(']');
Â  Â  Â  Â  Â  Â  const realEnd = Math.max(lastBrace, lastBracket);

Â  Â  Â  Â  Â  Â  if (firstBrace === -1 || realEnd === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("No JSON structure found in response.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  cleanString = cleanString.substring(firstBrace, realEnd + 1);

Â  Â  Â  Â  Â  Â  cleanString = cleanString
Â  Â  Â  Â  Â  Â  Â  Â  .replace(/[\u0000-\u001F]+/g, " ")Â 
Â  Â  Â  Â  Â  Â  Â  Â  .replace(/[\u201C\u201D\u201E\u201F\u275D\u275E]/g, '"');Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let aiData = JSON.parse(cleanString);

Â  Â  Â  Â  Â  Â  let finalData;
Â  Â  Â  Â  Â  Â  if (Array.isArray(aiData)) {
Â  Â  Â  Â  Â  Â  Â  Â  finalData = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: "AI Exercise Set",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lang_code: currentTargetLang,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theory: "Generated Practice",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exercises: aiDataÂ 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  finalData = aiData;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!finalData.exercises || !Array.isArray(finalData.exercises)) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("JSON structure is valid but missing 'exercises' array.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
Â  Â  Â  Â  Â  Â  const newItem = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  title: finalData.title || "Untitled",Â 
Â  Â  Â  Â  Â  Â  Â  Â  lang: finalData.lang_code || currentTargetLang,Â 
Â  Â  Â  Â  Â  Â  Â  Â  theory: finalData.theory || "",Â 
Â  Â  Â  Â  Â  Â  Â  Â  date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),Â 
Â  Â  Â  Â  Â  Â  Â  Â  data: finalData.exercises,
Â  Â  Â  Â  Â  Â  Â  Â  isHtml: false
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  memory.unshift(newItem);
Â  Â  Â  Â  Â  Â  localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderAiList();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const previewBox = document.querySelector('#ai-latest-preview .ai-preview-box');
Â  Â  Â  Â  Â  Â  if (previewBox) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  previewBox.classList.add('highlight');Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => previewBox.classList.remove('highlight'), 2000);Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  alert("âŒ AI Generation Error.\n\n" + e.message);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 2. FunciÃ³n para procesar texto y volverlo clickable
Â  Â  function makeInteractable(text, canSave = true) {
Â  Â  Â  Â  return text.split(' ').map(word => {
Â  Â  Â  Â  Â  Â  const safeWord = word.replace(/'/g, "\\'");Â 
Â  Â  Â  Â  Â  Â  // HERE: Pass canSave flag
Â  Â  Â  Â  Â  Â  return `<span class="interactive-word" onclick="window.handleWordClick('${safeWord}', this, ${canSave})">${word}</span>`;
Â  Â  Â  Â  }).join(' ');
Â  Â  }

Â  Â  // 3. FunciÃ³n para copiar texto de TeorÃ­a o Hints
Â  Â  window.copyDivText = function(elementId, btnElement) {
Â  Â  Â  Â  const el = document.getElementById(elementId);
Â  Â  Â  Â  if (!el) return;
Â  Â  Â  Â  const textToCopy = el.innerText;
Â  Â  Â  Â  navigator.clipboard.writeText(textToCopy).then(() => {
Â  Â  Â  Â  Â  Â  const original = btnElement.innerHTML;
Â  Â  Â  Â  Â  Â  btnElement.innerHTML = "âœ“";
Â  Â  Â  Â  Â  Â  btnElement.classList.add('copied');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  btnElement.innerHTML = "ğŸ“‹";
Â  Â  Â  Â  Â  Â  Â  Â  btnElement.classList.remove('copied');
Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  });
Â  Â  };
Â  Â Â 
Â function insertExerciseFromMem(id) {
Â  Â  Â  Â  const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
Â  Â  Â  Â  const item = memory.find(x => x.id === id); if (!item) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const insertTime = Date.now();Â 
Â  Â  Â  Â  const theoryId = `theory-${id}-${insertTime}`;Â 
Â  Â  Â  Â  const targetLang = item.lang || 'en';

Â  Â  Â  Â  let htmlBlock = `
Â  Â  Â  Â  <div class="exercise-box" contenteditable="false">
Â  Â  Â  Â  Â  Â  <div class="exercise-header">
Â  Â  Â  Â  Â  Â  Â  Â  <span>âœï¸ ${item.title}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-theory" onclick="document.getElementById('${theoryId}').style.display = document.getElementById('${theoryId}').style.display === 'block' ? 'none' : 'block'">ğŸ“˜ Theory</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-reset-block" contenteditable="false" onclick="window.resetExerciseBlock(this)" title="Reset">â†º</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-del-block" contenteditable="false" onclick="if(confirm('Delete block?')) { this.closest('.exercise-box').remove(); window.saveNote(); }" title="Delete">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="theory-box" id="${theoryId}">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:flex-end; margin-bottom:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-copy-text" onclick="window.copyDivText('${theoryId}-content', this)" title="Copy Theory">ğŸ“‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="${theoryId}-content">${makeInteractable(item.theory || "No theory.", true)}</div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  item.data.forEach((ex, index) => {
Â  Â  Â  Â  Â  Â  const uId = `ex-${id}-${index}-${insertTime}`;Â 
Â  Â  Â  Â  Â  Â  const hId = `hint-${id}-${index}-${insertTime}`;Â 
Â  Â  Â  Â  Â  Â  const tId = `trans-${id}-${index}-${insertTime}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let exerciseContent = "";

Â  Â  Â  Â  Â  Â  if (ex.cloze_text) {
Â  Â  Â  Â  Â  Â  Â  Â  const parts = ex.cloze_text.split(/(\{.*?\})/g);
Â  Â  Â  Â  Â  Â  Â  Â  let interactiveHtml = "";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  parts.forEach(part => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (part.startsWith('{') && part.endsWith('}')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const content = part.slice(1, -1);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const optsArr = content.split('|');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const correctAns = optsArr[0].trim();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const shuffled = [...optsArr].sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let optsHtml = `<option value="" disabled selected>...</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shuffled.forEach(opt => { optsHtml += `<option value="${escapeHtml(opt.trim())}">${opt.trim()}</option>`; });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  interactiveHtml += `<span class="cloze-gap-container"><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(correctAns)}')">${optsHtml}</select></span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  interactiveHtml += makeInteractable(part, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  exerciseContent = `<span><b>${index + 1}.</b> ${interactiveHtml}</span>`;

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  let optsHtml = `<option value="" disabled selected>...</option>`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const shuffled = [...ex.options].sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  shuffled.forEach(opt => { optsHtml += `<option value="${escapeHtml(opt)}">${opt}</option>`; });
Â  Â  Â  Â  Â  Â  Â  Â  const preText = makeInteractable(ex.pre || '', true);
Â  Â  Â  Â  Â  Â  Â  Â  const postText = makeInteractable(ex.post || '', true);
Â  Â  Â  Â  Â  Â  Â  Â  exerciseContent = `<span><b>${index + 1}.</b> ${preText}</span><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(ex.answer)}')">${optsHtml}</select><span>${postText}</span>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let transContent = "";
Â  Â  Â  Â  Â  Â  if (ex.translations) {
Â  Â  Â  Â  Â  Â  Â  Â  for (const [key, val] of Object.entries(ex.translations)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let f = "ğŸ‡¬ğŸ‡§"; if (key === 'es') f = "ğŸ‡ªğŸ‡¸"; if (key === 'pt') f = "ğŸ‡§ğŸ‡·"; if (key === 'it') f = "ğŸ‡®ğŸ‡¹";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // TRANSLATIONS: canSave = false
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transContent += `<div class="trans-line"><button class="btn-mini-speak" contenteditable="false" onclick="window.speakText('${escapeHtml(val)}', '${key}')">ğŸ”Š</button><span>${f} ${makeInteractable(val, false)}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else { transContent = "No translation"; }

Â  Â  Â  Â  Â  Â  htmlBlock += `
Â  Â  Â  Â  Â  Â  <div class="exercise-row" id="${uId}">
Â  Â  Â  Â  Â  Â  Â  Â  ${exerciseContent}
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:inline-flex; gap:5px; margin-left:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="ex-btn-icon" contenteditable="false" onclick="window.speakText('${escapeHtml(ex.full_sentence)}', '${targetLang}')">ğŸ”Š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${tId}').style.display = document.getElementById('${tId}').style.display === 'block' ? 'none' : 'block'">ğŸŒ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${hId}').style.display = document.getElementById('${hId}').style.display === 'block' ? 'none' : 'block'">â“</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="hint-box" id="${hId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ’¡ Tip</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-copy-text" onclick="window.copyDivText('${hId}-txt', this)" title="Copy Hint">ğŸ“‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="${hId}-txt">${makeInteractable(ex.hint, true)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="trans-box" id="${tId}">${transContent}</div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  htmlBlock += '</div><p><br></p>';
Â  Â  Â  Â  editorArea.insertAdjacentHTML('beforeend', htmlBlock);
Â  Â  Â  Â  // Force refresh
Â  Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  refreshActiveView();
Â  Â  Â  Â  Â  Â  editorArea.scrollTop = editorArea.scrollHeight;Â 
Â  Â  Â  Â  Â  Â  window.saveNote();Â 
Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  closeAIMenu();
Â  Â  }
Â  Â Â 
Â  Â  window.validateExercise = function(s, a) {
Â  Â  Â  Â  s.classList.remove('correct', 'wrong');
Â  Â  Â  Â  if (s.value.trim().toLowerCase() === a.trim().toLowerCase()) { s.classList.add('correct'); } else { s.classList.add('wrong'); if (navigator.vibrate) navigator.vibrate(200); }
Â  Â  Â  Â  window.saveNote();
Â  Â  };
Â  Â Â 
Â  Â  window.speakText = function(text, langCode) {
Â  Â  Â  Â  if ('speechSynthesis' in window) {
Â  Â  Â  Â  Â  Â  window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text);
Â  Â  Â  Â  Â  Â  const m = { 'en': 'en-US', 'es': 'es-ES', 'pt': 'pt-BR', 'it': 'it-IT' };
Â  Â  Â  Â  Â  Â  u.lang = m[langCode] || 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u);
Â  Â  Â  Â  } else { alert("TTS not supported."); }
Â  Â  };
Â  Â  window.resetExerciseBlock = function(btn) { const box = btn.closest('.exercise-box'); if(box) { const selects = box.querySelectorAll('select'); selects.forEach(s => { s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); s.selectedIndex = 0; }); window.saveNote(); } };
// === COMUNICACIÃ“N CON NEXUS (CÃ“DIGO 1) ===
window.addEventListener('message', function(event) {
Â  Â  if (event.data === 'FORCE_PAUSE') {
Â  Â  Â  Â  if ('speechSynthesis' in window) {
Â  Â  Â  Â  Â  Â  window.speechSynthesis.cancel();
Â  Â  Â  Â  }
Â  Â  }
});

</script>

Â  Â  <script>
(function() {
Â  Â  const VOCAB_KEY = 'mdc_vocab_list';
Â  Â  let isTranslating = false; // Bandera para evitar bucles infinitos

Â  Â  // 1. EL TRUCO MAESTRO: Interceptar el guardado local (Misma pestaÃ±a)
Â  Â  const originalSetItem = localStorage.setItem;
Â  Â Â 
Â  Â  localStorage.setItem = function(key, value) {
Â  Â  Â  Â  // Primero, hacemos el guardado normal
Â  Â  Â  Â  originalSetItem.apply(this, arguments);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Luego, si lo que se guardÃ³ es nuestra lista, activamos la revisiÃ³n
Â  Â  Â  Â  if (key === VOCAB_KEY && !isTranslating) {
Â  Â  Â  Â  Â  Â  // Usamos un pequeÃ±o delay para asegurar que el dato ya asentÃ³
Â  Â  Â  Â  Â  Â  setTimeout(checkAndFixTranslations, 100);
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // 2. Escuchar guardados de OTRAS pestaÃ±as
Â  Â  window.addEventListener('storage', (e) => {
Â  Â  Â  Â  if (e.key === VOCAB_KEY && !isTranslating) {
Â  Â  Â  Â  Â  Â  checkAndFixTranslations();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // 3. Revisar al cargar la pÃ¡gina
Â  Â  document.addEventListener('DOMContentLoaded', checkAndFixTranslations);

Â  Â  // --- LÃ“GICA DE TRADUCCIÃ“N ---
Â  Â  async function checkAndFixTranslations() {
Â  Â  Â  Â  if (isTranslating) return; // Si ya estoy trabajando, no me interrumpas
Â  Â  Â  Â Â 
Â  Â  Â  Â  const raw = localStorage.getItem(VOCAB_KEY);
Â  Â  Â  Â  if (!raw) return;

Â  Â  Â  Â  let items;
Â  Â  Â  Â  try { items = JSON.parse(raw); } catch(e) { return; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  let updated = false;

Â  Â  Â  Â  // FunciÃ³n auxiliar: conecta con Google
Â  Â  Â  Â  const translate = async (text) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=es&dt=t&q=${encodeURIComponent(text)}`;
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  return (data && data[0]) ? data[0].map(s => s[0]).join('') : null;
Â  Â  Â  Â  Â  Â  } catch (e) { return null; }
Â  Â  Â  Â  };

Â  Â  Â  Â  // Escaneo recursivo
Â  Â  Â  Â  const scanItems = async (list) => {
Â  Â  Â  Â  Â  Â  for (let item of list) {
Â  Â  Â  Â  Â  Â  Â  Â  if (item.isFolder) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await scanItems(item.items);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CONDICIÃ“N: Hay inglÃ©s PERO el espaÃ±ol estÃ¡ vacÃ­o o no existe
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.eng && (!item.esp || item.esp.trim() === "")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isTranslating = true; // Bloqueamos para que nadie moleste
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const translation = await translate(item.eng);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (translation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.esp = translation.replace(/['`â€˜Â´]/g, "â€™").replace(/[^a-zA-Z0-9\u00C0-\u017F\sâ€™]/g, "");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  await scanItems(items);

Â  Â  Â  Â  if (updated) {
Â  Â  Â  Â  Â  Â  console.log("ğŸ¤– MDC Translator: Nuevas palabras detectadas y traducidas.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Guardamos usando la funciÃ³n ORIGINAL para evitar un bucle infinito
Â  Â  Â  Â  Â  Â  originalSetItem.call(localStorage, VOCAB_KEY, JSON.stringify(items));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Notificamos a la pÃ¡gina actual para que se refresque visualmente
Â  Â  Â  Â  Â  Â  refreshCurrentPage(items);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  isTranslating = false; // Liberamos la bandera
Â  Â  }

Â  Â  // FunciÃ³n para actualizar la interfaz visual sin recargar la pÃ¡gina
Â  Â  function refreshCurrentPage(items) {
Â  Â  Â  Â  // Intenta actualizar el reproductor
Â  Â  Â  Â  if (typeof updateAllWordStates === 'function') updateAllWordStates();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Intenta actualizar la lista de vocabulario
Â  Â  Â  Â  if (typeof loadVocab === 'function') loadVocab();
Â  Â  Â  Â  else if (typeof renderList === 'function') renderList(items);
Â  Â  }

})();
</script>
</body>
</html>
