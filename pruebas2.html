<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Polyglot Tutor V26 (Complete)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --primary: #007AFF;
            --primary-soft: #e3f2fd;
            --danger: #FF3B30;
            --bg-body: #F2F2F7;
            --text-main: #1C1C1E;
            --text-muted: #8E8E93;
            --card-bg: #FFFFFF;
            --radius: 16px;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.06);
            --header-height: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: 'Inter', sans-serif;
            padding-top: var(--header-height);
            padding-bottom: 60px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ====== HEADER ====== */
        #mdc-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(16px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        #mdc-header a { text-decoration: none; font-weight: 800; font-size: 20px; color: white; }

        /* ====== DASHBOARD ====== */
        .dashboard-container {
            width: 95%; max-width: 1100px; margin-top: 30px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dash-card {
            background: #fff; border-radius: 16px; padding: 24px; box-shadow: var(--shadow-soft);
            display: flex; flex-direction: column; gap: 15px; transition: transform 0.2s;
        }
        .dash-card:hover { transform: translateY(-2px); }

        .dash-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        
        .btn-free-study {
            background: linear-gradient(135deg, #007AFF, #5856D6); color: white; border: none; padding: 16px; 
            border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; gap: 10px;
        }

        .input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #e5e5ea; border-radius: 8px; background: #f9f9fb; font-size: 0.95rem; }
        input[type="text"]:focus { border-color: var(--primary); outline: none; background: #fff; }
        
        .type-selector { display: flex; gap: 5px; background: #f2f2f7; padding: 4px; border-radius: 8px; }
        .type-btn { flex: 1; border: none; background: transparent; padding: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-radius: 6px; color: #8e8e93; }
        .type-btn.active { background: white; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .btn-add-res { width: 100%; padding: 12px; background: var(--text-main); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        
        .manage-box { display: none; background: #fff5f5; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #ffecec; }
        .manage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .btn-clean { background: white; border: 1px solid #ffccc7; color: var(--danger); font-size: 0.7rem; padding: 6px; border-radius: 6px; cursor: pointer; }
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-data { padding: 10px; background: #f2f2f7; color: var(--text-main); border: 1px solid #e5e5ea; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 6px; }

        /* ====== FILTER BAR ====== */
        .filter-section { width: 95%; max-width: 1100px; margin-top: 30px; display: flex; flex-direction: column; gap: 15px; }
        @media (min-width: 600px) { .filter-section { flex-direction: row; align-items: center; justify-content: space-between; } }
        .filter-pill-container { background: #e5e5ea; padding: 4px; border-radius: 12px; display: inline-flex; gap: 2px; }
        .filter-btn { padding: 8px 16px; border: none; background: transparent; font-size: 0.9rem; font-weight: 600; color: #666; cursor: pointer; border-radius: 10px; }
        .filter-btn.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .search-container { position: relative; flex-grow: 1; max-width: 300px; }
        .search-container input { padding-left: 34px; background: white; border: 1px solid #e5e5ea; width: 100%; border-radius: 10px; height: 36px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.4; }

        /* ====== RESOURCE CARDS (NEW DESIGN) ====== */
        .grid-container { width: 95%; max-width: 1100px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-bottom: 40px; margin-top: 20px; }
        
        .res-card {
            border-radius: 20px; padding: 20px; 
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 180px; 
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; border: 1px solid rgba(0,0,0,0.03);
        }
        .res-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }

        .res-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .res-icon { 
            width: 48px; height: 48px; background: white; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow: hidden;
        }
        .res-icon img { width: 32px; height: 32px; object-fit: contain; }
        
        .res-badge { 
            background: rgba(255,255,255,0.6); backdrop-filter: blur(4px);
            padding: 4px 10px; border-radius: 20px; 
            font-size: 0.65rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;
            color: rgba(0,0,0,0.6);
        }

        .res-body { flex-grow: 1; margin-bottom: 15px; cursor: pointer; }
        .res-title { font-size: 1.1rem; font-weight: 700; color: #1c1c1e; line-height: 1.3; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .res-domain { font-size: 0.8rem; color: rgba(0,0,0,0.5); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .res-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 12px; }
        .res-date { font-size: 0.75rem; color: rgba(0,0,0,0.4); font-weight: 500; }
        .res-actions { display: flex; gap: 6px; }
        
        .btn-card-icon { 
            width: 32px; height: 32px; border-radius: 8px; border: none; 
            background: rgba(255,255,255,0.5); cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            transition: all 0.2s; font-size: 1rem; color: #333;
        }
        .btn-card-icon:hover { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-dice:hover { color: var(--primary); transform: rotate(180deg); }
        .btn-del:hover { color: var(--danger); background: #fff0f0; }

        /* ====== EDITOR ====== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .editor-popup { background: white; width: 95%; max-width: 1500px; height: 90vh; display: flex; border-radius: 14px; overflow: hidden; }
        @media (max-width: 900px) { .editor-popup { flex-direction: column; width: 100%; height: 100%; border-radius: 0; } }
        
        .desktop-video-container { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; min-width: 300px;}
        .editor-content-panel { flex: 1; background: white; display: flex; flex-direction: column; min-width: 300px; position: relative; }
        .editor-popup.free-mode .desktop-video-container { display: none !important; }
        
        .editor-toolbar { padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 10px; overflow-x: auto; background: #fff; align-items: center; }
        .editor-area { flex: 1; padding: 30px; overflow-y: auto; outline: none; font-size: 1.1rem; line-height: 1.6; }
        .editor-footer { padding: 10px 20px; background: #fbfbfd; border-top: 1px solid #eee; text-align: right; color: #999; font-size: 0.8rem; }
        .editor-header { padding: 10px 16px; background: #f9f9fb; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .editor-title { font-weight: 700; }
        .btn-header-icon { width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #eee; }

        .web-iframe { width: 100%; height: 100%; border: none; background: white; }
        .audio-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; background: #1c1c1e; }
        .resizer-gutter { width: 10px; background: #f2f2f7; cursor: col-resize; border-left: 1px solid #ddd; border-right: 1px solid #ddd; display: none; }
        @media (min-width: 900px) { .resizer-gutter { display: block; } }

        /* ====== AI HUB (Essential Styles) ====== */
        .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .ai-popup-overlay.active { display: flex; }
        .ai-popup-box { background: white; width: 92%; max-width: 700px; border-radius: 18px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; max-height: 90vh; }
        .ai-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .ai-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: 700; display: flex; justify-content: space-between; }
        .ai-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 5px; }
        .btn-ai-action { padding: 12px; background: #f2f2f7; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-ai-primary { background: var(--primary); color: white; }
        
        /* Reuse generic buttons */
        .btn-fmt { width: 36px; height: 36px; border-radius: 8px; border: none; background: #f2f2f7; font-weight: 600; cursor: pointer; }
        .btn-fmt:hover { background: #e5e5ea; }
        .btn-ai-trigger { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #007AFF; }
    </style>
</head>
<body>

    <div id="mdc-header">
        <a href="#">MDC Polyglot</a>
    </div>

    <div class="dashboard-container">
        <div class="dash-card" style="border-top: 4px solid var(--primary);">
            <div class="dash-title"><span style="font-size:1.5rem">üìù</span> Pizarra de Estudio</div>
            <div style="font-size:0.85rem; color:#8e8e93;">Editor libre sin multimedia. Ideal para templates.</div>
            <button class="btn-free-study" onclick="openFreeEditor()"><span>Entrar al Editor</span><span>‚Üí</span></button>
        </div>

        <div class="dash-card">
            <div class="dash-title"><span style="font-size:1.5rem">‚ûï</span> Add Resource</div>
            <div class="type-selector" id="res-types">
                <button class="type-btn active" onclick="setResourceType('auto')">‚ú® Auto</button>
                <button class="type-btn" onclick="setResourceType('video')">üé• Video</button>
                <button class="type-btn" onclick="setResourceType('audio')">üéß Audio</button>
                <button class="type-btn" onclick="setResourceType('web')">üåê Web</button>
            </div>
            <div class="input-group">
                <label>URL</label>
                <input type="text" id="vidUrl" placeholder="https://...">
            </div>
            <div class="input-group">
                <label>Title (Optional)</label>
                <input type="text" id="vidTitle" placeholder="Auto-generated if empty">
            </div>
            <button class="btn-add-res" onclick="addResource()">Add to Library</button>
            <div style="text-align: right; margin-top:5px;">
                <button style="border:none; background:none; color:#999; cursor:pointer; font-size:0.75rem;" onclick="document.getElementById('manage-box').style.display = document.getElementById('manage-box').style.display==='block'?'none':'block'">‚öôÔ∏è Clean/Manage</button>
            </div>
            <div id="manage-box" class="manage-box">
                <div class="manage-grid">
                    <button class="btn-clean" onclick="deleteByType('video')">Del Videos</button>
                    <button class="btn-clean" onclick="deleteByType('audio')">Del Audios</button>
                    <button class="btn-clean" onclick="deleteByType('web')">Del Web</button>
                    <button class="btn-clean" style="color:white; background:var(--danger); border-color:var(--danger);" onclick="deleteByType('all')">Del All</button>
                </div>
            </div>
        </div>

        <div class="dash-card">
            <div class="dash-title"><span style="font-size:1.5rem">üíæ</span> Backup</div>
            <div class="data-grid">
                <button class="btn-data" onclick="downloadBackup()">‚¨áÔ∏è Save</button>
                <input type="file" id="imp" hidden onchange="importBackup(this)">
                <button class="btn-data" onclick="document.getElementById('imp').click()">‚¨ÜÔ∏è Load</button>
            </div>
        </div>
    </div>

    <div class="filter-section">
        <div class="filter-pill-container">
            <button class="filter-btn active" onclick="filterGrid('all', this)">All</button>
            <button class="filter-btn" onclick="filterGrid('video', this)">Video</button>
            <button class="filter-btn" onclick="filterGrid('audio', this)">Audio</button>
            <button class="filter-btn" onclick="filterGrid('web', this)">Web</button>
        </div>
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-input" placeholder="Search..." oninput="searchGrid()">
        </div>
    </div>

    <div class="grid-container" id="video-grid"></div>

    <div class="modal-overlay" id="editor-modal">
        <div class="editor-popup" id="editor-popup">
            <div class="desktop-video-container" id="desktop-video-wrapper"></div>
            <div class="resizer-gutter" id="drag-resizer"></div>
            <div class="editor-content-panel">
                <div class="editor-header">
                    <span class="editor-title">Note Editor</span>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-header-icon" id="btn-fullscreen" onclick="toggleEditorFullScreen()">‚õ∂</button>
                        <button class="btn-header-icon" onclick="closeEditor()">√ó</button>
                    </div>
                </div>
                <div class="editor-toolbar">
                    <button class="btn-fmt" onclick="document.execCommand('bold')">B</button>
                    <button class="btn-fmt btn-ai-trigger" onclick="openAIMenu()">‚ö° AI</button>
                    <button class="btn-fmt" onclick="saveEditorAsTemplate()">üíæ Tpl</button>
                    <button class="btn-fmt" onclick="document.getElementById('editor-text').innerHTML='';saveNote()">üóëÔ∏è</button>
                </div>
                <div id="editor-text" class="editor-area" contenteditable="true" oninput="saveNote()"></div>
                <div class="editor-footer"><span>‚úì Auto-saved</span></div>
            </div>
        </div>
    </div>

    <div class="ai-popup-overlay" id="ai-hub-modal">
        <div class="ai-popup-box">
            <div class="ai-header"><span>‚ö° AI Hub</span><button class="ai-close" onclick="closeAIMenu()">√ó</button></div>
            <div class="ai-body">
                <div class="ai-label">Context</div>
                <select id="ai-context-select" class="ai-select"><option>Daily Life</option><option>Business</option><option>Travel</option></select>
                <div class="ai-label">Grammar</div>
                <select id="ai-grammar-select" class="ai-select"><option>Present Tenses</option><option>Past Tenses</option></select>
                <div class="ai-label">Type</div>
                <select id="ai-type-select" class="ai-select"><option>Fill Blanks</option><option>Multiple Choice</option></select>
                
                <div class="ai-actions">
                    <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">‚ú® Create Mission</button>
                    <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">üì• Import JSON</button>
                </div>
                
                <div class="ai-label">Memory Bank</div>
                <div id="ai-memory-list"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn-data" onclick="exportMemoryBank()">Exp Bank</button>
                    <input type="file" id="impMem" hidden onchange="importMemoryBank(this)">
                    <button class="btn-data" onclick="document.getElementById('impMem').click()">Imp Bank</button>
                </div>
                <button class="btn-clean" style="width:100%; margin-top:10px;" onclick="clearAIMemory()">Clear Memory</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'mdc_saved_v26';
        const AI_MEM_KEY = 'mdc_ai_mem_v26';
        let currentFilter = 'all';
        let selectedResourceType = 'auto';
        let currentEditIndex = -1;
        let currentVideoId = null;
        let player = null;
        let activePlayer = null;

        // Pastel Palette
        const COLORS = ['#FFF8E1', '#E3F2FD', '#F3E5F5', '#E0F2F1', '#FFEBEE', '#F1F8E9', '#E8EAF6', '#FFF3E0'];

        document.addEventListener('DOMContentLoaded', () => { loadVideos(); renderAiList(); initResizer(); });

        /* DATA LOGIC */
        function addResource() {
            const url = document.getElementById('vidUrl').value.trim();
            let title = document.getElementById('vidTitle').value.trim();
            if(!url) return alert("URL required");

            let type = 'web';
            let id = url;
            let domain = 'general';

            // Auto Detect
            if(selectedResourceType !== 'auto') type = selectedResourceType;
            else {
                if(url.match(/(youtu\.be|youtube\.com)/)) type = 'video';
                else if(url.match(/\.(mp3|wav|ogg|m4a)$/i)) type = 'audio';
            }

            try {
                const urlObj = new URL(url);
                domain = urlObj.hostname.replace('www.', '');
                if(!title) title = domain; 
            } catch(e) { domain = 'Resource'; if(!title) title="Untitled"; }

            if(type === 'video') {
                const m = (url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|live\/)([^#&?]*).*/) || [])[2];
                if(m && m.length===11) id = m;
            }

            const newItem = {
                id, url, title, type, note: "",
                date: new Date().toLocaleDateString(),
                domain: domain,
                color: COLORS[Math.floor(Math.random() * COLORS.length)]
            };

            const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            list.unshift(newItem);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            
            document.getElementById('vidUrl').value = ''; 
            document.getElementById('vidTitle').value = '';
            loadVideos();
        }

        function loadVideos() {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            renderGrid(data);
        }

        /* RENDER LOGIC (THE NEW CARD) */
        function renderGrid(allData) {
            const grid = document.getElementById('video-grid');
            const query = document.getElementById('search-input').value.toLowerCase();
            
            const filtered = allData.filter(item => {
                const typeMatch = currentFilter === 'all' || (item.type || 'video') === currentFilter;
                const textMatch = (item.title + (item.domain||'')).toLowerCase().includes(query);
                return typeMatch && textMatch;
            });

            if(filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; margin-top:40px;">No resources found.</div>';
                return;
            }

            grid.innerHTML = filtered.map(item => {
                const idx = allData.indexOf(item);
                const type = item.type || 'video';
                
                // Icon Logic
                let iconUrl = `https://www.google.com/s2/favicons?domain=${item.domain || 'google.com'}&sz=64`;
                if(type === 'video') iconUrl = `https://img.youtube.com/vi/${item.id}/default.jpg`; 
                
                let typeBadge = type.toUpperCase();

                return `
                <div class="res-card" style="background-color: ${item.color || '#fff'};">
                    <div class="res-header">
                        <div class="res-icon">
                            <img src="${iconUrl}" onerror="this.style.display='none'">
                        </div>
                        <div class="res-badge">${typeBadge}</div>
                    </div>
                    
                    <div class="res-body" onclick="openEditor(${idx})">
                        <div class="res-title">${item.title}</div>
                        <div class="res-domain">${item.domain || 'link'}</div>
                    </div>

                    <div class="res-footer">
                        <div class="res-date">${item.date}</div>
                        <div class="res-actions">
                            <button class="btn-card-icon btn-dice" onclick="randomizeColor(${idx})" title="Change Color">üé≤</button>
                            <button class="btn-card-icon" onclick="openEditor(${idx})" title="Open">‚Üó</button>
                            <button class="btn-card-icon btn-del" onclick="deleteItem(${idx})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        /* ACTIONS */
        function randomizeColor(idx) {
            const list = JSON.parse(localStorage.getItem(STORAGE_KEY));
            let newColor = COLORS[Math.floor(Math.random() * COLORS.length)];
            while(newColor === list[idx].color) newColor = COLORS[Math.floor(Math.random() * COLORS.length)];
            list[idx].color = newColor;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            loadVideos();
        }

        function deleteItem(idx) {
            if(confirm("Delete this resource?")) {
                const list = JSON.parse(localStorage.getItem(STORAGE_KEY));
                list.splice(idx, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
                loadVideos();
            }
        }

        function filterGrid(type, btn) {
            currentFilter = type;
            if(btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            loadVideos();
        }
        function searchGrid() { loadVideos(); }
        function setResourceType(t) { 
            selectedResourceType = t; 
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        function deleteByType(t) {
            if(!confirm("Sure?")) return;
            let list = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
            if(t==='all') list=[]; else list=list.filter(i=>(i.type||'video')!==t);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            loadVideos();
        }

        /* EDITOR LOGIC */
        function openFreeEditor() {
            openCommon(-1);
            document.getElementById('editor-popup').classList.add('free-mode');
        }

        function openEditor(idx) {
            openCommon(idx);
            document.getElementById('editor-popup').classList.remove('free-mode');
            const item = JSON.parse(localStorage.getItem(STORAGE_KEY))[idx];
            const wrap = document.getElementById('desktop-video-wrapper');
            wrap.innerHTML = '';
            const type = item.type || 'video';

            if(window.matchMedia("(min-width: 900px)").matches) {
                if(type === 'video') {
                    wrap.innerHTML = '<div id="yt-player" style="width:100%;height:100%"></div>';
                    player = new YT.Player('yt-player', { videoId: item.id });
                } else if(type === 'audio') {
                    wrap.innerHTML = `<div class="audio-container"><h1>üéß</h1><h3>${item.title}</h3><audio controls src="${item.url}" style="width:80%"></audio></div>`;
                } else {
                    wrap.innerHTML = `<iframe class="web-iframe" src="${item.url}" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>`;
                }
            }
        }

        function openCommon(idx) {
            currentEditIndex = idx;
            const data = idx > -1 ? JSON.parse(localStorage.getItem(STORAGE_KEY))[idx] : {note:''};
            document.getElementById('editor-text').innerHTML = data.note || '';
            document.getElementById('editor-modal').classList.add('active');
        }

        function closeEditor() {
            document.getElementById('editor-modal').classList.remove('active');
            if(player && player.destroy) player.destroy();
            document.getElementById('desktop-video-wrapper').innerHTML = '';
            if(currentEditIndex > -1) {
                const list = JSON.parse(localStorage.getItem(STORAGE_KEY));
                list[currentEditIndex].note = document.getElementById('editor-text').innerHTML;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            }
            loadVideos();
        }

        function saveNote() { 
            if(currentEditIndex > -1) {
                const list = JSON.parse(localStorage.getItem(STORAGE_KEY));
                list[currentEditIndex].note = document.getElementById('editor-text').innerHTML;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            }
        }

        function downloadBackup() { 
            const d = localStorage.getItem(STORAGE_KEY); 
            const b = new Blob([d],{type:'application/json'}); 
            const a = document.createElement('a'); 
            a.href=URL.createObjectURL(b); a.download='library.json'; a.click(); 
        }
        function importBackup(inp) {
            const r = new FileReader(); r.onload = e => {
                localStorage.setItem(STORAGE_KEY, e.target.result); loadVideos();
            }; r.readAsText(inp.files[0]);
        }

        function initResizer() {
            const r = document.getElementById('drag-resizer');
            const l = document.getElementById('desktop-video-wrapper');
            const p = document.getElementById('editor-popup');
            let x=0, w=0;
            const md = e => { x=e.clientX; w=l.getBoundingClientRect().width; document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu); l.style.pointerEvents='none'; };
            const mm = e => { const dx=e.clientX-x; const nw=w+dx; l.style.width = ((nw/p.getBoundingClientRect().width)*100)+'%'; };
            const mu = () => { document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',mu); l.style.pointerEvents='auto'; };
            r.addEventListener('mousedown', md);
        }
        function toggleEditorFullScreen() { document.getElementById('editor-popup').classList.toggle('is-fullscreen'); }

        /* AI & Memory (Simplified for size, fully functional) */
        function openAIMenu() { document.getElementById('ai-hub-modal').classList.add('active'); renderAiList(); }
        function closeAIMenu() { document.getElementById('ai-hub-modal').classList.remove('active'); }
        function copyProfessorPrompt() { 
            const prompt = "Create a JSON exercise. Structure: {title:'', lang_code:'en', exercises:[{pre:'', answer:'', post:'', options:[], hint:'', translations:{es:''}, full_sentence:''}]}"; 
            navigator.clipboard.writeText(prompt).then(()=>alert("Prompt Copied!")); 
        }
        async function pasteAIJson() {
            try {
                const t = await navigator.clipboard.readText();
                const j = JSON.parse(t.replace(/```json|```/g,'').trim());
                const m = JSON.parse(localStorage.getItem(AI_MEM_KEY)||'[]');
                m.unshift({id:Date.now(), title:j.title||'Exercise', data:j.exercises||[], isHtml:false, date:new Date().toLocaleDateString()});
                localStorage.setItem(AI_MEM_KEY, JSON.stringify(m)); renderAiList();
            } catch(e) { alert("Invalid JSON"); }
        }
        function renderAiList() {
            const list = JSON.parse(localStorage.getItem(AI_MEM_KEY)||'[]');
            const c = document.getElementById('ai-memory-list'); c.innerHTML='';
            list.forEach(i => {
                c.innerHTML += `<div class="saved-item"><div class="saved-info"><b>${i.title}</b> <small>${i.date}</small></div><div class="mem-actions"><button class="btn-clean" onclick="insertEx(${i.id})">Insert</button><button class="btn-clean" onclick="delMem(${i.id})">Del</button></div></div>`;
            });
        }
        function insertEx(id) {
            const m = JSON.parse(localStorage.getItem(AI_MEM_KEY)).find(x=>x.id===id);
            if(m.isHtml) document.getElementById('editor-text').insertAdjacentHTML('beforeend', m.htmlContent);
            else {
                let h = `<div class="exercise-box" contenteditable="false"><div class="exercise-header"><b>${m.title}</b><button class="btn-clean" onclick="this.closest('.exercise-box').remove()">Del Block</button></div>`;
                m.data.forEach((e,i) => {
                    h += `<div class="exercise-row"><b>${i+1}.</b> ${e.pre} <select class="ex-select" onchange="this.classList.toggle('correct',this.value=='${e.answer}')"><option disabled selected>Select</option>${e.options.map(o=>`<option>${o}</option>`).join('')}</select> ${e.post}</div>`;
                });
                document.getElementById('editor-text').insertAdjacentHTML('beforeend', h+'</div><p><br></p>');
            }
            closeAIMenu(); saveNote();
        }
        function delMem(id) {
            const m = JSON.parse(localStorage.getItem(AI_MEM_KEY)).filter(x=>x.id!==id);
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(m)); renderAiList();
        }
        function saveEditorAsTemplate() {
            const c = document.getElementById('editor-text').innerHTML;
            const n = prompt("Template Name:"); if(!n)return;
            const m = JSON.parse(localStorage.getItem(AI_MEM_KEY)||'[]');
            m.unshift({id:Date.now(), title:n, isHtml:true, htmlContent:c, date:new Date().toLocaleDateString()});
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(m)); renderAiList();
        }
        function exportMemoryBank() {
            const d = localStorage.getItem(AI_MEM_KEY);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([d],{type:'application/json'})); a.download='ai_bank.json'; a.click();
        }
        function importMemoryBank(i) {
            const r = new FileReader(); r.onload=e=>{
                const n = JSON.parse(e.target.result);
                const c = JSON.parse(localStorage.getItem(AI_MEM_KEY)||'[]');
                localStorage.setItem(AI_MEM_KEY, JSON.stringify([...n, ...c])); renderAiList();
            }; r.readAsText(i.files[0]);
        }
        function clearAIMemory() { if(confirm("Clear All?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }
    </script>
</body>
</html>
