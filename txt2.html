<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Smart Editor Ultimate (V16 Hybrid)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* MDC Core Theme */
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --bg-body: #111827; 
            --bg-panel: #1f2937;
            --bg-pair-alt: #283142; 
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #374151;
            --highlight: #fde047;
            --danger: #ef4444;
            --recording: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --sidebar-width: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* TOOLBAR */
        .toolbar {
            height: 60px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 20;
            flex-shrink: 0;
            overflow-x: auto; 
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .toolbar::-webkit-scrollbar { display: none; }

        .brand { font-weight: 700; color: var(--primary); font-size: 1.1rem; margin-right: 10px; display: none; }
        @media(min-width: 768px) { .brand { display: block; } }

        .tool-btn {
            background: #374151; border: none; color: white; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
            display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0;
        }
        .tool-btn:hover { background: var(--primary); }
        .tool-btn.active { background: var(--highlight); color: black; font-weight: bold; }
        .tool-btn.ai-trigger { background: linear-gradient(135deg, #4f46e5, #9333ea); border: 1px solid #6366f1; font-weight: 800; box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); }
        .tool-btn svg { width: 18px; height: 18px; }
        
        .format-group { display: flex; gap: 5px; border-right: 1px solid var(--border); padding-right: 10px; flex-shrink: 0; }
        .study-group { margin-left: auto; display: flex; gap: 8px; align-items: center; flex-shrink: 0; }

        #save-status {
            font-size: 0.75rem; color: var(--text-muted); font-style: italic;
            opacity: 0; transition: opacity 0.5s; display: none; white-space: nowrap;
        }
        @media(min-width: 768px) { #save-status { display: inline; } }
        #save-status.visible { opacity: 1; color: var(--success); }

        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* SIDEBAR (Original Code A) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: absolute; 
            height: 100%;
            z-index: 15;
            transform: translateX(-100%); 
        }

        @media(min-width: 768px) {
            .sidebar { position: relative; transform: translateX(0); }
            .sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        }

        .sidebar.mobile-open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }

        .sidebar-header { 
            padding: 15px; font-weight: 700; color: var(--primary-light); font-size: 0.75rem; 
            text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; border-top: 1px solid var(--border);
        }
        .sidebar-header:first-child { border-top: none; margin-top: 0; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        .db-folder { margin-bottom: 5px; border: 1px solid #374151; border-radius: 6px; overflow: hidden; background: #111827; }
        .db-folder-title {
            padding: 12px; background: #1f2937; cursor: pointer; font-size: 0.95rem; 
            display: flex; justify-content: space-between; align-items: center; font-weight: 500;
        }
        .db-folder-title:active { background: #374151; }
        .db-folder-items { display: none; padding: 10px; background: #111827; border-top: 1px solid #374151; }
        .db-folder.open .db-folder-items { display: block; }
        
        .draggable-word {
            background: #374151; padding: 10px; margin-bottom: 6px; border-radius: 6px;
            font-size: 0.9rem; cursor: pointer; border: 1px solid transparent; 
            color: #e5e7eb; display: flex; justify-content: space-between; align-items: center;
            user-select: none;
        }
        .draggable-word:active { background: #4b5563; border-color: var(--primary); transform: scale(0.98); }
        .chip-text { pointer-events: none; flex: 1; } 
        .chip-audio-btn {
            background: rgba(255,255,255,0.05); border: none; color: var(--text-muted);
            cursor: pointer; padding: 6px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; width: 32px; height: 32px; margin-left: 8px;
        }
        .chip-audio-btn:active { background: var(--primary); color: white; }

        /* EDITOR AREA */
        .editor-container {
            flex: 1; padding: 20px; overflow-y: auto;
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-size: 20px 20px; padding-bottom: 150px; width: 100%;
        }
        .document-title {
            width: 100%; background: transparent; border: none; font-size: 1.5rem; font-weight: 700;
            color: var(--text-main); margin-bottom: 20px; outline: none;
        }

        .editor-block {
            background: var(--bg-panel); border-radius: 12px; margin-bottom: 20px;
            border: 1px solid var(--border); overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            transition: all 0.3s ease;
        }
        .block-header {
            background: #111827; padding: 10px 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .block-label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        
        /* STANDARD BLOCKS (Code A) */
        .lesson-drawer { display: none; padding: 15px; background: #1f2937; border-bottom: 1px solid var(--border); }
        .lesson-drawer textarea {
            width: 100%; min-height: 80px; background: #111827; color: #d1d5db;
            border: 1px dashed #6b7280; border-radius: 6px; padding: 10px;
            font-family: monospace; font-size: 0.9rem; resize: vertical;
        }
        .pairs-container { display: flex; flex-direction: column; }
        .sentence-pair {
            display: flex; gap: 8px; padding: 10px;
            border-bottom: 1px solid #374151; align-items: flex-start;
        }
        .sentence-pair:nth-child(even) { background-color: var(--bg-pair-alt); }
        .sentence-pair:last-child { border-bottom: none; }

        .pair-inputs { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .row-wrapper { position: relative; width: 100%; }
        
        .input-row {
            padding: 10px; padding-right: 30px; border-radius: 6px; outline: none; 
            min-height: 42px; line-height: 1.4; transition: border 0.2s;
            font-size: 1rem;
        }
        .row-en {
            color: #fff; font-weight: 500;
            border-left: 3px solid var(--primary); background: rgba(79,70,229, 0.1);
        }
        .row-es {
            color: var(--text-muted); font-style: italic;
            border-left: 3px solid #10b981; background: rgba(16,185,129, 0.05);
        }
        .input-row.active-focus { box-shadow: 0 0 0 2px var(--primary); background: rgba(79,70,229, 0.2); }
        .blur-en .row-en { color: transparent; text-shadow: 0 0 10px rgba(255,255,255,0.7); }
        .blur-es .row-es { color: transparent; text-shadow: 0 0 10px rgba(255,255,255,0.7); }
        
        .pair-controls { display: flex; flex-direction: column; gap: 5px; padding-top: 2px; }
        .lang-flag {
            position: absolute; right: 8px; bottom: 12px; width: 18px; height: 12px; pointer-events: none;
            filter: grayscale(100%); opacity: 0.3; background-size: cover;
        }
        .flag-en { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 30'%3E%3Cpath d='M0,0 v30 h60 v-30 z' fill='%23012169'/%3E%3Cpath d='M0,0 L60,30 M60,0 L0,30' stroke='%23fff' stroke-width='6'/%3E%3Cpath d='M0,0 L60,30 M60,0 L0,30' stroke='%23C8102E' stroke-width='4'/%3E%3Cpath d='M30,0 v30 M0,15 h60' stroke='%23fff' stroke-width='10'/%3E%3Cpath d='M30,0 v30 M0,15 h60' stroke='%23C8102E' stroke-width='6'/%3E%3C/svg%3E"); }
        .flag-es { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 750 500'%3E%3Crect width='750' height='500' fill='%23c60b1e'/%3E%3Crect width='750' height='250' y='125' fill='%23ffc400'/%3E%3C/svg%3E"); }

        .mini-btn {
            width: 32px; height: 32px; border-radius: 6px; border: none;
            background: #374151; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .mini-btn:active { transform: scale(0.9); }
        .mini-btn:hover { background: var(--primary); color: white; }
        .mini-btn.delete:hover { background: var(--danger); }
        .mini-btn.book-active { background: var(--highlight); color: black; }
        .mini-btn.recording { background: var(--recording); color: white; animation: pulse 1.5s infinite; }
        .block-delete { margin-left: auto; background: transparent; color: #6b7280; }

        /* ====== AI RENDERED BLOCKS (Ported from Code B & Dark Mode Adapted) ====== */
        .ai-content { padding: 0; }
        .exercise-box { background: var(--bg-pair-alt); border-radius: 8px; padding: 20px; user-select: none; }
        .exercise-header { 
            font-size: 1rem; font-weight: 700; color: var(--primary-light); margin-bottom: 16px; 
            border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; 
        }
        .theory-box { display: none; background: #111827; padding: 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.6; border: 1px solid var(--border); color: #d1d5db; }
        .exercise-row { margin-bottom: 16px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; line-height: 1.8; }
        .btn-theory { background: #374151; color: var(--primary-light); border: none; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        
        .ex-select { 
            padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; 
            background: #111827; color: var(--text-main); cursor: pointer; outline: none; font-size: 0.95rem; 
        }
        .ex-select.correct { border-color: var(--success) !important; background-color: rgba(16,185,129, 0.1) !important; color: var(--success) !important; }
        .ex-select.wrong { border-color: var(--danger) !important; background-color: rgba(239,68,68, 0.1) !important; color: var(--danger) !important; animation: shake 0.3s; }
        
        .hint-box, .trans-box { display: none; width: 100%; margin-top: 8px; padding: 12px; border-radius: 8px; font-size: 0.9rem; }
        .hint-box { background: rgba(245, 158, 11, 0.1); border-left: 3px solid var(--warning); color: #fcd34d; }
        .trans-box { background: rgba(79, 70, 229, 0.1); border-left: 3px solid var(--primary); color: #c7d2fe; }
        .trans-line { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        
        .ex-btn-icon { background: #374151; border: none; border-radius: 6px; cursor: pointer; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
        .ex-btn-icon:hover { background: var(--primary); color: white; }
        
        .exercise-row s { color: var(--danger); text-decoration: line-through; opacity: 0.7; margin-right: 5px; }

        /* ====== AI MODAL & HUB (Full Code B Integration) ====== */
        .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; backdrop-filter: blur(5px); }
        .ai-popup-overlay.active { display: flex; }
        .ai-popup-box { 
            background: var(--bg-body); width: 100%; height: 100%; display: flex; flex-direction: column; 
            max-width: 900px; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            border-left: 1px solid var(--border); border-right: 1px solid var(--border);
        }
        .ai-header { 
            background: var(--bg-panel); border-bottom: 1px solid var(--border); color: var(--text-main); 
            padding: 15px 20px; font-weight: 700; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; 
        }
        .ai-close { background: #374151; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; color: white; font-size: 1.2rem; display:flex; align-items:center; justify-content:center;}
        .ai-body { padding: 20px; overflow-y: auto; flex:1; background: var(--bg-body); }
        
        .ai-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 15px; }
        @media(max-width: 600px) { .ai-grid-2 { grid-template-columns: 1fr; } }
        
        .ai-card-group { 
            background: var(--bg-panel); border-radius: 12px; padding: 10px; border: 1px solid var(--border); 
            display: flex; flex-direction: column; gap: 8px;
        }
        .ai-card-label { font-size: 0.75rem; font-weight: 700; color: var(--primary-light); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Custom Dropdown Dark Mode */
        .ai-select { display: none; } 
        .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
        .custom-select-trigger { 
            position: relative; display: flex; align-items: center; justify-content: space-between; 
            padding: 10px; font-size: 0.9rem; color: var(--text-main); cursor: pointer; 
            background: #111827; border: 1px solid var(--border); border-radius: 8px; 
        }
        .custom-options { 
            position: absolute; top: 105%; left: 0; right: 0; background: var(--bg-panel); 
            border: 1px solid var(--border); border-radius: 8px; z-index: 2000; 
            opacity: 0; visibility: hidden; pointer-events: none; max-height: 250px; overflow-y: auto; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; pointer-events: auto; }
        .custom-option { padding: 10px; font-size: 0.9rem; color: #d1d5db; cursor: pointer; }
        .custom-option:hover { background: var(--primary); color: white; }
        .custom-option.selected { background: #374151; color: var(--highlight); }
        .custom-group-header { padding: 8px; font-size: 0.7rem; color: #6b7280; font-weight: 800; border-top: 1px solid var(--border); }
        
        .ai-custom-input { 
            width: 100%; padding: 10px; background: #111827; border: 1px solid var(--border); 
            color: white; border-radius: 8px; outline: none; font-size: 0.9rem;
        }
        
        .segmented-control { display: flex; background: #111827; padding: 4px; border-radius: 8px; gap: 2px; margin-top: 5px; border: 1px solid var(--border);}
        .level-btn { flex: 1; padding: 6px; border: none; border-radius: 6px; background: transparent; color: #9ca3af; font-size: 0.75rem; cursor: pointer; }
        .level-btn.selected { background: var(--bg-panel); color: white; border: 1px solid var(--border); }
        
        .flag-group { display: flex; gap: 10px; margin-top: 5px; }
        .flag-btn { 
            width: 40px; height: 40px; border-radius: 50%; background: #111827; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; filter: grayscale(100%); opacity: 0.5;
        }
        .flag-btn.selected { filter: grayscale(0%); opacity: 1; border-color: var(--primary); }
        .flag-btn.hidden { display: none; }
        
        .ai-footer-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-ai-action { 
            flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
        }
        .btn-ai-primary { background: var(--primary); color: white; }
        .btn-ai-primary:hover { background: var(--primary-light); }
        #btn-paste-json { background: #374151; color: white; }
        
        .saved-exercises-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; background: #111827; }
        .saved-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-size: 0.85rem;}
        .saved-item:last-child { border-bottom: none; }
        .mem-actions { margin-left: auto; display: flex; gap: 5px; }

        /* Helper Classes */
        #translation-tooltip {
            position: fixed; background: var(--primary); color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
            z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        
        b { color: var(--primary-light); }
        i { color: #f472b6; }
        u { text-decoration-color: var(--highlight); text-decoration-thickness: 2px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="tool-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        
        <div class="brand">MDC Ultimate</div>
        
        <div class="format-group">
            <button class="tool-btn" onclick="formatText('bold')"><b>B</b></button>
            <button class="tool-btn" onclick="formatText('italic')"><i>I</i></button>
            <button class="tool-btn" onclick="formatText('underline')"><u>U</u></button>
        </div>

        <button class="tool-btn" onclick="createBlock()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            <span style="display:none; @media(min-width:768px){display:inline;}">New</span>
        </button>
        
        <button class="tool-btn ai-trigger" onclick="openAIMenu()">
            <span>‚ö° AI Hub</span>
        </button>

        <button class="tool-btn" onclick="saveDocumentManual()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
        </button>
        
        <div class="study-group">
            <span id="save-status">Autosaved</span>
            <button class="tool-btn" id="btn-speed" onclick="cycleSpeed()" title="Playback Speed">1.0x</button>
            <button class="tool-btn" id="btn-blur-en" onclick="toggleBlur('en')">üëÅÔ∏è EN</button>
            <button class="tool-btn" id="btn-blur-es" onclick="toggleBlur('es')">üëÅÔ∏è ES</button>
        </div>
    </div>

    <div class="workspace">
        <div class="sidebar" id="main-sidebar">
            <div class="sidebar-content" id="sidebar-list"></div>
        </div>

        <div class="editor-container" id="editor-area" onclick="closeSidebarMobile()">
            <input type="text" class="document-title" id="doc-title" placeholder="Lesson Title...">
            <div id="blocks-wrapper"></div>
        </div>
    </div>

    <div id="translation-tooltip">Translation</div>

    <div class="ai-popup-overlay" id="ai-hub-modal">
        <div class="ai-popup-box">
            <div class="ai-header">
                <span>‚ö° Polyglot AI Hub (Dark)</span>
                <button class="ai-close" onclick="closeAIMenu()">√ó</button>
            </div>
            
            <div class="ai-body">
                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üåç Context</div>
                        <select id="ai-context-select" class="ai-select">
                            <option value="" selected disabled>Select Context...</option>
                            <optgroup label="üìö Vocabulary Builder DB">
                                <option value="vb_last_5">Last 5 Saved Words</option>
                                <option value="vb_last_10">Last 10 Saved Words</option>
                                <option value="vb_random">Random Selection (15)</option>
                            </optgroup>
                            <optgroup label="üè† Daily Life">
                                <option value="Daily Routine & Habits">Daily Routine & Habits</option>
                                <option value="Family & Relationships">Family & Relationships</option>
                                <option value="Food, Cooking & Restaurants">Food, Cooking & Restaurants</option>
                            </optgroup>
                            <optgroup label="üíº Work">
                                <option value="Job Interviews">Job Interviews</option>
                                <option value="Business Meetings">Meetings & Strategy</option>
                                <option value="Tech & IT">Tech & IT</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-context-custom" class="ai-custom-input" placeholder="Or type custom context...">
                    </div>

                    <div class="ai-card-group">
                        <div class="ai-card-label">üß† Grammar</div>
                        <select id="ai-grammar-select" class="ai-select">
                            <option value="" selected disabled>Select Grammar...</option>
                            <optgroup label="üïí Present Tenses">
                                <option value="Present Simple">Present Simple</option>
                                <option value="Present Continuous">Present Continuous</option>
                                <option value="Present Perfect">Present Perfect</option>
                            </optgroup>
                            <optgroup label="üîô Past Tenses">
                                <option value="Past Simple">Past Simple</option>
                                <option value="Past Continuous">Past Continuous</option>
                            </optgroup>
                            <optgroup label="‚öôÔ∏è Advanced">
                                <option value="Conditionals">Conditionals</option>
                                <option value="Passive Voice">Passive Voice</option>
                                <option value="Phrasal Verbs">Phrasal Verbs</option>
                            </optgroup>
                        </select>
                        <input type="text" id="ai-grammar-custom" class="ai-custom-input" placeholder="Or type custom grammar...">
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div class="ai-card-group">
                        <div class="ai-card-label">üìù Format</div>
                        <select id="ai-type-select" class="ai-select">
                            <option value="" selected disabled>Select Format...</option>
                            <option value="Fill in the Blanks (Cloze)">Fill in the Blanks (Cloze)</option>
                            <option value="Multiple Choice Quiz">Multiple Choice Quiz</option>
                            <option value="Find and Fix the Mistake">Find and Fix the Mistake</option>
                            <option value="Sentence Reordering">Sentence Reordering</option>
                            <option value="True or False (Reading)">True or False</option>
                            <option value="Vocabulary Matching">Vocabulary Matching</option>
                            <option value="Reverse Translation">Reverse Translation</option>
                        </select>
                        <input type="text" id="ai-type-custom" class="ai-custom-input" placeholder="Custom format...">
                    </div>

                    <div class="ai-card-group" style="justify-content: space-between;">
                        <div>
                             <div class="ai-card-label">‚öôÔ∏è Settings</div> 
                             <div style="display: flex; gap: 5px;"> 
                                 <select id="ai-gap-count" class="ai-select" style="flex: 1;" title="Gaps">
                                     <option value="1" selected>1 Gap</option>
                                     <option value="2">2 Gaps</option>
                                     <option value="3">3 Gaps</option>
                                 </select>
                                 <select id="ai-option-count" class="ai-select" style="flex: 1;" title="Options">
                                     <option value="3">3 Opts</option>
                                     <option value="4" selected>4 Opts</option>
                                 </select>
                                 <select id="ai-sentence-count" class="ai-select" style="flex: 1;" title="Qty">
                                     <option value="3">3 Qs</option>
                                     <option value="6" selected>6 Qs</option>
                                     <option value="9">9 Qs</option>
                                 </select>
                             </div>
                        </div>
                        <div class="segmented-control">
                            <button class="level-btn" onclick="selectLevel(this, 'A1-A2 (Beginner)')">A1-A2</button>
                            <button class="level-btn selected" onclick="selectLevel(this, 'B1-B2 (Intermediate)')">B1-B2</button>
                            <button class="level-btn" onclick="selectLevel(this, 'C1-C2 (Advanced)')">C1-C2</button>
                        </div>
                    </div>
                </div>

                <div class="ai-grid-2">
                    <div>
                        <div class="ai-card-label">üéØ Target</div>
                        <div class="flag-group" id="target-lang-group">
                            <div class="flag-btn selected" onclick="selectTarget(this, 'en')" title="English">üá∫üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'es')" title="Spanish">üá™üá∏</div>
                            <div class="flag-btn" onclick="selectTarget(this, 'pt')" title="Portuguese">üáßüá∑</div>
                        </div>
                    </div>
                    <div>
                        <div class="ai-card-label">üåê Translate</div>
                        <div class="flag-group" id="trans-lang-group">
                            <div class="flag-btn" data-lang="es" onclick="toggleTrans(this, 'es')">üá™üá∏</div>
                            <div class="flag-btn" data-lang="pt" onclick="toggleTrans(this, 'pt')">üáßüá∑</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top:10px;">
                    <textarea id="ai-extra-data" class="ai-custom-input" placeholder="Extra instructions (e.g., Use British slang, make it funny...)" style="min-height:60px;"></textarea>
                </div>

                <div class="ai-footer-actions">
                    <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">
                        <span>‚ú®</span> Create Mission
                    </button>
                    <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">
                        <span>üìã</span> Paste & Insert
                    </button>
                </div>

                <div style="margin-top: 20px;">
                    <div class="ai-card-label">üíæ Memory Bank</div>
                    <div class="saved-exercises-list" id="ai-memory-list"></div>
                    <div style="display:flex; justify-content:flex-end; padding-top:10px; gap:10px;">
                        <button class="mini-btn" onclick="exportMemoryBank()">‚¨áÔ∏è</button>
                        <input type="file" id="importMemFile" accept=".json" style="display:none" onchange="importMemoryBank(this)">
                         <button class="mini-btn" onclick="document.getElementById('importMemFile').click()">‚¨ÜÔ∏è</button>
                        <button class="mini-btn delete" onclick="clearAIMemory()">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    /* ================= 1. CORE SYSTEM CONFIG ================= */
    const DB_KEY = 'mdc_vocab_list';
    const DOC_KEY = 'mdc_smart_editor_v8_doc';
    const AI_MEM_KEY = 'mdc_ai_exercises';
    
    let hoverTimer;
    let currentTooltip = document.getElementById('translation-tooltip');
    let recognition;
    let isRecording = false;
    let currentRecordingBtn = null;
    let activeLangContext = 'en'; 
    let lastFocusedInput = null;
    let speechRate = 1.0;
    
    // AI STATE
    let currentTargetLang = 'en'; 
    let currentLevel = 'B1-B2 (Intermediate)';
    const transLangs = new Set(['es']); 
    const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian' };

    /* ================= 2. INITIALIZATION ================= */
    document.addEventListener('DOMContentLoaded', () => {
        loadSidebar(); // Original Code A functionality
        loadDocument(); // Hybrid Loader
        renderAiList(); // Code B functionality
        initCustomDropdowns(); // Polyglot UI
        
        if(document.getElementById('blocks-wrapper').children.length === 0) createBlock();
    });

    /* ================= 3. SPEECH RECOGNITION (CODE A) ================= */
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.onresult = function(event) {
            if(currentRecordingBtn) {
                const text = event.results[0][0].transcript;
                const pair = currentRecordingBtn.closest('.sentence-pair');
                let targetRow = (activeLangContext === 'es') ? pair.querySelector('.row-es') : pair.querySelector('.row-en');
                if(targetRow.innerText.trim() === '') targetRow.innerText = text;
                else targetRow.innerText += " " + text;
                autoSave();
            }
        };
        recognition.onend = function() {
            isRecording = false;
            if(currentRecordingBtn) currentRecordingBtn.classList.remove('recording');
            currentRecordingBtn = null;
        };
    }

    /* ================= 4. SIDEBAR LOGIC (RESTORED CODE A) ================= */
    const STATIC_GRAMMAR = [
      { name: "Pronouns", words: ["I", "You", "He", "She", "It", "We", "They", "Me", "Him", "Her", "Us", "Them"] },
      { name: "Verbs", words: ["Be", "Have", "Do", "Say", "Go", "Get", "Make", "Know", "Think", "Take"] },
      { name: "Adjectives", words: ["Good", "New", "First", "Last", "Long", "Great", "Little", "Own", "Other"] },
      { name: "Connectors", words: ["And", "But", "Because", "So", "However", "Although", "Unless"] }
    ];

    function loadSidebar() {
        const raw = localStorage.getItem(DB_KEY);
        const list = document.getElementById('sidebar-list');
        list.innerHTML = ''; 

        // Load User DB
        if (raw) {
            const data = JSON.parse(raw);
            const folders = data.filter(i => i.isFolder);
            if (folders.length > 0) {
                const header = document.createElement('div');
                header.className = 'sidebar-header'; header.innerText = 'My Database';
                list.appendChild(header);
                folders.forEach(folder => {
                    const folderEl = document.createElement('div');
                    folderEl.className = 'db-folder';
                    folderEl.innerHTML = `
                        <div class="db-folder-title" onclick="this.parentElement.classList.toggle('open')">
                            <span>üìÇ ${folder.name}</span> <span style="font-size:0.8em; opacity:0.7">${folder.items.length}</span>
                        </div>
                        <div class="db-folder-items"></div>
                    `;
                    const container = folderEl.querySelector('.db-folder-items');
                    folder.items.forEach(item => { if(item && item.eng) container.appendChild(createDraggableChip(item.eng)); });
                    list.appendChild(folderEl);
                });
            }
        }
        // Load Static Grammar
        if(STATIC_GRAMMAR.length > 0) {
            const gramHeader = document.createElement('div');
            gramHeader.className = 'sidebar-header'; gramHeader.innerText = 'Grammar Helper';
            list.appendChild(gramHeader);
            STATIC_GRAMMAR.forEach(cat => {
                const catEl = document.createElement('div');
                catEl.className = 'db-folder';
                catEl.innerHTML = `<div class="db-folder-title" onclick="this.parentElement.classList.toggle('open')"><span>üìö ${cat.name}</span></div><div class="db-folder-items"></div>`;
                const container = catEl.querySelector('.db-folder-items');
                cat.words.forEach(word => container.appendChild(createDraggableChip(word)));
                list.appendChild(catEl);
            });
        }
    }

    function createDraggableChip(text) {
        const chip = document.createElement('div');
        chip.className = 'draggable-word';
        chip.draggable = true;
        chip.innerHTML = `<span class="chip-text">${text}</span><button class="chip-audio-btn">üîä</button>`;
        
        chip.ondragstart = (e) => { e.dataTransfer.setData('text/plain', text); e.dataTransfer.effectAllowed = 'copy'; };
        
        chip.onclick = (e) => {
            if (e.target.closest('.chip-audio-btn')) { e.stopPropagation(); speakText(text, 'en'); return; }
            if (lastFocusedInput) {
                lastFocusedInput.focus();
                document.execCommand('insertText', false, " " + text + " ");
                autoSave();
            } else alert("Select an input first.");
        };
        return chip;
    }

    /* ================= 5. EDITOR BLOCKS & HYBRID LOGIC ================= */
    function createBlock(lessonText = '', pairsData = []) {
        const wrapper = document.getElementById('blocks-wrapper');
        const block = document.createElement('div');
        block.className = 'editor-block standard-block';
        const showLesson = lessonText.trim().length > 0 ? 'style="display:block;"' : '';
        block.innerHTML = `
            <div class="block-header">
                <div class="block-label">Standard Block</div>
                <div style="display:flex; gap:5px;">
                    <button class="mini-btn ${lessonText?'book-active':''}" onclick="toggleLesson(this)">üìñ</button>
                    <button class="mini-btn block-delete" onclick="removeBlock(this)">‚úï</button>
                </div>
            </div>
            <div class="lesson-drawer" ${showLesson}><textarea placeholder="Paste notes..." oninput="autoSave()">${lessonText}</textarea></div>
            <div class="pairs-container"></div>
        `;
        wrapper.appendChild(block);
        const pairsContainer = block.querySelector('.pairs-container');
        if(pairsData.length > 0) pairsData.forEach(p => addPair(pairsContainer, p.en, p.es));
        else addPair(pairsContainer);
        block.scrollIntoView({ behavior: 'smooth' });
    }

    function createAIBlock(htmlContent) {
        const wrapper = document.getElementById('blocks-wrapper');
        const block = document.createElement('div');
        block.className = 'editor-block ai-block';
        block.innerHTML = `
            <div class="block-header">
                <div class="block-label" style="color:var(--primary-light)">‚ö° AI Exercise</div>
                <div style="display:flex; gap:5px;">
                     <button class="mini-btn" onclick="resetAIBlock(this)" title="Reset Inputs">‚Ü∫</button>
                    <button class="mini-btn block-delete" onclick="removeBlock(this)">‚úï</button>
                </div>
            </div>
            <div class="ai-content">${htmlContent}</div>
        `;
        wrapper.appendChild(block);
        block.scrollIntoView({ behavior: 'smooth' });
    }

    function addPair(container, enText = '', esText = '', focusEn = false) {
        const pair = document.createElement('div');
        pair.className = 'sentence-pair';
        pair.innerHTML = `
            <div class="pair-inputs">
                <div class="row-wrapper"><div class="input-row row-en" contenteditable="true" data-placeholder="English..." oninput="autoSave()" onmousemove="handleHover(event)" onmouseleave="hideTooltip()" onpaste="handlePaste(event)">${enText}</div><div class="lang-flag flag-en"></div></div>
                <div class="row-wrapper"><div class="input-row row-es" contenteditable="true" data-placeholder="Espa√±ol..." oninput="autoSave()">${esText}</div><div class="lang-flag flag-es"></div></div>
            </div>
            <div class="pair-controls">
                <button class="mini-btn" onclick="toggleRecord(this)">üé§</button>
                <button class="mini-btn" onclick="speakPair(this)">üîä</button>
                <button class="mini-btn" onclick="translatePair(this)">üåê</button>
                <button class="mini-btn delete" onclick="deletePair(this)">‚úï</button>
            </div>
        `;
        container.appendChild(pair);
        const en = pair.querySelector('.row-en');
        const es = pair.querySelector('.row-es');
        const handleFocus = (e, lang) => { activeLangContext = lang; if(lastFocusedInput) lastFocusedInput.classList.remove('active-focus'); lastFocusedInput = e.target; lastFocusedInput.classList.add('active-focus'); };
        en.onfocus = (e) => handleFocus(e, 'en'); es.onfocus = (e) => handleFocus(e, 'es');
        en.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); es.focus(); } });
        es.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); addPair(container, '', '', true); } });
        if(focusEn) setTimeout(() => en.focus(), 10);
    }

    /* ================= 6. SAVING & LOADING (HYBRID SYSTEM) ================= */
    function saveDocument() {
        const title = document.getElementById('doc-title').value;
        const blocksData = [];
        document.querySelectorAll('.editor-block').forEach(block => {
            if (block.classList.contains('standard-block')) {
                const lesson = block.querySelector('.lesson-drawer textarea').value;
                const pairs = [];
                block.querySelectorAll('.sentence-pair').forEach(pair => {
                    pairs.push({ en: pair.querySelector('.row-en').innerHTML, es: pair.querySelector('.row-es').innerHTML });
                });
                blocksData.push({ type: 'std', lesson, pairs });
            } else if (block.classList.contains('ai-block')) {
                blocksData.push({ type: 'ai', html: block.querySelector('.ai-content').innerHTML });
            }
        });
        localStorage.setItem(DOC_KEY, JSON.stringify({ title, blocks: blocksData, date: Date.now() }));
    }

    function loadDocument() {
        const raw = localStorage.getItem(DOC_KEY); if(!raw) return;
        const data = JSON.parse(raw);
        document.getElementById('doc-title').value = data.title || '';
        document.getElementById('blocks-wrapper').innerHTML = '';
        if(data.blocks && data.blocks.length > 0) {
            data.blocks.forEach(b => {
                if(b.type === 'ai') createAIBlock(b.html);
                else createBlock(b.lesson || '', b.pairs || []);
            });
        }
    }
    
    function autoSave(){ saveDocument(); const s=document.getElementById('save-status'); s.classList.add('visible'); setTimeout(()=>s.classList.remove('visible'),2000); }
    function saveDocumentManual(){ saveDocument(); const s=document.getElementById('save-status'); s.innerText="Saved!"; s.classList.add('visible'); setTimeout(()=>{ s.classList.remove('visible'); s.innerText="Autosaved"; },2000); }

    /* ================= 7. AI HUB LOGIC (FULL POLYGLOT ENGINE) ================= */
    function openAIMenu() { document.getElementById('ai-hub-modal').classList.add('active'); renderAiList(); }
    function closeAIMenu() { document.getElementById('ai-hub-modal').classList.remove('active'); }
    function selectTarget(el, lang) { document.querySelectorAll('#target-lang-group .flag-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentTargetLang = lang; }
    function selectLevel(el, level) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentLevel = level; }
    function toggleTrans(el, lang) { if(transLangs.has(lang)) { transLangs.delete(lang); el.classList.remove('selected'); } else { transLangs.add(lang); el.classList.add('selected'); } }

    /* --- DB Helper for AI --- */
    function getDbWords(mode, count) {
        const raw = localStorage.getItem(DB_KEY); if(!raw) return [];
        const data = JSON.parse(raw);
        let allWords = [];
        const extract = (list) => { list.forEach(item => { if(item.isFolder) extract(item.items); else if(item.eng) allWords.push(item.eng); }); };
        extract(data);
        if(mode === 'last') return allWords.slice(0, count);
        if(mode === 'random') return allWords.sort(() => 0.5 - Math.random()).slice(0, count);
        return [];
    }

    function copyProfessorPrompt() {
        // Data Collection
        const ctxSel = document.getElementById('ai-context-select').value;
        const graSel = document.getElementById('ai-grammar-select').value;
        const typSel = document.getElementById('ai-type-select').value;
        const gapCount = document.getElementById('ai-gap-count').value;
        let finalOptionCount = document.getElementById('ai-option-count').value;
        const ctxCust = document.getElementById('ai-context-custom').value.trim();
        const graCust = document.getElementById('ai-grammar-custom').value.trim();
        const typCust = document.getElementById('ai-type-custom').value.trim();
        const extraData = document.getElementById('ai-extra-data').value.trim();
        const quantity = document.getElementById('ai-sentence-count').value || 6;

        // Logic Tweaks
        const fullTypeCheck = (typSel || "").toLowerCase();
        if (fullTypeCheck.includes("true") || fullTypeCheck.includes("reading")) finalOptionCount = 2;

        let contextInstruction = ctxCust ? `Custom Topic: "${ctxCust}"` : (ctxSel ? `Topic: "${ctxSel}"` : "General Daily Life");
        
        // DB Injection
        let dbWords = [];
        if (ctxSel && ctxSel.startsWith('vb_')) {
            let mode = ctxSel.replace('vb_', '');
            dbWords = getDbWords(mode === 'random' ? 'random' : 'last', mode === 'random' ? 15 : parseInt(mode.split('_')[1] || 10));
        }
        let vocabBlock = dbWords.length > 0 ? `VOCABULARY INJECTION: [${dbWords.join(', ')}]. Use 1-2 words per sentence naturally.` : "";

        // Rules Setup
        const fullType = (typSel + " " + typCust).toLowerCase();
        let gapRule = '3. GAPS: Format is "{correct|distractor1...}". Correct answer FIRST.';
        let distractorRule = "4. DISTRACTORS: Plausible but incorrect.";
        let clozeExample = '"She {went|goes} to school."'; 

        if (fullType.includes("fix")) { clozeExample = '"He <s>goed</s> {went|gone} to school."'; }
        if (fullType.includes("reordering")) { gapRule = '3. GAPS: Hide a CRITICAL SEGMENT (3-5 words).'; distractorRule = '4. DISTRACTORS: Same words scrambled.'; }
        if (fullType.includes("translation") || fullType.includes("reverse")) { gapRule = '3. GAPS: "<b>Source Sentence</b><br>{CorrectTarget|WrongTarget}".'; clozeExample = '"<b>Hola</b><br>{Hello|Hi}"'; }
        if (fullType.includes("odd")) { gapRule = '3. GAPS: "{Intruder|Member1|Member2}".'; clozeExample = '"Which is odd? {Car|Apple|Banana}"'; }
        if (fullType.includes("matching")) { clozeExample = '"A domestic feline is a {cat|dog|bird}."'; }
        if (fullType.includes("true")) { gapRule = '3. GAPS: "{True|False}".'; clozeExample = '"Sun is cold. {False|True}"'; }

        // TypeScript Interface
        const activeTransLangs = Array.from(transLangs);
        const transType = activeTransLangs.length > 0 ? activeTransLangs.map(l => `${l}: string`).join('; ') : '// None';
        
        const promptText = `
        ROLE: Expert ${LANG_NAMES[currentTargetLang]} Linguist & JSON Generator.
        TASK: Generate valid JSON.
        SETTINGS: Level: ${currentLevel}. Qty: ${quantity}. Grammar: ${graCust||graSel||"General"}. ${contextInstruction}. Format: ${typCust||typSel}. Gaps: ${gapCount}. Options: ${finalOptionCount}.
        ${vocabBlock}
        EXTRA: ${extraData}

        STRICT TYPESCRIPT INTERFACE:
        interface Exercise {
          title: string;
          lang_code: "${currentTargetLang}";
          theory: string; // HTML allowed <b>, <ul>
          exercises: Array<{
            full_sentence: string; 
            cloze_text: string; // Syntax: ${clozeExample}
            hint: string;
            translations: { ${transType} };
          }>;
        }

        RULES:
        1. OUTPUT RAW JSON ONLY. No markdown.
        2. LANG: Target is ${LANG_NAMES[currentTargetLang]}.
        ${gapRule}
        ${distractorRule}
        6. JSON SAFETY: Use single quotes (') inside strings.
        `;

        navigator.clipboard.writeText(promptText).then(() => {
            const btn = document.querySelector('.btn-ai-primary'); 
            const orig = btn.innerText; btn.innerText = "‚úÖ Copied!"; setTimeout(() => btn.innerText = orig, 2000);
        });
    }

    async function pasteAIJson() {
        let jsonString = "";
        try { jsonString = await navigator.clipboard.readText(); } catch (err) { jsonString = prompt("Paste JSON here:"); }
        if (!jsonString) return;
        
        try {
            let clean = jsonString.trim().replace(/```json|```/g, '');
            const start = clean.indexOf('{'); const end = clean.lastIndexOf('}');
            if (start === -1 || end === -1) throw new Error("No JSON found");
            clean = clean.substring(start, end + 1);
            
            let aiData = JSON.parse(clean);
            let finalData = Array.isArray(aiData) ? { title: "AI Set", exercises: aiData } : aiData;

            // Save to Memory
            const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
            const newItem = { 
                id: Date.now(), 
                title: finalData.title || "Untitled", 
                lang: finalData.lang_code || currentTargetLang, 
                theory: finalData.theory || "", 
                date: new Date().toLocaleTimeString(), 
                data: finalData.exercises 
            };
            memory.unshift(newItem);
            localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
            renderAiList();
            
            // Insert Block Immediately
            insertExerciseFromMem(newItem.id);
            
        } catch (e) { alert("JSON Error: " + e.message); }
    }

    function renderAiList() {
        const list = document.getElementById('ai-memory-list');
        const mem = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        list.innerHTML = '';
        if (mem.length === 0) { list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Empty</div>'; return; }
        mem.forEach(item => {
            const div = document.createElement('div');
            div.className = 'saved-item';
            div.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:700;color:white;">${item.title}</div>
                    <div style="font-size:0.7rem;color:#999">${item.data.length} Qs ‚Ä¢ ${item.date}</div>
                </div>
                <div class="mem-actions">
                    <button class="mini-btn" onclick="insertExerciseFromMem(${item.id})">üì•</button>
                    <button class="mini-btn" onclick="exportSingleItem(${item.id})">‚¨áÔ∏è</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function insertExerciseFromMem(id) {
        const mem = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
        const item = mem.find(x => x.id === id); if (!item) return;
        
        let html = `<div class="exercise-box">
            <div class="exercise-header">
                <span>‚úçÔ∏è ${item.title}</span>
                <button class="btn-theory" onclick="this.parentElement.parentElement.parentElement.querySelector('.theory-box').style.display = 'block'">üìò Theory</button>
            </div>
            <div class="theory-box">${item.theory || "No theory."}</div>`;
            
        item.data.forEach((ex, index) => {
            let parsedHtml = ex.cloze_text.replace(/\{([^}]+)\}/g, (match, content) => {
                const parts = content.split('|');
                const correct = parts[0];
                const shuffled = [...parts].sort(() => Math.random() - 0.5);
                let opts = `<option value="" disabled selected>...</option>`;
                shuffled.forEach(opt => opts += `<option value="${opt.replace(/"/g, '&quot;')}">${opt}</option>`);
                return `<select class="ex-select" onchange="window.validateEx(this, '${correct.replace(/'/g, "\\'")}')">${opts}</select>`;
            });
            
            let transHtml = "";
            if (ex.translations) {
                for (const [key, val] of Object.entries(ex.translations)) {
                    transHtml += `<div class="trans-line"><button class="mini-btn" style="width:24px;height:24px;font-size:0.7rem" onclick="speakText('${val.replace(/'/g, "\\'")}', '${key}')">üîä</button> <span style="font-size:0.8rem;color:#aaa">${key.toUpperCase()}: ${val}</span></div>`;
                }
            }

            html += `<div class="exercise-row">
                <div style="width:100%; margin-bottom:5px;"><b>${index + 1}.</b> ${parsedHtml}</div>
                <div style="display:flex; gap:5px; width:100%">
                    <button class="ex-btn-icon" onclick="speakText('${ex.full_sentence.replace(/'/g, "\\'")}', '${item.lang}')">üîä</button>
                    <button class="ex-btn-icon" onclick="this.parentElement.parentElement.querySelector('.trans-box').style.display='block'">üåê</button>
                    <button class="ex-btn-icon" onclick="this.parentElement.parentElement.querySelector('.hint-box').style.display='block'">üí°</button>
                </div>
                <div class="hint-box">üí° ${ex.hint}</div>
                <div class="trans-box">${transHtml}</div>
            </div>`;
        });
        html += `</div>`;
        createAIBlock(html);
        closeAIMenu();
        saveDocument();
    }

    // AI Memory Utils
    function exportMemoryBank() { const data = localStorage.getItem(AI_MEM_KEY); const blob = new Blob([data], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'mdc_ai_mem.json'; a.click(); }
    function importMemoryBank(input) { const f = input.files[0]; const r = new FileReader(); r.onload = (e) => { const d = JSON.parse(e.target.result); const cur = JSON.parse(localStorage.getItem(AI_MEM_KEY)||'[]'); localStorage.setItem(AI_MEM_KEY, JSON.stringify([...d, ...cur])); renderAiList(); }; r.readAsText(f); }
    function clearAIMemory() { if(confirm("Delete All History?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }
    function exportSingleItem(id) { const m = JSON.parse(localStorage.getItem(AI_MEM_KEY)); const i = m.find(x=>x.id===id); const b = new Blob([JSON.stringify([i])], {type:'json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'exercise.json'; a.click(); }

    /* ================= 8. GLOBAL UTILS & HELPERS ================= */
    window.validateEx = function(s, correct) {
        s.classList.remove('correct', 'wrong');
        if (s.value === correct) s.classList.add('correct'); else s.classList.add('wrong');
        // Persist selection for saving
        const opts = s.querySelectorAll('option'); opts.forEach(o => o.removeAttribute('selected'));
        s.options[s.selectedIndex].setAttribute('selected', 'selected');
        saveDocument();
    };

    window.speakText = function(text, lang) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang === 'es' ? 'es-ES' : (lang === 'pt' ? 'pt-BR' : 'en-US');
        u.rate = speechRate;
        window.speechSynthesis.speak(u);
    };

    function resetAIBlock(btn) {
        const box = btn.closest('.editor-block').querySelector('.exercise-box');
        box.querySelectorAll('select').forEach(s => { s.classList.remove('correct', 'wrong'); s.selectedIndex = 0; s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); });
        saveDocument();
    }

    // Sidebar UI
    function toggleSidebar() { const s = document.getElementById('main-sidebar'); if (window.innerWidth < 768) s.classList.toggle('mobile-open'); else s.classList.toggle('collapsed'); }
    function closeSidebarMobile() { if (window.innerWidth < 768) document.getElementById('main-sidebar').classList.remove('mobile-open'); }
    
    // Tools
    function cycleSpeed() { const b = document.getElementById('btn-speed'); speechRate = (speechRate===1.0)?0.75:(speechRate===0.75?0.5:1.0); b.innerText = speechRate + "x"; }
    function toggleBlur(l) { document.body.classList.toggle(`blur-${l}`); document.getElementById(`btn-blur-${l}`).classList.toggle('active'); }
    function formatText(c){ document.execCommand(c,false,null); }
    function toggleRecord(btn) { 
        if (!recognition) return alert("Not supported"); 
        if (isRecording) { recognition.stop(); return; }
        currentRecordingBtn = btn; btn.classList.add('recording'); recognition.lang = (activeLangContext === 'es') ? 'es-ES' : 'en-US'; recognition.start(); isRecording = true; 
    }
    function toggleLesson(btn) { const d = btn.closest('.editor-block').querySelector('.lesson-drawer'); d.style.display = (d.style.display === 'block') ? 'none' : 'block'; btn.classList.toggle('book-active'); autoSave(); }
    function removeBlock(btn) { if(confirm("Delete?")) { btn.closest('.editor-block').remove(); autoSave(); } }
    function deletePair(btn) { const p=btn.closest('.sentence-pair'); if(p.parentElement.children.length===1){p.querySelector('.row-en').innerText='';p.querySelector('.row-es').innerText='';}else{p.remove();} autoSave(); }
    function speakPair(btn) { const t=btn.closest('.sentence-pair').querySelector('.row-en').innerText; speakText(t,'en'); }
    async function translatePair(btn) {
        const p=btn.closest('.sentence-pair'); const en=p.querySelector('.row-en'); const es=p.querySelector('.row-es');
        if(en.innerText.trim()){ es.style.opacity=0.5; const r=await ft(en.innerText,'en','es'); es.style.opacity=1; if(r) es.innerText=r; }
        else if(es.innerText.trim()){ en.style.opacity=0.5; const r=await ft(es.innerText,'es','en'); en.style.opacity=1; if(r) en.innerText=r; }
        autoSave();
    }
    async function ft(t,s,l){ try{const r=await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${s}&tl=${l}&dt=t&q=${encodeURIComponent(t)}`);const d=await r.json();return d[0][0][0];}catch(e){return null;}}
    function handleHover(e){ 
        if(e.target.nodeName!=='DIV')return; clearTimeout(hoverTimer);
        const r=document.caretRangeFromPoint(e.clientX,e.clientY); if(!r||!r.startContainer.textContent)return;
        const t=r.startContainer.textContent; let s=r.startOffset,n=r.startOffset;
        while(s>0&&/\w/.test(t.charAt(s-1)))s--; while(n<t.length&&/\w/.test(t.charAt(n)))n++;
        const w=t.slice(s,n).trim(); if(w.length>2){ hoverTimer=setTimeout(async()=>{ const tr=await ft(w,'en','es'); if(tr){ currentTooltip.innerText=`${w}‚Üí${tr}`; currentTooltip.style.left=(e.clientX+10)+'px'; currentTooltip.style.top=(e.clientY+20)+'px'; currentTooltip.style.opacity=1; } },500); }
    }
    function hideTooltip(){ clearTimeout(hoverTimer); currentTooltip.style.opacity=0; }
    function handlePaste(e){ e.preventDefault(); document.execCommand('insertText',false,(e.originalEvent||e).clipboardData.getData('text/plain')); }

    // Custom Dropdowns (Polyglot Style adapted to Dark)
    function initCustomDropdowns() {
        document.querySelectorAll('.ai-select').forEach(select => {
            const wrapper = document.createElement('div'); wrapper.className = 'custom-select-wrapper';
            select.parentNode.insertBefore(wrapper, select); wrapper.appendChild(select);
            const trigger = document.createElement('div'); trigger.className = 'custom-select-trigger';
            trigger.innerHTML = `<span>${select.options[select.selectedIndex].text}</span> <span>‚ñº</span>`;
            wrapper.appendChild(trigger);
            const opts = document.createElement('div'); opts.className = 'custom-options'; wrapper.appendChild(opts);
            Array.from(select.children).forEach(child => {
                if(child.tagName === 'OPTGROUP') {
                    const h = document.createElement('div'); h.className='custom-group-header'; h.innerText=child.label; opts.appendChild(h);
                    Array.from(child.children).forEach(o => createOpt(o, opts, trigger, select, wrapper));
                } else createOpt(child, opts, trigger, select, wrapper);
            });
            trigger.onclick = (e) => { e.stopPropagation(); document.querySelectorAll('.custom-select-wrapper').forEach(w=>w!==wrapper && w.classList.remove('open')); wrapper.classList.toggle('open'); };
        });
        document.onclick = () => document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
    }
    function createOpt(opt, container, trigger, select, wrapper) {
        if(opt.disabled) return;
        const d = document.createElement('div'); d.className = 'custom-option'; d.innerText = opt.text;
        if(opt.selected) d.classList.add('selected');
        d.onclick = (e) => {
            e.stopPropagation(); select.value=opt.value; trigger.innerHTML=`<span>${opt.text}</span> <span>‚ñº</span>`;
            container.querySelectorAll('.custom-option').forEach(x=>x.classList.remove('selected')); d.classList.add('selected');
            wrapper.classList.remove('open');
        };
        container.appendChild(d);
    }
</script>
</body>
</html>
