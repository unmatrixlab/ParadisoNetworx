<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doc Expert</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --header-bg: #1a1a1a;
            --accent: #2563eb;
            --bubble-user: #2563eb;
            --bubble-ai: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color); margin: 0; height: 100dvh; display: flex; flex-direction: column;
            position: fixed; width: 100%;
        }

        /* HEADER & CONTROLS */
        .top-section { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 100; }
        .app-header { background: var(--header-bg); color: #fff; padding: 15px; text-align: center; font-weight: 700; font-size: 1rem; }
        
        .controls-container { padding: 10px; display: flex; justify-content: center; border-bottom: 1px solid #e5e7eb; }
        
        /* Language Toggle - Simple & Elegant */
        .lang-toggle {
            display: flex; background: #e5e7eb; border-radius: 20px; padding: 4px; gap: 4px;
        }
        .t-btn {
            border: none; background: transparent; padding: 8px 16px; border-radius: 16px;
            font-size: 0.9rem; font-weight: 500; color: #4b5563; cursor: pointer; transition: all 0.2s;
        }
        .t-btn.active { background: #fff; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 700; }

        /* CHAT AREA */
        #chat-view { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        
        .msg-row { display: flex; width: 100%; }
        .msg-row.user { justify-content: flex-end; }
        .msg-row.ai { justify-content: flex-start; }

        .bubble { max-width: 90%; padding: 14px 18px; border-radius: 18px; font-size: 1rem; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .bubble.user { background: var(--bubble-user); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.ai { background: var(--bubble-ai); color: #1f2937; border-bottom-left-radius: 4px; border: 1px solid #e5e7eb; }
        .bubble p { margin: 0 0 10px 0; } .bubble p:last-child { margin: 0; }
        .bubble strong { font-weight: 700; color: #000; }
        
        /* INPUT */
        .bottom-bar { background: #fff; padding: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; }
        .bottom-bar:disabled { opacity: 0.5; }
        #message-input { flex: 1; padding: 12px 16px; border-radius: 25px; border: 1px solid #d1d5db; font-size: 16px; outline: none; }
        #message-input:focus { border-color: var(--accent); }
        #send-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: var(--accent); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .typing { display: flex; gap: 4px; padding: 10px; }
        .dot { width: 6px; height: 6px; background: #9ca3af; border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body>

    <div class="top-section">
        <div class="app-header">PARADISO STUDIOS</div>
        <div class="controls-container">
            <div class="lang-toggle">
                <button class="t-btn active" onclick="setLang('ES', this)">Español</button>
                <button class="t-btn" onclick="setLang('EN', this)">English</button>
            </div>
        </div>
    </div>

    <div id="chat-view"></div>

    <div class="bottom-bar">
        <input type="text" id="message-input" placeholder="Pregunta sobre el documento..." autocomplete="off">
        <button id="send-btn">➤</button>
    </div>

    <script>
        // --- CONFIG ---
        const API_URL = "https://ai.paradisonetworx.com"; 
        const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjA4YTE5ZDI0LTAzMTktNDQ5ZS1hNTc0LWU3ZGZiMzRhYWUwZSIsImV4cCI6MTc3MDEzNjE5NiwianRpIjoiZWE4NDAyNWYtOTQwNi00MGVkLTg4MDAtNWJkYjIzZTcyODdhIn0.6DwQosJkJEdCPJbBWBfTsD1KmoUCSpZx0mPmeXCVX9U";
        
        // MODELO HARDCODED
        const MODEL_ID = 'experto-mistral';

        let currentLang = 'ES';
        let chatHistory = [];

        const chatView = document.getElementById('chat-view');
        const inputField = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        function setLang(lang, btn) {
            currentLang = lang;
            document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            inputField.placeholder = (lang === 'ES') ? "Pregunta sobre el documento..." : "Ask about the document...";
        }

        function renderChat() {
            chatView.innerHTML = '';
            // Eliminé el mensaje de bienvenida estático para que no choque con la pregunta automática
            if (chatHistory.length === 0) return;

            chatHistory.forEach(msg => {
                if(msg.role === 'system') return;
                const row = document.createElement('div'); row.className = `msg-row ${msg.role === 'user' ? 'user' : 'ai'}`;
                const bubble = document.createElement('div'); bubble.className = `bubble ${msg.role === 'user' ? 'user' : 'ai'}`;
                if (msg.role === 'assistant') {
                    try { bubble.innerHTML = marked.parse(msg.content); } catch (e) { bubble.textContent = msg.content; }
                } else { bubble.textContent = msg.content; }
                row.appendChild(bubble); chatView.appendChild(row);
            });
            chatView.scrollTop = chatView.scrollHeight;
        }

        // Modificado para aceptar texto automático
        async function handleSend(customText = null) {
            // Si customText es un evento (click) o null, usamos el input. Si es string, usamos el string.
            const isAuto = (typeof customText === 'string');
            const text = isAuto ? customText : inputField.value.trim();
            
            if(!text) return;
            
            // Solo limpiamos el input si fue manual
            if(!isAuto) inputField.value = ''; 
            
            sendBtn.disabled = true;

            chatHistory.push({ role: "user", content: text });
            renderChat();
            showTyping();

            // PROMPTS DUROS
            const sysPromptES = "ERES UN EXPERTO ANALISTA DE DOCUMENTOS. Tu memoria contiene un archivo importante. Tu trabajo es responder preguntas BASADO EXCLUSIVAMENTE EN EL CONTEXTO del documento proporcionado. Si no sabes la respuesta, di 'No aparece en el documento'. RESPUESTA EN ESPAÑOL.";
            const sysPromptEN = "YOU ARE AN EXPERT DOCUMENT ANALYST. Your memory contains an important file. Your job is to answer questions BASED EXCLUSIVELY ON THE CONTEXT of the provided document. If you don't know, say 'Not in document'. ANSWER IN ENGLISH.";

            const messagesPayload = [
                { role: "system", content: (currentLang === 'ES' ? sysPromptES : sysPromptEN) },
                ...chatHistory.slice(-6)
            ];

            try {
                const response = await fetch(`${API_URL}/api/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: MODEL_ID,
                        messages: messagesPayload,
                        temperature: 0.1,
                        max_tokens: 4096
                    })
                });

                if(!response.ok) throw new Error(`Status: ${response.status}`);
                const data = await response.json();
                const reply = data.choices?.[0]?.message?.content || "Error.";
                removeTyping();
                chatHistory.push({ role: "assistant", content: reply });
                renderChat();
            } catch (err) {
                removeTyping();
                chatHistory.push({ role: "assistant", content: `Error: ${err.message}` });
                renderChat();
            } finally { sendBtn.disabled = false; if(!isAuto) inputField.focus(); }
        }

        function showTyping() {
            const d=document.createElement('div'); d.id='typing'; d.className='msg-row ai';
            d.innerHTML='<div class="bubble ai"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';
            chatView.appendChild(d); chatView.scrollTop=chatView.scrollHeight;
        }
        function removeTyping() { const e=document.getElementById('typing'); if(e) e.remove(); }

        sendBtn.addEventListener('click', (e) => handleSend(null));
        inputField.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(null); });
        
        // --- AUTO-PREGUNTA AL INICIAR ---
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const autoQuestion = (currentLang === 'ES') 
                    ? "Prepara una lista de preguntas importantes que crees que debería hacer sobre este documento para entender sus riesgos."
                    : "Prepare a list of important questions you think I should ask about this document to understand its risks.";
                handleSend(autoQuestion);
            }, 800); // Pequeño retraso para efecto visual
        });

    </script>
</body>
</html>
