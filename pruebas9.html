<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDC - Polyglot Tutor V31</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Dancing+Script:wght=700&family=Playfair+Display:wght=600&family=Courier+Prime:wght=700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
<style>
        :root {
            --primary: #007AFF;
            --primary-dark: #005ec4;
            --primary-soft: #e3f2fd;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
            --bg-body: #F2F2F7;
            --text-main: #111111;
            --text-muted: #666666;
            --card-bg: #FFFFFF;
            --radius: 16px;
            --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.06);
            --header-height: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            padding-top: var(--header-height);
            padding-bottom: 60px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ====== TOP HEADER (Logo) ====== */
        #mdc-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: rgba(10, 20, 35, 0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #mdc-header a {
            text-decoration: none; font-weight: 900; font-size: 22px; letter-spacing: 1px;
            color: white; 
        }

        /* ====== NUEVA BARRA DE CONTROL (Header Gestiรณn) ====== */
        .control-bar {
            width: 95%; max-width: 1200px;
            margin: 20px auto 15px auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid #d1d1d6;
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            gap: 15px; flex-wrap: wrap; z-index: 900;
        }

        .control-left { display: flex; align-items: center; gap: 12px; flex-grow: 1; }
        
        .compact-search { position: relative; width: 100%; max-width: 400px; transition: width 0.3s ease; }
        .compact-search input {
            width: 100%; padding: 10px 12px 10px 36px; border-radius: 10px;
            border: 1px solid #ccc; background: #fff; font-size: 0.95rem; font-weight: 500; color: #000;
            outline: none; transition: all 0.2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .compact-search input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.2); }
        .compact-search .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.6; font-size: 1rem; pointer-events: none; color: #000; }

        .control-right { display: flex; align-items: center; gap: 10px; }

        .btn-new-session {
            background: #000; color: white; padding: 10px 20px;
            border-radius: 10px; border: none; font-weight: 700; font-size: 0.95rem;
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s, background 0.2s;
        }
        .btn-new-session:hover { transform: translateY(-2px); background: #333; box-shadow: 0 6px 16px rgba(0,0,0,0.25); }

        .data-dropdown-container { position: relative; }
        .btn-data-mini {
            width: 42px; height: 42px; border-radius: 10px; border: 1px solid #ccc;
            background: #fff; color: #111; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-data-mini:hover { background: #f0f0f5; border-color: #999; transform: rotate(15deg); }
        
        .data-menu-popup {
            display: none; position: absolute; top: 55px; right: 0; width: 240px;
            background: white; border: 1px solid #d1d1d6; border-radius: 14px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2); padding: 8px; z-index: 2000;
        }
        .data-menu-popup.active { display: block; animation: fadeIn 0.15s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

        .data-menu-item {
            display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px;
            border: none; background: transparent; text-align: left; font-size: 0.9rem;
            font-weight: 600; color: #111; border-radius: 8px; cursor: pointer; transition: background 0.1s;
        }
        .data-menu-item:hover { background: #f2f2f7; }
        .data-menu-item.danger { color: #cc0000; }
        .data-menu-item.danger:hover { background: #fff0f0; }
        .data-divider { height: 1px; background: #e0e0e0; margin: 6px 0; }
        
/* ====== GRID & CARDS (Rectangular Compacto) ====== */
        .section-header { width: 95%; max-width: 1200px; margin: 20px auto 15px auto; font-weight: 900; font-size: 1.1rem; color: #444; text-transform: uppercase; letter-spacing: 1.2px; border-bottom: 2px solid #e5e5ea; padding-bottom: 5px; }
        .grid-container { width: 95%; max-width: 1200px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding-bottom: 60px; margin: 0 auto; }
        
        .resource-card { 
            background: white; border-radius: 16px; overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s; 
            display: flex; flex-direction: column; 
            height: 260px; 
            border: 1px solid #e5e5ea; 
        }
        .resource-card:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); border-color: #d1d1d6; }
        
        .media-area { 
            position: relative; width: 100%; 
            height: 150px; 
            flex-shrink: 0; background: #000; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; 
        }
        .media-area.video img { width: 100%; height: 100%; object-fit: cover; opacity: 0.95; transition: opacity 0.2s;}
        .media-area:hover img { opacity: 0.8; }
        .play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: rgba(255,255,255,0.95); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; transition: transform 0.2s; z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .media-area:hover .play-icon { transform: translate(-50%, -50%) scale(1.1); }
        .play-icon svg { width: 20px; height: 20px; fill: #000; margin-left: 2px; }
        .media-area.audio { background: linear-gradient(135deg, #FF9500, #FF3B30); }
        .audio-icon { font-size: 3rem; color: white; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .media-area.web { flex-direction: column; align-items: flex-start; justify-content: flex-end; padding: 15px; box-sizing: border-box; background: #f0f0f5; }
        .web-domain-tag { background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; color: #fff; margin-bottom: auto; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .web-favicon-box { width: 40px; height: 40px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 8px; }
        .web-favicon-box img { width: 24px; height: 24px; object-fit: contain; }
        .web-domain-text { font-size: 1rem; font-weight: 800; color: #333; }

        .card-info { 
            padding: 12px 16px; 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            background: #fff; 
            gap: 5px; 
        }
        .card-title { 
            font-weight: 800; font-size: 1rem; color: #111; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            display: block; margin-bottom: 0; letter-spacing: -0.3px;
        }

        .card-actions { display: flex; width: 100%; gap: 8px; margin-top: auto; }
        .btn-action { 
            flex: 1; background: #f9f9fb; border: 1px solid #e5e5ea; 
            cursor: pointer; padding: 8px 0; border-radius: 8px; 
            font-size: 1rem; transition: all 0.15s; color: #555; 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-edit:hover { background: #007AFF; color: white; border-color: #007AFF; }
        .btn-delete:hover { background: #FF3B30; color: white; border-color: #FF3B30; }
        .btn-duplicate:hover { background: #34C759; color: white; border-color: #34C759; }
        .btn-meta:hover { background: #FF9500; color: white; border-color: #FF9500; }

        /* ====== EDITOR ====== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .editor-popup { background: white; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 900px) {
            .editor-popup { width: 96%; max-width: 1600px; height: 90vh; flex-direction: row; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
            .editor-popup.is-fullscreen { width: 100vw !important; height: 100vh !important; max-width: none !important; border-radius: 0 !important; }
        }

        .desktop-media-container { display: none; background: #111; align-items: center; justify-content: center; flex-direction: column; border-right: 1px solid #333; }
        @media (min-width: 900px) { 
            .desktop-media-container { display: flex; width: 45%; flex-shrink: 0; position: relative; } 
            .editor-content-panel { flex: 1; min-width: 400px; } 
            /* Opacity slider removed from here per user request */
            .editor-popup.free-mode .desktop-media-container { display: none !important; }
            .editor-popup.free-mode .resizer-gutter { display: none !important; }
            .editor-popup.free-mode .editor-content-panel { width: 100% !important; }
            .editor-popup.free-mode #btn-main-play, .editor-popup.free-mode .btn-media { display: none !important; }
        }

        /* WEB TABS */
        .media-iframe-wrapper { width: 100%; height: 100%; position: relative; background: #e5e5ea; display: flex; flex-direction: column; }
        .web-tab-nav { display: flex; background: #f2f2f7; border-bottom: 1px solid #d1d1d6; height: 44px; flex-shrink: 0; overflow-x: auto; }
        .web-tab-btn { flex: 1; border: none; background: #f2f2f7; font-size: 0.85rem; font-weight: 700; color: #888; min-width: 90px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 10px; }
        .web-tab-btn:hover { background: #e5e5ea; color: #555; }
        .web-tab-btn.active { color: #000; background: #fff; }
        .tab-gear { font-size: 0.9rem; opacity: 0.4; margin-left: 6px; padding: 4px; border-radius: 50%; transition: all 0.2s;}
        .tab-gear:hover { opacity: 1; background: rgba(0,0,0,0.1); color: #000; transform: rotate(90deg); }
        .web-content-area { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; background: #fff; }
        .web-frame-container { width: 100%; height: 100%; display: none; position: relative; }
        .web-frame-container.active { display: block; }
        .web-frame-container iframe { width: 100%; height: 100%; border: none; position: relative; z-index: 2; background: transparent; }
        .web-error-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ccc; z-index: 1; font-weight: 600;}
        .media-audio-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
        audio { width: 85%; filter: invert(1); }

        .channel-1.active { color: #007AFF !important; border-bottom-color: #007AFF !important; }
        .channel-2.active { color: #34C759 !important; border-bottom-color: #34C759 !important; }
        .channel-3.active { color: #AF52DE !important; border-bottom-color: #AF52DE !important; }
        .channel-4.active { color: #FF9500 !important; border-bottom-color: #FF9500 !important; }
        .channel-5.active { color: #FF3B30 !important; border-bottom-color: #FF3B30 !important; }

        .editor-content-panel { display: flex; flex-direction: column; height: 100%; background: white; }
        .resizer-gutter { display: none; width: 12px; background: #f2f2f7; cursor: col-resize; flex-shrink: 0; border-left: 1px solid #d1d1d6; border-right: 1px solid #d1d1d6; }
        @media (min-width: 900px) { .resizer-gutter { display: block; } }

        .editor-header { padding: 12px 20px; background: #fff; border-bottom: 1px solid #e5e5ea; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .editor-title { font-weight: 800; font-size: 1.1rem; color: #111; }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .btn-header-icon { background: #f2f2f7; border: 1px solid #e5e5ea; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; color: #666; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.2s;}
        .btn-header-icon:hover { background: #111; color: #fff; border-color: #111; }
        #btn-fullscreen { display: none; }
        @media (min-width: 900px) { #btn-fullscreen { display: flex; } }

        /* ====== DELICATE TOOLBAR (UPDATED) ====== */
        .editor-toolbar { 
            width: 100%; padding: 10px 20px; background: #fff; border-bottom: 1px solid #e5e5ea; 
            display: flex; align-items: center; gap: 15px; overflow-x: auto; scrollbar-width: none; 
        }
        
        /* New delicate text group */
        .delicate-group {
            display: flex; align-items: center; gap: 8px; 
            background: #f7f7f9; border: 1px solid #e5e5ea; 
            border-radius: 20px; padding: 4px 10px;
        }
        
        .delicate-sep { width: 1px; height: 18px; background: #d1d1d6; margin: 0 4px; }

        /* Color Circles */
        .color-circle { 
            width: 18px; height: 18px; border-radius: 50%; cursor: pointer; 
            border: 2px solid transparent; transition: transform 0.2s;
        }
        .color-circle:hover { transform: scale(1.2); }
        .color-circle.active { border-color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: scale(1.1); }

        /* Font Buttons */
        .font-btn {
            background: none; border: none; font-size: 0.9rem; font-weight: 600; 
            color: #888; cursor: pointer; padding: 2px 6px; border-radius: 6px; 
            transition: all 0.2s;
        }
        .font-btn:hover { color: #000; background: #e5e5ea; }
        .font-btn.active { color: #007aff; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Style Icons */
        .style-icon {
            background: none; border: none; font-size: 0.85rem; font-weight: 700;
            color: #666; cursor: pointer; width: 24px; height: 24px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .style-icon:hover { background: #e5e5ea; color: #000; }
        .style-icon.active { background: #000; color: #fff; }

        /* Other Controls */
        .toolbar-group { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .btn-ai-trigger { background: linear-gradient(135deg, #e3f2fd, #90caf9); color: #007AFF; border: 1px solid #bbdefb; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; font-weight: 700; display:flex; align-items:center; justify-content:center; }
        .btn-ai-trigger:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,122,255,0.2); }
        .btn-save-template { background: #fff8e1; color: #b45309; font-size: 0.75rem; padding: 6px 12px; border: 1px solid #fcd34d; border-radius: 8px; cursor: pointer; font-weight: 700; }
        
        .ctrl-target-group { display: flex; background: #f2f2f7; border-radius: 8px; padding: 4px; border: 1px solid #e5e5ea; gap: 4px; align-items: center;}
        .btn-target { width: 28px; height: 28px; border: none; background: transparent; border-radius: 6px; font-size: 0.75rem; font-weight: 800; color: #999; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .btn-target.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-lock { width: 28px; height: 28px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; opacity: 0.4; transition: all 0.2s; }
        .btn-lock.locked { opacity: 1; background: #e0e0e0; color: #333; }

        .media-controls { display: flex; gap: 10px; }
        .btn-media { padding: 0 16px; height: 40px; background: #f2f2f7; border: 1px solid #e5e5ea; border-radius: 10px; cursor: pointer; font-weight: 700; color: #333; display:flex; align-items:center; justify-content:center; transition: all 0.2s;}
        .btn-media:hover { background: #e5e5ea; }
        #btn-main-play { min-width: 50px; font-size: 1.2rem; }
        #btn-main-play.is-playing { background-color: #fff3cd; color: #d97706; border-color: #fcd34d; }
        #btn-main-play.is-paused { background-color: #d1e7dd; color: #0f5132; border-color: #a3cfbb; }
        .btn-clear { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e5ea; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-clear svg { width: 18px; height: 18px; fill: #888; }

        .editor-area { flex: 1; width: 100%; padding: 40px; border: none; font-family: 'Inter', sans-serif; font-size: 18px; line-height: 1.7; overflow-y: auto; outline: none; color: #111; }
        .editor-footer { padding: 12px 20px; border-top: 1px solid #e5e5ea; text-align: right; background: #f9f9fb; font-size: 0.8rem; color: #888; font-weight: 600; }

        /* ====== TAB CONFIG POPUP (MODIFICADO) ====== */
        .tab-settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .tab-settings-modal.active { display: flex; }
        .tab-popup-content { 
            background: #fff; padding: 25px; border-radius: 16px; 
            width: 800px; /* Aumentado de 600px */
            max-width: 95%; max-height: 85vh; 
            box-shadow: 0 25px 80px rgba(0,0,0,0.5); 
            font-family: 'Inter', sans-serif; display: flex; flex-direction: column;
            border: 1px solid #ccc;
        }
        .tab-popup-header { font-weight: 800; margin-bottom: 20px; font-size: 1.3rem; display:flex; justify-content:space-between; align-items: center; color: #000; }
        .tab-popup-close { cursor: pointer; padding: 5px; font-size: 1.2rem; opacity: 0.5; transition: opacity 0.2s; }
        .tab-popup-close:hover { opacity: 1; color: #d00; }
        
        .tab-input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-input-group input { 
            flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; 
            font-size: 1rem; color: #000; font-weight: 500; outline: none; transition: border 0.2s;
            min-width: 250px;
        }
        .tab-input-group input:focus { border-color: #007aff; }
        
        .tab-btn-action { 
            padding: 0 16px; border-radius: 8px; cursor: pointer; font-weight: 700; border: none; 
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9rem;
            transition: transform 0.1s;
        }
        .btn-paste { background: #e5e5ea; color: #333; }
        .btn-paste:hover { background: #d1d1d6; }
        .tab-btn-go { background: #007aff; color: white; }
        .tab-btn-go:hover { background: #006ce6; transform: scale(1.02); }

        /* Nuevos botones extra en el popup de tabs */
        .tab-btn-extra {
            background: #f2f2f7; color: #333; border: 1px solid #d1d1d6;
        }
        .tab-btn-extra:hover { background: #e5e5ea; color: #000; transform: translateY(-1px); }

        .fav-list-title { font-size: 0.85rem; color: #444; text-transform: uppercase; margin-bottom: 10px; font-weight: 800; letter-spacing: 0.5px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .fav-list { list-style: none; padding: 0; overflow-y: auto; flex: 1; padding-right: 5px; }
        .fav-list::-webkit-scrollbar { width: 6px; }
        .fav-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .fav-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .fav-list::-webkit-scrollbar-thumb:hover { background: #999; }

        .fav-item { 
            display: flex; align-items: center; padding: 12px 10px; 
            border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.1s; 
            border-radius: 8px; margin-bottom: 2px;
        }
        .fav-item:hover { background: #f5f5f7; }
        .fav-icon { width: 24px; height: 24px; margin-right: 12px; border-radius: 4px; object-fit: contain; background: #fff; padding: 2px; border: 1px solid #eee;}
        .fav-name { flex: 1; font-size: 1rem; color: #111; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .fav-actions { display: flex; gap: 8px; opacity: 0.4; transition: opacity 0.2s; margin-left: 10px;}
        .fav-item:hover .fav-actions { opacity: 1; }
        .btn-fav-mini { 
            padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; background: #fff; 
            font-size: 0.8rem; cursor: pointer; color: #555; font-weight: 600; 
            display: flex; align-items: center; gap: 4px;
        }
        .btn-fav-mini:hover { background: #e5e5ea; color: #000; border-color: #bbb; }
        .btn-fav-del { color: #cc0000; border-color: #ffcccc; background: #fff5f5; }
        .btn-fav-del:hover { background: #ff0000; color: white; border-color: #ff0000; }

        /* ====== AI HUB (V31 FINAL MODIFICADO) ====== */
        .ai-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .ai-popup-overlay.active { display: flex; }
        
        .ai-popup-box { 
            background: #fff; width: 95%; max-width: 800px; border-radius: 24px; 
            box-shadow: 0 40px 100px rgba(0,0,0,0.25); display: flex; flex-direction: column; 
            overflow: hidden; /* Fix horizontal scroll */
            overflow-x: hidden;
            font-family: 'Inter', sans-serif; max-height: 92vh; 
            border: 1px solid rgba(255,255,255,0.5);
        }

        .ai-header { 
            background: rgba(255,255,255,0.95); border-bottom: 1px solid #eee; 
            color: #111; padding: 18px 24px; font-weight: 800; font-size: 1.2rem;
            display: flex; justify-content: space-between; align-items: center; 
            backdrop-filter: blur(10px); z-index: 10;
        }
        .ai-close { background: #f2f2f7; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; transition: background 0.2s; font-size: 1.2rem;}
        .ai-close:hover { background: #e5e5ea; color: #000; }

        .ai-body { padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; flex:1; background: #fff; overflow-x: hidden; }

        .ai-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media(max-width: 600px) { .ai-grid-2 { grid-template-columns: 1fr; } }

        .ai-card-group {
            background: #F9F9FB; border-radius: 16px; padding: 4px;
            border: 1px solid #e5e5ea; display: flex; flex-direction: column;
            transition: border-color 0.2s;
        }
        .ai-card-group:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        
        /* Labels mรกs grandes */
        .ai-card-label { 
            font-size: 0.75rem; font-weight: 800; color: #888; text-transform: uppercase; 
            letter-spacing: 0.5px; padding: 8px 12px 2px 12px; display: flex; align-items: center; gap: 6px;
        }

        .ai-select { 
            width: 100%; padding: 8px 12px; border: none; background: transparent; 
            font-size: 0.95rem; font-weight: 600; color: #111; cursor: pointer; outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto;
        }
        .ai-custom-input { 
            width: 100%; padding: 10px 12px; border: none; border-top: 1px solid #e5e5ea; 
            background: #fff; font-size: 0.85rem; color: #333; outline: none; border-radius: 0 0 12px 12px;
            transition: background 0.2s;
        }
        .ai-custom-input:focus { background: #fff; }
        .ai-select.override-warning { color: #d00; }

        .segmented-control { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; gap: 2px; }
        .level-btn { 
            flex: 1; padding: 8px; border: none; border-radius: 8px; 
            background: transparent; color: #666; font-size: 0.8rem; font-weight: 700; 
            cursor: pointer; transition: all 0.2s; 
        }
        .level-btn:hover { color: #000; }
        .level-btn.selected { background: #fff; color: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

        .flag-group { display: flex; gap: 12px; flex-wrap: wrap;}
        .flag-btn { 
            border: 2px solid transparent; border-radius: 50%; background: #f2f2f7; 
            font-size: 1.5rem; width: 48px; height: 48px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0.6; filter: grayscale(100%); transition: all 0.2s;
        }
        .flag-btn:hover { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
        .flag-btn.selected { border-color: var(--primary); background: #fff; opacity: 1; filter: grayscale(0%); box-shadow: 0 4px 10px rgba(0,122,255,0.2); }
        .flag-btn.hidden { display: none !important; }
        .flag-sm { width: 40px; height: 40px; font-size: 1.2rem; }

        textarea.ai-custom-input { resize: vertical; min-height: 80px; border-radius: 12px; border: 1px solid #e5e5ea; background: #F9F9FB; margin-top: 0; }
        textarea.ai-custom-input:focus { background: #fff; border-color: var(--primary); }

        /* AI FOOTER (REDISEรADO - MOVIDO) */
        .ai-footer-actions { 
            /* Se eliminaron margenes negativos y borde superior */
            margin: 15px 0; 
            padding: 0; 
            background: transparent; 
            border-top: none; 
            display: flex; gap: 15px; z-index: 5;
            width: 100%;
        }
        
        .btn-ai-action { 
            flex: 1; 
            padding: 16px; 
            border: none; 
            border-radius: 14px; 
            font-weight: 800; 
            font-size: 0.95rem; 
            cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-transform: uppercase; letter-spacing: 0.5px;
            border: 2px solid #fff; 
        }

        .btn-ai-primary { 
            background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
            color: #445; 
            box-shadow: 0 8px 20px rgba(142, 197, 252, 0.25); 
        }
        .btn-ai-primary:hover { 
            transform: translateY(-2px);
            background: linear-gradient(135deg, #d3b0f5 0%, #7eb8f2 100%);
            box-shadow: 0 12px 25px rgba(142, 197, 252, 0.4); 
            color: #223;
        }

        #btn-paste-json {
            background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);
            color: #445;
            box-shadow: 0 8px 20px rgba(250, 208, 196, 0.25);
        }
        #btn-paste-json:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #f5c0b0 0%, #f5c0f5 100%);
            box-shadow: 0 12px 25px rgba(250, 208, 196, 0.4);
            color: #223;
        }

        /* NEW PREVIEW BOX FOR LATEST EXERCISE */
        .ai-preview-box {
            margin-bottom: 20px;
            border: 2px solid var(--success);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1);
        }

        /* ANIMACIรN DE PARPADEO */
        .ai-preview-box.highlight {
            animation: highlightPulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) 3;
        }

        @keyframes highlightPulse {
            0%, 100% { border-color: var(--success); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.1); }
            50% { border-color: var(--warning); box-shadow: 0 0 20px rgba(255, 149, 0, 0.5); }
        }

        /* Memory List Updated */
        .saved-exercises-list { 
            max-height: 300px; 
            overflow-y: auto; border: 1px solid #e5e5ea; border-radius: 12px; margin-bottom: 10px; 
        }
        .saved-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .saved-item:nth-child(odd) { background: #fff; }
        .saved-item:nth-child(even) { background: #f4f4f7; }
        
        .saved-item:last-child { border-bottom: none; }
        .saved-info { flex: 1; }
        .saved-name { font-weight: 600; font-size: 0.9rem; color: #111; }
        .saved-date { font-size: 0.7rem; color: #888; }
        .badge-new { background: var(--success); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
        .badge-tpl { background: var(--warning); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
        .mem-actions { display: flex; gap: 6px; }
        .btn-icon-action { width: 30px; height: 30px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); color: #555; transition: all 0.2s;}
        .btn-icon-action:hover { background: #000; color: #fff; }
        .btn-insert { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
        .btn-delete-item:hover { background: #d00 !important; color: #fff !important; }
        
        .mem-controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn-mem-ctrl { flex: 1; padding: 10px; border: 1px solid #e5e5ea; background: #fff; border-radius: 10px; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .btn-mem-ctrl:hover { background: #f9f9f9; }
        
        /* ====== EXERCISE RENDER ====== */
        .exercise-box { background: #fff; border: 1px solid #e5e5ea; border-radius: 12px; padding: 20px; margin: 20px 0; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .exercise-header { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 16px; border-bottom: 1px solid #f2f2f7; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .exercise-header span { flex: 1; word-wrap: break-word; overflow-wrap: break-word; }
        .btn-theory { background: var(--primary-soft); color: var(--primary); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
        .btn-del-block { background: #fff5f5; color: var(--danger); border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 5px; }
        .btn-reset-block { background: #fff8e1; color: #d97706; border: none; padding: 6px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: 700; white-space: nowrap; margin-left: 5px; }
        .theory-box { display: none; background: #f9f9fb; padding: 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; }
        .exercise-row { margin-bottom: 16px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; line-height: 1.8; position: relative; } 
        .hint-box, .trans-box { display: none; width: 100%; margin-top: 8px; padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; }
        .hint-box { background: #fffbe6; border-left: 4px solid #f59e0b; color: #78350f; }
        .trans-box { background: #f0f9ff; border-left: 4px solid #007AFF; color: #0c4a6e; }
        .trans-line { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .btn-mini-speak { background: #fff; border: 1px solid #d1d1d6; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .ex-select { padding: 8px 14px; border: 1px solid #d1d1d6; border-radius: 8px; background: white; cursor: pointer; outline: none; font-size: 0.95rem; appearance: none; padding-right: 2.5rem; max-width: 100%; white-space: normal; }
        .ex-select.correct { border-color: var(--success) !important; background-color: #e8f5e9 !important; color: #1b5e20 !important; font-weight: 700; }
        .ex-select.wrong { border-color: var(--danger) !important; background-color: #ffebee !important; color: #b71c1c !important; animation: shake 0.3s; }
        .ex-btn-icon { background: #f2f2f7; border: none; border-radius: 8px; cursor: pointer; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; color: #1d1d1f; }
        .ex-btn-icon:hover { background: #e5e5ea; color: var(--primary); }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        /* SPECIAL EXERCISE STYLES */
        .exercise-row s { color: var(--danger); text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color: var(--danger); background-color: rgba(255, 59, 48, 0.1); padding: 2px 6px; border-radius: 6px; margin-right: 8px; font-weight: 600; display: inline-block; }
        .exercise-row s::before { content: "โ"; font-size: 0.7em; margin-right: 4px; vertical-align: text-top; opacity: 0.6; }
        .cloze-gap-container { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 4px; }
        .embedded-editor-area { width: 100%; height: 100%; padding: 15px; overflow-y: auto; background: #fff; font-size: 1rem; line-height: 1.5; outline: none; }
    </style>
ย ย </head>
ย ย <body>

ย ย <div id="mdc-header">
ย ย ย ย <a href="https://paradisonetworx.com/mdceng.html">MDC ENG</a>
ย ย </div>

ย ย <div class="control-bar">
ย ย ย ย <div class="control-left">
ย ย ย ย ย ย <div class="compact-search">
ย ย ย ย ย ย ย ย <span class="icon">๐</span>
ย ย ย ย ย ย ย ย <input type="text" id="searchInput" placeholder="Search library..." oninput="applySearch()">
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <div class="control-right">
ย ย ย ย ย ยย
ย ย ย ย ย ย <button class="btn-new-session" onclick="openFreeEditor()">
ย ย ย ย ย ย ย ย <span>+ Study Whiteboard</span>
ย ย ย ย ย ย </button>

ย ย ย ย ย ย <div class="data-dropdown-container">
ย ย ย ย ย ย ย ย <button class="btn-data-mini" onclick="document.getElementById('data-popup').classList.toggle('active')" title="Data & Backup">
ย ย ย ย ย ย ย ย ย ย โ๏ธ
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย <div id="data-popup" class="data-menu-popup">
ย ย ย ย ย ย ย ย ย ย <div style="padding: 5px 10px; font-size: 0.7rem; font-weight: 800; color:#888; text-transform:uppercase;">Library Data</div>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <button class="data-menu-item" onclick="downloadBackup()">
ย ย ย ย ย ย ย ย ย ย ย ย <span>โฌ๏ธ</span> Backup Library
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <input type="file" id="importFile" accept=".html,.json" style="display:none" onchange="importBackup(this)">
ย ย ย ย ย ย ย ย ย ย <button class="data-menu-item" onclick="document.getElementById('importFile').click()">
ย ย ย ย ย ย ย ย ย ย ย ย <span>โฌ๏ธ</span> Import Backup
ย ย ย ย ย ย ย ย ย ย </button>

ย ย ย ย ย ย ย ย ย ย <div class="data-divider"></div>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div style="padding: 5px 10px; font-size: 0.7rem; font-weight: 800; color:#888; text-transform:uppercase; margin-top:5px;">Manage</div>
ย ย ย ย ย ย ย ย ย ย <button class="data-menu-item danger" onclick="clearResources('all')">๐๏ธ Clear All</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย </div>
ย ย </div>

ย ย <div class="section-header">
ย ย ย ย <span>๐ Library</span>
ย ย </div>

ย ย <div class="grid-container" id="video-grid"></div>

ย ย <div class="modal-overlay" id="editor-modal">
ย ย ย ย <div class="editor-popup" id="editor-popup">
ย ย ย ย ย ย <div class="desktop-media-container" id="desktop-media-wrapper"></div>
ย ย ย ย ย ย <div class="resizer-gutter" id="drag-resizer"></div>
ย ย ย ย ย ย <div class="editor-content-panel" id="editor-panel">
ย ย ย ย ย ย ย ย <div class="editor-header">
ย ย ย ย ย ย ย ย ย ย <span class="editor-title">Note Editor</span>
ย ย ย ย ย ย ย ย ย ย <div class="header-actions">
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-header-icon" id="btn-fullscreen" onclick="toggleEditorFullScreen()" title="Expand Editor">โถ</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-header-icon" onclick="closeEditor()" title="Close">ร</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="editor-toolbar">
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="delicate-group">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="color-circle" style="background:#111; border-color:#ddd;" onmousedown="event.preventDefault(); applyColor('#1d1d1f')" title="Black"></div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="color-circle" style="background:#FF3B30" onmousedown="event.preventDefault(); applyColor('#FF3B30')" title="Red"></div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="color-circle" style="background:#007AFF" onmousedown="event.preventDefault(); applyColor('#007AFF')" title="Blue"></div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="color-circle" style="background:#34C759" onmousedown="event.preventDefault(); applyColor('#34C759')" title="Green"></div>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <div class="delicate-sep"></div>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <button class="font-btn" style="font-family:'Inter'" onclick="setFont('Inter')" title="Sans Serif">Aa</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="font-btn" style="font-family:'Playfair Display'" onclick="setFont('Playfair Display')" title="Serif">Aa</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="font-btn" style="font-family:'Courier Prime'" onclick="setFont('Courier Prime')" title="Mono">Aa</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="font-btn" style="font-family:'Dancing Script'; font-size:1.1rem;" onclick="setFont('Dancing Script')" title="Script">Aa</button>

ย ย ย ย ย ย ย ย ย ย ย ย <div class="delicate-sep"></div>

ย ย ย ย ย ย ย ย ย ย ย ย <button class="style-icon" id="btn-bold" onmousedown="event.preventDefault(); toggleBold()" title="Bold">B</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="style-icon" id="btn-size-norm" onmousedown="event.preventDefault(); setSize(3)" title="Normal">T</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="style-icon" id="btn-size-lg" onmousedown="event.preventDefault(); setSize(5)" title="Large" style="font-size:1.1rem">T+</button>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="toolbar-group">
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-fmt btn-ai-trigger" onclick="openAIMenu()" title="AI Exercise Hub">โก</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-fmt btn-save-template" onclick="saveEditorAsTemplate()" title="Save current editor content as reusable template">๐พ Save</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="toolbar-group">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="ctrl-target-group">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-lock locked" id="btn-sync-lock" onclick="toggleSyncLock()" title="Lock/Unlock Tab Sync">๐</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-target channel-1 active" onclick="setControlTarget(0)">1</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-target channel-2" onclick="setControlTarget(1)">2</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-target channel-3" onclick="setControlTarget(2)">3</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-target channel-4" onclick="setControlTarget(3)">4</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-target channel-5" onclick="setControlTarget(4)">5</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-media" onclick="seekVideo(-3)">-3s</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-media" id="btn-main-play" onclick="togglePlay()">โฏ๏ธ</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-media" onclick="seekVideo(3)">+3s</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-media btn-speed" id="btn-speed" onclick="cycleSpeed()">1x</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <button class="btn-clear" onclick="if(confirm('Clear all?')) { document.getElementById('editor-text').innerHTML=''; saveNote(); }" title="Clear All">
ย ย ย ย ย ย ย ย ย ย ย ย <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div id="editor-text" class="editor-area" contenteditable="true" placeholder="Type here..." oninput="saveNote()"></div>
ย ย ย ย ย ย ย ย <div class="editor-footer"><span class="save-indicator">โ Saved</span></div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div class="ai-popup-overlay" id="ai-hub-modal">
ย ย ย ย <div class="ai-popup-box">
ย ย ย ย ย ย <div class="ai-header">
ย ย ย ย ย ย ย ย <div style="display:flex; align-items:center; gap:12px;">
ย ย ย ย ย ย ย ย ย ย <span>โก Polyglot AI Hub</span>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <button class="ai-close" onclick="closeAIMenu()">ร</button>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <div class="ai-body">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div class="ai-grid-2">
ย ย ย ย ย ย ย ย ย ย <div class="ai-card-group">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label">๐ Context</div>
ย ย ย ย ย ย ย ย ย ย ย ย <select id="ai-context-select" class="ai-select">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="" selected disabled>Select Context...</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ Daily Life & Lifestyle">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Daily Routine & Habits">Daily Routine & Habits</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Family & Relationships">Family & Relationships</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="House & Chores">House, Furniture & Chores</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Food, Cooking & Restaurants">Food, Cooking & Restaurants</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Health, Fitness & Body">Health, Fitness & Doctors</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Hobbies, Music & Movies">Hobbies, Music & Movies</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="โ๏ธ Travel & Adventure">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="At the Airport & Flying">At the Airport & Flying</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Hotel Check-in & Problems">Hotel Situations</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Asking for Directions & City">City & Directions</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Car Rental & Driving">Car Rental & Driving</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ผ Work & Business">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Job Interviews & CVs">Job Interviews & HR</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Business Meetings & Strategy">Meetings & Negotiations</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Emails & Formal Communication">Formal Emails</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Tech, IT & Programming">Tech, IT & Programming</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Marketing & Sales">Marketing & Sales</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Customer Service Scenarios">Customer Service Issues</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ Academic & Abstract">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="University & Campus Life">University & Campus Life</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Science & Environment">Science & Environment</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Debating Opinions & Ethics">Debating Opinions</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="News & Current Events">News & Current Events</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="ai-context-custom" class="ai-custom-input" placeholder="Or type custom context..." oninput="checkCustomOverride('ai-context-custom', 'ai-context-select')">
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="ai-card-group">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label">๐ง Grammar</div>
ย ย ย ย ย ย ย ย ย ย ย ย <select id="ai-grammar-select" class="ai-select">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="" selected disabled>Select Grammar...</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ Present Tenses">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Present Simple">Present Simple (Habits & Facts)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Present Continuous">Present Continuous (Now & Future)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Present Perfect">Present Perfect (Experiences)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Present Perfect Continuous">Present Perfect Continuous</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Present Simple vs Continuous">Mix: Simple vs Continuous</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ Past Tenses">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Past Simple">Past Simple (Finished Actions)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Past Continuous">Past Continuous (Interrupted Actions)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Past Perfect">Past Perfect (The Past before the Past)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Past Perfect Continuous">Past Perfect Continuous</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Narrative Tenses Mix">Mix: Narrative Tenses (Storytelling)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ Future Tenses">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Future Simple (Will)">Future Simple (Will - Spontaneous)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Be Going To">Be Going To (Plans)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Future Continuous">Future Continuous (In progress later)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Future Perfect">Future Perfect (Completed by then)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Future Forms Mix">Mix: Will / Going to / Present Cont.</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="โ๏ธ Advanced Structures">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Conditionals 0 & 1">Conditionals 0 & 1 (Real)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Conditionals 2 & 3">Conditionals 2 & 3 (Unreal)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Mixed Conditionals">Mixed Conditionals</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Passive Voice">Passive Voice</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Reported Speech">Reported Speech (Indirect)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Relative Clauses">Relative Clauses (Who, Which, That)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Causative (Have/Get something done)">Causative Form</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐งฉ Particles & Modals">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Modal Verbs (Can, Could, Should, Must)">Modal Verbs</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Modals of Deduction (Must have, Can't have)">Modals of Past Deduction</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Phrasal Verbs">Phrasal Verbs (General)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Prepositions of Place & Time">Prepositions (In, On, At, By)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Articles (A, An, The, Zero)">Articles (A / An / The)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Gerunds vs Infinitives">Gerunds vs Infinitives</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="ai-grammar-custom" class="ai-custom-input" placeholder="Or type custom grammar..." oninput="checkCustomOverride('ai-grammar-custom', 'ai-grammar-select')">
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="ai-grid-2">
ย ย ย ย ย ย ย ย ย ย <div class="ai-card-group">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label">๐ Format</div>
ย ย ย ย ย ย ย ย ย ย ย ย <select id="ai-type-select" class="ai-select">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="" selected disabled>Select Format...</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="โ๏ธ Standard Practice">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Fill in the Blanks (Cloze)">Fill in the Blanks (Classic)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Multiple Choice Quiz">Multiple Choice Quiz</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Find and Fix the Mistake">Find and Fix the Mistake</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="True or False (Reading)">True or False (Reading Comp.)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ง Vocabulary & Logic">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Vocabulary Matching">Vocabulary Matching (Def - Word)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Synonym & Antonym Finder">Synonym Finder</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Sentence Reordering">Sentence Reordering (Scrambled)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Choose the Odd One Out">Odd One Out (Logic)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <optgroup label="๐ Translation">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Reverse Translation (ES->EN)">Reverse Translation (See ES, Pick EN)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </optgroup>
ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="ai-type-custom" class="ai-custom-input" placeholder="Or type custom format..." oninput="checkCustomOverride('ai-type-custom', 'ai-type-select')">
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="ai-card-group" style="justify-content: space-between;">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex: 1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label">๐๏ธ Difficulty & Qty</div>ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div style="display: flex; align-items: center; gap: 8px; padding-right: 12px;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="ai-gap-count" class="ai-select" style="flex: 1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="1" selected>1 Gap / Sentence</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="2">2 Gaps / Sentence</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="3">3 Gaps / Sentence</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="random">Random Mix (1-3 gaps)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div style="display:flex; align-items:center; gap:5px; background:#fff; padding:0 8px; border:1px solid #d1d1d6; border-radius:8px;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:0.7rem; font-weight:800; color:#888;">OPC</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="ai-option-count" value="4" min="2" max="10" placeholder="4" style="width: 40px; text-align: center; border:none; outline:none; font-size:0.9rem; font-weight:600; padding:8px 0;" title="Number of options per gap">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div style="display:flex; align-items:center; gap:5px; background:#fff; padding:0 8px; border:1px solid #d1d1d6; border-radius:8px;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:0.7rem; font-weight:800; color:#888;">QTY</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="ai-sentence-count" value="5" min="1" placeholder="#" style="width: 40px; text-align: center; border:none; outline:none; font-size:0.9rem; font-weight:600; padding:8px 0;" title="Number of sentences">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="padding: 0 10px 10px 10px;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="segmented-control" id="level-group">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="level-btn" onclick="selectLevel(this, 'A1-A2 (Beginner)')">A1-A2</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="level-btn selected" onclick="selectLevel(this, 'B1-B2 (Intermediate)')">B1-B2</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="level-btn" onclick="selectLevel(this, 'C1-C2 (Advanced)')">C1-C2</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="ai-grid-2">
ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label">๐ฏ Target</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-group" id="target-lang-group">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn selected" onclick="selectTarget(this, 'en')" title="English">๐บ๐ธ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn" onclick="selectTarget(this, 'es')" title="Spanish">๐ช๐ธ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn" onclick="selectTarget(this, 'pt')" title="Portuguese">๐ง๐ท</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn" onclick="selectTarget(this, 'it')" title="Italian">๐ฎ๐น</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label">๐ Translations</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-group" id="trans-lang-group">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn flag-sm" data-lang="en" onclick="toggleTrans(this, 'en')" title="Translate to English">๐บ๐ธ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn flag-sm selected" data-lang="es" onclick="toggleTrans(this, 'es')" title="Translate to Spanish">๐ช๐ธ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn flag-sm" data-lang="pt" onclick="toggleTrans(this, 'pt')" title="Translate to Portuguese">๐ง๐ท</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flag-btn flag-sm" data-lang="it" onclick="toggleTrans(this, 'it')" title="Translate to Italian">๐ฎ๐น</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label">โก Extra Instructions</div>
ย ย ย ย ย ย ย ย ย ย <textarea id="ai-extra-data" class="ai-custom-input" placeholder="E.g. Use British slang, make it funny, focus on medical terms..."></textarea>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="ai-footer-actions">
ย ย ย ย ย ย ย ย ย ย <button class="btn-ai-action btn-ai-primary" onclick="copyProfessorPrompt()">
ย ย ย ย ย ย ย ย ย ย ย ย <span>โจ</span> Create Mission
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button class="btn-ai-action" id="btn-paste-json" onclick="pasteAIJson()">
ย ย ย ย ย ย ย ย ย ย ย ย <span>โจ</span> Paste Mission
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div id="ai-latest-preview"></div>

ย ย ย ย ย ย ย ย <div style="margin-top: 20px;">
ย ย ย ย ย ย ย ย ย ย <div class="ai-card-label" style="font-size: 0.9rem;">๐ Memory Bank</div>
ย ย ย ย ย ย ย ย ย ย <div class="saved-exercises-list" id="ai-memory-list">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="mem-controls">
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-mem-ctrl" onclick="exportMemoryBank()">โฌ๏ธ Export</button>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" id="importMemFile" accept=".json" style="display:none" onchange="importMemoryBank(this)">
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-mem-ctrl" onclick="document.getElementById('importMemFile').click()">โฌ๏ธ Import</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-mem-ctrl" style="color:var(--danger)" onclick="clearAIMemory()">๐๏ธ Clear</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="tab-settings-modal" class="tab-settings-modal" onclick="if(event.target===this) closeTabPopup()">
ย ย ย ย <div class="tab-popup-content">
ย ย ย ย ย ย <div class="tab-popup-header">
ย ย ย ย ย ย ย ย <span>Tab Settings</span>
ย ย ย ย ย ย ย ย <span class="tab-popup-close" onclick="closeTabPopup()">โ</span>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="tab-input-group">
ย ย ย ย ย ย ย ย <input type="text" id="tab-url-input" placeholder="https://... or type 'internal:editor'">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <button class="tab-btn-action btn-paste" onclick="pasteToTabInput()" title="Paste from Clipboard">๐</button>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <button class="tab-btn-action tab-btn-extra" onclick="clearTabUrl()" title="Clear URL">โ</button>
ย ย ย ย ย ย ย ย <button class="tab-btn-action tab-btn-extra" onclick="copyTabUrlFromInput()" title="Copy URL">๐</button>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <button class="tab-btn-action tab-btn-go" onclick="applyTabUrlFromInput()">Go</button>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="fav-list-title">Presets & Favorites</div>
ย ย ย ย ย ย <ul class="fav-list" id="tab-fav-list"></ul>
ย ย ย ย </div>
ย ย </div>

<script>
ย ย /* ====== CONFIG & STATE ====== */
ย ย const STORAGE_KEY = 'mdc_saved_favorites';
ย ย const AI_MEM_KEY = 'mdc_ai_exercises';
ย ย const FAV_KEY = 'mdc_tab_favs';ย
ย ยย
ย ย // Data Guardian Keys
ย ย const MIRROR_RES_KEY = 'mdc_mirror_res_bak';
ย ย const MIRROR_AI_KEY = 'mdc_mirror_ai_bak';

ย ย let currentTargetLang = 'en';ย
ย ย let currentLevel = 'B1-B2 (Intermediate)';
ย ย const transLangs = new Set(['es']);ย
ย ย const LANG_NAMES = { 'en': 'English', 'es': 'Spanish', 'pt': 'Portuguese', 'it': 'Italian' };
ย ยย
ย ย const grid = document.getElementById('video-grid');
ย ย let gridPlayer = null;ย
ย ย let players = [null, null, null, null, null];ย
ย ย let controlTarget = 0;ย

ย ย let currentEditIndex = -1;ย
ย ย let trackingInterval = null;ย
ย ย let currentResourceId = null;ย
ย ย let selectedResourceType = 'auto';ย
ย ย let currentFilter = 'all';ย
ย ย let searchQuery = '';

ย ย const modal = document.getElementById('editor-modal');
ย ย const editorArea = document.getElementById('editor-text');
ย ย const aiModal = document.getElementById('ai-hub-modal');

ย ย // Variables para el sistema de pestaรฑas y Sincronizaciรณn
ย ย let activeTabIndexForPopup = 0;
ย ย let isSyncLocked = true; // Por defecto el candado estรก cerrado (Activo)

ย ย /* ====== INITIALIZATION ====== */
ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย ย loadResources();ย
ย ย ย ย renderAiList();ย
ย ย ย ย updateTransFlagsVisibility();ย
ย ย ย ย initResizer();ย
ย ย ย ย initDataGuardian(); // Seguridad V2
ย ย });

ย ย // Cierra el menรบ de datos si clicamos fuera
ย ย document.addEventListener('click', function(e) {
ย ย ย ย const popup = document.getElementById('data-popup');
ย ย ย ย const btn = document.querySelector('.btn-data-mini');
ย ย ย ย if (popup && popup.classList.contains('active') && !popup.contains(e.target) && !btn.contains(e.target)) {
ย ย ย ย ย ย popup.classList.remove('active');
ย ย ย ย }
ย ย });

ย ย /* ====== SYNC LOCK SYSTEM ====== */
ย ย function toggleSyncLock() {
ย ย ย ย isSyncLocked = !isSyncLocked;
ย ย ย ย const btn = document.getElementById('btn-sync-lock');
ย ย ย ย if(isSyncLocked) {
ย ย ย ย ย ย btn.innerText = "๐";
ย ย ย ย ย ย btn.classList.add('locked');
ย ย ย ย ย ย // Al bloquear, sincronizamos inmediatamente el control a la pestaรฑa que estamos viendo
ย ย ย ย ย ย setControlTarget(activeTabIndexForPopup, true);ย
ย ย ย ย } else {
ย ย ย ย ย ย btn.innerText = "๐";
ย ย ย ย ย ย btn.classList.remove('locked');
ย ย ย ย }
ย ย }

ย ย /* ====== TAB SETTINGS POPUP LOGIC ====== */
ย ยย
ย ย window.editTabUrl = function(index, event) {
ย ย ย ย event.stopPropagation();
ย ย ย ย if(currentEditIndex === -1) {
ย ย ย ย ย ย if(confirm("To configure tabs, you must save the whiteboard first. Save now?")) {ย
ย ย ย ย ย ย ย ย saveFreeModeWork("Study Session Project");ย
ย ย ย ย ย ย } else {ย
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย activeTabIndexForPopup = index;
ย ย ย ย const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
ย ย ย ย const r = resources[currentEditIndex];
ย ย ย ยย
ย ย ย ย let key = index === 0 ? 'url' : `url${index + 1}`;
ย ย ย ย // Para pestaรฑas 2-5, si estรก vacรญo intentamos no mostrar 'undefined'
ย ย ย ย const currentUrl = r[key] || '';
ย ย ย ยย
ย ย ย ย document.getElementById('tab-url-input').value = currentUrl;
ย ย ย ย renderTabFavorites();
ย ย ย ย document.getElementById('tab-settings-modal').classList.add('active');
ย ย }

ย ย function closeTabPopup() { document.getElementById('tab-settings-modal').classList.remove('active'); }

ย ย /* NUEVAS FUNCIONES PARA EL POPUP (LIMPIAR / COPIAR) */
ย ย function clearTabUrl() {
ย ย ย ย document.getElementById('tab-url-input').value = '';
ย ย ย ย document.getElementById('tab-url-input').focus();
ย ย }

ย ย function copyTabUrlFromInput() {
ย ย ย ย const val = document.getElementById('tab-url-input').value;
ย ย ย ย if(val) {
ย ย ย ย ย ย navigator.clipboard.writeText(val);
ย ย ย ย ย ย // Efecto visual rรกpido en el botรณn
ย ย ย ย ย ย const btn = document.querySelector('.tab-btn-extra[onclick="copyTabUrlFromInput()"]');
ย ย ย ย ย ย const original = btn.innerText;
ย ย ย ย ย ย btn.innerText = "โ";
ย ย ย ย ย ย setTimeout(() => btn.innerText = original, 1000);
ย ย ย ย }
ย ย }

ย ย async function pasteToTabInput() {
ย ย ย ย try {
ย ย ย ย ย ย const text = await navigator.clipboard.readText();
ย ย ย ย ย ย document.getElementById('tab-url-input').value = text;
ย ย ย ย } catch (err) {
ย ย ย ย ย ย alert('Failed to paste: ' + err);
ย ย ย ย }
ย ย }

ย ย function applyTabUrlFromInput() {
ย ย ย ย const val = document.getElementById('tab-url-input').value.trim();
ย ย ย ย // Permitimos guardar vacรญo para limpiar la pestaรฑa
ย ย ย ยย
ย ย ย ย const favs = getTabFavorites();ย
ย ย ย ย const exists = favs.some(f => f.url === val);
ย ย ย ยย
ย ย ย ย // Auto-save a favoritos si es una URL compleja y no existe
ย ย ย ย if (val && !exists && val !== 'internal:editor' && val.includes('.')) {ย
ย ย ย ย ย ย if(confirm("Add this site to your Favorites list?")) {ย
ย ย ย ย ย ย ย ย const defaultName = getDomain(val).charAt(0).toUpperCase() + getDomain(val).slice(1);
ย ย ย ย ย ย ย ย const customName = prompt("Enter a name for this favorite:", defaultName);
ย ย ย ย ย ย ย ย if(customName) {
ย ย ย ย ย ย ย ย ย ย addTabFavorite(val, customName);ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }ย
ย ย ย ย }
ย ย ย ย selectTabUrl(val);
ย ย }

ย ย function selectTabUrl(newUrl) {
ย ย ย ย const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));ย
ย ย ย ย const r = resources[currentEditIndex];ย
ย ย ย ย const idx = activeTabIndexForPopup;
ย ย ย ยย
ย ย ย ย let key = idx === 0 ? 'url' : `url${idx + 1}`;ย
ย ย ย ย r[key] = newUrl;
ย ย ย ยย
ย ย ย ย // Detect type change only for main tab (0) to update card icon
ย ย ย ย if (idx === 0) {ย
ย ย ย ย ย ย const ytId = getYouTubeID(newUrl);ย
ย ย ย ย ย ย if (ytId) r.type = 'video';ย
ย ย ย ย ย ย else if (newUrl.match(/\.(mp3|wav|ogg)$/i)) r.type = 'audio';ย
ย ย ย ย ย ย else r.type = 'web';ย
ย ย ย ย }
ย ย ย ยย
ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));ย
ย ย ย ย closeTabPopup();ย
ย ย ย ย openEditorById(r.id);ย
ย ย ย ย setTimeout(() => switchWebTab(idx), 300);
ย ย }

/* ====== FAVORITES LOGIC ====== */
ย ย function getTabFavorites() {
ย ย ย ย const defaults = [
ย ย ย ย ย ย { title: "Google Translate", url: "https://translate.google.com", icon: "https://www.google.com/s2/favicons?domain=translate.google.com" },
ย ย ย ย ย ย { title: "WordReference", url: "https://www.wordreference.com", icon: "https://www.google.com/s2/favicons?domain=wordreference.com" },
ย ย ย ย ย ย { title: "ChatGPT", url: "https://chatgpt.com", icon: "https://www.google.com/s2/favicons?domain=openai.com" }
ย ย ย ย ];
ย ย ย ย const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
ย ย ย ย return [...defaults, ...saved];
ย ย }

ย ย function renderTabFavorites() {
ย ย ย ย const list = document.getElementById('tab-fav-list'); list.innerHTML = '';
ย ย ย ย const favs = getTabFavorites();
ย ย ย ย favs.forEach((fav, idx) => {
ย ย ย ย ย ย const isDefault = idx < 3;ย
ย ย ย ย ย ย const deleteBtn = isDefault ? '' : `<div class="btn-fav-mini btn-fav-del" onclick="deleteTabFavorite(${idx - 3}, event)" title="Delete">โ</div>`;
ย ย ย ย ย ย const actionBtns = `
ย ย ย ย ย ย ย ย <div class="fav-actions">
ย ย ย ย ย ย ย ย ย ย <div class="btn-fav-mini" onclick="copyTabFavorite('${fav.url}', event)" title="Copy">๐</div>
ย ย ย ย ย ย ย ย ย ย ${!fav.url.startsWith('internal:') ? `<div class="btn-fav-mini" onclick="openTabFavoriteExternal('${fav.url}', event)" title="Open External">โ๏ธ</div>` : ''}
ย ย ย ย ย ย ย ย ย ย ${deleteBtn}
ย ย ย ย ย ย ย ย </div>`;

ย ย ย ย ย ย list.innerHTML += `
ย ย ย ย ย ย ย ย <li class="fav-item" onclick="selectTabUrl('${fav.url}')">
ย ย ย ย ย ย ย ย ย ย <img src="${fav.icon}" class="fav-icon" onerror="this.src='about:blank'">
ย ย ย ย ย ย ย ย ย ย <span class="fav-name">${fav.title}</span>
ย ย ย ย ย ย ย ย ย ย ${actionBtns}
ย ย ย ย ย ย ย ย </li>`;
ย ย ย ย });
ย ย }

ย ย function addTabFavorite(url, customName) {
ย ย ย ย const titleToUse = customName || (getDomain(url).charAt(0).toUpperCase() + getDomain(url).slice(1));
ย ย ย ย const newFav = { title: titleToUse, url: url, icon: `https://www.google.com/s2/favicons?domain=${url}&sz=64` };
ย ย ย ย const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); saved.push(newFav); localStorage.setItem(FAV_KEY, JSON.stringify(saved));
ย ย }

ย ย function deleteTabFavorite(savedIndex, e) {
ย ย ย ย e.stopPropagation(); if(!confirm("Remove from favorites?")) return;
ย ย ย ย const saved = JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); saved.splice(savedIndex, 1); localStorage.setItem(FAV_KEY, JSON.stringify(saved)); renderTabFavorites();
ย ย }

ย ย function copyTabFavorite(url, e) {
ย ย ย ย e.stopPropagation();
ย ย ย ย navigator.clipboard.writeText(url).then(() => alert("URL Copied"));
ย ย }

ย ย function openTabFavoriteExternal(url, e) {
ย ย ย ย e.stopPropagation();
ย ย ย ย if (url.startsWith('internal:')) return;
ย ย ย ย window.open(url, '_blank');
ย ย }

ย ย /* ====== CORE HELPER FUNCTIONS ====== */
ย ย function getYouTubeID(url) { if (!url) return null; const match = (url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|live\/)([^#&?]*).*/) || [])[2]; return (match && match.length === 11) ? match : null; }
ย ย function getDomain(url) { try { return new URL(url).hostname.replace('www.', ''); } catch(e) { return 'web'; } }
ย ย function generatePastelColor() { const hue = Math.floor(Math.random() * 360); return `hsl(${hue}, 70%, 90%)`; }
ย ย function escapeHtml(text) { if (!text) return ""; return text.replace(/'/g, "\\'").replace(/"/g, "&quot;"); }

ย ย function initResizer() {
ย ย ย ย const resizer = document.getElementById('drag-resizer'); const leftSide = document.getElementById('desktop-media-wrapper'); const popup = document.getElementById('editor-popup'); let x = 0; let leftWidth = 0;
ย ย ย ย const mouseDownHandler = function(e) { x = e.clientX; leftWidth = leftSide.getBoundingClientRect().width; document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler); resizer.classList.add('dragging'); leftSide.style.pointerEvents = 'none'; };
ย ย ย ย const mouseMoveHandler = function(e) { const dx = e.clientX - x; const newWidth = leftWidth + dx; const percentage = (newWidth / popup.getBoundingClientRect().width) * 100; if (percentage > 20 && percentage < 80) leftSide.style.width = `${percentage}%`; };
ย ย ย ย const mouseUpHandler = function() { document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseMoveHandler); resizer.classList.remove('dragging'); leftSide.style.pointerEvents = 'auto'; };
ย ย ย ย if(resizer) resizer.addEventListener('mousedown', mouseDownHandler);
ย ย }
ย ยย
ย ย function toggleEditorFullScreen() { document.getElementById('editor-popup').classList.toggle('is-fullscreen'); document.getElementById('btn-fullscreen').classList.toggle('active'); }
ย ยย
ย ย function selectTarget(el, lang) { document.querySelectorAll('#target-lang-group .flag-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentTargetLang = lang; updateTransFlagsVisibility(); }
ย ย function selectLevel(el, levelDesc) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); currentLevel = levelDesc; }
ย ย function updateTransFlagsVisibility() { document.querySelectorAll('#trans-lang-group .flag-btn').forEach(btn => { const btnLang = btn.getAttribute('data-lang'); if (btnLang === currentTargetLang) { btn.classList.add('hidden'); btn.classList.remove('selected'); transLangs.delete(btnLang); } else { btn.classList.remove('hidden'); } }); }
ย ย function toggleTrans(el, lang) { if (transLangs.has(lang)) { transLangs.delete(lang); el.classList.remove('selected'); } else { if (transLangs.size >= 3) return alert("Max 3 translation languages."); transLangs.add(lang); el.classList.add('selected'); } }

ย ย /* ====== RESOURCE CRUD ====== */
ย ย function saveFreeModeWork(defaultTitle) {
ย ย ย ย const uniqueCardId = Date.now().toString() + Math.floor(Math.random() * 1000);ย
ย ย ย ย const newRes = {ย
ย ย ย ย ย ย id: uniqueCardId, url: '', url2: '', url3: '', url4: '', url5: '',ย
ย ย ย ย ย ย type: 'web', title: defaultTitle, date: new Date().toLocaleDateString(),ย
ย ย ย ย ย ย note: editorArea.innerHTML, lastTime: 0, color: generatePastelColor()ย
ย ย ย ย };
ย ย ย ย let resources = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];ย
ย ย ย ย resources.unshift(newRes);ย
ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));ย
ย ย ย ย loadResources();
ย ย ย ย const newIndex = resources.findIndex(r => r.id === uniqueCardId);ย
ย ย ย ย currentEditIndex = newIndex;ย
ย ย ย ย currentResourceId = uniqueCardId;ย
ย ย ย ย document.getElementById('editor-popup').classList.remove('free-mode');ย
ย ย ย ย return uniqueCardId;
ย ย }
ย ยย
ย ย function deleteResourceById(id) {ย
ย ย ย ย if(confirm("Delete this resource?")) {ย
ย ย ย ย ย ย let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');ย
ย ย ย ย ย ย resources = resources.filter(r => String(r.id) !== String(id));ย
ย ย ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));ย
ย ย ย ย ย ย loadResources();ย
ย ย ย ย }ย
ย ย }
ย ยย
ย ย function duplicateResourceById(id) {ย
ย ย ย ย let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');ย
ย ย ย ย const original = resources.find(r => String(r.id) === String(id));ย
ย ย ย ย if (!original) return;ย
ย ย ย ย const copy = JSON.parse(JSON.stringify(original));ย
ย ย ย ย copy.title = copy.title + " (Copy)";ย
ย ย ย ย copy.id = Date.now().toString() + Math.floor(Math.random() * 1000);ย
ย ย ย ย resources.unshift(copy);ย
ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));ย
ย ย ย ย loadResources();ย
ย ย }
ย ยย
ย ย function editResourceMetaById(id) {ย
ย ย ย ย let resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');ย
ย ย ย ย const index = resources.findIndex(r => String(r.id) === String(id));ย
ย ย ย ย if (index === -1) return;ย
ย ย ย ย const r = resources[index];ย
ย ย ย ย const newTitle = prompt("Edit Title:", r.title); if (newTitle === null) return;ย
ย ย ย ย const newUrl = prompt("Edit Primary URL (Tab 1):", r.url); if (newUrl === null) return;ย
ย ย ย ย r.title = newTitle; r.url = newUrl;ย
ย ย ย ย const ytId = getYouTubeID(newUrl);ย
ย ย ย ย if (ytId) r.type = 'video'; else if (newUrl.match(/\.(mp3|wav|ogg)$/i)) r.type = 'audio'; else r.type = 'web';ย
ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(resources));ย
ย ย ย ย loadResources();ย
ย ย }

ย ย function clearResources(type) {ย
ย ย ย ย if(!confirm(`Are you sure you want to delete ${type === 'all' ? 'EVERYTHING' : 'all ' + type + ' resources'}?`)) return;ย
ย ย ย ย let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');ย
ย ย ย ย if(type === 'all') { data = []; } else { data = data.filter(r => { const rType = r.type || 'video'; return rType !== type; }); }ย
ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(data));ย
ย ย ย ย loadResources();ย
ย ย ย ย const popup = document.getElementById('data-popup');
ย ย ย ย if(popup) popup.classList.remove('active');
ย ย }

ย ย function applySearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); loadResources(); }
ย ยย
ย ย function loadResources() {ย
ย ย ย ย const data = localStorage.getItem(STORAGE_KEY);ย
ย ย ย ย let allResources = [];ย
ย ย ย ย try { allResources = data ? JSON.parse(data) : []; if (!Array.isArray(allResources)) throw new Error("Data is not an array"); } catch (e) { allResources = []; }ย
ย ย ย ย const filtered = allResources.filter(item => {ย
ย ย ย ย ย ย const type = item.type || 'video';ย
ย ย ย ย ย ย if (currentFilter !== 'all' && type !== currentFilter) return false;ย
ย ย ย ย ย ย if (searchQuery && !item.title.toLowerCase().includes(searchQuery)) return false;ย
ย ย ย ย ย ย return true;ย
ย ย ย ย });ย
ย ย ย ย renderGrid(filtered);ย
ย ย }

ย ย function renderGrid(resources) {
ย ย ย ย grid.innerHTML = resources.length ? '' : '<div style="grid-column:1/-1;text-align:center;color:#666;margin-top:40px">No resources found.</div>';
ย ย ย ย resources.forEach((r) => {
ย ย ย ย ย ย const hasNote = r.note && r.note.replace(/<[^>]*>/g, '').trim().length > 0;
ย ย ย ย ย ย const type = r.type || 'video'; let mediaContent = '';
ย ย ย ย ย ย if (type === 'video') { const videoId = getYouTubeID(r.url); if (videoId) { mediaContent = `<div class="media-area video" onclick="initGridPlayer(this, '${r.id}', '${videoId}')"><img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg"><div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>`; } else { mediaContent = `<div class="media-area video" style="background:#000; display:flex; align-items:center; justify-content:center; color:#666; font-size:0.8rem;">Invalid URL</div>`; } }ย
ย ย ย ย ย ย else if (type === 'audio') { mediaContent = `<div class="media-area audio" onclick="openEditorById('${r.id}')"><div class="audio-icon">๐ง</div></div>`; }ย
ย ย ย ย ย ย else if (type === 'web') { const domain = getDomain(r.url || r.id); const faviconUrl = `https://www.google.com/s2/favicons?domain=${r.url || r.id}&sz=128`; mediaContent = `<div class="media-area web" style="background:${r.color || '#e3f2fd'}" onclick="openEditorById('${r.id}')"><div class="web-favicon-box"><img src="${faviconUrl}" onerror="this.src='about:blank'"></div><div class="web-domain-tag">WEB RESOURCE</div><div class="web-domain-text">${domain}</div></div>`; }
ย ย ย ย ย ย grid.innerHTML += `<div class="resource-card">${mediaContent}<div class="card-info"><div class="card-title">${hasNote ? '๐ ' : ''}${r.title}</div><div class="card-actions"><button class="btn-action btn-edit" onclick="openEditorById('${r.id}')" title="Open Editor">โ๏ธ</button><button class="btn-action btn-duplicate" onclick="duplicateResourceById('${r.id}')" title="Duplicate">๐</button><button class="btn-action btn-meta" onclick="editResourceMetaById('${r.id}')" title="Edit Data">๐ง</button><button class="btn-action btn-delete" onclick="deleteResourceById('${r.id}')" title="Delete">๐๏ธ</button></div></div></div>`;
ย ย ย ย });
ย ย }

ย ย /* ====== MEDIA PLAYERS ====== */
ย ย function initGridPlayer(el, cardId, videoId) { if (!videoId) return alert("Video ID not found."); currentResourceId = cardId; const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); const resData = resources.find(v => String(v.id) === String(cardId)); const startTime = resData ? (resData.lastTime || 0) : 0; el.innerHTML = `<div id="p-${cardId}" class="video-target"></div>`; el.onclick = null; gridPlayer = new YT.Player(`p-${cardId}`, { width:'100%', height:'100%', videoId: videoId, playerVars: { autoplay: 1, rel: 0, start: Math.floor(startTime) }, events: { 'onReady': (e) => { e.target.playVideo(); players[0] = gridPlayer; }, 'onStateChange': (e) => onPlayerStateChange(e, cardId, gridPlayer) } }); }
ย ย function onPlayerStateChange(event, id, playerInstance) { const playBtn = document.getElementById('btn-main-play'); const isControlled = (players[controlTarget] === playerInstance); if (event.data === 1) { stopTracking(); trackingInterval = setInterval(() => saveMediaTime(playerInstance, id), 5000); if(playBtn && isControlled) { playBtn.innerText = "โธ๏ธ"; playBtn.classList.add('is-playing'); playBtn.classList.remove('is-paused'); } } else { saveMediaTime(playerInstance, id); stopTracking(); if(playBtn && isControlled) { playBtn.innerText = "โถ๏ธ"; playBtn.classList.add('is-paused'); playBtn.classList.remove('is-playing'); } } }
ย ย function saveMediaTime(player, id) { if (!player) return; let currentTime = 0; if (typeof player.getCurrentTime === 'function') { currentTime = player.getCurrentTime(); } else if (player.tagName === 'AUDIO') { currentTime = player.currentTime; } if (currentTime > 0) { const resources = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); const index = resources.findIndex(v => String(v.id) === String(id)); if (index !== -1) { resources[index].lastTime = currentTime; localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); } } }
ย ย function stopTracking() { if (trackingInterval) { clearInterval(trackingInterval); trackingInterval = null; } }

ย ย /* ====== BACKUP & RESTORE ====== */
ย ย function downloadBackup() {ย
ย ย ย ย const rawResources = localStorage.getItem(STORAGE_KEY); const rawMemory = localStorage.getItem(AI_MEM_KEY); const rawFavs = localStorage.getItem(FAV_KEY);ย
ย ย ย ย const resources = rawResources ? JSON.parse(rawResources) : []; const memory = rawMemory ? JSON.parse(rawMemory) : []; const favs = rawFavs ? JSON.parse(rawFavs) : [];
ย ย ย ย alert(`Generating Backup:\n๐ Resources: ${resources.length}\n๐ง AI Exercises: ${memory.length}\nโญ Tab Favorites: ${favs.length}`);
ย ย ย ย const fullData = { version: 3, resources: resources, memory: memory, favs: favs }; const d = JSON.stringify(fullData); const encodedData = btoa(unescape(encodeURIComponent(d)));
ย ย ย ย const htmlContent = `<!DOCTYPE html><html><head><title>MDC Full Backup</title></head><body><h1>MDC Polyglot Full Backup</h1><p>Data Summary: ${resources.length} Resources, ${memory.length} AI Exercises.</p><p><strong>Upload this file using the Import button.</strong></p><script>const backupData = "${encodedData}";<\/script></body></html>`;
ย ย ย ย const b = new Blob([htmlContent], {type: 'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); const dateStr = new Date().toISOString().split('T')[0]; a.download = `MDC_FullBackup_${dateStr}.html`; document.body.appendChild(a); a.click(); document.body.removeChild(a);ย
ย ย }

ย ย function importBackup(inp) {ย
ย ย ย ย const file = inp.files[0]; if (!file) return;
ย ย ย ย const r = new FileReader(); r.onload = e => {ย
ย ย ย ย ย ย try {ย
ย ย ย ย ย ย ย ย const content = e.target.result;
ย ย ย ย ย ย ย ย let match = content.match(/const backupData\s*=\s*"(.*?)";/); if (!match) match = content.match(/const backupData=(.*?)(;|<\/script>)/s); if (!match) throw new Error("No backup data found.");
ย ย ย ย ย ย ย ย let json = match[1]; try { json = decodeURIComponent(escape(atob(json))); } catch(e) { console.log("Legacy decode fallback"); } const parsedData = JSON.parse(json);
ย ย ย ย ย ย ย ย if (parsedData.version >= 2 || (parsedData.resources && parsedData.memory)) {
ย ย ย ย ย ย ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(parsedData.resources)); localStorage.setItem(AI_MEM_KEY, JSON.stringify(parsedData.memory));
ย ย ย ย ย ย ย ย ย ย if(parsedData.favs) localStorage.setItem(FAV_KEY, JSON.stringify(parsedData.favs));
ย ย ย ย ย ย ย ย ย ย alert(`โ RESTORE COMPLETE:\n๐ Resources: ${parsedData.resources.length}\n๐ง AI Exercises: ${parsedData.memory.length}`);
ย ย ย ย ย ย ย ย } else if (Array.isArray(parsedData)) {
ย ย ย ย ย ย ย ย ย ย if(confirm("Legacy backup detected. Keep existing AI data?")) { localStorage.setItem(STORAGE_KEY, JSON.stringify(parsedData)); }ย
ย ย ย ย ย ย ย ย ย ย else { localStorage.setItem(STORAGE_KEY, JSON.stringify(parsedData)); localStorage.setItem(AI_MEM_KEY, '[]'); }
ย ย ย ย ย ย ย ย ย ย alert("โ Resources restored (Legacy format).");
ย ย ย ย ย ย ย ย } else { throw new Error("Unknown format."); }
ย ย ย ย ย ย ย ย loadResources(); renderAiList(); inp.value = '';ย
ย ย ย ย ย ย } catch (err) { alert("โ Error importing: " + err.message); }
ย ย ย ย }; r.readAsText(file);ย
ย ย }

ย ย /* ====== CONTROL & TAB SWITCHING ====== */
ย ย window.setControlTarget = function(idx, fromSync = false) {
ย ย ย ย controlTarget = idx;
ย ย ย ย document.querySelectorAll('.btn-target').forEach((b, i) => {ย
ย ย ย ย ย ย if(i === idx) b.classList.add('active'); else b.classList.remove('active');ย
ย ย ย ย });
ย ย ย ยย
ย ย ย ย // Sync Lock Logic: Sync Tab to Control
ย ย ย ย if (isSyncLocked && !fromSync) { switchWebTab(idx, true); }

ย ย ย ย const p = players[controlTarget];
ย ย ย ย const playBtn = document.getElementById('btn-main-play');
ย ย ย ย if(p && typeof p.getPlayerState === 'function') {
ย ย ย ย ย ย if(p.getPlayerState() === 1) { playBtn.innerText = "โธ๏ธ"; playBtn.classList.add('is-playing'); }ย
ย ย ย ย ย ย else { playBtn.innerText = "โถ๏ธ"; playBtn.classList.remove('is-playing'); }
ย ย ย ย }
ย ย }

ย ย function openFreeEditor() {ย
ย ย ย ย currentEditIndex = -1; currentResourceId = null; editorArea.innerHTML = ""; modal.classList.add('active'); document.getElementById('editor-popup').classList.remove('free-mode'); document.getElementById('editor-popup').style.opacity = 1; players = [null, null, null, null, null];ย
ย ย ย ย const container = document.getElementById('desktop-media-wrapper');ย
ย ย ย ย const getBtn = (idx) => `<button class="web-tab-btn channel-${idx+1} ${idx===0?'active':''}" onclick="switchWebTab(${idx})">Tab ${idx + 1}<span class="tab-gear" onclick="window.editTabUrl(${idx}, event)">โ๏ธ</span></button>`;ย
ย ย ย ย const getContent = (idx) => `<div class="web-frame-container ${idx===0?'active':''}" id="tab-content-${idx}"><div class="web-error-bg"><span>Empty Tab<br><small>Click โ๏ธ to add resource</small></span></div></div>`;ย
ย ย ย ย let tabsHtml = `<div class="media-iframe-wrapper"><div class="web-tab-nav">${getBtn(0)}${getBtn(1)}${getBtn(2)}${getBtn(3)}${getBtn(4)}</div><div class="web-content-area">${getContent(0)}${getContent(1)}${getContent(2)}${getContent(3)}${getContent(4)}</div></div>`;ย
ย ย ย ย container.innerHTML = tabsHtml; if(gridPlayer) gridPlayer.pauseVideo(); updateToolbarState();ย
ย ย }

ย ย window.switchWebTab = function(idx, fromSync = false) {ย
ย ย ย ย activeTabIndexForPopup = idx;
ย ย ย ย document.querySelectorAll('.web-tab-btn').forEach((b, i) => {ย
ย ย ย ย ย ย if(b.innerText.includes('Externally')) return;ย
ย ย ย ย ย ย const buttons = Array.from(document.querySelectorAll('.web-tab-btn')).filter(btn => !btn.innerText.includes('Externally'));ย
ย ย ย ย ย ย if(buttons[idx]) { buttons.forEach(btn => btn.classList.remove('active')); buttons[idx].classList.add('active'); }ย
ย ย ย ย });ย
ย ย ย ย document.querySelectorAll('.web-frame-container').forEach((f, i) => { if(i === idx) f.classList.add('active'); else f.classList.remove('active'); });ย
ย ย ย ยย
ย ย ย ย // Sync Lock Logic: Sync Control to Tab
ย ย ย ย if (isSyncLocked && !fromSync) { setControlTarget(idx, true); }
ย ย };

ย ย function openEditorById(id) {
ย ย ย ย const resources = JSON.parse(localStorage.getItem(STORAGE_KEY));
ย ย ย ย const index = resources.findIndex(r => String(r.id) === String(id));
ย ย ย ย if (index === -1) return;
ย ย ย ย currentEditIndex = index; const resData = resources[index]; currentResourceId = resData.id;
ย ย ย ย editorArea.innerHTML = resData.note || ""; const type = resData.type || 'video';
ย ย ย ย modal.classList.add('active'); document.getElementById('editor-popup').classList.remove('free-mode'); document.getElementById('editor-popup').style.opacity = 1;
ย ย ย ย const container = document.getElementById('desktop-media-wrapper'); container.innerHTML = '';ย
ย ย ย ย const isDesktop = window.matchMedia("(min-width: 900px)").matches; let startTime = resData.lastTime || 0;
ย ย ย ย players = [null, null, null, null, null]; setControlTarget(0, true);ย

ย ย ย ย const ytId1 = getYouTubeID(resData.url);
ย ย ย ย const ytId2 = getYouTubeID(resData.url2);
ย ย ย ย const ytId3 = getYouTubeID(resData.url3);
ย ย ย ย const ytId4 = getYouTubeID(resData.url4);ย
ย ย ย ย const ytId5 = getYouTubeID(resData.url5);ย

ย ย ย ย const renderTabs = (content1, content2, content3, content4, content5) => {
ย ย ย ย ย ย const getBtn = (idx, link) => {
ย ย ย ย ย ย ย ย const activeClass = idx === 0 ? 'active' : '';
ย ย ย ย ย ย ย ย return `<button class="web-tab-btn channel-${idx+1} ${activeClass}" onclick="switchWebTab(${idx})" title="${link || ''}">Tab ${idx + 1}<span class="tab-gear" onclick="window.editTabUrl(${idx}, event)">โ๏ธ</span></button>`;
ย ย ย ย ย ย };
ย ย ย ย ย ย return `<div class="media-iframe-wrapper"><div class="web-tab-nav">${getBtn(0, resData.url)}${resData.url2 ? getBtn(1, resData.url2) : getBtn(1, '')}${resData.url3 ? getBtn(2, resData.url3) : getBtn(2, '')}${resData.url4 ? getBtn(3, resData.url4) : getBtn(3, '')}${resData.url5 ? getBtn(4, resData.url5) : getBtn(4, '')}</div><div class="web-content-area"><div class="web-frame-container active" id="tab-content-0">${content1}</div><div class="web-frame-container" id="tab-content-1">${content2 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-2">${content3 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-3">${content4 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div><div class="web-frame-container" id="tab-content-4">${content5 || '<div class="web-error-bg"><span>Empty Tab</span></div>'}</div></div></div>`;
ย ย ย ย };

ย ย ย ย const getTabContent = (link, ytId, index) => {
ย ย ย ย ย ย if (link === 'internal:editor') { return `<div class="embedded-editor-area" contenteditable="true" oninput="document.getElementById('editor-text').innerHTML = this.innerHTML; window.saveNote();">${resData.note || ''}</div><div style="position:absolute; bottom:5px; right:5px; font-size:10px; color:#aaa; background:#fff; padding:2px;">Linked to Main Note</div>`; }
ย ย ย ย ย ย if(ytId) return `<div id="player-tab-${index}" style="width:100%;height:100%"></div>`;
ย ย ย ย ย ย if(link) return `<iframe src="${link}" allowfullscreen style="width:100%;height:100%;border:none;position:relative;z-index:2"></iframe>`;
ย ย ย ย ย ย return null;
ย ย ย ย };

ย ย ย ย const htmlContent2 = getTabContent(resData.url2, ytId2, 2);
ย ย ย ย const htmlContent3 = getTabContent(resData.url3, ytId3, 3);
ย ย ย ย const htmlContent4 = getTabContent(resData.url4, ytId4, 4);ย
ย ย ย ย const htmlContent5 = getTabContent(resData.url5, ytId5, 5);ย

ย ย ย ย const initSubPlayers = () => {
ย ย ย ย ย ย if(ytId2) players[1] = new YT.Player(`player-tab-2`, { width: '100%', height: '100%', videoId: ytId2, playerVars: { rel: 0 } });
ย ย ย ย ย ย if(ytId3) players[2] = new YT.Player(`player-tab-3`, { width: '100%', height: '100%', videoId: ytId3, playerVars: { rel: 0 } });
ย ย ย ย ย ย if(ytId4) players[3] = new YT.Player(`player-tab-4`, { width: '100%', height: '100%', videoId: ytId4, playerVars: { rel: 0 } });ย
ย ย ย ย ย ย if(ytId5) players[4] = new YT.Player(`player-tab-5`, { width: '100%', height: '100%', videoId: ytId5, playerVars: { rel: 0 } });ย
ย ย ย ย };

ย ย ย ย if (type === 'video') {
ย ย ย ย ย ย if (isDesktop) {
ย ย ย ย ย ย ย ย if (gridPlayer && typeof gridPlayer.getCurrentTime === 'function' && gridPlayer.getVideoData().video_id === ytId1) { startTime = gridPlayer.getCurrentTime(); gridPlayer.pauseVideo(); }
ย ย ย ย ย ย ย ย container.innerHTML = renderTabs('<div id="desktop-player-target" style="width:100%; height:100%;"></div>', htmlContent2, htmlContent3, htmlContent4, htmlContent5);
ย ย ย ย ย ย ย ย if (ytId1) { players[0] = new YT.Player('desktop-player-target', { width: '100%', height: '100%', videoId: ytId1, playerVars: { autoplay: 0, rel: 0, start: Math.floor(startTime) }, events: { 'onStateChange': (e) => onPlayerStateChange(e, id, players[0]) } }); }
ย ย ย ย ย ย ย ย initSubPlayers();
ย ย ย ย ย ย } else { if (gridPlayer) { players[0] = gridPlayer; gridPlayer.pauseVideo(); } }
ย ย ย ย } else if (type === 'audio') {
ย ย ย ย ย ย if (isDesktop) {
ย ย ย ย ย ย ย ย const audioHtml = `<div class="media-audio-wrapper"><audio controls id="modal-audio-player" src="${resData.url}"></audio></div>`;
ย ย ย ย ย ย ย ย container.innerHTML = renderTabs(audioHtml, htmlContent2, htmlContent3, htmlContent4, htmlContent5);
ย ย ย ย ย ย ย ย const audioEl = document.getElementById('modal-audio-player'); audioEl.currentTime = startTime; players[0] = audioEl;
ย ย ย ย ย ย ย ย audioEl.addEventListener('play', () => { stopTracking(); trackingInterval = setInterval(() => saveMediaTime(audioEl, id), 5000); });
ย ย ย ย ย ย ย ย audioEl.addEventListener('pause', () => { saveMediaTime(audioEl, id); stopTracking(); });
ย ย ย ย ย ย ย ย initSubPlayers();
ย ย ย ย ย ย }
ย ย ย ย } else if (type === 'web') {
ย ย ย ย ย ย if (isDesktop) {
ย ย ย ย ย ย ย ย const webContent1 = `<iframe src="${resData.url}" allowfullscreen style="width:100%;height:100%;border:none;position:relative;z-index:2"></iframe>`;
ย ย ย ย ย ย ย ย container.innerHTML = renderTabs(webContent1, htmlContent2, htmlContent3, htmlContent4, htmlContent5);
ย ย ย ย ย ย ย ย players[0] = null; initSubPlayers();
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย updateToolbarState();
ย ย }

ย ย function closeEditor() {
ย ย ย ย if(currentEditIndex === -1) {
ย ย ย ย ย ย const hasContent = editorArea.innerText.trim().length > 0 || editorArea.innerHTML.includes('<img') || editorArea.innerHTML.includes('<iframe');
ย ย ย ย ย ย if(hasContent && confirm("Save current whiteboard session?")) { saveFreeModeWork("Saved Session " + new Date().toLocaleTimeString()); }
ย ย ย ย }
ย ย ย ย if (players[0] && currentResourceId) { saveMediaTime(players[0], currentResourceId); stopTracking(); }ย
ย ย ย ย players.forEach(p => { if (p && typeof p.destroy === 'function') { p.destroy(); } }); players = [null, null, null, null, null];
ย ย ย ย loadResources(); modal.classList.remove('active'); document.getElementById('editor-popup').classList.remove('is-fullscreen'); document.getElementById('btn-fullscreen').classList.remove('active'); document.getElementById('editor-popup').classList.remove('free-mode'); document.getElementById('desktop-media-wrapper').innerHTML = ''; currentEditIndex = -1; gridPlayer = null; closeAIMenu();
ย ย }
ย ยย
ย ย window.saveNote = function() { if(currentEditIndex > -1) { const selects = editorArea.querySelectorAll('select'); selects.forEach(s => { const val = s.value; const opts = s.querySelectorAll('option'); opts.forEach(o => { if (o.value === val) o.setAttribute('selected', 'true'); else o.removeAttribute('selected'); }); }); const resources = JSON.parse(localStorage.getItem(STORAGE_KEY)); resources[currentEditIndex].note = editorArea.innerHTML; localStorage.setItem(STORAGE_KEY, JSON.stringify(resources)); } }
ย ย window.resetExerciseBlock = function(btn) { const box = btn.closest('.exercise-box'); if(box) { const selects = box.querySelectorAll('select'); selects.forEach(s => { s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); s.selectedIndex = 0; }); window.saveNote(); } };
ย ย function seekVideo(s) { const p = players[controlTarget]; if(!p) return; if(typeof p.seekTo === 'function') { p.seekTo(p.getCurrentTime()+s, true); } else if (p.tagName === 'AUDIO') { p.currentTime += s; } }
ย ย function togglePlay() { const p = players[controlTarget]; if(!p) return; if(typeof p.getPlayerState === 'function') { p.getPlayerState()===1 ? p.pauseVideo() : p.playVideo(); } else if (p.tagName === 'AUDIO') { p.paused ? p.play() : p.pause(); } }
ย ย function cycleSpeed() { const p = players[controlTarget]; if (!p) return; let r = 1; const t = document.getElementById('btn-speed').innerText; if(t==='1x') r=0.9; else if(t==='0.9x') r=0.8; else if(t==='0.8x') r=0.7; else if(t==='0.7x') r=0.6; else if(t==='0.6x') r=0.5; if(typeof p.setPlaybackRate === 'function') { p.setPlaybackRate(r); } else if (p.tagName === 'AUDIO') { p.playbackRate = r; } document.getElementById('btn-speed').innerText=r+'x'; }
ย ย function applyColor(hex) { document.execCommand('foreColor', false, hex); updateToolbarState(); }
ย ย function toggleBold() { document.execCommand('bold'); updateToolbarState(); }
ย ย function setSize(size) { document.execCommand('fontSize', false, size); updateToolbarState(); }
ย ย function setFont(fontName) { document.execCommand('fontName', false, fontName); updateToolbarState(); }

ย ย editorArea.addEventListener('keyup', updateToolbarState); editorArea.addEventListener('mouseup', updateToolbarState); editorArea.addEventListener('click', updateToolbarState); editorArea.addEventListener('input', window.saveNote);
ย ยย
ย ย function updateToolbarState() {ย
ย ย ย ย const isBold = document.queryCommandState('bold');ย
ย ย ย ย document.getElementById('btn-bold').classList.toggle('active', isBold);ย
ย ย ย ยย
ย ย ย ย const size = document.queryCommandValue('fontSize');ย
ย ย ย ย document.getElementById('btn-size-lg').classList.toggle('active', size === '5' || size === 'x-large');ย
ย ย ย ย document.getElementById('btn-size-norm').classList.toggle('active', size !== '5' && size !== 'x-large');ย
ย ย ย ยย
ย ย ย ย const rgb = document.queryCommandValue('foreColor');ย
ย ย ย ย document.querySelectorAll('.color-circle').forEach(b => b.classList.remove('active'));ย
ย ย ย ย if(rgb) {
ย ย ย ย ย ย if(rgb.includes('255, 59, 48')) document.querySelectorAll('.color-circle')[1].classList.add('active');ย
ย ย ย ย ย ย else if (rgb.includes('0, 122, 255')) document.querySelectorAll('.color-circle')[2].classList.add('active');ย
ย ย ย ย ย ย else if (rgb.includes('52, 199, 89')) document.querySelectorAll('.color-circle')[3].classList.add('active');ย
ย ย ย ย ย ย else document.querySelectorAll('.color-circle')[0].classList.add('active');ย
ย ย ย ย }

ย ย ย ย const font = document.queryCommandValue('fontName');
ย ย ย ย document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
ย ย ย ย if(font) {
ย ย ย ย ย ย if(font.includes('Inter')) document.querySelectorAll('.font-btn')[0].classList.add('active');
ย ย ย ย ย ย else if(font.includes('Playfair')) document.querySelectorAll('.font-btn')[1].classList.add('active');
ย ย ย ย ย ย else if(font.includes('Courier')) document.querySelectorAll('.font-btn')[2].classList.add('active');
ย ย ย ย ย ย else if(font.includes('Dancing')) document.querySelectorAll('.font-btn')[3].classList.add('active');
ย ย ย ย }
ย ย }

ย ย /* ====== AI HUB LOGIC ====== */
ย ย function openAIMenu() { aiModal.classList.add('active'); renderAiList(); }
ย ย function closeAIMenu() { aiModal.classList.remove('active'); }
ย ย function checkCustomOverride(inputId, selectId) { const inputVal = document.getElementById(inputId).value.trim(); const selectEl = document.getElementById(selectId); if(inputVal.length > 0) { selectEl.classList.add('override-warning'); } else { selectEl.classList.remove('override-warning'); } }
ย ยย
ย ย function saveEditorAsTemplate() { const rawContent = document.getElementById('editor-text').innerHTML.trim(); if(!rawContent || rawContent === "<br>") return alert("Editor is empty."); const name = prompt("Name this lesson template:"); if(!name) return; const tempDiv = document.createElement('div'); tempDiv.innerHTML = rawContent; tempDiv.querySelectorAll('select').forEach(s => { s.value = ""; s.classList.remove('correct', 'wrong'); s.querySelectorAll('option').forEach(o => o.removeAttribute('selected')); }); tempDiv.querySelectorAll('.hint-box, .trans-box, .theory-box').forEach(box => { box.style.display = 'none'; }); const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory.unshift({ id: Date.now(), title: name, isHtml: true, htmlContent: tempDiv.innerHTML, lang: 'en', date: new Date().toLocaleDateString(), data: [] }); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); alert("Template saved!"); renderAiList(); }
ย ยย
ย ย function exportMemoryBank() { const data = localStorage.getItem(AI_MEM_KEY); if(!data || data === '[]') return alert("Memory is empty."); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'polyglot_memory_full.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
ย ย function importMemoryBank(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if(!Array.isArray(importedData)) throw new Error("Invalid format"); const current = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const combined = [...importedData, ...current]; localStorage.setItem(AI_MEM_KEY, JSON.stringify(combined)); renderAiList(); alert("Import Successful!"); } catch(err) { alert("Error importing: " + err.message); } }; reader.readAsText(file); }
ย ย function renameMemoryItem(id) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const idx = memory.findIndex(i => i.id === id); if(idx > -1) { const newTitle = prompt("New Title:", memory[idx].title); if(newTitle) { memory[idx].title = newTitle; localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } } }
ย ย function exportSingleItem(id) { const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); const item = memory.find(x => x.id === id); if(!item) return; const data = JSON.stringify([item], null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const safeName = (item.title || 'exercise').replace(/[^a-z0-9]/gi, '_').toLowerCase(); a.download = `${safeName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
ย ย function deleteMemoryItem(id) { if(confirm("Delete?")) { let memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]'); memory = memory.filter(item => item.id !== id); localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory)); renderAiList(); } }
ย ย function clearAIMemory() { if(confirm("Clear all?")) { localStorage.removeItem(AI_MEM_KEY); renderAiList(); } }
ย ยย
ย ย // MODIFICADO: Renderiza el รบltimo creado arriba y la lista completa abajo
ย ย function renderAiList() {ย
ย ย ย ย const listContainer = document.getElementById('ai-memory-list');ย
ย ย ย ย const previewContainer = document.getElementById('ai-latest-preview');
ย ย ย ย const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');ย
ย ย ย ยย
ย ย ย ย previewContainer.innerHTML = '';
ย ย ย ย listContainer.innerHTML = '';

ย ย ย ย if (memory.length === 0) {ย
ย ย ย ย ย ย listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px; font-size:0.8rem;">No exercises saved yet.</div>';ย
ย ย ย ย ย ย return;ย
ย ย ย ย }ย

ย ย ย ย const createItemHtml = (item, index, isPreview = false) => {
ย ย ย ย ย ย let flag = "๐ฌ๐ง"; if(item.lang === 'es') flag = "๐ช๐ธ"; if(item.lang === 'pt') flag = "๐ง๐ท"; if(item.lang === 'it') flag = "๐ฎ๐น";ย
ย ย ย ย ย ย let newBadge = (index === 0 && !isPreview) ? '<span class="badge-new">NEW</span>' : '';ย
ย ย ย ย ย ย let typeBadge = item.isHtml ? '<span class="badge-tpl">TEMPLATE</span>' : `โข ${item.data.length} Qs`;ย
ย ย ย ย ย ยย
ย ย ย ย ย ย // Clase diferente si es el preview
ย ย ย ย ย ย let boxClass = isPreview ? 'saved-item ai-preview-box' : 'saved-item';
ย ย ย ย ย ย let titlePrefix = isPreview ? '๐ LATEST CREATED: ' : '';

ย ย ย ย ย ย return `<div class="${boxClass}" style="${isPreview ? 'background:#f0fff4; border-bottom:none;' : ''}">
ย ย ย ย ย ย ย ย <div class="saved-num">${isPreview ? 'โญ' : '#' + (index + 1)}</div>
ย ย ย ย ย ย ย ย <div class="saved-info">
ย ย ย ย ย ย ย ย ย ย <span class="saved-name">${flag} ${titlePrefix}${item.title} ${newBadge}</span>
ย ย ย ย ย ย ย ย ย ย <span class="saved-date">${item.date} ${typeBadge}</span>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="mem-actions">
ย ย ย ย ย ย ย ย ย ย <button class="btn-insert" onclick="insertExerciseFromMem(${item.id})">Insert</button>
ย ย ย ย ย ย ย ย ย ย <button class="btn-icon-action btn-export-item" onclick="exportSingleItem(${item.id})" title="Export JSON">โฌ๏ธ</button>
ย ย ย ย ย ย ย ย ย ย <button class="btn-icon-action btn-rename" onclick="renameMemoryItem(${item.id})" title="Rename">โ๏ธ</button>
ย ย ย ย ย ย ย ย ย ย <button class="btn-icon-action btn-delete-item" onclick="deleteMemoryItem(${item.id})" title="Delete">ร</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>`;ย
ย ย ย ย };

ย ย ย ย // Renderizar el รบltimo (preview)
ย ย ย ย if(memory.length > 0) {
ย ย ย ย ย ย previewContainer.innerHTML = createItemHtml(memory[0], 0, true);
ย ย ย ย }

ย ย ย ย // Renderizar la lista completa (Bank)
ย ย ย ย let listHtml = '';
ย ย ย ย memory.forEach((item, index) => {ย
ย ย ย ย ย ย listHtml += createItemHtml(item, index, false);
ย ย ย ย });ย
ย ย ย ย listContainer.innerHTML = listHtml;ย
ย ย }
ย ยย
function copyProfessorPrompt() {
ย ย ย ย const ctxSel = document.getElementById('ai-context-select').value;
ย ย ย ย const graSel = document.getElementById('ai-grammar-select').value;
ย ย ย ย const typSel = document.getElementById('ai-type-select').value;
ย ย ย ย const gapCount = document.getElementById('ai-gap-count').value;
ย ย ย ย 
ย ย ย ย // ๐ NUEVA LรNEA: Obtener el nรบmero de opciones (OPC. por Gap)
ย ย ย ย const optionCount = document.getElementById('ai-option-count').value || 4; // Default a 4 si el campo estรก vacรญo
ย ย ย ยย
ย ย ย ย const ctxCust = document.getElementById('ai-context-custom').value.trim();
ย ย ย ย const graCust = document.getElementById('ai-grammar-custom').value.trim();
ย ย ย ย const typCust = document.getElementById('ai-type-custom').value.trim();
ย ย ย ย const extraData = document.getElementById('ai-extra-data').value.trim();
ย ย ย ยย
ย ย ย ย const quantity = document.getElementById('ai-sentence-count').value || 5;

ย ย ย ย let requirements = [];
ย ย ย ย let isGrammarFocus = false;
ย ย ย ย let typeStr = typCust ? typCust : typSel;

ย ย ย ย if(ctxCust) requirements.push(`Topic Context: ${ctxCust}`);
ย ย ย ย else if(ctxSel) requirements.push(`Topic Context: ${ctxSel}`);

ย ย ย ย if(graCust) {
ย ย ย ย ย ย requirements.push(`Grammar Focus: ${graCust}`);
ย ย ย ย ย ย isGrammarFocus = true;
ย ย ย ย } else if(graSel) {
ย ย ย ย ย ย requirements.push(`Grammar Focus: ${graSel}`);
ย ย ย ย ย ย isGrammarFocus = true;
ย ย ย ย }

ย ย ย ย if(typeStr) requirements.push(`Exercise Format: ${typeStr}`);

ย ย ย ย if(requirements.length === 0) return alert("โ๏ธ Please select at least one option.");

ย ย ย ย const finalTopic = requirements.join(", ");
ย ย ย ย const target = LANG_NAMES[currentTargetLang];
ย ย ย ยย
ย ย ย ย // Instrucciones base
ย ย ย ย let languageInstruction = `CRITICAL LANGUAGE RULE: The sentences AND the options inside the gaps {opt1|opt2...} MUST BE in **${target.toUpperCase()}**. Do NOT use English words inside the gaps.`;
ย ย ย ย let strictInstruction = "";
ย ย ย ย let gapInstruction = "";

ย ย ย ย // Lรณgica de tipos especรญficos
ย ย ย ย if (typeStr && typeStr.includes("Find and Fix")) {
ย ย ย ย ย ย strictInstruction += `TYPE: FIND AND FIX THE MISTAKE.\nVISUAL REQUIREMENT: You MUST include the mistake crossed out using HTML tags <s>mistake</s> immediately before the correct gap.`;
ย ย ย ย } else if (typeStr && typeStr.includes("Vocabulary Matching")) {
ย ย ย ย ย ย strictInstruction += `TYPE: VOCABULARY MATCHING.\nFormat: "Definition text (${target})... {CorrectWord|Distractor1|Distractor2}"`;
ย ย ย ย } else if (typeStr && typeStr.includes("True or False")) {
ย ย ย ย ย ย strictInstruction += `TYPE: READING COMPREHENSION (TRUE/FALSE).\nFormat: "Statement about the text... {True|False}"`;
ย ย ย ย ย ย // REGLA ESPECIAL: Forzar 2 opciones para True/False
ย ย ย ย ย ย gapInstruction = "GAP REQUIREMENT: Provide **exactly 2 options** ({True|False}).";
ย ย ย ย }

ย ย ย ย // LรGICA DE GAPS Y OPCIONES (MODIFICADA)
ย ย ย ย if (!gapInstruction) {
ย ย ย ย ย ย if (gapCount === 'random') {
ย ย ย ย ย ย ย ย gapInstruction = `GAP REQUIREMENT: Provide **exactly ${optionCount} options** in ${target} for each gap. Mix of 1, 2, or 3 gaps per sentence.`;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย gapInstruction = `GAP REQUIREMENT: Provide **exactly ${optionCount} options** in ${target} for each gap. Provide exactly ${gapCount} gap(s) per sentence.`;
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย if (isGrammarFocus && (!typeStr || !typeStr.includes("Reordering"))) {
ย ย ย ย ย ย strictInstruction += ` Focus gaps ONLY on the requested GRAMMAR rule.`;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย // JSON de ejemplo formateado para claridad
ย ย ย ย const jsonExample = `
ย ย {
ย ย ย "cloze_text": "Sentence in ${target} with {option1|option2|option3...} gaps.",
ย ย ย "hint": "Brief clue",
ย ย ย "translations": { ${Array.from(transLangs).map(l => `"${l}": "Translation"`).join(', ')} },
ย ย ย "full_sentence": "Full sentence without gaps."
ย ย }`;
ย ย ย ยย
ย ย ย ย // CONSTRUCCIรN DEL PROMPT CON SALTOS DE LรNEA (\n)
ย ย ย ย const promptText =ย
`ACT AS: Senior ${target} Linguist.
LEVEL: CEFR ${currentLevel}.
TASK: Create a structured JSON exercise with exactly ${quantity} sentences.

REQUIREMENTS:ย
${finalTopic}

RULES:
1. ${languageInstruction}
2. GAP DENSITY: ${gapInstruction}
3. ${strictInstruction}
${extraData ? `4. EXTRA INSTRUCTIONS: ${extraData}` : ''}

OUTPUT FORMAT: RAW JSON ONLY (No markdown, no text before/after).
JSON STRUCTURE:
{ย
ย "title": "Short descriptive title in ${target}",ย
ย "lang_code": "${currentTargetLang}",ย
ย "theory": "Brief rules explanation...",ย
ย "exercises": [ ${jsonExample} ]ย
}`.trim();
ย ย ย ยย
ย ย ย ย navigator.clipboard.writeText(promptText).then(() => {
ย ย ย ย ย ย const btn = document.querySelector('.btn-ai-primary');
ย ย ย ย ย ย const orig = btn.innerText;
ย ย ย ย ย ย btn.innerText = "โ Copied!";
ย ย ย ย ย ย setTimeout(() => btn.innerText = orig, 2000);
ย ย ย ย }).catch(err => alert("Error copying: " + err));
ย ย }
ย ยย
ย ย async function pasteAIJson() {
ย ย ย ย let jsonString = "";
ย ย ย ย try {
ย ย ย ย ย ย jsonString = await navigator.clipboard.readText();
ย ย ย ย } catch (err) {
ย ย ย ย ย ย jsonString = prompt("Paste JSON here:");
ย ย ย ย }
ย ย ย ย if (!jsonString) return;
ย ย ย ย processJsonAndSave(jsonString);
ย ย }
ย ยย
ย ย function processJsonAndSave(jsonString) {
ย ย ย ย try {
ย ย ย ย ย ย let cleanString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
ย ย ย ย ย ย const aiData = JSON.parse(cleanString);
ย ย ย ย ย ย let finalData = Array.isArray(aiData) ? {
ย ย ย ย ย ย ย ย title: "Exercise",
ย ย ย ย ย ย ย ย lang_code: "en",
ย ย ย ย ย ย ย ย theory: "Review rules.",
ย ย ย ย ย ย ย ย exercises: aiData
ย ย ย ย ย ย } : aiData;
ย ย ย ย ย ย if (!finalData.lang_code) finalData.lang_code = "en";
ย ย ย ย ย ย const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
ย ย ย ย ย ย memory.unshift({
ย ย ย ย ย ย ย ย id: Date.now(),
ย ย ย ย ย ย ย ย title: finalData.title || "Untitled",
ย ย ย ย ย ย ย ย lang: finalData.lang_code,
ย ย ย ย ย ย ย ย theory: finalData.theory,
ย ย ย ย ย ย ย ย date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {
ย ย ย ย ย ย ย ย ย ย hour: '2-digit',
ย ย ย ย ย ย ย ย ย ย minute: '2-digit'
ย ย ย ย ย ย ย ย }),
ย ย ย ย ย ย ย ย data: finalData.exercises
ย ย ย ย ย ย });
ย ย ย ย ย ย localStorage.setItem(AI_MEM_KEY, JSON.stringify(memory));
ย ย ย ย ย ยย
ย ย ย ย ย ย renderAiList();
ย ย ย ย ย ยย
ย ย ย ย ย ย // --- NUEVA LรGICA DE PARPADEO ---
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย const previewBox = document.querySelector('#ai-latest-preview .ai-preview-box');
ย ย ย ย ย ย ย ย if (previewBox) {
ย ย ย ย ย ย ย ย ย ย previewBox.classList.add('highlight');
ย ย ย ย ย ย ย ย ย ย // Remover la clase despuรฉs de que la animaciรณn termine (1.5s * 3 repeticiones = 4.5s)
ย ย ย ย ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ย ย ย ย previewBox.classList.remove('highlight');
ย ย ย ย ย ย ย ย ย ย }, 4600);ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }, 50);

ย ย ย ย } catch (e) {
ย ย ย ย ย ย alert("โ Invalid JSON.\nError: " + e.message);
ย ย ย ย }
ย ย }
ย ยย
ย ย function insertExerciseFromMem(id) {
ย ย ย ย const memory = JSON.parse(localStorage.getItem(AI_MEM_KEY) || '[]');
ย ย ย ย const item = memory.find(x => x.id === id);
ย ย ย ย if (!item) return;
ย ย ย ย if (item.isHtml) {
ย ย ย ย ย ย if (confirm("Insert template?")) {
ย ย ย ย ย ย ย ย editorArea.insertAdjacentHTML('beforeend', item.htmlContent + '<p><br></p>');
ย ย ย ย ย ย ย ย closeAIMenu();
ย ย ย ย ย ย ย ย window.saveNote();
ย ย ย ย ย ย }
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ย const insertTime = Date.now();
ย ย ย ย const theoryId = `theory-${id}-${insertTime}`;
ย ย ย ย const targetLang = item.lang || 'en';
ย ย ย ย let htmlBlock = `<div class="exercise-box" contenteditable="false"><div class="exercise-header"><span>โ๏ธ ${item.title}</span><div style="display:flex; align-items:center;"><button class="btn-theory" onclick="document.getElementById('${theoryId}').style.display = document.getElementById('${theoryId}').style.display === 'block' ? 'none' : 'block'">๐ Theory</button><button class="btn-reset-block" contenteditable="false" onclick="window.resetExerciseBlock(this)" title="Reset">โบ</button><button class="btn-del-block" contenteditable="false" onclick="if(confirm('Delete block?')) { this.closest('.exercise-box').remove(); window.saveNote(); }" title="Delete">๐๏ธ</button></div></div><div class="theory-box" id="${theoryId}">${item.theory || "No theory."}</div>`;
ย ย ย ย item.data.forEach((ex, index) => {
ย ย ย ย ย ย const uId = `ex-${id}-${index}-${insertTime}`;
ย ย ย ย ย ย const hId = `hint-${id}-${index}-${insertTime}`;
ย ย ย ย ย ย const tId = `trans-${id}-${index}-${insertTime}`;
ย ย ย ย ย ย let exerciseContent = "";
ย ย ย ย ย ย if (ex.cloze_text) {
ย ย ย ย ย ย ย ย let parsedHtml = ex.cloze_text.replace(/\{([^}]+)\}/g, (match, content) => {
ย ย ย ย ย ย ย ย ย ย const parts = content.split('|');
ย ย ย ย ย ย ย ย ย ย const correctAns = parts[0].trim();
ย ย ย ย ย ย ย ย ย ย const shuffled = [...parts].sort(() => Math.random() - 0.5);
ย ย ย ย ย ย ย ย ย ย let optsHtml = `<option value="" disabled selected>...</option>`;
ย ย ย ย ย ย ย ย ย ย shuffled.forEach(opt => {
ย ย ย ย ย ย ย ย ย ย ย ย optsHtml += `<option value="${escapeHtml(opt.trim())}">${opt.trim()}</option>`;
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ย return `<span class="cloze-gap-container"><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(correctAns)}')">${optsHtml}</select></span>`;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย exerciseContent = `<span><b>${index + 1}.</b> ${parsedHtml}</span>`;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย let optsHtml = `<option value="" disabled selected>...</option>`;
ย ย ย ย ย ย ย ย const shuffled = [...ex.options].sort(() => Math.random() - 0.5);
ย ย ย ย ย ย ย ย shuffled.forEach(opt => {
ย ย ย ย ย ย ย ย ย ย optsHtml += `<option value="${escapeHtml(opt)}">${opt}</option>`;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย exerciseContent = `<span><b>${index + 1}.</b> ${ex.pre || ''}</span><select class="ex-select" onchange="window.validateExercise(this, '${escapeHtml(ex.answer)}')">${optsHtml}</select><span>${ex.post || ''}</span>`;
ย ย ย ย ย ย }
ย ย ย ย ย ย let transContent = "";
ย ย ย ย ย ย if (ex.translations) {
ย ย ย ย ย ย ย ย for (const [key, val] of Object.entries(ex.translations)) {
ย ย ย ย ย ย ย ย ย ย let f = "๐ฌ๐ง";
ย ย ย ย ย ย ย ย ย ย if (key === 'es') f = "๐ช๐ธ";
ย ย ย ย ย ย ย ย ย ย if (key === 'pt') f = "๐ง๐ท";
ย ย ย ย ย ย ย ย ย ย if (key === 'it') f = "๐ฎ๐น";
ย ย ย ย ย ย ย ย ย ย transContent += `<div class="trans-line"><button class="btn-mini-speak" contenteditable="false" onclick="window.speakText('${escapeHtml(val)}', '${key}')">๐</button><span>${f} ${val}</span></div>`;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย transContent = "No translation";
ย ย ย ย ย ย }
ย ย ย ย ย ย htmlBlock += `<div class="exercise-row" id="${uId}">${exerciseContent}<div style="display:inline-flex; gap:5px; margin-left:10px;"><button class="ex-btn-icon" contenteditable="false" onclick="window.speakText('${escapeHtml(ex.full_sentence)}', '${targetLang}')">๐</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${tId}').style.display = document.getElementById('${tId}').style.display === 'block' ? 'none' : 'block'">๐</button><button class="ex-btn-icon" contenteditable="false" onclick="document.getElementById('${hId}').style.display = document.getElementById('${hId}').style.display === 'block' ? 'none' : 'block'">โ</button></div><div class="hint-box" id="${hId}">๐ก ${ex.hint}</div><div class="trans-box" id="${tId}">${transContent}</div></div>`;
ย ย ย ย });
ย ย ย ย htmlBlock += '</div><p><br></p>';
ย ย ย ย editorArea.insertAdjacentHTML('beforeend', htmlBlock);
ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย editorArea.scrollTop = editorArea.scrollHeight;
ย ย ย ย ย ย window.saveNote();
ย ย ย ย }, 50);
ย ย ย ย closeAIMenu();
ย ย }
ย ยย
ย ย window.validateExercise = function(s, a) {
ย ย ย ย s.classList.remove('correct', 'wrong');
ย ย ย ย if (s.value.trim().toLowerCase() === a.trim().toLowerCase()) {
ย ย ย ย ย ย s.classList.add('correct');
ย ย ย ย } else {
ย ย ย ย ย ย s.classList.add('wrong');
ย ย ย ย ย ย if (navigator.vibrate) navigator.vibrate(200);
ย ย ย ย }
ย ย ย ย window.saveNote();
ย ย };
ย ยย
ย ย window.speakText = function(text, langCode) {
ย ย ย ย if ('speechSynthesis' in window) {
ย ย ย ย ย ย window.speechSynthesis.cancel();
ย ย ย ย ย ย const u = new SpeechSynthesisUtterance(text);
ย ย ย ย ย ย const m = {
ย ย ย ย ย ย ย ย 'en': 'en-US',
ย ย ย ย ย ย ย ย 'es': 'es-ES',
ย ย ย ย ย ย ย ย 'pt': 'pt-BR',
ย ย ย ย ย ย ย ย 'it': 'it-IT'
ย ย ย ย ย ย };
ย ย ย ย ย ย u.lang = m[langCode] || 'en-US';
ย ย ย ย ย ย u.rate = 0.9;
ย ย ย ย ย ย window.speechSynthesis.speak(u);
ย ย ย ย } else {
ย ย ย ย ย ย alert("TTS not supported.");
ย ย ย ย }
ย ย };

ย ย /* ====== DATA GUARDIAN (SECURITY V2) ====== */
ย ย function initDataGuardian() {
ย ย ย ย if (navigator.storage && navigator.storage.persist) {
ย ย ย ย ย ย navigator.storage.persist().then(granted => {
ย ย ย ย ย ย ย ย if (granted) console.log("๐ก๏ธ Data Guardian: Persistence Granted.");
ย ย ย ย ย ย ย ย else console.warn("โ๏ธ Data Guardian: Storage not persistent.");
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย // Auto-Restore Logic
ย ย ย ย const mainRes = localStorage.getItem(STORAGE_KEY);
ย ย ย ย const mirrorRes = localStorage.getItem(MIRROR_RES_KEY);

ย ย ย ย if ((!mainRes || mainRes === '[]') && (mirrorRes && mirrorRes.length > 50)) {
ย ย ย ย ย ย if (confirm("โ๏ธ SECURITY ALERT โ๏ธ\n\nYour main library appears empty, but a safety mirror exists.\n\nRESTORE data from mirror?")) {
ย ย ย ย ย ย ย ย localStorage.setItem(STORAGE_KEY, mirrorRes);
ย ย ย ย ย ย ย ย alert("โ Data rescued successfully.");
ย ย ย ย ย ย ย ย location.reload();
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย const mainAi = localStorage.getItem(AI_MEM_KEY);
ย ย ย ย const mirrorAi = localStorage.getItem(MIRROR_AI_KEY);
ย ย ย ย if ((!mainAi || mainAi === '[]') && (mirrorAi && mirrorAi.length > 50)) {
ย ย ย ย ย ย console.warn("Auto-restoring AI memory from mirror...");
ย ย ย ย ย ย localStorage.setItem(AI_MEM_KEY, mirrorAi);
ย ย ย ย }

ย ย ย ย setInterval(updateSecurityMirror, 60000);
ย ย }

ย ย function updateSecurityMirror() {
ย ย ย ย const currentRes = localStorage.getItem(STORAGE_KEY);
ย ย ย ย const currentAi = localStorage.getItem(AI_MEM_KEY);
ย ย ย ย if (currentRes && currentRes.length > 50) localStorage.setItem(MIRROR_RES_KEY, currentRes);
ย ย ย ย if (currentAi && currentAi.length > 50) localStorage.setItem(MIRROR_AI_KEY, currentAi);
ย ย }

ย ย const originalSetItem = localStorage.setItem;
ย ย localStorage.setItem = function(key, value) {
ย ย ย ย originalSetItem.apply(this, [key, value]);
ย ย ย ย if (key === STORAGE_KEY || key === AI_MEM_KEY) {
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย if (key === STORAGE_KEY && value.length > 50) originalSetItem.apply(this, [MIRROR_RES_KEY, value]);
ย ย ย ย ย ย ย ย if (key === AI_MEM_KEY && value.length > 50) originalSetItem.apply(this, [MIRROR_AI_KEY, value]);
ย ย ย ย ย ย }, 100);
ย ย ย ย }
ย ย };
</script>
</body>
</html>
