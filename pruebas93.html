<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocabulary Hunter: Precision Update</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ==========================================================================
           CONFIGURACI√ìN GLOBAL
           ========================================================================== */
        :root {
            --neon-green: #0f0;
            --neon-red: #ff4444;
            --neon-blue: #4f46e5;
            --neon-yellow: #ffff00;
            --dark-bg: #050505;
            --panel-bg: #0a0a0a; /* Fondo m√°s s√≥lido para legibilidad */
            --card-bg: #111;
            --btn-shadow: #111;
        }

        body {margin:0;overflow:hidden;background:var(--dark-bg);font-family:'Press Start 2P',monospace;color:white;user-select:none;touch-action:none;}
        canvas {display:block;}

        .scanlines {
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,255,255,0) 50%,rgba(0,0,0,0.1) 50%,rgba(0,0,0,0.1));
            background-size:100% 4px;z-index:999;pointer-events:none;
        }

        /* --- UI PRINCIPAL --- */
        #ui {position:absolute;top:10px;left:10px;right:10px;z-index:10;pointer-events:none;display:flex;justify-content:space-between;text-shadow:2px 2px 0 #000; font-size: 10px;}
        #lives-panel {color:var(--neon-red);}
        #score-panel {color:var(--neon-green);}
        
        /* --- CONTROLES M√ìVILES --- */
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        .gamepad-group { position: absolute; pointer-events: auto; width: 150px; height: 150px; }
        
        #touch-zone-left { left: 20px; bottom: 80px; transition: all 0.3s; }
        #touch-zone-left.touch-area-full { width: 50%; height: auto; top: 0; bottom: 80px; left: 0; }
        #touch-zone-left.touch-area-full .action-btn { position: absolute; transform: scale(1.1); }
        #touch-zone-left.touch-area-full #btn-left { left: 40px; bottom: 20px; top: auto; }
        #touch-zone-left.touch-area-full #btn-right { left: 110px; bottom: 20px; top: auto; }

        .group-right { right: 20px; bottom: 110px; }

        .action-btn {
            border-radius: 50%; font-size: 14px; font-weight: bold;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 6px 0 #111, 0 8px 15px rgba(0,0,0,0.7); border: 2px solid #000;
            position: absolute; cursor: pointer; z-index: 10; opacity: 0.8;
        }
        .action-btn:active { transform: translateY(4px) scale(0.95); box-shadow: 0 2px 0 #111; }
        .btn-label { font-size: 7px; margin-top: 2px; opacity: 0.9; font-family: sans-serif; font-weight: 900; }
        
        .btn-gray { width: 60px; height: 60px; background: linear-gradient(145deg, #777, #444); color: #fff; border-color: #333; font-size: 10px; }
        #btn-left { top: 50%; left: 0; transform: translateY(-50%); }
        #btn-right { top: 50%; right: 0; transform: translateY(-50%); }

        #btn-fire { width: 75px; height: 75px; bottom: 0; right: 0; background: linear-gradient(145deg, #ff4444, #cc0000); color: white; border-color: #800; z-index: 12; }
        #btn-ban { width: 55px; height: 55px; bottom: 0px; right: 80px; background: linear-gradient(145deg, #00ffff, #009999); color: #003333; border-color: #004444; }
        #btn-boost { width: 55px; height: 55px; bottom: 80px; right: 5px; background: linear-gradient(145deg, #ffff00, #cccc00); color: #333; border-color: #999900; }

        @media (max-width: 768px) or (pointer: coarse) {
            #mobile-controls { display: block; }
            #category-bar-wrapper { bottom: 160px; } 
        }

        /* --- BARRA INFERIOR --- */
        #category-bar-wrapper {
            position:absolute; bottom:30px; left:0; width:100%; padding:10px 0;
            background:rgba(0,0,0,0.9); z-index:15; overflow-x:auto; white-space:nowrap;
            display:flex; justify-content:center; border-top:1px solid #333;
        }
        .category-chip {
            padding:8px 16px; margin:0 8px; background:#111; color:#666;
            font-size:10px; cursor:pointer; border:1px solid #444; display:inline-block;
        }
        .category-chip.active { color:var(--neon-green); background:#002200; border-color:var(--neon-green); }
        .category-chip.help-btn { border-color:var(--neon-yellow); color:var(--neon-yellow); }

        /* --- PANTALLAS (MODALES) --- */
        .overlay-screen {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.92); z-index:100;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            backdrop-filter: blur(5px); /* Efecto moderno */
        }
        
        /* -----------------------------------------------------------
           MEJORA: CONTENEDOR DE AYUDA / CONFIG (NO FLOTANTE)
           ----------------------------------------------------------- */
        #study-guide {
            /* Permite scroll si la pantalla es muy peque√±a en altura */
            overflow-y: auto; 
            display: none; /* Se activa con JS */
            align-items: flex-start; /* Empieza arriba, no centrado verticalmente */
            padding-top: 5vh;
            padding-bottom: 5vh;
        }

        #study-content {
            background: var(--panel-bg);
            border: 2px solid var(--neon-green);
            width: 95%; /* Aleja los lados del borde */
            max-width: 800px;
            /* Altura autom√°tica basada en contenido, con l√≠mite seguro */
            height: auto;
            max-height: 90vh; 
            display: flex; 
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 40px rgba(0,255,0,0.15);
            margin: 0 auto; /* Centrado horizontal */
            border-radius: 4px;
        }

        .close-btn {
            position: absolute; top: -15px; right: -10px;
            font-size: 16px; color: #fff; background: var(--neon-red);
            padding: 8px 12px; cursor: pointer; border: 2px solid #fff;
            box-shadow: 4px 4px 0 #000; z-index: 25;
            font-family: sans-serif; font-weight: bold;
        }
        .close-btn:hover { transform: scale(1.1); }

        .tabs-header { 
            display: flex; background: #000; border-bottom: 2px solid var(--neon-green);
            flex-shrink: 0; /* Header no se encoge */
        }
        .tab-btn {
            flex: 1; padding: 15px; cursor: pointer; text-align: center; font-size: 10px;
            background: #111; border: none; color: #666; font-family: 'Press Start 2P';
            border-right: 1px solid #333;
        }
        .tab-btn.active { background: var(--panel-bg); color: var(--neon-green); font-weight: bold; border-bottom: 4px solid var(--panel-bg); margin-bottom: -2px; }

        .tab-content { 
            flex: 1; 
            overflow-y: auto; /* Scroll interno solo para el contenido */
            padding: 20px; 
            display: none;
            /* Espacio para que el scrollbar no tape texto */
            padding-right: 15px; 
        }
        .tab-content.active { display: block; }

        /* --- MEJORA: TARJETAS DE CONFIGURACI√ìN (CLARIDAD) --- */
        .settings-card {
            background: var(--card-bg);
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }
        .card-title {
            color: #fff; font-size: 12px; margin-bottom: 15px;
            border-bottom: 1px solid #444; padding-bottom: 8px;
            display: flex; align-items: center; gap: 10px;
        }
        .card-icon { color: var(--neon-yellow); font-size: 14px; }

        .config-row { margin-bottom: 15px; }
        .config-label { display: flex; justify-content: space-between; font-size: 10px; color: #aaa; margin-bottom: 8px;}
        .config-val { color: var(--neon-green); }
        
        /* Grid para los checkboxes */
        .checkbox-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        @media (max-width: 500px) { .checkbox-grid { grid-template-columns: 1fr; } }
        
        .chk-label {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            background: #000; padding: 10px; border: 1px solid #333; border-radius: 4px;
            font-size: 9px; color: #888; transition: 0.2s;
        }
        .chk-label:hover { border-color: var(--neon-green); color: #fff; }
        .chk-label input:checked + span { color: var(--neon-green); }

        input[type=range] { width: 100%; accent-color: var(--neon-green); height: 5px; background: #333; border-radius: 5px; outline: none; }
        select { width: 100%; padding: 8px; background: #000; color: #fff; border: 1px solid #444; font-family: 'Press Start 2P'; font-size: 9px; }
        
        /* --- TABLA DE DATOS --- */
        table {width:100%;border-collapse:separate;border-spacing:0;font-size:10px;}
        th {color:var(--neon-green);text-align:left;border-bottom:2px solid var(--neon-green);padding:10px;position:sticky;top:0;background:var(--panel-bg);z-index:2;}
        td {padding:12px 10px;border-bottom:1px solid #333;color:#aaa;}
        tr:hover td {background:#1a1a1a;}
        .en-word {color:var(--neon-blue);}
        
        tr.boosted-row td { color: var(--neon-yellow); background: rgba(255, 255, 0, 0.05); }
        tr.banned-row td { text-decoration: line-through; opacity: 0.5; }
        
        .star-active { color: var(--neon-yellow); animation: pulseStar 1s infinite alternate; }
        .star-inactive { color: #333; }
        @keyframes pulseStar { from { opacity: 0.8; transform: scale(1); } to { opacity: 1; transform: scale(1.2); } }

        /* --- STEPPER --- */
        .stepper-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; background: #000; padding: 10px; border-radius: 5px;}
        .stepper-btn { background: #333; color: #fff; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #555; }
        .stepper-btn:active { background: var(--neon-green); color: #000; }
        
        /* --- ESTILOS GENERALES PANTALLAS --- */
        h1 {color:var(--neon-green);text-shadow:4px 4px #003300;font-size:30px;margin-bottom:20px; text-align: center;}
        p {line-height:2;color:#aaa;font-size:11px;max-width:600px;text-align: center;}
        .key-hint {padding:2px 6px;border:1px solid #666;border-radius:4px;background:#222;font-size:10px;}
        .blink {animation:blinker 1s linear infinite;color:var(--neon-yellow);margin-top:30px;font-size:12px;cursor:pointer;}
        
        /* --- QUIZ POPUP --- */
        #quiz-overlay { background: #050505; border: 4px solid var(--neon-red); padding: 20px; width: 90%; max-width: 500px; display: flex; flex-direction: column; align-items: center; }
        #quiz-input { background: #000; border: 2px solid #333; color: #fff; padding: 15px; font-family: 'Press Start 2P'; font-size: 14px; text-align: center; width: 100%; margin: 10px 0; box-sizing: border-box; }
        #quiz-input:focus { border-color: var(--neon-green); outline: none; }
        .quiz-actions { display: flex; gap: 10px; width: 100%; }
        .quiz-btn { flex: 1; padding: 15px; font-family: 'Press Start 2P'; cursor: pointer; font-size: 10px; background: #000; color: #fff; border: 2px solid #333; }
        .btn-verify { border-color: var(--neon-green); color: var(--neon-green); }
        .btn-verify:hover { background: var(--neon-green); color: #000; }
        .correct-ans-highlight { color: #fff; background: var(--neon-red); padding: 5px; }

        /* Scrollbars bonitos */
        ::-webkit-scrollbar {width:8px;}
        ::-webkit-scrollbar-track {background:#000;}
        ::-webkit-scrollbar-thumb {background:#333;border-radius:4px;}
        ::-webkit-scrollbar-thumb:hover {background:#555;}
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="ui">
        <div id="score-panel">SCORE: <span id="score">0</span> | COMBO: <span id="combo">0</span></div>
        <div id="lives-panel">LIVES: <span id="lives">5</span></div>
        <div id="high-score-panel">HIGH: <span id="highScore">0</span></div>
    </div>
    
    <div id="level-up-msg">LEVEL UP!<br>+20 WORDS</div>

    <div id="mobile-controls">
        <div class="gamepad-group group-left" id="touch-zone-left">
            <div class="action-btn btn-gray" id="btn-left"><span>TOUCH</span></div>
            <div class="action-btn btn-gray" id="btn-right"><span>ZONE</span></div>
        </div>

        <div class="gamepad-group group-right">
            <div class="action-btn" id="btn-boost">
                <span>+</span><span class="btn-label">BOOST</span>
            </div>
            <div class="action-btn" id="btn-ban">
                <span>X</span><span class="btn-label">BAN</span>
            </div>
            <div class="action-btn" id="btn-fire">
                <span>‚óè</span><span class="btn-label">FIRE</span>
            </div>
        </div>
    </div>

    <div id="category-bar-wrapper"></div>

    <div id="start-screen" class="overlay-screen" onclick="startGame()">
        <h1>VOCAB ROBOT</h1>
        <p>
            1. Enemies drop English words & <strong>Bombs</strong>.<br>
            2. Shoot 3 times to Translate -> 1 time to Destroy.<br>
            3. <strong>SUPER BOSSES</strong> appear in VERB modes.<br><br>
            <span style="color: var(--neon-cyan);">BLUE (X): BAN WORD (3 HITS)</span><br>
            <span style="color: var(--neon-yellow);">YELLOW (+): BOOST FREQUENCY (3 HITS)</span><br>
            <span style="color: var(--neon-red);">RED (‚óè): 3 HITS TO REMOVE BOOST</span><br><br>
            <span class="key-hint">‚Üê ‚Üí</span> Move &nbsp;&nbsp; <span class="key-hint">SPACE</span> Shoot
        </p>
        <div class="blink">CLICK / TAP TO START</div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;" onclick="startGame()">
        <h2>MISSION FAILED</h2>
        <p>FINAL SCORE: <span id="finalScore" style="color:white;">0</span></p>
        <div class="blink">CLICK TO RETRY</div>
    </div>
    
    <div id="grand-finale-screen" onclick="location.reload()">
        <h1 style="color: #fff; font-size: 40px; text-shadow: 0 0 20px #FFD700;">MISSION COMPLETE!</h1>
        <h2 style="color: var(--neon-green);">100% VOCABULARY UNLOCKED</h2>
        <p>YOU ARE A LEGEND!</p>
        <div class="blink">CLICK TO RESTART SYSTEM</div>
    </div>

    <div id="quiz-screen" class="overlay-screen" style="display:none;">
        <div id="quiz-overlay">
            <h2 style="color:var(--neon-red);" id="quiz-title">SYSTEM HACK DETECTED!</h2>
            <p style="font-size:10px; color:#aaa;">TRANSLATE TO RESTORE SYSTEMS</p>
            <div id="quiz-question">WORD</div>
            <input type="text" id="quiz-input" placeholder="TYPE TRANSLATION" autocomplete="off">
            <div id="quiz-feedback"></div>
            
            <div class="quiz-actions">
                <button class="quiz-btn btn-skip" onclick="skipQuiz()">FORCE REBOOT (-500 PTS)</button>
                <button class="quiz-btn btn-verify" onclick="checkQuizAnswer()">VERIFY REPAIR</button>
            </div>
        </div>
    </div>

    <div id="study-guide" class="overlay-screen" style="display:none;">
        <div id="study-content">
            <span class="close-btn" onclick="toggleStudyGuide()">X</span>
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('db')">DATABASE</button>
                <button class="tab-btn" onclick="switchTab('settings')">SETTINGS</button>
            </div>
            
            <div id="tab-db" class="tab-content active">
                <div class="settings-card">
                    <div class="card-title"><span class="card-icon">üìö</span> WORD MANAGEMENT</div>
                    <div class="config-row">
                        <label class="config-label">WORDS PER LEVEL <span class="config-val" id="val-level-inc-display">10</span></label>
                        <div class="stepper-container">
                            <div class="stepper-btn" onclick="adjustWordsPerLevel(-5)">-</div>
                            <span class="stepper-val" style="font-size:12px;">ADJUST</span>
                            <div class="stepper-btn" onclick="adjustWordsPerLevel(5)">+</div>
                        </div>
                        <div id="db-stats-display" class="db-stats" style="color:#666;">Total DB: 0</div>
                        <div id="active-stats-display" class="db-stats" style="color:var(--neon-green); margin-top:5px;">Playing: 0/0</div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="card-title"><span class="card-icon">‚ö°</span> POP QUIZ SYSTEM</div>
                    <div class="checkbox-grid">
                        <label class="chk-label">
                            <input type="checkbox" id="chk-quiz" onchange="updateConfig('quiz')">
                            <span>ENABLE POP QUIZ</span>
                        </label>
                    </div>
                    <div class="config-row" style="margin-top:15px;">
                        <label class="config-label">FREQUENCY <span id="val-quiz-time" class="config-val">30s</span></label>
                        <input type="range" id="cfg-quiz-time" min="10" max="60" step="5" value="30" oninput="updateConfig('quiz')">
                        <div class="slider-desc"><span>OFTEN</span><span>RARE</span></div>
                    </div>
                </div>
                
                <div id="study-table-container"></div>
            </div>

            <div id="tab-settings" class="tab-content">
                
                <div class="settings-card">
                    <div class="card-title"><span class="card-icon">üîä</span> AUDIO & VOICE</div>
                    <div class="config-row">
                         <label class="config-label">MASTER VOLUME <span id="val-volume" class="config-val">50%</span></label>
                         <input type="range" id="cfg-volume" min="0" max="100" step="10" value="50" oninput="updateConfig('volume')">
                    </div>
                    <div class="checkbox-grid">
                        <label class="chk-label">
                            <input type="checkbox" id="chk-sfx" onchange="updateConfig('audio_toggles')" checked>
                            <span>SFX SOUNDS</span>
                        </label>
                        <label class="chk-label">
                            <input type="checkbox" id="chk-voice-words" onchange="updateConfig('audio_toggles')" checked>
                            <span>VOICE: WORDS</span>
                        </label>
                        <label class="chk-label">
                            <input type="checkbox" id="chk-voice-bombs" onchange="updateConfig('audio_toggles')" checked>
                            <span>VOICE: BOMBS</span>
                        </label>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="card-title"><span class="card-icon">üéÆ</span> CONTROLS</div>
                    <div class="config-row">
                        <label class="config-label">MOVEMENT STYLE</label>
                        <select id="cfg-movement" onchange="updateConfig('movement')">
                            <option value="algo1">ALGO 1: VIRTUAL KEYS</option>
                            <option value="algo2">ALGO 2: DIRECT FOLLOW</option>
                            <option value="algo3">ALGO 3: DYNAMIC SLIDE</option>
                        </select>
                    </div>
                    <div class="config-row">
                        <label class="config-label">TOUCH AREA SIZE</label>
                        <select id="cfg-touch-area" onchange="updateConfig('touch_area')">
                            <option value="classic">CLASSIC (Small Box)</option>
                            <option value="full">FULL SCREEN (Left Side)</option>
                        </select>
                    </div>
                    <div class="config-row">
                        <label class="config-label">PLAYER COLOR</label>
                        <input type="color" id="cfg-color" value="#4f46e5" style="width:100%; height:30px; cursor:pointer;" onchange="updateConfig('color')">
                    </div>
                </div>

                <div class="settings-card">
                    <div class="card-title"><span class="card-icon">‚öôÔ∏è</span> GAMEPLAY DIFFICULTY</div>
                    
                    <div class="config-row">
                        <label class="config-label">VOCABULARY SOURCE</label>
                        <select id="cfg-source" onchange="updateConfig('source')"></select>
                    </div>

                    <div class="config-row">
                        <label class="config-label">SUPER BOSS FREQUENCY <span id="val-boss-freq" class="config-val">15</span></label>
                        <input type="range" id="cfg-boss-freq" min="5" max="50" step="5" value="15" oninput="updateConfig('bossFreq')">
                        <div class="slider-desc"><span>OFTEN</span><span>RARE</span></div>
                    </div>

                    <div class="config-row">
                        <label class="config-label">ENEMY SPAWN RATE <span id="val-spawn" class="config-val">1</span></label>
                        <input type="range" id="cfg-spawn" min="1" max="10" step="1" value="1" oninput="updateConfig('spawn')">
                    </div>

                    <div class="config-row">
                        <label class="config-label">ENEMY SPEED <span id="val-speed" class="config-val">0.5x</span></label>
                        <input type="range" id="cfg-speed" min="0.5" max="3.0" step="0.1" value="0.5" oninput="updateConfig('speed')">
                    </div>

                    <div class="config-row">
                        <label class="config-label">BOMB CHANCE <span id="val-bomb" class="config-val">30%</span></label>
                        <input type="range" id="cfg-bomb" min="0" max="100" step="10" value="30" oninput="updateConfig('bomb')">
                    </div>
                    
                    <div class="config-row">
                        <label class="config-label">BOMB FALL SPEED <span id="val-bspeed" class="config-val">1.0</span></label>
                        <input type="range" id="cfg-bspeed" min="1.0" max="5.0" step="0.1" value="1.0" oninput="updateConfig('bspeed')">
                    </div>
                </div>

                <button class="reset-btn" style="width:100%; padding:15px; border:1px solid var(--neon-red); background:#200; color:#fff;" onclick="resetConfig()">RESET ALL TO DEFAULTS</button>
            </div>
            
            <p style="text-align:center; color:#555; font-size:9px; margin-top:auto; padding-top:20px;">
                PRESS <span style="color:#fff">TAB</span> TO RESUME GAME
            </p>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="https://paradisonetworx.com/database.js"></script>

    <script>
const CONFIG_KEY = 'vocab_robot_config_v19'; // Nueva versi√≥n para forzar limpieza limpia de lo viejo
const DISABLED_WORDS_KEY = 'vocab_robot_disabled_v1';
const REINFORCED_WORDS_KEY = 'vocab_robot_reinforced_v1';

let userSettings = {
    vocabSource: 'ALL_INTERNAL', 
    // ELIMINADO: dataPercent ya no se usa como control primario
    activeWordLimit: 10, // Cuantas palabras est√°n activas ahora mismo
    wordsPerLevel: 10,   // Cuantas palabras se suman al subir nivel
    spawnLevel: 1,      
    enemySpeed: 0.5,    
    bombChance: 30,     
    bombSpeed: 1.0,     
    playerColor: '#4f46e5',
    quizEnabled: false, quizInterval: 30,
    masterVolume: 50,
    audioFX: true, audioWords: true, audioBombs: true, bossFrequency: 15,
    movementAlgo: 'algo1',
    touchArea: 'classic'
};
let gameVars = { spawnInterval: 3500, bombProb: 0.005 };
let disabledWords = new Set(); 
let reinforcedWords = new Set(); 

let quizTimer = 0;
let currentQuizWord = null;
let lockedEnemyId = null;

// Variables globales para el touch logic
let touchStartX = 0;
let touchCurrentX = 0;
let isTouchingLeft = false;

// --- MENUS & UI ---
function renderCategoryBar() {
    const wrapper = document.getElementById('category-bar-wrapper');
    wrapper.innerHTML = '';
    const opts = [{val: 'LOCAL', txt: 'MY DB'}, {val: 'MIXED', txt: 'MIXED'}, {val: 'ALL_INTERNAL', txt: 'ALL INTERNAL'}];
    Object.keys(INTERNAL_VOCAB).forEach(key => opts.push({val: key, txt: key}));

    opts.forEach(o => {
        const chip = document.createElement('div');
        chip.className = 'category-chip' + (userSettings.vocabSource === o.val ? ' active' : '');
        chip.textContent = o.txt;
        chip.onclick = () => {
            document.getElementById('cfg-source').value = o.val;
            updateConfig('source');
        };
        wrapper.appendChild(chip);
    });
    const help = document.createElement('div');
    help.className = 'category-chip help-btn';
    help.textContent = 'CONFIG / HELP';
    help.onclick = toggleStudyGuide;
    wrapper.appendChild(help);
}

// Nueva funci√≥n para el stepper
function adjustWordsPerLevel(delta) {
    let newVal = userSettings.wordsPerLevel + delta;
    if (newVal < 5) newVal = 5;
    if (newVal > 100) newVal = 100; // Limite razonable
    
    userSettings.wordsPerLevel = newVal;
    updateConfig('level_inc_only');
}

function updateDbStats() {
    const inc = userSettings.wordsPerLevel;
    const total = totalAvailableWords;
    let percent = 0;
    if (total > 0) percent = ((inc / total) * 100).toFixed(2);
    
    document.getElementById('val-level-inc-display').textContent = inc;
    document.getElementById('db-stats-display').innerHTML = 
        `Total DB: <span class="highlight-stat">${total}</span> | <span class="highlight-stat">${inc}</span> is ${percent}% of Total`;
    
    // Stats de palabras activas actuales
    let currentActive = activeVocabList.length;
    if(activeVocabList.length === 1 && activeVocabList[0].en === "NO DATA") currentActive = 0;
    
    document.getElementById('active-stats-display').textContent = 
        `PLAYING WITH: ${currentActive} / ${total} WORDS`;
}

function populateSourceMenu() {
    const select = document.getElementById('cfg-source');
    select.innerHTML = '';
    const opts = [
        {val: 'LOCAL', txt: 'MY DATABASE (Custom)'},
        {val: 'ALL_INTERNAL', txt: 'INTERNAL: ALL MIXED'},
        {val: 'MIXED', txt: 'EVERYTHING (Local + Internal)'}
    ];
    Object.keys(INTERNAL_VOCAB).forEach(key => opts.push({val: key, txt: `INTERNAL: ${key}`}));
    opts.forEach(o => {
        const op = document.createElement('option');
        op.value = o.val; op.textContent = o.txt;
        select.appendChild(op);
    });
}

function loadConfig() {
    populateSourceMenu();
    const saved = localStorage.getItem(CONFIG_KEY);
    if(saved) {
        try { userSettings = { ...userSettings, ...JSON.parse(saved) }; } 
        catch(e) { console.error("Config error", e); }
    }
    // Asegurar que activeWordLimit existe (migraci√≥n)
    if (!userSettings.activeWordLimit) userSettings.activeWordLimit = 10;
    if (!userSettings.wordsPerLevel) userSettings.wordsPerLevel = 10;

    const savedDisabled = localStorage.getItem(DISABLED_WORDS_KEY);
    if(savedDisabled) {
        try { disabledWords = new Set(JSON.parse(savedDisabled)); }
        catch(e) { disabledWords = new Set(); }
    }
    const savedReinforced = localStorage.getItem(REINFORCED_WORDS_KEY);
    if(savedReinforced) {
        try { reinforcedWords = new Set(JSON.parse(savedReinforced)); }
        catch(e) { reinforcedWords = new Set(); }
    }
    applyConfigToUI();
    recalcGameVars();
}

function applyConfigToUI() {
    document.getElementById('cfg-source').value = userSettings.vocabSource;
    // Stepper Display se actualiza en updateDbStats() llamado al final de loadVocabData
    
    document.getElementById('chk-quiz').checked = userSettings.quizEnabled;
    document.getElementById('cfg-quiz-time').value = userSettings.quizInterval;
    document.getElementById('val-quiz-time').textContent = userSettings.quizInterval + 's';
    document.getElementById('cfg-volume').value = userSettings.masterVolume;
    document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
    document.getElementById('chk-sfx').checked = userSettings.audioFX !== false;
    document.getElementById('chk-voice-words').checked = userSettings.audioWords !== false;
    document.getElementById('chk-voice-bombs').checked = userSettings.audioBombs !== false;
    document.getElementById('cfg-boss-freq').value = userSettings.bossFrequency || 15;
    document.getElementById('val-boss-freq').textContent = userSettings.bossFrequency || 15;
    document.getElementById('cfg-spawn').value = userSettings.spawnLevel;
    document.getElementById('val-spawn').textContent = userSettings.spawnLevel;
    document.getElementById('cfg-speed').value = userSettings.enemySpeed;
    document.getElementById('val-speed').textContent = userSettings.enemySpeed + "x";
    document.getElementById('cfg-bomb').value = userSettings.bombChance;
    document.getElementById('val-bomb').textContent = userSettings.bombChance + "%";
    document.getElementById('cfg-bspeed').value = userSettings.bombSpeed;
    document.getElementById('val-bspeed').textContent = userSettings.bombSpeed;
    document.getElementById('cfg-color').value = userSettings.playerColor;
    document.getElementById('cfg-movement').value = userSettings.movementAlgo || 'algo1';
    
    document.getElementById('cfg-touch-area').value = userSettings.touchArea || 'classic';
    const touchZone = document.getElementById('touch-zone-left');
    if (userSettings.touchArea === 'full') touchZone.classList.add('touch-area-full');
    else touchZone.classList.remove('touch-area-full');

    player.color = userSettings.playerColor;
}

function recalcGameVars() {
    gameVars.spawnInterval = 5500 - (userSettings.spawnLevel * 500); 
    gameVars.bombProb = userSettings.bombChance / 2000; 
}

function updateConfig(key) {
    lockedEnemyId = null;

    if(key === 'source') {
        userSettings.vocabSource = document.getElementById('cfg-source').value;
        // Al cambiar de fuente, reiniciamos el contador de palabras activas al valor por defecto
        userSettings.activeWordLimit = userSettings.wordsPerLevel;
        loadVocabData(); populateStudyGuide(); renderCategoryBar();
        if(gameRunning) enemies = []; 
    }
    else if(key === 'level_inc_only') {
        // Solo actualizamos la config y stats, no recargamos todo el juego si no es necesario
        // Pero si el juego est√° en marcha y activeLimit < wordsPerLevel, podr√≠amos ajustar
        updateDbStats();
    }
    else if(key === 'limit_update') {
        loadVocabData(); populateStudyGuide();
        if(gameRunning) enemies = [];
    }
    else if(key === 'movement') {
        userSettings.movementAlgo = document.getElementById('cfg-movement').value;
    }
    else if(key === 'touch_area') {
        userSettings.touchArea = document.getElementById('cfg-touch-area').value;
        const touchZone = document.getElementById('touch-zone-left');
        if (userSettings.touchArea === 'full') touchZone.classList.add('touch-area-full');
        else touchZone.classList.remove('touch-area-full');
    }
    else if(key === 'volume') {
        userSettings.masterVolume = parseInt(document.getElementById('cfg-volume').value);
        document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
        playSound('shoot'); 
    }
    else if(key === 'audio_toggles') {
        userSettings.audioFX = document.getElementById('chk-sfx').checked;
        userSettings.audioWords = document.getElementById('chk-voice-words').checked;
        userSettings.audioBombs = document.getElementById('chk-voice-bombs').checked;
    }
    else if(key === 'quiz') {
        userSettings.quizEnabled = document.getElementById('chk-quiz').checked;
        userSettings.quizInterval = parseInt(document.getElementById('cfg-quiz-time').value);
        document.getElementById('val-quiz-time').textContent = userSettings.quizInterval + 's';
        quizTimer = 0; 
    }
    else if(key === 'bossFreq') {
        userSettings.bossFrequency = parseInt(document.getElementById('cfg-boss-freq').value);
        document.getElementById('val-boss-freq').textContent = userSettings.bossFrequency;
    }
    else if(key === 'spawn') userSettings.spawnLevel = parseInt(document.getElementById('cfg-spawn').value);
    else if(key === 'speed') userSettings.enemySpeed = parseFloat(document.getElementById('cfg-speed').value);
    else if(key === 'bomb') userSettings.bombChance = parseInt(document.getElementById('cfg-bomb').value);
    else if(key === 'bspeed') userSettings.bombSpeed = parseFloat(document.getElementById('cfg-bspeed').value);
    else if(key === 'color') {
        userSettings.playerColor = document.getElementById('cfg-color').value;
        player.color = userSettings.playerColor;
    }
    
    if(key !== 'limit_update' && key !== 'volume' && key !== 'touch_area' && key !== 'level_inc_only') {
        applyConfigToUI(); 
    }
    recalcGameVars();
    localStorage.setItem(CONFIG_KEY, JSON.stringify(userSettings));
}

function resetConfig() {
    localStorage.removeItem(CONFIG_KEY);
    localStorage.removeItem(DISABLED_WORDS_KEY);
    localStorage.removeItem(REINFORCED_WORDS_KEY);
    disabledWords.clear();
    reinforcedWords.clear();
    userSettings = { 
        vocabSource: 'ALL_INTERNAL', 
        activeWordLimit: 10, wordsPerLevel: 10,
        spawnLevel: 1, enemySpeed: 0.5, bombChance: 30, bombSpeed: 1.0, 
        playerColor: '#4f46e5', quizEnabled: false, quizInterval: 30, 
        masterVolume: 50, audioFX:true, audioWords:true, audioBombs:true, bossFrequency: 15,
        movementAlgo: 'algo1', touchArea: 'classic'
    };
    loadConfig(); loadVocabData(); populateStudyGuide(); renderCategoryBar();
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    if(tabName === 'db') document.querySelector('button[onclick="switchTab(\'db\')"]').classList.add('active');
    else document.querySelector('button[onclick="switchTab(\'settings\')"]').classList.add('active');
}

// --- DATA LOGIC ---
let activeVocabList = []; 
let gameDeck = []; 
let totalAvailableWords = 0; 

const cleanText = (str) => {
    if(!str) return "";
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase();
};

function loadVocabData() {
    let tempVocabList = [];

    const processItem = (en, es) => {
        if (!en || !es) return;
        const safeEn = cleanText(en);
        if (safeEn.split(' ').length > 2) return; 
        const safeEs = cleanText(es);
        if (safeEn.length > 0 && safeEs.length > 0) {
            tempVocabList.push({ en: safeEn, es: [safeEs] });
        }
    };

    const source = userSettings.vocabSource;

    let localDataLoaded = false;
    if (source === 'LOCAL' || source === 'MIXED') {
        try {
            const saved = localStorage.getItem('mdc_vocab_list');
            if (saved) {
                const items = JSON.parse(saved);
                items.forEach(item => {
                    if (item.isFolder && item.items) {
                        item.items.forEach(sub => processItem(sub.eng, sub.esp));
                    } else if (!item.isFolder) {
                        processItem(item.eng, item.esp);
                    }
                });
            }
        } catch (e) { console.error("Error cargando LocalStorage", e); }
        if (tempVocabList.length > 0) localDataLoaded = true;
    }

    let forceInternal = false;
    if (source === 'LOCAL' && !localDataLoaded) {
        console.warn("MY DB est√° vac√≠a. Usando INTERNAL como respaldo.");
        forceInternal = true;
    }

    if (typeof INTERNAL_VOCAB !== 'undefined') { 
        let categoriesToLoad = [];
        if (source === 'ALL_INTERNAL' || source === 'MIXED' || forceInternal) {
            categoriesToLoad = Object.keys(INTERNAL_VOCAB);
        } else if (source !== 'LOCAL') {
            if (INTERNAL_VOCAB[source]) {
                categoriesToLoad = [source];
            }
        }
        categoriesToLoad.forEach(catKey => {
            if (INTERNAL_VOCAB[catKey]) {
                INTERNAL_VOCAB[catKey].forEach(i => processItem(i.en, i.es));
            }
        });
    }

    totalAvailableWords = tempVocabList.length;

    // --- APLICAR L√çMITE NUM√âRICO (NO PORCENTAJE) ---
    if (tempVocabList.length > 0) {
        // Asegurar que activeWordLimit no sea mayor al total
        let limit = userSettings.activeWordLimit || 10;
        if (limit > totalAvailableWords) limit = totalAvailableWords;
        
        activeVocabList = tempVocabList.slice(0, limit);
    } else {
        activeVocabList = [{ en: "NO DATA", es: ["VACIO"] }];
    }
    
    // Actualizar las estadisticas visuales
    updateDbStats();
    
    refreshGameDeck();
}

function refreshGameDeck() {
    gameDeck = [];
    const hasData = activeVocabList.length > 0 && activeVocabList[0].en !== "NO DATA";

    if (hasData) {
        activeVocabList.forEach(item => {
            if (!disabledWords.has(item.en)) {
                gameDeck.push(item);
                if (reinforcedWords.has(item.en)) {
                    for(let k=0; k<10; k++) {
                        gameDeck.push(item);
                    }
                }
            }
        });
    }
    if(gameDeck.length === 0) gameDeck.push({en: "NO ACTIVE", es: ["CHECK LIST"]});
}

function toggleWordStatus(engWord) {
    if(disabledWords.has(engWord)) {
        disabledWords.delete(engWord);
    } else {
        disabledWords.add(engWord);
        if (reinforcedWords.has(engWord)) {
            reinforcedWords.delete(engWord);
        }
    }
    saveLists();
    refreshGameDeck();
    if(studyGuide.style.display === 'flex') populateStudyGuide();
}

function toggleReinforceStatus(engWord) {
    if (reinforcedWords.has(engWord)) {
        reinforcedWords.delete(engWord);
    } else {
        reinforcedWords.add(engWord);
        if (disabledWords.has(engWord)) {
            disabledWords.delete(engWord);
        }
    }
    saveLists();
    refreshGameDeck();
    if(studyGuide.style.display === 'flex') populateStudyGuide();
}

function saveLists() {
    localStorage.setItem(DISABLED_WORDS_KEY, JSON.stringify([...disabledWords]));
    localStorage.setItem(REINFORCED_WORDS_KEY, JSON.stringify([...reinforcedWords]));
}

// --- QUIZ & LEVENSHTEIN ---
function similarity(s1, s2) {
    var longer = s1; var shorter = s2;
    if (s1.length < s2.length) { longer = s2; shorter = s1; }
    var longerLength = longer.length;
    if (longerLength == 0) return 1.0;
    return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
    var costs = new Array();
    for (var i = 0; i <= s1.length; i++) {
        var lastValue = i;
        for (var j = 0; j <= s2.length; j++) {
            if (i == 0) costs[j] = j;
            else {
                if (j > 0) {
                    var newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1))
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

function triggerPopQuiz() {
    gameRunning = false; 
    
    // --- NUEVO CODIGO: FILTRAR SOLO BOOSTED WORDS ---
    // Buscar en el mazo palabras que est√©n en la lista de reforzados (reinforcedWords)
    let candidateList = gameDeck.filter(item => reinforcedWords.has(item.en));
    
    // Si la lista de candidatos est√° vac√≠a (usuario no tiene boosts), usar el mazo completo
    if (candidateList.length === 0) {
        candidateList = gameDeck;
    }

    const randomItem = candidateList[Math.floor(Math.random() * candidateList.length)];
    // --- FIN NUEVO CODIGO ---

    currentQuizWord = randomItem;
    
    const mode = Math.random() > 0.5 ? 'EN_TO_ES' : 'ES_TO_EN';
    currentQuizWord.mode = mode;

    const qEl = document.getElementById('quiz-question');
    const iEl = document.getElementById('quiz-input');
    const fEl = document.getElementById('quiz-feedback');
    const titleEl = document.getElementById('quiz-title');
    const overlay = document.getElementById('quiz-overlay');
    
    iEl.value = "";
    fEl.innerText = "";
    titleEl.innerText = "SYSTEM HACK!";
    titleEl.style.color = "var(--neon-red)";
    overlay.style.borderColor = "var(--neon-red)";
    
    if (mode === 'EN_TO_ES') {
        qEl.innerText = `TRANSLATE: ${randomItem.en}`;
        iEl.placeholder = "TYPE IN SPANISH";
    } else {
        qEl.innerText = `TRANSLATE: ${randomItem.es[0]}`; 
        iEl.placeholder = "TYPE IN ENGLISH";
    }

    document.getElementById('quiz-screen').style.display = 'flex';
    document.getElementById('quiz-input').focus();
}

function skipQuiz() {
    score = Math.max(0, score - 500); 
    scoreEl.innerText = score;
    const feedback = document.getElementById('quiz-feedback');
    feedback.style.color = '#ffaa00';
    feedback.innerText = `CORRECT WAS: ${currentQuizWord.mode === 'EN_TO_ES' ? currentQuizWord.es[0] : currentQuizWord.en}`;
    
    setTimeout(() => {
        document.getElementById('quiz-screen').style.display = 'none';
        quizTimer = 0; 
        gameRunning = true;
        lastTime = performance.now();
        gameLoopId = requestAnimationFrame(loop);
    }, 2000); 
}

function checkQuizAnswer() {
    const userInput = cleanText(document.getElementById('quiz-input').value);
    const feedback = document.getElementById('quiz-feedback');
    const overlay = document.getElementById('quiz-overlay');
    const titleEl = document.getElementById('quiz-title');
    
    let correctAnswers = [];
    if (currentQuizWord.mode === 'EN_TO_ES') correctAnswers = currentQuizWord.es; 
    else correctAnswers = [currentQuizWord.en];

    let maxSim = 0;
    let bestMatch = "";
    
    correctAnswers.forEach(ans => {
        const sim = similarity(userInput, ans);
        if (sim > maxSim) { maxSim = sim; bestMatch = ans; }
    });

    if (maxSim >= 1.0) {
        feedback.style.color = '#0f0';
        feedback.innerText = "SYSTEM RESTORED! BOMB CLEAR ACTIVATED!";
        setTimeout(resolveQuizSuccess, 1000);
    } else {
        const inputEl = document.getElementById('quiz-input');
        inputEl.classList.add('shake');
        setTimeout(()=>inputEl.classList.remove('shake'), 500);
        titleEl.innerText = "CRITICAL FAILURE!";
        overlay.style.borderColor = "#ff0000";
        const displayCorrect = bestMatch || correctAnswers[0] || "ERROR";
        feedback.innerHTML = `INCORRECT. REPAIR SEQUENCE REQUIRED:<br><span class="correct-ans-highlight">${displayCorrect}</span>`;
        inputEl.value = "";
        inputEl.placeholder = "TYPE THE WORD ABOVE";
        inputEl.focus();
    }
}

function resolveQuizSuccess() {
    quizTimer = 0; 
    document.getElementById('quiz-screen').style.display = 'none';
    
    for(let i=0; i<10; i++) {
        setTimeout(() => {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const color = `hsl(${Math.random()*360}, 100%, 50%)`;
            createExplosion(x, y, color, 40); 
            playSound('firework'); 
        }, i * 200); 
    }

    enemyBombs = []; 
    enemies.forEach(e => {
        e.fading = true;
        createExplosion(e.x, e.y, e.color, 20);
        score += 50;
    });
    lockedEnemyId = null; 
    
    gameRunning = true;
    lastTime = performance.now();
    gameLoopId = requestAnimationFrame(loop);
}

document.getElementById('quiz-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') checkQuizAnswer();
});

/* =========================================
   GAME ENGINE
   ========================================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const livesEl = document.getElementById('lives');
const highScoreEl = document.getElementById('highScore');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const studyGuide = document.getElementById('study-guide');
const studyTableContainer = document.getElementById('study-table-container');

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let gameLoopId;

const audioQueue = [];
let isSpeaking = false;
let availableVoices = [];

function loadVoices() {
    availableVoices = window.speechSynthesis.getVoices();
}
if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
}

setInterval(() => {
    if (!isSpeaking && audioQueue.length > 0) {
        const next = audioQueue.shift();
        playText(next.text, next.lang, next.enemyId);
    }
}, 100);

function speak(text, lang, isBomb = false, enemyId = null) {
    if (isBomb) {
        if (!userSettings.audioBombs) return;
    } else {
        if (!userSettings.audioWords) return;
    }
    audioQueue.push({text, lang, enemyId});
}

function getBestVoice(lang) {
    if (availableVoices.length === 0) loadVoices();
    const baseLang = lang.split('-')[0];
    const candidates = availableVoices.filter(v => v.lang.startsWith(baseLang));
    if (candidates.length === 0) return null;
    const scoreVoice = (v) => {
        let score = 0;
        if (v.lang === lang) score += 10; 
        if (v.name.includes("Google") || v.name.includes("Premium")) score += 5; 
        if (v.default) score += 1;
        return score;
    };
    candidates.sort((a, b) => scoreVoice(b) - scoreVoice(a));
    return candidates[0];
}

function playText(text, lang, enemyId) {
    if (!window.speechSynthesis) return;
    isSpeaking = true;
    window.speechSynthesis.cancel();
    
    let textToSpeak = text.toLowerCase().replace(/\//g, ', '); 

    if (text.length === 1 && text.match(/[A-Z]/i)) textToSpeak = text.toLowerCase() + ".";
    const u = new SpeechSynthesisUtterance(textToSpeak);
    u.lang = lang; u.rate = 0.9; 
    const bestVoice = getBestVoice(lang);
    if (bestVoice) u.voice = bestVoice;
    
    u.onstart = () => {
        if (enemyId) {
            const targetEnemy = enemies.find(e => e.id === enemyId);
            if (targetEnemy) {
                targetEnemy.fading = true; 
                createExplosion(targetEnemy.x, targetEnemy.y, '#ffffff', 50); 
                playSound('hit_syn');
            }
        }
    };
    
    u.onend = () => { setTimeout(() => { isSpeaking = false; }, 400); };
    u.onerror = () => { isSpeaking = false; };
    window.speechSynthesis.speak(u);
}

function playSound(type) {
    if (!userSettings.audioFX) return;
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    if(userSettings.masterVolume <= 0) return;
    const vol = userSettings.masterVolume / 100;

    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const n = audioCtx.currentTime;
    
    if(type==='shoot'){
        o.type='square'; o.frequency.setValueAtTime(400,n); o.frequency.exponentialRampToValueAtTime(100,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.1);
    }
    else if(type==='ban_shoot'){
        o.type='sine'; o.frequency.setValueAtTime(800,n); o.frequency.exponentialRampToValueAtTime(200,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.1);
    }
    else if(type==='boost_shoot'){
        o.type='square'; o.frequency.setValueAtTime(200,n); o.frequency.linearRampToValueAtTime(600,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.1);
    }
    else if(type==='hit_eng'){
        o.type='sawtooth'; o.frequency.setValueAtTime(600,n); o.frequency.linearRampToValueAtTime(800,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.15);
    }
    else if(type==='hit_syn'){
        o.type='sine'; o.frequency.setValueAtTime(1200,n); o.frequency.linearRampToValueAtTime(1800,n+.1);
        g.gain.setValueAtTime(0.1 * vol, n); g.gain.linearRampToValueAtTime(0,n+.3);
    }
    else if(type==='player_hit'){
        o.type='sawtooth'; o.frequency.setValueAtTime(120,n); o.frequency.linearRampToValueAtTime(8,n+.3);
        g.gain.setValueAtTime(0.2 * vol, n); g.gain.linearRampToValueAtTime(0,n+.5);
    }
    else if(type==='firework'){ 
        o.type='triangle'; o.frequency.setValueAtTime(300,n); o.frequency.exponentialRampToValueAtTime(50,n+.3);
        g.gain.setValueAtTime(0.2 * vol, n); g.gain.exponentialRampToValueAtTime(0.01,n+.3);
    }
    else if(type==='ban_success'){
        o.type='sine'; o.frequency.setValueAtTime(200,n); o.frequency.linearRampToValueAtTime(100,n+.5);
        g.gain.setValueAtTime(0.2 * vol, n); g.gain.linearRampToValueAtTime(0,n+.5);
    }
    else if(type==='boost_success'){
        o.type='triangle'; o.frequency.setValueAtTime(400,n); 
        o.frequency.linearRampToValueAtTime(600,n+.1);
        o.frequency.linearRampToValueAtTime(800,n+.2);
        o.frequency.linearRampToValueAtTime(1200,n+.4);
        g.gain.setValueAtTime(0.2 * vol, n); g.gain.linearRampToValueAtTime(0,n+.4);
    }
    o.start(n); o.stop(n + 0.5);
}

let gameRunning=false, score=0, combo=0, lives=5, highScore=0, lastTime=0;
let spawnTimer = 0;
let enemiesSpawnedCount = 0; 
const player = {x:0, y:0, w:48, h:48, speed:8, color:'#4f46e5', invincible:false, invTimer:0}; 
let bullets=[], enemies=[], particles=[], stars=[], enemyBombs=[], keys={};

function loadHighScore(){const s=localStorage.getItem('synonymHunterHighScore');highScore=s?parseInt(s):0;highScoreEl.innerText=highScore;}

function populateStudyGuide(){
    document.getElementById('db-title').innerText = "DATABASE: " + userSettings.vocabSource;
    
    let html='<table><thead><tr><th class="chk-cell">PLAY</th><th class="chk-cell">BOOST</th><th>ENGLISH</th><th>TRANSLATION</th></tr></thead><tbody>';
    
    activeVocabList.forEach(v => {
        const cleanWord = v.en; 
        const cleanWordQuote = cleanWord.replace(/'/g, "\\'"); 
        
        const isBanned = disabledWords.has(cleanWord);
        const isBoosted = reinforcedWords.has(cleanWord);
        const isChecked = !isBanned;

        let rowClass = "";
        if (isBoosted) rowClass = "boosted-row";
        if (isBanned) rowClass = "banned-row"; 

        const starIcon = isBoosted ? '‚òÖ' : '‚òÜ';
        const starClass = isBoosted ? 'star-active' : 'star-inactive';

        html += `<tr class="${rowClass}">
            <td class="chk-cell">
                <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleWordStatus('${cleanWordQuote}')">
            </td>
            <td class="chk-cell star-cell" onclick="toggleReinforceStatus('${cleanWordQuote}')">
                <span class="${starClass}">${starIcon}</span>
            </td>
            <td class="en-word">${cleanWord}</td>
            <td>${v.es[0]||"-"}</td>
        </tr>`;
    });
    html+='</tbody></table>';
    studyTableContainer.innerHTML=html;
}

function toggleStudyGuide(){
    const isOpen = studyGuide.style.display==='flex';
    if(isOpen){
        studyGuide.style.display='none';
        if(startScreen.style.display==='none' && gameOverScreen.style.display==='none'){
            gameRunning=true; lastTime=performance.now(); 
            gameLoopId = requestAnimationFrame(loop);
        }
    }else{
        gameRunning=false; cancelAnimationFrame(gameLoopId);
        populateStudyGuide(); studyGuide.style.display='flex';
        if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    }
}

function resize(){
    canvas.width=innerWidth; canvas.height=innerHeight;
    player.y=canvas.height-130; player.x=canvas.width/2-player.w/2;
}
window.addEventListener('resize',resize);

for(let i=0;i<80;i++) stars.push({
    x:Math.random()*innerWidth, y:Math.random()*innerHeight,
    size:Math.random()*2, speed:Math.random()*0.2+0.1,
    alphaBase: Math.random()*0.5+0.3, phase: Math.random() * Math.PI * 2
});

function getRandomBombContent() {
    if (Math.random() > 0.5) return "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*26));
    else return Math.floor(Math.random() * (9999 - 10) + 10).toString();
}

function getSafeSpawnX(enemyWidth) {
    const attempts = 15; const padding = 20;
    for (let i = 0; i < attempts; i++) {
        let safe = true;
        let candX = Math.random() * (canvas.width - enemyWidth - 50) + enemyWidth/2 + 25;
        for (let e of enemies) {
            if (e.y < 250) { 
                if (candX < e.x + e.w/2 + padding && candX > e.x - e.w/2 - padding) { safe = false; break; }
            }
        }
        if (safe) return candX;
    }
    return Math.random() * (canvas.width - enemyWidth - 50) + enemyWidth/2 + 25;
}

function getBossTypeForSource(source) {
    if (source === 'ALL_INTERNAL' || source === 'MIXED') {
        return Math.random() > 0.5 ? 'IRREGULAR_VERBS' : 'REGULAR_VERBS';
    }
    if (source === 'REGULAR_VERBS') return 'REGULAR_VERBS';
    if (source === 'IRREGULAR_VERBS') return 'IRREGULAR_VERBS';
    if (source === 'LOCAL') return null;
    return null; 
}

function spawnEnemy(){
    const bossFreq = userSettings.bossFrequency || 15;
    
    if (enemiesSpawnedCount > 0 && enemiesSpawnedCount % bossFreq === 0) {
        const source = userSettings.vocabSource;
        const bossType = getBossTypeForSource(source);

        if (bossType) {
            spawnBoss(bossType); 
            enemiesSpawnedCount++; 
            return; 
        }
    }

    if(gameDeck.length===0) return;
    const d=gameDeck[Math.floor(Math.random()*gameDeck.length)];
    ctx.font='16px "Press Start 2P"';
    const textWidth=ctx.measureText(d.en).width;
    const startX = getSafeSpawnX(textWidth);
    const vx = (Math.random() - 0.5) * 2.0;
    const baseSpeed = (Math.random()*0.8+0.4) * userSettings.enemySpeed;

    const isBoosted = reinforcedWords.has(d.en);

    enemies.push({
        id: Date.now() + Math.random(), 
        x: startX, y: -40, 
        wordData:d, text:d.en, 
        stage:0, hits:0, banHits: 0, boostHits: 0, demoteHits: 0, 
        speed: baseSpeed, vx: vx, 
        color: isBoosted ? '#FFD700' : '#ffffff',
        isBoosted: isBoosted,
        timer:0, fading:false, w:textWidth, droppedBomb: false, isBoss: false 
    });
    enemiesSpawnedCount++;
}

function spawnBoss(forcedListType) {
    if (typeof INTERNAL_VOCAB === 'undefined' || !INTERNAL_VOCAB) return;

    const activeEnglishWords = new Set(gameDeck.map(d => d.en));
    
    const allRegulars = INTERNAL_VOCAB['REGULAR_VERBS'] || [];
    const allIrregulars = INTERNAL_VOCAB['IRREGULAR_VERBS'] || [];

    const validRegulars = allRegulars.filter(v => activeEnglishWords.has(v.en));
    const validIrregulars = allIrregulars.filter(v => activeEnglishWords.has(v.en));

    let poolToUse = [];
    let listType = '';

    if (forcedListType) {
        if (forcedListType === 'REGULAR_VERBS') poolToUse = validRegulars;
        else if (forcedListType === 'IRREGULAR_VERBS') poolToUse = validIrregulars;
        listType = forcedListType;
    } else {
        if (Math.random() > 0.5 && validIrregulars.length > 0) {
            poolToUse = validIrregulars;
            listType = 'IRREGULAR_VERBS';
        } else if (validRegulars.length > 0) {
            poolToUse = validRegulars;
            listType = 'REGULAR_VERBS';
        } else if (validIrregulars.length > 0) {
            poolToUse = validIrregulars;
            listType = 'IRREGULAR_VERBS';
        }
    }

    if (poolToUse.length === 0) {
        spawnEnemy(); 
        return;
    }

    const verbData = poolToUse[Math.floor(Math.random() * poolToUse.length)];

    ctx.font = '16px "Press Start 2P"';
    const wBase = ctx.measureText(verbData.en).width;
    const wPast = ctx.measureText(verbData.past).width;
    const wPart = ctx.measureText(verbData.part).width;
    const maxW = Math.max(wBase, wPast, wPart);
    const startX = getSafeSpawnX(maxW);
    
    let bossColor = listType === 'REGULAR_VERBS' ? '#00ffff' : '#ff00ff'; 
    let speedMod = listType === 'REGULAR_VERBS' ? 1.0 : 0.6; 

    enemies.push({
        id: Date.now() + Math.random(),
        x: startX, y: -100, 
        wordData: verbData, isBoss: true, bossType: verbData.type,
        phases: [
            { text: verbData.en, hits: 0, completed: false },   
            { text: verbData.past, hits: 0, completed: false }, 
            { text: verbData.part, hits: 0, completed: false }  
        ],
        activePhase: 0, speed: (0.5 * userSettings.enemySpeed) * speedMod,
        vx: 0, color: bossColor, w: maxW,
        droppedBomb: false, fading: false, bossFinished: false,
        banHits: 0, boostHits: 0, demoteHits: 0
    });
}

function createExplosion(x,y,c,n=10){
    for(let i=0;i<n;i++) {
        if(particles.length > 400) particles.shift(); 
        particles.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,life:1,color:c});
    }
}
function checkCollisionRect(r1, r2) {
    return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
}
function drawRobot(ctx, x, y, w, h, color) {
    ctx.fillStyle = color; ctx.fillRect(x + 8, y + 15, w - 16, h - 20);
    ctx.fillStyle = '#ccc'; ctx.fillRect(x + 4, y, w - 8, 20);
    ctx.fillStyle = gameRunning ? '#0f0' : '#f00';
    ctx.fillRect(x + 10, y + 5, 8, 8); ctx.fillRect(x + w - 18, y + 5, 8, 8);
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(x + w/2, y); ctx.lineTo(x + w/2, y - 10); ctx.stroke();
    const time = Date.now();
    ctx.fillStyle = (Math.floor(time/200)%2===0) ? 'red' : '#500';
    ctx.beginPath(); ctx.arc(x + w/2, y - 10, 3, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#555'; ctx.fillRect(x + 4, y + h - 5, 10, 5); ctx.fillRect(x + w - 14, y + h - 5, 10, 5);
}

let lastFrameTime = 0; const targetFPS = 30; const frameInterval = 1000 / targetFPS;

function loop(timestamp) {
    if (!gameRunning) return;
    gameLoopId = requestAnimationFrame(loop);
    const elapsed = timestamp - lastFrameTime;
    if (elapsed < frameInterval) return;
    lastFrameTime = timestamp - (elapsed % frameInterval);
    const timeScale = elapsed / (1000/60); 
    update(elapsed, timeScale);
    draw(timestamp);
}

function update(dt, timeScale){
    if(timeScale > 4) timeScale = 1;
    if (userSettings.quizEnabled) {
        quizTimer += 33; 
        if (quizTimer >= userSettings.quizInterval * 1000) { triggerPopQuiz(); return; }
    }
    if(player.invincible){player.invTimer-=dt;if(player.invTimer<=0)player.invincible=false;}
    
    if (isTouchingLeft) {
        const delta = touchCurrentX - touchStartX;
        const algo = userSettings.movementAlgo || 'algo1';

        if (algo === 'algo1') {
            if (delta < -15) keys['ArrowLeft'] = true; else keys['ArrowLeft'] = false;
            if (delta > 15) keys['ArrowRight'] = true; else keys['ArrowRight'] = false;
        } 
        else if (algo === 'algo2') {
            player.x += delta * 1.5; 
            touchStartX = touchCurrentX; 
        }
        else if (algo === 'algo3') {
            let moveSpeed = 0;
            const deadZone = 10;
            const maxRange = 100; 
            
            if (Math.abs(delta) > deadZone) {
                let factor = (Math.abs(delta) - deadZone) / maxRange;
                if(factor > 1) factor = 1;
                
                if (delta < 0) player.x -= (player.speed * 1.5 * factor) * timeScale;
                else player.x += (player.speed * 1.5 * factor) * timeScale;
            }
        }
    } else {
        if (userSettings.movementAlgo === 'algo1') {
        }
    }

    if(keys['ArrowLeft']&&player.x>0)player.x -= player.speed * timeScale;
    if(keys['ArrowRight']&&player.x<canvas.width-player.w)player.x += player.speed * timeScale;
    
    if(player.x < 0) player.x = 0;
    if(player.x > canvas.width - player.w) player.x = canvas.width - player.w;

    stars.forEach(s=>{ s.y += s.speed * timeScale; if(s.y>canvas.height)s.y=0; });
    spawnTimer-=dt; if(spawnTimer<0){spawnEnemy(); spawnTimer=gameVars.spawnInterval;}
    
    for(let i=enemyBombs.length-1; i>=0; i--){
        let b = enemyBombs[i];
        b.y += b.vy * timeScale; b.x += (Math.sin(b.y * 0.05) * 1.5) * timeScale; 
        if(!player.invincible && checkCollisionRect(player, b)){
             lives--; livesEl.innerText=lives;
             createExplosion(player.x+player.w/2, player.y+player.h/2, '#ff4444', 30);
             playSound('player_hit'); player.invincible=true; player.invTimer=2000;
             enemyBombs.splice(i,1); if(lives<=0){gameOver();return;} continue;
        }
        for(let j=bullets.length-1; j>=0; j--){
            let bullet = bullets[j];
            // --- CAMBIO: Se removi√≥ la condici√≥n que requeria bullet.type === 'normal' ---
            // AHORA CUALQUIER BALA DESTRUYE BOMBAS
            if(bullet.x > b.x-20 && bullet.x < b.x+b.w+20 && bullet.y > b.y && bullet.y < b.y+b.h){
                bullets.splice(j,1); createExplosion(b.x, b.y, b.color, 15);
                playSound('hit_eng'); speak(b.text, 'en-US', true); 
                score += 25; scoreEl.innerText = score; enemyBombs.splice(i,1); break;
            }
        }
        if(b.y > canvas.height) enemyBombs.splice(i,1);
    }

    for(let i=bullets.length-1;i>=0;i--){ bullets[i].y -= 12 * timeScale; if(bullets[i].y<0)bullets.splice(i,1); }
    
    for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        if(e.bossFinished) { e.timer += dt; if(e.timer > 4000) e.fading = true; } 
        else {
             e.y += e.speed * timeScale; e.x += e.vx * timeScale; 
            if (e.x < e.w/2 + 10 || e.x > canvas.width - e.w/2 - 10) {
                e.vx *= -1; 
                if(e.x < e.w/2 + 10) e.x = e.w/2 + 11;
                if(e.x > canvas.width - e.w/2 - 10) e.x = canvas.width - e.w/2 - 11;
            }
        }
        if(!e.fading && !e.droppedBomb && (e.isBoss || e.stage < 2) && Math.random() < (gameVars.bombProb * timeScale)) {
            e.droppedBomb = true; 
            enemyBombs.push({
                x: e.x, y: e.y + 40, text: getRandomBombContent(),
                color: `hsl(${Math.random()*360}, 100%, 70%)`, vy: e.speed + userSettings.bombSpeed, w: 20, h: 30
            });
        }
        if(e.fading){
            if (lockedEnemyId === e.id) lockedEnemyId = null;
            createExplosion(e.x,e.y,e.color,1); enemies.splice(i,1); continue;
        }
        let eRect = e.isBoss ? {x: e.x-e.w/2, y: e.y-70, w: e.w, h: 90} : {x: e.x-e.w/2, y: e.y-15, w: e.w, h:30};
        if(!player.invincible && !e.bossFinished && checkCollisionRect(player, eRect)){
            lives--;livesEl.innerText=lives;createExplosion(player.x+player.w/2,player.y+player.h/2,'#ff4444',30);
            playSound('player_hit'); player.invincible=true;player.invTimer=2000;enemies.splice(i,1);combo=0;comboEl.innerText=combo;
            if (lockedEnemyId === e.id) lockedEnemyId = null;
            if(lives<=0){gameOver();return;} continue;
        }
        
        if(e.stage===1){
            e.timer+=dt;
            if(e.timer>8000) e.fading=true; 
        } 
        
        for(let j=bullets.length-1;j>=0;j--){
            const b=bullets[j];
            if (lockedEnemyId !== null && lockedEnemyId !== e.id) continue; 
            
            let hit = false; let targetY = e.y;
            if (e.isBoss && !e.bossFinished) {
                const yOffset = e.activePhase * 30; targetY = e.y - yOffset;
                if(b.x > e.x-e.w/2-10 && b.x < e.x+e.w/2+10 && b.y > targetY-20 && b.y < targetY+10) hit = true;
            } else if (!e.isBoss) {
                if(b.x>e.x-e.w/2-10 && b.x<e.x+e.w/2+10 && b.y>e.y-20 && b.y<e.y+10) hit = true;
            }

            if (hit) {
                bullets.splice(j,1);
                if (lockedEnemyId === null) lockedEnemyId = e.id;
                
                if (b.type === 'ban') {
                    e.banHits++; createExplosion(e.x, targetY, '#00ffff', 15); playSound('hit_eng');
                    if (e.banHits >= 3) {
                        toggleWordStatus(e.wordData.en); e.fading = true; 
                        createExplosion(e.x, e.y, '#000000', 50); playSound('ban_success');
                        
                        // Revisi√≥n de victoria o Level Up
                        const validWords = gameDeck.filter(w => w.en !== "NO ACTIVE");
                        if (validWords.length === 0) {
                            if (userSettings.activeWordLimit < totalAvailableWords) {
                                increaseLevel();
                            } else {
                                triggerGrandFinale();
                            }
                        }
                    }
                } 
                else if (b.type === 'boost') {
                    e.boostHits++; createExplosion(e.x, targetY, '#ffff00', 15); playSound('hit_eng');
                    if (e.boostHits >= 3) {
                          if (!reinforcedWords.has(e.wordData.en)) {
                             toggleReinforceStatus(e.wordData.en);
                             e.fading = true; createExplosion(e.x, e.y, '#FFD700', 80); playSound('boost_success'); score += 200; 
                          } else { e.fading = true; createExplosion(e.x, e.y, '#FFD700', 20); }
                    }
                }
                else {
                    if (e.isBoosted) {
                          e.demoteHits++; 
                          createExplosion(e.x, targetY, '#ff4444', 5);
                          playSound('hit_eng');
                          if (e.demoteHits >= 3) {
                              toggleReinforceStatus(e.wordData.en);
                              e.isBoosted = false; 
                              e.color = '#ffffff'; 
                              e.demoteHits = 0; e.banHits = 0; e.hits = 0; 
                              createExplosion(e.x, e.y, '#ffffff', 30);
                              playSound('hit_syn');
                          }
                    } 
                    else {
                        if (e.isBoss && !e.bossFinished) {
                            const phase = e.phases[e.activePhase]; phase.hits++; playSound('hit_eng'); createExplosion(e.x, targetY, e.color, 10);
                            if (phase.hits >= 3) {
                                phase.completed = true; speak(phase.text, 'en-US', false); e.activePhase++; score += 100;
                                if (e.activePhase >= 3) {
                                    e.bossFinished = true; e.color = '#00ff00'; e.timer = 0;
                                    e.phases[2].text = e.wordData.es; e.phases[2].completed = false; e.activePhase = 2; 
                                    createExplosion(e.x, e.y, '#ffffff', 150); playSound('hit_syn'); score += 500; combo++; speak(e.wordData.es, 'es-ES', false, e.id); 
                                }
                            }
                        } else if (!e.isBoss) {
                            e.timer=0;
                            if(e.stage===0){
                                e.hits++; 
                                if(e.hits === 1) speak(e.text, 'en-US', false); 
                                playSound('hit_eng');score+=10;
                                if(e.hits >= 3) {
                                    e.stage = 1; e.text = e.wordData.es[0]; e.color='#00ff00';
                                    createExplosion(e.x,e.y,'#00ff00',20); score+=50; combo++;
                                    ctx.font='20px "Press Start 2P"'; e.w = ctx.measureText(e.text).width;
                                    speak(e.text, 'es-ES', false, e.id); 
                                }
                            }
                        }
                    }
                    scoreEl.innerText=score; comboEl.innerText=combo;
                }
                break; 
            }
        }
        if(e.y>canvas.height){
            if(e.stage<1)combo=0; comboEl.innerText=combo;
            if (lockedEnemyId === e.id) lockedEnemyId = null; 
            enemies.splice(i,1);
        }
    }
    for(let i=particles.length-1;i>=0;i--){
        const p=particles[i]; p.x += p.vx * timeScale; p.y += p.vy * timeScale; p.life -= 0.04 * timeScale; if(p.life<=0)particles.splice(i,1);
    }
}

// --- ACTUALIZADO: NUEVA L√ìGICA DE NIVEL BASADA EN CONTADOR ---
function increaseLevel() {
    if (totalAvailableWords === 0) return;
    
    // Sumar exactamente el n√∫mero de palabras configurado
    const inc = userSettings.wordsPerLevel || 10;
    userSettings.activeWordLimit += inc;
    
    // Tope m√°ximo
    if (userSettings.activeWordLimit > totalAvailableWords) {
        userSettings.activeWordLimit = totalAvailableWords;
    }

    updateConfig('limit_update');
    
    for(let i=0; i<5; i++) {
        setTimeout(() => {
            const x = Math.random() * canvas.width;
            const y = Math.random() * (canvas.height/2);
            createExplosion(x, y, `hsl(${Math.random()*360}, 100%, 50%)`, 30);
            playSound('firework');
        }, i*300);
    }
    
    // Mostrar cartel con cantidad exacta sumada
    const msg = document.getElementById('level-up-msg');
    msg.innerHTML = `LEVEL UP!<br>+${inc} NEW WORDS`; 
    msg.style.animation = 'none';
    msg.offsetHeight; 
    msg.style.animation = 'floatUp 2s forwards';
}

function triggerGrandFinale() {
    gameRunning = false;
    cancelAnimationFrame(gameLoopId);
    
    document.getElementById('grand-finale-screen').style.display = 'flex';
    
    const canvas = document.getElementById('gameCanvas'); 
    const ctx = canvas.getContext('2d');
    
    const finaleLoop = () => {
        if (document.getElementById('grand-finale-screen').style.display === 'none') return;
        requestAnimationFrame(finaleLoop);
        
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        
        if (Math.random() < 0.1) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            createExplosion(x, y, `hsl(${Math.random()*360}, 100%, 60%)`, 50);
            playSound('firework');
        }
        
        for(let i=particles.length-1;i>=0;i--){
            const p=particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.02; 
            if(p.life<=0)particles.splice(i,1);
            else {
                ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,4,4);
            }
        }
        ctx.globalAlpha=1;
    };
    finaleLoop();
}

function draw(timestamp){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    stars.forEach(s=>{
        const opacity = s.alphaBase + Math.sin(timestamp * 0.005 + s.phase) * 0.2;
        ctx.fillStyle=`rgba(255,255,255,${Math.max(0.1, opacity)})`;
        ctx.beginPath();ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fill();
    });
    if(!player.invincible||(Math.floor(Date.now()/100)%2===0)){
        drawRobot(ctx, player.x, player.y, player.w, player.h, player.color);
    }
    ctx.textAlign='center'; ctx.textBaseline='middle';
    
    enemyBombs.forEach(b => {
        ctx.strokeStyle='#fff'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(b.x-10, b.y-15); ctx.lineTo(b.x-4, b.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(b.x+10, b.y-15); ctx.lineTo(b.x+4, b.y); ctx.stroke();
        ctx.fillStyle=b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y-15, 12, Math.PI, 0); ctx.fill();
        ctx.font='12px "Press Start 2P"'; ctx.fillStyle='#fff'; ctx.fillText(b.text, b.x, b.y+10);
    });

    bullets.forEach(b => {
        if(b.type === 'ban') ctx.fillStyle = '#00ffff'; 
        else if (b.type === 'boost') ctx.fillStyle = '#ffff00';
        else ctx.fillStyle = '#ff0055'; 
        ctx.fillRect(b.x-2,b.y,4,15);
    });
    
    enemies.forEach(e=>{
        const isLockedOut = (lockedEnemyId !== null && lockedEnemyId !== e.id);
        if (isLockedOut) { ctx.globalAlpha = 0.3; ctx.shadowBlur = 0; } else { ctx.globalAlpha = 1.0; }

        if (e.isBoss) {
            e.phases.forEach((p, index) => {
                const yPos = e.y - (index * 30);
                if (p.completed) { ctx.fillStyle = '#444'; ctx.shadowBlur = 0; ctx.fillText(p.text, e.x, yPos); }
                else if (index === e.activePhase) {
                    ctx.fillStyle = e.color; 
                    if(!isLockedOut) { ctx.shadowColor = e.color; ctx.shadowBlur = 15; }
                    ctx.font = 'bold 16px "Press Start 2P"';
                    ctx.fillText(p.text, e.x, yPos); ctx.lineWidth = 1; ctx.strokeStyle = '#fff'; ctx.strokeText(p.text, e.x, yPos);
                } else { ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.shadowBlur = 0; ctx.fillText(p.text, e.x, yPos); }
                ctx.shadowBlur = 0; 
                if (index === e.activePhase) {
                    for(let k=0;k<3;k++){
                        ctx.fillStyle = k < p.hits ? '#ff0000' : '#00ff00';
                        ctx.beginPath();ctx.arc(e.x-20+(k*20), yPos+12, 3, 0, Math.PI*2);ctx.fill();
                    }
                }
            });
        } else {
            ctx.font=e.stage>=1?'20px "Press Start 2P"':'16px "Press Start 2P"';
            if (e.isBoosted) {
                ctx.fillStyle = '#FFD700'; 
                if(!isLockedOut) { ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 10; }
            } else {
                ctx.fillStyle = e.color;
                ctx.shadowBlur = 0;
            }
            if(e.stage>=1){ ctx.lineWidth = 2; ctx.strokeStyle = '#003300'; ctx.strokeText(e.text, e.x, e.y); }
            ctx.fillText(e.text,e.x,e.y);
            ctx.shadowBlur = 0; 
            
            if (e.banHits > 0) {
                 ctx.fillStyle = '#00ffff';
                 for(let k=0;k<3;k++){ if (k < e.banHits) { ctx.beginPath();ctx.arc(e.x-22+(k*15),e.y-25, 3, 0, Math.PI*2);ctx.fill(); } }
            }
            if (e.boostHits > 0) {
                 ctx.fillStyle = '#ffff00';
                 for(let k=0;k<3;k++){ if (k < e.boostHits) { ctx.beginPath();ctx.arc(e.x-22+(k*15),e.y-25, 3, 0, Math.PI*2);ctx.fill(); } }
            }
            if (e.isBoosted && e.demoteHits > 0) {
                ctx.fillStyle = '#ff4444';
                for(let k=0;k<3;k++){ if (k < e.demoteHits) { ctx.beginPath();ctx.arc(e.x-22+(k*15),e.y+25, 3, 0, Math.PI*2);ctx.fill(); } }
            }
            if (!e.isBoosted) {
                for(let k=0;k<4;k++){
                    if(k<3) ctx.fillStyle = (e.stage===0 && k<e.hits) || e.stage>0 ? '#00ff00' : '#444'; else ctx.fillStyle = '#444';
                    ctx.beginPath();ctx.arc(e.x-22+(k*15),e.y+25,3,0,Math.PI*2);ctx.fill();
                }
            }
        }
        ctx.globalAlpha = 1.0; 
    });
    
    particles.forEach(p=>{ ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,3,3); });
    ctx.globalAlpha=1;
}

function gameOver(){
    gameRunning=false; cancelAnimationFrame(gameLoopId);
    if(score>highScore){highScore=score;localStorage.setItem('synonymHunterHighScore',highScore);highScoreEl.innerText=highScore;}
    document.getElementById('finalScore').innerText=score;
    gameOverScreen.style.display='flex';
}
function startGame(){
    if(gameRunning) return;
    if(window.speechSynthesis) {
        window.speechSynthesis.cancel(); let unlockVoice = new SpeechSynthesisUtterance(""); unlockVoice.volume = 0; window.speechSynthesis.speak(unlockVoice);
    }
    resize(); startScreen.style.display='none'; gameOverScreen.style.display='none'; studyGuide.style.display='none';
    score=combo=0; lives=5; enemies=[]; bullets=[]; particles=[]; enemyBombs=[]; player.invincible=false;
    enemiesSpawnedCount = 0; lockedEnemyId = null; 
    scoreEl.innerText=comboEl.innerText='0'; livesEl.innerText='5'; loadHighScore();
    gameRunning=true; lastFrameTime = performance.now(); spawnTimer = gameVars.spawnInterval; quizTimer = 0;
    
    keys = {}; isTouchingLeft = false;

    if(audioCtx.state==='suspended') audioCtx.resume().catch(e=>{});
    gameLoopId = requestAnimationFrame(loop);
}

const btnFire = document.getElementById('btn-fire');
const btnBan = document.getElementById('btn-ban'); 
const btnBoost = document.getElementById('btn-boost'); 
const touchZoneLeft = document.getElementById('touch-zone-left'); 

const handleTouchStart = (key, customAction = null) => {
    if (customAction) { customAction(); } else { keys[key] = true; }
    if(key === 'Space' && gameRunning && !customAction) { bullets.push({x:player.x+player.w/2, y:player.y, type: 'normal'}); playSound('shoot'); }
};
const handleTouchEnd = (key) => { keys[key] = false; };
const fireBanBullet = () => { if(gameRunning) { bullets.push({x:player.x+player.w/2, y:player.y, type: 'ban'}); playSound('ban_shoot'); } };
const fireBoostBullet = () => { if(gameRunning) { bullets.push({x:player.x+player.w/2, y:player.y, type: 'boost'}); playSound('boost_shoot'); } };

touchZoneLeft.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (gameRunning) {
        isTouchingLeft = true;
        touchStartX = e.touches[0].clientX;
        touchCurrentX = touchStartX;
    }
}, {passive: false});

touchZoneLeft.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (gameRunning && isTouchingLeft) {
        touchCurrentX = e.touches[0].clientX;
    }
}, {passive: false});

touchZoneLeft.addEventListener('touchend', (e) => {
    e.preventDefault();
    isTouchingLeft = false;
    keys['ArrowLeft'] = false;
    keys['ArrowRight'] = false;
});

['touchstart', 'mousedown'].forEach(evt => {
    btnFire.addEventListener(evt, (e) => { e.preventDefault(); handleTouchStart('Space'); });
    btnBan.addEventListener(evt, (e) => { e.preventDefault(); handleTouchStart(null, fireBanBullet); });
    btnBoost.addEventListener(evt, (e) => { e.preventDefault(); handleTouchStart(null, fireBoostBullet); });
});
['touchend', 'mouseup', 'mouseleave'].forEach(evt => {
    btnFire.addEventListener(evt, (e) => { e.preventDefault(); handleTouchEnd('Space'); });
});

document.addEventListener('keydown', e=>{
    if((e.code==='Tab'||e.code==='Escape') && startScreen.style.display==='none' && gameOverScreen.style.display==='none'){e.preventDefault(); toggleStudyGuide();}
    keys[e.code]=true;
    if(e.code==='Space' && gameRunning){ e.preventDefault(); bullets.push({x:player.x+player.w/2, y:player.y, type: 'normal'}); playSound('shoot'); }
    if(e.code==='KeyB' && gameRunning){ e.preventDefault(); fireBanBullet(); }
    if(e.code==='KeyV' && gameRunning){ e.preventDefault(); fireBoostBullet(); }
});
document.addEventListener('keyup', e=>keys[e.code]=false);

window.onload=()=>{ loadConfig(); loadVocabData(); resize(); renderCategoryBar(); };
    </script>
</body>
</html>
