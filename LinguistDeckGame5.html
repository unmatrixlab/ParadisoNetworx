<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocabulary Hunter: Verb Boss Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #0f0;
            --neon-red: #ff4444;
            --neon-blue: #4f46e5;
            --neon-cyan: #00ffff;
            --neon-purple: #d946ef;
            --neon-yellow: #ffff00;
            --dark-bg: #050505;
            --panel-bg: rgba(0, 15, 0, 0.95);
        }
        body {margin:0;overflow:hidden;background:var(--dark-bg);font-family:'Press Start 2P',monospace;color:white;user-select:none;touch-action:none;}
        canvas {display:block;}
        .scanlines {
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,255,255,0) 50%,rgba(0,0,0,0.1) 50%,rgba(0,0,0,0.1));
            background-size:100% 4px;z-index:999;pointer-events:none;
        }
        #ui {position:absolute;top:10px;left:10px;right:10px;z-index:10;pointer-events:none;display:flex;justify-content:space-between;text-shadow:2px 2px 0 #000; font-size: 10px;}
        #lives-panel {color:var(--neon-red);}
        #score-panel {color:var(--neon-green);}
        
        /* CONTROLES MÓVILES (Posición Ajustada) */
        #mobile-controls {
            display: none; 
            position: absolute; bottom: 20px; width: 100%;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
            z-index: 20; pointer-events: none; align-items: flex-end; 
        }
        .touch-group { display: flex; gap: 20px; pointer-events: auto; }
        .touch-group:first-child { margin-bottom: 150px; } /* Flechas arriba */
        .touch-group:last-child { margin-bottom: 90px; }  /* Disparo arriba */

        .touch-btn {
            width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.1); border: 2px solid var(--neon-green);
            border-radius: 50%; color: var(--neon-green); font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none; text-shadow: 2px 2px 0 #000;
        }
        .touch-btn:active { background: var(--neon-green); color: #000; }
        .btn-fire { border-color: var(--neon-red); color: var(--neon-red); }
        .btn-fire:active { background: var(--neon-red); color: #000; }

        @media (max-width: 768px) or (pointer: coarse) {
            #mobile-controls { display: flex; }
            #category-bar-wrapper { bottom: 100px; } 
            h1 { font-size: 20px; }
            p { font-size: 10px; line-height: 1.5; }
        }

        /* BARRA INFERIOR */
        #category-bar-wrapper {
            position:absolute; bottom:30px; left:0; width:100%; padding:10px 0;
            background:rgba(0,0,0,0.85); z-index:15; overflow-x:auto; white-space:nowrap;
            display:flex; justify-content:center; border-top:1px solid #333;
            box-shadow:0 -5px 15px rgba(0,255,0,0.1);
        }
        .category-chip {
            padding:8px 16px; margin:0 8px; background:#111; color:#666;
            font-size:10px; cursor:pointer; border:1px solid #444; transition:.2s;
            pointer-events:all; display:inline-block;
        }
        .category-chip:hover { border-color:#888; color:#888; }
        .category-chip.active {
            color:var(--neon-green); background:#002200;
            border-color:var(--neon-green); box-shadow:0 0 10px var(--neon-green);
        }
        .category-chip.help-btn { border-color:var(--neon-yellow); color:var(--neon-yellow); }
        
        /* OVERLAYS */
        .overlay-screen {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
        h1 {color:var(--neon-green);text-shadow:4px 4px #003300;font-size:35px;margin-bottom:20px;line-height:1.5;}
        h2 {color:var(--neon-red);font-size:30px;margin-bottom:20px;text-shadow:3px 3px 0 #300;}
        p {line-height:2;color:#aaa;font-size:12px;max-width:600px;padding:0 20px;}
        .key-hint {display:inline-block;padding:2px 6px;border:1px solid #666;border-radius:4px;color:#fff;background:#222;font-size:10px;}
        .blink {animation:blinker 1s linear infinite;color:var(--neon-yellow);margin-top:40px;font-size:14px;cursor:pointer;}
        @keyframes blinker {50%{opacity:0;}}
        
        /* QUIZ & STUDY UI */
        #quiz-overlay {
            background: rgba(0, 10, 0, 0.98); border: 4px solid var(--neon-red);
            padding: 20px; border-radius: 10px; max-width: 600px; width: 90%;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.2); display: flex; flex-direction: column; align-items: center;
        }
        #quiz-input {
            background: #000; border: 2px solid #333; color: #fff;
            padding: 15px; font-family: 'Press Start 2P'; font-size: 14px;
            text-align: center; width: 90%; text-transform: uppercase;
        }
        .correct-ans-highlight {color: #fff; background: var(--neon-red); padding: 5px 10px; display: inline-block; margin-top: 5px; border-radius: 4px;}
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, 2px); } 100% { transform: translate(1px, -2px); } }

        /* MODAL */
        #study-content {
            background:var(--panel-bg); padding:20px; border:2px solid var(--neon-green);
            width:90%; max-width:800px; height:80%; display: flex; flex-direction: column;
            position:relative; box-shadow:0 0 30px rgba(0,255,0,0.2); text-align:left;
        }
        .tabs-header { display: flex; border-bottom: 2px solid var(--neon-green); margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; cursor: pointer; text-align: center; font-size: 10px; background: transparent; border: none; color: #666; font-family: 'Press Start 2P'; transition: 0.2s; }
        .tab-btn.active { background: var(--neon-green); color: #000; font-weight: bold; }
        .tab-content { flex: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        
        table {width:100%;border-collapse:separate;border-spacing:0;font-size:10px;}
        th {color:var(--neon-green);text-align:left;border-bottom:2px solid var(--neon-green);padding:10px;position:sticky;top:0;background:#001500;z-index:2;}
        td {padding:12px 10px;border-bottom:1px solid #333;color:#aaa;}
        .en-word {color:var(--neon-blue);font-weight:bold;}
        .chk-cell { width: 40px; text-align: center; }
        
        /* Config Styles */
        .config-group { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .config-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 10px; color: #ddd; align-items: center;}
        .config-val { color: var(--neon-yellow); }
        input[type=range], select, input[type=color] { width: 100%; cursor: pointer; accent-color: var(--neon-green); margin-top:5px; }
        select { padding: 10px; background: #111; color: var(--neon-green); border: 1px solid var(--neon-green); font-family: 'Press Start 2P'; font-size: 10px; }
        .reset-btn { width: 100%; padding: 15px; background: #330000; color: var(--neon-red); border: 1px solid var(--neon-red); font-family: 'Press Start 2P'; cursor: pointer; margin-top: 20px; font-size: 10px; }
        .close-btn {position:absolute;top:15px;right:20px;font-size:20px;color:var(--neon-red);cursor:pointer;border:1px solid var(--neon-red);padding:5px 10px;z-index:10;background: transparent;}
        
        ::-webkit-scrollbar {width:10px;}
        ::-webkit-scrollbar-track {background:#111;}
        ::-webkit-scrollbar-thumb {background:#333;border:1px solid var(--neon-green);}
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="ui">
        <div id="score-panel">SCORE: <span id="score">0</span> | COMBO: <span id="combo">0</span></div>
        <div id="lives-panel">LIVES: <span id="lives">5</span></div>
        <div id="high-score-panel">HIGH: <span id="highScore">0</span></div>
    </div>
    
    <div id="mobile-controls">
        <div class="touch-group">
            <div class="touch-btn" id="btn-left">←</div>
            <div class="touch-btn" id="btn-right">→</div>
        </div>
        <div class="touch-group">
            <div class="touch-btn btn-fire" id="btn-fire">●</div>
        </div>
    </div>

    <div id="category-bar-wrapper"></div>

    <div id="start-screen" class="overlay-screen" onclick="startGame()">
        <h1>VERB HUNTER</h1>
        <p>
            1. <strong>CYAN ENEMIES:</strong> Regular Verbs (Easy).<br>
            2. <strong>PURPLE ENEMIES:</strong> Irregular Verbs (Bosses).<br>
            3. Kill <strong>BASE -> PAST -> PARTICIPLE</strong> to destroy.<br>
            4. Shoot 3 times to translate, then it dies.<br><br>
            <span class="key-hint">← →</span> Move &nbsp;&nbsp; <span class="key-hint">SPACE</span> Shoot
        </p>
        <div class="blink">CLICK / TAP TO START</div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;" onclick="startGame()">
        <h2>MISSION FAILED</h2>
        <p>FINAL SCORE: <span id="finalScore" style="color:white;">0</span></p>
        <div class="blink">CLICK TO RETRY</div>
    </div>

    <div id="quiz-screen" class="overlay-screen" style="display:none;">
        <div id="quiz-overlay">
            <h2 style="color:var(--neon-red);" id="quiz-title">SYSTEM HACK!</h2>
            <div id="quiz-question">WORD</div>
            <input type="text" id="quiz-input" placeholder="TRANSLATE" autocomplete="off">
            <div id="quiz-feedback"></div>
            <button class="reset-btn" onclick="checkQuizAnswer()">VERIFY</button>
        </div>
    </div>

    <div id="study-guide" class="overlay-screen" style="display:none;">
        <div id="study-content">
            <span class="close-btn" onclick="toggleStudyGuide()">X</span>
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('db')">DATABASE</button>
                <button class="tab-btn" onclick="switchTab('settings')">SETTINGS</button>
            </div>
            
            <div id="tab-db" class="tab-content active">
                <h2 id="db-title" class="config-header">VERB DATABASE</h2>
                <div id="study-table-container"></div>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2 class="config-header">SYSTEM CONFIG</h2>
                <div class="config-group">
                     <label class="config-label">MASTER VOLUME<span id="val-volume" class="config-val">50%</span></label>
                     <input type="range" id="cfg-volume" min="0" max="100" step="10" value="50" oninput="updateConfig('volume')">
                </div>
                <div class="config-group">
                    <label class="config-label">VOCABULARY SOURCE</label>
                    <select id="cfg-source" onchange="updateConfig('source')"></select>
                </div>
                <div class="config-group">
                    <label class="config-label">BOMB QUANTITY<span id="val-bomb" class="config-val">30%</span></label>
                    <input type="range" id="cfg-bomb" min="0" max="100" step="10" value="30" oninput="updateConfig('bomb')">
                </div>
                 <div class="config-group">
                    <label class="config-label">PLAYER COLOR</label>
                    <input type="color" id="cfg-color" value="#4f46e5" onchange="updateConfig('color')">
                </div>
                <button class="reset-btn" onclick="resetConfig()">RESET DEFAULTS</button>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/* =========================================
   1. INTERNAL DATA (EXPANDED FOR VERBS)
   ========================================= */
const INTERNAL_VOCAB = {
 'IRREGULAR_VERBS': [
    {en:"BE", past:"WAS/WERE", part:"BEEN", es:"SER/ESTAR", type:"IRREGULAR"},
    {en:"GO", past:"WENT", part:"GONE", es:"IR", type:"IRREGULAR"},
    {en:"DO", past:"DID", part:"DONE", es:"HACER", type:"IRREGULAR"},
    {en:"HAVE", past:"HAD", part:"HAD", es:"TENER", type:"IRREGULAR"},
    {en:"EAT", past:"ATE", part:"EATEN", es:"COMER", type:"IRREGULAR"},
    {en:"SEE", past:"SAW", part:"SEEN", es:"VER", type:"IRREGULAR"},
    {en:"TAKE", past:"TOOK", part:"TAKEN", es:"TOMAR", type:"IRREGULAR"},
    {en:"SPEAK", past:"SPOKE", part:"SPOKEN", es:"HABLAR", type:"IRREGULAR"}
 ],
 'REGULAR_VERBS': [
    {en:"WORK", past:"WORKED", part:"WORKED", es:"TRABAJAR", type:"REGULAR"},
    {en:"PLAY", past:"PLAYED", part:"PLAYED", es:"JUGAR", type:"REGULAR"},
    {en:"WALK", past:"WALKED", part:"WALKED", es:"CAMINAR", type:"REGULAR"},
    {en:"CALL", past:"CALLED", part:"CALLED", es:"LLAMAR", type:"REGULAR"},
    {en:"ASK", past:"ASKED", part:"ASKED", es:"PREGUNTAR", type:"REGULAR"}
 ],
  'NOUNS': [
    {en:"TIME", es:"TIEMPO"}, {en:"PERSON", es:"PERSONA"}, {en:"YEAR", es:"AÑO"}
 ]
};

/* =========================================
   2. CONFIGURATION
   ========================================= */
const CONFIG_KEY = 'vocab_hunter_boss_v1';
let userSettings = {
    vocabSource: 'IRREGULAR_VERBS', 
    dataPercent: 100, 
    spawnLevel: 1, enemySpeed: 0.5, bombChance: 30, bombSpeed: 1.0, playerColor: '#4f46e5',
    quizEnabled: false, quizInterval: 30,
    masterVolume: 50, audioFX: true, audioWords: true, audioBombs: true
};
let gameVars = { spawnInterval: 3500, bombProb: 0.005 };
let disabledWords = new Set(); 
let quizTimer = 0, currentQuizWord = null;

// UI FUNCTIONS
function renderCategoryBar() {
    const wrapper = document.getElementById('category-bar-wrapper');
    wrapper.innerHTML = '';
    const opts = Object.keys(INTERNAL_VOCAB).map(key => ({val: key, txt: key}));
    opts.forEach(o => {
        const chip = document.createElement('div');
        chip.className = 'category-chip' + (userSettings.vocabSource === o.val ? ' active' : '');
        chip.textContent = o.txt;
        chip.onclick = () => { document.getElementById('cfg-source').value = o.val; updateConfig('source'); };
        wrapper.appendChild(chip);
    });
    const help = document.createElement('div'); help.className = 'category-chip help-btn'; help.textContent = 'CONFIG'; help.onclick = toggleStudyGuide; wrapper.appendChild(help);
}

function populateSourceMenu() {
    const select = document.getElementById('cfg-source'); select.innerHTML = '';
    Object.keys(INTERNAL_VOCAB).forEach(key => {
        const op = document.createElement('option'); op.value = key; op.textContent = key; select.appendChild(op);
    });
}

function loadConfig() {
    populateSourceMenu();
    const saved = localStorage.getItem(CONFIG_KEY);
    if(saved) try { userSettings = { ...userSettings, ...JSON.parse(saved) }; } catch(e){}
    applyConfigToUI(); recalcGameVars();
}

function applyConfigToUI() {
    document.getElementById('cfg-source').value = userSettings.vocabSource;
    document.getElementById('cfg-volume').value = userSettings.masterVolume;
    document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
    document.getElementById('cfg-bomb').value = userSettings.bombChance;
    document.getElementById('val-bomb').textContent = userSettings.bombChance + "%";
    document.getElementById('cfg-color').value = userSettings.playerColor;
    player.color = userSettings.playerColor;
}

function recalcGameVars() {
    gameVars.spawnInterval = 5500 - (userSettings.spawnLevel * 500); 
    gameVars.bombProb = userSettings.bombChance / 2000; 
}

function updateConfig(key) {
    if(key === 'source') {
        userSettings.vocabSource = document.getElementById('cfg-source').value;
        loadVocabData(); renderCategoryBar(); if(gameRunning) enemies = []; 
    }
    else if(key === 'volume') {
        userSettings.masterVolume = parseInt(document.getElementById('cfg-volume').value);
        document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
        playSound('shoot'); 
    }
    else if(key === 'bomb') userSettings.bombChance = parseInt(document.getElementById('cfg-bomb').value);
    else if(key === 'color') { userSettings.playerColor = document.getElementById('cfg-color').value; player.color = userSettings.playerColor; }
    
    recalcGameVars();
    localStorage.setItem(CONFIG_KEY, JSON.stringify(userSettings));
}

function resetConfig() {
    localStorage.removeItem(CONFIG_KEY);
    userSettings = { vocabSource: 'IRREGULAR_VERBS', dataPercent: 100, spawnLevel: 1, enemySpeed: 0.5, bombChance: 30, bombSpeed: 1.0, playerColor: '#4f46e5', quizEnabled: false, quizInterval: 30, masterVolume: 50, audioFX:true, audioWords:true, audioBombs:true };
    loadConfig(); loadVocabData(); renderCategoryBar();
}

// DATA LOADING
let activeVocabList = [], gameDeck = [];        
function loadVocabData() {
    activeVocabList = INTERNAL_VOCAB[userSettings.vocabSource] || [];
    refreshGameDeck();
}
function refreshGameDeck() {
    gameDeck = activeVocabList.filter(item => !disabledWords.has(item.en));
    if(gameDeck.length === 0) gameDeck.push({en: "NO DATA", es: "VACIO"});
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    if(tabName === 'db') document.querySelector('button[onclick="switchTab(\'db\')"]').classList.add('active');
    else document.querySelector('button[onclick="switchTab(\'settings\')"]').classList.add('active');
}

function populateStudyGuide(){
    document.getElementById('db-title').innerText = userSettings.vocabSource;
    let html='<table><thead><tr><th>BASE</th><th>PAST</th><th>PART</th><th>ES</th></tr></thead><tbody>';
    activeVocabList.forEach(v => {
        html += `<tr>
            <td class="en-word">${v.en}</td>
            <td>${v.past || "-"}</td>
            <td>${v.part || "-"}</td>
            <td>${v.es}</td>
        </tr>`;
    });
    html+='</tbody></table>';
    document.getElementById('study-table-container').innerHTML=html;
}

function toggleStudyGuide(){
    const guide = document.getElementById('study-guide');
    if(guide.style.display==='flex'){
        guide.style.display='none';
        if(document.getElementById('start-screen').style.display==='none'){
            gameRunning=true; lastFrameTime=performance.now(); gameLoopId = requestAnimationFrame(loop);
        }
    }else{
        gameRunning=false; cancelAnimationFrame(gameLoopId);
        populateStudyGuide(); guide.style.display='flex';
    }
}

// AUDIO
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let audioQueue = [], isSpeaking = false, availableVoices = [];

function loadVoices() { availableVoices = window.speechSynthesis.getVoices(); }
if (window.speechSynthesis) { window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices(); }

setInterval(() => {
    if (!isSpeaking && audioQueue.length > 0) {
        const next = audioQueue.shift(); playText(next.text, next.lang);
    }
}, 100);

function speak(text, lang) {
    if (!userSettings.audioWords) return;
    audioQueue.push({text, lang});
}

function getBestVoice(lang) {
    if (availableVoices.length === 0) loadVoices();
    const baseLang = lang.split('-')[0];
    const candidates = availableVoices.filter(v => v.lang.startsWith(baseLang));
    if (candidates.length === 0) return null;
    // Prefer Enhanced/Premium
    candidates.sort((a, b) => {
        let scoreA = (a.name.includes("Premium") || a.name.includes("Enhanced") || a.name.includes("Google")) ? 10 : 0;
        let scoreB = (b.name.includes("Premium") || b.name.includes("Enhanced") || b.name.includes("Google")) ? 10 : 0;
        return scoreB - scoreA;
    });
    return candidates[0];
}

function playText(text, lang) {
    if (!window.speechSynthesis) return;
    isSpeaking = true; window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text.toLowerCase());
    u.lang = lang; u.rate = 1.1;
    const v = getBestVoice(lang); if(v) u.voice = v;
    u.onend = () => { setTimeout(() => isSpeaking = false, 200); };
    window.speechSynthesis.speak(u);
}

function playSound(type) {
    if (!userSettings.audioFX || userSettings.masterVolume <= 0) return;
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    const vol = userSettings.masterVolume / 100;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const n = audioCtx.currentTime;
    
    if(type==='shoot'){
        o.type='square'; o.frequency.setValueAtTime(400,n); o.frequency.exponentialRampToValueAtTime(100,n+.1);
        g.gain.setValueAtTime(0.1*vol, n); g.gain.linearRampToValueAtTime(0,n+.1);
    } else if(type==='hit'){
        o.type='sawtooth'; o.frequency.setValueAtTime(600,n); o.frequency.linearRampToValueAtTime(800,n+.1);
        g.gain.setValueAtTime(0.1*vol, n); g.gain.linearRampToValueAtTime(0,n+.1);
    } else if(type==='kill'){
        o.type='sine'; o.frequency.setValueAtTime(1200,n); o.frequency.linearRampToValueAtTime(1800,n+.1);
        g.gain.setValueAtTime(0.1*vol, n); g.gain.linearRampToValueAtTime(0,n+.3);
    } else if(type==='boss_stage'){
        o.type='triangle'; o.frequency.setValueAtTime(200,n); o.frequency.linearRampToValueAtTime(600,n+.2);
        g.gain.setValueAtTime(0.2*vol, n); g.gain.linearRampToValueAtTime(0,n+.2);
    }
    o.start(n); o.stop(n + 0.5);
}

// GAME ENGINE
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let gameLoopId, lastFrameTime = 0, spawnTimer = 0;
const player = {x:0, y:0, w:48, h:48, speed:8, color:'#4f46e5', invincible:false, invTimer:0};
let bullets=[], enemies=[], particles=[], stars=[], keys={};
let score=0, lives=5;

function resize(){
    canvas.width=innerWidth; canvas.height=innerHeight;
    player.y=canvas.height-130; player.x=canvas.width/2-player.w/2;
}
window.addEventListener('resize',resize);

for(let i=0;i<80;i++) stars.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,size:Math.random()*2,speed:Math.random()*0.2+0.1});

function spawnEnemy(){
    if(gameDeck.length===0) return;
    const d = gameDeck[Math.floor(Math.random()*gameDeck.length)];
    
    // Determine Type
    const isVerb = !!d.past; // Has verb data
    const type = d.type || "NOUN";
    
    // Config based on type
    let enemyColor = '#ffffff';
    let fallSpeed = (Math.random()*0.8+0.4) * userSettings.enemySpeed;
    
    if(type === 'REGULAR') { enemyColor = 'var(--neon-cyan)'; }
    else if(type === 'IRREGULAR') { enemyColor = 'var(--neon-purple)'; fallSpeed *= 0.6; } // Slower
    
    // Text Width calculation (Use Base form as primary width, or max of all 3)
    ctx.font='16px "Press Start 2P"';
    let w = ctx.measureText(d.en).width;
    if(isVerb) w = Math.max(w, ctx.measureText(d.past).width, ctx.measureText(d.part).width);

    // ANTI-OVERLAP SYSTEM
    let xPos = Math.random()*(canvas.width-w-50)+w/2+25;
    let attempts = 0;
    while(attempts < 10) {
        let clean = true;
        for(let e of enemies) {
            if(e.y < 100 && Math.abs(e.x - xPos) < (e.w + w + 20)) { clean = false; break; }
        }
        if(clean) break;
        xPos = Math.random()*(canvas.width-w-50)+w/2+25;
        attempts++;
    }

    // Verb Object Structure
    enemies.push({
        x: xPos, y: -100, // Start higher for stack
        wordData: d, 
        isVerb: isVerb,
        forms: isVerb ? [d.en, d.past, d.part] : [d.en],
        currentFormIdx: 0, // 0=Base, 1=Past, 2=Part
        hits: 0,
        color: enemyColor,
        speed: fallSpeed,
        vx: (Math.random() - 0.5) * 1.5,
        w: w, h: isVerb ? 70 : 30, // Taller if verb
        fading: false
    });
}

function createExplosion(x,y,c,n=10){
    for(let i=0;i<n;i++) particles.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,life:1,color:c});
}

function loop(timestamp) {
    if (!gameRunning) return;
    gameLoopId = requestAnimationFrame(loop);
    const elapsed = timestamp - lastFrameTime;
    if (elapsed < 33) return; // 30 FPS Cap
    lastFrameTime = timestamp - (elapsed % 33);
    update();
    draw(timestamp);
}

function update(){
    const timeScale = 2.0; // Fixed for 30fps

    if(keys['ArrowLeft']&&player.x>0)player.x -= player.speed * timeScale;
    if(keys['ArrowRight']&&player.x<canvas.width-player.w)player.x += player.speed * timeScale;
    
    stars.forEach(s=>{ s.y += s.speed * timeScale; if(s.y>canvas.height)s.y=0; });
    
    spawnTimer-=16.6*timeScale; 
    if(spawnTimer<0){spawnEnemy(); spawnTimer=gameVars.spawnInterval;}

    // Bullets
    for(let i=bullets.length-1;i>=0;i--){
        bullets[i].y -= 12 * timeScale;
        if(bullets[i].y<0)bullets.splice(i,1);
    }
    
    // Enemies
    for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        if(e.fading){
             createExplosion(e.x,e.y,e.color,2); enemies.splice(i,1); continue;
        }

        e.y += e.speed * timeScale; 
        e.x += e.vx * timeScale;
        if(e.x < e.w/2 || e.x > canvas.width-e.w/2) e.vx *= -1;

        // Collision Player
        if(e.y > player.y - 20 && Math.abs(e.x - (player.x+player.w/2)) < e.w/2 + 20) {
             if(!player.invincible) {
                 lives--; document.getElementById('lives').innerText=lives;
                 player.invincible=true; player.invTimer=2000;
                 playSound('boss_stage'); // Hurt sound
                 enemies.splice(i,1);
                 if(lives<=0) gameOver();
                 continue;
             }
        }

        // Hit Detection
        for(let j=bullets.length-1;j>=0;j--){
            const b=bullets[j];
            // Hitbox adjustment for verb stack
            let hitYTop = e.y - (e.isVerb ? 20 : 20);
            let hitYBot = e.y + (e.isVerb ? 60 : 10);
            
            if(b.x > e.x - e.w/2 - 10 && b.x < e.x + e.w/2 + 10 && b.y > hitYTop && b.y < hitYBot){
                bullets.splice(j,1);
                
                e.hits++;
                createExplosion(b.x, b.y, e.color, 5);
                playSound('hit');

                // Logic for "Phase" Killing
                // 3 Hits per word
                if(e.hits >= 3) {
                    // Current form destroyed
                    e.hits = 0;
                    
                    if(e.isVerb) {
                        // Speak current form
                        let wordJustDied = e.forms[e.currentFormIdx];
                        speak(wordJustDied, 'en-US');

                        // Advance Form
                        e.currentFormIdx++;
                        if(e.currentFormIdx >= 3) {
                             // All forms dead -> Translate & Die
                             speak(e.wordData.es, 'es-ES');
                             score += 300;
                             e.fading = true;
                             playSound('kill');
                        } else {
                            // Next Stage Audio cue
                             playSound('boss_stage');
                             score += 50;
                        }
                    } else {
                        // Normal noun
                        speak(e.forms[0], 'en-US');
                        setTimeout(()=>speak(e.wordData.es, 'es-ES'), 600);
                        score += 50;
                        e.fading = true;
                        playSound('kill');
                    }
                }
                document.getElementById('score').innerText=score;
                break;
            }
        }
        if(e.y>canvas.height) enemies.splice(i,1);
    }
    
    // Particles
    for(let i=particles.length-1;i>=0;i--){
        const p=particles[i]; p.x+=p.vx*timeScale; p.y+=p.vy*timeScale; p.life-=0.05;
        if(p.life<=0)particles.splice(i,1);
    }
    
    if(player.invincible){player.invTimer-=16*timeScale; if(player.invTimer<=0)player.invincible=false;}
}

function draw(timestamp){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Stars
    stars.forEach(s=>{
        ctx.fillStyle=`rgba(255,255,255,${Math.random()*0.5})`;
        ctx.beginPath();ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fill();
    });
    
    // Player
    if(!player.invincible||(Math.floor(Date.now()/100)%2===0)){
        ctx.fillStyle = player.color; ctx.fillRect(player.x+8, player.y+15, player.w-16, player.h-20);
        ctx.fillStyle = '#ccc'; ctx.fillRect(player.x+4, player.y, player.w-8, 20);
        ctx.fillStyle = '#0f0'; ctx.fillRect(player.x+10, player.y+5, 8, 8); ctx.fillRect(player.x+player.w-18, player.y+5, 8, 8);
    }

    // Bullets
    ctx.fillStyle='#ff0055';
    bullets.forEach(b=>ctx.fillRect(b.x-2,b.y,4,15));
    
    // Enemies
    enemies.forEach(e=>{
        ctx.textAlign='center'; 
        ctx.font='16px "Press Start 2P"';
        
        if(!e.isVerb) {
            // Normal Draw
            ctx.fillStyle = e.color;
            ctx.fillText(e.forms[0], e.x, e.y);
            // Hits dots
            for(let k=0; k<3; k++) {
                ctx.fillStyle = k < e.hits ? '#0f0' : '#444';
                ctx.beginPath(); ctx.arc(e.x-15+(k*15), e.y+15, 3,0,Math.PI*2); ctx.fill();
            }
        } else {
            // VERB BOSS DRAW (STACK)
            // Draw from Bottom (Base) to Top (Participle) visually, 
            // but logic usually puts base at bottom y-coord? No, let's stack downwards.
            // Let's draw: Top: Participle, Mid: Past, Bot: Base. 
            // Actually, game logic says kill base first. Let's put Base at the BOTTOM (closest to player).
            
            // Draw Participle (Top)
            let yPart = e.y;
            let yPast = e.y + 25;
            let yBase = e.y + 50;

            // Determine colors based on stage
            let cBase = e.currentFormIdx === 0 ? e.color : (e.currentFormIdx > 0 ? '#555' : '#222'); // Active, Dead, or Future
            let cPast = e.currentFormIdx === 1 ? e.color : (e.currentFormIdx > 1 ? '#555' : (e.currentFormIdx < 1 ? '#444' : '#222'));
            let cPart = e.currentFormIdx === 2 ? e.color : (e.currentFormIdx < 2 ? '#444' : '#555');

            ctx.font='12px "Press Start 2P"';
            
            // Draw Words
            ctx.fillStyle = cPart; ctx.fillText(e.forms[2], e.x, yPart); // Top
            ctx.fillStyle = cPast; ctx.fillText(e.forms[1], e.x, yPast); // Mid
            ctx.fillStyle = cBase; ctx.fillText(e.forms[0], e.x, yBase); // Bot (Target)

            // Draw HP Dots for CURRENT Stage
            let yDots = 0;
            if(e.currentFormIdx === 0) yDots = yBase + 15;
            else if(e.currentFormIdx === 1) yDots = yPast + 15;
            else yDots = yPart + 15;

            for(let k=0; k<3; k++) {
                ctx.fillStyle = k < e.hits ? '#0f0' : '#444';
                ctx.beginPath(); ctx.arc(e.x-15+(k*15), yDots, 3,0,Math.PI*2); ctx.fill();
            }
        }
    });
    
    // Particles
    particles.forEach(p=>{
        ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,3,3);
    });
    ctx.globalAlpha=1;
}

// INPUT
const btnLeft = document.getElementById('btn-left');
const btnRight = document.getElementById('btn-right');
const btnFire = document.getElementById('btn-fire');
const handleTS = (k) => { keys[k]=true; if(k==='Space'&&gameRunning) {bullets.push({x:player.x+player.w/2,y:player.y}); playSound('shoot');}};
const handleTE = (k) => { keys[k]=false; };
[btnLeft,btnRight,btnFire].forEach(b=>{
    b.addEventListener('touchstart',(e)=>{e.preventDefault(); handleTS(b.id==='btn-left'?'ArrowLeft':b.id==='btn-right'?'ArrowRight':'Space')});
    b.addEventListener('touchend',(e)=>{e.preventDefault(); handleTE(b.id==='btn-left'?'ArrowLeft':b.id==='btn-right'?'ArrowRight':'Space')});
    b.addEventListener('mousedown',(e)=>{e.preventDefault(); handleTS(b.id==='btn-left'?'ArrowLeft':b.id==='btn-right'?'ArrowRight':'Space')});
    b.addEventListener('mouseup',(e)=>{e.preventDefault(); handleTE(b.id==='btn-left'?'ArrowLeft':b.id==='btn-right'?'ArrowRight':'Space')});
});

document.addEventListener('keydown', e=>{keys[e.code]=true; if(e.code==='Space'&&gameRunning){bullets.push({x:player.x+player.w/2,y:player.y}); playSound('shoot');}});
document.addEventListener('keyup', e=>keys[e.code]=false);

function gameOver(){ gameRunning=false; document.getElementById('finalScore').innerText=score; document.getElementById('game-over-screen').style.display='flex'; }
function startGame(){ 
    if(window.speechSynthesis) window.speechSynthesis.cancel();
    resize(); document.getElementById('start-screen').style.display='none'; document.getElementById('game-over-screen').style.display='none';
    score=0; lives=5; enemies=[]; bullets=[]; particles=[]; keys={};
    document.getElementById('lives').innerText='5';
    gameRunning=true; lastFrameTime=performance.now(); spawnTimer=0;
    gameLoopId=requestAnimationFrame(loop);
}

window.onload=()=>{ loadConfig(); loadVocabData(); resize(); renderCategoryBar(); };
</script>
</body>
</html>
