<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vocabulary Hunter: Optimized</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #0f0;
            --neon-red: #ff4444;
            --neon-blue: #4f46e5;
            --neon-yellow: #ffff00;
            --dark-bg: #050505;
            --panel-bg: rgba(0, 15, 0, 0.95);
        }
        body {margin:0;overflow:hidden;background:var(--dark-bg);font-family:'Press Start 2P',monospace;color:white;user-select:none;}
        canvas {display:block;}
        /* SCANLINES: Reducido la opacidad para menos carga de composición */
        .scanlines {position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,255,255,0) 50%,rgba(0,0,0,0.05) 50%,rgba(0,0,0,0.05));background-size:100% 4px;z-index:999;pointer-events:none;}
        
        #ui {position:absolute;top:20px;left:20px;right:20px;z-index:10;pointer-events:none;display:flex;justify-content:space-between;text-shadow:2px 2px 0 #000;}
        #lives-panel {color:var(--neon-red);}
        #score-panel {color:var(--neon-green);}
        
        /* BARRA INFERIOR */
        #category-bar-wrapper {
            position:absolute; bottom:30px; left:0; width:100%; padding:10px 0;
            background:rgba(0,0,0,0.85); z-index:15; overflow-x:auto; white-space:nowrap;
            display:flex; justify-content:center; border-top:1px solid #333;
            box-shadow:0 -5px 15px rgba(0,255,0,0.1);
        }
        .category-chip {
            padding:8px 16px; margin:0 8px; background:#111; color:#666;
            font-size:10px; cursor:pointer; border:1px solid #444; transition:.2s;
            pointer-events:all; display:inline-block;
        }
        .category-chip:hover { border-color:#888; color:#888; }
        .category-chip.active {
            color:var(--neon-green); background:#002200;
            border-color:var(--neon-green); box-shadow:0 0 10px var(--neon-green);
        }
        .category-chip.help-btn { border-color:var(--neon-yellow); color:var(--neon-yellow); }
        .category-chip.help-btn:hover { background:#222200; box-shadow:0 0 10px var(--neon-yellow); }
        
        /* OVERLAYS */
        .overlay-screen {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
        h1 {color:var(--neon-green);text-shadow:4px 4px #003300;font-size:35px;margin-bottom:20px;line-height:1.5;}
        h2 {color:var(--neon-red);font-size:30px;margin-bottom:20px;text-shadow:3px 3px 0 #300;}
        p {line-height:2;color:#aaa;font-size:12px;max-width:600px;padding:0 20px;}
        .key-hint {display:inline-block;padding:2px 6px;border:1px solid #666;border-radius:4px;color:#fff;background:#222;font-size:10px;}
        .blink {animation:blinker 1s linear infinite;color:var(--neon-yellow);margin-top:40px;font-size:14px;cursor:pointer;}
        @keyframes blinker {50%{opacity:0;}}
        
        /* POP QUIZ MODAL */
        #quiz-overlay {
            background: rgba(0, 10, 0, 0.98); border: 4px solid var(--neon-red);
            padding: 40px; border-radius: 10px; max-width: 600px; width: 80%;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.2);
            transition: border-color 0.3s;
            display: flex; flex-direction: column; align-items: center;
        }
        #quiz-question { font-size: 20px; color: var(--neon-blue); margin: 20px 0; line-height: 1.5; }
        #quiz-input {
            background: #000; border: 2px solid #333; color: #fff;
            padding: 15px; font-family: 'Press Start 2P'; font-size: 16px;
            text-align: center; width: 90%; text-transform: uppercase;
        }
        #quiz-input:focus { border-color: var(--neon-green); outline: none; }
        
        #quiz-feedback { 
            margin-top: 20px; min-height: 30px; font-size: 10px; 
            color: var(--neon-yellow); line-height: 1.6; text-align: center;
        }
        .correct-ans-highlight {
            color: #fff; background: var(--neon-red); padding: 5px 10px; display: inline-block; margin-top: 5px; border-radius: 4px;
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .quiz-actions { display: flex; gap: 10px; margin-top: 15px; width: 100%; justify-content: center; }
        .quiz-btn {
            padding: 15px; font-family: 'Press Start 2P'; cursor: pointer; font-size: 10px; border: 2px solid;
            background: transparent; color: #fff; flex: 1;
        }
        .btn-verify { border-color: var(--neon-green); color: var(--neon-green); }
        .btn-verify:hover { background: var(--neon-green); color: #000; }
        .btn-skip { border-color: #555; color: #777; font-size: 8px; }
        .btn-skip:hover { border-color: var(--neon-red); color: var(--neon-red); }

        /* MODAL */
        #study-content {
            background:var(--panel-bg); padding:30px; border:2px solid var(--neon-green);
            width:80%; max-width:800px; height:70%; display: flex; flex-direction: column;
            position:relative; box-shadow:0 0 30px rgba(0,255,0,0.2); text-align:left;
        }
        .tabs-header { display: flex; border-bottom: 2px solid var(--neon-green); margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 10px; cursor: pointer; text-align: center; font-size: 12px;
            background: transparent; border: none; color: #666; font-family: 'Press Start 2P'; transition: 0.2s;
        }
        .tab-btn:hover { background: #002200; color: #fff; }
        .tab-btn.active { background: var(--neon-green); color: #000; font-weight: bold; }
        .tab-content { flex: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        
        table {width:100%;border-collapse:separate;border-spacing:0;font-size:12px;}
        th {color:var(--neon-green);text-align:left;border-bottom:2px solid var(--neon-green);padding:10px;position:sticky;top:0;background:#001500;z-index:2;}
        td {padding:12px 10px;border-bottom:1px solid #333;color:#aaa;}
        tr:hover td {background:#002200;color:#fff;cursor:crosshair;}
        .en-word {color:var(--neon-blue);font-weight:bold;}
        .chk-cell { width: 40px; text-align: center; }
        input[type=checkbox] { width: 18px; height: 18px; accent-color: var(--neon-green); cursor: pointer; }

        .config-header { color:var(--neon-green); margin-top:0; text-transform:uppercase; border-bottom:1px solid #333; padding-bottom:10px; font-size:18px; margin-bottom: 20px; }
        .config-group { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .config-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #ddd; }
        .config-val { color: var(--neon-yellow); }
        .slider-desc { font-size: 8px; color: #666; margin-top: 5px; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--neon-green); }
        input[type=color] { cursor: pointer; border: none; width: 50px; height: 30px; }
        select { width: 100%; padding: 10px; background: #111; color: var(--neon-green); border: 1px solid var(--neon-green); font-family: 'Press Start 2P'; font-size: 10px; cursor: pointer; margin-top: 5px; }
        select:focus { outline: none; background: #222; }
        .reset-btn { width: 100%; padding: 15px; background: #330000; color: var(--neon-red); border: 1px solid var(--neon-red); font-family: 'Press Start 2P'; cursor: pointer; margin-top: 20px; font-size: 10px; }
        .reset-btn:hover { background: var(--neon-red); color: #000; }
        .close-btn {position:absolute;top:15px;right:20px;font-size:20px;color:var(--neon-red);cursor:pointer;border:1px solid var(--neon-red);padding:5px 10px;z-index:10;background: transparent; border-radius: 0; width: auto; height: auto;}
        .close-btn:hover {background:var(--neon-red);color:#000;}
        
        ::-webkit-scrollbar {width:10px;}
        ::-webkit-scrollbar-track {background:#111;}
        ::-webkit-scrollbar-thumb {background:#333;border:1px solid var(--neon-green);}
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="ui">
        <div id="score-panel">SCORE: <span id="score">0</span> | COMBO: <span id="combo">0</span></div>
        <div id="lives-panel">LIVES: <span id="lives">5</span></div>
        <div id="high-score-panel">HIGH: <span id="highScore">0</span></div>
    </div>
    
    <div id="category-bar-wrapper"></div>

    <div id="start-screen" class="overlay-screen" onclick="startGame()">
        <h1>VOCAB ROBOT</h1>
        <p>
            1. Enemies drop English words & <strong>Bombs</strong>.<br>
            2. Shoot 3 times to Translate -> 1 time to Destroy.<br>
            3. Shoot Parachutes to hear them.<br><br>
            <span class="key-hint">← →</span> Move &nbsp;&nbsp; <span class="key-hint">SPACE</span> Shoot &nbsp;&nbsp; <span class="key-hint">TAB</span> Menu
        </p>
        <div class="blink">CLICK TO START</div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;" onclick="startGame()">
        <h2>MISSION FAILED</h2>
        <p>FINAL SCORE: <span id="finalScore" style="color:white;">0</span></p>
        <div class="blink">CLICK TO RETRY</div>
    </div>

    <div id="quiz-screen" class="overlay-screen" style="display:none;">
        <div id="quiz-overlay">
            <h2 style="color:var(--neon-red);" id="quiz-title">SYSTEM HACK DETECTED!</h2>
            <p style="font-size:10px; color:#aaa;">TRANSLATE TO RESTORE SYSTEMS</p>
            <div id="quiz-question">WORD</div>
            <input type="text" id="quiz-input" placeholder="TYPE TRANSLATION" autocomplete="off">
            <div id="quiz-feedback"></div>
            
            <div class="quiz-actions">
                <button class="quiz-btn btn-skip" onclick="skipQuiz()">FORCE REBOOT (-500 PTS)</button>
                <button class="quiz-btn btn-verify" onclick="checkQuizAnswer()">VERIFY REPAIR</button>
            </div>
        </div>
    </div>

    <div id="study-guide" class="overlay-screen" style="display:none;">
        <div id="study-content">
            <span class="close-btn" onclick="toggleStudyGuide()">X</span>
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('db')">DATABASE</button>
                <button class="tab-btn" onclick="switchTab('settings')">SETTINGS</button>
            </div>
            
            <div id="tab-db" class="tab-content active">
                <h2 id="db-title" class="config-header">ACTIVE VOCABULARY</h2>
                
                <div class="config-group" style="margin-bottom: 10px;">
                    <label class="config-label">DATA USAGE LIMIT<span id="lbl-percent" class="config-val">100%</span></label>
                    <input type="range" id="mini-slider-percent" min="1" max="100" value="100" oninput="updateDataPercent(this.value)">
                    <div class="slider-desc"><span>START</span><span>ALL DATA</span></div>
                </div>

                <div class="config-group" style="border-top: 1px dashed #333; padding-top: 10px;">
                    <label class="config-label" style="justify-content: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="chk-quiz" onchange="updateConfig('quiz')">
                        ENABLE POP QUIZ TIMER
                    </label>
                    <label class="config-label" style="margin-top:5px;">FREQUENCY<span id="val-quiz-time" class="config-val">30s</span></label>
                    <input type="range" id="cfg-quiz-time" min="10" max="60" step="5" value="30" oninput="updateConfig('quiz')">
                    <div class="slider-desc"><span>OFTEN</span><span>RARE</span></div>
                </div>

                <div id="study-table-container"></div>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2 class="config-header">SYSTEM CONFIG</h2>
                
                <div class="config-group">
                    <label class="config-label">MASTER VOLUME<span id="val-volume" class="config-val">50%</span></label>
                    <input type="range" id="cfg-volume" min="0" max="100" step="10" value="50" oninput="updateConfig('volume')">
                    <div class="slider-desc"><span>MUTE</span><span>LOUD</span></div>
                </div>

                <div class="config-group">
                    <label class="config-label">VOCABULARY SOURCE</label>
                    <select id="cfg-source" onchange="updateConfig('source')"></select>
                </div>
                <div class="config-group">
                    <label class="config-label">ENEMY FREQUENCY<span id="val-spawn" class="config-val">5</span></label>
                    <input type="range" id="cfg-spawn" min="1" max="10" step="1" value="5" oninput="updateConfig('spawn')">
                    <div class="slider-desc"><span>FEW</span><span>MANY</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">ENEMY SPEED<span id="val-speed" class="config-val">1.0x</span></label>
                    <input type="range" id="cfg-speed" min="0.5" max="3.0" step="0.1" value="1.0" oninput="updateConfig('speed')">
                    <div class="slider-desc"><span>SLOW</span><span>FAST</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">BOMB QUANTITY<span id="val-bomb" class="config-val">30%</span></label>
                    <input type="range" id="cfg-bomb" min="0" max="100" step="10" value="30" oninput="updateConfig('bomb')">
                    <div class="slider-desc"><span>NONE</span><span>RAIN</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">BOMB FALL SPEED<span id="val-bspeed" class="config-val">2.0</span></label>
                    <input type="range" id="cfg-bspeed" min="1.0" max="5.0" step="0.1" value="2.0" oninput="updateConfig('bspeed')">
                    <div class="slider-desc"><span>FLOAT</span><span>DROP</span></div>
                </div>
                <div class="config-group">
                    <label class="config-label">PLAYER COLOR</label>
                    <input type="color" id="cfg-color" value="#4f46e5" onchange="updateConfig('color')">
                </div>
                <button class="reset-btn" onclick="resetConfig()">RESET DEFAULTS</button>
            </div>
            <p style="margin-top:20px;text-align:center;color:#666;font-size:10px;">
                GAME PAUSED. PRESS <span class="key-hint">TAB</span> TO RESUME.
            </p>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/* =========================================
   1. INTERNAL DATA
   ========================================= */
const INTERNAL_VOCAB = {
 'VERBS': [
    {en:"BE", es:"SER/ESTAR"}, {en:"HAVE", es:"TENER"}, {en:"DO", es:"HACER"}, {en:"SAY", es:"DECIR"},
    {en:"UNLOCK", es:"DESBLOQUEAR"}, {en:"SIGN", es:"FIRMAR"}, {en:"CANCEL", es:"CANCELAR"}, {en:"CONFIRM", es:"CONFIRMAR"}
],
  'NOUNS': [
    {en:"TIME", es:"TIEMPO"}, {en:"PERSON", es:"PERSONA"}, {en:"YEAR", es:"AÑO"}, {en:"WAY", es:"CAMINO/MANERA"},
    {en:"SYSTEM", es:"SISTEMA"}, {en:"NETWORK", es:"RED"}, {en:"WEBSITE", es:"SITIO WEB"}, {en:"APP", es:"APLICACIÓN"}
],
'ADJECTIVES': [
    {en:"GOOD", es:"BUENO"}, {en:"NEW", es:"NUEVO"}, {en:"FIRST", es:"PRIMERO"}, {en:"LAST", es:"ÚLTIMO"},
    {en:"CHALLENGING", es:"DESAFIANTE"}, {en:"ENJOYABLE", es:"AGRADABLE"}, {en:"MEMORABLE", es:"MEMORABLE"}
],
 'FUNCTION WORDS': [
    {en:"THE", es:"EL/LA/LOS/LAS"}, {en:"OF", es:"DE"}, {en:"AND", es:"Y"}, {en:"A", es:"UN/UNA"},
    {en:"ALTHOUGH", es:"AUNQUE"}, {en:"WHEREUPON", es:"DESPUÉS DE LO CUAL"}
]
};

/* =========================================
   2. CONFIGURATION & STATE
   ========================================= */
const CONFIG_KEY = 'vocab_robot_config_v10';
const DISABLED_WORDS_KEY = 'vocab_robot_disabled_v1';

let userSettings = {
    vocabSource: 'LOCAL', 
    dataPercent: 100, 
    spawnLevel: 5, enemySpeed: 1.0, bombChance: 30, bombSpeed: 2.0, playerColor: '#4f46e5',
    quizEnabled: false, quizInterval: 30,
    masterVolume: 50
};
let gameVars = { spawnInterval: 3500, bombProb: 0.005 };
let disabledWords = new Set(); 

// Variables para el Quiz
let quizTimer = 0;
let currentQuizWord = null;

// --- MENUS & UI ---
function renderCategoryBar() {
    const wrapper = document.getElementById('category-bar-wrapper');
    wrapper.innerHTML = '';
    const opts = [{val: 'LOCAL', txt: 'MY DB'}, {val: 'MIXED', txt: 'MIXED'}, {val: 'ALL_INTERNAL', txt: 'ALL INTERNAL'}];
    Object.keys(INTERNAL_VOCAB).forEach(key => opts.push({val: key, txt: key}));

    opts.forEach(o => {
        const chip = document.createElement('div');
        chip.className = 'category-chip' + (userSettings.vocabSource === o.val ? ' active' : '');
        chip.textContent = o.txt;
        chip.onclick = () => {
            document.getElementById('cfg-source').value = o.val;
            updateConfig('source');
        };
        wrapper.appendChild(chip);
    });

    const help = document.createElement('div');
    help.className = 'category-chip help-btn';
    help.textContent = 'CONFIG / HELP';
    help.onclick = toggleStudyGuide;
    wrapper.appendChild(help);
}

function updateDataPercent(val) {
    userSettings.dataPercent = parseInt(val);
    document.getElementById('lbl-percent').textContent = userSettings.dataPercent + '%';
    updateConfig('percent_only');
}

function populateSourceMenu() {
    const select = document.getElementById('cfg-source');
    select.innerHTML = '';
    const opts = [
        {val: 'LOCAL', txt: 'MY DATABASE (Custom)'},
        {val: 'ALL_INTERNAL', txt: 'INTERNAL: ALL MIXED'},
        {val: 'MIXED', txt: 'EVERYTHING (Local + Internal)'}
    ];
    Object.keys(INTERNAL_VOCAB).forEach(key => opts.push({val: key, txt: `INTERNAL: ${key}`}));
    opts.forEach(o => {
        const op = document.createElement('option');
        op.value = o.val; op.textContent = o.txt;
        select.appendChild(op);
    });
}

function loadConfig() {
    populateSourceMenu();
    const saved = localStorage.getItem(CONFIG_KEY);
    if(saved) {
        try { userSettings = { ...userSettings, ...JSON.parse(saved) }; } 
        catch(e) { console.error("Config error", e); }
    }
    const savedDisabled = localStorage.getItem(DISABLED_WORDS_KEY);
    if(savedDisabled) {
        try { disabledWords = new Set(JSON.parse(savedDisabled)); }
        catch(e) { disabledWords = new Set(); }
    }
    applyConfigToUI();
    recalcGameVars();
}

function applyConfigToUI() {
    document.getElementById('cfg-source').value = userSettings.vocabSource;
    document.getElementById('mini-slider-percent').value = userSettings.dataPercent;
    document.getElementById('lbl-percent').textContent = userSettings.dataPercent + '%';

    document.getElementById('chk-quiz').checked = userSettings.quizEnabled;
    document.getElementById('cfg-quiz-time').value = userSettings.quizInterval;
    document.getElementById('val-quiz-time').textContent = userSettings.quizInterval + 's';

    document.getElementById('cfg-volume').value = userSettings.masterVolume;
    document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";

    document.getElementById('cfg-spawn').value = userSettings.spawnLevel;
    document.getElementById('val-spawn').textContent = userSettings.spawnLevel;
    document.getElementById('cfg-speed').value = userSettings.enemySpeed;
    document.getElementById('val-speed').textContent = userSettings.enemySpeed + "x";
    document.getElementById('cfg-bomb').value = userSettings.bombChance;
    document.getElementById('val-bomb').textContent = userSettings.bombChance + "%";
    document.getElementById('cfg-bspeed').value = userSettings.bombSpeed;
    document.getElementById('val-bspeed').textContent = userSettings.bombSpeed;
    document.getElementById('cfg-color').value = userSettings.playerColor;
    player.color = userSettings.playerColor;
}

function recalcGameVars() {
    gameVars.spawnInterval = 5500 - (userSettings.spawnLevel * 500); 
    gameVars.bombProb = userSettings.bombChance / 2000; 
}

function updateConfig(key) {
    if(key === 'source') {
        userSettings.vocabSource = document.getElementById('cfg-source').value;
        loadVocabData(); populateStudyGuide(); renderCategoryBar();
        if(gameRunning) enemies = []; 
    }
    else if(key === 'percent_only') {
        loadVocabData(); populateStudyGuide();
        if(gameRunning) enemies = [];
    }
    else if(key === 'volume') {
        userSettings.masterVolume = parseInt(document.getElementById('cfg-volume').value);
        document.getElementById('val-volume').textContent = userSettings.masterVolume + "%";
        playSound('shoot'); 
    }
    else if(key === 'quiz') {
        userSettings.quizEnabled = document.getElementById('chk-quiz').checked;
        userSettings.quizInterval = parseInt(document.getElementById('cfg-quiz-time').value);
        document.getElementById('val-quiz-time').textContent = userSettings.quizInterval + 's';
        quizTimer = 0; 
    }
    else if(key === 'spawn') userSettings.spawnLevel = parseInt(document.getElementById('cfg-spawn').value);
    else if(key === 'speed') userSettings.enemySpeed = parseFloat(document.getElementById('cfg-speed').value);
    else if(key === 'bomb') userSettings.bombChance = parseInt(document.getElementById('cfg-bomb').value);
    else if(key === 'bspeed') userSettings.bombSpeed = parseFloat(document.getElementById('cfg-bspeed').value);
    else if(key === 'color') {
        userSettings.playerColor = document.getElementById('cfg-color').value;
        player.color = userSettings.playerColor;
    }
    
    if(key !== 'percent_only' && key !== 'volume') {
        applyConfigToUI(); 
    }
    recalcGameVars();
    localStorage.setItem(CONFIG_KEY, JSON.stringify(userSettings));
}

function resetConfig() {
    localStorage.removeItem(CONFIG_KEY);
    localStorage.removeItem(DISABLED_WORDS_KEY);
    disabledWords.clear();
    userSettings = { vocabSource: 'LOCAL', dataPercent: 100, spawnLevel: 5, enemySpeed: 1.0, bombChance: 30, bombSpeed: 2.0, playerColor: '#4f46e5', quizEnabled: false, quizInterval: 30, masterVolume: 50 };
    loadConfig(); loadVocabData(); populateStudyGuide(); renderCategoryBar();
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    if(tabName === 'db') document.querySelector('button[onclick="switchTab(\'db\')"]').classList.add('active');
    else document.querySelector('button[onclick="switchTab(\'settings\')"]').classList.add('active');
}

// --- 3. DATA & CLEANING ---
let activeVocabList = []; 
let gameDeck = [];        

const cleanText = (str) => {
    if(!str) return "";
    return str.replace(/[.,;¡!¿?]/g, '').trim().toUpperCase();
};

function loadVocabData() {
    let tempVocabList = [];
    const countWords = (str) => str.trim().split(/\s+/).length;
    const processItem = (en, es) => {
        const safeEn = cleanText(en);
        const safeEs = cleanText(es);
        
        if(safeEn && safeEs && countWords(safeEn) <= 2) {
            tempVocabList.push({en: safeEn, es: [safeEs]});
        }
    };

    if (userSettings.vocabSource === 'LOCAL' || userSettings.vocabSource === 'MIXED') {
        try {
            const saved = localStorage.getItem('mdc_vocab_list');
            const items = saved ? JSON.parse(saved) : [];
            items.forEach(item => {
                if (item.isFolder && item.items) {
                    item.items.forEach(sub => processItem(sub.eng, sub.esp));
                } else if (!item.isFolder) {
                    processItem(item.eng, item.esp);
                }
            });
        } catch (e) { console.error("Local Load Error", e); }
    }

    if (userSettings.vocabSource !== 'LOCAL') {
        let sourcesToLoad = [];
        if (userSettings.vocabSource === 'ALL_INTERNAL' || userSettings.vocabSource === 'MIXED') {
            sourcesToLoad = Object.keys(INTERNAL_VOCAB);
        } else {
            sourcesToLoad = [userSettings.vocabSource];
        }
        sourcesToLoad.forEach(catKey => {
            if(INTERNAL_VOCAB[catKey]) {
                INTERNAL_VOCAB[catKey].forEach(i => processItem(i.en, i.es));
            }
        });
    }

    if (tempVocabList.length > 0) {
        const limit = Math.ceil(tempVocabList.length * (userSettings.dataPercent / 100));
        activeVocabList = tempVocabList.slice(0, limit);
    } else {
        activeVocabList = [];
    }

    if (activeVocabList.length === 0) activeVocabList.push({ en: "NO DATA", es: ["VACIO"] });
    refreshGameDeck();
}

function refreshGameDeck() {
    gameDeck = activeVocabList.filter(item => !disabledWords.has(item.en));
    if(gameDeck.length === 0) gameDeck.push({en: "NO
