<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LINGUA NEXUS | V10 Pro Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== ESTILOS BASE (UI LIMPIA) ==================== */
        :root {
            --bg-deep: #050505; --bg-card: #121214; --bg-hover: #1f1f22; --bg-input: #18181b;
            --txt-main: #f4f4f5; --txt-sec: #71717a; --border: #27272a;
            
            /* Colores Neon Brillantes */
            --c-noun: #0ea5e9; --c-adj: #d946ef; --c-reg: #22c55e; --c-irreg:#f59e0b; --c-func: #6366f1; 
            
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444; 
            --font-head: 'Bebas Neue', sans-serif; --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { background-color: var(--bg-deep); color: var(--txt-main); font-family: var(--font-ui); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { height: 64px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; background: rgba(5,5,5,0.95); border-bottom: 1px solid var(--border); z-index: 50; backdrop-filter: blur(10px); }
        .brand-area { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .brand { font-family: var(--font-head); font-size: 26px; letter-spacing: 2px; color: var(--txt-main); text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .back-btn { display: none; color: var(--txt-sec); }
        body:not(.is-home) .back-btn { display: block; }
        body:not(.is-home) .brand { display: none; } 
        .header-actions { display: flex; gap: 20px; }
        .icon-btn { background: none; border: none; color: var(--txt-sec); cursor: pointer; padding: 0; transition: 0.2s; }
        .icon-btn.active { color: var(--primary); filter: drop-shadow(0 0 5px var(--primary)); }

        /* MAIN LAYOUT */
        main { flex: 1; position: relative; overflow: hidden; width: 100%; display: flex; flex-direction: column; }
        .view-screen { display: none; flex-direction: column; width: 100%; height: 100%; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); max-width: 800px; margin: 0 auto; }
        .view-screen.active { display: flex; }

        /* HOME UI */
        .welcome-text { margin-bottom: 30px; text-align: center; }
        .welcome-text h1 { font-family: var(--font-head); font-size: 52px; margin: 0; line-height: 0.9; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .stat-pill { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
        .stat-val { font-family: var(--font-code); font-weight: 700; font-size: 24px; display: block; }
        .stat-lbl { font-size: 10px; font-weight: 600; color: var(--txt-sec); text-transform: uppercase; margin-top: 4px; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%; }
        .menu-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .menu-card:active { transform: scale(0.96); }
        .card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 15px; background: rgba(255,255,255,0.05); }
        .menu-card h3 { margin: 0; font-family: var(--font-head); font-size: 28px; line-height: 1; letter-spacing: 1px; }
        .menu-card span { font-size: 12px; color: var(--txt-sec); font-weight: 500; margin-top: 6px; display: block; }

        /* CATEGORY COLORS */
        .menu-card[data-type="noun"] { border-color: rgba(14, 165, 233, 0.3); color: var(--c-noun); } 
        .menu-card[data-type="adj"] { border-color: rgba(217, 70, 239, 0.3); color: var(--c-adj); }
        .menu-card[data-type="reg"] { border-color: rgba(34, 197, 94, 0.3); color: var(--c-reg); }
        .menu-card[data-type="irreg"] { border-color: rgba(245, 158, 11, 0.3); color: var(--c-irreg); }
        .menu-card[data-type="func"] { border-color: rgba(99, 102, 241, 0.3); color: var(--c-func); }
        .menu-card[data-type="mixed"] { border-color: var(--border); color: #fff; }
        .menu-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; border-style: dashed; }

        /* SETTINGS & LIBRARY */
        .section-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .section-head { font-family: var(--font-head); font-size: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; letter-spacing: 1px; }
        .row-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .num-inp { background: var(--bg-input); border: 1px solid var(--border); color: var(--txt-main); border-radius: 8px; padding: 8px; width: 70px; text-align: center; font-family: var(--font-code); }
        .lib-search { width: 100%; background: var(--bg-card); border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: var(--txt-main); font-size: 16px; margin-bottom: 15px; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; flex: 1; min-width: 50px; text-align: center; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 0 10px rgba(59,130,246,0.3); }
        .lib-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .lib-content { padding: 15px; }
        .lib-en { font-weight: 700; font-size: 16px; color: var(--txt-main); }
        .lib-es { font-size: 13px; color: var(--txt-sec); margin-top: 2px; }
        .prog-track { width: 100%; height: 4px; background: var(--bg-input); }
        .prog-fill { height: 100%; width: 0%; }
        .lvl-1 .prog-fill { background: var(--danger); } .lvl-2 .prog-fill { background: var(--c-irreg); }
        .lvl-3 .prog-fill { background: var(--primary); } .lvl-4 .prog-fill { background: var(--success); }
        .lib-badge { position: absolute; right: 15px; top: 15px; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: var(--bg-input); color: var(--txt-sec); }
        .load-more-btn { width: 100%; padding: 15px; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-main); border-radius: 12px; margin-top: 10px; cursor: pointer; font-weight: 700; font-size: 12px; letter-spacing: 1px; }

        /* QUEUE */
        .queue-grid { display: grid; gap: 8px; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-deep); border: 1px solid var(--border); padding: 10px 14px; border-radius: 8px; font-size: 14px; }
        .queue-tag { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; letter-spacing: 0.5px; }
        .tag-new { background: var(--c-noun); color: #fff; } .tag-learning { background: var(--c-irreg); color: #000; } .tag-review { background: var(--danger); color: #fff; } .tag-master { background: var(--success); color: #fff; } 

        /* ==================== PRO GAME UI ==================== */
        .game-top-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; z-index: 60; position: relative; }
        .stage-pill { display: inline-flex; padding: 6px 14px; border-radius: 100px; font-size: 11px; font-weight: 700; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); text-transform: uppercase; letter-spacing: 1px; }
        
        .timer-badge { 
            font-family: var(--font-code); font-size: 12px; color: var(--primary); 
            background: rgba(59, 130, 246, 0.1); padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);
            margin-left: 10px; font-weight: bold;
        }

        .audio-toggle-btn { background: var(--bg-card); border: 1px solid var(--border); width: 48px; height: 48px; border-radius: 12px; color: var(--txt-sec); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-left: auto; margin-right: 15px; }
        .audio-toggle-btn.active { background: var(--bg-input); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }

        .mini-chart { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .chart-hole { width: 38px; height: 38px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; }
        #chart-pct { font-size: 10px; font-weight: 800; font-family: var(--font-code); color: var(--txt-main); }

        /* CANVAS CONTAINER */
        #game-layout-wrapper { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        #game-canvas-container { 
            flex: 1; position: relative; width: 100%;
            background: #000;
            border-radius: 16px; border: 1px solid var(--border);
            overflow: hidden; margin-bottom: 20px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* CONTROLES TACTILES PRO */
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; height: 140px; }
        .ans-btn { 
            background: linear-gradient(145deg, var(--bg-card), var(--bg-input));
            border: 1px solid var(--border); color: var(--txt-sec); 
            padding: 10px; border-radius: 12px; font-size: 15px; font-weight: 600; 
            text-align: center; cursor: pointer; transition: all 0.1s; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .ans-btn:active { transform: translateY(3px); box-shadow: none; filter: brightness(1.2); }
        
        .ans-btn.correct-flash { 
            background: var(--success) !important; color: #fff; 
            border-color: var(--success); 
            box-shadow: 0 0 20px var(--success);
            z-index: 10;
        }
        .ans-btn.error-flash { 
            background: var(--danger) !important; color: #fff; 
            border-color: var(--danger); 
            box-shadow: 0 0 20px var(--danger);
            animation: shake 0.4s;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    </style>
</head>
<body class="is-home">

    <script src="https://paradisonetworx.com/database.js"></script>

    <header>
        <div class="brand-area" onclick="Game.stop(); App.nav('home')">
            <svg class="back-btn" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path></svg>
            <div class="brand">LINGUA NEXUS</div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="Profile.toggleTheme()">
                <svg id="theme-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button id="btn-settings-nav" class="icon-btn" onclick="Game.stop(); App.nav('settings')">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <main>
        <div id="view-home" class="view-screen active">
            <div class="welcome-text"><h1>TRAINING HUB</h1></div>
            <div class="stats-row">
                <div class="stat-pill"><span class="stat-val" style="color:var(--success)" id="stat-m">0</span><span class="stat-lbl">Mastered</span></div>
                <div class="stat-pill"><span class="stat-val" style="color:var(--c-noun)" id="stat-t">0</span><span class="stat-lbl">Total Seen</span></div>
            </div>
            <div class="grid-menu">
                <div class="menu-card" data-type="noun" onclick="App.start('nouns')"><div class="card-icon">N</div><div><h3>NOUNS</h3><span>Objects & Things</span></div></div>
                <div class="menu-card" data-type="adj" onclick="App.start('adjectives')"><div class="card-icon">A</div><div><h3>ADJECTIVES</h3><span>Descriptions</span></div></div>
                <div class="menu-card" data-type="reg" onclick="App.start('verbs_reg')"><div class="card-icon">R</div><div><h3>REGULAR</h3><span>Standard Verbs</span></div></div>
                <div class="menu-card" data-type="irreg" onclick="App.start('verbs_irreg')"><div class="card-icon">I</div><div><h3>IRREGULAR</h3><span>Complex Forms</span></div></div>
                <div class="menu-card" data-type="func" onclick="App.start('functionals')"><div class="card-icon">L</div><div><h3>LOGIC & SYNTAX</h3><span>Connectors & Structure</span></div></div>
                <div class="menu-card" data-type="mixed" onclick="App.start('mixed')"><div class="card-icon">M</div><div><h3>MIXED BAG</h3><span>All Words Shuffle</span></div></div>
            </div>
        </div>

        <div id="view-settings" class="view-screen">
            <div class="section-box" style="border-color: var(--c-func);">
                <div class="section-head" style="color: var(--c-func);">GAME ENGINE</div>
                <div class="row-ctrl">
                    <span class="row-lbl">Simulation Mode</span>
                    <select id="cfg-mode" class="num-inp" style="width:160px; text-align:left;" onchange="Profile.saveCfg()">
                        <option value="meteor">NEON FALL (Classic)</option>
                        <option value="bubble">ZERO GRAVITY (Float)</option>
                    </select>
                </div>
                <div class="row-ctrl"><span class="row-lbl">Game Speed</span><select id="cfg-speed" class="num-inp" onchange="Profile.saveCfg()"><option value="1">Slow</option><option value="2">Normal</option><option value="3">Fast</option></select></div>
            </div>

            <div class="section-box">
                <div class="section-head">SESSION</div>
                <div class="row-ctrl"><span class="row-lbl">Data Source</span><select id="cfg-source" class="num-inp" style="width:140px; text-align:left;" onchange="Profile.saveCfg()"><option value="official">Official Course</option><option value="custom">My Vocabulary</option></select></div>
                <div class="row-ctrl"><span class="row-lbl">Words per Session</span><input type="number" id="cfg-count" class="num-inp" value="10" onchange="Profile.saveCfg()"></div>
                <div class="row-ctrl"><span class="row-lbl">Time Limit (Min)</span><input type="number" id="cfg-time" class="num-inp" value="0" onchange="Profile.saveCfg()"></div>
            </div>

            <div class="section-box"><div class="section-head">DANGER ZONE</div><div class="row-ctrl"><span class="row-lbl" style="color:var(--danger)">Reset All Progress</span><button onclick="Profile.wipe()" style="background:var(--danger); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:bold;">WIPE</button></div></div>
        </div>

        <div id="view-game" class="view-screen">
            <div class="game-top-bar">
                <div class="stage-pill" id="game-cat-pill">CATEGORY</div>
                <div class="timer-badge" id="game-timer" style="display:none">00:00</div>
                <button id="btn-audio-mode" class="audio-toggle-btn active" onclick="App.toggleAudioMode()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
                </button>
                <div class="mini-chart" id="game-chart"><div class="chart-hole"><span id="chart-pct">0%</span></div></div>
            </div>

            <div id="game-layout-wrapper">
                <div id="game-canvas-container">
                    <canvas id="game-canvas"></canvas>
                </div>
                <div class="answers-grid" id="control-dock">
                    <button class="ans-btn">INITIALIZING...</button>
                    <button class="ans-btn">INITIALIZING...</button>
                    <button class="ans-btn">INITIALIZING...</button>
                    <button class="ans-btn">INITIALIZING...</button>
                </div>
            </div>
        </div>
    </main>

<script>
// --- DB & PROFILE (MANTENIDOS IGUAL) ---
const DB = { data: {}, async init() { return new Promise(r => { const t = setInterval(() => { if(typeof INTERNAL_VOCAB !== 'undefined') { this.data = INTERNAL_VOCAB; clearInterval(t); r(); } }, 50); }); }, getCustomData() { try { const r = JSON.parse(localStorage.getItem('mdc_vocab_list') || '[]'); let f = []; const ex = (it) => { it.forEach(i => { if(i.isFolder && i.items) ex(i.items); else if(i.eng) f.push({ en: i.eng, es: i.esp, cat: 'custom' }); }); }; ex(r); return f; } catch(e) { return []; } }, get(cat) { if (Profile.cfg.source === 'custom') return this.getCustomData().map(x => ({...x, cat: 'custom'})); const k = { nouns:'NOUNS', adjectives:'ADJECTIVES', verbs_reg:'REGULAR_VERBS', verbs_irreg:'IRREGULAR_VERBS', functionals:'FUNCTION WORDS' }; if (cat === 'mixed') { let a = []; Object.keys(k).forEach(key => { a = a.concat((this.data[k[key]] || []).map(x => ({...x, cat: key}))); }); return a; } return (this.data[k[cat]] || []).map(x => ({...x, cat})); }, all() { if (Profile.cfg.source === 'custom') return this.getCustomData(); let a = []; Object.keys(this.data).forEach(k => a = a.concat(this.data[k])); return a; } };
const Profile = { cfg: { count:10, time:0, theme:'dark', prog:{}, source: 'official', speed: 2, gameMode: 'meteor' }, load() { const s = localStorage.getItem('LN_V7'); if(s) this.cfg = { ...this.cfg, ...JSON.parse(s) }; this.applyDecay(); this.applyTheme(); const elC = document.getElementById('cfg-count'), elS = document.getElementById('cfg-source'), elSp = document.getElementById('cfg-speed'), elT = document.getElementById('cfg-time'), elM = document.getElementById('cfg-mode'); if(elC) elC.value = this.cfg.count; if(elS) elS.value = this.cfg.source || 'official'; if(elSp) elSp.value = this.cfg.speed || 2; if(elT) elT.value = this.cfg.time || 0; if(elM) elM.value = this.cfg.gameMode || 'meteor'; this.calcStats(); }, saveCfg() { this.cfg.count = parseInt(document.getElementById('cfg-count').value) || 10; this.cfg.speed = parseInt(document.getElementById('cfg-speed').value) || 2; this.cfg.time = parseInt(document.getElementById('cfg-time').value) || 0; this.cfg.gameMode = document.getElementById('cfg-mode').value; const src = document.getElementById('cfg-source'); if(src) this.cfg.source = src.value; this.save(); App.updateHomeMenu(); }, save() { localStorage.setItem('LN_V7', JSON.stringify(this.cfg)); }, applyTheme() { const d = document.documentElement, i = document.getElementById('theme-icon'); if(this.cfg.theme === 'light') { d.classList.add('light-mode'); if(i) i.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>'; } else { d.classList.remove('light-mode'); if(i) i.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'; } }, toggleTheme() { this.cfg.theme = this.cfg.theme === 'dark' ? 'light' : 'dark'; this.applyTheme(); this.save(); }, getData(w) { let v = this.cfg.prog[w]; if (v === undefined) return { lvl: 0, date: 0 }; if (typeof v === 'number') return { lvl: v, date: 0 }; return v; }, setProg(w, ok) { let e = this.getData(w), l = e.lvl; if(ok) { if(l < 4) l++; } else { l = Math.max(0, l - 1); } this.cfg.prog[w] = { lvl: l, date: Date.now() }; this.save(); this.calcStats(); }, getLvl(w) { return this.getData(w).lvl; }, getDate(w) { return this.getData(w).date; }, wipe() { if(confirm("Clear progress?")) { this.cfg.prog={}; this.save(); App.nav('home'); } }, calcStats() { const k = Object.keys(this.cfg.prog), m = k.filter(x => this.getData(x).lvl === 4).length, elM = document.getElementById('stat-m'), elT = document.getElementById('stat-t'); if(elM) elM.innerText = m; if(elT) elT.innerText = k.length; }, applyDecay() { const NOW = Date.now(), DECAY = 30 * 24 * 60 * 60 * 1000; let ch = false; Object.keys(this.cfg.prog).forEach(w => { let e = this.cfg.prog[w]; if (typeof e === 'object' && e.lvl === 4 && NOW - e.date > DECAY) { e.lvl = 3; e.date = NOW; ch = true; } }); if(ch) this.save(); } };

const App = {
    audioEnabled: true, // Estado del audio

    async boot() { await DB.init(); Profile.load(); this.nav('home'); },
    nav(v) { document.querySelectorAll('.view-screen').forEach(e => e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.body.className = (v === 'home') ? 'is-home' : ''; const btn = document.getElementById('btn-settings-nav'); if(v === 'settings') btn.classList.add('active'); else btn.classList.remove('active'); if(v === 'home') this.updateHomeMenu(); },
    updateHomeMenu() { const cust = Profile.cfg.source === 'custom', cards = document.querySelectorAll('.menu-card:not([data-type="mixed"])'); cards.forEach(c => { if(cust) c.classList.add('disabled'); else c.classList.remove('disabled'); }); },
    
    toggleAudioMode() {
        this.audioEnabled = !this.audioEnabled;
        const btn = document.getElementById('btn-audio-mode');
        // Icono cambiaría aquí visualmente
        if(this.audioEnabled) {
            btn.classList.add('active');
            btn.style.opacity = "1";
        } else {
            btn.classList.remove('active');
            btn.style.opacity = "0.5";
        }
    },

    start(cat) {
        if(Profile.cfg.source === 'custom' && cat !== 'mixed') return;
        const raw = DB.get(cat);
        // Sort Logic
        for (let i = raw.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [raw[i], raw[j]] = [raw[j], raw[i]]; }
        const sorted = raw.sort((a,b) => {
            const ga = (l=Profile.getLvl(a.en)) => l>0&&l<4?1:l===0?2:3;
            const gb = (l=Profile.getLvl(b.en)) => l>0&&l<4?1:l===0?2:3;
            if(ga(Profile.getLvl(a.en)) !== gb(Profile.getLvl(b.en))) return ga(Profile.getLvl(a.en)) - gb(Profile.getLvl(b.en));
            return Profile.getDate(a.en) - Profile.getDate(b.en);
        });
        
        const queue = sorted.slice(0, Profile.cfg.count);
        if(queue.length === 0) return alert("No words found.");

        this.nav('game');
        
        // Setup UI Colors
        const pills = { nouns:'--c-noun', adjectives:'--c-adj', verbs_reg:'--c-reg', verbs_irreg:'--c-irreg', functionals:'--c-func', mixed: '--c-mixed', custom: '--primary' };
        const p = document.getElementById('game-cat-pill');
        const cVar = cat === 'mixed' || Profile.cfg.source === 'custom' ? (cat==='mixed'?pills.mixed:pills.custom) : pills[cat];
        p.innerText = Profile.cfg.source === 'custom' ? "MY VOCAB" : (cat==='mixed'?'MIXED BAG':cat.toUpperCase());
        p.style.color = `var(${cVar})`; p.style.borderColor = `var(${cVar})`;
        
        this.updateChart(cat);
        Game.init(queue, cat, `var(${cVar})`); 
    },
    
    updateChart(cat) {
        const all = DB.get(cat), t = all.length, c = [0,0,0,0,0];
        if(t===0) return;
        all.forEach(w => c[Profile.getLvl(w.en)]++);
        const p4=c[4]/t*100, p3=c[3]/t*100, p2=c[2]/t*100, p1=c[1]/t*100;
        document.getElementById('game-chart').style.background = `conic-gradient(var(--success) 0% ${p4}%, var(--primary) ${p4}% ${p4+p3}%, var(--c-irreg) ${p4+p3}% ${p4+p3+p2}%, var(--danger) ${p4+p3+p2}% ${p4+p3+p2+p1}%, var(--bg-input) ${p4+p3+p2+p1}% 100%)`;
        document.getElementById('chart-pct').innerText = Math.round(p4)+'%';
    }
};

/* ==========================================================================
   PRO GAME ENGINE (HTML5 CANVAS)
   ========================================================================== */
const Game = {
    canvas: null, ctx: null, queue: [], pool: [], idx: 0, 
    width: 0, height: 0, loopId: null, lastTime: 0,
    
    // Game State
    activeWord: null, // { en, es, cat, x, y, vy, vx, rotation, color }
    particles: [],
    stars: [],
    laser: null,
    score: 0,
    startTime: 0, timeLimit: 0,
    themeColor: '#fff',
    
    init(queue, cat, colorVar) {
        this.queue = queue;
        const allData = DB.get(cat);
        this.pool = allData.length > 4 ? allData : DB.all();
        this.idx = 0; this.score = 0;
        
        // Canvas Setup
        this.canvas = document.getElementById('game-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        
        // Configs
        this.mode = Profile.cfg.gameMode || 'meteor';
        this.speedMult = Profile.cfg.speed === 1 ? 0.6 : (Profile.cfg.speed === 3 ? 1.5 : 1.0);
        this.startTime = Date.now();
        this.timeLimit = Profile.cfg.time * 60 * 1000;
        this.themeColor = getComputedStyle(document.documentElement).getPropertyValue(colorVar.replace('var(','').replace(')','')).trim();
        
        document.getElementById('game-timer').style.display = this.timeLimit > 0 ? 'block' : 'none';

        // Init Starfield
        this.stars = [];
        for(let i=0; i<80; i++) {
            this.stars.push({
                x: Math.random() * this.width,
                y: Math.random() * this.height,
                size: Math.random() * 2,
                speed: 0.2 + Math.random() * 0.5
            });
        }

        this.spawn();
        this.lastTime = performance.now();
        this.loopId = requestAnimationFrame(t => this.loop(t));
    },

    resize() {
        const con = document.getElementById('game-canvas-container');
        this.canvas.width = con.offsetWidth;
        this.canvas.height = con.offsetHeight;
        this.width = this.canvas.width;
        this.height = this.canvas.height;
    },

    stop() {
        cancelAnimationFrame(this.loopId);
        this.activeWord = null;
    },

    spawn() {
        if(this.idx >= this.queue.length) {
            alert("SESSION COMPLETE!");
            this.stop(); App.nav('home'); return;
        }

        const data = this.queue[this.idx];
        
        // Entity Setup
        const size = 60;
        let x = size + Math.random() * (this.width - size*2);
        let y = this.mode === 'meteor' ? -60 : this.height + 60;
        
        this.activeWord = {
            data: data,
            x: x, y: y,
            vx: (Math.random() - 0.5) * 0.5,
            vy: this.mode === 'meteor' ? (1 + Math.random()) * this.speedMult : (-1 - Math.random()) * this.speedMult,
            rot: 0,
            rotSpeed: (Math.random() - 0.5) * 0.02,
            size: size,
            color: this.themeColor
        };
        
        this.renderButtons(data);
    },

    renderButtons(correct) {
        const dock = document.getElementById('control-dock');
        dock.innerHTML = '';
        let opts = [correct];
        let i = 0;
        while(opts.length < 4 && i < 100) {
            const r = this.pool[Math.floor(Math.random() * this.pool.length)];
            if(!opts.find(x => x.en === r.en)) opts.push(r);
            i++;
        }
        opts.sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'ans-btn';
            btn.innerText = Array.isArray(opt.es) ? opt.es[0] : opt.es;
            btn.onclick = () => this.fire(opt, correct, btn);
            dock.appendChild(btn);
        });
    },

    fire(sel, cor, btn) {
        if(!this.activeWord) return;
        
        const rect = btn.getBoundingClientRect();
        const canRect = this.canvas.getBoundingClientRect();
        
        // Laser Origin relative to canvas
        const originX = (rect.left + rect.width/2) - canRect.left;
        const originY = this.height; 

        // Laser Effect
        this.laser = {
            x1: originX, y1: originY,
            x2: this.activeWord.x, y2: this.activeWord.y,
            life: 1.0,
            color: sel.en === cor.en ? '#10b981' : '#ef4444' // Green or Red laser
        };

        if(sel.en === cor.en) {
            // Success
            btn.classList.add('correct-flash');
            this.speak(cor.en);
            this.createExplosion(this.activeWord.x, this.activeWord.y, this.activeWord.color);
            Profile.setProg(cor.en, true);
            
            this.activeWord = null;
            this.idx++;
            setTimeout(() => this.spawn(), 500);
        } else {
            // Fail
            btn.classList.add('error-flash');
            this.screenShake();
        }
    },

    createExplosion(x, y, color) {
        for(let i=0; i<25; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5;
            this.particles.push({
                x: x, y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                life: 1.0,
                color: color,
                size: Math.random() * 4
            });
        }
    },

    fail() {
        if(App.audioEnabled) this.speak(this.activeWord.data.en);
        this.screenShake();
        Profile.setProg(this.activeWord.data.en, false);
        
        // Fade out particle effect instead of full explosion
        this.createExplosion(this.activeWord.x, this.activeWord.y, '#555'); 
        
        this.activeWord = null;
        this.idx++;
        setTimeout(() => this.spawn(), 1000);
    },

    speak(txt) {
        if(!App.audioEnabled) return; // FIX DE AUDIO SOLICITADO
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-US'; u.rate = 1.1;
        window.speechSynthesis.speak(u);
    },

    screenShake() {
        const c = document.getElementById('game-canvas');
        c.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
        setTimeout(() => c.style.transform = 'none', 200);
    },

    // --- MAIN RENDER LOOP ---
    loop(now) {
        const dt = (now - this.lastTime) / 16; // Norm to 60fps
        this.lastTime = now;
        
        // Clear
        this.ctx.fillStyle = '#050505';
        this.ctx.fillRect(0, 0, this.width, this.height);
        
        // 1. Draw Stars (Background)
        this.ctx.fillStyle = '#ffffff';
        this.stars.forEach(s => {
            s.y += s.speed * (this.mode === 'meteor' ? 1 : 0.2); // Slower stars if bubble mode
            if(s.y > this.height) s.y = 0;
            this.ctx.globalAlpha = 0.3 + Math.random() * 0.5;
            this.ctx.beginPath();
            this.ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
            this.ctx.fill();
        });
        this.ctx.globalAlpha = 1.0;

        // 2. Logic & Draw Entity
        if(this.activeWord) {
            const w = this.activeWord;
            w.x += w.vx * dt;
            w.y += w.vy * dt;
            w.rot += w.rotSpeed * dt;

            // Bounds check
            if((this.mode === 'meteor' && w.y > this.height - 50) ||
               (this.mode === 'bubble' && w.y < 50)) {
                this.fail();
            } else {
                // Draw Word Shape
                this.ctx.save();
                this.ctx.translate(w.x, w.y);
                this.ctx.rotate(w.rot);
                
                // Glow Effect
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = w.color;
                this.ctx.strokeStyle = w.color;
                this.ctx.lineWidth = 3;

                if(this.mode === 'meteor') {
                    // Hexagon Shape
                    this.ctx.beginPath();
                    for(let i=0; i<6; i++) {
                        this.ctx.lineTo(w.size * Math.cos(i*Math.PI/3), w.size * Math.sin(i*Math.PI/3));
                    }
                    this.ctx.closePath();
                    this.ctx.stroke();
                    this.ctx.fillStyle = "rgba(0,0,0,0.8)";
                    this.ctx.fill();
                } else {
                    // Bubble Shape
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, w.size, 0, Math.PI*2);
                    this.ctx.stroke();
                    this.ctx.fillStyle = "rgba(255,255,255,0.05)";
                    this.ctx.fill();
                }

                this.ctx.restore();

                // Draw Text (No Rotate)
                this.ctx.font = "bold 24px 'Bebas Neue'";
                this.ctx.fillStyle = "#fff";
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";
                this.ctx.shadowBlur = 0; // Clear blur for text clarity
                this.ctx.fillText(w.data.en, w.x, w.y);
            }
        }

        // 3. Draw Laser
        if(this.laser) {
            this.ctx.lineWidth = 6 * this.laser.life;
            this.ctx.strokeStyle = this.laser.color;
            this.ctx.shadowBlur = 15;
            this.ctx.shadowColor = this.laser.color;
            this.ctx.beginPath();
            this.ctx.moveTo(this.laser.x1, this.laser.y1);
            this.ctx.lineTo(this.laser.x2, this.laser.y2);
            this.ctx.stroke();
            this.laser.life -= 0.1;
            if(this.laser.life <= 0) this.laser = null;
            this.ctx.shadowBlur = 0;
        }

        // 4. Draw Particles
        for(let i = this.particles.length-1; i>=0; i--) {
            let p = this.particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.02;
            p.vy += 0.1; // Gravity
            
            if(p.life <= 0) {
                this.particles.splice(i, 1);
            } else {
                this.ctx.globalAlpha = p.life;
                this.ctx.fillStyle = p.color;
                this.ctx.beginPath();
                this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                this.ctx.fill();
            }
        }
        this.ctx.globalAlpha = 1.0;

        // 5. Draw Player Ship (Static at bottom center visually)
        const shipX = this.width / 2;
        const shipY = this.height - 30;
        this.ctx.fillStyle = '#ccc';
        this.ctx.beginPath();
        this.ctx.moveTo(shipX, shipY - 20);
        this.ctx.lineTo(shipX - 15, shipY + 15);
        this.ctx.lineTo(shipX, shipY + 5);
        this.ctx.lineTo(shipX + 15, shipY + 15);
        this.ctx.closePath();
        this.ctx.fill();

        // Timer Logic
        if(this.timeLimit > 0) {
            const left = this.timeLimit - (Date.now() - this.startTime);
            if(left <= 0) { this.stop(); alert("TIME'S UP!"); App.nav('home'); }
            else {
                const m = Math.floor(left/60000);
                const s = Math.floor((left%60000)/1000);
                document.getElementById('game-timer').innerText = `${m}:${s<10?'0':''}${s}`;
            }
        }

        this.loopId = requestAnimationFrame(t => this.loop(t));
    }
};

window.onload = () => App.boot();
</script>
</body>
</html>
