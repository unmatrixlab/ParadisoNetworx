<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LINGUA NEXUS | Multi-Game Arcade</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== ESTILOS BASE (NO CAMBIAN) ==================== */
        :root {
            --bg-deep: #09090b; --bg-card: #18181b; --bg-hover: #27272a; --bg-input: #27272a;
            --txt-main: #f4f4f5; --txt-sec: #a1a1aa; --border: #3f3f46;
            --c-noun: #38bdf8; --c-adj: #e879f9; --c-reg: #4ade80; --c-irreg:#fbbf24; --c-func: #818cf8; --c-mixed: #ffffff; 
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444; 
            --font-head: 'Bebas Neue', sans-serif; --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        :root.light-mode {
            --bg-deep: #f8fafc; --bg-card: #ffffff; --bg-hover: #f1f5f9; --bg-input: #e2e8f0;
            --txt-main: #0f172a; --txt-sec: #64748b; --border: #e2e8f0;
            --c-noun: #0284c7; --c-adj: #c026d3; --c-reg: #16a34a; --c-irreg:#d97706; --c-func: #4f46e5; --c-mixed: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { background-color: var(--bg-deep); color: var(--txt-main); font-family: var(--font-ui); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { height: 64px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; background: var(--bg-deep); border-bottom: 1px solid var(--border); z-index: 50; }
        .brand-area { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .brand { font-family: var(--font-head); font-size: 26px; letter-spacing: 1px; color: var(--txt-main); }
        .back-btn { display: none; color: var(--txt-sec); }
        body:not(.is-home) .back-btn { display: block; }
        body:not(.is-home) .brand { display: none; } 
        .header-actions { display: flex; gap: 20px; }
        .icon-btn { background: none; border: none; color: var(--txt-sec); cursor: pointer; padding: 0; transition: 0.2s; }
        .icon-btn.active { color: var(--primary); transform: scale(1.1); opacity: 1; }

        /* MAIN */
        main { flex: 1; position: relative; overflow: hidden; width: 100%; display: flex; flex-direction: column; }
        .view-screen { display: none; flex-direction: column; width: 100%; height: 100%; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); max-width: 800px; margin: 0 auto; }
        .view-screen.active { display: flex; }

        /* HOME UI */
        .welcome-text { margin-bottom: 30px; text-align: center; }
        .welcome-text h1 { font-family: var(--font-head); font-size: 48px; margin: 0; line-height: 0.9; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .stat-pill { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
        .stat-val { font-family: var(--font-code); font-weight: 700; font-size: 24px; display: block; }
        .stat-lbl { font-size: 10px; font-weight: 600; color: var(--txt-sec); text-transform: uppercase; margin-top: 4px; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%; }
        .menu-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; cursor: pointer; transition: 0.2s; }
        .menu-card:active { transform: scale(0.98); }
        .card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 15px; background: rgba(255,255,255,0.05); }
        .menu-card h3 { margin: 0; font-family: var(--font-head); font-size: 28px; line-height: 1; }
        .menu-card span { font-size: 12px; color: var(--txt-sec); font-weight: 500; margin-top: 6px; display: block; }
        
        /* COLORES */
        .menu-card[data-type="noun"] { color: var(--c-noun); } .menu-card[data-type="noun"] .card-icon { background: rgba(56, 189, 248, 0.1); color: var(--c-noun); }
        .menu-card[data-type="adj"] { color: var(--c-adj); } .menu-card[data-type="adj"] .card-icon { background: rgba(232, 121, 249, 0.1); color: var(--c-adj); }
        .menu-card[data-type="reg"] { color: var(--c-reg); } .menu-card[data-type="reg"] .card-icon { background: rgba(74, 222, 128, 0.1); color: var(--c-reg); }
        .menu-card[data-type="irreg"] { color: var(--c-irreg); } .menu-card[data-type="irreg"] .card-icon { background: rgba(251, 191, 36, 0.1); color: var(--c-irreg); }
        .menu-card[data-type="func"] { color: var(--c-func); } .menu-card[data-type="func"] .card-icon { background: rgba(129, 140, 248, 0.1); color: var(--c-func); }
        .menu-card[data-type="mixed"] { color: var(--c-mixed); border-color: var(--border); } .menu-card[data-type="mixed"] .card-icon { background: rgba(255, 255, 255, 0.1); color: var(--c-mixed); }
        .menu-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; border-style: dashed; }

        /* SETTINGS */
        .section-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .section-head { font-family: var(--font-head); font-size: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .row-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .num-inp { background: var(--bg-input); border: 1px solid var(--border); color: var(--txt-main); border-radius: 8px; padding: 8px; width: 70px; text-align: center; font-family: var(--font-code); }
        .lib-search { width: 100%; background: var(--bg-card); border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: var(--txt-main); font-size: 16px; margin-bottom: 15px; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; flex: 1; min-width: 50px; text-align: center; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .lib-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; overflow: hidden; display: flex; flex-direction: column; }
        .lib-content { padding: 15px; }
        .lib-en { font-weight: 700; font-size: 16px; color: var(--txt-main); }
        .lib-es { font-size: 13px; color: var(--txt-sec); margin-top: 2px; }
        .prog-track { width: 100%; height: 6px; background: var(--bg-input); position: relative; }
        .prog-fill { height: 100%; width: 0%; transition: width 0.3s ease; }
        .lvl-0 .prog-fill { background: transparent; } .lvl-1 .prog-fill { background: var(--danger); }
        .lvl-2 .prog-fill { background: var(--c-irreg); } .lvl-3 .prog-fill { background: var(--primary); } .lvl-4 .prog-fill { background: var(--success); }
        .lib-badge { position: absolute; right: 15px; top: 15px; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: var(--bg-input); color: var(--txt-sec); }
        .load-more-btn { width: 100%; padding: 15px; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-main); border-radius: 12px; margin-top: 10px; cursor: pointer; font-weight: 700; font-size: 12px; letter-spacing: 1px; }

        /* QUEUE */
        .queue-grid { display: grid; gap: 8px; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-deep); border: 1px solid var(--border); padding: 10px 14px; border-radius: 8px; font-size: 14px; }
        .queue-tag { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; letter-spacing: 0.5px; }
        .tag-new { background: var(--c-noun); color: #fff; } .tag-learning { background: var(--c-irreg); color: #000; } .tag-review { background: var(--danger); color: #fff; } .tag-master { background: var(--success); color: #fff; } 

        /* ==================== GAME VISUALS ==================== */
        .game-top-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; z-index: 60; position: relative; }
        .stage-pill { display: inline-flex; padding: 6px 14px; border-radius: 100px; font-size: 11px; font-weight: 700; background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-sec); text-transform: uppercase; }
        
        .timer-badge { 
            font-family: var(--font-code); font-size: 12px; color: var(--txt-sec); 
            background: var(--bg-card); padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border);
            margin-left: 10px;
        }

        .audio-toggle-btn { background: var(--bg-card); border: 1px solid var(--border); width: 48px; height: 48px; border-radius: 12px; color: var(--txt-sec); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-left: auto; margin-right: 15px; }
        .audio-toggle-btn.active { background: var(--bg-input); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }

        .mini-chart { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .chart-hole { width: 38px; height: 38px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; }
        #chart-pct { font-size: 10px; font-weight: 800; font-family: var(--font-code); color: var(--txt-main); }

        #game-layout-wrapper { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        #game-arena { 
            flex: 1; position: relative; width: 100%;
            background: radial-gradient(circle at center, #1c1c20 0%, #09090b 100%);
            border-radius: 16px; border: 1px solid var(--border);
            overflow: hidden; margin-bottom: 20px;
        }

        /* ENTIDAD BASE */
        .game-entity {
            position: absolute; color: var(--txt-main);
            font-family: var(--font-head); font-size: 28px; letter-spacing: 1px;
            white-space: nowrap; z-index: 10;
            display: flex; align-items: center; justify-content: center;
        }

        /* ESTILO 1: METEOR (Bloque Tecno) */
        .game-entity.mode-meteor {
            padding: 12px 20px; 
            background: rgba(24, 24, 27, 0.9);
            border: 2px solid var(--txt-sec); 
            border-radius: 8px; /* Cuadrado */
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* ESTILO 2: BUBBLE (Redondo) */
        .game-entity.mode-bubble {
            width: 120px; height: 120px; /* Tamaño fijo redondo */
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(24,24,27,0.8));
            border: 2px solid var(--txt-sec);
            border-radius: 50%; /* Circulo */
            box-shadow: inset 0 0 20px rgba(255,255,255,0.05);
            font-size: 22px; text-align: center;
        }

        /* Colores dinámicos */
        .game-entity[data-cat="nouns"] { border-color: var(--c-noun); color: var(--c-noun); box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }
        .game-entity[data-cat="adjectives"] { border-color: var(--c-adj); color: var(--c-adj); box-shadow: 0 0 15px rgba(232, 121, 249, 0.3); }
        .game-entity[data-cat="verbs_reg"] { border-color: var(--c-reg); color: var(--c-reg); box-shadow: 0 0 15px rgba(74, 222, 128, 0.3); }
        .game-entity[data-cat="verbs_irreg"] { border-color: var(--c-irreg); color: var(--c-irreg); box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        .game-entity[data-cat="functionals"] { border-color: var(--c-func); color: var(--c-func); box-shadow: 0 0 15px rgba(129, 140, 248, 0.3); }

        .particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 20; }
        .laser-beam { position: absolute; width: 4px; background: #fff; transform-origin: bottom center; pointer-events: none; z-index: 5; box-shadow: 0 0 8px #fff, 0 0 15px var(--primary); border-radius: 4px; }

        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; height: 140px; }
        .ans-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--txt-main); padding: 10px; border-radius: 12px; font-size: 15px; font-weight: 600; text-align: center; cursor: pointer; transition: all 0.1s; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .ans-btn:active { transform: translateY(3px); box-shadow: none; }
        .ans-btn.correct-flash { background: var(--success) !important; color: white; border-color: var(--success); }
        .ans-btn.error-flash { background: var(--danger) !important; color: white; border-color: var(--danger); animation: shake 0.4s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
        .shake-screen { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body class="is-home">

    <script src="https://paradisonetworx.com/database.js"></script>

    <header>
        <div class="brand-area" onclick="Game.stop(); App.nav('home')">
            <svg class="back-btn" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path></svg>
            <div class="brand">LINGUA NEXUS</div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="Profile.toggleTheme()">
                <svg id="theme-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button id="btn-settings-nav" class="icon-btn" onclick="Game.stop(); App.nav('settings')">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <main>
        <div id="view-home" class="view-screen active">
            <div class="welcome-text"><h1>TRAINING HUB</h1></div>
            <div class="stats-row">
                <div class="stat-pill"><span class="stat-val" style="color:var(--success)" id="stat-m">0</span><span class="stat-lbl">Mastered</span></div>
                <div class="stat-pill"><span class="stat-val" style="color:var(--c-noun)" id="stat-t">0</span><span class="stat-lbl">Total Seen</span></div>
            </div>
            <div class="grid-menu">
                <div class="menu-card" data-type="noun" onclick="App.start('nouns')"><div class="card-icon">N</div><div><h3>NOUNS</h3><span>Objects & Things</span></div></div>
                <div class="menu-card" data-type="adj" onclick="App.start('adjectives')"><div class="card-icon">A</div><div><h3>ADJECTIVES</h3><span>Descriptions</span></div></div>
                <div class="menu-card" data-type="reg" onclick="App.start('verbs_reg')"><div class="card-icon">R</div><div><h3>REGULAR</h3><span>Standard Verbs</span></div></div>
                <div class="menu-card" data-type="irreg" onclick="App.start('verbs_irreg')"><div class="card-icon">I</div><div><h3>IRREGULAR</h3><span>Complex Forms</span></div></div>
                <div class="menu-card" data-type="func" onclick="App.start('functionals')"><div class="card-icon">L</div><div><h3>LOGIC & SYNTAX</h3><span>Connectors & Structure</span></div></div>
                <div class="menu-card" data-type="mixed" onclick="App.start('mixed')"><div class="card-icon">M</div><div><h3>MIXED BAG</h3><span>All Words Shuffle</span></div></div>
            </div>
        </div>

        <div id="view-settings" class="view-screen">
            <div class="section-box" style="border-color: var(--c-func);">
                <div class="section-head" style="color: var(--c-func);">GAME CONFIG</div>
                
                <div class="row-ctrl">
                    <span class="row-lbl">Active Game Engine</span>
                    <select id="cfg-mode" class="num-inp" style="width:160px; text-align:left;" onchange="Profile.saveCfg()">
                        <option value="meteor">Meteor Rain (Fall)</option>
                        <option value="bubble">Rising Bubbles (Float)</option>
                    </select>
                </div>

                <div class="row-ctrl"><span class="row-lbl">Game Speed</span><select id="cfg-speed" class="num-inp" onchange="Profile.saveCfg()"><option value="1">Slow</option><option value="2">Normal</option><option value="3">Fast</option></select></div>
            </div>

            <div class="section-box">
                <div class="section-head">SESSION CONTROLS</div>
                <div class="row-ctrl"><span class="row-lbl">Data Source</span><select id="cfg-source" class="num-inp" style="width:140px; text-align:left;" onchange="Profile.saveCfg()"><option value="official">Official Course</option><option value="custom">My Vocabulary</option></select></div>
                <div class="row-ctrl"><span class="row-lbl">Words per Session</span><input type="number" id="cfg-count" class="num-inp" value="10" onchange="Profile.saveCfg()"></div>
                
                <div class="row-ctrl">
                    <span class="row-lbl">Time Limit (Min)</span>
                    <input type="number" id="cfg-time" class="num-inp" value="0" onchange="Profile.saveCfg()">
                </div>
                <p style="font-size:11px; color:var(--txt-sec); margin:5px 0 0 0;">0 = Infinite (Play until done)</p>
            </div>

            <div class="section-box"><div class="section-head">DANGER ZONE</div><div class="row-ctrl"><span class="row-lbl" style="color:var(--danger)">Reset All Progress</span><button onclick="Profile.wipe()" style="background:var(--danger); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:bold;">WIPE</button></div></div>
            <div class="section-box" style="border-color: var(--primary);"><div class="section-head" style="color:var(--primary)">UP NEXT IN QUEUE</div><div id="study-queue-list" class="queue-grid"></div></div>
            <input type="text" id="inp-search" class="lib-search" placeholder="Search Database..." onkeyup="App.resetRender()">
            <div class="filter-bar"><button class="filter-btn active" onclick="App.setLibFilter('all', this)">ALL</button><button class="filter-btn" onclick="App.setLibFilter(0, this)">LVL 0</button><button class="filter-btn" onclick="App.setLibFilter(1, this)">LVL 1</button><button class="filter-btn" onclick="App.setLibFilter(2, this)">LVL 2</button><button class="filter-btn" onclick="App.setLibFilter(3, this)">LVL 3</button><button class="filter-btn" onclick="App.setLibFilter(4, this)">LVL 4</button></div>
            <div id="lib-list" style="padding-bottom:20px;"></div><button id="btn-load-more" class="load-more-btn" onclick="App.renderMore()">LOAD MORE...</button>
        </div>

        <div id="view-game" class="view-screen">
            <div class="game-top-bar">
                <div class="stage-pill" id="game-cat-pill">CATEGORY</div>
                <div class="timer-badge" id="game-timer" style="display:none">00:00</div>
                <button id="btn-audio-mode" class="audio-toggle-btn active"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg></button>
                <div class="mini-chart" id="game-chart"><div class="chart-hole"><span id="chart-pct">0%</span></div></div>
            </div>

            <div id="game-layout-wrapper">
                <div id="game-arena"></div>
                <div class="answers-grid" id="control-dock">
                    <button class="ans-btn">A</button><button class="ans-btn">B</button><button class="ans-btn">C</button><button class="ans-btn">D</button>
                </div>
            </div>
        </div>
    </main>

<script>
const DB = {
    data: {},
    async init() { return new Promise(resolve => { const t = setInterval(() => { if(typeof INTERNAL_VOCAB !== 'undefined') { this.data = INTERNAL_VOCAB; clearInterval(t); resolve(); } }, 50); }); },
    getCustomData() { try { const raw = JSON.parse(localStorage.getItem('mdc_vocab_list') || '[]'); let flat = []; const extract = (items) => { items.forEach(i => { if(i.isFolder && i.items) extract(i.items); else if(i.eng) flat.push({ en: i.eng, es: i.esp, cat: 'custom' }); }); }; extract(raw); return flat; } catch(e) { return []; } },
    get(cat) { if (Profile.cfg.source === 'custom') { return this.getCustomData().map(x => ({...x, cat: 'custom'})); } const keys = { nouns:'NOUNS', adjectives:'ADJECTIVES', verbs_reg:'REGULAR_VERBS', verbs_irreg:'IRREGULAR_VERBS', functionals:'FUNCTION WORDS' }; if (cat === 'mixed') { let all = []; Object.keys(keys).forEach(key => { const dbKey = keys[key]; const items = (this.data[dbKey] || []).map(x => ({...x, cat: key})); all = all.concat(items); }); return all; } const k = keys[cat]; return (this.data[k] || []).map(x => ({...x, cat})); },
    all() { if (Profile.cfg.source === 'custom') return this.getCustomData(); let a = []; Object.keys(this.data).forEach(k => a = a.concat(this.data[k])); return a; }
};

const Profile = {
    cfg: { count:10, time:0, theme:'dark', prog:{}, source: 'official', speed: 2, gameMode: 'meteor' },
    load() { 
        const s = localStorage.getItem('LN_V7'); if(s) this.cfg = { ...this.cfg, ...JSON.parse(s) }; this.applyDecay(); this.applyTheme(); 
        const elCount = document.getElementById('cfg-count'); const elSrc = document.getElementById('cfg-source'); const elSpd = document.getElementById('cfg-speed'); const elTime = document.getElementById('cfg-time'); const elMode = document.getElementById('cfg-mode');
        if(elCount) elCount.value = this.cfg.count; if(elSrc) elSrc.value = this.cfg.source || 'official'; if(elSpd) elSpd.value = this.cfg.speed || 2; if(elTime) elTime.value = this.cfg.time || 0; if(elMode) elMode.value = this.cfg.gameMode || 'meteor';
        this.calcStats(); 
    },
    saveCfg() { 
        this.cfg.count = parseInt(document.getElementById('cfg-count').value) || 10; 
        this.cfg.speed = parseInt(document.getElementById('cfg-speed').value) || 2; 
        this.cfg.time = parseInt(document.getElementById('cfg-time').value) || 0;
        this.cfg.gameMode = document.getElementById('cfg-mode').value;
        const srcEl = document.getElementById('cfg-source'); if(srcEl) this.cfg.source = srcEl.value; 
        this.save(); App.resetRender(); App.renderQueue(); App.updateHomeMenu(); 
    },
    save() { localStorage.setItem('LN_V7', JSON.stringify(this.cfg)); },
    applyTheme() { const doc = document.documentElement; const i = document.getElementById('theme-icon'); if(this.cfg.theme === 'light') { doc.classList.add('light-mode'); if(i) i.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>'; } else { doc.classList.remove('light-mode'); if(i) i.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'; } },
    toggleTheme() { this.cfg.theme = this.cfg.theme === 'dark' ? 'light' : 'dark'; this.applyTheme(); this.save(); },
    getData(w) { let val = this.cfg.prog[w]; if (val === undefined) return { lvl: 0, date: 0 }; if (typeof val === 'number') return { lvl: val, date: 0 }; return val; },
    setProg(w, ok) { let entry = this.getData(w); let l = entry.lvl; if(ok) { if(l < 4) l++; } else { l = Math.max(0, l - 1); } this.cfg.prog[w] = { lvl: l, date: Date.now() }; this.save(); this.calcStats(); },
    getLvl(w) { return this.getData(w).lvl; },
    getDate(w) { return this.getData(w).date; },
    wipe() { if(confirm("Clear all progress?")) { this.cfg.prog={}; this.save(); App.nav('home'); } },
    calcStats() { const k = Object.keys(this.cfg.prog); const m = k.filter(x => this.getData(x).lvl === 4).length; const elM = document.getElementById('stat-m'); const elT = document.getElementById('stat-t'); if(elM) elM.innerText = m; if(elT) elT.innerText = k.length; },
    applyDecay() { const NOW = Date.now(); const DECAY_TIME = 30 * 24 * 60 * 60 * 1000; let changed = false; Object.keys(this.cfg.prog).forEach(w => { let entry = this.cfg.prog[w]; if (typeof entry === 'object' && entry.lvl === 4) { if (NOW - entry.date > DECAY_TIME) { entry.lvl = 3; entry.date = NOW; changed = true; } } }); if(changed) this.save(); }
};

const App = {
    filterLvl: 'all', filteredResults: [], renderCount: 50, currentCat: '',
    async boot() { await DB.init(); Profile.load(); this.nav('home'); },
    nav(v) { document.querySelectorAll('.view-screen').forEach(e => e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.body.className = (v === 'home') ? 'is-home' : ''; const btnSet = document.getElementById('btn-settings-nav'); if(v === 'settings') { btnSet.classList.add('active'); this.renderQueue(); this.resetRender(); } else { btnSet.classList.remove('active'); } if(v === 'home') this.updateHomeMenu(); },
    updateHomeMenu() { const isCustom = Profile.cfg.source === 'custom'; const cards = document.querySelectorAll('.menu-card:not([data-type="mixed"])'); cards.forEach(c => { if(isCustom) c.classList.add('disabled'); else c.classList.remove('disabled'); }); },
    getSortedData(cat) { let raw = DB.get(cat); for (let i = raw.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [raw[i], raw[j]] = [raw[j], raw[i]]; } return raw.sort((a,b) => { const la = Profile.getLvl(a.en); const lb = Profile.getLvl(b.en); const getGroup = (l) => { if(l > 0 && l < 4) return 1; if(l === 0) return 2; return 3; }; const ga = getGroup(la); const gb = getGroup(lb); if(ga !== gb) return ga - gb; return Profile.getDate(a.en) - Profile.getDate(b.en); }); },
    renderQueue() { const sorted = this.getSortedData('mixed'); const sessionLimit = Profile.cfg.count; const nextBatch = sorted.slice(0, sessionLimit); const container = document.getElementById('study-queue-list'); if(!container) return; container.innerHTML = ''; if(nextBatch.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--txt-sec)">No words available.</div>'; return; } const countInfo = document.createElement('div'); countInfo.style.cssText = "font-size:11px; color:var(--primary); margin-bottom:10px; font-weight:700;"; countInfo.innerText = `NEXT ${nextBatch.length} TARGETS:`; container.appendChild(countInfo); nextBatch.forEach(w => { const lvl = Profile.getLvl(w.en); let tagClass = 'tag-new'; let tagText = 'NEW'; if(lvl === 4) { tagClass = 'tag-master'; tagText = 'MASTER'; } else if(lvl > 0) { tagClass = 'tag-review'; tagText = 'REVIEW'; } const div = document.createElement('div'); div.className = 'queue-item'; div.innerHTML = `<div><span style="font-weight:700; color:var(--txt-main)">${w.en}</span></div><div class="queue-tag ${tagClass}">${tagText} (L${lvl})</div>`; container.appendChild(div); }); },
    
    start(cat) {
        if(Profile.cfg.source === 'custom' && cat !== 'mixed') return;
        this.currentCat = cat;

        const sorted = this.getSortedData(cat);
        const queue = sorted.slice(0, Profile.cfg.count);
        if(queue.length === 0) return alert("No words found.");

        this.nav('game');
        
        // SETUP UI
        const pills = { nouns:'--c-noun', adjectives:'--c-adj', verbs_reg:'--c-reg', verbs_irreg:'--c-irreg', functionals:'--c-func', mixed: '--c-mixed', custom: '--primary' };
        const p = document.getElementById('game-cat-pill');
        if(Profile.cfg.source === 'custom') {
             p.innerText = "MY VOCABULARY";
             p.style.color = "var(--primary)"; p.style.borderColor = "var(--primary)";
        } else {
            p.innerText = cat === 'mixed' ? 'MIXED BAG' : cat.toUpperCase();
            const colorVar = cat === 'mixed' ? pills.mixed : pills[cat];
            p.style.color = `var(${colorVar})`; p.style.borderColor = `var(${colorVar})`;
        }
        
        this.updateChart();
        Game.init(queue, cat); // El Game init leerá el modo desde Profile
    },

    updateChart() {
        const all = DB.get(this.currentCat);
        const total = all.length;
        if(total === 0) return;
        const counts = [0,0,0,0,0];
        all.forEach(w => counts[Profile.getLvl(w.en)]++);
        const p4 = (counts[4] / total) * 100;
        const p3 = (counts[3] / total) * 100;
        const p2 = (counts[2] / total) * 100;
        const p1 = (counts[1] / total) * 100;
        const g = `conic-gradient(var(--success) 0% ${p4}%, var(--primary) ${p4}% ${p4+p3}%, var(--c-irreg) ${p4+p3}% ${p4+p3+p2}%, var(--danger) ${p4+p3+p2}% ${p4+p3+p2+p1}%, var(--bg-input) ${p4+p3+p2+p1}% 100%)`;
        document.getElementById('game-chart').style.background = g;
        document.getElementById('chart-pct').innerText = Math.round(p4) + '%';
    },

    setLibFilter(lvl, btn) { this.filterLvl = lvl; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); this.resetRender(); },
    resetRender() { this.renderCount = 50; this.calculateFilteredList(); this.renderLib(); },
    renderMore() { this.renderCount += 50; this.renderLib(); },
    calculateFilteredList() { const s = document.getElementById('inp-search').value; const term = s.toLowerCase(); this.filteredResults = DB.all().filter(x => { const matchesText = !s || x.en.toLowerCase().includes(term); if(!matchesText) return false; if(this.filterLvl === 'all') return true; return Profile.getLvl(x.en) === this.filterLvl; }); },
    renderLib() { const c = document.getElementById('lib-list'); c.innerHTML = ''; const btnMore = document.getElementById('btn-load-more'); if(this.filteredResults.length > this.renderCount) { btnMore.style.display = 'block'; btnMore.innerText = `LOAD MORE (${this.filteredResults.length - this.renderCount} REMAINING)`; } else { btnMore.style.display = 'none'; } const frag = document.createDocumentFragment(); this.filteredResults.slice(0, this.renderCount).forEach(w => { const l = Profile.getLvl(w.en); const pct = l * 25; const d = document.createElement('div'); d.className = `lib-card lvl-${l}`; d.innerHTML = `<div class="lib-content"><span class="lib-badge">LVL ${l}</span><div class="lib-en">${w.en}</div><div class="lib-es">${Array.isArray(w.es)?w.es[0]:w.es}</div></div><div class="prog-track"><div class="prog-fill" style="width:${pct}%"></div></div>`; frag.appendChild(d); }); c.appendChild(frag); }
};

/* ==========================================================================
   GAME ENGINE (DUAL MODE: METEOR & BUBBLE)
   ========================================================================== */
const Game = {
    queue: [], backupPool: [], currentIdx: 0, activeWord: null,
    frameReq: null, score: 0, speedFactor: 1, startTime: 0, timeLimit: 0,
    currentMode: 'meteor', // 'meteor' or 'bubble'

    init(queue, cat) {
        this.queue = queue;
        const allData = DB.get(cat);
        this.backupPool = allData.length > 4 ? allData : DB.all();
        this.currentIdx = 0;
        this.score = 0;
        this.startTime = Date.now();
        this.timeLimit = Profile.cfg.time * 60 * 1000;
        
        // LEER MODO DE JUEGO
        this.currentMode = Profile.cfg.gameMode || 'meteor';
        
        const spdCfg = Profile.cfg.speed || 2;
        this.speedFactor = spdCfg === 1 ? 0.7 : (spdCfg === 3 ? 1.6 : 1.1);

        document.getElementById('game-arena').innerHTML = '';
        
        // UI Timer
        const tEl = document.getElementById('game-timer');
        if(this.timeLimit > 0) { tEl.style.display = 'block'; } else { tEl.style.display = 'none'; }

        this.spawnNext();
        this.loop();
    },

    stop() {
        cancelAnimationFrame(this.frameReq);
        if(this.activeWord && this.activeWord.el) this.activeWord.el.remove();
        this.activeWord = null;
    },

    spawnNext() {
        if(this.currentIdx >= this.queue.length) {
            alert(`SESSION COMPLETE!`);
            this.stop();
            App.nav('home');
            return;
        }

        const wData = this.queue[this.currentIdx];
        const arena = document.getElementById('game-arena');
        const arenaH = arena.offsetHeight;

        const el = document.createElement('div');
        // APLICAR CLASE SEGUN MODO
        el.className = `game-entity mode-${this.currentMode}`;
        el.innerText = wData.en;
        el.dataset.cat = wData.cat; 
        
        let startY = 0;
        let startX = 20 + Math.random() * 60;

        if(this.currentMode === 'meteor') {
            startY = -80; // Arriba
        } else {
            startY = arenaH + 10; // Abajo
        }

        el.style.left = startX + '%';
        el.style.top = startY + 'px'; 

        arena.appendChild(el);

        this.activeWord = {
            data: wData,
            el: el,
            x: startX, // Usamos % para X
            y: startY,
            // Velocidad base
            speed: (1 + (Math.random() * 0.8)) * this.speedFactor,
            // Para efecto zig-zag de burbuja
            wiggleOffset: Math.random() * 100, 
            wiggleSpeed: 0.05
        };

        this.generateOptions(wData);
    },

    generateOptions(correctWord) {
        const dock = document.getElementById('control-dock');
        dock.innerHTML = '';
        let opts = [correctWord];
        let attempts = 0;
        while(opts.length < 4 && attempts < 100) {
            const rnd = this.backupPool[Math.floor(Math.random() * this.backupPool.length)];
            if(!opts.find(x => x.en === rnd.en)) opts.push(rnd);
            attempts++;
        }
        opts.sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'ans-btn';
            let txt = Array.isArray(opt.es) ? opt.es[0] : opt.es;
            btn.innerText = txt;
            btn.onclick = (e) => this.checkAnswer(opt, correctWord, btn, e);
            dock.appendChild(btn);
        });
    },

    checkAnswer(selected, correct, btnEl, event) {
        if(!this.activeWord) return;
        this.createLaser(btnEl, this.activeWord.el);

        if(selected.en === correct.en) {
            btnEl.classList.add('correct-flash');
            this.speak(correct.en); 
            this.explode(this.activeWord.el);
            Profile.setProg(correct.en, true);
            App.updateChart(); 
            this.activeWord = null;
            this.currentIdx++;
            setTimeout(() => this.spawnNext(), 400);
        } else {
            btnEl.classList.add('error-flash');
            this.shakeScreen();
        }
    },

    loop() {
        // 1. CHEQUEAR TIEMPO
        if(this.timeLimit > 0) {
            const now = Date.now();
            const left = this.timeLimit - (now - this.startTime);
            if(left <= 0) {
                alert("TIME'S UP!");
                this.stop();
                App.nav('home');
                return;
            }
            // Actualizar UI Reloj
            const m = Math.floor(left / 60000);
            const s = Math.floor((left % 60000) / 1000);
            document.getElementById('game-timer').innerText = `${m}:${s<10?'0':''}${s}`;
        }

        // 2. LOGICA MOVIMIENTO
        if(this.activeWord) {
            const arena = document.getElementById('game-arena');
            const arenaH = arena.offsetHeight;

            if(this.currentMode === 'meteor') {
                // Caída simple
                this.activeWord.y += this.activeWord.speed;
                
                // Limites
                if(this.activeWord.y > (arenaH - 50)) {
                    this.failWord();
                    return; // Fail maneja el reset loop
                }
            } else {
                // BURBUJA: Subida + ZigZag
                this.activeWord.y -= this.activeWord.speed * 0.7; // Suben mas lento
                
                // Oscilación horizontal
                const wiggle = Math.sin(Date.now() * 0.005 + this.activeWord.wiggleOffset) * 0.4;
                this.activeWord.x += wiggle;
                this.activeWord.el.style.left = this.activeWord.x + '%';

                // Limites (Techo)
                if(this.activeWord.y < 20) {
                    this.failWord();
                    return;
                }
            }

            this.activeWord.el.style.top = this.activeWord.y + 'px';
        }
        this.frameReq = requestAnimationFrame(() => this.loop());
    },

    failWord() {
        this.shakeScreen();
        this.speak(this.activeWord.data.en);
        
        // Fade out
        const el = this.activeWord.el;
        el.style.transition = 'opacity 0.2s, transform 0.2s';
        el.style.opacity = '0';
        el.style.transform = 'scale(0.8)';
        
        Profile.setProg(this.activeWord.data.en, false);
        App.updateChart();

        setTimeout(() => el.remove(), 200);

        this.activeWord = null;
        this.currentIdx++;
        // Continuar loop
        this.frameReq = requestAnimationFrame(() => {
            setTimeout(() => this.spawnNext(), 500);
            this.loop(); 
        });
    },

    speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 1.1; 
        window.speechSynthesis.speak(u);
    },

    explode(el) {
        const rect = el.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const computedStyle = window.getComputedStyle(el);
        const color = computedStyle.color;
        
        el.remove(); 

        for(let i=0; i<16; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.backgroundColor = color;
            p.style.boxShadow = `0 0 6px ${color}`;
            p.style.left = centerX + 'px';
            p.style.top = centerY + 'px';
            document.body.appendChild(p);

            const angle = Math.random() * Math.PI * 2;
            const velocity = 3 + Math.random() * 5;
            let vx = Math.cos(angle) * velocity;
            let vy = Math.sin(angle) * velocity;
            let life = 1.0;

            const anim = () => {
                life -= 0.04;
                if(life <= 0) { p.remove(); return; }
                
                if(this.currentMode === 'meteor') vy += 0.2; // Gravedad normal
                else vy -= 0.1; // Gravedad inversa para burbujas

                vx *= 0.95;
                const currX = parseFloat(p.style.left);
                const currY = parseFloat(p.style.top);
                p.style.left = (currX + vx) + 'px';
                p.style.top = (currY + vy) + 'px';
                p.style.opacity = life;
                p.style.transform = `scale(${life})`;
                requestAnimationFrame(anim);
            };
            requestAnimationFrame(anim);
        }
    },

    createLaser(btnEl, targetEl) {
        const rect1 = btnEl.getBoundingClientRect();
        const rect2 = targetEl.getBoundingClientRect(); 
        const x1 = rect1.left + rect1.width/2;
        const y1 = rect1.top;
        const x2 = rect2.left + rect2.width/2;
        const y2 = rect2.top + rect2.height/2;

        const laser = document.createElement('div');
        laser.className = 'laser-beam';
        const dist = Math.hypot(x2-x1, y2-y1);
        const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;
        laser.style.width = '4px'; 
        laser.style.height = dist + 'px'; 
        laser.style.left = x1 + 'px';
        laser.style.top = y1 + 'px';
        laser.style.transformOrigin = 'top center'; 
        laser.style.transform = `rotate(${angle - 90}deg)`; 
        document.body.appendChild(laser);
        requestAnimationFrame(() => { laser.style.opacity = '0'; laser.style.width = '0px'; });
        setTimeout(() => laser.remove(), 250);
        this.shakeScreen();
    },

    shakeScreen() {
        const arena = document.getElementById('game-arena');
        arena.classList.remove('shake-screen');
        void arena.offsetWidth; 
        arena.classList.add('shake-screen');
    }
};

window.onload = () => App.boot();
</script>
</body>
</html>
