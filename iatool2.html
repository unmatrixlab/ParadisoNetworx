<!DOCTYPE html>
<html lang="en">   
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Generator (Long Press Phrase Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #bb86fc;
            --text: #e0e0e0;
            --border: #333;
            --accent-active: #2196F3;
            
            /* === COLORES EXACTOS === */
            --saved-word: #ec4899; /* Rosa */
            --phrase-word: #f59e0b; /* √Åmbar */
            
            --daw-bg: #222;
            --daw-screen-bg: #050505;
        }

        body {
            font-family: 'Segoe UI', monospace, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; width: 100%; padding-bottom: 80px; 
            user-select: none; /* Importante para la experiencia app */
        }

        /* === ESTILOS DE PALABRAS === */
        
        .interactive-word { 
            cursor: pointer; 
            padding: 0 1px; 
            transition: background-color 0.2s, color 0.2s; 
            border-bottom: 2px solid transparent;
            border-radius: 2px;
            display: inline-block;
        }
        .interactive-word:hover { background: rgba(255, 255, 255, 0.1); }

        /* PALABRA SIMPLE (ROSA) */
        .interactive-word.saved { 
            color: var(--saved-word) !important; 
            font-weight: 700; 
            border-bottom: 2px solid var(--saved-word);
        }

        /* FRASE GUARDADA (√ÅMBAR - GANA A ROSA) */
        .interactive-word.phrase-saved {
            background-color: var(--phrase-word) !important;
            color: white !important;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin: 0 1px;
            font-weight: normal; 
            border-bottom: none !important; 
            text-shadow: none !important;
        }

        /* SELECCI√ìN MANUAL (PRESI√ìN LARGA) */
        .interactive-word.phrase-selecting {
            background-color: rgba(245, 158, 11, 0.5) !important; /* √Åmbar transparente */
            color: white !important;
            border: 1px dashed var(--phrase-word);
            border-radius: 4px;
        }

        /* === LAYOUT === */
        #generator-container {
            width: 100%; max-width: none; background: var(--surface);
            padding: 20px; margin: 0; border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        .hidden { display: none !important; }
        h2 { margin-top: 0; color: var(--primary); text-align: center; }

        .switch-wrapper { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 15px; font-weight: bold; font-size: 0.9em; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-active); }
        input:checked + .slider:before { transform: translateX(26px); }
        .mode-label { opacity: 0.5; transition: 0.3s; color: #aaa; }
        .mode-label.active { opacity: 1; color: white; font-weight: bold; }

        /* === VOCAB PANEL === */
        #vocab-controls {
            background: #181818; border: 1px solid #333; border-left: 4px solid #444; 
            border-radius: 6px; margin-bottom: 20px; transition: all 0.3s ease; overflow: hidden;
        }
        #vocab-controls.active-panel {
            border-left-color: var(--saved-word); background: #1f1a1d; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .vocab-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; user-select: none; }
        .vocab-toggle-wrapper { display: flex; align-items: center; gap: 12px; font-weight: 600; color: #ccc; font-size: 1rem; }
        #vocab-controls.active-panel .vocab-toggle-wrapper { color: white; text-shadow: 0 0 8px rgba(236, 72, 153, 0.4); }
        .custom-checkbox {
            appearance: none; -webkit-appearance: none; width: 40px; height: 22px; background: #333; border-radius: 20px;
            position: relative; cursor: pointer; transition: background 0.3s; flex-shrink: 0;
        }
        .custom-checkbox::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: #888; 
            border-radius: 50%; transition: transform 0.3s, background 0.3s;
        }
        .custom-checkbox:checked { background: rgba(236, 72, 153, 0.2); border: 1px solid var(--saved-word); }
        .custom-checkbox:checked::after { transform: translateX(18px); background: var(--saved-word); box-shadow: 0 0 8px var(--saved-word); }
        .vocab-badge {
            background: #252525; color: #777; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; 
            font-family: 'Roboto Mono', monospace; border: 1px solid #333;
        }
        #vocab-controls.active-panel .vocab-badge { border-color: var(--saved-word); color: var(--saved-word); background: rgba(236, 72, 153, 0.05); }
        .vocab-settings { padding: 15px; background: #141414; border-top: 1px solid #333; display: none; }

        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        @media (max-width: 600px) { .grid-container { grid-template-columns: 1fr; } } 
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #aaa; }
        input, select, textarea { width: 100%; background: #2d2d2d; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; outline: none; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; border: none; border-radius: 4px; transition: background 0.2s; }
        #btn-generate { background-color: var(--primary); color: #000; }
        #btn-paste { background-color: #03dac6; color: #000; }
        #btn-show-gen { background-color: #333; color: #fff; margin: 0; padding: 15px; display: none; width: 100%; border-radius: 0; }
        #prompt-output { margin-top: 20px; background: #000; padding: 15px; border: 1px solid var(--primary); font-family: monospace; white-space: pre-wrap; display: none; }

        /* SEARCH & RESULTS */
        #search-container { width: 100%; background: var(--surface); padding: 10px 20px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        #searchBar { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 12px; border-radius: 4px; font-size: 16px; }
        #results-container { width: 100%; padding: 0 20px 20px 20px; }
        .accordion-item { background: var(--surface); border: 1px solid var(--border); margin-bottom: 10px; border-radius: 4px; overflow: hidden; }
        .accordion-header { padding: 15px; background: #252525; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .header-content { display: flex; flex-direction: column; gap: 4px; }
        .meta-tag { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; display: inline-block; width: fit-content; }
        .btn-delete { background: transparent; color: #666; border: 1px solid #444; padding: 5px 12px; border-radius: 4px; font-size: 1.2em; }
        .accordion-content { padding: 15px; display: none; border-top: 1px solid var(--border); font-size: 0.95em; line-height: 1.6; }
        .accordion-content.active { display: block; }

        /* ACTION BUTTONS */
        .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .action-btn { border: none; padding: 8px 12px; font-size: 0.85em; border-radius: 4px; cursor: pointer; flex: 1; font-weight: bold; }
        .btn-copy { background: var(--primary); color: black; }
        .btn-save-phrase { background: #374151; color: white; border: 1px solid #4b5563; transition: all 0.2s; opacity: 0.5; pointer-events: none; }
        .btn-save-phrase.ready { opacity: 1; pointer-events: all; background: var(--phrase-word); border-color: white; }

        /* DAW AUDIO PLAYER */
        .daw-panel {
            background: linear-gradient(to bottom, #2a2a2a, #1a1a1a); border: 1px solid #444; border-radius: 6px; padding: 12px; margin: 10px 0 20px 0;
            display: flex; flex-direction: column; gap: 12px; font-family: 'Roboto Mono', monospace;
        }
        .daw-top-deck { display: flex; gap: 10px; width: 100%; height: 44px; }
        .daw-btn-play {
            width: 44px; height: 44px; background: #111; border: 2px solid #555; border-radius: 4px; color: #888;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;
        }
        .daw-btn-play.playing { color: #0f0; border-color: #0f0; background: #001100; box-shadow: 0 0 10px #0f0; }
        .daw-screen {
            flex: 1; background: var(--daw-screen-bg); border: 1px solid #333; border-radius: 2px;
            display: flex; align-items: center; padding: 0 12px; color: #06b6d4; font-size: 0.85em; overflow: hidden; white-space: nowrap;
        }
        .daw-screen.active { color: #0f0; }
        .daw-control-deck { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; }
        .daw-knob-group { display: flex; flex-direction: column; gap: 4px; }
        .daw-label { font-size: 0.65em; color: #777; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .daw-slider { -webkit-appearance: none; width: 100%; height: 24px; background: transparent; }
        .daw-slider::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #000; border: 1px solid #333; border-radius: 3px; }
        .daw-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 10px; background: #888; border: 1px solid #000; border-radius: 2px; margin-top: -7px; }
        .daw-select { background: #111; color: #ccc; border: 1px solid #444; font-family: 'Roboto Mono', monospace; font-size: 0.8em; padding: 8px; width: 100%; height: 32px; border-radius: 2px; }
        @media (min-width: 768px) {
            .daw-panel { flex-direction: row; height: 60px; }
            .daw-top-deck { width: auto; flex: 1; }
            .daw-control-deck { display: flex; gap: 20px; width: auto; }
            .daw-slider { width: 100px; }
            .daw-select { width: 140px; }
        }

        /* PILL */
        #unified-pill {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(150%);
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px;
            padding: 8px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            display: flex; align-items: center; gap: 15px; z-index: 5000; transition: transform 0.3s;
            max-width: 95%; white-space: nowrap;
        }
        #unified-pill.visible { transform: translateX(-50%) translateY(0); }
        .pill-section { display: flex; align-items: center; gap: 8px; }
        #pill-stats-text { font-family: 'Roboto Mono', monospace; font-weight: 800; font-size: 1em; color: #e5e7eb; letter-spacing: 1px; }
        .stats-active { color: var(--saved-word) !important; }
        .pill-divider { width: 1px; height: 16px; background: rgba(255,255,255,0.2); }
        #pill-trans { display: none; }
        #pill-trans.active { display: flex; }
        .trans-origin { color: #aaa; font-style: italic; font-size: 0.9em; }
        .trans-result { color: #fff; font-weight: 700; font-size: 0.95em; }
    </style>
</head>
<body>

    <div id="unified-pill">
        <div class="pill-section">
            <span style="font-size:1.1em;">üìä</span>
            <span id="pill-stats-text">- | 0</span>
        </div>
        <div id="pill-divider" class="pill-divider" style="display:none;"></div>
        <div id="pill-trans" class="pill-section">
            <span id="trans-origin" class="trans-origin">...</span>
            <span style="color:#666; font-size:0.8em; margin:0 4px;">‚Üí</span>
            <span id="trans-result" class="trans-result">...</span>
        </div>
    </div>

    <button id="btn-show-gen" onclick="toggleGenerator(true)">‚ûï New Generation</button>

    <div id="generator-container">
        <h2>Nexus Prompt Engineer</h2>
        <div class="switch-wrapper">
            <span id="labelSimple" class="mode-label active">SIMPLE</span>
            <label class="switch">
                <input type="checkbox" id="modeSwitch" onchange="toggleAlgorithmMode()">
                <span class="slider"></span>
            </label>
            <span id="labelComplex" class="mode-label">COMPLEX</span>
        </div>

        <div id="vocab-controls">
            <div class="vocab-header" onclick="document.getElementById('useVocabCheckbox').click()">
                <div class="vocab-toggle-wrapper">
                    <input type="checkbox" id="useVocabCheckbox" class="custom-checkbox" onclick="event.stopPropagation()" onchange="toggleVocabMode()">
                    <span>Inject MDC Vocab</span>
                </div>
                <span id="vocab-count-badge" class="vocab-badge">Checking DB...</span>
            </div>
            <div id="vocab-settings" class="vocab-settings">
                <div class="grid-container" style="margin-bottom:0;">
                    <div><label>Source</label><select id="vocabSource"><option value="all">üåê All Words</option><option value="highlighted">‚≠ê Highlighted</option><option value="recent">Hz Recent (10)</option><optgroup id="folder-group" label="üìÇ Folders"></optgroup></select></div>
                    <div><label>Amount (Words)</label><input type="number" id="vocabAmount" value="5" min="1" max="50"></div>
                </div>
                <div style="font-size:0.8em; color:#666; margin-top:10px; border-top:1px solid #222; padding-top:5px;">‚ÑπÔ∏è "Learning Mode" active: Topic is locked.</div>
            </div>
        </div>
        <div class="grid-container">
            <div><label>Context</label><input type="text" id="contextInput" list="context-history" placeholder="Ex: React, Finance..."></div>
            <div><label>Specific Topic</label><input type="text" id="topicInput" list="topic-history" placeholder="Ex: Hooks, ROI..."></div>
            <div><label>Mode</label><select id="modeSelect"></select></div>
            <div><label>Format</label><select id="formatSelect"></select></div>
            <div><label id="taskLabel">Task Type</label><select id="taskSelect" onchange="syncModeWithTask()"></select></div>
            <div><label>Voice</label><select id="voiceSelect"></select></div>
            <div><label>Length</label><select id="lengthSelect"></select></div>
            <div><label>Depth</label><select id="levelSelect"></select></div>
            <datalist id="context-history"></datalist><datalist id="topic-history"></datalist>
        </div>
        <div class="btn-group">
            <button id="btn-generate" onclick="generatePrompt()">‚ö° Generate Prompt</button>
            <button id="btn-paste" onclick="handlePasteResponse()">üìã Paste Response & Hide</button>
        </div>
        <div id="prompt-output"></div>
    </div>

    <div id="search-container">
        <input type="text" id="searchBar" placeholder="üîç Search saved prompts..." onkeyup="filterResults()">
    </div>

    <div id="results-container"></div>

<script>
/* 1. CONFIG DATA (ORIGINAL) */
const COMMON_DATA = {
    MODES: [ { id: 'tech', label: 'TECHNICAL', role: 'Act as a Senior Engineer.', style: 'Cyberpunk/Terminal style.', goal: 'Technical accuracy.' }, { id: 'art', label: 'ART', role: 'Act as a Creative Director.', style: 'Minimalist Gallery style.', goal: 'Aesthetic refinement.' }, { id: 'school', label: 'SCHOOL', role: 'Act as a Professor.', style: 'Textbook style.', goal: 'Education.' }, { id: 'story', label: 'STORYTELLING', role: 'Act as a Novelist.', style: 'Cinematic.', goal: 'Engagement.' }, { id: 'marketing', label: 'MARKETING', role: 'Act as a Senior Copywriter.', style: 'Persuasive.', goal: 'Conversion.' }, { id: 'business', label: 'BUSINESS', role: 'Act as a Strategy Consultant.', style: 'Executive brief.', goal: 'Clarity.' }, { id: 'research', label: 'RESEARCH', role: 'Act as a Research Scientist.', style: 'Academic.', goal: 'Evidence-based.' }, { id: 'casual', label: 'CASUAL', role: 'Act as a friend.', style: 'Conversational.', goal: 'Simplicity.' } ],
    FORMATS: [ { id: 'text', label: 'TEXT GUIDE', instruction: 'Markdown.' }, { id: 'html', label: 'HTML APP', instruction: 'Single HTML5 file.' }, { id: 'code', label: 'CODE SNIPPET', instruction: 'Raw code.' }, { id: 'essay', label: 'ESSAY', instruction: 'Formal essay.' }, { id: 'dialogue', label: 'DIALOGUE', instruction: 'Scripted scene.' }, { id: 'template', label: 'TEMPLATE', instruction: 'Structured template.' }, { id: 'checklist', label: 'CHECKLIST', instruction: 'Actionable checklist.' } ]
};
const VOCAB_TASKS = [ { id: 'v_story', label: 'üìñ Story', instruction: 'Write a story.', linkedMode: 'story' }, { id: 'v_quiz', label: '‚ùì Quiz', instruction: 'Create a quiz.', linkedMode: 'school' }, { id: 'v_dialogue', label: 'üí¨ Dialogue', instruction: 'Roleplay.', linkedMode: 'casual' }, { id: 'v_sentences', label: '‚úçÔ∏è Sentences', instruction: 'Drill sentences.', linkedMode: 'school' }, { id: 'v_explain', label: 'üß† Explain', instruction: 'Deep dive.', linkedMode: 'research' } ];
const ALGORITHMS = { 
    SIMPLEX: { TASK_TYPES: [{id:'explain', label:'EXPLAIN', instruction:'Clear explanation.'}, {id:'analysis', label:'ANALYSIS', instruction:'Breakdown.'}, {id:'create', label:'CREATIVE', instruction:'Generate original content.'}, {id:'teach', label:'TEACHING', instruction:'Education.'}, {id:'improve', label:'IMPROVE', instruction:'Rewrite.'}, {id:'compare', label:'COMPARE', instruction:'Comparison.'}, {id:'build', label:'BUILD', instruction:'Construct.'}], VOICES: [{id:'neutral', label:'Neutral', instruction:'Balanced.'}, {id:'friendly', label:'Friendly', instruction:'Warm.'}, {id:'authoritative', label:'Expert', instruction:'Confident.'}, {id:'poetic', label:'Poetic', instruction:'Flowery.'}, {id:'concise', label:'Concise', instruction:'Short.'}], LENGTH: [{id:'short', label:'SHORT', instruction:'2 paragraphs.'}, {id:'medium', label:'MEDIUM', instruction:'6 paragraphs.'}, {id:'long', label:'LONG', instruction:'Detailed.'}], FADER_LEVELS: ["- Level 1", "- Level 2", "- Level 3", "- Level 4", "- Level 5"], RESTRICTIONS: ["No filler."] },
    COMPLEX: { TASK_TYPES: [{id:'explain', label:'DEMYSTIFY', instruction:'First principles.'}, {id:'analysis', label:'DECONSTRUCT', instruction:'Root causes.'}, {id:'create', label:'IDEATE', instruction:'Novel synthesis.'}, {id:'teach', label:'MASTERY', instruction:'Scaffolded.'}, {id:'improve', label:'ELEVATE', instruction:'Optimize.'}, {id:'compare', label:'EVALUATE', instruction:'Trade-offs.'}, {id:'build', label:'ARCHITECT', instruction:'Logical artifact.'}], VOICES: [{id:'neutral', label:'Objective', instruction:'Factual.'}, {id:'friendly', label:'Collaborative', instruction:'Safe.'}, {id:'authoritative', label:'Expert', instruction:'Decisive.'}, {id:'poetic', label:'Evocative', instruction:'Metaphorical.'}, {id:'concise', label:'Surgical', instruction:'Dense.'}], LENGTH: [{id:'short', label:'ATOMIC', instruction:'Impact.'}, {id:'medium', label:'COMPREHENSIVE', instruction:'Detailed.'}, {id:'long', label:'EXHAUSTIVE', instruction:'Full.'}], FADER_LEVELS: ["- Level 1", "- Level 2", "- Level 3", "- Level 4", "- Level 5"], RESTRICTIONS: ["Strict format."] }
};

/* 2. STATE */
let currentData = ALGORITHMS.SIMPLEX; let nexusHistory = []; let availableVoices = [];
const NEXUS_KEY='nexus_prompt_history', MDC_KEY='mdc_vocab_list', PREF_VOICE='nexus_audio_voice', PREF_SPEED='nexus_audio_speed';
let currentStatsContext = null, currentWordStats = {occurrences:"-", uniqueTotal:0}, lastStorageString = "";
let pressTimer, isLongPressHandled = false; // VARS PARA LONG PRESS

/* 3. INIT */
document.addEventListener('DOMContentLoaded', () => {
    populateSelect('modeSelect', COMMON_DATA.MODES); populateSelect('formatSelect', COMMON_DATA.FORMATS); updateDynamicDropdowns();
    loadHistory('contextInput','context-history'); loadHistory('topicInput','topic-history'); loadNexusHistory(); loadVocabFolders(); startStorageWatcher();
    if(window.speechSynthesis) { window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices(); }
});

/* CORE LOGIC: PHRASES (SLIDING WINDOW) */
function startStorageWatcher() {
    lastStorageString = localStorage.getItem(MDC_KEY) || "";
    setInterval(() => {
        const cur = localStorage.getItem(MDC_KEY) || "";
        if(cur !== lastStorageString) { lastStorageString = cur; loadVocabFolders(); refreshActiveView(); }
    }, 500);
}

function refreshActiveView() {
    const activeContent = document.querySelector('.accordion-content.active .interactive-content');
    if (!activeContent) return;

    // 1. OBTENER DATOS
    const rawData = JSON.parse(localStorage.getItem(MDC_KEY) || '[]');
    const savedWordsSet = new Set();
    const savedPhrases = [];
    const extract = (obj) => {
        const t = sanitizeText(obj.eng).toLowerCase();
        if(t.includes(" ")) savedPhrases.push(t); else savedWordsSet.add(t);
    };
    rawData.forEach(i => { if(i.isFolder && i.items) i.items.forEach(extract); else if(i.eng) extract(i); });

    // 2. LIMPIAR (Pero NO si el usuario est√° seleccionando manualmente)
    const elements = Array.from(activeContent.querySelectorAll('.interactive-word'));
    elements.forEach(el => {
        if (!el.classList.contains('phrase-selecting')) {
            el.classList.remove('saved', 'phrase-saved');
        }
    });

    // 3. PINTAR ROSA
    elements.forEach(el => {
        const clean = sanitizeText(el.innerText).toLowerCase();
        if (savedWordsSet.has(clean) && !el.classList.contains('phrase-selecting')) {
            el.classList.add('saved');
        }
    });

    // 4. PINTAR √ÅMBAR (Gana a rosa)
    savedPhrases.sort((a,b) => b.length - a.length);
    const textArr = elements.map(el => sanitizeText(el.innerText).toLowerCase());

    savedPhrases.forEach(phrase => {
        const pArr = phrase.split(" ");
        for (let i = 0; i <= textArr.length - pArr.length; i++) {
            let match = true;
            for (let j = 0; j < pArr.length; j++) { if (textArr[i + j] !== pArr[j]) { match = false; break; } }
            if (match) {
                for (let k = 0; k < pArr.length; k++) {
                    const el = elements[i + k];
                    if (!el.classList.contains('phrase-selecting')) {
                        el.classList.remove('saved'); 
                        el.classList.add('phrase-saved');
                    }
                }
            }
        }
    });

    currentStatsContext = activeContent; updateUnifiedPill();
}

/* === INTERACCI√ìN: LONG PRESS (500ms) === */
function startPress(el) {
    isLongPressHandled = false;
    pressTimer = setTimeout(() => {
        handleLongPress(el);
        isLongPressHandled = true;
    }, 500); // 0.5 segundos
}

function endPress(el, e) {
    clearTimeout(pressTimer);
    if (e.type === 'touchend' && isLongPressHandled) {
        e.preventDefault(); 
    }
}

function handleShortClick(el) {
    if (isLongPressHandled) return;
    saveWordToMDC(el.innerText, el);
}

function handleLongPress(el) {
    if (navigator.vibrate) navigator.vibrate(50);
    el.classList.toggle('phrase-selecting');
    checkSelectionState(el);
}

function checkSelectionState(elementContext) {
    const parent = elementContext.closest('.accordion-content');
    const selected = parent.querySelectorAll('.phrase-selecting');
    const saveBtn = parent.querySelector('.btn-save-phrase');
    
    if (selected.length > 0) {
        saveBtn.classList.add('ready');
        saveBtn.innerText = `üíæ Save Phrase (${selected.length})`;
    } else {
        saveBtn.classList.remove('ready');
        saveBtn.innerText = `üíæ Save Phrase`;
    }
}

function savePhraseSelection(btn) {
    const parent = btn.closest('.accordion-content');
    const selected = Array.from(parent.querySelectorAll('.phrase-selecting'));
    if (selected.length === 0) return;

    selected.sort((a,b) => parseInt(a.dataset.idx) - parseInt(b.dataset.idx));
    const phrase = selected.map(el => sanitizeText(el.innerText)).join(" ");
    
    // GUARDAR STRICTO: esp = ""
    forceSave(phrase, parent, true); 
    
    selected.forEach(el => el.classList.remove('phrase-selecting'));
    btn.classList.remove('ready'); btn.innerText = "üíæ Save Phrase";
    refreshActiveView();
}

/* SAVE LOGIC */
function forceSave(text, contextEl, isPhrase) {
    if(!text) return;
    let items = JSON.parse(localStorage.getItem(MDC_KEY) || '[]');
    const check = text.toLowerCase();
    
    // Check duplicates
    let exists = false;
    items.forEach(i => {
        if(!i.isFolder && i.eng && sanitizeText(i.eng).toLowerCase()===check) exists=true;
        if(i.isFolder) i.items.forEach(s => { if(sanitizeText(s.eng).toLowerCase()===check) exists=true; });
    });
    
    if(exists) { if(isPhrase) alert("Phrase already saved."); return; }

    const header = contextEl.closest('.accordion-item').querySelector('.header-content strong').innerText.trim();
    // REQUISITO: esp vac√≠o
    const newItem = { id:Date.now(), isFolder:false, eng:text, esp:"", isHighlighted:false, dateAdded:Date.now() };
    
    let target = items.find(i => i.isFolder && i.name.toLowerCase()===header.toLowerCase());
    if(target) { target.items.unshift(newItem); items = items.filter(i=>i.id!==target.id); items.unshift(target); }
    else { items.unshift({id:Date.now()+1, isFolder:true, name:header, items:[newItem]}); }
    
    localStorage.setItem(MDC_KEY, JSON.stringify(items));
}

function saveWordToMDC(word, el) {
    translateWord(word);
    const text = sanitizeText(word); if(!text) return;
    
    // Check if exists -> Toggle (Delete or Save)
    let items = JSON.parse(localStorage.getItem(MDC_KEY) || '[]');
    const check = text.toLowerCase();
    let found = false;
    items.forEach(i => { if(!i.isFolder && sanitizeText(i.eng).toLowerCase()===check) found=true; if(i.isFolder) i.items.forEach(s=>{ if(sanitizeText(s.eng).toLowerCase()===check) found=true; }); });

    if(!found) forceSave(text, el.closest('.accordion-content'), false);
    else {
        // DELETE
        items.forEach(f => { if(f.isFolder) f.items = f.items.filter(s => sanitizeText(s.eng).toLowerCase()!==check); });
        items = items.filter(i => i.isFolder || sanitizeText(i.eng).toLowerCase()!==check);
        localStorage.setItem(MDC_KEY, JSON.stringify(items));
    }
}

/* HELPERS & UI */
function sanitizeText(t) { if(!t) return ""; return t.replace(/['`‚Äò¬¥]/g, "‚Äô").replace(/[^a-zA-Z0-9\u00C0-\u017F\s‚Äô]/g, "").trim(); }
function formatInteractiveContent(txt) {
    if(!txt) return "";
    let i=0; 
    return txt.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").split(/(\s+)/).map(t => {
        if(t.match(/^\s+$/)) return t;
        // EVENTOS AGREGADOS PARA LONG PRESS
        const s = `<span class="interactive-word" data-idx="${i}" 
            onmousedown="startPress(this)" 
            ontouchstart="startPress(this)" 
            onmouseup="endPress(this, event)" 
            ontouchend="endPress(this, event)"
            onclick="handleShortClick(this)">${t}</span>`;
        i++; return s;
    }).join('');
}

function updateUnifiedPill(trans) {
    const pill = document.getElementById('unified-pill');
    if(!currentStatsContext) { pill.classList.remove('visible'); return; }
    pill.classList.add('visible');
    const saved = currentStatsContext.querySelectorAll('.interactive-word.saved, .interactive-word.phrase-saved');
    const uniq = new Set(); saved.forEach(el => uniq.add(sanitizeText(el.innerText).toLowerCase()));
    const stats = document.getElementById('pill-stats-text');
    stats.innerText = `${saved.length} | ${uniq.size}`;
    if(uniq.size>0) stats.classList.add('stats-active'); else stats.classList.remove('stats-active');
    const tPanel = document.getElementById('pill-trans');
    if(trans) { 
        document.getElementById('pill-divider').style.display='block'; tPanel.classList.add('active');
        document.getElementById('trans-origin').innerText = trans.origin; document.getElementById('trans-result').innerText = trans.result;
    } else if(!tPanel.dataset.hasActive) {
        document.getElementById('pill-divider').style.display='none'; tPanel.classList.remove('active');
    }
}
async function translateWord(text) {
    const p = document.getElementById('pill-trans'); p.dataset.hasActive="1";
    updateUnifiedPill({origin:text.substring(0,12)+"..", result:"..."});
    try {
        const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=es&dt=t&q=${encodeURIComponent(text)}`);
        const d = await r.json();
        updateUnifiedPill({origin:text.substring(0,12)+"..", result:d[0][0][0]});
    } catch(e){ updateUnifiedPill({origin:text, result:"Error"}); }
    setTimeout(()=>{ p.dataset.hasActive=""; updateUnifiedPill(); }, 4000);
}

function toggleAccordion(id) {
    const c = document.getElementById(`content-${id}`);
    const vis = c.classList.contains('active');
    document.querySelectorAll('.accordion-content').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.phrase-selecting').forEach(x=>x.classList.remove('phrase-selecting'));
    document.querySelectorAll('.btn-save-phrase').forEach(b=>{b.classList.remove('ready'); b.innerText="üíæ Save Phrase";});
    
    if(!vis) { c.classList.add('active'); setTimeout(refreshActiveView, 50); }
    else { currentStatsContext=null; updateUnifiedPill(); }
}

function renderAccordionDOM(data) {
    const div = document.createElement('div'); div.className = 'accordion-item'; div.id = `item-${data.id}`;
    const html = formatInteractiveContent(data.content);
    div.innerHTML = `
        <div class="accordion-header" onclick="toggleAccordion(${data.id})">
            <div class="header-content"><span class="meta-tag">${data.modeName}</span><strong>${data.topic}</strong></div>
            <div class="header-actions"><button class="btn-delete" onclick="deleteItem(event, ${data.id})">üóëÔ∏è</button><span>‚ñº</span></div>
        </div>
        <div class="accordion-content" id="content-${data.id}">
            <div class="daw-panel">
                <div class="daw-top-deck"><button id="play-${data.id}" class="daw-btn-play" onclick="toggleAudio(${data.id})">‚ñ∂</button><div class="daw-screen" id="screen-${data.id}">MASTER OUT</div></div>
                <div class="daw-control-deck">
                    <div class="daw-knob-group"><span class="daw-label">SPEED</span><input type="range" id="speed-${data.id}" class="daw-slider" min="0.5" max="2.0" step="0.1" value="1" oninput="updateAudioLive(${data.id})"></div>
                    <div class="daw-knob-group"><span class="daw-label">VOICE</span><select id="voice-${data.id}" class="daw-select" onchange="updateAudioLive(${data.id})"></select></div>
                </div>
            </div>
            <div class="action-row">
                <button class="action-btn btn-save-phrase" onclick="savePhraseSelection(this)">üíæ Save Phrase</button>
                <button class="action-btn btn-copy" onclick="copyTextToClipboard(this)">üìú Copy Prompt</button>
            </div>
            <div style="display:none;">${data.prompt}</div><hr style="border:0; border-top:1px solid #444; margin:10px 0;">
            <div class="interactive-content" style="white-space: pre-wrap;">${html}</div>
        </div>`;
    const c = document.getElementById('results-container');
    if(!document.getElementById(`item-${data.id}`)) { if(c.firstChild) c.insertBefore(div, c.firstChild); else c.appendChild(div); }
    setTimeout(()=>updateVoiceSelect(document.getElementById(`voice-${data.id}`)), 100);
}

/* APP UTILS */
function toggleAlgorithmMode() { document.getElementById('modeSwitch').checked ? (currentData=ALGORITHMS.COMPLEX, document.getElementById('labelComplex').classList.add('active'), document.getElementById('labelSimple').classList.remove('active')) : (currentData=ALGORITHMS.SIMPLEX, document.getElementById('labelSimple').classList.add('active'), document.getElementById('labelComplex').classList.remove('active')); updateDynamicDropdowns(); }
function updateDynamicDropdowns() { if(!document.getElementById('useVocabCheckbox').checked) populateSelect('taskSelect', currentData.TASK_TYPES); populateSelect('voiceSelect', currentData.VOICES); populateSelect('lengthSelect', currentData.LENGTH); const l=document.getElementById('levelSelect'); l.innerHTML=''; currentData.FADER_LEVELS.forEach(x=>{let o=document.createElement('option'); o.value=x; o.textContent=x.split(':')[0]; l.appendChild(o);}); }
function populateSelect(id, arr) { const s=document.getElementById(id); s.innerHTML=''; arr.forEach(i=>{let o=document.createElement('option'); o.value=i.id; o.textContent=i.label; s.appendChild(o);}); }
function loadHistory(i,l) { const h=JSON.parse(localStorage.getItem(i+'_mem')||'[]'); const d=document.getElementById(l); if(d){d.innerHTML=''; h.forEach(x=>{let o=document.createElement('option'); o.value=x; d.appendChild(o);});} }
function saveToHistory(i) { const v=document.getElementById(i).value.trim(); if(!v)return; let h=JSON.parse(localStorage.getItem(i+'_mem')||'[]'); h=h.filter(x=>x!==v); h.unshift(v); if(h.length>5)h.pop(); localStorage.setItem(i+'_mem',JSON.stringify(h)); loadHistory(i,document.getElementById(i).getAttribute('list')); }
function toggleVocabMode() { const c=document.getElementById('useVocabCheckbox').checked; document.getElementById('vocab-settings').style.display=c?'block':'none'; document.getElementById('vocab-controls').classList.toggle('active-panel', c); c?(loadVocabFolders(),document.getElementById('topicInput').value="Target Vocab",document.getElementById('topicInput').disabled=true,document.getElementById('taskSelect').innerHTML='',VOCAB_TASKS.forEach(t=>{let o=document.createElement('option');o.value=t.id;o.textContent=t.label;document.getElementById('taskSelect').appendChild(o);}),syncModeWithTask()):(document.getElementById('topicInput').value="",document.getElementById('topicInput').disabled=false,updateDynamicDropdowns()); }
function loadVocabFolders() { const r=localStorage.getItem(MDC_KEY); const g=document.getElementById('folder-group'); const b=document.getElementById('vocab-count-badge'); if(!r){b.innerText="No DB";return;} const d=JSON.parse(r); g.innerHTML=''; let t=0; d.forEach(i=>{if(i.isFolder){let o=document.createElement('option');o.value=`folder:${i.id}`;o.textContent=`${i.name} (${i.items.length})`;g.appendChild(o);t+=i.items.length;}else t++;}); b.innerText=`${t} words`; b.style.color="#00ffcc"; }
function syncModeWithTask() { if(!document.getElementById('useVocabCheckbox').checked)return; const t=VOCAB_TASKS.find(x=>x.id===document.getElementById('taskSelect').value); if(t) document.getElementById('modeSelect').value=t.linkedMode; }
function getSelectedVocab() { if(!document.getElementById('useVocabCheckbox').checked) return null; const s=document.getElementById('vocabSource').value; const amt=parseInt(document.getElementById('vocabAmount').value); const r=localStorage.getItem(MDC_KEY); if(!r)return[]; const d=JSON.parse(r); let p=[]; if(s==='all') d.forEach(i=>i.isFolder?p.push(...i.items):p.push(i)); else if(s==='highlighted') d.forEach(i=>{if(i.isFolder)p.push(...i.items.filter(x=>x.isHighlighted));else if(i.isHighlighted)p.push(i);}); else if(s.startsWith('folder:')) { const f=d.find(i=>i.id===parseInt(s.split(':')[1])); if(f)p=f.items; } else if(s==='recent') { let a=[]; d.forEach(i=>i.isFolder?a.push(...i.items):a.push(i)); a.sort((x,y)=>y.id-x.id); p=a.slice(0,10); } return p.sort(()=>0.5-Math.random()).slice(0,amt).map(i=>i.eng); }
function loadVoices() { availableVoices=window.speechSynthesis.getVoices().filter(v=>v.lang.startsWith('en')); document.querySelectorAll('.daw-select').forEach(s=>updateVoiceSelect(s)); }
function updateVoiceSelect(s) { const sv=localStorage.getItem(PREF_VOICE); s.innerHTML=''; availableVoices.forEach(v=>{let o=document.createElement('option');o.value=v.voiceURI;o.textContent=v.name.substring(0,18);s.appendChild(o);}); if(sv)s.value=sv; }
function updateAudioLive(id) { const sp=document.getElementById(`speed-${id}`).value; const v=document.getElementById(`voice-${id}`).value; localStorage.setItem(PREF_SPEED,sp); localStorage.setItem(PREF_VOICE,v); document.getElementById(`screen-${id}`).innerText=`SPD:${sp}x`; if(document.getElementById(`play-${id}`).classList.contains('playing')) speakContent(id); }
function toggleAudio(id) { const b=document.getElementById(`play-${id}`); b.classList.contains('playing')?window.speechSynthesis.cancel():speakContent(id); }
function speakContent(id) { window.speechSynthesis.cancel(); const txt=document.querySelector(`#content-${id} .interactive-content`).innerText; const u=new SpeechSynthesisUtterance(txt); const v=availableVoices.find(x=>x.voiceURI===document.getElementById(`voice-${id}`).value); if(v)u.voice=v; u.rate=parseFloat(document.getElementById(`speed-${id}`).value); const b=document.getElementById(`play-${id}`); u.onstart=()=>{b.classList.add('playing');b.innerHTML='‚óè';}; u.onend=()=>{b.classList.remove('playing');b.innerHTML='‚ñ∂';}; window.speechSynthesis.speak(u); }
function loadNexusHistory() { const s=localStorage.getItem(NEXUS_KEY); if(s) JSON.parse(s).reverse().forEach(d=>renderAccordionDOM(d)); }
function addToNexusHistory(d) { nexusHistory.unshift(d); localStorage.setItem(NEXUS_KEY,JSON.stringify(nexusHistory)); }
function removeFromNexusHistory(id) { nexusHistory=nexusHistory.filter(x=>x.id!==id); localStorage.setItem(NEXUS_KEY,JSON.stringify(nexusHistory)); }
function generatePrompt() { const isVocabMode = document.getElementById('useVocabCheckbox').checked; let context = document.getElementById('contextInput').value; let topic = document.getElementById('topicInput').value; let vocabBlock = ""; let selectedTask = null; if (isVocabMode) { const words = getSelectedVocab(); if (words && words.length > 0) { vocabBlock = `\n<target_vocabulary_list>\n${words.join(', ')}\n</target_vocabulary_list>\n\n**MANDATORY INSTRUCTION:** 1. You MUST incorporate the words inside the <target_vocabulary_list> tags into your response.\n2. Formatting Rule: Mark every used word in **bold** (e.g., **word**).\n`; topic = "English Vocabulary Practice"; const taskId = document.getElementById('taskSelect').value; selectedTask = VOCAB_TASKS.find(t => t.id === taskId); if(!selectedTask) selectedTask = VOCAB_TASKS[0]; } else { alert("No vocabulary found!"); return; } } else { selectedTask = currentData.TASK_TYPES.find(t => t.id === document.getElementById('taskSelect').value); } const mode = COMMON_DATA.MODES.find(m => m.id === document.getElementById('modeSelect').value); const format = COMMON_DATA.FORMATS.find(f => f.id === document.getElementById('formatSelect').value); const voice = currentData.VOICES.find(v => v.id === document.getElementById('voiceSelect').value); const len = currentData.LENGTH.find(l => l.id === document.getElementById('lengthSelect').value); const level = document.getElementById('levelSelect').value; const prompt = `# SYSTEM IDENTITY & CORE OBJECTIVE\nYou are an advanced AI acting strictly as: **${mode.role}**\nYour style must be: ${mode.style}\n**Primary Goal:** ${mode.goal}\n\n# PROJECT CONTEXT\nI need you to perform a specific task based on the following parameters:\n- **Context:** ${context || "General"}\n- **Subject/Topic:** ${topic}\n- **Task Type:** ${selectedTask.label} -> ${selectedTask.instruction}\n\n${vocabBlock ? `\n# MANDATORY DATA (Vocabulary)${vocabBlock}\n` : ''}\n\n# RESPONSE GUIDELINES\nFollow these configuration rules strictly:\n1. **Format:** ${format.label} (${format.instruction})\n2. **Tone:** ${voice.instruction}\n3. **Length:** ${len.instruction}\n4. **Depth Level:** ${level}\n\n# CRITICAL INSTRUCTIONS & RESTRICTIONS\nTo ensure high quality, follow this logic:\n- Think step-by-step before generating.\n- Analyze the "${topic}" within the context of "${context}".\n- ${currentData.RESTRICTIONS.join('\n- ')}\n\n---\n**BEGIN RESPONSE:**`.trim(); const outputDiv = document.getElementById('prompt-output'); outputDiv.style.display = 'block'; outputDiv.textContent = prompt; navigator.clipboard.writeText(prompt); lastGeneratedPrompt = prompt; if(!isVocabMode) { saveToHistory('contextInput'); saveToHistory('topicInput'); } }
async function handlePasteResponse() { try { const text = await navigator.clipboard.readText(); if(!text) return alert("Clipboard is empty."); const data = { id: Date.now(), modeName: document.getElementById('modeSelect').options[document.getElementById('modeSelect').selectedIndex].text, topic: document.getElementById('topicInput').value || "Untitled Result", prompt: lastGeneratedPrompt, content: text }; addToNexusHistory(data); renderAccordionDOM(data); toggleGenerator(false); } catch (err) { alert("Error reading clipboard."); } }
function toggleGenerator(show) { const gen = document.getElementById('generator-container'); const btnShow = document.getElementById('btn-show-gen'); if (show) { gen.classList.remove('hidden'); btnShow.style.display = 'none'; } else { gen.classList.add('hidden'); btnShow.style.display = 'block'; } }
function deleteItem(event, id) { event.stopPropagation(); if(confirm("Delete result?")) { const el = document.getElementById(`item-${id}`); if(el) el.remove(); removeFromNexusHistory(id); } }
function copyTextToClipboard(btnElement) { const promptText = btnElement.parentElement.nextElementSibling.innerText; navigator.clipboard.writeText(promptText).then(() => { const originalText = btnElement.innerText; btnElement.innerText = "Copied!"; setTimeout(() => btnElement.innerText = originalText, 1500); }); }
function filterResults() { const query = document.getElementById('searchBar').value.toLowerCase(); const items = document.querySelectorAll('.accordion-item'); items.forEach(item => { const topic = item.querySelector('.header-content strong').innerText.toLowerCase(); const content = item.querySelector('.interactive-content').innerText.toLowerCase(); if (topic.includes(query) || content.includes(query)) item.style.display = "block"; else item.style.display = "none"; }); }
</script>
</body>
</html>
