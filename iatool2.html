<!DOCTYPE html>
<html lang="en">   
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Generator (Visual Grid V7 - Full UI)</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
   <style>
    /* =========================================
       MDC V16 COLOR PALETTE 
       ========================================= */
    :root {
        --bg: #111827;             /* Deep Blue Gray BG */
        --surface: #1f2937;       /* Panel BG */
        --primary: #6366f1;       /* Indigo Primary */
        --text: #f3f4f6;          /* Main Text */
        --border: #374151;        /* Subtle Borders */
        
        --accent-active: #6366f1; 
        --danger: #ef4444;        
        --success: #10b981;        
        
        --saved-word: #f472b6;    /* V16 Pink */
        --phrase-word: #fbbf24;   /* Amber Bright */
        
        --daw-bg: #1f2937;        
        --daw-screen-bg: #000;    
        --daw-text: #10b981;      
        
        --text-muted: #9ca3af;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Segoe UI', monospace, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0; padding: 0;
        display: flex; flex-direction: column; align-items: center;
        overflow-x: hidden; width: 100%; padding-bottom: 80px; 
        
        -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; 
    }

    input, textarea, select {
        -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; user-select: text !important; cursor: text;
    }

    /* === LAYOUT === */
    #generator-container {
        width: 100%; max-width: none; background: var(--surface);
        padding: 20px; margin: 0; border-bottom: 1px solid var(--border);
        transition: all 0.3s ease;
    }
    .hidden { display: none !important; }
    h2 { margin-top: 0; color: var(--primary); text-align: center; }

    /* === INPUTS & GRID === */
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    @media (max-width: 600px) { .grid-container { grid-template-columns: 1fr; } } 
    
    label { display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-muted); }
    input, select, textarea { 
        width: 100%; background: var(--surface); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; outline: none; 
    }
    input:disabled { opacity: 0.5; cursor: not-allowed; background: var(--bg); border-color: var(--border); color: var(--text-muted); }
    
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    button { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; border: none; border-radius: 4px; transition: background 0.2s; }
    
    #btn-generate { background-color: var(--primary); color: white; }
    #btn-paste { background-color: var(--success); color: white; }
    #btn-show-gen { background-color: var(--surface); color: #fff; margin: 0; padding: 15px; display: none; width: 100%; border-radius: 0; }
    #prompt-output { margin-top: 20px; background: #000; padding: 15px; border: 1px solid var(--primary); font-family: monospace; white-space: pre-wrap; display: none; }

    /* === MODAL & GRID SELECTION CSS === */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 9999;
        display: none; justify-content: center; align-items: center; padding: 20px;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-content {
        background: var(--bg); border: 1px solid var(--border); width: 100%; max-width: 800px; max-height: 90vh;
        border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        position: relative; padding-bottom: 0; overflow: hidden;
    }
    .modal-header {
        padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        background: var(--surface); border-radius: 12px 12px 0 0;
    }
    .modal-header h3 { margin: 0; color: var(--text); }
    .close-modal-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0; flex: 0; }

    .modal-search-bar { padding: 10px 20px; background: var(--bg); border-bottom: 1px solid var(--border); }
    #modalSearch { width: 100%; background: var(--surface); border: 1px solid var(--border); padding: 12px; border-radius: 6px; color: white; font-size: 1rem; }

    .mode-grid-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 220px; }
    .mode-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }

    .grid-category-header {
        grid-column: 1 / -1; color: var(--primary); font-size: 0.85em; font-weight: 700;
        text-transform: uppercase; letter-spacing: 1px; margin-top: 15px; margin-bottom: 5px;
        border-bottom: 1px solid var(--border); padding-bottom: 5px;
    }
    .grid-category-header:first-child { margin-top: 0; }

    .mode-card {
        background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 15px 10px; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        transition: all 0.2s ease; height: 110px; position: relative;
    }
    .mode-card:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); transform: translateY(-2px); }
    .mode-card.selected { border-color: var(--success); background: rgba(16, 185, 129, 0.1); box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); }
    .mode-card.active-preview { border-color: var(--primary); background: rgba(99, 102, 241, 0.2); transform: scale(1.02); }
    .mode-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .mode-label { font-size: 0.85rem; font-weight: 600; color: var(--text); line-height: 1.2; }
    .mode-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; }

    .custom-select-trigger { display: flex; gap: 8px; }
    .btn-select-mode {
        background: var(--surface); border: 1px solid var(--border); color: var(--primary); flex: 0 0 40px;
        display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; border-radius: 4px;
    }
    .btn-select-mode:hover { background: var(--border); }
    .display-input { cursor: pointer; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; font-weight: 600; color: var(--text); }

    /* === PREVIEW PANEL === */
    .preview-panel {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 190px;
        background: rgba(17, 24, 39, 0.98); border-top: 1px solid var(--primary);
        padding: 15px 20px; display: flex; flex-direction: column;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 10; transition: transform 0.3s ease;
    }
    .preview-panel.hidden-panel { transform: translateY(100%); }
    .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .preview-title { font-size: 1.1em; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .preview-details { display: grid; grid-template-columns: 1fr; gap: 6px; font-size: 0.85em; color: var(--text-muted); overflow-y: auto; flex: 1; margin-bottom: 10px; }
    .detail-row strong { color: var(--text); margin-right: 5px; }
    .btn-confirm-selection {
        background: var(--success); color: white; border: none; padding: 10px;
        border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem;
        display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;
    }
    .btn-confirm-selection:hover { background: #059669; }

    /* === VOCAB PANEL === */
    #vocab-controls {
        background: var(--bg); border: 1px solid var(--border); border-left: 4px solid var(--border);
        border-radius: 6px; margin-bottom: 20px; transition: all 0.3s ease; overflow: hidden;
    }
    #vocab-controls.active-panel { border-left-color: var(--saved-word); background: rgba(244, 114, 182, 0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .vocab-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; user-select: none; }
    .vocab-toggle-wrapper { display: flex; align-items: center; gap: 12px; font-weight: 600; color: var(--text-muted); font-size: 1rem; transition: color 0.3s; }
    #vocab-controls.active-panel .vocab-toggle-wrapper { color: white; text-shadow: 0 0 8px rgba(244, 114, 182, 0.4); }
    .custom-checkbox {
        appearance: none; -webkit-appearance: none; width: 40px; height: 22px; 
        background: var(--border); border-radius: 20px; position: relative; cursor: pointer; transition: background 0.3s; flex-shrink: 0;
    }
    .custom-checkbox::after {
        content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
        background: var(--text-muted); border-radius: 50%; transition: transform 0.3s, background 0.3s;
    }
    .custom-checkbox:checked { background: rgba(244, 114, 182, 0.2); border: 1px solid var(--saved-word); }
    .custom-checkbox:checked::after { transform: translateX(18px); background: var(--saved-word); box-shadow: 0 0 8px var(--saved-word); }
    .vocab-badge {
        background: var(--surface); color: var(--text-muted); padding: 4px 8px; border-radius: 4px;
        font-size: 0.75rem; font-family: 'Roboto Mono', monospace; letter-spacing: 0.5px;
        border: 1px solid var(--border); white-space: nowrap; transition: all 0.3s;
    }
    #vocab-controls.active-panel .vocab-badge { border-color: var(--saved-word); color: var(--saved-word); background: rgba(244, 114, 182, 0.05); }
    .vocab-settings { padding: 15px; background: var(--bg); border-top: 1px solid var(--border); display: none; animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* === SEARCH & RESULTS === */
    #search-container { width: 100%; background: var(--surface); padding: 10px 20px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
    #searchBar { width: 100%; background: var(--bg); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 4px; font-size: 16px; }
    #results-container { width: 100%; padding: 0 20px 20px 20px; }
    .accordion-item { background: var(--surface); border: 1px solid var(--border); margin-bottom: 10px; border-radius: 4px; overflow: hidden; }
    .accordion-header { padding: 15px; background: rgba(255,255,255,0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .header-content { display: flex; flex-direction: column; gap: 4px; }
    .meta-tag { background: var(--border); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; display: inline-block; width: fit-content; }
    .btn-delete { background: transparent; color: var(--text-muted); border: 1px solid var(--border); padding: 5px 12px; border-radius: 4px; font-size: 1.2em; }
    .accordion-content { padding: 15px; display: none; border-top: 1px solid var(--border); font-size: 0.95em; line-height: 1.6; }
    .accordion-content.active { display: block; }
    
    .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .copy-prompt-btn { border: none; padding: 8px 12px; font-size: 0.85em; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; background: var(--primary); color: white; }

    /* === INTERACTIVE WORD SYSTEM === */
    .interactive-word { border-radius: 4px; padding: 2px 1px; cursor: pointer; display: inline-block; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .interactive-word:hover { background-color: rgba(99, 102, 241, 0.2); border-bottom-color: var(--primary); color: white; }
    .interactive-word.saved { color: var(--saved-word) !important; font-weight: 700; border-bottom: none !important; }
    .interactive-word.phrase-saved {
        background-color: var(--phrase-word) !important; color: #111827 !important;
        margin: 0 -1px !important; box-shadow: 5px 0 0 var(--phrase-word), -5px 0 0 var(--phrase-word) !important;
        padding: 2px 0 !important; border-radius: 0 !important; position: relative; z-index: 1; font-weight: 700; border-bottom: none;
    }
    .interactive-word.phrase-saved:first-child { border-top-left-radius: 4px !important; border-bottom-left-radius: 4px !important; }
    .interactive-word.phrase-saved:last-child { border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; }
    .interactive-word.phrase-selecting { background-color: rgba(245, 158, 11, 0.5) !important; color: white !important; border-bottom: 2px solid var(--phrase-word); }
    .interactive-word.saved.phrase-saved { color: var(--saved-word) !important; z-index: 2; text-shadow: 0 1px 0 rgba(0,0,0,0.2); }

       /* === ESTILO DE LECTURA (HIGHLIGHT) === */
.reading-active {
    background-color: rgba(99, 102, 241, 0.4) !important; /* √çndigo suave */
    color: #fff !important;
    box-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
    border-radius: 3px;
    transition: background-color 0.1s ease;
}

    /* === DAW AUDIO PLAYER === */
    .daw-panel {
        background: linear-gradient(to bottom, var(--surface), var(--bg)); border: 1px solid var(--border);
        border-radius: 6px; padding: 12px; margin: 10px 0 20px 0; display: flex; flex-direction: column; gap: 12px;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 4px 10px rgba(0,0,0,0.5); font-family: 'Roboto Mono', monospace;
    }
    .daw-top-deck { display: flex; gap: 10px; width: 100%; height: 44px; align-items: center; }
    
    /* Botones DAW unificados */
    .daw-btn-icon {
        width: 44px; height: 44px; background: var(--bg); border: 2px solid var(--border); border-radius: 4px; 
        color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transition: all 0.1s;
    }
    .daw-btn-icon:active { transform: translateY(2px); box-shadow: inset 0 4px 8px rgba(0,0,0,0.8); }
    
    /* MODIFIED: Disabled State */
    .daw-btn-icon:disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
    
    /* Play activo */
    .daw-btn-icon.playing {
        color: var(--success); border-color: var(--success); text-shadow: 0 0 8px var(--success);
        box-shadow: inset 0 0 15px rgba(16, 185, 129, 0.2); background: rgba(16, 185, 129, 0.1);
    }
    
    .daw-screen {
        flex: 1; background: var(--daw-screen-bg); border: 1px solid var(--border); border-radius: 2px;
        display: flex; align-items: center; padding: 0 12px; color: var(--daw-text); font-size: 0.85em; height: 100%;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.8); position: relative; overflow: hidden; white-space: nowrap;
    }
    .daw-screen.active { color: var(--success); }
    .daw-control-deck { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; }
    .daw-knob-group { display: flex; flex-direction: column; gap: 4px; }
    .daw-label { font-size: 0.65em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
    .daw-slider { -webkit-appearance: none; width: 100%; height: 24px; background: transparent; margin: 0; }
    .daw-slider::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #000; border: 1px solid var(--border); border-radius: 3px; }
    .daw-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 10px; background: var(--text-muted); border: 1px solid #000; border-radius: 2px; margin-top: -7px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .daw-select { background: var(--bg); color: var(--text); border: 1px solid var(--border); font-family: 'Roboto Mono', monospace; font-size: 0.8em; padding: 8px; width: 100%; border-radius: 2px; height: 32px; }
    @media (min-width: 768px) {
        .daw-panel { flex-direction: row; height: 60px; }
        .daw-top-deck { width: auto; flex: 1; }
        .daw-control-deck { display: flex; gap: 20px; width: auto; }
        .daw-slider { width: 100px; }
        .daw-select { width: 140px; }
    }

    /* === UNIFIED PILL === */
    #unified-pill {
        position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(150%);
        background: rgba(31, 41, 55, 0.95); backdrop-filter: blur(12px); border: 1px solid var(--border);
        border-radius: 50px; padding: 8px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
        display: flex; align-items: center; gap: 15px; z-index: 5000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-width: 95%; white-space: nowrap;
    }
    #unified-pill.visible { transform: translateX(-50%) translateY(0); }
    .pill-section { display: flex; align-items: center; gap: 8px; }
    .pill-icon { font-size: 1.1em; }
    #pill-stats-text { font-family: 'Roboto Mono', monospace; font-weight: 800; font-size: 1em; color: var(--text); letter-spacing: 1px; }
    .stats-active { color: var(--saved-word) !important; }
    .pill-divider { width: 1px; height: 16px; background: var(--border); }
    #pill-trans { display: none; }
    #pill-trans.active { display: flex; align-items: center; gap: 8px; }
    .trans-origin, .trans-arrow { display: none; }
    .trans-result { color: #fff; font-weight: 700; font-size: 0.95em; }
    .pill-speak-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0 0 0 8px; color: var(--primary); display: flex; align-items: center; transition: color 0.2s; }
    .pill-speak-btn:hover { color: #fff; }

    /* === MAGIC CIRCLE === */
    #magic-circle {
        position: fixed; width: 50px; height: 50px; border-radius: 50%; background: rgba(99, 102, 241, 0.3); border: 2px solid var(--primary);
        box-shadow: 0 0 15px var(--primary); z-index: 6000; top: 50%; left: 85%; touch-action: none;
        display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: move; backdrop-filter: blur(2px);
    }
    #magic-circle::after { content: 'üîç'; opacity: 0.8; }
    @media (min-width: 769px) { #magic-circle { display: none; } }

    /* === PILL SAVE ACTION === */
    .pill-save-action {
        display: none; background: var(--phrase-word); color: #000; border: none; font-weight: 800;
        font-family: 'Roboto Mono', monospace; font-size: 1em; padding: 5px 15px; border-radius: 20px;
        cursor: pointer; width: 100%; text-align: center; box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
        animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); flex-shrink: 0;
    }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    /* MODIFIED: Selection Mode with Translation Visible */
    #unified-pill.selection-mode #pill-stats-group, 
    #unified-pill.selection-mode #pill-divider { display: none !important; }
    
    #unified-pill.selection-mode #pill-trans {
        display: flex !important; margin-right: 10px; border-right: 1px solid rgba(255,255,255,0.2); padding-right: 10px;
    }
    #unified-pill.selection-mode #pill-trans .pill-speak-btn { display: none; } /* Hide speaker to save space */
    
    #unified-pill.selection-mode .pill-save-action { display: block; }
    #unified-pill.selection-mode { border-color: var(--phrase-word); background: rgba(20, 20, 20, 0.98); }

   </style>
</head>
<body>

   <div id="unified-pill">
        <div id="pill-stats-group" class="pill-section">
            <span class="pill-icon">üìä</span>
            <span id="pill-stats-text">- | 0</span>
        </div>
        
        <div id="pill-divider" class="pill-divider" style="display:none;"></div>

        <div id="pill-trans" class="pill-section">
            <span id="trans-origin" class="trans-origin">...</span>
            <span class="trans-arrow">‚Üí</span>
            <span id="trans-result" class="trans-result">...</span>
            <button id="pill-speak" class="pill-speak-btn">üîä</button>
        </div>

        <button id="pill-save-btn" class="pill-save-action" onclick="savePhraseFromPill()">
            üíæ SAVE
        </button>
    </div>

    <button id="btn-show-gen" onclick="toggleGenerator(true)">‚ûï New Generation</button>

    <div id="generator-container">
        <h2>Prompt Engineer</h2>
        
        <div id="vocab-controls">
            <div class="vocab-header" onclick="document.getElementById('useVocabCheckbox').click()">
                <div class="vocab-toggle-wrapper">
                    <input type="checkbox" id="useVocabCheckbox" class="custom-checkbox" onclick="event.stopPropagation()" onchange="toggleVocabMode()">
                    <span>Inject MDC Vocab</span>
                </div>
                <span id="vocab-count-badge" class="vocab-badge">Checking DB...</span>
            </div>

            <div id="vocab-settings" class="vocab-settings">
                <div class="grid-container" style="margin-bottom:0;">
                    <div>
                        <label>Source</label>
                        <select id="vocabSource">
                            <option value="all">üåê All Words</option>
                            <option value="highlighted">‚≠ê Highlighted</option>
                            <option value="recent">Hz Recent (10)</option>
                            <optgroup id="folder-group" label="üìÇ Folders"></optgroup>
                        </select>
                    </div>
                    <div>
                        <label>Amount (Words)</label>
                        <input type="number" id="vocabAmount" value="5" min="1" max="50">
                    </div>
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top:10px; font-style:italic; border-top: 1px solid #222; padding-top: 5px;">
                    ‚ÑπÔ∏è "Learning Mode" active: Topic is locked. Task dictates the Persona.
                </div>
            </div>
        </div>

        <div class="grid-container">
            <div>
                <label>Context</label>
                <input type="text" id="contextInput" list="context-history" placeholder="Ex: React, Finance...">
                <datalist id="context-history"></datalist>
            </div>
            <div>
                <label>Specific Topic</label>
                <input type="text" id="topicInput" list="topic-history" placeholder="Ex: Hooks, ROI...">
                <datalist id="topic-history"></datalist>
            </div>

            <div>
                <label>Writes like a...</label>
                <div class="custom-select-trigger">
                    <input type="text" id="modeDisplay" class="display-input" value="‚öôÔ∏è TECHNICAL" readonly onclick="openModal('modeSelect')">
                    <div class="btn-select-mode" onclick="openModal('modeSelect')">‚ö°</div>
                </div>
                <input type="hidden" id="modeSelect" value="tech"> 
            </div>

            <div>
                <label>Format</label>
                <div class="custom-select-trigger">
                    <input type="text" id="formatDisplay" class="display-input" value="üìÑ TEXT GUIDE" readonly onclick="openModal('formatSelect')">
                    <div class="btn-select-mode" onclick="openModal('formatSelect')">üìù</div>
                </div>
                <input type="hidden" id="formatSelect" value="text"> 
            </div>
            
            <div>
                <label id="taskLabel">Task Type</label>
                <div class="custom-select-trigger">
                    <input type="text" id="taskDisplay" class="display-input" value="üí° DEMYSTIFY" readonly onclick="openModal('taskSelect')">
                    <div class="btn-select-mode" onclick="openModal('taskSelect')">üõ†Ô∏è</div>
                </div>
                <input type="hidden" id="taskSelect" value="explain"> 
            </div>
            
            <div>
                <label>Voice/Tone</label>
                <div class="custom-select-trigger">
                    <input type="text" id="voiceDisplay" class="display-input" value="‚öñÔ∏è Objective" readonly onclick="openModal('voiceSelect')">
                    <div class="btn-select-mode" onclick="openModal('voiceSelect')">üîä</div>
                </div>
                <input type="hidden" id="voiceSelect" value="neutral"> 
            </div>

            <div>
                <label>Length</label>
                <div class="custom-select-trigger">
                    <input type="text" id="lengthDisplay" class="display-input" value="üß† Full" readonly onclick="openModal('lengthSelect')">
                    <div class="btn-select-mode" onclick="openModal('lengthSelect')">üìè</div>
                </div>
                <input type="hidden" id="lengthSelect" value="full"> 
            </div>

            <div>
                <label>Depth Level</label>
                <div class="custom-select-trigger">
                    <input type="text" id="levelDisplay" class="display-input" value="- Level 1: Surface" readonly onclick="openModal('levelSelect')">
                    <div class="btn-select-mode" onclick="openModal('levelSelect')">üìä</div>
                </div>
                <input type="hidden" id="levelSelect" value="- Level 1: Surface."> 
            </div>
        </div>

        <div class="btn-group">
            <button id="btn-generate" onclick="generatePrompt()">‚ö° Generate Prompt</button>
            <button id="btn-paste" onclick="handlePasteResponse()">üìã Paste Response & Hide</button>
        </div>

        <div id="prompt-output"></div>
    </div>

    <div id="search-container">
        <input type="text" id="searchBar" placeholder="üîç Search saved prompts..." onkeyup="filterResults()">
    </div>

    <div id="results-container"></div>
    <div id="magic-circle"></div>

    <div id="universal-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Select Option</h3>
            <button class="close-modal-btn" onclick="closeModal()">‚úï</button>
        </div>
        
        <div class="modal-search-bar">
            <input type="text" id="modalSearch" placeholder="üîç Filter options..." onkeyup="filterGrid()">
        </div>
        
        <div class="mode-grid-container">
            <div id="universal-grid" class="mode-grid">
                </div>
        </div>

        <div id="preview-panel" class="preview-panel hidden-panel">
            <div class="preview-header">
                <div class="preview-title" id="preview-title">Select an option</div>
            </div>
            
            <div class="preview-details" id="preview-content">
                </div>

            <button class="btn-confirm-selection" onclick="confirmSelection()">
                ‚úÖ CONFIRM SELECTION
            </button>
        </div>
    </div>
</div>

<script>
// ... (The long config arrays remain exactly the same as your input, collapsing for brevity) ...
/* 1. CONFIG DATA (FULL MERGED & CATEGORIZED) */
/* 1. CONFIG DATA (FULL MERGED & CATEGORIZED) */
const COMMON_DATA = {
    MODES: [
        // --- STEM & TECH ---
        { id: 'tech', label: '‚öôÔ∏è TECHNICAL', category: 'STEM & Tech', role: 'Act as a Senior Engineer.', style: 'Cyberpunk/Terminal style.', goal: 'Technical accuracy and implementation detail.' },
        { id: 'programming', label: 'üíª PROGRAMMING', category: 'STEM & Tech', role: 'Act as a Senior Software Developer.', style: 'Clean code and debugging style.', goal: 'Efficient algorithms and robust implementation.' },
        { id: 'ai', label: 'ü§ñ AI RESEARCH', category: 'STEM & Tech', role: 'Act as an AI Research Scientist.', style: 'Futuristic, code-infused style.', goal: 'Innovative AI solutions and ethical considerations.' },
        { id: 'data', label: 'üìä DATA SCIENCE', category: 'STEM & Tech', role: 'Act as a Data Scientist.', style: 'Statistical charts and insights style.', goal: 'Data-driven decisions and predictive modeling.' },
        { id: 'math', label: 'üßÆ MATHEMATICS', category: 'STEM & Tech', role: 'Act as a Mathematician.', style: 'Formal proofs and equations style.', goal: 'Logical precision and theoretical depth.' },
        { id: 'physics', label: '‚öõÔ∏è PHYSICS', category: 'STEM & Tech', role: 'Act as a Theoretical Physicist.', style: 'Quantum/Einstein-inspired style.', goal: 'Fundamental laws and conceptual breakthroughs.' },
        { id: 'biology', label: 'üß¨ BIOLOGY', category: 'STEM & Tech', role: 'Act as a Biologist.', style: 'Scientific observation and diagrams style.', goal: 'Life processes and evolutionary insights.' },
        { id: 'chemistry', label: 'üß™ CHEMISTRY', category: 'STEM & Tech', role: 'Act as a Chemist.', style: 'Molecular and reaction-focused style.', goal: 'Synthesis, reactions, and material properties.' },
        { id: 'robotics', label: 'ü¶æ ROBOTICS', category: 'STEM & Tech', role: 'Act as a Robotics Engineer.', style: 'Mechanical and AI integration style.', goal: 'Autonomous systems and practical applications.' },
        { id: 'astronomy', label: 'üî≠ ASTRONOMY', category: 'STEM & Tech', role: 'Act as an Astronomer.', style: 'Cosmic observation style.', goal: 'Universe exploration and celestial phenomena.' },
        { id: 'geology', label: 'ü™® GEOLOGY', category: 'STEM & Tech', role: 'Act as a Geologist.', style: 'Rock formations and maps style.', goal: 'Earth processes and resources.' },
        { id: 'medicine', label: 'ü©∫ MEDICINE', category: 'STEM & Tech', role: 'Act as a Medical Doctor.', style: 'Clinical case study style.', goal: 'Diagnosis, treatment, and patient care.' },
        { id: 'environmental', label: 'üåø ENVIRONMENTAL', category: 'STEM & Tech', role: 'Act as an Ecologist.', style: 'Ecosystem and sustainability style.', goal: 'Environmental protection and climate solutions.' },

        // --- BUSINESS & PROFESSIONAL ---
        { id: 'business', label: 'üíº BUSINESS', category: 'Business & Pro', role: 'Act as a Strategy Consultant.', style: 'Executive brief style.', goal: 'Clarity, precision, and actionable insights.' },
        { id: 'marketing', label: 'üì£ MARKETING', category: 'Business & Pro', role: 'Act as a Senior Copywriter.', style: 'Persuasive, high-conversion writing.', goal: 'Brand voice alignment & audience engagement.' },
        { id: 'entrepreneur', label: 'üöÄ STARTUP', category: 'Business & Pro', role: 'Act as a Startup Founder.', style: 'Pitch deck and growth style.', goal: 'Innovation and business scaling.' },
        { id: 'finance', label: 'üí∞ FINANCE', category: 'Business & Pro', role: 'Act as a Financial Analyst.', style: 'Balance sheets and forecasts style.', goal: 'Investment strategies and risk management.' },
        { id: 'economics', label: 'üíπ ECONOMICS', category: 'Business & Pro', role: 'Act as an Economist.', style: 'Graphs and policy analysis style.', goal: 'Market dynamics and resource allocation.' },
        { id: 'law', label: '‚öñÔ∏è LAW', category: 'Business & Pro', role: 'Act as a Legal Expert.', style: 'Case law and statutes style.', goal: 'Legal reasoning and justice principles.' },
        { id: 'hr', label: 'üë• HR', category: 'Business & Pro', role: 'Act as a HR Manager.', style: 'Talent development style.', goal: 'Team building and organizational culture.' },
        { id: 'journalism', label: 'üì∞ JOURNALISM', category: 'Business & Pro', role: 'Act as a Investigative Journalist.', style: 'News article style.', goal: 'Fact-based reporting and public awareness.' },
        { id: 'political', label: 'üó≥Ô∏è POLITICAL', category: 'Business & Pro', role: 'Act as a Political Analyst.', style: 'Policy debate style.', goal: 'Governance, power, and international relations.' },

        // --- CREATIVE ARTS & LIFESTYLE ---
        { id: 'art', label: 'üé® ART', category: 'Creative Arts', role: 'Act as a Creative Director.', style: 'Minimalist Gallery / Editorial style.', goal: 'Aesthetic refinement and originality.' },
        { id: 'design', label: '‚úèÔ∏è DESIGN', category: 'Creative Arts', role: 'Act as a UX/UI Designer.', style: 'Visual mood boards and prototypes style.', goal: 'User-centered aesthetics and functionality.' },
        { id: 'music', label: 'üéµ MUSIC', category: 'Creative Arts', role: 'Act as a Composer/Music Producer.', style: 'Symphonic or electronic score style.', goal: 'Harmonic innovation and emotional resonance.' },
        { id: 'film', label: 'üé¨ FILM', category: 'Creative Arts', role: 'Act as a Film Director.', style: 'Script and storyboard style.', goal: 'Visual storytelling and cinematic impact.' },
        { id: 'photography', label: 'üì∏ PHOTOGRAPHY', category: 'Creative Arts', role: 'Act as a Professional Photographer.', style: 'Composition and lighting style.', goal: 'Capturing moments with artistic vision.' },
        { id: 'painting', label: 'üñåÔ∏è PAINTING', category: 'Creative Arts', role: 'Act as a Painter/Artist.', style: 'Brushstroke and palette style.', goal: 'Expressive color and form exploration.' },
        { id: 'dance', label: 'üíÉ DANCE', category: 'Creative Arts', role: 'Act as a Choreographer.', style: 'Movement sequence style.', goal: 'Bodily expression and rhythmic innovation.' },
        { id: 'theater', label: 'üé≠ THEATER', category: 'Creative Arts', role: 'Act as a Theater Director.', style: 'Stage directions and drama style.', goal: 'Live performance and emotional depth.' },
        { id: 'fashion', label: 'üëó FASHION', category: 'Creative Arts', role: 'Act as a Fashion Designer.', style: 'Trend and silhouette style.', goal: 'Style innovation and wearable art.' },
        { id: 'cooking', label: 'üë®‚Äçüç≥ CULINARY', category: 'Creative Arts', role: 'Act as a Chef.', style: 'Recipe and plating style.', goal: 'Flavor innovation and gastronomic experience.' },
        { id: 'gaming', label: 'üéÆ GAME DESIGN', category: 'Creative Arts', role: 'Act as a Game Designer.', style: 'Mechanics and narrative style.', goal: 'Immersive gameplay and player engagement.' },
        { id: 'architecture', label: 'üèóÔ∏è ARCHITECTURE', category: 'Creative Arts', role: 'Act as an Architect.', style: 'Blueprint and spatial design style.', goal: 'Functional beauty and sustainable structures.' },
        { id: 'sports', label: '‚öΩ SPORTS', category: 'Creative Arts', role: 'Act as a Sports Coach.', style: 'Training plan style.', goal: 'Performance optimization and strategy.' },

        // --- HUMANITIES & EDUCATION ---
        { id: 'school', label: 'üìö SCHOOL', category: 'Humanities', role: 'Act as a Professor.', style: 'Clean Textbook / Academic style.', goal: 'Structured education and conceptual clarity.' },
        { id: 'research', label: 'üî¨ RESEARCH', category: 'Humanities', role: 'Act as a Research Scientist.', style: 'Peer-reviewed academic tone.', goal: 'Evidence-based rigor with citations when relevant.' },
        { id: 'history', label: 'üèõÔ∏è HISTORY', category: 'Humanities', role: 'Act as a Historian.', style: 'Chronological narrative with sources style.', goal: 'Contextual understanding and lessons from the past.' },
        { id: 'philosophy', label: 'ü§î PHILOSOPHY', category: 'Humanities', role: 'Act as a Philosopher.', style: 'Socratic dialogue style.', goal: 'Ethical reasoning and existential inquiry.' },
        { id: 'psychology', label: 'üß† PSYCHOLOGY', category: 'Humanities', role: 'Act as a Clinical Psychologist.', style: 'Therapeutic case study style.', goal: 'Mental health insights and behavioral analysis.' },
        { id: 'sociology', label: 'üë• SOCIOLOGY', category: 'Humanities', role: 'Act as a Sociologist.', style: 'Social patterns and surveys style.', goal: 'Society dynamics and cultural norms.' },
        { id: 'anthropology', label: 'üåç ANTHROPOLOGY', category: 'Humanities', role: 'Act as an Anthropologist.', style: 'Ethnographic fieldwork style.', goal: 'Human cultures and evolution.' },
        { id: 'linguistics', label: 'üó£Ô∏è LINGUISTICS', category: 'Humanities', role: 'Act as a Linguist.', style: 'Phonetic and syntactic analysis style.', goal: 'Language structure and communication.' },
        { id: 'education', label: 'üéì EDUCATION', category: 'Humanities', role: 'Act as an Educational Designer.', style: 'Curriculum and pedagogy style.', goal: 'Learning outcomes and student engagement.' },
        { id: 'psychotherapy', label: 'üõãÔ∏è THERAPY', category: 'Humanities', role: 'Act as a Therapist.', style: 'Empathetic session style.', goal: 'Emotional healing and personal growth.' },
        { id: 'ethics', label: '‚öñÔ∏è ETHICS', category: 'Humanities', role: 'Act as an Ethicist.', style: 'Moral dilemma analysis style.', goal: 'Ethical frameworks and decision-making.' },

        // --- WRITING & STORY ---
        { id: 'story', label: 'üìñ STORYTELLING', category: 'Writing', role: 'Act as a Master Novelist.', style: 'Cinematic, immersive narrative tone.', goal: 'Engaging storytelling and world-building.' },
        { id: 'literature', label: 'üìú LITERATURE', category: 'Writing', role: 'Act as a Literary Critic.', style: 'Prose analysis and quotes style.', goal: 'Deep textual interpretation and thematic exploration.' },
        { id: 'poetry', label: 'üñãÔ∏è POETRY', category: 'Writing', role: 'Act as a Poet.', style: 'Verse and metaphor style.', goal: 'Lyrical expression and emotional depth.' },
        { id: 'casual', label: 'üòä CASUAL', category: 'Writing', role: 'Act as a friendly assistant.', style: 'Conversational, natural tone.', goal: 'Clarity, simplicity, and a human-sounding delivery.' },

        // --- GLOBAL CULTURE (FULL LIST) ---
        { id: 'japanesephilosophy', label: 'üà∂ JAPANESE ZEN', category: 'Global Culture', role: 'Act as a Zen Master.', style: 'Wabi-sabi and minimalist koan style.', goal: 'Inner peace and impermanence contemplation.' },
        { id: 'africanart', label: 'ü™ò AFRICAN ART', category: 'Global Culture', role: 'Act as an African Tribal Artist.', style: 'Rhythmic patterns and ancestral symbolism style.', goal: 'Cultural heritage and communal storytelling.' },
        { id: 'latinliterature', label: 'üìñ LATIN MAGICAL', category: 'Global Culture', role: 'Act as a Magical Realist Writer.', style: 'Surreal blend of reality and fantasy style.', goal: 'Social commentary through mythical narratives.' },
        { id: 'indianmusic', label: 'ü™ï INDIAN RAGA', category: 'Global Culture', role: 'Act as a Raga Composer.', style: 'Improvisational melodic raga style.', goal: 'Spiritual elevation and emotional raga expression.' },
        { id: 'chinesecalligraphy', label: 'üñåÔ∏è CALLIGRAPHY', category: 'Global Culture', role: 'Act as a Calligrapher.', style: 'Brush strokes with qi energy style.', goal: 'Harmony of form and spirit in writing.' },
        { id: 'mexicandance', label: 'üíÉ MEXICAN FOLK', category: 'Global Culture', role: 'Act as a Folklorico Choreographer.', style: 'Vibrant regional folk dance style.', goal: 'Cultural identity and historical celebration.' },
        { id: 'arabicpoetry', label: 'üïå SUFI POETRY', category: 'Global Culture', role: 'Act as a Sufi Poet.', style: 'Mystical qasida and ghazal style.', goal: 'Divine love and spiritual ecstasy.' },
        { id: 'australianaboriginalart', label: 'üåè DREAMTIME', category: 'Global Culture', role: 'Act as a Dreamtime Artist.', style: 'Dot painting and symbolic storytelling style.', goal: 'Connection to land and ancestral dreams.' },
        { id: 'russianliterature', label: '‚ùÑÔ∏è RUSSIAN LIT', category: 'Global Culture', role: 'Act as a Dostoevskian Novelist.', style: 'Psychological depth and existential drama style.', goal: 'Human soul exploration and moral dilemmas.' },
        { id: 'koreanfilm', label: 'üé• KOREAN WAVE', category: 'Global Culture', role: 'Act as a New Wave Director.', style: 'Thrilling social critique cinema style.', goal: 'Genre-bending and cultural reflection.' },
        { id: 'nigerianstorytelling', label: 'ü¶Ö GRIOT TALES', category: 'Global Culture', role: 'Act as an Oral Historian.', style: 'Griot tradition with proverbs style.', goal: 'Community wisdom and historical preservation.' },
        { id: 'frenchphilosophy', label: 'üá´üá∑ EXISTENTIAL', category: 'Global Culture', role: 'Act as an Existentialist Thinker.', style: 'Absurdity and freedom discourse style.', goal: 'Authentic existence and rebellion against absurdity.' },
        { id: 'brazilianmusic', label: 'ü•Å SAMBA', category: 'Global Culture', role: 'Act as a Samba Composer.', style: 'Rhythmic carnival beat style.', goal: 'Joyful expression and cultural fusion.' },
        { id: 'indigenousanthropology', label: 'üåø INDIGENOUS', category: 'Global Culture', role: 'Act as a Native Knowledge Keeper.', style: 'Oral tradition and ecological wisdom style.', goal: 'Sustainable living and cultural continuity.' },
        { id: 'spanishflamenco', label: 'ü™ï FLAMENCO', category: 'Global Culture', role: 'Act as a Flamenco Artist.', style: 'Passionate duende performance style.', goal: 'Emotional catharsis and gypsy heritage.' },
        { id: 'canadianliterature', label: 'üçÅ CANADIAN LIT', category: 'Global Culture', role: 'Act as a Multicultural Novelist.', style: 'Identity and landscape narrative style.', goal: 'Diverse voices and national mosaic.' },
        { id: 'egyptianhistory', label: 'üóø PHARAOH', category: 'Global Culture', role: 'Act as a Pharaoh Chronicler.', style: 'Hieroglyphic epic recounting style.', goal: 'Ancient mysteries and Nile civilization.' },
        { id: 'vietnamesetheater', label: 'üé≠ WATER PUPPET', category: 'Global Culture', role: 'Act as a Water Puppet Director.', style: 'Aquatic folklore performance style.', goal: 'Rural life and mythical tales.' },
        { id: 'irishfolkmusic', label: 'üçÄ CELTIC BARD', category: 'Global Culture', role: 'Act as a Celtic Bard.', style: 'Ballad and jig instrumental style.', goal: 'Heritage preservation and lively sessions.' },
        { id: 'peruvianarchaeology', label: 'üèîÔ∏è INCA', category: 'Global Culture', role: 'Act as an Inca Explorer.', style: 'Andean artifact analysis style.', goal: 'Lost empires and cultural decoding.' },
        { id: 'turkishpoetry', label: 'üïå OTTOMAN', category: 'Global Culture', role: 'Act as an Ottoman Divan Poet.', style: 'Gazelle and mystical verse style.', goal: 'Love, wine, and divine inspiration.' },
        { id: 'mexicanmuralism', label: 'üñºÔ∏è MURALISM', category: 'Global Culture', role: 'Act as a Revolutionary Muralist.', style: 'Large-scale social realism style.', goal: 'Political activism and public art.' },
        { id: 'japaneseteaceremony', label: 'üçµ TEA CEREMONY', category: 'Global Culture', role: 'Act as a Chado Master.', style: 'Zen ritual and harmony style.', goal: 'Mindfulness and aesthetic simplicity.' },
        { id: 'africanrhythms', label: 'ü•Å DJEMBE', category: 'Global Culture', role: 'Act as a Djembe Drummer.', style: 'Polyrhythmic tribal beat style.', goal: 'Community bonding and spiritual trance.' },
        { id: 'indianphilosophy', label: 'üïâÔ∏è VEDANTIC', category: 'Global Culture', role: 'Act as a Vedantic Sage.', style: 'Upanishadic dialogue style.', goal: 'Self-realization and cosmic unity.' },
        { id: 'chileanpoetry', label: 'üåÑ NERUDIAN', category: 'Global Culture', role: 'Act as a Nerudian Poet.', style: 'Sensual ode and epic verse style.', goal: 'Love, nature, and political passion.' },
        { id: 'mongolianthroatsinging', label: 'üèûÔ∏è KHOOMEI', category: 'Global Culture', role: 'Act as a Khoomei Singer.', style: 'Harmonic overtone vocal style.', goal: 'Nature imitation and shamanic connection.' },
        { id: 'greekmythology', label: 'üèõÔ∏è GREEK MYTH', category: 'Global Culture', role: 'Act as a Mythic Bard.', style: 'Epic Homeric recitation style.', goal: 'Heroic tales and moral lessons.' },
        { id: 'maoriart', label: 'üåø TA MOKO', category: 'Global Culture', role: 'Act as a Ta Moko Tattoo Artist.', style: 'Spiral and genealogical pattern style.', goal: 'Identity marking and cultural pride.' },
        { id: 'koreanpoetry', label: 'üñãÔ∏è SIJO POET', category: 'Global Culture', role: 'Act as a Sijo Poet.', style: 'Three-line philosophical verse style.', goal: 'Nature reflection and human condition.' },
        { id: 'cubansalsa', label: 'üíÉ SALSA', category: 'Global Culture', role: 'Act as a Salsa Choreographer.', style: 'Afro-Cuban rhythmic dance style.', goal: 'Joyful movement and social connection.' },
        { id: 'persianminiature', label: 'üñºÔ∏è MINIATURIST', category: 'Global Culture', role: 'Act as a Miniaturist Painter.', style: 'Intricate illuminated manuscript style.', goal: 'Poetic scenes and royal chronicles.' },
        { id: 'scandinaviandesign', label: 'ü™ë NORDIC', category: 'Global Culture', role: 'Act as a Functionalist Designer.', style: 'Minimalist hygge aesthetic style.', goal: 'Simplicity, functionality, and coziness.' },
        { id: 'thaitheater', label: 'üé≠ KHON', category: 'Global Culture', role: 'Act as a Khon Performer.', style: 'Masked Ramayana epic style.', goal: 'Mythical storytelling and graceful movement.' },
        { id: 'jamaicanreggae', label: 'üé∏ REGGAE', category: 'Global Culture', role: 'Act as a Reggae Musician.', style: 'Roots rhythm and social lyrics style.', goal: 'Protest music and Rastafarian spirituality.' },
        { id: 'aztecmythology', label: 'üóø AZTEC', category: 'Global Culture', role: 'Act as a Nahua Storyteller.', style: 'Sacrificial cosmic narrative style.', goal: 'World creation and divine balance.' },
        { id: 'polynesiandance', label: 'üå∫ HULA', category: 'Global Culture', role: 'Act as a Hula Choreographer.', style: 'Storytelling hip movement style.', goal: 'Cultural legends and ocean connection.' },
        { id: 'russianballet', label: 'ü©∞ BALLET', category: 'Global Culture', role: 'Act as a Ballet Master.', style: 'Classical tutu and pointe style.', goal: 'Graceful expression and dramatic narrative.' },
        { id: 'chineseopera', label: 'üé≠ PEKING OPERA', category: 'Global Culture', role: 'Act as a Peking Opera Performer.', style: 'Acrobatic facial makeup style.', goal: 'Historical drama and martial arts.' },
        { id: 'australiansurfing', label: 'üèÑ SURFING', category: 'Global Culture', role: 'Act as a Surf Culture Expert.', style: 'Wave-riding lifestyle narrative style.', goal: 'Adventure and coastal harmony.' },
        { id: 'moroccanarchitecture', label: 'üïå RIAD', category: 'Global Culture', role: 'Act as a Riads Designer.', style: 'Intricate zellige tile style.', goal: 'Privacy, beauty, and Islamic geometry.' },
        { id: 'indonesianbatik', label: 'üñºÔ∏è BATIK', category: 'Global Culture', role: 'Act as a Batik Artisan.', style: 'Wax-resist dyeing pattern style.', goal: 'Cultural symbols and textile art.' },
        { id: 'scottishfolklore', label: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø HIGHLAND', category: 'Global Culture', role: 'Act as a Highland Storyteller.', style: 'Celtic myth and legend style.', goal: 'Supernatural beings and clan histories.' },
        { id: 'bolivianweaving', label: 'üß∂ ANDEAN WEAVE', category: 'Global Culture', role: 'Act as an Andean Weaver.', style: 'Colorful textile pattern style.', goal: 'Indigenous identity and craft tradition.' },
        { id: 'jewishphilosophy', label: '‚ú°Ô∏è KABBALAH', category: 'Global Culture', role: 'Act as a Kabbalist Scholar.', style: 'Mystical Torah interpretation style.', goal: 'Divine secrets and ethical living.' },
        { id: 'finnishsauna', label: 'üßñ SAUNA', category: 'Global Culture', role: 'Act as a Sauna Ritual Master.', style: 'Steam and l√∂yly philosophical style.', goal: 'Purification and social equality.' },
        { id: 'haitianvoodoo', label: 'üïØÔ∏è VOODOO', category: 'Global Culture', role: 'Act as a Houngan Priest.', style: 'Ritual drumming and loa invocation style.', goal: 'Spiritual healing and ancestral connection.' },
        { id: 'italianopera', label: 'üéº BEL CANTO', category: 'Global Culture', role: 'Act as a Bel Canto Composer.', style: 'Dramatic aria and recitative style.', goal: 'Emotional intensity and vocal virtuosity.' },
        { id: 'kenyanmasaiculture', label: 'ü¶Å MASAI', category: 'Global Culture', role: 'Act as a Warrior Elder.', style: 'Beadwork and oral history style.', goal: 'Nomadic traditions and lion hunting lore.' },
        { id: 'portuguesefado', label: 'üé∏ FADO', category: 'Global Culture', role: 'Act as a Fadista Singer.', style: 'Melancholic guitar lament style.', goal: 'Saudade emotion and seafaring nostalgia.' },
        { id: 'samiindigenous', label: '‚ùÑÔ∏è JOIK', category: 'Global Culture', role: 'Act as a Joik Chanter.', style: 'Vocal yoik improvisation style.', goal: 'Nature spirits and reindeer herding life.' },
        { id: 'armenianfolkdance', label: 'üíÉ KOCHARI', category: 'Global Culture', role: 'Act as a Kochari Choreographer.', style: 'Circle dance rhythm style.', goal: 'Community unity and historical resilience.' },
        { id: 'mongolianhorse', label: 'üèá STEPPE NOMAD', category: 'Global Culture', role: 'Act as a Steppe Nomad.', style: 'Epic yurt narrative style.', goal: 'Conquest legends and equestrian mastery.' },
        { id: 'cambodianapsara', label: 'üï∫ APSARA', category: 'Global Culture', role: 'Act as an Apsara Dancer.', style: 'Graceful hand gesture style.', goal: 'Khmer mythology and temple carvings.' },
        { id: 'algerianrai', label: 'üé§ RAI', category: 'Global Culture', role: 'Act as a Rai Musician.', style: 'Rebellious love song style.', goal: 'Social taboo breaking and emotional release.' },
        { id: 'inuitthroatsinging', label: '‚ùÑÔ∏è KATAJJAQ', category: 'Global Culture', role: 'Act as a Katajjaq Performer.', style: 'Vocal game imitation style.', goal: 'Arctic survival and playful competition.' },
        { id: 'colombiancumbia', label: 'ü•Å CUMBIA', category: 'Global Culture', role: 'Act as a Cumbia Rhythm Master.', style: 'African-indigenous fusion dance style.', goal: 'Festive celebration and cultural mixing.' },
        { id: 'tibetanbuddhism', label: 'üïâÔ∏è TIBETAN', category: 'Global Culture', role: 'Act as a Lama Teacher.', style: 'Mandala and mantra meditation style.', goal: 'Enlightenment path and compassion cultivation.' },
        { id: 'fijianmeke', label: 'üå∫ MEKE', category: 'Global Culture', role: 'Act as a Meke Performer.', style: 'War dance and legend chant style.', goal: 'Tribal history and Pacific island spirit.' },
        { id: 'lebanesedabke', label: 'üíÉ DABKE', category: 'Global Culture', role: 'Act as a Dabke Leader.', style: 'Line dance stomp rhythm style.', goal: 'Wedding joy and national pride.' },
        { id: 'malaysiansilat', label: 'ü•ã SILAT', category: 'Global Culture', role: 'Act as a Silat Guru.', style: 'Martial arts flow style.', goal: 'Self-defense and spiritual discipline.' },
        { id: 'ethiopianjazz', label: 'üé∑ ETHIO-JAZZ', category: 'Global Culture', role: 'Act as an Ethio-Jazz Improviser.', style: 'Pentatonic scale fusion style.', goal: 'Cultural revival and rhythmic innovation.' },
        { id: 'balinesegamelan', label: 'üîî GAMELAN', category: 'Global Culture', role: 'Act as a Gamelan Conductor.', style: 'Metallophone ensemble style.', goal: 'Ceremonial harmony and island rituals.' },
        { id: 'nativeamericanflute', label: 'ü™∂ FLUTE', category: 'Global Culture', role: 'Act as a Flute Maker.', style: 'Melodic wind instrument style.', goal: 'Healing sounds and tribal legends.' },
        { id: 'uzbekminiaturism', label: 'üñºÔ∏è SILK ROAD', category: 'Global Culture', role: 'Act as a Silk Road Painter.', style: 'Persian-influenced detail style.', goal: 'Epic tales and ornamental beauty.' },
        { id: 'romanigypsymusic', label: 'üéª GYPSY VIOLIN', category: 'Global Culture', role: 'Act as a Violin Virtuoso.', style: 'Passionate nomadic melody style.', goal: 'Wanderlust expression and emotional fire.' },
        { id: 'srilankanmask', label: 'üé≠ KOLAM', category: 'Global Culture', role: 'Act as a Kolam Performer.', style: 'Carved mask satire style.', goal: 'Social commentary and exorcism rituals.' },
        { id: 'ghanaiankente', label: 'üßµ KENTE', category: 'Global Culture', role: 'Act as a Kente Weaver.', style: 'Woven strip pattern style.', goal: 'Royal symbolism and Akan proverbs.' },
        { id: 'icelandicsaga', label: '‚ùÑÔ∏è VIKING SKALD', category: 'Global Culture', role: 'Act as a Viking Skald.', style: 'Epic prose-poetry style.', goal: 'Heroic deeds and settlement history.' },
        { id: 'burmesemarionette', label: 'üßµ PUPPETRY', category: 'Global Culture', role: 'Act as a Yokthei Pwe Puppeteer.', style: 'String puppet theater style.', goal: 'Buddhist tales and skillful manipulation.' },
        { id: 'saudiarabianpoetry', label: 'üïå BEDOUIN', category: 'Global Culture', role: 'Act as a Bedouin Poet.', style: 'Desert qasida ode style.', goal: 'Tribal honor and nomadic life.' },
        { id: 'hawaiianhula', label: 'üå∫ HULA KUMU', category: 'Global Culture', role: 'Act as a Hula Kumu.', style: 'Hand gesture storytelling style.', goal: 'Polynesian history and aloha spirit.' },
        { id: 'zuluwarriordance', label: 'üõ°Ô∏è ZULU WARRIOR', category: 'Global Culture', role: 'Act as an Indlamu Dancer.', style: 'High-kick battle rhythm style.', goal: 'Tribal strength and ceremonial power.' },
        { id: 'nepalesemandala', label: 'üïâÔ∏è THANGKA', category: 'Global Culture', role: 'Act as a Thangka Painter.', style: 'Sacred geometric art style.', goal: 'Buddhist meditation and deity visualization.' },
        { id: 'albanianfolklore', label: 'ü¶Ö RHAPSODE', category: 'Global Culture', role: 'Act as a Rhapsode Singer.', style: 'Epic lahuta ballad style.', goal: 'National heroes and mountain traditions.' },
        { id: 'filipinotinikling', label: 'üíÉ TINIKLING', category: 'Global Culture', role: 'Act as a Bamboo Dance Choreographer.', style: 'Bamboo pole rhythm style.', goal: 'Agility and colonial resistance.' },
        { id: 'kazakhdombra', label: 'ü™ï DOMBRA', category: 'Global Culture', role: 'Act as a Dombra Player.', style: 'Steppe string melody style.', goal: 'Nomadic epics and horse culture.' },
        { id: 'yemeniarchitecture', label: 'üè∞ MUD BRICK', category: 'Global Culture', role: 'Act as a Mudbrick Builder.', style: 'Tower house qasr style.', goal: 'Defensive living and adobe artistry.' },
        { id: 'maasaimara', label: 'ü¶Å MAASAI MORAN', category: 'Global Culture', role: 'Act as a Maasai Moran.', style: 'Beaded jewelry narrative style.', goal: 'Wildlife guardianship and rite of passage.' },
        { id: 'tahitianori', label: 'üå∫ ORI TAHITI', category: 'Global Culture', role: 'Act as an Ori Dancer.', style: 'Hip-shaking tamure style.', goal: 'Fertility celebration and island legends.' },
        { id: 'belarusianstrawart', label: 'üåæ STRAW ART', category: 'Global Culture', role: 'Act as a Solomopletenie Artisan.', style: 'Woven straw sculpture style.', goal: 'Folk magic and harvest symbols.' },
        { id: 'congolesesoukous', label: 'üé∏ SOUKOUS', category: 'Global Culture', role: 'Act as a Soukous Guitarist.', style: 'Lingala rumba dance style.', goal: 'African groove and urban energy.' },
        { id: 'lithuanianfolksong', label: 'üé∂ SUTARTINES', category: 'Global Culture', role: 'Act as a Sutartines Singer.', style: 'Polyphonic canon harmony style.', goal: 'Baltic pagan roots and communal chant.' },
        { id: 'ecuadorianpasillo', label: 'üé∏ PASILLO', category: 'Global Culture', role: 'Act as a Pasillo Composer.', style: 'Waltz-like melancholy tune style.', goal: 'Love lament and Andean emotion.' },
        
        // --- ADDED MISSING ITEMS FROM ORIGINAL LIST (Recovered & Categorized) ---
        { id: 'kabuki', label: 'üé≠ KABUKI', category: 'Global Culture', role: 'Act as a Kabuki Actor.', style: 'Stylized gestures and makeup.', goal: 'Japanese traditional drama.' },
        { id: 'bollywood', label: 'üé• BOLLYWOOD', category: 'Global Culture', role: 'Act as a Bollywood Director.', style: 'Song-and-dance sequences style.', goal: 'Melodramatic plots and colorful Indian cinema.' },
        { id: 'mariachi', label: 'üé∫ MARIACHI', category: 'Global Culture', role: 'Act as a Mariachi.', style: 'Vibrant trumpet fanfares style.', goal: 'Mexican folk ensemble energy.' },
        { id: 'tango', label: 'üíÉ TANGO', category: 'Global Culture', role: 'Act as a Tango Dancer.', style: 'Passionate embraces and footwork.', goal: 'Argentine melancholic rhythm.' },
        { id: 'kathakali', label: 'üé≠ KATHAKALI', category: 'Global Culture', role: 'Act as a Kathakali Performer.', style: 'Elaborate costumes and facial expressions.', goal: 'Mythological storytelling from Kerala.' },
        { id: 'sufiwhirling', label: 'üïäÔ∏è WHIRLING', category: 'Global Culture', role: 'Act as a Whirling Dervish.', style: 'Spinning meditation style.', goal: 'Divine ecstasy and mystical poetry.' },
        { id: 'celticfolklore', label: 'üçÄ CELTIC FOLK', category: 'Global Culture', role: 'Act as a Celtic Storyteller.', style: 'Fairy tales and druidic wisdom.', goal: 'Irish-Scottish mythical creature narratives.' },
        { id: 'afrobeat', label: 'ü•Å AFROBEAT', category: 'Global Culture', role: 'Act as an Afrobeat Musician.', style: 'Polyrhythmic grooves style.', goal: 'Social commentary and Nigerian highlife fusion.' },
        { id: 'ikebana', label: 'üå∏ IKEBANA', category: 'Global Culture', role: 'Act as an Ikebana Master.', style: 'Asymmetrical flower arrangements.', goal: 'Zen minimalism and Japanese harmony.' },
        { id: 'capoeira', label: 'ü•ã CAPOEIRA', category: 'Global Culture', role: 'Act as a Capoeirista.', style: 'Acrobatic martial dance.', goal: 'Ginga rhythm and Brazilian resistance history.' },
        { id: 'origami', label: 'üïäÔ∏è ORIGAMI', category: 'Global Culture', role: 'Act as an Origami Artist.', style: 'Paper folding instructions.', goal: 'Symbolic forms and Japanese precision.' },
        { id: 'calypso', label: 'üèùÔ∏è CALYPSO', category: 'Global Culture', role: 'Act as a Calypsonian.', style: 'Witty lyrics and steel pan melodies.', goal: 'Trinidadian carnival satire.' },
        { id: 'bonsai', label: 'üå≥ BONSAI', category: 'Global Culture', role: 'Act as a Bonsai Master.', style: 'Miniature tree cultivation.', goal: 'Patience philosophy and aesthetic pruning.' },
        { id: 'didgeridoo', label: 'üé∫ DIDGERIDOO', category: 'Global Culture', role: 'Act as a Didgeridoo Player.', style: 'Circular breathing drones.', goal: 'Aboriginal dreamtime sounds.' },
        { id: 'batik', label: 'üñºÔ∏è BATIK', category: 'Global Culture', role: 'Act as a Batik Artisan.', style: 'Wax-resist dyeing patterns.', goal: 'Javanese motifs and textile narratives.' },
        { id: 'bharatanatyam', label: 'üíÉ BHARATANATYAM', category: 'Global Culture', role: 'Act as a Bharatanatyam Dancer.', style: 'Expressive mudras and footwork.', goal: 'South Indian temple dance devotion.' },
        { id: 'taiko', label: 'ü•Å TAIKO', category: 'Global Culture', role: 'Act as a Taiko Drummer.', style: 'Thunderous drumming ensembles.', goal: 'Martial energy and Japanese festival power.' },
        { id: 'qawwali', label: 'üïå QAWWALI', category: 'Global Culture', role: 'Act as a Qawwal.', style: 'Devotional Sufi singing.', goal: 'Pakistani spiritual trance.' },
        { id: 'wayangkulit', label: 'üé≠ SHADOW PUPPET', category: 'Global Culture', role: 'Act as a Dalang.', style: 'Shadow puppet epics.', goal: 'Indonesian Ramayana adaptations.' },
        { id: 'gnawa', label: 'ü™ò GNAWA', category: 'Global Culture', role: 'Act as a Gnawa Musician.', style: 'Healing trance music.', goal: 'Moroccan spiritual possession rituals.' },
        { id: 'haka', label: 'üó£Ô∏è HAKA', category: 'Global Culture', role: 'Act as a Maori Warrior.', style: 'War chants and stomping.', goal: 'Maori challenge performances.' },
        { id: 'koto', label: 'ü™ï KOTO', category: 'Global Culture', role: 'Act as a Koto Player.', style: 'Zither string plucking.', goal: 'Japanese court elegance.' },
        { id: 'sitar', label: 'ü™ï SITAR', category: 'Global Culture', role: 'Act as a Sitarist.', style: 'Raga improvisations.', goal: 'North Indian classical depth.' },
        { id: 'ukiyo-e', label: 'üñºÔ∏è UKIYO-E', category: 'Global Culture', role: 'Act as a Woodblock Artist.', style: 'Floating world aesthetics.', goal: 'Edo period vibrancy.' },
        { id: 'merengue', label: 'üíÉ MERENGUE', category: 'Global Culture', role: 'Act as a Merengue Dancer.', style: 'Fast-paced accordion rhythms.', goal: 'Dominican party spirit.' },
        { id: 'shakuhachi', label: 'üéç SHAKUHACHI', category: 'Global Culture', role: 'Act as a Monk Flutist.', style: 'Bamboo flute meditations.', goal: 'Zen breathing techniques.' },
        { id: 'zajal', label: 'üó£Ô∏è ZAJAL', category: 'Global Culture', role: 'Act as a Zajal Poet.', style: 'Colloquial Arabic poetry duels.', goal: 'Levantine dialect and improvisational wit.' },
        { id: 'morna', label: 'üé∏ MORNA', category: 'Global Culture', role: 'Act as a Morna Singer.', style: 'Cape Verdean blues.', goal: 'Saudade melodies and longing.' },
        { id: 'pansori', label: 'üé§ PANSORI', category: 'Global Culture', role: 'Act as a Pansori Singer.', style: 'Epic vocal storytelling.', goal: 'Korean han emotion.' },
        { id: 'rongo', label: 'üóø RONGO RONGO', category: 'Global Culture', role: 'Act as a Glyph Interpreter.', style: 'Mysterious glyph interpretations.', goal: 'Easter Island scripts enigmas.' },
        { id: 'tarot', label: 'üÉè TAROT', category: 'Global Culture', role: 'Act as a Tarot Reader.', style: 'Card spread interpretations.', goal: 'Symbolic archetypes and intuitive guidance.' },
        { id: 'yodel', label: 'üèîÔ∏è YODEL', category: 'Global Culture', role: 'Act as a Yodeler.', style: 'Alpine echo calls.', goal: 'Swiss mountain herding songs.' },
        { id: 'huayno', label: 'ü•Å HUAYNO', category: 'Global Culture', role: 'Act as a Huayno Musician.', style: 'Andean flute and harp rhythms.', goal: 'Quechua lyrics and Peruvian dances.' },
        { id: 'klezmer', label: 'üéª KLEZMER', category: 'Global Culture', role: 'Act as a Klezmer Musician.', style: 'Clarinet wails and freylekhs.', goal: 'Eastern European Jewish wedding music.' },
        { id: 'lavani', label: 'üíÉ LAVANI', category: 'Global Culture', role: 'Act as a Lavani Performer.', style: 'Seductive tamasha performances.', goal: 'Maharashtrian folk theater.' },
        { id: 'noh', label: 'üé≠ NOH', category: 'Global Culture', role: 'Act as a Noh Actor.', style: 'Masked slow-motion drama.', goal: 'Yugen aesthetics and medieval ghosts.' },
        { id: 'joik', label: 'üé§ JOIK', category: 'Global Culture', role: 'Act as a Joik Chanter.', style: 'Sami vocal evocations.', goal: 'Lapland shamanic chants.' },
        { id: 'bhangra', label: 'ü•Å BHANGRA', category: 'Global Culture', role: 'Act as a Bhangra Dancer.', style: 'Punjabi harvest beats.', goal: 'Energetic dhol drumming.' },
        { id: 'odissi', label: 'üíÉ ODISSI', category: 'Global Culture', role: 'Act as an Odissi Dancer.', style: 'Temple sculpture poses.', goal: 'Odishan devotional expressions.' },
        { id: 'gagaku', label: 'üéº GAGAKU', category: 'Global Culture', role: 'Act as a Court Musician.', style: 'Ancient court orchestras.', goal: 'Japanese Shinto-Buddhist fusion.' },
        { id: 'rumba', label: 'ü•Å RUMBA', category: 'Global Culture', role: 'Act as a Rumbero.', style: 'Afro-Cuban conga rhythms.', goal: 'Havana street parties.' },
        { id: 'shamisen', label: 'ü™ï SHAMISEN', category: 'Global Culture', role: 'Act as a Shamisen Player.', style: 'Three-stringed lute plucks.', goal: 'Geisha accompaniment and Edo storytelling.' },
        { id: 'mariachiband', label: 'üé∫ MARIACHI BAND', category: 'Global Culture', role: 'Act as a Mariachi Band.', style: 'Vihuela strums and trumpets.', goal: 'Mexican ranchera passion.' },
        { id: 'bulgarfolkdance', label: 'üíÉ BULGARIAN', category: 'Global Culture', role: 'Act as a Folk Dancer.', style: 'Asymmetric rhythms.', goal: 'Balkan village festivities.' },
        { id: 'candombe', label: 'ü•Å CANDOMBE', category: 'Global Culture', role: 'Act as a Candombe Drummer.', style: 'Uruguayan drum calls.', goal: 'Montevideo carnival beats.' },
        { id: 'kora', label: 'ü™ï KORA', category: 'Global Culture', role: 'Act as a Kora Player.', style: 'Harp-lute melodies.', goal: 'Mandinka epics.' },
        { id: 'griot', label: 'üó£Ô∏è GRIOT', category: 'Global Culture', role: 'Act as a Griot.', style: 'Oral genealogy recitals.', goal: 'Senegalese wisdom keeping.' },
        { id: 'kyogen', label: 'üé≠ KYOGEN', category: 'Global Culture', role: 'Act as a Kyogen Actor.', style: 'Comic interlude farces.', goal: 'Japanese satirical dialogues.' },
        { id: 'balletfolklorico', label: 'üíÉ FOLKLORICO', category: 'Global Culture', role: 'Act as a Folklorico Dancer.', style: 'Regional Mexican costumes.', goal: 'Cultural mosaic performances.' },
        { id: 'mbira', label: 'ü™ï MBIRA', category: 'Global Culture', role: 'Act as a Mbira Player.', style: 'Zimbabwean thumb piano.', goal: 'Shona spirit possession.' },
        { id: 'cantejondo', label: 'üé§ CANTE JONDO', category: 'Global Culture', role: 'Act as a Flamenco Singer.', style: 'Deep Andalusian song.', goal: 'Gitano soul cries.' },
        { id: 'huasteco', label: 'üéª HUASTECO', category: 'Global Culture', role: 'Act as a Huasteco Musician.', style: 'Violin falsettos.', goal: 'Veracruz huapango dances.' },
        { id: 'sephardic', label: 'üéº SEPHARDIC', category: 'Global Culture', role: 'Act as a Sephardic Musician.', style: 'Ladino ballads.', goal: 'Jewish-Spanish diaspora laments.' },
        { id: 'tuareg', label: 'üèúÔ∏è TUAREG', category: 'Global Culture', role: 'Act as a Tuareg Guitarist.', style: 'Saharan electric guitar riffs.', goal: 'Nomadic blues.' },
        { id: 'bunraku', label: 'üßµ BUNRAKU', category: 'Global Culture', role: 'Act as a Bunraku Puppeteer.', style: 'Puppet theater narrations.', goal: 'Osaka dramatic epics.' },
        { id: 'andeanflute', label: 'üéç ANDEAN FLUTE', category: 'Global Culture', role: 'Act as a Flutist.', style: 'Quena and siku panpipes.', goal: 'Incan wind spirits.' },
        { id: 'accordianpolka', label: 'üéπ POLKA', category: 'Global Culture', role: 'Act as an Accordionist.', style: 'Czech-German oompah beats.', goal: 'Beer hall merriment.' },
        { id: 'sardana', label: 'üíÉ SARDANA', category: 'Global Culture', role: 'Act as a Sardana Dancer.', style: 'Catalan circle dances.', goal: 'National unity symbols.' },
        { id: 'balafon', label: 'ü™ò BALAFON', category: 'Global Culture', role: 'Act as a Balafon Player.', style: 'Malian xylophone cascades.', goal: 'Village ceremonies.' },
        { id: 'mari', label: 'ü™∂ MARI', category: 'Global Culture', role: 'Act as a Mari Shaman.', style: 'Finno-Ugric ritual chant style.', goal: 'Forest spirits and pagan harmony.' },
        { id: 'yorubaoriki', label: 'üó£Ô∏è ORIKI', category: 'Global Culture', role: 'Act as a Yoruba Poet.', style: 'Nigerian praise poetry.', goal: 'Lineage celebrations.' }
    ],
    
    FORMATS: [
        // --- DIGITAL & CODE ---
        { id: 'html', label: 'üåê HTML APP', category: 'Digital & Code', instruction: 'Return a single HTML5 file with inline CSS/JS. No external files. Use overflow-y:auto for scrolling.' },
        { id: 'code', label: 'üíª CODE SNIPPET', category: 'Digital & Code', instruction: 'Return raw code only with explanatory comments. No extra text.' },
        { id: 'react', label: '‚öõÔ∏è REACT COMP', category: 'Digital & Code', instruction: 'Return a complete, modern React functional component with hooks and inline styles if needed.' },
        { id: 'json', label: 'üóÇÔ∏è JSON', category: 'Digital & Code', instruction: 'Return valid JSON only, structured for the requested data.' },
        { id: 'mermaid', label: 'üßú‚Äç‚ôÄÔ∏è MERMAID', category: 'Digital & Code', instruction: 'Return Mermaid.js syntax for flowchart, sequence, class or other diagram.' },
        { id: 'svg', label: 'üé≠ SVG', category: 'Digital & Code', instruction: 'Return standalone SVG code that visually represents the concept.' },
        { id: 'ascii', label: '‚å®Ô∏è ASCII', category: 'Digital & Code', instruction: 'Return detailed ASCII art representing the subject.' },

        // --- TEXT & DOCUMENTATION ---
        { id: 'text', label: 'üìÑ TEXT GUIDE', category: 'Documents', instruction: 'Return clean Markdown text with clear headings, lists and structure.' },
        { id: 'essay', label: '‚úçÔ∏è ESSAY', category: 'Documents', instruction: 'Return a polished, formal essay with introduction, body and conclusion.' },
        { id: 'template', label: 'üìã TEMPLATE', category: 'Documents', instruction: 'Return a reusable structured template with clear placeholders for customization.' },
        { id: 'checklist', label: '‚úÖ CHECKLIST', category: 'Documents', instruction: 'Return a concise, actionable checklist or standard operating procedure.' },
        { id: 'letter', label: '‚úâÔ∏è LETTER', category: 'Documents', instruction: 'Return a formatted personal or formal letter with salutation and signature.' },
        { id: 'recipe', label: 'üç≥ RECIPE', category: 'Documents', instruction: 'Return a complete recipe with ingredients list and step-by-step instructions.' },
        { id: 'timeline', label: '‚è≥ TIMELINE', category: 'Documents', instruction: 'Return a chronological timeline of events with dates and descriptions.' },
        { id: 'mindmap', label: 'üó∫Ô∏è MIND MAP', category: 'Documents', instruction: 'Return a text-based hierarchical mind map structure with branches.' },
        { id: 'dialogue', label: 'üí¨ DIALOGUE', category: 'Documents', instruction: 'Return a scripted scene or conversation with character names and stage directions.' },
        { id: 'manifesto', label: 'üì£ MANIFESTO', category: 'Documents', instruction: 'Return a bold, provocative artistic manifesto declaring principles and intentions.' },

        // --- CREATIVE WRITING & MEDIA ---
        { id: 'screenplay', label: 'üìΩÔ∏è SCREENPLAY', category: 'Creative & Media', instruction: 'Return properly formatted screenplay pages (FADE IN, scene headings, action lines, dialogue).' },
        { id: 'storyboard', label: 'üìã STORYBOARD', category: 'Creative & Media', instruction: 'Describe sequential panels with shot composition, camera angles and key dialogue.' },
        { id: 'sonnet', label: 'üìú SONNET', category: 'Creative & Media', instruction: 'Return a 14-line sonnet (Shakespearean or Petrarchan) on the topic.' },
        { id: 'haiku', label: 'üå∏ HAIKU', category: 'Creative & Media', instruction: 'Return traditional or modern haiku(s) capturing essence and seasonal reference.' },
        { id: 'poetic', label: 'üñãÔ∏è POETIC', category: 'Creative & Media', instruction: 'Respond in free verse or structured poetry form with rich imagery and rhythm.' },
        { id: 'cinematic', label: 'üé¨ CINEMATIC', category: 'Creative & Media', instruction: 'Respond as a film sequence: describe shots, lighting, camera movement and dramatic pacing.' },
        
        // --- ART STYLES (HISTORICAL) ---
        { id: 'renaissance', label: 'üñºÔ∏è RENAISSANCE', category: 'Art Styles', instruction: 'Respond in the style of Renaissance art: balanced composition, classical ideals, perspective, humanism.' },
        { id: 'baroque', label: 'üé≠ BAROQUE', category: 'Art Styles', instruction: 'Respond with dramatic intensity, ornate detail, strong contrast, movement and emotional grandeur.' },
        { id: 'romanticism', label: 'üåô ROMANTICISM', category: 'Art Styles', instruction: 'Respond with emotional depth, exaltation of nature, individualism, sublime beauty.' },
        { id: 'impressionism', label: 'üå∏ IMPRESSIONISM', category: 'Art Styles', instruction: 'Respond with loose brushwork feel, emphasis on light/color, fleeting moments.' },
        { id: 'expressionism', label: 'üò± EXPRESSIONISM', category: 'Art Styles', instruction: 'Respond with emotional distortion, bold colors, raw feeling and subjective inner experience.' },
        { id: 'cubism', label: 'üî≥ CUBISM', category: 'Art Styles', instruction: 'Respond fragmenting reality into geometric planes, multiple viewpoints and abstract reconfiguration.' },
        { id: 'surrealism', label: 'üï≥Ô∏è SURREALISM', category: 'Art Styles', instruction: 'Respond with dream-like scenes, unexpected juxtapositions, unconscious imagery and bizarre logic.' },
        { id: 'popart', label: 'üí• POP ART', category: 'Art Styles', instruction: 'Respond using bold colors, commercial imagery, irony, mass culture references and repetition.' },
        { id: 'minimalism', label: '‚¨ú MINIMALISM', category: 'Art Styles', instruction: 'Respond with extreme simplicity, clean lines, reduction to essentials and neutral tones.' },
        { id: 'cyberpunk', label: 'üåÜ CYBERPUNK', category: 'Art Styles', instruction: 'Respond with neon-noir aesthetics, high-tech low-life themes, and futuristic decay.' },
        { id: 'dadaism', label: 'üé≤ DADAISM', category: 'Art Styles', instruction: 'Respond with absurdity, irony, anti-art provocation, randomness and rejection of logic.' },
        { id: 'abstractexp', label: 'üåÄ ABSTRACT EXP', category: 'Art Styles', instruction: 'Respond with gestural spontaneity, large scale, emotional intensity and non-representational forms.' },
        { id: 'classicism', label: 'üèõÔ∏è CLASSICISM', category: 'Art Styles', instruction: 'Respond with harmony, clarity, restraint, proportion and inspiration from ancient Greece/Rome.' },
        { id: 'gothic', label: '‚õ™ GOTHIC', category: 'Art Styles', instruction: 'Respond with verticality, pointed arches, intricate detail, mysticism and spiritual aspiration.' },
        { id: 'realism', label: 'üëÅÔ∏è REALISM', category: 'Art Styles', instruction: 'Respond with objective depiction of everyday life, social truth and unidealized subjects.' },
        { id: 'symbolism', label: 'ü¶ã SYMBOLISM', category: 'Art Styles', instruction: 'Respond using metaphors, suggestion, mystery and evocation of ideas/feelings through symbols.' },
        { id: 'fauvism', label: 'üé® FAUVISM', category: 'Art Styles', instruction: 'Respond with wild bold colors, strong painterly qualities and emotional rather than realistic representation.' },
        { id: 'futurism', label: '‚ö° FUTURISM', category: 'Art Styles', instruction: 'Respond celebrating speed, technology, machinery, youth and violence with dynamic fragmentation.' },
        { id: 'constructivism', label: '‚öôÔ∏è CONSTRUCTIVISM', category: 'Art Styles', instruction: 'Respond with geometric abstraction, industrial materials and functional purpose serving society.' },
        { id: 'bauhaus', label: 'üè≠ BAUHAUS', category: 'Art Styles', instruction: 'Respond combining crafts and fine arts, functionality, clean modern design and "form follows function".' },
        { id: 'artdeco', label: 'üóº ART DECO', category: 'Art Styles', instruction: 'Respond with luxurious glamour, geometric patterns, bold colors and streamlined modern elegance.' },
        { id: 'postmodern', label: 'üÉè POSTMODERN', category: 'Art Styles', instruction: 'Respond with irony, pastiche, eclecticism, playful references and rejection of grand narratives.' },
        { id: 'conceptual', label: 'üí° CONCEPTUAL', category: 'Art Styles', instruction: 'Respond prioritizing idea over aesthetic, using text, documentation and minimal visual elements.' },
        { id: 'streetart', label: 'üé® STREET ART', category: 'Art Styles', instruction: 'Respond with urban energy, stencils, murals, social commentary and rebellious spirit.' },
        { id: 'operatic', label: 'üéº OPERATIC', category: 'Art Styles', instruction: 'Respond with grand emotional arias, dramatic recitatives and theatrical intensity.' },
        { id: 'jazz', label: 'üé∑ JAZZ', category: 'Art Styles', instruction: 'Respond with improvisation, syncopation, swing feel and spontaneous creative variation.' },
        { id: 'flamenco', label: 'üíÉ FLAMENCO', category: 'Art Styles', instruction: 'Respond with passionate duende, rhythmic footwork, intense emotion and raw vocal cries.' }
    ]
};

const SYSTEM_DATA = {
    TASK_TYPES: [
        // --- ANALYSIS & LOGIC ---
        { id: 'explain', label: 'üí° DEMYSTIFY', category: 'Analysis', instruction: 'Take the specific topic and break it down from first principles. Reveal the underlying logic clearly.' },
        { id: 'analysis', label: 'üîç DECONSTRUCT', category: 'Analysis', instruction: 'Perform a deep-dive analysis. Identify root causes, systemic connections, variables, and potential edge cases.' },
        { id: 'solve', label: 'üîë SOLVE', category: 'Analysis', instruction: 'Identify the core problem, explore multiple solution paths, evaluate feasibility, and deliver the resolution.' },
        { id: 'debug', label: 'üêû DEBUG', category: 'Analysis', instruction: 'Identify issues using multidisciplinary diagnostic approaches and propose fixes.' },
        { id: 'critique', label: 'üñãÔ∏è CRITIQUE', category: 'Analysis', instruction: 'Provide sharp, constructive criticism. Highlight strengths, expose weaknesses, and offer recommendations.' },
        { id: 'compare', label: '‚öñÔ∏è COMPARE', category: 'Analysis', instruction: 'Compare entities using rigorous criteria. Highlight trade-offs, synergies, and contextual suitability.' },
        { id: 'evaluate', label: 'üìä EVALUATE', category: 'Analysis', instruction: 'Assess using multicultural criteria, drawing from global standards and perspectives.' },
        { id: 'research', label: 'üî¨ RESEARCH', category: 'Analysis', instruction: 'Gather, evaluate, and integrate the most relevant and credible information into a well-supported overview.' },
        { id: 'forecast', label: 'üîÆ FORECAST', category: 'Analysis', instruction: 'Analyze current trends, drivers, and constraints to project plausible future scenarios.' },
        { id: 'debate', label: 'üó£Ô∏è DEBATE', category: 'Analysis', instruction: 'Simulate a multi-sided debate, presenting nuanced arguments from diverse cultural perspectives.' },
        { id: 'reflect', label: 'ü™û REFLECT', category: 'Analysis', instruction: 'Explore deeper implications, personal meaning, philosophical layers, or long-term consequences.' },
        { id: 'review', label: '‚≠ê REVIEW', category: 'Analysis', instruction: 'Provide balanced reviews incorporating international viewpoints and artistic critiques.' },
        { id: 'simulate', label: 'üß© SIMULATE', category: 'Analysis', instruction: 'Construct and run a mental or explicit simulation of a process, scenario, or system.' },
        
        // --- CREATION & DESIGN ---
        { id: 'create', label: '‚ú® IDEATE', category: 'Creation', instruction: 'Generate novel, non-obvious content. Combine disparate concepts from the context to create something original.' },
        { id: 'build', label: 'üõ†Ô∏è ARCHITECT', category: 'Creation', instruction: 'Construct a complete artifact (plan, blueprint, codebase) from start to finish.' },
        { id: 'design', label: 'üé® DESIGN', category: 'Creation', instruction: 'Craft interdisciplinary designs blending global artistic currents and functional needs.' },
        { id: 'brainstorm', label: 'üí≠ BRAINSTORM', category: 'Creation', instruction: 'Generate a wide spectrum of ideas, possibilities, and creative directions without judgment.' },
        { id: 'remix', label: 'üîÄ REMIX', category: 'Creation', instruction: 'Remix concepts across artistic currents and cultural boundaries.' },
        { id: 'write', label: '‚úçÔ∏è WRITE', category: 'Creation', instruction: 'Compose text focusing on voice, tone and narrative flow.' },
        { id: 'visualize', label: 'üëÅÔ∏è VISUALIZE', category: 'Creation', instruction: 'Translate abstract or complex ideas into clear visual metaphors, diagrams, or mental images.' },
        { id: 'experiment', label: 'üß™ EXPERIMENT', category: 'Creation', instruction: 'Design cross-disciplinary experiments blending science, art, and cultural methods.' },
        { id: 'roleplay', label: 'üé≠ ROLEPLAY', category: 'Creation', instruction: 'Assume a specific persona, historical figure, or expert role and respond fully in-character.' },
        { id: 'narrate', label: 'üìö NARRATE', category: 'Creation', instruction: 'Transform the topic into a compelling narrative with character, tension, and pacing.' },
        { id: 'fuse', label: 'üî• FUSE', category: 'Creation', instruction: 'Blend concepts from diverse cultures and disciplines into novel hybrids.' },
        
        // --- STRATEGY & PLANNING ---
        { id: 'plan', label: 'üó∫Ô∏è PLAN', category: 'Strategy', instruction: 'Create a detailed, phased plan with milestones, dependencies, resources, and risk mitigation.' },
        { id: 'optimize', label: '‚ö° OPTIMIZE', category: 'Strategy', instruction: 'Improve efficiency drawing from global best practices across disciplines.' },
        { id: 'strategize', label: '‚ôüÔ∏è STRATEGIZE', category: 'Strategy', instruction: 'Develop a high-level strategy to achieve the goal, considering competition and resources.' },
        { id: 'persuade', label: 'üóØÔ∏è PERSUADE', category: 'Strategy', instruction: 'Craft a compelling, evidence-backed argument to convince the audience of a specific position.' },
        { id: 'decolonize', label: '‚úä DECOLONIZE', category: 'Strategy', instruction: 'Challenge Western-centric views, incorporating indigenous and global south perspectives.' },
        { id: 'ecodesign', label: 'üåø ECODESIGN', category: 'Strategy', instruction: 'Create sustainable solutions inspired by biomimicry and traditional ecological knowledge.' },
        { id: 'mythweave', label: 'üßµ MYTHWEAVE', category: 'Strategy', instruction: 'Weave modern topics into ancient global mythological frameworks.' },
        { id: 'ritualize', label: 'üïØÔ∏è RITUALIZE', category: 'Strategy', instruction: 'Transform processes into ritualistic experiences drawing from world ceremonies.' },
        { id: 'polyrhythm', label: 'ü•Å POLYRHYTHM', category: 'Strategy', instruction: 'Layer multiple cultural rhythms and patterns into complex compositions.' },
        { id: 'transcend', label: 'üïäÔ∏è TRANSCEND', category: 'Strategy', instruction: 'Elevate ideas to spiritual or transcendental levels using global mystic traditions.' },
        { id: 'collaborate', label: 'üë• COLLABORATE', category: 'Strategy', instruction: 'Simulate multicultural team input for co-created outcomes.' },
        { id: 'harmonize', label: 'üéº HARMONIZE', category: 'Strategy', instruction: 'Unify disparate elements into cohesive wholes inspired by world music harmonies.' },
        
        // --- EDUCATION & SYNTHESIS ---
        { id: 'teach', label: 'üìñ TEACH', category: 'Education', instruction: 'Design a learning path. Introduce the concept, show a concrete example, explain the nuance.' },
        { id: 'summarize', label: 'üìù SUMMARIZE', category: 'Education', instruction: 'Condense complex or lengthy input into its purest essence. Retain all critical meaning.' },
        { id: 'translate', label: 'üåê TRANSLATE', category: 'Education', instruction: 'Translate across languages while adapting cultural nuances and idiomatic expressions.' },
        { id: 'simplify', label: 'üë∂ SIMPLIFY', category: 'Education', instruction: 'Rewrite the content so a 5-year-old could understand it, using simple analogies.' },
        { id: 'synthesize', label: 'üîó SYNTHESIZE', category: 'Education', instruction: 'Combine multiple sources or ideas into a coherent new understanding or framework.' },
        { id: 'improve', label: '‚úçÔ∏è IMPROVE', category: 'Education', instruction: 'Critique the input. Optimize for clarity, efficiency, and impact. Explain specifically what was improved.' }
    ],
    
    VOICES: [
        // --- PROFESSIONAL ---
        { id: 'neutral', label: '‚öñÔ∏è OBJECTIVE', category: 'Professional', instruction: 'Maintain a bias-free, factual, and observably detached tone.' },
        { id: 'authoritative', label: 'üéì EXPERT', category: 'Professional', instruction: 'Use decisive, unwavering language. Project absolute confidence.' },
        { id: 'formal', label: 'üé© ELEGANT', category: 'Professional', instruction: 'Employ polished, sophisticated language with impeccable structure and decorum.' },
        { id: 'business', label: 'üíº CORPORATE', category: 'Professional', instruction: 'Use standard business terminology, concise and result-oriented.' },
        { id: 'scientific', label: 'üî¨ SCIENTIFIC', category: 'Professional', instruction: 'Use rigorous terminology, evidence-based claims, and clinical detachment.' },
        { id: 'journalistic', label: 'üì∞ NEWS', category: 'Professional', instruction: 'Report with who/what/when/where/why, blending global media styles.' },
        
        // --- EMOTIONAL & HUMAN ---
        { id: 'friendly', label: 'üòä FRIENDLY', category: 'Emotional', instruction: 'Use an inviting, encouraging, and psychologically safe tone.' },
        { id: 'empathetic', label: 'ü§ó EMPATHETIC', category: 'Emotional', instruction: 'Show deep understanding of emotions. Validate feelings and offer gentle guidance.' },
        { id: 'enthusiastic', label: 'üî• ENERGETIC', category: 'Emotional', instruction: 'Convey genuine excitement and high energy through vivid language and exclamation.' },
        { id: 'playful', label: 'üéà PLAYFUL', category: 'Emotional', instruction: 'Infuse fun wordplay, light teasing, and imaginative flair.' },
        { id: 'humorous', label: 'üòÇ WITTY', category: 'Emotional', instruction: 'Employ sharp wit, irony, and light-hearted humor while staying on-topic.' },
        { id: 'romantic', label: '‚ù§Ô∏è PASSIONATE', category: 'Emotional', instruction: 'Evoke intimacy and desire inspired by ghazals, sonnets, and boleros.' },
        { id: 'childlike', label: 'üë∂ INNOCENT', category: 'Emotional', instruction: 'Speak with curiosity and simplicity, like worldwide children\'s folklore.' },
        { id: 'folksy', label: 'üçÄ FOLKSY', category: 'Emotional', instruction: 'Use homespun wisdom from Appalachian ballads or African proverbs.' },
        { id: 'ecstatic', label: 'üåà ECSTATIC', category: 'Emotional', instruction: 'Overflow with bhakti devotion or gospel exaltation.' },
        { id: 'melancholic', label: 'üåßÔ∏è MELANCHOLIC', category: 'Emotional', instruction: 'Lament softly with Irish keening or Portuguese fado.' },
        
        // --- STYLE & ATMOSPHERE ---
        { id: 'poetic', label: 'üñãÔ∏è POETIC', category: 'Stylized', instruction: 'Use metaphor, rhythm, and sensory imagery to paint a picture with words.' },
        { id: 'dramatic', label: 'üé≠ DRAMATIC', category: 'Stylized', instruction: 'Heighten stakes with powerful language, tension, and vivid dramatic flair.' },
        { id: 'mysterious', label: 'üïØÔ∏è MYSTERIOUS', category: 'Stylized', instruction: 'Hint rather than state directly. Build intrigue through implication and shadow.' },
        { id: 'sarcastic', label: 'üòè SARCASTIC', category: 'Stylized', instruction: 'Use subtle irony, understatement, and clever mockery.' },
        { id: 'cynical', label: 'üòí CYNICAL', category: 'Stylized', instruction: 'Express doubt and subtle disillusionment while remaining intellectually sharp.' },
        { id: 'urgent', label: 'üö® URGENT', category: 'Stylized', instruction: 'Convey time-sensitive alarms, drawing from global crisis narratives.' },
        { id: 'nostalgic', label: 'üìª NOSTALGIC', category: 'Stylized', instruction: 'Evoke past memories through saudade or melancholy.' },
        { id: 'rebellious', label: '‚úä REBELLIOUS', category: 'Stylized', instruction: 'Challenge norms with punk energy mixed with global protest songs.' },
        { id: 'shamanic', label: 'üïØÔ∏è SHAMANIC', category: 'Stylized', instruction: 'Invoke spirits with rhythmic chants from Siberian to Amazonian traditions.' },
        { id: 'operatic', label: 'üéº OPERATIC', category: 'Stylized', instruction: 'Swell with arias of passion, blending Italian opera and Chinese jingju.' },
        { id: 'surreal', label: 'üï≥Ô∏è SURREAL', category: 'Stylized', instruction: 'Warp reality with Dali-esque twists and Latin magical realism.' },
        { id: 'ritualistic', label: 'üïäÔ∏è RITUALISTIC', category: 'Stylized', instruction: 'Perform with incantatory repetition from Voodoo to Shinto rites.' },
        { id: 'nomadic', label: 'üèúÔ∏è NOMADIC', category: 'Stylized', instruction: 'Roam freely like Tuareg poetry or Gypsy flamenco tales.' },
        { id: 'imperial', label: 'üèØ IMPERIAL', category: 'Stylized', instruction: 'Decree with Ottoman grandeur or Incan authority.' },
        { id: 'warrior', label: 'üõ°Ô∏è WARRIOR', category: 'Stylized', instruction: 'Charge with Maori haka power or Samurai bushido resolve.' },
        { id: 'visionary', label: 'üîÆ VISIONARY', category: 'Stylized', instruction: 'Foreshadow with oracle-like insight from Delphi to Mayan calendars.' },
        { id: 'harmonious', label: 'üéº HARMONIOUS', category: 'Stylized', instruction: 'Blend voices like Balinese gamelan or Native American circle songs.' },
        { id: 'confident', label: 'üí™ CONFIDENT', category: 'Stylized', instruction: 'Project certainty with warrior-like conviction from diverse cultures.' },
        { id: 'whisper', label: 'ü§´ WHISPER', category: 'Stylized', instruction: 'Share confidences softly, like Sufi whispers or indigenous dream talks.' },
        { id: 'concise', label: '‚úÇÔ∏è CONCISE', category: 'Stylized', instruction: 'Maximize information density. Remove all fluff. Be surgical.' },
        { id: 'minimalist', label: '‚¨ú MINIMALIST', category: 'Stylized', instruction: 'Use deliberate brevity, inspired by haiku and zen koans.' },
        
        // --- NARRATIVE ---
        { id: 'narrative', label: 'üìñ NARRATIVE', category: 'Narrative', instruction: 'Speak as a masterful storyteller, weaving events into a compelling flow.' },
        { id: 'epic', label: '‚öîÔ∏è EPIC', category: 'Narrative', instruction: 'Narrate grandly, echoing epics from Gilgamesh to Mahabharata.' },
        { id: 'mythic', label: 'üóø MYTHIC', category: 'Narrative', instruction: 'Use archetypal language suitable for legends and myths.' },
        { id: 'philosophical', label: 'ü§î PROFOUND', category: 'Narrative', instruction: 'Explore deeper truths and existential questions with reflective insight.' }
    ],
    
    LENGTH: [
        // --- SHORT FORM ---
        { id: 'one-liner', label: 'üí¨ 1 LINE', category: 'Micro', instruction: 'A single punchy sentence. Max 20 words.' },
        { id: 'caption', label: 'üì∏ CAPTION', category: 'Micro', instruction: '1-2 sentences. Ideal for social captions or hooks.' },
        { id: 'tweet', label: 'üê¶ TWEET', category: 'Micro', instruction: 'Max 280 characters. Single idea. Immediate impact.' },
        { id: 'instant', label: '‚ö° 15 SEC', category: 'Micro', instruction: 'Max 50 words. No fluff. Direct answer.' },
        { id: 'hook', label: 'üé£ HOOK', category: 'Micro', instruction: 'Powerful opening. 1-3 sentences designed to grab immediate attention.' },
        
        // --- MEDIUM FORM ---
        { id: 'flash', label: '‚ú® 1 MIN', category: 'Medium', instruction: '150-200 words. Quick read, clear and direct.' },
        { id: 'quick', label: 'üìÑ 2 MIN', category: 'Medium', instruction: '300-400 words. Short but complete response.' },
        { id: 'bite', label: 'üç™ 3 MIN', category: 'Medium', instruction: '500-600 words. Bite-sized article length.' },
        { id: 'coffee', label: '‚òï 5 MIN', category: 'Medium', instruction: '800-1000 words. Standard blog post length.' },
        
        // --- LONG FORM ---
        { id: 'focus', label: 'üß† 8 MIN', category: 'Long', instruction: '1200-1600 words. Medium depth with structure.' },
        { id: 'deep', label: 'üîç 10 MIN', category: 'Long', instruction: '1800-2200 words. Deep dive immersion.' },
        { id: 'longread', label: 'üìú 15 MIN', category: 'Long', instruction: '2500-3500 words. Detailed essay or guide.' },
        { id: 'essay', label: '‚úçÔ∏è 20 MIN', category: 'Long', instruction: '4000-5000 words. Exhaustive essay.' },
        { id: 'feature', label: 'üì∞ 30 MIN', category: 'Long', instruction: '6000-8000 words. In-depth reportage.' },
        { id: 'chapter', label: 'üìñ 45+ MIN', category: 'Long', instruction: '>10,000 words. Book chapter or extensive treatise.' },
        
        // --- STRUCTURED ---
        { id: 'snippet', label: 'üß© SNIPPET', category: 'Structure', instruction: 'Brief reusable fragment.' },
        { id: 'summary', label: 'üßæ SUMMARY', category: 'Structure', instruction: 'Clear synthesis of key points.' },
        { id: 'tldr', label: '‚ö° TL;DR', category: 'Structure', instruction: 'Ultra short summary of everything.' },
        { id: 'bullets', label: 'üîπ BULLETS', category: 'Structure', instruction: 'Response as clear, concise bullet points.' },
        { id: 'outline', label: 'üóÇÔ∏è OUTLINE', category: 'Structure', instruction: 'Hierarchical outline with sections and subsections.' },
        { id: 'sections', label: 'üß© SECTIONS', category: 'Structure', instruction: 'Content divided into clear sections with brief titles.' },
        { id: 'framework', label: 'üèóÔ∏è FRAMEWORK', category: 'Structure', instruction: 'Reusable framework with steps or conceptual blocks.' },
        { id: 'essential', label: '‚¨ú ESSENTIAL', category: 'Structure', instruction: 'As brief as possible without losing anything important.' },
        { id: 'full', label: 'üß† FULL', category: 'Structure', instruction: 'Everything necessary, no artificial length limit.' }
    ],
    
    LEVELS: [
        { id: 'l1', label: '- Level 1: Surface', category: 'Basic', instruction: '- Level 1: Surface. Simple definitions and basic concepts.' },
        { id: 'l2', label: '- Level 2: Context', category: 'Basic', instruction: '- Level 2: Context. Connecting concepts to the wider world.' },
        { id: 'l3', label: '- Level 3: Mechanics', category: 'Intermediate', instruction: '- Level 3: Mechanics. How it works, underlying logic and rules.' },
        { id: 'l4', label: '- Level 4: Nuance', category: 'Advanced', instruction: '- Level 4: Nuance. Edge cases, exceptions, and subtle distinctions.' },
        { id: 'l5', label: '- Level 5: Mastery', category: 'Advanced', instruction: '- Level 5: Mastery. Expert synthesis, innovation and deep insight.' }
    ],

    RESTRICTIONS: [
        "Strict format.", 
        "No filler.", 
        "Align tone.", 
        "Integrate context.", 
        "Complete output.", 
        "Always respond in English even if the question is asked in another language.",
        "Do NOT bold or highlight target vocabulary words in the output."
    ]
};

/* 2. GLOBAL STATE */
let lastGeneratedPrompt = ""; 
let currentData = SYSTEM_DATA; 
let nexusHistory = [];
const NEXUS_STORAGE_KEY = 'nexus_prompt_history';
const MDC_VOCAB_KEY = 'mdc_vocab_list';
const PREF_AUDIO_VOICE = 'nexus_audio_voice';
const PREF_AUDIO_SPEED = 'nexus_audio_speed';
let availableVoices = [];

// MODAL STATE
let activeSelectionId = null; 

// PILL STATE
let currentStatsContext = null;
let currentWordStats = { occurrences: "-", uniqueTotal: 0 };
let lastStorageString = "";

// VARS LONG PRESS
let pressTimer;
let isLongPressHandled = false;
let pendingPhraseStartIdx = null; 
let tempSelectedItem = null;

/* 3. INITIALIZATION */
document.addEventListener('DOMContentLoaded', () => {
    loadHistory('contextInput', 'context-history');
    loadHistory('topicInput', 'topic-history');
    loadNexusHistory();
    loadVocabFolders();
    startStorageWatcher(); 
    initMagicCircle(); 
    
    if(window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();
    }
});

/* === UNIVERSAL MODAL LOGIC === */
function openModal(elementId) {
    tempSelectedItem = null;
    document.getElementById('preview-panel').classList.add('hidden-panel');
    
    if (elementId === 'taskSelect' && document.getElementById('useVocabCheckbox').checked) {
        const fakeVocabTasks = VOCAB_TASKS.map(t => ({...t, category: 'Vocab Practice'}));
        activeSelectionId = elementId;
        renderGrid(fakeVocabTasks, elementId);
        document.getElementById('modal-title').innerText = "Select Vocabulary Task";
    } else {
        activeSelectionId = elementId;
        const data = getDataForId(elementId);
        if(!data) return;
        renderGrid(data, elementId);
        
        const label = document.querySelector(`label[for="${elementId}"]`) || document.querySelector(`div:has(> #${elementId}) label`);
        document.getElementById('modal-title').innerText = label ? `Select ${label.innerText}` : "Select Option";
    }

    document.getElementById('universal-modal').classList.add('active');
    document.getElementById('modalSearch').value = "";
    document.getElementById('modalSearch').focus();
}

function closeModal() {
    document.getElementById('universal-modal').classList.remove('active');
    activeSelectionId = null;
}

function getDataForId(id) {
    switch(id) {
        case 'modeSelect': return COMMON_DATA.MODES;
        case 'formatSelect': return COMMON_DATA.FORMATS;
        case 'taskSelect': return SYSTEM_DATA.TASK_TYPES;
        case 'voiceSelect': return SYSTEM_DATA.VOICES;
        case 'lengthSelect': return SYSTEM_DATA.LENGTH;
        case 'levelSelect': return SYSTEM_DATA.LEVELS;
        default: return [];
    }
}

function renderGrid(dataArray, targetId, filterText = "") {
    const grid = document.getElementById('universal-grid');
    grid.innerHTML = "";
    const currentVal = document.getElementById(targetId).value;
    const filter = filterText.toLowerCase();

    const groups = {};
    dataArray.forEach(item => {
        if (item.label.toLowerCase().includes(filter) || (item.category && item.category.toLowerCase().includes(filter))) {
            const cat = item.category || "General";
            if (!groups[cat]) groups[cat] = [];
            groups[cat].push(item);
        }
    });

    for (const [catName, items] of Object.entries(groups)) {
        const header = document.createElement('div');
        header.className = 'grid-category-header';
        header.textContent = `--- ${catName} ---`;
        grid.appendChild(header);

        items.forEach(item => {
            const card = document.createElement('div');
            let valCheck = (activeSelectionId === 'levelSelect') ? item.instruction : item.id;
            let isSel = (valCheck === currentVal);
            
            card.className = `mode-card ${isSel ? 'selected' : ''}`;
            card.id = `card-${item.id}`; 
            
            card.onclick = () => previewOption(item);
            card.ondblclick = () => { previewOption(item); confirmSelection(); };

            let icon = "üîπ";
            let labelClean = item.label;
            const emojiMatch = item.label.match(/^([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/);
            if (emojiMatch) { icon = emojiMatch[0]; labelClean = item.label.substring(icon.length).trim(); }

            card.innerHTML = `
                <div class="mode-icon">${icon}</div>
                <div class="mode-label">${labelClean}</div>
                <div class="mode-sub">${item.category}</div>
            `;
            grid.appendChild(card);
        });
    }
}

function filterGrid() {
    const text = document.getElementById('modalSearch').value;
    if (activeSelectionId === 'taskSelect' && document.getElementById('useVocabCheckbox').checked) {
        const fakeVocabTasks = VOCAB_TASKS.map(t => ({...t, category: 'Vocab Practice'}));
        renderGrid(fakeVocabTasks, activeSelectionId, text);
    } else {
        const data = getDataForId(activeSelectionId);
        renderGrid(data, activeSelectionId, text);
    }
}

function previewOption(item) {
    tempSelectedItem = item;
    
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active-preview'));
    const card = document.getElementById(`card-${item.id}`);
    if(card) card.classList.add('active-preview');

    const panel = document.getElementById('preview-panel');
    const title = document.getElementById('preview-title');
    const content = document.getElementById('preview-content');

    title.innerHTML = item.label;
    
    let detailsHTML = "";
    
    if (item.role) {
        detailsHTML += `<div class="detail-row"><strong>üé≠ Role:</strong> ${item.role}</div>`;
        detailsHTML += `<div class="detail-row"><strong>üé® Style:</strong> ${item.style}</div>`;
        detailsHTML += `<div class="detail-row"><strong>üéØ Goal:</strong> ${item.goal}</div>`;
    } 
    else if (item.instruction) {
        detailsHTML += `<div class="detail-row"><strong>üìù Instruction:</strong> ${item.instruction}</div>`;
    }

    content.innerHTML = detailsHTML;
    panel.classList.remove('hidden-panel');
}

function confirmSelection() {
    if (!tempSelectedItem || !activeSelectionId) return;
    
    const item = tempSelectedItem;

    if (activeSelectionId === 'levelSelect') {
        document.getElementById(activeSelectionId).value = item.instruction; 
    } else {
        document.getElementById(activeSelectionId).value = item.id;
    }

    const displayId = activeSelectionId.replace('Select', 'Display');
    const displayInput = document.getElementById(displayId);
    if(displayInput) displayInput.value = item.label;

    if (activeSelectionId === 'taskSelect') syncModeWithTask();

    closeModal();
}

/* === MAGIC CIRCLE LOGIC (MDC) === */
function initMagicCircle() {
    const circle = document.getElementById('magic-circle');
    let lastTarget = null;
    circle.addEventListener('touchmove', (e) => {
        e.preventDefault(); const touch = e.touches[0];
        circle.style.left = (touch.clientX - 25) + 'px'; circle.style.top = (touch.clientY - 25) + 'px';
        circle.style.visibility = 'hidden'; let elem = document.elementFromPoint(touch.clientX, touch.clientY); circle.style.visibility = 'visible';
        if (elem && elem.classList.contains('interactive-word')) { if (lastTarget !== elem) { lastTarget = elem; handleHoverStart(elem); } } 
        else { if (lastTarget) { handleHoverEnd(); lastTarget = null; } }
    }, { passive: false });
    circle.addEventListener('touchend', () => { if(lastTarget) { handleHoverEnd(); lastTarget = null; } });
}

/* === REAL-TIME SYNC ENGINE === */
function startStorageWatcher() {
    lastStorageString = localStorage.getItem(MDC_VOCAB_KEY) || "";
    setInterval(() => {
        const currentString = localStorage.getItem(MDC_VOCAB_KEY) || "";
        if (currentString !== lastStorageString) { lastStorageString = currentString; loadVocabFolders(); refreshActiveView(); }
    }, 500);
}

function refreshActiveView() {
    const activeContent = document.querySelector('.accordion-content.active .interactive-content');
    if (!activeContent) return;
    const rawData = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]');
    const savedWordsSet = new Set();
    const savedPhrases = [];
    const extract = (obj) => { const text = sanitizeText(obj.eng).toLowerCase(); if(text.includes(" ")) savedPhrases.push(text); else savedWordsSet.add(text); };
    rawData.forEach(item => { if(item.isFolder && item.items) item.items.forEach(sub => extract(sub)); else if(!item.isFolder && item.eng) extract(item); });
    const allWords = Array.from(activeContent.querySelectorAll('.interactive-word'));
    allWords.forEach(el => { if (!el.classList.contains('phrase-selecting')) { el.classList.remove('saved', 'phrase-saved'); } });
    allWords.forEach(el => { const clean = sanitizeText(el.innerText).toLowerCase(); if (savedWordsSet.has(clean) && !el.classList.contains('phrase-selecting')) { el.classList.add('saved'); } });
    savedPhrases.sort((a, b) => b.length - a.length);
    const lineTextArr = allWords.map(el => sanitizeText(el.innerText).toLowerCase());
    savedPhrases.forEach(phrase => {
        const phraseArr = phrase.split(" ");
        for (let i = 0; i <= lineTextArr.length - phraseArr.length; i++) {
            let match = true; for (let j = 0; j < phraseArr.length; j++) { if (lineTextArr[i + j] !== phraseArr[j]) { match = false; break; } }
            if (match) { for (let k = 0; k < phraseArr.length; k++) { const targetEl = allWords[i + k]; if (!targetEl.classList.contains('phrase-selecting')) { targetEl.classList.add('phrase-saved'); } } }
        }
    });
    currentStatsContext = activeContent; updateUnifiedPill(null);
}

/* === INTERACTION LOGIC === */
function startPress(el) { isLongPressHandled = false; pressTimer = setTimeout(() => { handleLongPress(el); isLongPressHandled = true; }, 500); }
function endPress(el, e) { clearTimeout(pressTimer); if(e.type === 'touchend' && isLongPressHandled) { e.preventDefault(); } }
let hoverTimerRef;
function handleHoverStart(el) { clearTimeout(hoverTimerRef); hoverTimerRef = setTimeout(() => { const rawText = el.innerText.replace(/[^a-zA-Z0-9]/g, ""); translateWord(rawText); }, 500); }
function handleHoverEnd() { clearTimeout(hoverTimerRef); }
function handleShortClick(el) { if (isLongPressHandled) return; if (document.querySelector('.interactive-word.phrase-selecting')) { clearManualSelection(); return; } saveWordToMDC(el.innerText, el); }

function handleLongPress(el) {
    if (navigator.vibrate) navigator.vibrate(50);
    const currentIdx = parseInt(el.dataset.idx);
    if (el.classList.contains('phrase-saved')) {
        const contentDiv = el.closest('.interactive-content');
        const allWords = Array.from(contentDiv.querySelectorAll('.interactive-word'));
        const textArr = allWords.map(w => sanitizeText(w.innerText).toLowerCase());
        const rawData = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]');
        let savedPhrases = [];
        const extractPhrases = (list) => { list.forEach(item => { if (item.isFolder) extractPhrases(item.items); else if (item.eng && item.eng.includes(" ")) savedPhrases.push(item.eng.toLowerCase()); }); };
        extractPhrases(rawData); savedPhrases.sort((a, b) => b.length - a.length);
        let phraseToDelete = null;
        for (let phrase of savedPhrases) {
            const phraseArr = phrase.split(" ");
            for (let i = 0; i <= textArr.length - phraseArr.length; i++) {
                let match = true; for (let j = 0; j < phraseArr.length; j++) { if (textArr[i + j] !== phraseArr[j]) { match = false; break; } }
                if (match) { if (currentIdx >= i && currentIdx < i + phraseArr.length) { phraseToDelete = phrase; break; } }
            }
            if (phraseToDelete) break;
        }
        if (phraseToDelete) { if (navigator.vibrate) navigator.vibrate([50, 100]); deletePhraseFromDB(phraseToDelete); clearManualSelection(); refreshActiveView(); }
        return; 
    }
    if (pendingPhraseStartIdx === null) {
        clearManualSelection(); el.classList.add('phrase-selecting'); el.dataset.userSelected = "true"; pendingPhraseStartIdx = currentIdx;
    } else {
        const contentDiv = el.closest('.interactive-content');
        const start = Math.min(pendingPhraseStartIdx, currentIdx); const end = Math.max(pendingPhraseStartIdx, currentIdx);
        if (end - start > 12) { if (navigator.vibrate) navigator.vibrate([50, 50]); clearManualSelection(); return; }
        const allWords = Array.from(contentDiv.querySelectorAll('.interactive-word'));
        for (let i = start; i <= end; i++) { const w = allWords.find(wd => parseInt(wd.dataset.idx) === i); if (w) { w.classList.add('phrase-selecting'); w.dataset.userSelected = "true"; } }
        pendingPhraseStartIdx = null; checkSelectionState(el); 
    }
}
function deletePhraseFromDB(phraseText) {
    let items = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]'); const target = sanitizeText(phraseText).toLowerCase();
    const recursiveFilter = (list) => { return list.filter(item => { if (item.isFolder) { item.items = recursiveFilter(item.items); return true; } return sanitizeText(item.eng).toLowerCase() !== target; }); };
    items = recursiveFilter(items); localStorage.setItem(MDC_VOCAB_KEY, JSON.stringify(items));
}
function clearManualSelection() { document.querySelectorAll('.phrase-selecting').forEach(el => { el.classList.remove('phrase-selecting'); delete el.dataset.userSelected; }); pendingPhraseStartIdx = null; const pill = document.getElementById('unified-pill'); if(pill) pill.classList.remove('selection-mode'); }

function checkSelectionState(element) {
    const contentDiv = element.closest('.interactive-content') || currentStatsContext; if (!contentDiv) return;
    const selected = Array.from(contentDiv.querySelectorAll('.phrase-selecting')); 
    const pill = document.getElementById('unified-pill'); 
    const saveBtn = document.getElementById('pill-save-btn');
    
    if(selected.length > 0) { 
        pill.classList.add('visible'); 
        pill.classList.add('selection-mode'); 
        saveBtn.innerHTML = `üíæ SAVE`;
        
        selected.sort((a,b) => parseInt(a.dataset.idx) - parseInt(b.dataset.idx));
        const phraseText = selected.map(el => sanitizeText(el.innerText)).join(" ");
        translateWord(phraseText); 
        
    } else { 
        pill.classList.remove('selection-mode'); 
    }
}

function savePhraseFromPill() {
    if (!currentStatsContext) return; const selected = Array.from(currentStatsContext.querySelectorAll('.phrase-selecting')); if (selected.length === 0) return;
    selected.sort((a,b) => parseInt(a.dataset.idx) - parseInt(b.dataset.idx)); const phraseText = selected.map(el => sanitizeText(el.innerText)).join(" ");
    forceSavePhrase(phraseText, currentStatsContext); clearManualSelection(); refreshActiveView(); 
}
function forceSavePhrase(cleanPhrase, elementContext) {
    if (!cleanPhrase) return; let items = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]'); const checkEng = cleanPhrase.toLowerCase(); let exists = false;
    items.forEach(i => { if (!i.isFolder && i.eng && sanitizeText(i.eng).toLowerCase() === checkEng) exists = true; if (i.isFolder && i.items) { i.items.forEach(sub => { if (sub.eng && sanitizeText(sub.eng).toLowerCase() === checkEng) exists = true; }); } });
    if (exists) { alert("Phrase already saved."); return; }
    const accordionItem = elementContext.closest('.accordion-item'); const folderName = accordionItem ? accordionItem.querySelector('.header-content strong').innerText.trim() : "AI Generator";
    const newItem = { id: Date.now(), isFolder: false, eng: cleanPhrase, esp: "", isHighlighted: false, dateAdded: Date.now() };
    let targetFolder = items.find(i => i.isFolder && i.name.toLowerCase() === folderName.toLowerCase());
    if (targetFolder) { targetFolder.items.unshift(newItem); items = items.filter(i => i.id !== targetFolder.id); items.unshift(targetFolder); } else { const newFolder = { id: Date.now() + 1, isFolder: true, name: folderName, items: [newItem] }; items.unshift(newFolder); }
    localStorage.setItem(MDC_VOCAB_KEY, JSON.stringify(items));
}

function updateUnifiedPill(translationData = null) {
    const pill = document.getElementById('unified-pill'); const statsText = document.getElementById('pill-stats-text'); const transPart = document.getElementById('pill-trans'); const divider = document.getElementById('pill-divider'); const transResult = document.getElementById('trans-result'); const speakBtn = document.getElementById('pill-speak');
    if (!currentStatsContext) { pill.classList.remove('visible'); return; }
    pill.classList.add('visible'); const savedElements = currentStatsContext.querySelectorAll('.interactive-word.saved, .interactive-word.phrase-saved');
    const uniqueSet = new Set(); savedElements.forEach(el => uniqueSet.add(sanitizeText(el.innerText).toLowerCase()));
    currentWordStats.uniqueTotal = uniqueSet.size; currentWordStats.occurrences = savedElements.length;
    statsText.innerText = `${currentWordStats.occurrences} | ${currentWordStats.uniqueTotal}`;
    if(currentWordStats.uniqueTotal > 0) statsText.classList.add('stats-active'); else statsText.classList.remove('stats-active');
    
    if (translationData) { 
        divider.style.display = 'block'; 
        transPart.classList.add('active'); 
        transResult.innerText = translationData.result; 
        speakBtn.onclick = () => speakText(translationData.origin); 
    } else if (!transPart.classList.contains('active')) { 
        divider.style.display = 'none'; 
    }
}
async function translateWord(text) {
    const transPart = document.getElementById('pill-trans'); transPart.dataset.hasActive = "true"; updateUnifiedPill({ result: "...", origin: text });
    try { const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=es&dt=t&q=${encodeURIComponent(text)}`); const data = await res.json(); let result = "Not found"; if (data && data[0] && data[0][0]) result = data[0][0][0]; updateUnifiedPill({ result: result, origin: text }); } catch (e) { updateUnifiedPill({ result: "Error", origin: text }); }
}
function toggleAccordion(id) {
    const content = document.getElementById(`content-${id}`); const isVisible = content.classList.contains('active'); document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('active')); clearManualSelection();
    if (!isVisible) { content.classList.add('active'); setTimeout(refreshActiveView, 50); currentStatsContext = content.querySelector('.interactive-content'); currentWordStats.occurrences = "-"; updateUnifiedPill(null); } else { currentStatsContext = null; updateUnifiedPill(null); }
}
function saveWordToMDC(word, element) {
    translateWord(word); const cleanWord = sanitizeText(word); if (!cleanWord) return;
    let items = JSON.parse(localStorage.getItem(MDC_VOCAB_KEY) || '[]'); const checkEng = cleanWord.toLowerCase(); let wordFound = false;
    items.forEach(i => { if (!i.isFolder && i.eng && sanitizeText(i.eng).toLowerCase() === checkEng) wordFound = true; if (i.isFolder && i.items) { i.items.forEach(sub => { if (sub.eng && sanitizeText(sub.eng).toLowerCase() === checkEng) wordFound = true; }); } });
    const accordionItem = element.closest('.accordion-item'); const folderName = accordionItem ? accordionItem.querySelector('.header-content strong').innerText.trim() : "AI Generator";
    if (!wordFound) { const newItem = { id: Date.now(), isFolder: false, eng: cleanWord, esp: "", isHighlighted: false, dateAdded: Date.now() }; let targetFolder = items.find(i => i.isFolder && i.name.toLowerCase() === folderName.toLowerCase()); if (targetFolder) { targetFolder.items.unshift(newItem); items = items.filter(i => i.id !== targetFolder.id); items.unshift(targetFolder); } else { const newFolder = { id: Date.now() + 1, isFolder: true, name: folderName, items: [newItem] }; items.unshift(newFolder); } } else { items.forEach(folder => { if (folder.isFolder && folder.items) { folder.items = folder.items.filter(item => sanitizeText(item.eng).toLowerCase() !== checkEng); } }); items = items.filter(i => i.isFolder || (i.eng && sanitizeText(i.eng).toLowerCase() !== checkEng)); }
    localStorage.setItem(MDC_VOCAB_KEY, JSON.stringify(items));
}

/* === REST OF APP LOGIC === */
function loadVocabFolders() {
    const raw = localStorage.getItem(MDC_VOCAB_KEY); const group = document.getElementById('folder-group'); const badge = document.getElementById('vocab-count-badge');
    if(!raw) { badge.innerText = "No DB"; badge.style.color = "#cf6679"; return; } const data = JSON.parse(raw); group.innerHTML = ''; let total = 0;
    data.forEach(item => { if(item.isFolder) { let opt = document.createElement('option'); opt.value = `folder:${item.id}`; opt.textContent = `${item.name} (${item.items.length})`; group.appendChild(opt); total += item.items.length; } else total++; });
    badge.innerText = `${total} words`; badge.style.color = "#00ffcc";
}

function toggleVocabMode() {
    const isActive = document.getElementById('useVocabCheckbox').checked; const settings = document.getElementById('vocab-settings'); const controlsPanel = document.getElementById('vocab-controls'); const topicInput = document.getElementById('topicInput'); 
    settings.style.display = isActive ? 'block' : 'none';
    if (isActive) {
        controlsPanel.classList.add('active-panel'); loadVocabFolders(); topicInput.value = "Target Vocabulary List"; topicInput.disabled = true;
        syncModeWithTask();
    } else {
        controlsPanel.classList.remove('active-panel'); topicInput.value = ""; topicInput.disabled = false;
        document.getElementById('taskDisplay').value = "üí° DEMYSTIFY";
        document.getElementById('taskSelect').value = "explain";
    }
}

function syncModeWithTask() {
    if (!document.getElementById('useVocabCheckbox').checked) return;
    const taskId = document.getElementById('taskSelect').value;
    const task = VOCAB_TASKS.find(t => t.id === taskId);
    if (task && task.linkedMode) {
        const modeObj = COMMON_DATA.MODES.find(m => m.id === task.linkedMode);
        if(modeObj) {
            document.getElementById('modeSelect').value = modeObj.id;
            document.getElementById('modeDisplay').value = modeObj.label;
        }
        document.getElementById('taskDisplay').value = task.label;
    }
}

function getSelectedVocab() {
    if (!document.getElementById('useVocabCheckbox').checked) return null;
    const source = document.getElementById('vocabSource').value; const amount = parseInt(document.getElementById('vocabAmount').value); const raw = localStorage.getItem(MDC_VOCAB_KEY); if(!raw) return [];
    const data = JSON.parse(raw); let pool = [];
    if (source === 'all') { data.forEach(i => i.isFolder ? pool.push(...i.items) : pool.push(i)); } else if (source === 'highlighted') { data.forEach(i => { if(i.isFolder) pool.push(...i.items.filter(x=>x.isHighlighted)); else if(i.isHighlighted) pool.push(i); }); } else if (source.startsWith('folder:')) { const fid = parseInt(source.split(':')[1]); const f = data.find(i => i.id === fid); if(f) pool = f.items; } else if (source === 'recent') { let all = []; data.forEach(i => i.isFolder ? all.push(...i.items) : all.push(i)); all.sort((a,b) => b.id - a.id); pool = all.slice(0, 10); }
    if(pool.length === 0) return []; return pool.sort(() => 0.5 - Math.random()).slice(0, amount).map(i => i.eng);
}

function loadVoices() { availableVoices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en')); document.querySelectorAll('.daw-select').forEach(sel => updateVoiceSelect(sel)); }
function updateVoiceSelect(select) { const savedVoiceURI = localStorage.getItem(PREF_AUDIO_VOICE); select.innerHTML = ''; availableVoices.forEach(v => { const opt = document.createElement('option'); opt.value = v.voiceURI; opt.textContent = v.name.substring(0, 18); select.appendChild(opt); }); if(savedVoiceURI) select.value = savedVoiceURI; }
function updateAudioLive(id) { const speed = document.getElementById(`speed-${id}`).value; const voiceURI = document.getElementById(`voice-${id}`).value; localStorage.setItem(PREF_AUDIO_SPEED, speed); localStorage.setItem(PREF_AUDIO_VOICE, voiceURI); const screen = document.getElementById(`screen-${id}`); const voiceName = availableVoices.find(v => v.voiceURI === voiceURI)?.name.substring(0,6) || "DEF"; if(screen) screen.innerText = `SPD:${speed}x | ${voiceName}`; }

/* MODIFIED: ROBUST AUDIO LOGIC - DISABLED STATE */
/* MODIFIED: ROBUST AUDIO LOGIC WITH HIGHLIGHT */
function speakContent(id) {
    const contentDiv = document.querySelector(`#content-${id} .interactive-content`);
    const text = contentDiv.innerText;
    const speed = document.getElementById(`speed-${id}`).value;
    const voiceURI = document.getElementById(`voice-${id}`).value;
    const playBtn = document.getElementById(`play-${id}`);
    const rewBtn = document.getElementById(`rewind-${id}`);
    const screen = document.getElementById(`screen-${id}`);

    // Limpieza previa de highlights
    document.querySelectorAll('.reading-active').forEach(el => el.classList.remove('reading-active'));

    // RESUME LOGIC
    if (playBtn.classList.contains('playing') && window.speechSynthesis.paused) {
        window.speechSynthesis.resume();
        return;
    }

    // PAUSE RECOVERY
    if (window.speechSynthesis.paused) {
         window.speechSynthesis.resume();
         playBtn.classList.add('playing'); playBtn.innerHTML = '‚è∏';
         if(screen) screen.classList.add('active');
         if(rewBtn) rewBtn.disabled = false;
         return;
    }

    // START NEW
    window.speechSynthesis.cancel();
    
    playBtn.classList.add('playing'); playBtn.innerHTML = '‚è∏';
    if(screen) screen.classList.add('active');
    
    const utter = new SpeechSynthesisUtterance(text);
    const selectedVoice = availableVoices.find(v => v.voiceURI === voiceURI);
    if(selectedVoice) utter.voice = selectedVoice;
    utter.rate = parseFloat(speed);
    
    // --- L√ìGICA DE MAPEO PARA RESALTADO ---
    // 1. Obtenemos todos los spans y creamos un mapa de posiciones
    const allSpans = Array.from(contentDiv.querySelectorAll('.interactive-word'));
    const wordMap = [];
    let cursor = 0;

    // Mapeamos cada span a su posici√≥n en el texto completo
    allSpans.forEach(span => {
        const wordText = span.innerText;
        // Busamos la palabra en el texto completo a partir de la posici√≥n del cursor actual
        // Esto asegura que si hay palabras repetidas, tomemos la correcta
        const foundIndex = text.indexOf(wordText, cursor);
        
        if (foundIndex !== -1) {
            wordMap.push({
                start: foundIndex,
                end: foundIndex + wordText.length,
                element: span
            });
            // Movemos el cursor justo despu√©s de esta palabra
            cursor = foundIndex + 1; 
        }
    });

    // 2. Evento onboundary: se dispara cada vez que la voz cambia de palabra
    utter.onboundary = (event) => {
        if (event.name === 'word') {
            // Quitamos la clase de la palabra anterior
            const active = contentDiv.querySelector('.reading-active');
            if(active) active.classList.remove('reading-active');

            // Buscamos qu√© span corresponde al charIndex actual
            // Usamos un rango peque√±o de tolerancia por si el navegador var√≠a un poco
            const match = wordMap.find(m => 
                event.charIndex >= m.start && event.charIndex < m.end
            );

            if (match) {
                match.element.classList.add('reading-active');
                
                // Opcional: Auto-scroll suave si la palabra est√° muy abajo
                // match.element.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
            }
        }
    };
    // --------------------------------------

    utter.onstart = () => {
        playBtn.classList.add('playing');
        playBtn.innerHTML = '‚è∏';
        if(rewBtn) rewBtn.disabled = false;
    };
    
    utter.onend = () => {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '‚ñ∂';
        if(screen) screen.classList.remove('active');
        if(rewBtn) rewBtn.disabled = true;
        // Limpiar highlight al terminar
        document.querySelectorAll('.reading-active').forEach(el => el.classList.remove('reading-active'));
    };
    
    utter.onerror = () => {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '‚ñ∂';
        if(screen) screen.classList.remove('active');
        if(rewBtn) rewBtn.disabled = true;
        document.querySelectorAll('.reading-active').forEach(el => el.classList.remove('reading-active'));
    };
    
    window.speechSynthesis.speak(utter);
}

function pauseAudio(id) {
    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
        window.speechSynthesis.pause();
    }
}

function rewindAudio(id) {
    // 1. Visual feedback
    const rewBtn = document.getElementById(`rewind-${id}`);
    
    // Safety check: if disabled, do nothing (though UI prevents click)
    if(rewBtn && rewBtn.disabled) return;

    if (rewBtn) {
        rewBtn.classList.add('playing');
        setTimeout(() => rewBtn.classList.remove('playing'), 200);
    }

    // 2. FORCE RESET SYSTEM
    if (window.speechSynthesis.paused) {
        window.speechSynthesis.resume();
    }
    window.speechSynthesis.cancel();

    // 3. RESET UI MANUALLY
    const playBtn = document.getElementById(`play-${id}`);
    if (playBtn) {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '‚ñ∂';
    }
    const screen = document.getElementById(`screen-${id}`);
    if(screen) screen.classList.remove('active');

    // 4. RESTART AFTER DELAY
    setTimeout(() => {
        speakContent(id);
    }, 300);
}

function toggleAudio(id) { 
    const btn = document.getElementById(`play-${id}`); 
    const rewBtn = document.getElementById(`rewind-${id}`);

    if (btn.classList.contains('playing')) { 
        // PAUSE LOGIC
        window.speechSynthesis.pause();
        btn.classList.remove('playing'); 
        btn.innerHTML = '‚ñ∂'; 
        if(rewBtn) rewBtn.disabled = true; // DISABLE REWIND
    } else { 
        // PLAY LOGIC
        speakContent(id); 
    } 
}
/* ------------------------------------- */

function sanitizeText(text) { if (!text) return ""; text = text.replace(/['`‚Äò¬¥]/g, "‚Äô"); text = text.replace(/[^a-zA-Z0-9\u00C0-\u017F\s‚Äô]/g, ""); return text.trim(); }
function loadNexusHistory() { const stored = localStorage.getItem(NEXUS_STORAGE_KEY); if (stored) { nexusHistory = JSON.parse(stored); [...nexusHistory].reverse().forEach(data => renderAccordionDOM(data)); } }
function saveNexusState() { localStorage.setItem(NEXUS_STORAGE_KEY, JSON.stringify(nexusHistory)); }
function addToNexusHistory(data) { nexusHistory.unshift(data); saveNexusState(); }
function removeFromNexusHistory(id) { nexusHistory = nexusHistory.filter(item => item.id !== id); saveNexusState(); }

function formatInteractiveContent(text, existingVocabSet) {
    if (!text) return ""; const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); let i = 0; 
    return safeText.split(/(\s+)/).map(token => { if (token.match(/^\s+$/)) return token; const span = `<span class="interactive-word" data-idx="${i}" onmousedown="startPress(this)" ontouchstart="startPress(this)" onmouseup="endPress(this, event)" ontouchend="endPress(this, event)" onclick="handleShortClick(this)" onmouseenter="handleHoverStart(this)" onmouseleave="handleHoverEnd()">${token}</span>`; i++; return span; }).join('');
}

function renderAccordionDOM(data) {
    const container = document.getElementById('results-container'); 
    const item = document.createElement('div'); 
    item.className = 'accordion-item'; 
    item.id = `item-${data.id}`; 
    const interactiveHTML = formatInteractiveContent(data.content); 
    const savedSpeed = localStorage.getItem(PREF_AUDIO_SPEED) || "1";
    
    // MODIFIED: Rewind button starts DISABLED
    item.innerHTML = `
    <div class="accordion-header" onclick="toggleAccordion(${data.id})">
        <div class="header-content"><span class="meta-tag">${data.modeName}</span><strong>${data.topic}</strong></div>
        <div class="header-actions"><button class="btn-delete" onclick="deleteItem(event, ${data.id})">üóëÔ∏è</button><span>‚ñº</span></div>
    </div>
    <div class="accordion-content" id="content-${data.id}">
        <div class="daw-panel">
            <div class="daw-top-deck">
                <button id="rewind-${data.id}" class="daw-btn-icon" onclick="rewindAudio(${data.id})" disabled>‚è™</button>
                <button id="play-${data.id}" class="daw-btn-icon" onclick="toggleAudio(${data.id})">‚ñ∂</button>
                <div class="daw-screen" id="screen-${data.id}">MASTER OUT</div>
            </div>
            <div class="daw-control-deck">
                <div class="daw-knob-group">
                    <span class="daw-label">SPEED</span>
                    <input type="range" id="speed-${data.id}" class="daw-slider" min="0.5" max="2.0" step="0.1" value="${savedSpeed}" oninput="updateAudioLive(${data.id})">
                </div>
                <div class="daw-knob-group">
                    <span class="daw-label">VOICE BANK</span>
                    <select id="voice-${data.id}" class="daw-select" onchange="updateAudioLive(${data.id})"></select>
                </div>
            </div>
        </div>
        <button class="copy-prompt-btn" onclick="copyTextToClipboard(this)">üìú Copy Prompt</button>
        <div style="display:none;" class="prompt-source">${data.prompt}</div>
        <hr style="border:0; border-top:1px solid #444; margin:10px 0;">
        <div class="interactive-content" style="white-space: pre-wrap;">${interactiveHTML}</div>
    </div>`;
    
    if(document.getElementById(`item-${data.id}`)) return; 
    if (container.firstChild) container.insertBefore(item, container.firstChild); else container.appendChild(item); 
    setTimeout(() => { updateVoiceSelect(document.getElementById(`voice-${data.id}`)); }, 100);
}

function loadHistory(inputId, listId) { const history = JSON.parse(localStorage.getItem(inputId + '_mem')) || []; const dataList = document.getElementById(listId); if(dataList) { dataList.innerHTML = ''; history.forEach(item => { let option = document.createElement('option'); option.value = item; dataList.appendChild(option); }); } }
function saveToHistory(inputId) { const input = document.getElementById(inputId); const value = input.value.trim(); if (!value) return; let history = JSON.parse(localStorage.getItem(inputId + '_mem')) || []; history = history.filter(item => item !== value); history.unshift(value); if (history.length > 5) history.pop(); localStorage.setItem(inputId + '_mem', JSON.stringify(history)); loadHistory(inputId, input.getAttribute('list')); }

function generatePrompt() {
    const isVocabMode = document.getElementById('useVocabCheckbox').checked; let context = document.getElementById('contextInput').value; let topic = document.getElementById('topicInput').value; let vocabBlock = ""; let selectedTask = null;

    if (isVocabMode) {
        const words = getSelectedVocab();
        if (words && words.length > 0) {
            vocabBlock = `\n<target_vocabulary_list>\n${words.join(', ')}\n</target_vocabulary_list>\n\n**MANDATORY INSTRUCTION:** You MUST incorporate the words inside the <target_vocabulary_list> tags into your response naturally.\n`;
            topic = "English Vocabulary Practice"; const taskId = document.getElementById('taskSelect').value; selectedTask = VOCAB_TASKS.find(t => t.id === taskId); if(!selectedTask) selectedTask = VOCAB_TASKS[0];
        } else { alert("No vocabulary found! Add words in the MDC App."); return; }
    } else { selectedTask = SYSTEM_DATA.TASK_TYPES.find(t => t.id === document.getElementById('taskSelect').value); }

    const modeId = document.getElementById('modeSelect').value; const mode = COMMON_DATA.MODES.find(m => m.id === modeId);
    const format = COMMON_DATA.FORMATS.find(f => f.id === document.getElementById('formatSelect').value);
    const voice = SYSTEM_DATA.VOICES.find(v => v.id === document.getElementById('voiceSelect').value);
    const len = SYSTEM_DATA.LENGTH.find(l => l.id === document.getElementById('lengthSelect').value);
    const levelInstruction = document.getElementById('levelSelect').value;

    const prompt = `
# SYSTEM IDENTITY & CORE OBJECTIVE
You are an advanced AI acting strictly as: **${mode.role}**
Your style must be: ${mode.style}
**Primary Goal:** ${mode.goal}

# PROJECT CONTEXT
I need you to perform a specific task based on the following parameters:
- **Context:** ${context || "General"}
- **Subject/Topic:** ${topic}
- **Task Type:** ${selectedTask.label} -> ${selectedTask.instruction}

${vocabBlock ? `\n# MANDATORY DATA (Vocabulary)${vocabBlock}\n` : ''}

# RESPONSE GUIDELINES
Follow these configuration rules strictly:
1. **Format:** ${format.label} (${format.instruction})
2. **Tone:** ${voice.instruction}
3. **Length:** ${len.instruction}
4. **Depth Level:** ${levelInstruction}

# CRITICAL INSTRUCTIONS & RESTRICTIONS
To ensure high quality, follow this logic:
- Think step-by-step before generating.
- Analyze the "${topic}" within the context of "${context}".
- ${SYSTEM_DATA.RESTRICTIONS.join('\n- ')}

---
**BEGIN RESPONSE:**`.trim();

    const outputDiv = document.getElementById('prompt-output'); outputDiv.style.display = 'block'; outputDiv.textContent = prompt; navigator.clipboard.writeText(prompt); lastGeneratedPrompt = prompt; if(!isVocabMode) { saveToHistory('contextInput'); saveToHistory('topicInput'); }
}

/* MODIFIED: Prompt for Title on Paste */
async function handlePasteResponse() {
    try {
        const text = await navigator.clipboard.readText(); if(!text) return alert("Clipboard is empty.");
        
        // Ask user for Title
        const defaultTitle = document.getElementById('topicInput').value || "Untitled Result";
        const userTitle = prompt("Enter a title for this result:", defaultTitle);
        
        if (userTitle === null) return; // User cancelled
        
        const modeLabel = document.getElementById('modeDisplay').value;
        const data = { id: Date.now(), modeName: modeLabel, topic: userTitle, prompt: lastGeneratedPrompt, content: text };
        addToNexusHistory(data); renderAccordionDOM(data); toggleGenerator(false);
    } catch (err) { alert("Permission denied or error reading clipboard."); }
}

function toggleGenerator(show) { const gen = document.getElementById('generator-container'); const btnShow = document.getElementById('btn-show-gen'); if (show) { gen.classList.remove('hidden'); btnShow.style.display = 'none'; } else { gen.classList.add('hidden'); btnShow.style.display = 'block'; } }
function deleteItem(event, id) { event.stopPropagation(); if(confirm("Delete result?")) { const el = document.getElementById(`item-${id}`); if(el) el.remove(); removeFromNexusHistory(id); } }
function copyTextToClipboard(btnElement) { const promptText = btnElement.nextElementSibling.textContent; navigator.clipboard.writeText(promptText).then(() => { const originalText = btnElement.innerText; btnElement.innerText = "Copied!"; setTimeout(() => btnElement.innerText = originalText, 1500); }); }
function filterResults() { const query = document.getElementById('searchBar').value.toLowerCase(); const items = document.querySelectorAll('.accordion-item'); items.forEach(item => { const topic = item.querySelector('.header-content strong').innerText.toLowerCase(); const content = item.querySelector('.interactive-content').innerText.toLowerCase(); if (topic.includes(query) || content.includes(query)) item.style.display = "block"; else item.style.display = "none"; }); }
function speakText(text) {
    if (!text) return; window.speechSynthesis.cancel(); const utter = new SpeechSynthesisUtterance(text); const savedSpeed = localStorage.getItem(PREF_AUDIO_SPEED) || "1.0"; utter.rate = parseFloat(savedSpeed); const savedVoiceURI = localStorage.getItem(PREF_AUDIO_VOICE);
    const setEnglishVoice = () => { const voices = window.speechSynthesis.getVoices(); let enVoice = null; if (savedVoiceURI) { enVoice = voices.find(v => v.voiceURI === savedVoiceURI); } if (!enVoice) { enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) || voices.find(v => v.lang.startsWith('en')) || voices[0]; } if (enVoice) utter.voice = enVoice; window.speechSynthesis.speak(utter); };
    if (window.speechSynthesis.getVoices().length === 0) { window.speechSynthesis.onvoiceschanged = setEnglishVoice; } else { setEnglishVoice(); }
}
</script>
</body>
</html>
